<?xml version="1.0" encoding="utf-8" ?>
<diff>
<!-- add. purpose: data store
	<params>
-->
	<add sel="//params">
		<param name="kAAITParam_isAvoidHighRisk" required="false" type="internal" text="{1111920, 3}" default="false" />
		<param name="kAAITParam_isStepForwardWithdraw" required="false" type="internal" text="{1111920, 109}" default="false" />
	</add>
<!-- add. purpose: add handlers.
	<interrupts>
-->
	<add pos="prepend" sel="//interrupts">
		<handler ref="kAAIT_Handler_AvoidWithdrawOrJustFight" />
		<handler ref="kAAIT_Handler_NewBigTarget" />
	</add>
<!-- add prepend. purpose: init var.
	<init>
-->
	<add pos="prepend" sel="//init">
		<debug_text text="@this.assignedcontrolled.idcode + ' EVENT init'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<do_if value="@$kAAITParam_isAvoidHighRisk">
			<include_interrupt_actions ref="kAAIT_Init" />
		</do_if>
	</add>
<!--
	             ,,            ,,  ,,        ,,
	             db            db *MM      `7MM
	                               MM        MM
	`7M'   `MF'`7MM  ,pP"Ybd `7MM  MM,dMMb.  MM  .gP"Ya
	  VA   ,V    MM  8I   `"   MM  MM    `Mb MM ,M'   Yb
	   VA ,V     MM  `YMMMa.   MM  MM     M8 MM 8M""""""
	    VVV      MM  L.   I8   MM  MM.   ,M9 MM YM.    ,
	     W     .JMML.M9mmmP' .JMML.P^YbmdP'.JMML.`Mbmmd'
 -->
<!-- add before. purpose: behaviours.
	<label name="fight" />
-->
	<add pos="before" sel="//attention[@min=&quot;visible&quot;]//label[@name=&quot;fight&quot;]">
		<resume label="fight" />

		<label name="kAAIT_label_avoid" />
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL kAAIT_label_avoid'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<include_interrupt_actions ref="kAAIT_Order_Avoid" />
		<wait min="5s" max="10s" />
		<resume label="fight" />
	</add>
<!-- add after. purpose: add attacker to target
	<label name="fight" />
-->
	<add pos="after" sel="//attention[@min=&quot;visible&quot;]//label[@name=&quot;fight&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL fight'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<do_if value="@$kAAITParam_isAvoidHighRisk and (not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isIgnoreKAAIT)">
			<include_interrupt_actions ref="kAAIT_AddAttackerToTarget" />
			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_space" />
			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_pos" />
		</do_if>
	</add>
<!--
	add before. purpose: break off attack if near a big target
	<do_while value="$target.isoperational">
		<do_if value="$target.isoperational">
-->
	<add pos="before" sel="//do_while[@value=&quot;$target.isoperational&quot;]//do_if[@value=&quot;$target.isoperational&quot;][1]">
		<do_if value="@$kAAITParam_isAvoidHighRisk and (not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isIgnoreKAAIT)">
			<do_if value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isTargetHighRisk">
				<do_if value="player.age gt @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$time_avoidAllowed">
					<set_value name="$kAAIT_test_target_isAvoid" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget" />
					<include_interrupt_actions ref="kAAIT_AvoidOrNot" />
					<do_if value="@$kAAIT_result_avoidEnemy.isoperational">
						<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$target_avoid" exact="$kAAIT_result_avoidEnemy" />
						<do_if value="$kAAIT_result_avoidEnemy == $kAAIT_test_target_isAvoid">
							<resume label="kAAITLabel_withdraw" />
						</do_if>
						<do_else>
							<resume label="kAAIT_label_avoid" />
						</do_else>
					</do_if>
				</do_if>
			</do_if>
		</do_if>
	</add>
<!-- add before. purpose: withdraw.
	<label name="finish"/>
-->
	<add pos="before" sel="//attention[@min=&quot;visible&quot;]//label[@name=&quot;finish&quot;]">
		<resume label="finish"/>
		<label name="kAAITLabel_withdraw" />
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL kAAITLabel_withdraw'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<create_order object="this.assignedcontrolled" id="'kAAIT_MoveWithdraw'" immediate="true">
			<param name="target" value="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget" />
		</create_order>
		<resume label="finish"/>
	</add>
<!-- add after. purpose: clean-up.
	<label name="finish" />
-->
	<add pos="after" sel="//attention[@min=&quot;visible&quot;]//label[@name=&quot;finish&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL finish'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<include_interrupt_actions ref="kAAIT_RemoveAttackerFromTarget" />
		<do_if value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data">
			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_space" />
			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_pos" />
		</do_if>
	</add>
<!--
	                        `7MM
	                          MM
	`7MM  `7MM  `7MMpMMMb.    MM  ,MP'`7MMpMMMb.  ,pW"Wq.`7M'    ,A    `MF'`7MMpMMMb.
	  MM    MM    MM    MM    MM ;Y     MM    MM 6W'   `Wb VA   ,VAA   ,V    MM    MM
	  MM    MM    MM    MM    MM;Mm     MM    MM 8M     M8  VA ,V  VA ,V     MM    MM
	  MM    MM    MM    MM    MM `Mb.   MM    MM YA.   ,A9   VVV    VVV      MM    MM
	  `Mbod"YML..JMML  JMML..JMML. YA..JMML  JMML.`Ybmd9'     W      W     .JMML  JMML.
 -->
<!-- add before. purpose: behaviours.
	<label name="fight" />
-->
	<add pos="before" sel="//attention[@min=&quot;unknown&quot;]//label[@name=&quot;fight&quot;]">
		<resume label="fight" />

		<label name="kAAIT_label_avoid" />
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL kAAIT_label_avoid'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<include_interrupt_actions ref="kAAIT_Order_Avoid" />
		<wait min="5s" max="10s" />
		<resume label="fight" />
	</add>
<!-- add after. purpose: add attacker to target
	<label name="fight" />
-->
	<add pos="after" sel="//attention[@min=&quot;unknown&quot;]//label[@name=&quot;fight&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL fight'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<do_if value="@$kAAITParam_isAvoidHighRisk and (not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isIgnoreKAAIT)">
			<include_interrupt_actions ref="kAAIT_AddAttackerToTarget" />
			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_space" />
			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_pos" />
		</do_if>
	</add>
<!--
	add before. purpose: break off attack if near a big target
	<do_while value="$target.isoperational and not $isdead" >
		<do_if value="$target.isoperational">
-->
	<add pos="before" sel="//do_while[@value=&quot;$target.isoperational and not $isdead&quot;]//do_if[@value=&quot;$target.isoperational&quot;]">
		<do_if value="@$kAAITParam_isAvoidHighRisk and (not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isIgnoreKAAIT)">
			<do_if value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isTargetHighRisk">
				<do_if value="player.age gt @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$time_avoidAllowed">
					<set_value name="$kAAIT_test_target_isAvoid" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget" />
					<include_interrupt_actions ref="kAAIT_AvoidOrNot" />
					<do_if value="@$kAAIT_result_avoidEnemy.isoperational">
						<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$target_avoid" exact="$kAAIT_result_avoidEnemy" />
						<do_if value="$kAAIT_result_avoidEnemy == $kAAIT_test_target_isAvoid">
							<resume label="kAAITLabel_withdraw" />
						</do_if>
						<do_else>
							<resume label="kAAIT_label_avoid" />
						</do_else>
					</do_if>
				</do_if>
			</do_if>
		</do_if>
	</add>
<!-- add before. purpose: withdraw.
	<label name="finish"/>
-->
	<add pos="before" sel="//attention[@min=&quot;unknown&quot;]//label[@name=&quot;finish&quot;]">
		<resume label="finish"/>
		<label name="kAAITLabel_withdraw" />
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL kAAITLabel_withdraw'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<create_order object="this.assignedcontrolled" id="'kAAIT_MoveWithdraw'" immediate="true">
			<param name="target" value="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget" />
		</create_order>
		<resume label="finish"/>
	</add>
<!-- add after. purpose: clean-up.
	<label name="finish" />
-->
	<add pos="after" sel="//attention[@min=&quot;unknown&quot;]//label[@name=&quot;finish&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL finish'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<include_interrupt_actions ref="kAAIT_RemoveAttackerFromTarget" />
		<do_if value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data">
			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_space" />
			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_pos" />
		</do_if>
	</add>
	<!--
		   db    88""Yb  dP"Yb  88""Yb 888888
		  dPYb   88__dP dP   Yb 88__dP   88
		 dP__Yb  88""Yb Yb   dP 88"Yb    88
		dP""""Yb 88oodP  YbodP  88  Yb   88
	 -->
<!-- add. purpose: cleanup.
	<on_abort>
-->
	<add sel="//on_abort">
		<include_interrupt_actions ref="kAAIT_RemoveAttackerFromTarget" />
		<do_if value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data">
			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_space" />
			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_pos" />
		</do_if>
	</add>
</diff>
