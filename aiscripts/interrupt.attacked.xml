<?xml version='1.0' encoding='utf-8'?>
<diff>
<!-- add. purpose: block event.
      <handler name="AttackHandler">
        <conditions>
          <event_object_attacked object="this.defensible"/>
          ...
          <check_all comment="flee">
            <check_value value="not event.object.isunit"/>
            <check_any>
              <check_value value="event.object.signal.{'attacked'}.response.id == 'flee'"/>
-->
  <replace sel="//check_all[@comment=&quot;flee&quot;]//check_value[@value=&quot;event.object.signal.{'attacked'}.response.id == 'flee'&quot;]">
    <check_all>
        <check_value value="event.object.signal.{'attacked'}.response.id == 'flee'"/>
        <check_value value="not @this.assignedcontrolled.order.$kAAITParam_iskAAITOrder" comment="not performing a kAAIT order" />
        <check_value value="not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isInited" comment="not inited by kAAIT" />
        <debug_text text="@this.assignedcontrolled.idcode + ' AttackHandler event.name: ' + event.name" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
    </check_all>
  </replace>
<!-- add. purpose: block event.
      <handler name="AttackHandler">
        <conditions>
          <event_object_attacked object="this.defensible"/>
          ...
          <check_all comment="flee">
            <check_value value="not event.object.isunit"/>
            <check_any>
              <check_value value="event.object.signal.{'attacked'}.response.id == 'flee'"/>
              <check_all>
                <check_value value="event.object.signal.{'attacked'}.response.id == 'auto'"/>
-->
	<replace sel="//check_all[@comment=&quot;flee&quot;]//check_value[@value=&quot;event.object.signal.{'attacked'}.response.id == 'auto'&quot;]">
    <check_all>
        <check_value value="event.object.signal.{'attacked'}.response.id == 'auto'"/>
        <check_value value="not @this.assignedcontrolled.order.$kAAITParam_iskAAITOrder" comment="not performing a kAAIT order" />
        <check_value value="not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isInited" comment="not inited by kAAIT" />
        <debug_text text="@this.assignedcontrolled.idcode + ' AttackHandler event.name: ' + event.name" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
    </check_all>
	</replace>
<!-- add. purspose: do not restock if commander has an attack order or there's an enemy nearby.
  <signal_objects object="event.object" param="'resupply'" param2="[false]" param3="$debugchance" delay="10ms" comment="param2 = [urgent?, resupplystationID], param3 = $debugchance"/>
-->
  <add pos="before" sel="//signal_objects[@param=&quot;'resupply'&quot;]">
    <set_value name="$kAAIT_restockChance" exact="100" />
    <do_if value="@$kAAITParam_isAvoidHighRisk and (not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isIgnoreKAAIT)">
      <do_if value="this.assignedcontrolled.hullpercentage gt 25">
        <include_interrupt_actions ref="kAAIT_GetBigEnemies" />
        <include_interrupt_actions ref="kAAIT_GetIsNearBigEnemies" />
        <do_if value="
          @$kAAIT_bigEnemy.isoperational or
          @this.assignedcontrolled.commaner.order.id == 'Attack' or
          @this.assignedcontrolled.commaner.order.$kAAITParam_iskAAITOrder or
          @this.assignedcontrolled.commaner.order.id == 'TacticalOrder'">
          <set_value name="$kAAIT_restockChance" exact="0" />
        </do_if>
      </do_if>
    </do_if>
  </add>
  <add sel="//signal_objects[@param=&quot;'resupply'&quot;]" type="@chance">$kAAIT_restockChance</add>
</diff>
