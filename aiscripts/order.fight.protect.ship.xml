<?xml version='1.0' encoding='utf-8'?>
<diff>
<!-- add. purpose: params.
	<params>
-->
	<add sel="//params">
		<param name="kAAITParam_isAvoidHighRisk" required="false" type="bool" text="{1111920, 3}" default="
			if (not this.assignedcontrolled.isunit) and (not this.assignedcontrolled.islasertower) and
			(
				(
					this.assignedcontrolled.isplayerowned and
					(this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m] or this.assignedcontrolled.primarypurpose != purpose.fight) and
					@global.$kAAIT_Data.$xssm_isAvoidHighRisk and
					(
						(not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_isAvoidHighRisk_user?) or
						@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_isAvoidHighRisk_user
					)
				) or
				(
					(not this.assignedcontrolled.isplayerowned) and
					(this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m] or this.assignedcontrolled.primarypurpose != purpose.fight) and
					@global.$kAAIT_Data.$xssm_isAvoidHighRisk_allFactions
				) or
				(
					this.assignedcontrolled.isplayerowned and
					this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
					(@global.$kAAIT_Data.$lxl_isAvoidHighRisk_vShip or @global.$kAAIT_Data.$lxl_isAvoidHighRisk_vStation) and
					(
						(not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_isAvoidHighRisk_user?) or
						@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_isAvoidHighRisk_user
					)
				) or
				(
					(not this.assignedcontrolled.isplayerowned) and
					this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
					(@global.$kAAIT_Data.$lxl_isAvoidHighRisk_vShip_allFactions or @global.$kAAIT_Data.$lxl_isAvoidHighRisk_vStation_allFactions)
				)
			) then true else false
		" />
		<param name="kAAITParam_isStepForwardWithdraw" required="false" type="bool" text="{1111920, 109}" default="
			if (not this.assignedcontrolled.isunit) and (not this.assignedcontrolled.islasertower) and
			(
				(
					this.assignedcontrolled.isplayerowned and
					(
						this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m] or
						this.assignedcontrolled.primarypurpose != purpose.fight
					) and
					@global.$kAAIT_Data.$xssm_isAvoidHighRisk and
					(
						(not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_isStepForwardWithdraw_user?) or
						@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_isStepForwardWithdraw_user
					)
				) or
				(
					(not this.assignedcontrolled.isplayerowned) and
					(
						this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m] or
						this.assignedcontrolled.primarypurpose != purpose.fight
					) and
					@global.$kAAIT_Data.$xssm_isAvoidHighRisk_allFactions
				) or
				(
					this.assignedcontrolled.isplayerowned and
					this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
					(
						@global.$kAAIT_Data.$lxl_isStepForward_vShip or
						@global.$kAAIT_Data.$lxl_isMoveOutOfRange_vShip or
						@global.$kAAIT_Data.$lxl_isStepForward_vStation or
						@global.$kAAIT_Data.$lxl_isMoveOutOfRange_vStation
					) and
					(
						(not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_isStepForwardWithdraw_user?) or
						@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_isStepForwardWithdraw_user
					)
				) or
				(
					(not this.assignedcontrolled.isplayerowned) and
					this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
					(
						@global.$kAAIT_Data.$lxl_isStepForward_vShip_allFactions or
						@global.$kAAIT_Data.$lxl_isMoveOutOfRange_vShip_allFactions or
						@global.$kAAIT_Data.$lxl_isStepForward_vStation_allFactions or
						@global.$kAAIT_Data.$lxl_isMoveOutOfRange_vStation_allFactions
					) and
					(
						(not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_isStepForwardWithdraw_user?) or
						@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_isStepForwardWithdraw_user
					)
				)
			) then true else false
		" />
	</add>
<!-- add before. purpose: show movement.
	<location object="$target" condition="$target.exists" />
-->
	<add pos="before" sel="//location[@object=&quot;$target&quot;][@condition=&quot;$target.exists&quot;]">
		<location object="@$kAAIT_orderLocation_space" position="@$kAAIT_orderLocation_pos" condition="@$kAAIT_orderLocation_space and @$kAAIT_orderLocation_pos" />
	</add>
<!-- add. purpose: withdraw ai.
	<interrupts>
-->
	<add pos="prepend" sel="//interrupts">
		<handler ref="kAAIT_Handler_AvoidWithdrawOrJustFight" />
		<handler comment="attack or move">
			<conditions>
				<check_any>
					<check_all>
						<event_object_signalled object="this.ship" param2="'break and attack'"/>
						<check_value value="$target.isoperational and $target.pilot and event.param.isoperational and $target.mayattack.{event.param}"/>
					</check_all>
					<check_all>
						<check_any>
							<event_object_attacked object="this.ship"/>
							<event_object_attacked object="$target"/>
							<check_all>
								<event_object_enemy_found object="this.ship"/>
								<check_value value="not $target.pilot or (@$target.pilot.command.value == command.attackenemies) or (@$target.pilot.command.value == command.attackobject) or (@$target.pilot.command.value == command.patrol) or (@$target.pilot.command.value == command.protect) or ($target.primarypurpose != purpose.fight)"/>
								<check_value value="event.param.primarypurpose == purpose.fight"/>
							</check_all>
							<check_all>
								<event_object_attacked_object object="$target"/>
								<check_value value="$target == player.occupiedship"/>
							</check_all>
						</check_any>
						<check_value value="event.param.isoperational"/>
						<check_value value="$target.isoperational" />
						<check_value value="$target != event.param" comment="special check for attack (or not) the target" />
						<check_any>
							<check_value value="this.mayattack.{event.param}"/>
							<check_value value="$target.mayattack.{event.param} and (this.assignedcontrolled.hasrelation.enemy.{event.param} or (this.trueowner == $target.trueowner))"/>
						</check_any>
						<check_value value="($target.distanceto.{event.param} le $pursuedistance) and (this.ship.distanceto.{event.param} le $pursuedistance)" />
					</check_all>
					<check_all>
						<event_object_changed_zone object="$target"/>
						<check_any>
							<check_value value="not this.assignedcontrolled.isformationwingman or (this.assignedcontrolled.formationleader != $target)"/>
							<check_value value="event.param.isclass.highway or event.param2.isclass.highway"/>
						</check_any>
					</check_all>
					<event_object_changed_sector object="$target"/>
					<event_object_destroyed object="$target" />
					<event_object_abandoned object="$target" />
					<event_object_changed_true_owner object="$target"/>
				</check_any>
			</conditions>
			<actions>
				<debug_text text="this.assignedcontrolled.idcode + ' EVENT ' + event.name" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				<set_value name="$enemy" exact="null" />

				<debug_text text="'squadron movement interrupted by: %1 event.param: %2 (%3)'.[event.name, @event.param.knownname, event.param]" chance="$debugchance"/>

				<do_if value="(event.name == 'event_object_destroyed') or (event.name == 'event_object_abandoned') or (event.name == 'event_object_changed_true_owner')">
					<debug_text text="'target was %s. aborting.'.[event.name]" chance="@$debugchance"/>
					<abort_called_scripts resume="finish" />
				</do_if>
				<do_elseif value="(event.name == 'event_object_changed_zone') or (event.name == 'event_object_changed_sector')">
					<do_if value="@$leaderpilot.exists">
						<remove_from_group group="$leaderpilot.$escortgroup" object="this.ship"/>
					</do_if>
					<abort_called_scripts resume="start" />
				</do_elseif>
				<do_else>
					<do_if value="event.param.isoperational">

						<set_value name="$enemy" exact="event.param" />

						<do_if value="(event.name == 'event_object_signalled') and (event.param2 == 'break and attack')">
							<set_value name="this.$goattack" exact="true"/>
							<do_if value="@$leaderpilot.$escortgroup">
								<remove_from_group group="$leaderpilot.$escortgroup" object="this.ship" />
							</do_if>
							<debug_text text="'This ship, %1 (%2), escorting %3, attacking %4 (%5). CONDITION 4.2.2: Squadron reinforcing (response to condition 4.1)'.[this.ship.knownname, this.ship, $target.knownname, $enemy.knownname, $enemy]" chance="@$debugchance"/>
						</do_if>
						<do_elseif value="@$leaderpilot.$escortgroup.count and ((event.name == 'event_object_attacked') or (event.name == 'event_object_enemy_found') or (event.name == 'event_object_attacked_object'))">
							<set_value name="$nsupportships" exact="$leaderpilot.$escortgroup.count * 0.2" />

							<do_if value="event.name" exact="'event_object_attacked'">
								<do_if value="event.param3" exact="this.ship">
									<set_value name="this.ship.pilot.$goattack" exact="true" />
									<remove_from_group group="$leaderpilot.$escortgroup" object="this.ship" />
									<debug_text text="'This ship, %1 (%2), escorting %3, attacking %4 (%5). CONDITION 2: Squadron was attacked'.[this.ship.knownname, this.ship, $target.knownname, $enemy.knownname, $enemy]" chance="@$debugchance"/>
									<set_value name="$nsupportships" exact="$leaderpilot.$escortgroup.count * 0.3" />
								</do_if>
								<do_elseif value="event.param3" exact="$target">
									<do_all chance="60">
										<set_value name="this.ship.pilot.$goattack" exact="true"/>
										<remove_from_group group="$leaderpilot.$escortgroup" object="this.ship" />
										<debug_text text="'This ship, %1 (%2), escorting %3, attacking %4 (%5). CONDITION 3: Leader under attack'.[this.ship.knownname, this.ship, $target.knownname, $enemy.knownname, $enemy]" chance="@$debugchance"/>
									</do_all>
								</do_elseif>
							</do_if>

							<do_if value="$leaderpilot.$escortgroup.count" min="1">
								<do_all exact="[1, $nsupportships].max" counter="$i">
									<signal_objects object="$leaderpilot.$escortgroup.{$i}" param="$enemy" param2="'break and attack'"/>
									<set_value name="$leaderpilot.$escortgroup.{$i}.pilot.$goattack" exact="true" />
									<debug_text text="'Requesting %1 (%2), escorting %3, to attack %4 (%5). CONDITION 4.1: Requesting reinforcements'.[$leaderpilot.$escortgroup.{$i}.knownname, $leaderpilot.$escortgroup.{$i}, $target.knownname, $enemy.knownname, $enemy]" chance="@$debugchance"/>
									<do_if value="$leaderpilot.$escortgroup.{$i} == this.ship">
										<remove_from_group group="$leaderpilot.$escortgroup" object="this.ship" />
										<debug_text text="'This ship, %1 (%2), escorting %3, attacking %4 (%5). CONDITION 4.2.1'.[this.ship.knownname, this.ship, $target.knownname, $enemy.knownname, $enemy]" chance="@$debugchance"/>
									</do_if>
								</do_all>
							</do_if>
						</do_elseif>
						<do_elseif value="not @$leaderpilot.$escortgroup">
							<debug_text text="'no coordination. attacking %s %s %s'.[$enemy.idcode, $enemy.knownname, $enemy]" chance="@$debugchance"/>
							<set_value name="this.$goattack" exact="true"/>
						</do_elseif>
						<do_else>
							<debug_text text="'squadron attack case unaccounted for. this ship will just stay in formation. event.name: ' + event.name" filter="error"/>
						</do_else>
					</do_if>
					<remove_value name="$nsupportships" />
				</do_else>
				<do_if value="this.$goattack">
					<abort_called_scripts resume="fight" />
				</do_if>
			</actions>
		</handler>
	</add>
<!--
	Yb    dP 88 .dP"Y8 88 88""Yb 88     888888
	 Yb  dP  88 `Ybo." 88 88__dP 88     88__
		YbdP   88 o.`Y8b 88 88""Yb 88  .o 88""
		 YP    88 8bodP' 88 88oodP 88ood8 888888
 -->
<!-- add before. purpose: avoid.
	<attention min="visible">
		<actions>
			...
			<label name="start" />
-->
	<add pos="before" sel="//attention[@min=&quot;visible&quot;]//label[@name=&quot;start&quot;]">
		<resume label="start" />
		<label name="kAAIT_label_avoid" />
		<debug_text text="this.assignedcontrolled.idcode + ' LABEL kAAIT_label_avoid'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
		<include_interrupt_actions ref="kAAIT_Order_Avoid" />
		<wait min="5s" max="10s" />
		<resume label="start" />
	</add>
<!-- add. purspose: do not restock if commander has an attack order or there's an enemy nearby.
	<signal_objects object="event.object" param="'resupply'" param2="[false]" param3="$debugchance" delay="10ms" comment="param2 = [urgent?, resupplystationID], param3 = $debugchance"/>
-->
	<add pos="before" sel="//attention[@min=&quot;visible&quot;]//signal_objects[@param=&quot;'resupply'&quot;]">
		<set_value name="$kAAIT_restockChance" exact="100" />
		<do_if value="@$kAAITParam_isAvoidHighRisk and (not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isIgnoreKAAIT)">
			<do_if value="this.assignedcontrolled.hullpercentage gt 25">
				<include_interrupt_actions ref="kAAIT_GetBigEnemies" />
				<include_interrupt_actions ref="kAAIT_GetIsNearBigEnemies" />
				<do_if value="
					@$kAAIT_bigEnemy.isoperational or
					@this.assignedcontrolled.commaner.order.id == 'Attack' or
					@this.assignedcontrolled.commaner.nextoder.id == 'Attack' or
					@this.assignedcontrolled.commaner.order.id == 'TacticalOrder' or
					@this.assignedcontrolled.commaner.nextoder.id == 'TacticalOrder'">
					<set_value name="$kAAIT_restockChance" exact="0" />
				</do_if>
			</do_if>
		</do_if>
	</add>
	<add sel="//attention[@min=&quot;visible&quot;]//signal_objects[@param=&quot;'resupply'&quot;]" type="@chance">$kAAIT_restockChance</add>
<!-- add prepend. purpose avoid or not
	<do_while value="$target.isoperational">
-->
	<add pos="prepend" sel="//attention[@min=&quot;visible&quot;]//do_while[@value=&quot;$target.isoperational&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' do_while'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
		<do_if value="@$kAAITParam_isAvoidHighRisk and (not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isIgnoreKAAIT)">
			<do_if value="this.sector == $target.sector">
				<include_interrupt_actions ref="kAAIT_AvoidOrNot" />
				<do_if value="@$kAAIT_result_avoidEnemy.isoperational">
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$target_avoid" exact="$kAAIT_result_avoidEnemy" />
					<resume label="kAAIT_label_avoid" />
				</do_if>
			</do_if>
		</do_if>
	</add>
<!-- add after. purpose: get pos behind target if non-fighter
	<get_safe_pos object="$target" zone="$target.zone" radius="this.ship.size/2" allowyaxis="false" result="$pos" ignored="this.ship" />
-->
	<add pos="after" sel="//attention[@min=&quot;visible&quot;]//get_safe_pos[@object=&quot;$target&quot;][@zone=&quot;$target.zone&quot;][@radius=&quot;this.ship.size/2&quot;][@allowyaxis=&quot;false&quot;][@result=&quot;$pos&quot;][@ignored=&quot;this.ship&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' get_safe_pos'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
		<do_if value="@$kAAITParam_isAvoidHighRisk and (not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isIgnoreKAAIT)">
			<set_value name="$kAAIT_target_escort" exact="$target" />
			<include_interrupt_actions ref="kAAIT_GetEscortPos" />
			<get_safe_pos result="$pos" zone="$target.zone" object="$target.sector" value="$kAAIT_result_pos_escort" />
		</do_if>
	</add>
<!-- add. purpose: move to escort pos if non-fighter
	<attention min="visible">
		<move_to object="this.ship" destination="$target.zone" uselocalhighways="false" forceposition="false" finishonapproach="true" commandaction="false" >
-->
	<add pos="before" sel="//attention[@min=&quot;visible&quot;]//move_to[@object=&quot;this.ship&quot;][@destination=&quot;$target.zone&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' move_to'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
		<do_if value="@$kAAITParam_isAvoidHighRisk and (not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isIgnoreKAAIT)">
			<set_value name="$kAAIT_orderLocation_space" exact="$target.zone" />
			<set_value name="$kAAIT_orderLocation_pos" exact="$pos" />
		</do_if>
	</add>
<!-- remove. purpose: events now in handler.
	<attention min="visible">
		<wait min="10s" max="20s" >
			<interrupt>
-->
	<remove sel="//attention[@min=&quot;visible&quot;]//wait[@min=&quot;10s&quot;][@max=&quot;20s&quot;]/interrupt" />
<!-- add after. purpose: finish.
	<label name="finish" />
-->
	<add pos="after" sel="//attention[@min=&quot;visible&quot;]//label[@name=&quot;finish&quot;]">
		<include_interrupt_actions ref="kAAIT_Deinit" />
	</add>
<!--
	88   88 88b 88 88  dP 88b 88  dP"Yb  Yb        dP 88b 88
	88   88 88Yb88 88odP  88Yb88 dP   Yb  Yb  db  dP  88Yb88
	Y8   8P 88 Y88 88"Yb  88 Y88 Yb   dP   YbdPYbdP   88 Y88
	`YbodP' 88  Y8 88  Yb 88  Y8  YbodP     YP  YP    88  Y8
 -->
<!-- add before. purpose: avoid.
	<attention min="visible">
		<actions>
			...
			<label name="start" />
-->
	<add pos="before" sel="//attention[@min=&quot;unknown&quot;]//label[@name=&quot;start&quot;]">
		<resume label="start" />
		<label name="kAAIT_label_avoid" />
		<debug_text text="this.assignedcontrolled.idcode + ' LABEL kAAIT_label_avoid'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
		<include_interrupt_actions ref="kAAIT_Order_Avoid" />
		<wait min="5s" max="10s" />
		<resume label="start" />
	</add>
<!-- add. purspose: do not restock if commander has an attack order or there's an enemy nearby.
	<signal_objects object="event.object" param="'resupply'" param2="[false]" param3="$debugchance" delay="10ms" comment="param2 = [urgent?, resupplystationID], param3 = $debugchance"/>
-->
	<add pos="before" sel="//attention[@min=&quot;unknown&quot;]//signal_objects[@param=&quot;'resupply'&quot;]">
		<set_value name="$kAAIT_restockChance" exact="100" />
		<do_if value="@$kAAITParam_isAvoidHighRisk and (not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isIgnoreKAAIT)">
			<do_if value="this.assignedcontrolled.hullpercentage gt 25">
				<include_interrupt_actions ref="kAAIT_GetBigEnemies" />
				<include_interrupt_actions ref="kAAIT_GetIsNearBigEnemies" />
				<do_if value="
					@$kAAIT_bigEnemy.isoperational or
					@this.assignedcontrolled.commaner.order.id == 'Attack' or
					@this.assignedcontrolled.commaner.nextoder.id == 'Attack' or
					@this.assignedcontrolled.commaner.order.id == 'TacticalOrder' or
					@this.assignedcontrolled.commaner.nextoder.id == 'TacticalOrder'">
					<set_value name="$kAAIT_restockChance" exact="0" />
				</do_if>
			</do_if>
		</do_if>
	</add>
	<add sel="//attention[@min=&quot;unknown&quot;]//signal_objects[@param=&quot;'resupply'&quot;]" type="@chance">$kAAIT_restockChance</add>
<!-- remove. purpose: will be re-added in the correct location.
	<label name="fight" />
-->
	<remove sel="//attention[@min=&quot;unknown&quot;]//label[@name=&quot;fight&quot;]" />
<!-- add after. add vars from visible attention so that the handler could work.
	<do_if value="not $target.isoperational">
-->
	<add pos="after" sel="//attention[@min=&quot;unknown&quot;]//do_if[@value=&quot;not $target.isoperational&quot;]">
		<do_if value="$target.isoperational">
			<do_if value="@$target.pilot">
				<set_value name="$leaderpilot" exact="$target.pilot"/>
				<do_if value="not $leaderpilot.$escortgroup?">
					<debug_text text="'creating escort list'" chance="@$debugchance" />
					<create_group groupname="$leaderpilot.$escortgroup"/>
				</do_if>
				<add_to_group groupname="$leaderpilot.$escortgroup" object="this.ship"/>
			</do_if>
		</do_if>

		<set_value name="this.$goattack" exact="false" />
	</add>
<!-- add prepend. purpose avoid or not
	<do_if value="@$target.isoperational">
-->
	<add pos="prepend" sel="//attention[@min=&quot;unknown&quot;]//do_if[@value=&quot;@$target.isoperational&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' do_if @$target.isoperational'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
		<do_if value="@$kAAITParam_isAvoidHighRisk and (not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isIgnoreKAAIT)">
			<do_if value="this.sector == $target.sector">
				<include_interrupt_actions ref="kAAIT_AvoidOrNot" />
				<do_if value="@$kAAIT_result_avoidEnemy.isoperational">
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$target_avoid" exact="$kAAIT_result_avoidEnemy" />
					<resume label="kAAIT_label_avoid" />
				</do_if>
			</do_if>
		</do_if>
	</add>
<!-- add / replace. purpose: move to pos behind target if non-fighter
	<move_to object="this.ship" destination="$target.zone" uselocalhighways="false">
		<position object="$target" min="this.ship.size + $target.size" max="$radius"/>
-->
	<add pos="before" sel="//attention[@min=&quot;unknown&quot;]//move_to[@object=&quot;this.ship&quot;][@destination=&quot;$target.zone&quot;][@uselocalhighways=&quot;false&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' move_to'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
		<create_position name="$kAAIT_pos" object="$target" min="this.ship.size + $target.size" max="$radius" />
		<do_if value="@$kAAITParam_isAvoidHighRisk and (not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isIgnoreKAAIT)">
			<set_value name="$kAAIT_target_escort" exact="$target" />
			<include_interrupt_actions ref="kAAIT_GetEscortPos" />
			<get_safe_pos result="$kAAIT_pos" zone="$target.zone" object="$target.sector" value="$kAAIT_result_pos_escort" />
			<set_value name="$kAAIT_orderLocation_space" exact="$target.zone" />
			<set_value name="$kAAIT_orderLocation_pos" exact="$kAAIT_pos" />
		</do_if>
	</add>
	<replace sel="//attention[@min=&quot;unknown&quot;]//move_to[@object=&quot;this.ship&quot;][@destination=&quot;$target.zone&quot;][@uselocalhighways=&quot;false&quot;]/position">
		<position value="$kAAIT_pos" />
	</replace>
<!-- add before. purpose: add the missing fight label
	<label name="finish" />
-->
	<add pos="before" sel="//attention[@min=&quot;unknown&quot;]//label[@name=&quot;finish&quot;]">
		<label name="fight" />
		<debug_text text="this.assignedcontrolled.idcode + ' fight'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />

		<do_if value="this.$goattack">
			<do_if value="$target.isoperational and $enemy.isoperational">
				<do_if value="not this.mayattack.{$enemy}">
					<do_if value="this.isplayerowned">
						<set_relation_boost object="$enemy" otherobject="this" value="this.owner.relation.kill.min" decay="1" delay="10min" silent="true" />
					</do_if>
					<do_else>
						<set_relation_boost object="this" otherobject="$enemy" value="this.owner.relation.kill.min" decay="1" delay="10min" silent="true" />
					</do_else>
				</do_if>

				<do_if value="@$leaderpilot.$escortgroup">
					<remove_from_group group="$leaderpilot.$escortgroup" object="this.ship" />
				</do_if>
				<debug_text text="' I will attack you. Index: ' +$myindex " chance="@$debugchance" />

				<leave_formation object="this.assignedcontrolled"/>

				<create_order id="'Attack'" object="this.ship" immediate="true">
					<param name="primarytarget" value="$enemy" />
					<param name="escort" value="$target" />
					<param name="pursuedistance" value="$pursuedistance" comment="make sure to be the same distance as max attack range" />
					<param name="pursuetargets" value="false"/>
					<param name="allowothertargets" value="true" />
					<param name="internalorder" value="true"/>
					<param name="debugchance" value="@$debugchance" />
				</create_order>

				<remove_value name="this.$goattack" />
			</do_if>
		</do_if>

		<resume label="start" />
	</add>
<!-- add after. purpose: finish.
	<label name="finish" />
-->
	<add pos="after" sel="//attention[@min=&quot;unknown&quot;]//label[@name=&quot;finish&quot;]">
		<include_interrupt_actions ref="kAAIT_Deinit" />
	</add>
<!-- add. purpose: clean-up.
	<on_abort>
-->
	<add sel="//on_abort">
		<include_interrupt_actions ref="kAAIT_Deinit" />
	</add>
<!-- add. purpose: debug.
	<init>
-->
	<add pos="prepend" sel="//init">
		<debug_text text="this.assignedcontrolled.idcode + ' EVENT init'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
	<add pos="after" sel="//attention[@min=&quot;visible&quot;]//label[@name=&quot;start&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' LABEL start'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
	<add pos="after" sel="//attention[@min=&quot;visible&quot;]//label[@name=&quot;fight&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' LABEL fight'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
	<add pos="after" sel="//attention[@min=&quot;visible&quot;]//label[@name=&quot;finish&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' LABEL finish'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
	<add pos="after" sel="//attention[@min=&quot;visible&quot;]//wait[@exact=&quot;200ms&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' wait 200ms'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
	<add pos="before" sel="//attention[@min=&quot;visible&quot;]//run_script[@name=&quot;'move.generic'&quot;][@result=&quot;$movesuccess&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' move.generic'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
	<add pos="prepend" sel="//attention[@min=&quot;visible&quot;]//do_while[@value=&quot;$target.isoperational&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' do_while'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
	<add pos="before" sel="//attention[@min=&quot;visible&quot;]//create_formation[@leader=&quot;$target&quot;][@follower=&quot;this.assignedcontrolled&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' create_formation'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
	<add pos="before" sel="//attention[@min=&quot;visible&quot;]//wait[@min=&quot;10s&quot;][@max=&quot;20s&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' wait 10s 20s'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
	<add pos="after" sel="//attention[@min=&quot;unknown&quot;]//label[@name=&quot;start&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' LABEL start'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
	<add pos="after" sel="//attention[@min=&quot;unknown&quot;]//label[@name=&quot;fight&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' LABEL fight'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
	<add pos="after" sel="//attention[@min=&quot;unknown&quot;]//label[@name=&quot;finish&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' LABEL finish'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
	<add pos="before" sel="//attention[@min=&quot;unknown&quot;]//run_script[@name=&quot;'move.generic'&quot;][@result=&quot;$movesuccess&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' move.generic'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
	<add pos="before" sel="//attention[@min=&quot;unknown&quot;]//move_to[@object=&quot;this.ship&quot;][@destination=&quot;$target.zone.destination&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' move_to (in highway)'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
	<add pos="before" sel="//attention[@min=&quot;unknown&quot;]//move_to[@object=&quot;this.ship&quot;][@destination=&quot;$target.zone&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' move_to'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
	<add pos="before" sel="//attention[@min=&quot;unknown&quot;]//wait[@min=&quot;10s&quot;][@max=&quot;30s&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' wait 10s 30s'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
	<add pos="before" sel="//attention[@min=&quot;unknown&quot;]//create_formation[@leader=&quot;$target&quot;][@follower=&quot;this.assignedcontrolled&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' create_formation'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
</diff>
