<?xml version='1.0' encoding='utf-8'?>
<diff>
<!-- add. purpose: kaait data
  <params>
-->
  <add sel="//params">
    <param name="kAAITParam_iskAAITOrder" required="false" default="false" type="internal" />
    <param name="kAAITParam_isAvoidHighRisk" required="false" type="bool" text="{1111920, 3}" default="
      if this.$kAAIT_isAvoidHighRisk_user? then 
        this.$kAAIT_isAvoidHighRisk_user
      else (
        if (not this.assignedcontrolled.isunit) and (not this.assignedcontrolled.islasertower) and
        (
          (
            this.assignedcontrolled.isplayerowned and
            (
              this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m] or
              this.assignedcontrolled.primarypurpose != purpose.fight or
              (
                this.assignedcontrolled.type == shiptype.carrier and
                @this.assignedcontrolled.commander.isoperational
              )
            ) and
            @global.$kAAIT_Config.$xssm_isAvoidHighRisk
          ) or
          (
            (not this.assignedcontrolled.isplayerowned) and
            (
              this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m] or
              this.assignedcontrolled.primarypurpose != purpose.fight or
              (
                this.assignedcontrolled.type == shiptype.carrier and
                @this.assignedcontrolled.commander.isoperational
              )
            ) and
            @global.$kAAIT_Config.$xssm_isAvoidHighRisk_allFactions
          ) or
          (
            this.assignedcontrolled.isplayerowned and
            this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
            (
              @global.$kAAIT_Config.$lxl_isAvoidHighRisk_vShip or
              @global.$kAAIT_Config.$lxl_isAvoidHighRisk_vStation
            )
          ) or
          (
            (not this.assignedcontrolled.isplayerowned) and
            this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
            (
              @global.$kAAIT_Config.$lxl_isAvoidHighRisk_vShip_allFactions or
              @global.$kAAIT_Config.$lxl_isAvoidHighRisk_vStation_allFactions
            )
          )
        ) then true else false
      )
    " />
    <param name="kAAITParam_isStepForwardWithdraw" required="false" type="bool" text="{1111920, 109}" default="
      if (not this.assignedcontrolled.isunit) and (not this.assignedcontrolled.islasertower) and
      (
        (
          this.assignedcontrolled.isplayerowned and
          this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
          (
            @global.$kAAIT_Config.$lxl_isStepForward_vShip or
            @global.$kAAIT_Config.$lxl_isMoveOutOfRange_vShip or
            @global.$kAAIT_Config.$lxl_isStepForward_vStation or
            @global.$kAAIT_Config.$lxl_isMoveOutOfRange_vStation
          )
        ) or
        (
          (not this.assignedcontrolled.isplayerowned) and
          this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
          (
            @global.$kAAIT_Config.$lxl_isStepForward_vShip_allFactions or
            @global.$kAAIT_Config.$lxl_isMoveOutOfRange_vShip_allFactions or
            @global.$kAAIT_Config.$lxl_isStepForward_vStation_allFactions or
            @global.$kAAIT_Config.$lxl_isMoveOutOfRange_vStation_allFactions
          )
        )
      ) then true else false
    " />
  </add>
<!-- add. purspose: do not restock if commander has an attack order or there's an enemy nearby.
  <signal_objects object="event.object" param="'resupply'" param2="[false]" param3="$debugchance" delay="10ms" comment="param2 = [urgent?, resupplystationID], param3 = $debugchance"/>
-->
  <add pos="before" sel="//signal_objects[@param=&quot;'resupply'&quot;]">
    <set_value name="$kAAIT_restockChance" exact="100" />
    <do_if value="@$kAAITParam_isAvoidHighRisk and (not @this.$kAAIT_data.$isIgnoreKAAIT)">
      <do_if value="this.assignedcontrolled.hullpercentage gt 25">
        <include_interrupt_actions ref="kAAIT_GetBigEnemies" />
        <include_interrupt_actions ref="kAAIT_GetIsNearBigEnemies" />
        <do_if value="
          @$kAAIT_bigEnemy.isoperational or
          @this.assignedcontrolled.commaner.order.id == 'Attack' or
          @this.assignedcontrolled.commaner.nextoder.id == 'Attack' or
          @this.assignedcontrolled.commaner.order.id == 'TacticalOrder' or
          @this.assignedcontrolled.commaner.nextoder.id == 'TacticalOrder'">
          <set_value name="$kAAIT_restockChance" exact="0" />
        </do_if>
      </do_if>
    </do_if>
  </add>
  <add sel="//signal_objects[@param=&quot;'resupply'&quot;]" type="@chance">$kAAIT_restockChance</add>
</diff>
