<?xml version="1.0" encoding="utf-8" ?>
<diff>
<!-- kaait data
	<params>
-->
	<add sel="//params">
		<param name="kAAITParam_iskAAITOrder" required="false" default="false" type="internal" />
		<param name="kAAITParam_isAvoidHighRisk" required="false" type="bool" text="{1111920, 3}" default="
			if (not this.assignedcontrolled.isunit) and (not this.assignedcontrolled.islasertower) and
			(
				(
					this.assignedcontrolled.isplayerowned and
					((not @this.assignedcontrolled.iscapitalship) or this.assignedcontrolled.primarypurpose != purpose.fight) and
					@global.$kAAIT_Data.$xssm_isAvoidHighRisk and
					(
						(not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_isAvoidHighRisk_user?) or
						@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_isAvoidHighRisk_user
					)
				) or
				(
					(not this.assignedcontrolled.isplayerowned) and
					((not @this.assignedcontrolled.iscapitalship) or this.assignedcontrolled.primarypurpose != purpose.fight) and
					@global.$kAAIT_Data.$xssm_isAvoidHighRisk_allFactions
				) or
				(
					this.assignedcontrolled.isplayerowned and
					@this.assignedcontrolled.iscapitalship and
					(@global.$kAAIT_Data.$lxl_isAvoidHighRisk_vShip or @global.$kAAIT_Data.$lxl_isAvoidHighRisk_vStation) and
					(
						(not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_isAvoidHighRisk_user?) or
						@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_isAvoidHighRisk_user
					)
				) or
				(
					(not this.assignedcontrolled.isplayerowned) and
					@this.assignedcontrolled.iscapitalship and
					(@global.$kAAIT_Data.$lxl_isAvoidHighRisk_vShip_allFactions or @global.$kAAIT_Data.$lxl_isAvoidHighRisk_vStation_allFactions)
				)
			) then true else false">
			<editable/>
		</param>
		<param name="kAAITParam_isStepForwardWithdraw" required="false" type="bool" text="{1111920, 109}" default="
			if (not this.assignedcontrolled.isunit) and (not this.assignedcontrolled.islasertower) and
			(
				(
					this.assignedcontrolled.isplayerowned and
					(
						(not @this.assignedcontrolled.iscapitalship) or
						this.assignedcontrolled.primarypurpose != purpose.fight
					) and
					@global.$kAAIT_Data.$xssm_isAvoidHighRisk and
					(
						(not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_isStepForwardWithdraw_user?) or
						@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_isStepForwardWithdraw_user
					)
				) or
				(
					(not this.assignedcontrolled.isplayerowned) and
					(
						(not @this.assignedcontrolled.iscapitalship) or
						this.assignedcontrolled.primarypurpose != purpose.fight
					) and
					@global.$kAAIT_Data.$xssm_isAvoidHighRisk_allFactions
				) or
				(
					this.assignedcontrolled.isplayerowned and
					@this.assignedcontrolled.iscapitalship and
					(
						@global.$kAAIT_Data.$lxl_isStepForward_vShip or
						@global.$kAAIT_Data.$lxl_isMoveOutOfRange_vShip or
						@global.$kAAIT_Data.$lxl_isStepForward_vStation or
						@global.$kAAIT_Data.$lxl_isMoveOutOfRange_vStation
					) and
					(
						(not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_isStepForwardWithdraw_user?) or
						@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_isStepForwardWithdraw_user
					)
				) or
				(
					(not this.assignedcontrolled.isplayerowned) and
					@this.assignedcontrolled.iscapitalship and
					(
						@global.$kAAIT_Data.$lxl_isStepForward_vShip_allFactions or
						@global.$kAAIT_Data.$lxl_isMoveOutOfRange_vShip_allFactions or
						@global.$kAAIT_Data.$lxl_isStepForward_vStation_allFactions or
						@global.$kAAIT_Data.$lxl_isMoveOutOfRange_vStation_allFactions
					) and
					(
						(not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_isStepForwardWithdraw_user?) or
						@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_isStepForwardWithdraw_user
					)
				)
			) then true else false">
			<editable/>
		</param>
		<param name="kAAITParam_isSurroundTheTarget" required="false" type="bool" text="{1111920, 118}" default="false">
			<editable/>
		</param>
	</add>
<!-- set default attack weaker enemies first to false
	<param name="weakfirst" type="bool" default="true" />
-->
	<replace sel="//param[@name=&quot;weakfirst&quot;][@type=&quot;bool&quot;][@default=&quot;true&quot;]/@default">false</replace>
<!-- show movement.
	<location object="$selectedtarget.toplevelcommander" condition="$selectedtarget.canbeattacked" />
-->
	<add pos="before" sel="//location[@object=&quot;$selectedtarget.toplevelcommander&quot;][@condition=&quot;$selectedtarget.canbeattacked&quot;]">
		<location object="$selectedtarget.sector" position="$initialpos" condition="$selectedtarget? and $selectedtarget.sector? and $initialpos?" />
		<location object="$primarytarget" condition="$primarytarget? and @$primarytarget.isoperational" />
		<location object="$selectedtarget" condition="$selectedtarget? and @$selectedtarget.iscapitalship or $selectedtarget.isclass.station or @$selectedtarget.defensible.isclass.station" />
	</add>
<!-- not required.
	<location object="$selectedtarget.toplevelcommander" condition="$selectedtarget.canbeattacked" />
-->
	<remove sel="//location[@object=&quot;$selectedtarget.toplevelcommander&quot;][@condition=&quot;$selectedtarget.canbeattacked&quot;]" />
<!-- if ship is alread an l or xl, do not find commander.
	<actions name="select_targets">
		<do_if value="not $primarytarget.isoperational">
			<do_while value="$primarytarget.commander.canbeattacked and ($primarytarget.commander.sector == $primarytarget.sector)">
-->
	<add pos="after" sel="//actions[@name=&quot;select_targets&quot;]//do_while[@value=&quot;$primarytarget.commander.canbeattacked and ($primarytarget.commander.sector == $primarytarget.sector)&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' $primarytarget.idcode: ' + @$primarytarget.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
	</add>
	<replace sel="//actions[@name=&quot;select_targets&quot;]//do_while[@value=&quot;$primarytarget.commander.canbeattacked and ($primarytarget.commander.sector == $primarytarget.sector)&quot;]/@value">(not $primarytarget.isclass.[class.ship_l, class.ship_xl]) and $primarytarget.commander.canbeattacked and ($primarytarget.commander.sector == $primarytarget.sector)</replace>
<!--
	=====
	debug
	=====
-->
	<add pos="prepend" sel="//actions[@name=&quot;clear_previous_orders&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' clear_previous_orders'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
	</add>
	<add pos="prepend" sel="//actions[@name=&quot;clear_all_orders&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' clear_all_orders'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
	</add>
	<add pos="prepend" sel="//actions[@name=&quot;create_orders&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' create_orders ' + $subordinate.knownname + ' ' + $subordinate.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
	</add>
	<add pos="after" sel="//actions[@name=&quot;create_orders&quot;]//create_order[@object=&quot;$subordinate&quot;][@id=&quot;'ProtectShip'&quot;][@immediate=&quot;true&quot;][@name=&quot;$mainorder&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + '    create_order ProtectShip $mainorder: ' + $mainorder" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
	</add>
	<add pos="after" sel="//actions[@name=&quot;create_orders&quot;]//create_order[@object=&quot;$subordinate&quot;][@id=&quot;'Attack'&quot;][@immediate=&quot;true&quot;][@name=&quot;$mainorder&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + '    create_order Attack $mainorder: ' + $mainorder" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
	</add>
	<add pos="after" sel="//actions[@name=&quot;create_orders&quot;]//create_order[@object=&quot;$subordinate&quot;][@id=&quot;'MoveWait'&quot;][@immediate=&quot;true&quot;][@name=&quot;$moveorder&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + '    create_order MoveWait $moveorder: ' + $moveorder" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
	</add>
	<add pos="after" sel="//actions[@name=&quot;create_orders&quot;]//create_order[@object=&quot;$subsubordinate&quot;][@id=&quot;'Escort'&quot;][@immediate=&quot;true&quot;][@name=&quot;$escortorder&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + '    create_order Escort $moveorder: ' + $escortorder" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
	</add>
	<add pos="after" sel="//label[@name=&quot;start&quot;]">
		<set_value name="$debugchance" exact="100" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL start'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
	</add>
	<add pos="after" sel="//label[@name=&quot;targetselection&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL targetselection'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
	</add>
	<add pos="after" sel="//label[@name=&quot;giveorders&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL giveorders'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
	</add>
	<add pos="after" sel="//label[@name=&quot;attack&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL attack'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		<debug_text text="@this.assignedcontrolled.idcode + ' $releasemove: ' + $releasemove" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
	</add>
	<add pos="after" sel="//label[@name=&quot;finish&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL finish'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
	</add>
	<add pos="prepend" sel="//on_abort">
		<debug_text text="@this.assignedcontrolled.idcode + ' on_abort'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
	</add>
<!--
	========================
	ignore subordinates away
	========================
	<actions name="create_orders">
		<do_if value="$assignments.indexof.{$subordinate.assignment} and not $subordinate.subordinategroupdockoverride">
-->
	<add pos="before" sel="//actions[@name=&quot;create_orders&quot;]/do_if[@value=&quot;$assignments.indexof.{$subordinate.assignment} and not $subordinate.subordinategroupdockoverride&quot;]">
		<set_value name="$kAAIT_isOkToJoinTacticalAttack" exact="$subordinate.gatedistance.{this.assignedcontrolled} le 0 and
			(
				$subordinate.orders.count le 0 or
				$subordinate.orders.{1}.script == 'order.move.wait.object' or
				$subordinate.orders.{1}.script == 'order.move.wait' or
				$subordinate.orders.{1}.script == 'order.wait.signal' or
				$subordinate.orders.{1}.script == 'order.wait'
			)" />
	</add>
	<add sel="//actions[@name=&quot;create_orders&quot;]/do_if[@value=&quot;$assignments.indexof.{$subordinate.assignment} and not $subordinate.subordinategroupdockoverride&quot;]" type="@chance">if $kAAIT_isOkToJoinTacticalAttack then 100 else 0</add>
<!--
	==============
	wait positions
	==============
	based on MTE positions
-->
	<add sel="//interrupts/library">
		<actions name="kAAIT_GetAttackPosition" comment="overrides $initialpos">
			<create_position name="$kAAIT_posShip" space="$primarytarget.sector" object="this.assignedcontrolled" />
			<create_position name="$kAAIT_posTarget" space="$primarytarget.sector" object="$primarytarget" />
			<create_orientation name="$kAAIT_rotDefensibleTargetToShip" orientation="look_at" refposition="$kAAIT_posShip">
				<position value="$kAAIT_posTarget" />
			</create_orientation>
			<set_value name="$kAAIT_test_moveToEngageTarget" exact="$primarytarget" />
			<include_interrupt_actions ref="KAAIT_GetEngagePosDistance" />
			<set_value name="$kAAIT_shipIndex" exact="this.assignedcontrolled.allsubordinates.indexof.{$kAAIT_attackingShip}" />
			<do_if value="$forcedassignment == assignment.defence">
				<do_if value="$kAAIT_shipIndex % 2 == 0">
					<set_value name="$kAAIT_yaw" exact="$kAAIT_rotDefensibleTargetToShip.yaw + ($kAAIT_shipIndex * - 2)deg" />
				</do_if>
				<do_else>
					<set_value name="$kAAIT_yaw" exact="$kAAIT_rotDefensibleTargetToShip.yaw + ($kAAIT_shipIndex * 2)deg" />
				</do_else>
				<create_position name="$initialpos"
					x="$kAAIT_posTarget.x + ($kAAIT_result_engagePosDist + 5km) * sin($kAAIT_yaw) * cos($kAAIT_rotDefensibleTargetToShip.pitch)"
					y="$kAAIT_posTarget.y + ($kAAIT_result_engagePosDist + 5km) * sin($kAAIT_rotDefensibleTargetToShip.pitch)"
					z="$kAAIT_posTarget.z + ($kAAIT_result_engagePosDist + 5km) * cos($kAAIT_yaw) * cos($kAAIT_rotDefensibleTargetToShip.pitch)"/>
			</do_if>
			<do_else>
				<do_if value="$kAAITParam_isSurroundTheTarget">
					<set_value name="$kAAIT_yaw_separation" exact="360 / (this.assignedcontrolled.allsubordinates.count + 1)f" />
					<set_value name="$kAAIT_yaw" exact="($kAAIT_yaw_separation * $kAAIT_shipIndex)deg" />
				</do_if>
				<do_else>
					<do_if value="$kAAIT_shipIndex % 2 == 0">
						<set_value name="$kAAIT_yaw" exact="$kAAIT_rotDefensibleTargetToShip.yaw + ($kAAIT_shipIndex * - 2)deg" />
					</do_if>
					<do_else>
						<set_value name="$kAAIT_yaw" exact="$kAAIT_rotDefensibleTargetToShip.yaw + ($kAAIT_shipIndex * 2)deg" />
					</do_else>
				</do_else>
				<create_position name="$initialpos"
					x="$kAAIT_posTarget.x + $kAAIT_result_engagePosDist * sin($kAAIT_yaw) * cos($kAAIT_rotDefensibleTargetToShip.pitch)"
					y="$kAAIT_posTarget.y + $kAAIT_result_engagePosDist * sin($kAAIT_rotDefensibleTargetToShip.pitch)"
					z="$kAAIT_posTarget.z + $kAAIT_result_engagePosDist * cos($kAAIT_yaw) * cos($kAAIT_rotDefensibleTargetToShip.pitch)"/>
			</do_else>
		</actions>
	</add>
<!--
	<create_order object="$subordinate" id="'MoveWait'"  immediate="true" name="$moveorder">
-->
	<add pos="before" sel="//create_order[@object=&quot;$subordinate&quot;][@id=&quot;'MoveWait'&quot;][@immediate=&quot;true&quot;][@name=&quot;$moveorder&quot;]">
		<set_value name="$kAAIT_attackingShip" exact="$subordinate" />
		<include_interrupt_actions ref="kAAIT_GetAttackPosition" />
	</add>
	<!--
	<move_to destination="$primarytarget.sector" object="this.ship" forcerotation="true" forceposition="false" travel="true">
	-->
	<add pos="before" sel="//move_to[@destination=&quot;$primarytarget.sector&quot;][@object=&quot;this.ship&quot;][@forcerotation=&quot;true&quot;][@forceposition=&quot;false&quot;][@travel=&quot;true&quot;]">
		<set_value name="$kAAIT_attackingShip" exact="this.assignedcontrolled" />
		<include_interrupt_actions ref="kAAIT_GetAttackPosition" />
	</add>
<!--
	=============
	cancel orders
	=============
	<interrupts>
-->
	<add sel="//interrupts//library">
		<actions name="kAAIT_CancelWaitOrders" comment="cancel all waits and just fight">
			<set_value name="$releasemove" exact="true" />
			<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_CancelWaitOrders $ORDERS.keys.list: ' + @$ORDERS.keys.list" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			<do_for_each name="$ordergroup" in="$ORDERS">
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_CancelWaitOrders $ORDERS.{$ordergroup}.$MoveWait.count: ' + @$ORDERS.{$ordergroup}.$MoveWait.count" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<do_if value="@$ORDERS.{$ordergroup}.$MoveWait">
					<do_for_each name="$order" in="$ORDERS.{$ordergroup}.$MoveWait">
						<do_if value="$order.exists">
							<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_CancelWaitOrders $order.script: ' + @$order.script" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
							<unassign_order_syncpoint_from_order order="$order" />
							<cancel_order order="$order" />
						</do_if>
					</do_for_each>
				</do_if>
			</do_for_each>
		</actions>
	</add>
<!--
	===============
	kuda behaviours
	===============
-->
	<add sel="//init">
		<set_value name="$kAAIT_isAttackOtherTargets" exact="false" />
	</add>
	<!-- tag orders attack as coordinated attack orders
		<actions name="create_orders">
			...
			<create_order object="$subordinate" id="'Attack'" immediate="true" name="$mainorder" >
			...
			<create_order object="$subordinate" id="'MoveWait'"  immediate="true" name="$moveorder">
	-->
	<add sel="//create_order[@object=&quot;$subordinate&quot;][@id=&quot;'Attack'&quot;]">
		<param name="kAAITParam_isFromTactical" value="true" />
	</add>
	<add sel="//create_order[@object=&quot;$subordinate&quot;][@id=&quot;'MoveWait'&quot;]">
		<param name="kAAITParam_tacticalOrderTarget" value="$primarytarget" />
	</add>
	<!-- -->
	<add pos="prepend" sel="//handler[@comment=&quot;Order cancelled&quot;]/actions">
		<debug_text text="@this.assignedcontrolled.idcode + ' EVENT event.name: ' + @event.name + ' event.param: ' + @event.param + ' order.script: ' + @this.assignedcontrolled.order.script" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		<set_value name="$kAAIT_isCancelled" exact="true" />
	</add>
	<add pos="prepend" sel="//interrupts">
		<handler ref="kAAIT_Handler_AvoidWithdrawOrJustFight" />
	</add>
	<add pos="before" sel="//label[@name=&quot;start&quot;]">
		<set_value name="$kAAIT_isScriptHasAvoidLabel" exact="true" />
		<set_value name="$kAAIT_isScriptHasWithdrawLabel" exact="true" />
		<resume label="start" />

		<label name="kAAIT_label_avoid" />
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL kAAIT_label_avoid'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		<include_interrupt_actions ref="kAAIT_Order_Avoid" />
		<wait min="1s" max="3s" comment="stop this order from continuing as the new order is created" />
		<resume label="start" comment="in case the new order fails, do this" />

		<label name="kAAIT_label_withdraw" />
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL kAAIT_label_withdraw'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		<include_interrupt_actions ref="kAAIT_Order_Withdraw" />
		<wait min="1s" max="3s" comment="stop this order from continuing as the new order is created" />
		<resume label="start" comment="in case the new order fails, do this" />
	</add>
	<add pos="after" sel="//label[@name=&quot;start&quot;]">
		<set_value name="$kAAIT_orderLocation_space" exact="$primarytarget" />
		<set_value name="$kAAIT_sector_start" exact="$primarytarget.sector" />
		<create_position name="$kAAIT_orderLocation_pos" x="0" y="0" z="0" />
		<create_position name="$kAAIT_pos_tacticatTarget" space="$primarytarget.zone" value="$primarytarget.position" />

		<set_value name="$kAAIT_test_target_isAvoid" exact="null" />
		<include_interrupt_actions ref="kAAIT_GetAvoidOrNot" />
		<do_if value="@$kAAIT_result_avoidEnemy.isoperational or @$kAAIT_result_withdrawFromEnemy.isoperational">
			<do_if value="@$kAAIT_result_avoidEnemy.isoperational and @$kAAITParam_isAvoidHighRisk">
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid" exact="$kAAIT_result_avoidEnemy" />
				<resume label="kAAIT_label_avoid" />
			</do_if>
			<do_elseif value="@$kAAIT_result_withdrawFromEnemy.isoperational and @$kAAITParam_isStepForwardWithdraw">
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid" exact="$kAAIT_result_withdrawFromEnemy" />
				<resume label="kAAIT_label_withdraw" />
			</do_elseif>
		</do_if>
	</add>
<!--
	============================================
	create_order instead of run_script attack ai
	============================================
	<run_script name="'order.fight.attack.object'">
-->
	<add pos="before" sel="//run_script[@name=&quot;'order.fight.attack.object'&quot;]">
		<label name="kAAIT_label_just_fight" />
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL kAAIT_label_just_fight'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		<do_if value="not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}">
			<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}" exact="table[]" />
		</do_if>
		<create_order object="this.assignedcontrolled" id="'Attack'" immediate="true">
	        <param name="primarytarget" value="$primarytarget"/>
			<param name="pursuedistance" value="this.assignedcontrolled.maxradarrange" />
			<param name="pursuetargets" value="true" />
	        <param name="allowothertargets" value="if this.ship.isplayerowned
				then (
					if global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_isAllowOtherTargets_user?
					then global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_isAllowOtherTargets_user
					else @$kAAIT_isAttackOtherTargets
				) else true" />
	        <param name="allowboost" value="true" />
	        <param name="squad_attack" value="false"/>
			<param name="kAAITParam_isAvoidHighRisk" value="@$kAAITParam_isAvoidHighRisk" />
			<param name="kAAITParam_isStepForwardWithdraw" value="@$kAAITParam_isStepForwardWithdraw" />
			<param name="kAAITParam_isFromTactical" value="true" />
		</create_order>
		<!-- also remove this coordinated attack order -->
		<do_for_each name="$kAAIT_order" in="this.assignedcontrolled.orders">
			<do_if value="$kAAIT_order.script == 'order.fight.tactical' and $kAAIT_order.$selectedtarget == $primarytarget">
				<!-- <append_to_list name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_tacticalOrdersToCancel" exact="$kAAIT_order" /> -->
				<unassign_order_syncpoint_from_order order="$kAAIT_order" />
				<cancel_order order="$kAAIT_order" />
			</do_if>
		</do_for_each>
		<resume label="finish" />
	</add>
</diff>
