<?xml version='1.0' encoding='utf-8'?>
<diff>
<!-- add. purpose: params.
  <params>
-->
  <add sel="//params">
    <param name="kAAITParam_isAvoidHighRisk" required="false" type="bool" text="{1111920, 3}" default="
      if this.assignedcontrolled.$kAAIT_isAvoidHighRisk_user? then 
        this.assignedcontrolled.$kAAIT_isAvoidHighRisk_user
      else (
        if (not this.assignedcontrolled.isunit) and (not this.assignedcontrolled.islasertower) and
        (
          (
            this.assignedcontrolled.isplayerowned and
            (
              this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m]
            ) and
            @global.$kAAIT_Config.$xssm_isAvoidHighRisk
          ) or
          (
            (not this.assignedcontrolled.isplayerowned) and
            (
              this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m]
            ) and
            @global.$kAAIT_Config.$xssm_isAvoidHighRisk_allFactions
          ) or
          (
            this.assignedcontrolled.isplayerowned and
            this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
            (
              @this.assignedcontrolled.orders.{1}.id != 'Attack' and
              (not @this.assignedcontrolled.orders.{1}.$kAAITParam_iskAAITOrder)
            ) and
            (
              @global.$kAAIT_Config.$lxl_isAvoidHighRisk_vShip or
              @global.$kAAIT_Config.$lxl_isAvoidHighRisk_vStation
            )
          ) or
          (
            (not this.assignedcontrolled.isplayerowned) and
            this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
            (
              @this.assignedcontrolled.orders.{1}.id != 'Attack' and
              (not @this.assignedcontrolled.orders.{1}.$kAAITParam_iskAAITOrder)
            ) and
            (
              @global.$kAAIT_Config.$lxl_isAvoidHighRisk_vShip_allFactions or
              @global.$kAAIT_Config.$lxl_isAvoidHighRisk_vStation_allFactions
            )
          )
        ) then true else false
      )
    "/>
  </add>
<!-- add before. purpose: show movement.
  <location object="$target" condition="$target.exists" />
-->
  <add pos="before" sel="//location[@object=&quot;$target&quot;][@condition=&quot;$target.exists&quot;]">
    <location object="@this.$kAAIT_data.$orderLocation_space" position="@this.$kAAIT_data.$orderLocation_pos" condition="@this.$kAAIT_data.$orderLocation_space and @this.$kAAIT_data.$orderLocation_pos" />
  </add>
<!-- add. purpose: withdraw ai.
  <interrupts>
-->
  <add sel="//interrupts">
    <handler ref="kAAIT_Handler_WithdrawOrJustFight"/>
  </add>
<!-- add before. purpose: prevent attack.
  <actions name="CreateAttackOrder">
    <create_order id="'Attack'" object="this.assignedcontrolled" immediate="true">
-->
  <add pos="before" sel="//actions[@name=&quot;CreateAttackOrder&quot;]//create_order[@id=&quot;'Attack'&quot;][@object=&quot;this.assignedcontrolled&quot;][@immediate=&quot;true&quot;]">
    <do_if value="@$kAAITParam_isAvoidHighRisk">
      <debug_text text="this.assignedcontrolled.idcode + ' CreateAttackOrder create_order Attack'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>" />
      <include_interrupt_actions ref="kAAIT_AvoidOrNot" />
    </do_if>
  </add>
<!-- add. purpose: debug.
  <attention min="visible">
    <label name="start" />
    <run_script name="'move.generic'" result="$movesuccess">
    <label name="finish" />
  <attention min="unknown">
    <label name="start" />
    <run_script name="'move.generic'" result="$movesuccess">
    <wait exact="500ms"/>
    <wait exact="$waittime">
    <label name="finish" />
-->
  <!-- <add pos="after" sel="//attention[@min=&quot;visible&quot;]//label[@name=&quot;start&quot;]">
    <debug_text text="this.assignedcontrolled.idcode + ' VISIBLE start'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>
  </add>
  <add pos="before" sel="(//attention[@min=&quot;visible&quot;]//set_value[@name=&quot;$enemy&quot;][@exact=&quot;null&quot;])[1]">
    <debug_text text="this.assignedcontrolled.idcode + ' enemy null'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>
  </add>
  <add pos="before" sel="//attention[@min=&quot;visible&quot;]//do_if[@value=&quot;$target.trueowner != this.trueowner&quot;]">
    <debug_text text="this.assignedcontrolled.idcode + ' $target.trueowner != this.trueowner'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>
  </add>
  <add pos="before" sel="//attention[@min=&quot;visible&quot;]//do_if[@value=&quot;@this.assignedcontrolled.allsubordinates.indexof.{$target} or ($target.isformationwingman and $target.formationleader == this.assignedcontrolled)&quot;]">
    <debug_text text="this.assignedcontrolled.idcode + ' subordinates and target'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>
  </add>
  <add pos="before" sel="(//attention[@min=&quot;visible&quot;]//do_if[@value=&quot;(this.sector != $target.sector) or (((not this.assignedcontrolled.iscapitalship and not $target.zone.isclass.highway) or this.zone != $target.zone) and this.assignedcontrolled.bboxdistanceto.{$target} gt 10km)&quot;])[1]">
    <debug_text text="this.assignedcontrolled.idcode + ' far away'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>
  </add>
  <add pos="before" sel="//attention[@min=&quot;visible&quot;]//run_script[@name=&quot;'move.generic'&quot;][@result=&quot;$movesuccess&quot;]">
    <debug_text text="this.assignedcontrolled.idcode + ' run_script move.generic'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>
  </add>
  <add pos="before" sel="//attention[@min=&quot;visible&quot;]//wait[@max=&quot;500ms&quot;]">
    <debug_text text="this.assignedcontrolled.idcode + ' wait 500ms'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>
  </add>
  <add pos="before" sel="(//attention[@min=&quot;visible&quot;]//do_if[@value=&quot;$target.isoperational&quot;])[3]">
    <debug_text text="this.assignedcontrolled.idcode + ' before $target.isoperational'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>
  </add>
  <add pos="prepend" sel="(//attention[@min=&quot;visible&quot;]//do_if[@value=&quot;$target.isoperational&quot;])[3]">
    <debug_text text="this.assignedcontrolled.idcode + ' prepend $target.isoperational'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>
  </add>
  <add pos="after" sel="(//attention[@min=&quot;visible&quot;]//do_if[@value=&quot;$target.isoperational&quot;])[3]">
    <debug_text text="this.assignedcontrolled.idcode + ' after $target.isoperational'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>
  </add>
  <add pos="before" sel="//attention[@min=&quot;visible&quot;]//do_if[@value=&quot;player.age lt @$time_rejoinformation&quot;]">
    <debug_text text="this.assignedcontrolled.idcode + ' before player.age (' + player.age + ') lt @$time_rejoinformation (' + @$time_rejoinformation + '): ' + (player.age - @$time_rejoinformation)" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>
  </add>
  <add pos="after" sel="//attention[@min=&quot;visible&quot;]//do_if[@value=&quot;player.age lt @$time_rejoinformation&quot;]">
    <debug_text text="this.assignedcontrolled.idcode + ' after player.age (' + player.age + ') lt @$time_rejoinformation (' + @$time_rejoinformation + '): ' + (player.age - @$time_rejoinformation)" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>
  </add>
  <add pos="before" sel="//attention[@min=&quot;visible&quot;]//do_while[@value=&quot;$target.isoperational and (($target.owner == faction.player) or $leaderpilot)&quot;]">
    <debug_text text="this.assignedcontrolled.idcode + ' before do_while $target.isoperational'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>" />
  </add>
  <add pos="prepend" sel="//attention[@min=&quot;visible&quot;]//do_while[@value=&quot;$target.isoperational and (($target.owner == faction.player) or $leaderpilot)&quot;]">
    <debug_text text="this.assignedcontrolled.idcode + ' prepend do_while $target.isoperational'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>" />
  </add>
  <add pos="after" sel="//attention[@min=&quot;visible&quot;]//do_while[@value=&quot;$target.isoperational and (($target.owner == faction.player) or $leaderpilot)&quot;]">
    <debug_text text="this.assignedcontrolled.idcode + ' after do_while $target.isoperational'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>" />
  </add>
  <add pos="after" sel="//attention[@min=&quot;visible&quot;]//label[@name=&quot;finish&quot;]">
    <debug_text text="this.assignedcontrolled.idcode + ' VISIBLE finish'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>
  </add>
  <add pos="after" sel="//attention[@min=&quot;unknown&quot;]//label[@name=&quot;start&quot;]">
    <debug_text text="this.assignedcontrolled.idcode + ' UNKNOWN start'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>
  </add>
  <add pos="before" sel="//attention[@min=&quot;unknown&quot;]//run_script[@name=&quot;'move.generic'&quot;][@result=&quot;$movesuccess&quot;]">
    <debug_text text="this.assignedcontrolled.idcode + ' run_script move.generic'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>
  </add>
  <add pos="before" sel="//attention[@min=&quot;unknown&quot;]//wait[@exact=&quot;500ms&quot;]">
    <debug_text text="this.assignedcontrolled.idcode + ' wait 500ms'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>
  </add>
  <add pos="before" sel="//attention[@min=&quot;unknown&quot;]//wait[@exact=&quot;$waittime&quot;]">
    <debug_text text="this.assignedcontrolled.idcode + ' wait waittime'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>
  </add>
  <add pos="after" sel="//attention[@min=&quot;unknown&quot;]//label[@name=&quot;finish&quot;]">
    <debug_text text="this.assignedcontrolled.idcode + ' UNKNOWN finish'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>
  </add> -->
<!-- add before. purpose: prevent attacks.
  <do_if value="@$target.pilot.$attacktarget.canbeattacked">
-->
  <add pos="before" sel="//attention[@min=&quot;visible&quot;]//do_if[@value=&quot;@$target.pilot.$attacktarget.canbeattacked&quot;]">
    <debug_text text="this.assignedcontrolled.idcode + ' $target.pilot.$attacktarget: ' + @$target.pilot.$attacktarget" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>" />
    <do_if value="@$kAAITParam_isAvoidHighRisk">
      <resume label="skip_attack" />
    </do_if>
  </add>
  <add pos="after" sel="//attention[@min=&quot;visible&quot;]//do_if[@value=&quot;@$target.pilot.$attacktarget.canbeattacked&quot;]">
    <label name="skip_attack" />
    <do_if value="@$kAAITParam_isAvoidHighRisk">
      <debug_text text="this.assignedcontrolled.idcode + ' skip_attack'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>" />
    </do_if>
  </add>
<!-- add prepend. purpose: move away on attacks.
  <do_if value="player.age lt @$time_rejoinformation">
    <wait exact="player.age - $time_rejoinformation" sinceversion="14"/>
-->
  <add pos="prepend" sel="//attention[@min=&quot;visible&quot;]//do_if[@value=&quot;player.age lt @$time_rejoinformation&quot;]/wait[@exact=&quot;player.age - $time_rejoinformation&quot;]">
    <interrupt>
      <conditions>
        <check_any>
          <event_object_attacked object="this.assignedcontrolled" />
          <event_object_attacked object="$target" />
          <event_object_attacked_object object="$target" />
        </check_any>
        <check_value value="@$kAAITParam_isAvoidHighRisk" />
      </conditions>
      <actions>
        <do_if value="@$kAAITParam_isAvoidHighRisk">
          <debug_text text="this.assignedcontrolled.idcode + ' event.name (player.age lt @$time_rejoinformation): ' + event.name" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>" />
          <do_if value="['event_object_attacked', 'event_object_attacked_object', 'event_object_enemy_found', 'event_object_signalled'].indexof.{event.name}">
            <include_interrupt_actions ref="kAAIT_AvoidOrNot" />
          </do_if>
        </do_if>
      </actions>
    </interrupt>
  </add>
<!-- add prepend. purpose: move away on attacks.
  <do_while value="$target.isoperational and (($target.owner == faction.player) or $leaderpilot)">
    <wait>
      <conditions>
        <check_any>
      <actions>
-->
  <add pos="prepend" sel="//attention[@min=&quot;visible&quot;]//do_while[@value=&quot;$target.isoperational and (($target.owner == faction.player) or $leaderpilot)&quot;]//wait//conditions/check_any">
    <check_all>
      <check_any>
        <event_object_attacked object="this.assignedcontrolled" />
        <event_object_attacked object="$target" />
        <event_object_attacked_object object="$target" />
      </check_any>
      <check_value value="@$kAAITParam_isAvoidHighRisk" />
    </check_all>
  </add>
  <add pos="prepend" sel="//attention[@min=&quot;visible&quot;]//do_while[@value=&quot;$target.isoperational and (($target.owner == faction.player) or $leaderpilot)&quot;]//wait//actions">
    <do_if value="@$kAAITParam_isAvoidHighRisk">
      <debug_text text="this.assignedcontrolled.idcode + ' event.name (do_while $target.isoperational): ' + event.name" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>" />
      <do_if value="['event_object_attacked', 'event_object_attacked_object'].indexof.{event.name}">
        <include_interrupt_actions ref="kAAIT_AvoidOrNot" />
      </do_if>
    </do_if>
  </add>
<!-- add before. purpose: prevent attack.
  <create_order id="'Attack'" object="$locattacker" immediate="true">
-->
  <add pos="before" sel="//attention[@min=&quot;visible&quot;]//create_order[@id=&quot;'Attack'&quot;][@object=&quot;$locattacker&quot;][@immediate=&quot;true&quot;]">
    <do_if value="@$kAAITParam_isAvoidHighRisk">
      <do_if value="$locattacker == this.assignedcontrolled">
        <debug_text text="this.assignedcontrolled.idcode + ' create_order Attack'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>" />
        <include_interrupt_actions ref="kAAIT_AvoidOrNot" />
      </do_if>
    </do_if>
  </add>
<!-- add before. purpose: ensure labels between attentions are the same.
  <wait exact="500ms"/>
-->
  <add pos="before" sel="//attention[@min=&quot;unknown&quot;]//wait[@exact=&quot;500ms&quot;]">
    <label name="skip_attack" />
    <do_if value="@$kAAITParam_isAvoidHighRisk">
      <debug_text text="this.assignedcontrolled.idcode + ' skip_attack'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>" />
    </do_if>
  </add>
<!-- add prepend. purpose: move away on attacks.
  <wait exact="$waittime">
    <conditions>
      <check_any>
    <actions>
-->
  <add pos="prepend" sel="//attention[@min=&quot;unknown&quot;]//wait[@exact=&quot;$waittime&quot;]//conditions/check_any">
    <check_all>
      <check_any>
        <event_object_attacked object="this.assignedcontrolled" />
        <event_object_attacked object="$target" />
        <event_object_attacked_object object="$target" />
      </check_any>
      <check_value value="@$kAAITParam_isAvoidHighRisk" />
    </check_all>
  </add>
  <add pos="prepend" sel="//attention[@min=&quot;unknown&quot;]//wait[@exact=&quot;$waittime&quot;]//actions">
    <do_if value="@$kAAITParam_isAvoidHighRisk">
      <debug_text text="this.assignedcontrolled.idcode + ' event.name: ' + event.name" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>" />
      <do_if value="['event_object_attacked', 'event_object_attacked_object'].indexof.{event.name}">
        <include_interrupt_actions ref="kAAIT_AvoidOrNot" />
      </do_if>
    </do_if>
  </add>
<!-- add before. purpose: avoid.
  <move_to object="this.ship" destination="$target.zone" uselocalhighways="false" travel="true" sinceversion="2">
-->
  <add pos="before" sel="//attention[@min=&quot;unknown&quot;]//move_to[@object=&quot;this.ship&quot;][@destination=&quot;$target.zone&quot;][@uselocalhighways=&quot;false&quot;][@travel=&quot;true&quot;]">
    <do_if value="@$kAAITParam_isAvoidHighRisk">
      <debug_text text="this.assignedcontrolled.idcode + ' move_to $target.zone'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>" />
      <include_interrupt_actions ref="kAAIT_AvoidOrNot" />
    </do_if>
  </add>
<!-- add before. purpose: prevent attack.
  <create_order id="'Attack'" object="$locattacker" immediate="true">
-->
  <add pos="before" sel="//attention[@min=&quot;unknown&quot;]//create_order[@id=&quot;'Attack'&quot;][@object=&quot;$locattacker&quot;][@immediate=&quot;true&quot;]">
    <do_if value="@$kAAITParam_isAvoidHighRisk">
      <do_if value="$locattacker == this.assignedcontrolled">
        <debug_text text="this.assignedcontrolled.idcode + ' create_order Attack'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>" />
        <include_interrupt_actions ref="kAAIT_AvoidOrNot" />
      </do_if>
    </do_if>
  </add>
  <!-- DeadAir Diffs -->
  <replace sel="/aiscript/attention[@min='visible']/actions/do_if[@value='@$target.pilot.$attacktarget.canbeattacked']/shoot_at[@tolerance='12deg']/@tolerance">4.0deg</replace>
  <replace sel="/aiscript/attention[@min='visible']/actions/do_if[@value='@$target.pilot.$attacktarget.canbeattacked']/shoot_at[@tolerance='5deg']/@tolerance">4.0deg</replace>
  <replace sel="/aiscript/attention[@min='visible']/actions/do_while[@value='$target.isoperational and (($target.owner == faction.player) or $leaderpilot)']/wait/interrupt/actions/do_if/do_if[@value='@$params.{1}.canbeattacked']/shoot_at[@tolerance='12deg']/@tolerance">if $params.{1}.isclass.[class.ship_l, class.ship_xl, class.station] then 8.0deg else 4.0deg</replace>
  <replace sel="/aiscript/attention[@min='visible']/actions/do_while[@value='$target.isoperational and (($target.owner == faction.player) or $leaderpilot)']/wait/interrupt/actions/do_if/do_if[@value='@$params.{1}.canbeattacked']/shoot_at[@tolerance='5deg']/@tolerance">if $params.{1}.isclass.[class.ship_l, class.ship_xl, class.station] then 8.0deg else 4.0deg</replace>
</diff>
