<?xml version="1.0" encoding="utf-8" ?>
<aiscript name="move.kuertee.avoid" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="aiscripts.xsd" version="18">
	<order id="kAAIT_MoveAvoid" name="{1111920, 105}" description="{1111920, 105}" category="internal">
		<params>
			<param name="target" required="false" default="null" type="internal" />
			<param name="kAAITParam_iskAAITOrder" required="false" default="true" type="internal" />
			<param name="kAAITParam_isAvoidHighRisk" required="false" type="internal" text="{1111920, 3}" default="
				if this.assignedcontrolled.$kAAIT_isAvoidHighRisk_user? then 
					this.assignedcontrolled.$kAAIT_isAvoidHighRisk_user
				else (
					if (not this.assignedcontrolled.isunit) and (not this.assignedcontrolled.islasertower) and
					(
						(
							this.assignedcontrolled.isplayerowned and
							(
								this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m] or
								this.assignedcontrolled.primarypurpose != purpose.fight
							) and
							@global.$kAAIT_Config.$xssm_isAvoidHighRisk
						) or
						(
							(not this.assignedcontrolled.isplayerowned) and
							(
								this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m] or
								this.assignedcontrolled.primarypurpose != purpose.fight
							) and
							@global.$kAAIT_Config.$xssm_isAvoidHighRisk_allFactions
						) or
						(
							this.assignedcontrolled.isplayerowned and
							this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
							(
								@global.$kAAIT_Config.$lxl_isAvoidHighRisk_vShip or
								@global.$kAAIT_Config.$lxl_isAvoidHighRisk_vStation
							)
						) or
						(
							(not this.assignedcontrolled.isplayerowned) and
							this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
							(
								@global.$kAAIT_Config.$lxl_isAvoidHighRisk_vShip_allFactions or
								@global.$kAAIT_Config.$lxl_isAvoidHighRisk_vStation_allFactions
							)
						)
					) then true else false
				)
			" />
			<param name="kAAITParam_isStepForwardWithdraw" required="false" type="internal" text="{1111920, 109}" default="
				if (not this.assignedcontrolled.isunit) and
				(
					(
						this.assignedcontrolled.isplayerowned and
						this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
						(
							@global.$kAAIT_Config.$lxl_isStepForward_vShip or
							@global.$kAAIT_Config.$lxl_isMoveOutOfRange_vShip or
							@global.$kAAIT_Config.$lxl_isStepForward_vStation or
							@global.$kAAIT_Config.$lxl_isMoveOutOfRange_vStation
						)
					) or
					(
						(not this.assignedcontrolled.isplayerowned) and
						this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
						(
							@global.$kAAIT_Config.$lxl_isStepForward_vShip_allFactions or
							@global.$kAAIT_Config.$lxl_isMoveOutOfRange_vShip_allFactions or
							@global.$kAAIT_Config.$lxl_isStepForward_vStation_allFactions or
							@global.$kAAIT_Config.$lxl_isMoveOutOfRange_vStation_allFactions
						)
					)
				) then true else false
			" />
		</params>
		<requires>
			<match shiptype="shiptype.lasertower" negate="true"/>
		</requires>
		<location object="@this.$kAAIT_data.$orderLocation_space" position="@this.$kAAIT_data.$orderLocation_pos" condition="@this.$kAAIT_data.$orderLocation_space and @this.$kAAIT_data.$orderLocation_pos" />
	</order>
	<interrupts>
		<handler ref="DisengageHandler"/>
		<handler ref="kAAIT_Handler_WithdrawOrJustFight"/>
		<handler name="kAAIT_MoveAvoid_ShipOrTargetChangedZone">
			<conditions>
				<check_any>
					<event_object_changed_zone object="this.assignedcontrolled" />
					<event_object_changed_zone object="$target" />
					<event_object_attacked object="this.assignedcontrolled" />
				</check_any>
				<check_any>
					<check_value value="$target.isclass.ship" />
					<check_value value="event.name == 'event_object_attacked'" />
				</check_any>
			</conditions>
			<actions>
				<debug_text text="this.assignedcontrolled.idcode + ' event.name: ' + event.name" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<set_value name="$distToTarget" exact="this.assignedcontrolled.bboxdistanceto.{$target}" />
				<do_if value="
					event.name == 'event_object_attacked' or
					$distToTarget gt this.assignedcontrolled.maxradarrange or
					$distToTarget lt this.assignedcontrolled.maxradarrange * 0.25
				">
					<abort_called_scripts resume="finish" />
				</do_if>
			</actions>
		</handler>
		<handler ref="kAAIT_Handler_UpdateOrderLocation" />
	</interrupts>
	<init>
		<!-- required for disengage handler -->
		<set_value name="$pursuetargets" exact="false" />
		<set_value name="$pursuedistance" exact="this.assignedcontrolled.maxradarrange" />
		<set_value name="$debugchance" exact="0" />
	</init>
	<attention min="unknown">
		<actions>
			<do_if value="not $target">
				<resume label="finish" />
			</do_if>

			<include_interrupt_actions ref="kAAIT_Init" />

			<label name="start"/>
			<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_MoveEngagePosition start'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			<set_value name="$distToTarget" exact="this.assignedcontrolled.bboxdistanceto.{$target}" />
			<do_if value="not @this.$kAAIT_data.$aroundDir">
				<set_value name="this.$kAAIT_data.$aroundDir" exact="[-1, 1].random" />
			</do_if>
			<do_if value="@this.assignedcontrolled.orders.{2}.id == 'Attack'">
				<set_value name="this.$kAAIT_data.$aroundDir" exact="this.$kAAIT_data.$aroundDir * [-1, 1, 1, 1].random" comment="chance of reversal" />
			</do_if>

			<set_value name="$orderLocation_space" exact="this.assignedcontrolled.sector" />
			<create_position name="$posShip" space="$orderLocation_space" object="this.assignedcontrolled" />
			<create_position name="$posTarget" space="$orderLocation_space" object="$target" />
			<create_orientation name="$rotFromTarget" orientation="look_at" refposition="$posShip">
				<position value="$posTarget" />
			</create_orientation>
			<set_value name="$ship_yaw_deg" exact="$rotFromTarget.yaw * 180 / pi" />
			<set_value name="$ship_pitch_deg" exact="$rotFromTarget.pitch * 180 / pi" />
			<!-- <do_if value="
				(not this.assignedcontrolled.travel.active) and
				this.assignedcontrolled.speed le this.assignedcontrolled.maxspeed * 0.25
			"> -->
			<do_if value="not @this.assignedcontrolled.orders.{1}.exists">
				<debug_text text="this.assignedcontrolled.idcode + ' MOVING DIRECTLY BACK'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<set_value name="$yaw_deg" exact="$ship_yaw_deg" />
				<set_value name="$pitch_deg" exact="$ship_pitch_deg" />
			</do_if>
			<do_else>
				<debug_text text="this.assignedcontrolled.idcode + ' MOVING AROUND'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<set_value name="$yaw_adj" min="30" max="45" />
				<set_value name="$yaw_deg" exact="$ship_yaw_deg + $yaw_adj * this.$kAAIT_data.$aroundDir" />
				<set_value name="$pitch_adj" min="0" max="15" />
				<set_value name="$pitch_deg" exact="$ship_pitch_deg + $pitch_adj" />
			</do_else>
			<set_value name="$yaw" exact="$yaw_deg * pi / 180" />
			<set_value name="$pitch" exact="$pitch_deg * pi / 180" />
			<set_value name="$distAvoid" exact="this.assignedcontrolled.maxradarrange * 0.5" />
			<debug_text text="this.assignedcontrolled.idcode + ' $distAvoid: ' + @$distAvoid" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			<create_position name="$orderLocation_pos"
				x="$posTarget.x + $distAvoid * sin ($yaw) * cos ($pitch)"
				y="$posTarget.y + $distAvoid * sin ($pitch)"
				z="$posTarget.z + $distAvoid * cos ($yaw) * cos ($pitch)"
			/>
			<signal_objects object="this.assignedcontrolled" param="'update_order_location'" param2="table[$kAAIT_moveToSpace = $orderLocation_space, $kAAIT_moveToPos = $orderLocation_pos]" />
			<run_script name="'move.generic'" result="$movesuccess">
				<param name="destination" value="$orderLocation_space" />
				<param name="position" value="$orderLocation_pos" />
				<param name="kAAITParam_isSkipAvoidance" value="true" />
			</run_script>

			<label name="finish" />
			<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_MoveAvoid finish'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			<signal_objects object="this.assignedcontrolled" param="'update_order_location'" />
			<include_interrupt_actions ref="kAAIT_Deinit" />
		</actions>
	</attention>
	<on_abort>
		<include_interrupt_actions ref="kAAIT_Deinit" />
	</on_abort>
</aiscript>
