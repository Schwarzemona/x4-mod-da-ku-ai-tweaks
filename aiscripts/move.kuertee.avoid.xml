<?xml version="1.0" encoding="utf-8" ?>
<aiscript name="move.kuertee.avoid" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="aiscripts.xsd" version="18">
	<order id="kAAIT_MoveAvoid" name="{1111920, 105}" description="{1111920, 125}" category="internal">
		<params>
			<param name="target" required="true" type="object" text="{1041, 10126}" comment="target" />
			<param name="kAAITParam_iskAAITOrder" required="false" default="true" type="internal" />
		</params>
		<requires>
			<match shiptype="shiptype.lasertower" negate="true"/>
		</requires>
		<location object="@this.$kAAIT_data.$orderLocation_space" position="@this.$kAAIT_data.$orderLocation_pos" condition="@this.$kAAIT_data.$orderLocation_space and @this.$kAAIT_data.$orderLocation_pos" />
	</order>
	<interrupts>
		<handler ref="DisengageHandler"/>
		<handler ref="kAAIT_Handler_AvoidWithdrawOrJustFight" />
		<handler ref="kAAIT_Handler_NewBigTarget" />
		<handler comment="target destroyed">
			<conditions>
				<check_any>
					<event_object_destroyed object="$target" check="false" />
					<event_object_destroyed object="@this.$kAAIT_data.$defensibleTarget" check="false" />
				</check_any>
			</conditions>
			<actions>
				<abort_called_scripts resume="finish" />
			</actions>
		</handler>
		<handler comment="cancelled">
			<conditions>
				<event_object_order_cancelled object="this.assignedcontrolled" />
			</conditions>
			<actions>
				<debug_text text="this.assignedcontrolled.idcode + ' EVENT event.name: ' + event.name + ' event.param.id: ' + @event.param.id + ' event.param2: ' + @event.param2" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' EVENT this.assignedcontrolled.order.id: ' + @this.assignedcontrolled.order.id" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<do_if value="@this.assignedcontrolled.order.id != 'kAAIT_MoveAvoid'">
					<set_value name="this.$kAAIT_data.$time_avoidAllowed" exact="player.age + 10s" />
					<remove_value name="this.$kAAIT_data.$isAvoiding" />
					<remove_value name="this.$kAAIT_data.$target_avoid" />
					<remove_value name="this.$kAAIT_data.$orderLocation_space" />
					<remove_value name="this.$kAAIT_data.$orderLocation_pos" />
					<abort_called_scripts resume="finish" />
				</do_if>
			</actions>
		</handler>
	</interrupts>
	<init>
		<set_value name="$kAAIT_detailedDebugChance" exact="0" />
		<do_if value="not this.$kAAIT_data?">
			<set_value name="this.$kAAIT_data" exact="table[]" />
		</do_if>
		<remove_value name="this.$kAAIT_data.$time_avoidAllowed" />
		<set_value name="this.$kAAIT_data.$isAvoiding" exact="true" />
		<!-- required for disengage handler -->
		<set_value name="$pursuetargets" exact="false" />
		<set_value name="$pursuedistance" exact="this.assignedcontrolled.maxradarrange" />
		<set_value name="$debugchance" exact="$kAAIT_detailedDebugChance" />
	</init>
	<attention min="unknown">
		<actions>
			<do_if value="not $target">
				<resume label="finish" />
			</do_if>

			<include_interrupt_actions ref="kAAIT_Init" />

			<label name="start"/>
			<debug_text text="this.assignedcontrolled.idcode + ' LABEL start'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			<debug_text text="this.assignedcontrolled.idcode + ' $target: ' + @$target.knownname + ' ' + @$target.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode and $kAAIT_detailedDebugChance then @global.$kAAIT_Config.$debugChance else 0" />
			<debug_text text="this.assignedcontrolled.idcode + ' this.$kAAIT_data.$defensibleTarget: ' + @this.$kAAIT_data.$defensibleTarget.knownname + ' ' + @this.kAAIT_data.$defensibleTarget.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode and $kAAIT_detailedDebugChance then @global.$kAAIT_Config.$debugChance else 0" />
			<set_value name="$distToTarget" exact="this.assignedcontrolled.bboxdistanceto.{$target}" />
			<debug_text text="this.assignedcontrolled.idcode + ' this.$kAAIT_aroundDir: ' + @this.$kAAIT_aroundDir" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode and $kAAIT_detailedDebugChance then @global.$kAAIT_Config.$debugChance else 0" />
			<do_if value="not @this.$kAAIT_aroundDir">
				<do_if value="@this.$kAAIT_data.$defensibleTarget.isoperational and @this.$kAAIT_data.$defensibleTarget != $target" comment="avoiding an arbitrary enemy">
					<create_orientation name="$rotToAttackTarget" orientation="look_at" refobject="this.$kAAIT_data.$defensibleTarget">
						<position value="this.assignedcontrolled.position" />
					</create_orientation>
					<set_value name="$yawToAttackTarget" exact="$rotToAttackTarget.yaw * 180 / pi" />
					<create_orientation name="$rotToTarget" orientation="look_at" refobject="$target">
						<position value="this.assignedcontrolled.position" />
					</create_orientation>
					<set_value name="$yawToTarget" exact="$rotToTarget.yaw * 180 / pi" />
					<debug_text text="this.assignedcontrolled.idcode + ' $yawToAttackTarget: ' + $yawToAttackTarget" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode and $kAAIT_detailedDebugChance then @global.$kAAIT_Config.$debugChance else 0" />
					<debug_text text="this.assignedcontrolled.idcode + ' $yawToTarget: ' + $yawToTarget" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode and $kAAIT_detailedDebugChance then @global.$kAAIT_Config.$debugChance else 0" />
					<do_if value="$yawToAttackTarget ge $yawToTarget">
						<set_value name="this.$kAAIT_aroundDir" exact="-1" />
					</do_if>
					<do_else>
						<set_value name="this.$kAAIT_aroundDir" exact="1" />
					</do_else>
					<debug_text text="this.assignedcontrolled.idcode + ' this.$kAAIT_aroundDir (attack target v avoid enemy): ' + this.$kAAIT_aroundDir" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode and $kAAIT_detailedDebugChance then @global.$kAAIT_Config.$debugChance else 0" />
				</do_if>
				<do_else>
					<set_value name="this.$kAAIT_aroundDir" exact="[-1, 1].random" />
				</do_else>
			</do_if>
			<do_elseif value="@this.$kAAIT_data.$defensibleTarget == $target" comment="avoiding an attack target">
				<set_value name="this.$kAAIT_aroundDir" exact="this.$kAAIT_aroundDir * [-1, 1, 1, 1].random" comment="chance of reversal" />
			</do_elseif>

			<set_value name="$orderLocation_space" exact="this.sector" />
			<create_position name="$posShip" space="$orderLocation_space" object="this.assignedcontrolled" />
			<create_position name="$posTarget" space="$orderLocation_space" object="$target" />
			<include_interrupt_actions ref="kAAIT_GetBigEnemies" />
			<remove_from_group group="this.$kAAIT_data.$bigEnemies" object="$target" />
			<do_if value="this.$kAAIT_data.$bigEnemies.count gt 1" comment="add positions all big enemies to pos to withdraw from">
				<do_for_each name="$kAAIT_bigEnemy" in="this.$kAAIT_data.$bigEnemies">
					<create_position name="$posEnemy" space="$orderLocation_space" object="$kAAIT_bigEnemy" />
					<create_position name="$posTarget"
						x="$posTarget.x + ($posEnemy.x - $posTarget.x) * 0.5"
						y="$posTarget.y + ($posEnemy.y - $posTarget.y) * 0.5"
						z="$posTarget.z + ($posEnemy.z - $posTarget.z) * 0.5" />
				</do_for_each>
			</do_if>
			<create_position name="$posTarget" space="$orderLocation_space" object="$target" />
			<create_orientation name="$rotFromTarget" orientation="look_at" refposition="$posShip">
				<position value="$posTarget" />
			</create_orientation>
			<set_value name="$ship_yaw_deg" exact="$rotFromTarget.yaw * 180 / pi" />
			<set_value name="$ship_pitch_deg" exact="$rotFromTarget.pitch * 180 / pi" />
			<set_value name="$isMoveBehindCommander" exact="false" />
			<set_value name="$distToCommander" exact="0" />
			<do_if value="
				(
					this.assignedcontrolled.primarypurpose != purpose.fight or
					this.assignedcontrolled.type == shiptype.carrier
				) and
				@this.assignedcontrolled.commander.isoperational and
				this.assignedcontrolled.commander.isclass.ship and
				this.assignedcontrolled.distanceto.{this.assignedcontrolled.commander} le this.assignedcontrolled.maxradarrange and
				(
					@this.assignedcontrolled.commander.assignedaipilot.$kAAIT_data.$defensibleTarget == $target or
					@this.assignedcontrolled.commander.order.$primarytarget == $target or
					@this.assignedcontrolled.commander.order.$primarytarget.defensible == $target.defensible or
					@this.assignedcontrolled.commander.nextorder.$primarytarget == $target or
					@this.assignedcontrolled.commander.nextorder.$primarytarget.defensible == $target.defensible
				)">
				<debug_text text="this.assignedcontrolled.idcode + ' MOVING BEHIND COMMANDER'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode and $kAAIT_detailedDebugChance then @global.$kAAIT_Config.$debugChance else 0" />
				<set_value name="$distToCommander" exact="this.assignedcontrolled.bboxdistanceto.{this.assignedcontrolled.commander}" />
				<set_value name="$isMoveBehindCommander" exact="true" />
				<set_value name="$kAAIT_target_escort" exact="this.assignedcontrolled.commander" />
				<include_interrupt_actions ref="kAAIT_GetEscortPos" />
				<create_position name="$posTarget" space="$orderLocation_space" object="$kAAIT_target_escort" />
				<set_value name="$yaw_deg" exact="$kAAIT_result_yawDeg" />
				<set_value name="$pitch_deg" exact="$kAAIT_result_pitchDeg" />
			</do_if>
			<do_else>
				<debug_text text="this.assignedcontrolled.idcode + ' MOVING AROUND'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode and $kAAIT_detailedDebugChance then @global.$kAAIT_Config.$debugChance else 0" />
				<set_value name="$yaw_adj" min="30" max="45" />
				<set_value name="$yaw_deg" exact="$ship_yaw_deg + $yaw_adj * this.$kAAIT_aroundDir" />
				<set_value name="$pitch_adj" min="-15" max="15" />
				<set_value name="$pitch_deg" exact="$ship_pitch_deg + $pitch_adj" />
			</do_else>
			<set_value name="$yaw" exact="$yaw_deg * pi / 180" />
			<set_value name="$pitch" exact="$pitch_deg * pi / 180" />
			<do_if value="not this.$kAAIT_data.$skill_distance_withdraw?">
				<include_interrupt_actions ref="kAAIT_GetSkillVars" />
			</do_if>
			<do_if value="$isMoveBehindCommander">
				<!-- <set_value name="$distAvoid" exact="this.assignedcontrolled.maxradarrange * 0.5" /> -->
				<set_value name="$distAvoid" exact="10km" />
			</do_if>
			<do_elseif value="
				this.assignedcontrolled.primarypurpose != purpose.fight or
				this.assignedcontrolled.type == shiptype.carrier">
				<do_if value="$target.isclass.ship">
					<set_value name="$distAvoid" exact="this.assignedcontrolled.maxradarrange * 2" />
				</do_if>
				<do_else>
					<set_value name="$distAvoid" exact="this.assignedcontrolled.maxradarrange" />
				</do_else>
			</do_elseif>
			<do_elseif value="@this.$kAAIT_data.$defensibleTarget == $target">
				<set_value name="$distAvoid" exact="[10km + this.$kAAIT_data.$skill_distance_withdraw, [$distToTarget, this.assignedcontrolled.maxradarrange * 0.5].min].max" />
				<do_if value="
					this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m] and
					$target.isclass.ship and
					this.assignedcontrolled.shieldpercentage gt this.$kAAIT_data.$skill_shieldPercentage_withdrawAt_vShip
				">
					<set_value name="$distAvoid" exact="$distAvoid * 0.5" />
				</do_if>
			</do_elseif>
			<do_else>
				<set_value name="$distAvoid" exact="this.assignedcontrolled.maxradarrange" />
			</do_else>
			<debug_text text="this.assignedcontrolled.idcode + ' $distAvoid: ' + @$distAvoid" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode and $kAAIT_detailedDebugChance then @global.$kAAIT_Config.$debugChance else 0" />
			<create_position name="$orderLocation_pos"
				x="$posTarget.x + $distAvoid * sin ($yaw) * cos ($pitch)"
				y="$posTarget.y + $distAvoid * sin ($pitch)"
				z="$posTarget.z + $distAvoid * cos ($yaw) * cos ($pitch)"
			/>
			<set_value name="this.$kAAIT_data.$orderLocation_space" exact="$orderLocation_space" />
			<set_value name="this.$kAAIT_data.$orderLocation_pos" exact="$orderLocation_pos" />
			<set_value name="$dist_targetToWithdrawDest" exact="$target.distanceto.[$orderLocation_space, $orderLocation_pos]" />
			<do_if value="
				$distToTarget gt this.assignedcontrolled.maxradarrange and
				($isMoveBehindCommander and $distToCommander le this.assignedcontrolled.maxradarrange * 0.5)">
				<resume label="finish" />
			</do_if>
			<move_to object="this.assignedcontrolled"
				destination="$orderLocation_space"
				uselocalhighways="false"
				useknownpath="this.isplayerowned"
				forcesteering="this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m]"
				commandaction="false"
				travel="if @this.assignedcontrolled.orders.{2}.id == 'Attack' then false else true">
				<position value="$orderLocation_pos"/>
				<interrupt>
					<conditions>
						<check_any>
							<event_object_attacked object="this.assignedcontrolled" />
							<event_object_attacked object="$target" />
							<event_object_changed_zone object="this.assignedcontrolled" />
							<event_object_changed_zone object="$target" />
						</check_any>
						<check_any>
							<check_all>
								<check_value value="this.assignedcontrolled.bboxdistanceto.{$target} gt this.assignedcontrolled.maxradarrange * 0.25" />
								<check_value value="$target.distanceto.[$orderLocation_space, $orderLocation_pos] gt $dist_targetToWithdrawDest" comment="enemy ship must have moved away to not be in the way" />
							</check_all>
							<check_value value="this.assignedcontrolled.bboxdistanceto.{$target} gt this.assignedcontrolled.maxradarrange" />
						</check_any>
						<set_value name="$kAAIT_isCancelAvoidance" exact="true" />
					</conditions>
					<actions>
						<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_isCancelAvoidance: ' + $kAAIT_isCancelAvoidance" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode and $kAAIT_detailedDebugChance then @global.$kAAIT_Config.$debugChance else 0" />
					</actions>
				</interrupt>
			</move_to>
			<resume label="finish" />

			<label name="flee" />
			<debug_text text="this.assignedcontrolled.idcode + ' LABEL flee'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			<set_value name="this.$kAAIT_data.$target_avoid" exact="$target" />
			<include_interrupt_actions ref="kAAIT_Order_Flee" />
			<wait min="1s" max="3s" />

			<label name="fight" comment="required for DisengageHandler. $disengage_pursue resumes at fight label. in this case, just finish." />
			<debug_text text="this.assignedcontrolled.idcode + ' LABEL fight'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />

			<label name="finish" />
			<debug_text text="this.assignedcontrolled.idcode + ' LABEL finish'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			<stop_moving object="this.assignedcontrolled" />
			<do_if value="@this.$kAAIT_data">
				<set_value name="this.$kAAIT_data.$isAvoiding" exact="false" />
				<remove_value name="this.$kAAIT_data.$orderLocation_space" />
				<remove_value name="this.$kAAIT_data.$orderLocation_pos" />
			</do_if>
			<include_interrupt_actions ref="kAAIT_Deinit" />
		</actions>
	</attention>
	<on_abort>
		<stop_moving object="this.assignedcontrolled" />
		<do_if value="@this.$kAAIT_data">
			<set_value name="this.$kAAIT_data.$isAvoiding" exact="false" />
			<remove_value name="this.$kAAIT_data.$orderLocation_space" />
			<remove_value name="this.$kAAIT_data.$orderLocation_pos" />
		</do_if>
		<include_interrupt_actions ref="kAAIT_Deinit" />
	</on_abort>
</aiscript>
