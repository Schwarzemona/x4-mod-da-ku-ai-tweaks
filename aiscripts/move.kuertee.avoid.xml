<?xml version="1.0" encoding="utf-8" ?>
<aiscript name="move.kuertee.avoid" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="aiscripts.xsd" version="18">
	<order id="kAAIT_MoveAvoid" name="{1111920, 105}" description="{1111920, 125}" category="internal">
		<params>
			<param name="target" required="true" type="object" text="{1041, 10126}" comment="target" />
			<param name="kAAITParam_iskAAITOrder" required="false" default="true" type="internal" />
		</params>
		<requires>
			<match shiptype="shiptype.lasertower" negate="true"/>
		</requires>
		<location object="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_space" position="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_pos" condition="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_space and @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_pos" />
	</order>
	<interrupts>
		<handler ref="DisengageHandler"/>
		<handler ref="ResupplyHandler"/>
		<handler ref="kAAIT_Handler_NewBigTarget" />
		<handler comment="target destroyed">
			<conditions>
				<check_any>
					<event_object_destroyed object="$target" check="false" />
					<event_object_destroyed object="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget" check="false" />
				</check_any>
			</conditions>
			<actions>
				<abort_called_scripts resume="finish" />
			</actions>
		</handler>
		<handler comment="cancelled">
			<conditions>
				<event_object_order_cancelled object="this.assignedcontrolled" />
				<!-- <check_value value="not @global.$kAAIT_Data.$debugChance" /> -->
			</conditions>
			<actions>
				<debug_text text="@this.assignedcontrolled.idcode + ' EVENT event.name: ' + event.name + ' event.param.id: ' + @event.param.id + ' event.param2: ' + @event.param2" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
				<debug_text text="@this.assignedcontrolled.idcode + ' EVENT this.assignedcontrolled.order.script: ' + @this.assignedcontrolled.order.script" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
				<do_if value="@this.assignedcontrolled.order.script != 'move.kuertee.avoid'">
					<do_for_each name="$order" in="this.assignedcontrolled.orders">
						<do_if value="$order.$kAAITParam_isAvoidHighRisk?">
							<!-- <set_value name="$order.$kAAITParam_isAvoidHighRisk" exact="false" /> -->
							<edit_order_param order="$order" param="'kAAITParam_isAvoidHighRisk'" value="false" />
							<!-- <set_value name="global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$kAAIT_isAvoidHighRisk_user" exact="false" /> -->
							<debug_text text="@this.assignedcontrolled.idcode + ' EVENT this.assignedcontrolled.order.script: ' + @this.assignedcontrolled.order.script" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
						</do_if>
					</do_for_each>
					<do_if value="global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData?">
						<remove_value name="global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData.$isAvoiding" />
						<remove_value name="global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData.$target_avoid" />
						<remove_value name="global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData.$orderLocation_space" />
						<remove_value name="global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData.$orderLocation_pos" />
					</do_if>
					<abort_called_scripts resume="finish" />
				</do_if>
			</actions>
		</handler>
	</interrupts>
	<init>
		<!-- required for disengage handler -->
		<debug_text text="@this.assignedcontrolled.idcode + ' init'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' and $kAAIT_detailedDebugChance then @global.$kAAIT_Data.$debugChance else 0" />
		<set_value name="$pursuetargets" exact="false" />
		<set_value name="$pursuedistance" exact="this.assignedcontrolled.maxradarrange" />
		<set_value name="$debugchance" exact="0" />
	</init>
	<attention min="unknown">
		<actions>
			<set_value name="$kAAIT_detailedDebugChance" exact="100" />
			<debug_text text="@this.assignedcontrolled.idcode + ' $target: ' + @$target.knownname + ' ' + @$target.idcode + ', ' + @$target.isoperational + ', ' + @$target.hullpercentage" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' and $kAAIT_detailedDebugChance then @global.$kAAIT_Data.$debugChance else 0" />
			<debug_text text="@this.assignedcontrolled.idcode + ' $defensibleTarget: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget.knownname + ' ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' and $kAAIT_detailedDebugChance then @global.$kAAIT_Data.$debugChance else 0" />
			<do_if value="not @$target.isoperational">
				<resume label="finish" />
			</do_if>
			<include_interrupt_actions ref="kAAIT_Init" />
			<!-- <set_flight_behaviour object="this.assignedcontrolled" flightbehaviour="flightbehaviour.evasive_random" /> -->

			<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isAvoiding" exact="true" />

			<label name="start"/>
			<debug_text text="@this.assignedcontrolled.idcode + ' LABEL start'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
			<set_value name="$dist_shipToTarget" exact="this.assignedcontrolled.bboxdistanceto.{$target}" />
			<set_value name="$isShortAvoidance" exact="false" />
			<do_if value="$dist_shipToTarget gt this.assignedcontrolled.maxradarrange">
				<resume label="finish" />
			</do_if>
			<set_value name="$orderLocation_space" exact="this.sector" />
			<create_position name="$posShip" space="$orderLocation_space" object="this.assignedcontrolled" />
			<create_position name="$posTarget" space="$orderLocation_space" object="$target" />
			<set_value name="$kAAIT_target_avoid" exact="$target" />
			<include_interrupt_actions ref="GetAvoidPosVectorAndObject" />
			<set_value name="$pos_avoidFrom" exact="$kAAIT_result_pos_avoidFrom" />
			<set_value name="$yaw_avoid" exact="$kAAIT_result_yaw_avoidFrom" />
			<set_value name="$pitch_avoid" exact="$kAAIT_result_pitch_avoidFrom" />
			<set_value name="$target_nearestAvoid" exact="$kAAIT_result_target_nearestAvoid" />
			<set_value name="$dist_avoidExtra" exact="0" />
			<do_if value="this.assignedcontrolled.bboxdistanceto.[this.sector, $pos_avoidFrom] le global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$skill_distance_withdraw">
				<set_value name="$dist_avoidExtra" exact="$posTarget.distanceto.{$pos_avoidFrom}" comment="add this to the distance to avoid. if pos_avoidFrom is far from target_nearestAvoid, the avoid distance could be too short" />
			</do_if>
			<debug_text text="@this.assignedcontrolled.idcode + ' $dist_avoidExtra: ' + $dist_avoidExtra" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' and $kAAIT_detailedDebugChance then @global.$kAAIT_Data.$debugChance else 0" />
			<!-- start: add other yaws -->
			<do_if value="
				this.assignedcontrolled.primarypurpose != purpose.fight and
				@this.assignedcontrolled.commander.isoperational and
				@this.assignedcontrolled.commander.isclass.ship and
				@this.assignedcontrolled.bboxdistanceto.{this.assignedcontrolled.commander} le this.assignedcontrolled.maxradarrange and
				(
					@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget == $target or
					@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget == @$target.defensible
				)">
				<debug_text text="@this.assignedcontrolled.idcode + ' MOVING BEHIND COMMANDER'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' and $kAAIT_detailedDebugChance then @global.$kAAIT_Data.$debugChance else 0" />
				<set_value name="$isShortAvoidance" exact="true" />
				<set_value name="$distToCommander" exact="this.assignedcontrolled.bboxdistanceto.{this.assignedcontrolled.commander}" />
				<create_position name="$posCommander" space="$orderLocation_space" object="this.assignedcontrolled.commander" />
				<create_orientation name="$rot_shipToCommander" orientation="look_at" refposition="$posCommander" comment="get vector from enemy because that's the direction of the withdraw">
					<position value="$pos_avoidFrom" />
				</create_orientation>
				<set_value name="$yaw_shipToCommander" exact="$rot_shipToCommander.yaw * 180 / pi" />
				<set_value name="$kAAIT_yaw_from" exact="$yaw_avoid" />
				<set_value name="$kAAIT_yaw_to" exact="$yaw_shipToCommander" />
				<include_interrupt_actions ref="kAAIT_GetMidYaw" />
				<set_value name="$yaw_avoid" exact="$kAAIT_yaw_mid" />
				<set_value name="$pos_avoidFrom" exact="$posCommander" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $yaw_avoid (adjusted to move behind commander): ' + $yaw_avoid" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' and $kAAIT_detailedDebugChance then @global.$kAAIT_Data.$debugChance else 0" />
			</do_if>
			<do_elseif value="$target.isrealclass.module">
				<debug_text text="@this.assignedcontrolled.idcode + ' MOVING AROUND STATION TO TARGET MODULE'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' and $kAAIT_detailedDebugChance then @global.$kAAIT_Data.$debugChance else 0" />
				<create_position name="$posStation" space="$orderLocation_space" object="$target.defensible" />
				<create_orientation name="$rot_stationToTarget" orientation="look_at" refposition="$posTarget">
					<position value="$pos_avoidFrom" />
				</create_orientation>
				<set_value name="$yaw_stationToTarget" exact="$rot_stationToTarget.yaw * 180 / pi" />
				<set_value name="$kAAIT_yaw_from" exact="$yaw_avoid" />
				<set_value name="$kAAIT_yaw_to" exact="$yaw_stationToTarget" />
				<include_interrupt_actions ref="kAAIT_GetMidYaw" />
				<set_value name="$yaw_avoid" exact="$kAAIT_yaw_mid" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $yaw_avoid (adjusted to move to next module): ' + $yaw_avoid" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' and $kAAIT_detailedDebugChance then @global.$kAAIT_Data.$debugChance else 0" />
			</do_elseif>
			<do_else>
				<include_interrupt_actions ref="kAAIT_GetDestination" />
				<do_if value="
					@$kAAIT_destination and
					@$kAAIT_destinationPosition and
					$kAAIT_destination != $target and
					$target.distanceto.[$kAAIT_destination, $kAAIT_destinationPosition] gt this.assignedcontrolled.maxradarrange * 0.25 and
					(
						$kAAIT_destination != this.assignedcontrolled.commander or
						@this.assignedcontrolled.commander.order.$primarytarget != @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget
					)
				" comment="either destination != commander or commander's target != my target. distanceto: at this point all objects are in same sector as ship.">
					<set_value name="$dist_toDest" exact="this.assignedcontrolled.distanceto.[$kAAIT_destination, $kAAIT_destinationPosition]" />
					<debug_text text="@this.assignedcontrolled.idcode + ' AVOIDING WHILE MOVING TOWARDS DESTINATION'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' and $kAAIT_detailedDebugChance then @global.$kAAIT_Data.$debugChance else 0" />
					<create_orientation name="$rot_shipToDest" orientation="look_at" refposition="$kAAIT_destinationPosition">
						<position value="$pos_avoidFrom" />
					</create_orientation>
					<set_value name="$yaw_shipToDest" exact="$rot_shipToDest.yaw * 180 / pi" />
					<set_value name="$kAAIT_yaw_from" exact="$yaw_avoid" />
					<set_value name="$kAAIT_yaw_to" exact="$yaw_shipToDest" />
					<include_interrupt_actions ref="kAAIT_GetMidYaw" />
					<set_value name="$yaw_avoid" exact="$kAAIT_yaw_mid" />
					<debug_text text="@this.assignedcontrolled.idcode + ' $yaw_avoid (adjusted to move to dest): ' + $yaw_avoid" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' and $kAAIT_detailedDebugChance then @global.$kAAIT_Data.$debugChance else 0" />
				</do_if>
				<do_else>
					<debug_text text="@this.assignedcontrolled.idcode + ' MOVING AROUND ATTACK TARGET'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' and $kAAIT_detailedDebugChance then @global.$kAAIT_Data.$debugChance else 0" />
					<do_if value="not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_aroundDir">
						<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_aroundDir" exact="[-1, 1].random" />
					</do_if>
					<set_value name="$yaw_adj" min="30" max="45" />
					<set_value name="$yaw_avoid" exact="$yaw_avoid + $yaw_adj * global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_aroundDir" />
					<debug_text text="@this.assignedcontrolled.idcode + ' $yaw_avoid (adjusted to move around target): ' + $yaw_avoid" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' and $kAAIT_detailedDebugChance then @global.$kAAIT_Data.$debugChance else 0" />
				</do_else>
			</do_else>
			<set_value name="$yaw" exact="$yaw_avoid * pi / 180" />
			<!-- end: add other yaws -->
			<!-- start: finalise vector -->
			<set_value name="$yaw_avoid" exact="$yaw_avoid * pi / 180" />
			<set_value name="$pitch_adj" min="-15" max="15" />
			<!-- end: finalise vector -->
			<!-- start: get distance -->
			<set_value name="$pitch_avoid" exact="($pitch_avoid + $pitch_adj) * pi / 180" />
			<!-- <do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$skill_distance_withdraw?">
				<include_interrupt_actions ref="kAAIT_GetSkillVars" />
			</do_if> -->
			<do_if value="$isShortAvoidance">
				<set_value name="$distAvoid" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$skill_distance_withdraw * 0.5" />
			</do_if>
			<do_elseif value="this.assignedcontrolled.primarypurpose != purpose.fight">
				<do_if value="$target.isclass.ship">
					<set_value name="$distAvoid" exact="this.assignedcontrolled.maxradarrange * 2" />
				</do_if>
				<do_else>
					<set_value name="$distAvoid" exact="this.assignedcontrolled.maxradarrange" />
				</do_else>
			</do_elseif>
			<do_elseif value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget == $target">
				<set_value name="$distAvoid" exact="[10km + global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$skill_distance_withdraw, [$dist_shipToTarget, this.assignedcontrolled.maxradarrange * 0.5].min].max" />
				<do_if value="
					this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m] and
					$target.isclass.ship and
					this.assignedcontrolled.shieldpercentage gt $target.shieldpercentage * (global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$skill_shieldPercentage_withdrawAt_vShip / 100.0)
				">
					<set_value name="$distAvoid" exact="$distAvoid * 0.5" />
				</do_if>
			</do_elseif>
			<do_else>
				<set_value name="$distAvoid" exact="this.assignedcontrolled.maxradarrange" />
			</do_else>
			<debug_text text="@this.assignedcontrolled.idcode + ' $distAvoid: ' + @$distAvoid" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' and $kAAIT_detailedDebugChance then @global.$kAAIT_Data.$debugChance else 0" />
			<set_value name="$distAvoid" exact="$dist_avoidExtra" operation="add" />
			<debug_text text="@this.assignedcontrolled.idcode + ' $distAvoid ($dist_avoidExtra added): ' + @$distAvoid" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' and $kAAIT_detailedDebugChance then @global.$kAAIT_Data.$debugChance else 0" />
			<!-- end: get distance -->

			<label name="move" />
			<debug_text text="@this.assignedcontrolled.idcode + ' LABEL move'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
			<create_position name="$orderLocation_pos"
				x="$pos_avoidFrom.x + $distAvoid * sin ($yaw_avoid) * cos ($pitch_avoid)"
				y="$pos_avoidFrom.y + $distAvoid * sin ($pitch_avoid)"
				z="$pos_avoidFrom.z + $distAvoid * cos ($yaw_avoid) * cos ($pitch_avoid)"
			/>
			<get_safe_pos result="$orderLocation_pos" sector="$orderLocation_space" value="$orderLocation_pos" radius="this.ship.size * 2" />
			<set_value name="$dist_toOrderLocationPos" exact="this.assignedcontrolled.distanceto.[$orderLocation_space, $orderLocation_pos]" />
			<debug_text text="@this.assignedcontrolled.idcode + ' $dist_toDest: ' + @$dist_toDest + ' $dist_toOrderLocationPos: ' + @$dist_toOrderLocationPos" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' and $kAAIT_detailedDebugChance then @global.$kAAIT_Data.$debugChance else 0" />
			<do_if value="@$dist_toDest and $dist_toDest le $dist_toOrderLocationPos">
				<create_orientation name="$rot_toDest" orientation="look_at" refposition="$kAAIT_destinationPosition">
					<position value="$posShip" />
				</create_orientation>
				<set_value name="$yaw_toDest" exact="$rot_toDest.yaw * 180 / pi" />
				<create_orientation name="$rot_toAvoid" orientation="look_at" refposition="$orderLocation_pos">
					<position value="$posShip" />
				</create_orientation>
				<set_value name="$yaw_toAvoid" exact="$rot_toAvoid.yaw * 180 / pi" />
				<set_value name="$yaw_diff" exact="$yaw_toDest - $yaw_toAvoid" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $yaw_toDest: ' + $yaw_toDest + ' $yaw_toAvoid: ' + $yaw_toAvoid + ' $yaw_diff: ' + $yaw_diff" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' and $kAAIT_detailedDebugChance then @global.$kAAIT_Data.$debugChance else 0" />
				<do_if value="$yaw_diff ge -45 and $yaw_diff le 45">
					<create_position name="$orderLocation_pos" space="$orderLocation_space" object="$kAAIT_destination" value="$kAAIT_destinationPosition" />
				</do_if>
			</do_if>
			<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_space" exact="$orderLocation_space" />
			<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_pos" exact="$orderLocation_pos" />
			<set_value name="$dist_targetToAvoidDest" exact="$target.distanceto.[$orderLocation_space, $orderLocation_pos]" />

			<label name="move_locked_destination" />
			<debug_text text="@this.assignedcontrolled.idcode + ' LABEL move_locked_destination'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
			<do_if value="
				@this.assignedcontrolled.nextorder.script != 'order.repair' and
				@this.assignedcontrolled.nextorder.script != 'order.restock.subordinates' and
				@this.assignedcontrolled.nextorder.script != 'order.dock' and
				@this.assignedcontrolled.nextorder.script != 'order.dock.wait' and
				(	this.assignedcontrolled.hullpercentage le 25 or
					(
						this.assignedcontrolled.hullpercentage le 50 and
						this.assignedcontrolled.shieldpercentage le 25
					) or
					(not this.assignedcontrolled.weapons.all.count) or
					(not this.assignedcontrolled.engines.all.count) or
					this.assignedcontrolled.weapons.operational.count / ([this.assignedcontrolled.weapons.all.count, 1].max)f le 0.25 or
					this.assignedcontrolled.engines.operational.count / ([this.assignedcontrolled.engines.all.count, 1].max)f le 0.25
				)" comment="resupply if required and not already resupplying.">
				<signal_objects object="this.assignedcontrolled" param="'resupply'" param2="[false]" param3="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
				<wait min="1s" max="3s" />
			</do_if>
			<remove_value name="$kAAIT_isCancelAvoidance" />
			<move_to object="this.assignedcontrolled"
				destination="$orderLocation_space"
				uselocalhighways="false"
				useknownpath="this.isplayerowned"
				forcesteering="this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m]"
				commandaction="false"
				travel="if @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget == $target then false else true"
				flightbehaviour="flightbehaviour.evasive_random">
				<position value="$orderLocation_pos"/>
				<interrupt_after_time time="1s" />
			</move_to>
			<debug_text text="@this.assignedcontrolled.idcode + ' wait start'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' and $kAAIT_detailedDebugChance then @global.$kAAIT_Data.$debugChance else 0" />
			<set_value name="$kAAIT_attacker" exact="null" />
			<remove_value name="$kAAIT_isInterrupted" />
			<wait exact="5s">
				<interrupt>
					<conditions>
						<check_any>
							<check_all>
								<event_object_attacked object="this.assignedcontrolled" />
								<set_value name="$kAAIT_attacker" exact="event.param" />
							</check_all>
							<event_object_attacked object="$target" />
							<event_object_changed_zone object="this.assignedcontrolled" />
							<event_object_changed_zone object="$target" />
						</check_any>
						<check_any>
							<check_all>
								<check_value value="this.assignedcontrolled.bboxdistanceto.{$target} gt this.assignedcontrolled.maxradarrange * 0.25" />
								<check_value value="$target.distanceto.[$orderLocation_space, $orderLocation_pos] gt $dist_targetToAvoidDest" comment="enemy ship must have moved away to not be in the way" />
							</check_all>
							<check_value value="this.assignedcontrolled.bboxdistanceto.{$target} gt this.assignedcontrolled.maxradarrange" />
						</check_any>
						<set_value name="$kAAIT_isCancelAvoidance" exact="true" />
					</conditions>
				</interrupt>
			</wait>
			<debug_text text="@this.assignedcontrolled.idcode + ' wait end'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' and $kAAIT_detailedDebugChance then @global.$kAAIT_Data.$debugChance else 0" />
			<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_isCancelAvoidance: ' + @$kAAIT_isCancelAvoidance" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' and $kAAIT_detailedDebugChance then @global.$kAAIT_Data.$debugChance else 0" />
			<set_value name="$distToDest" exact="this.assignedcontrolled.bboxdistanceto.[$orderLocation_space, $orderLocation_pos]" />
			<debug_text text="@this.assignedcontrolled.idcode + ' $distToDest: ' + $distToDest" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' and $kAAIT_detailedDebugChance then @global.$kAAIT_Data.$debugChance else 0" />
			<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_attacker: ' + @$kAAIT_attacker + ' (' + @$kAAIT_attacker.knownname + ', ' + @$kAAIT_attacker.idcode + ')'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' and $kAAIT_detailedDebugChance then @global.$kAAIT_Data.$debugChance else 0" />
			<do_if value="not @this.assignedcontrolled.isoperational">
				<resume label="finish" />
			</do_if>
			<do_if value="not @$kAAIT_isCancelAvoidance">
				<debug_text text="@this.assignedcontrolled.idcode + ' this.assignedcontrolled.isoperational: ' + @this.assignedcontrolled.isoperational" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' and $kAAIT_detailedDebugChance then @global.$kAAIT_Data.$debugChance else 0" />
				<set_value name="$dist_shipToTarget" exact="this.assignedcontrolled.bboxdistanceto.{$target}" />
				<set_value name="$dist_toOrderLocationPos" exact="this.assignedcontrolled.bboxdistanceto.[$orderLocation_space, $orderLocation_pos]" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $dist_toOrderLocationPos: ' + $dist_toOrderLocationPos" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' and $kAAIT_detailedDebugChance then @global.$kAAIT_Data.$debugChance else 0" />
				<do_if value="
					$dist_toOrderLocationPos le $dist_shipToTarget and
					$dist_shipToTarget gt global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData.$skill_distance_withdraw">
					<resume label="finish" />
				</do_if>
				<do_if value="
					@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget and
					@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget.bboxdistanceto.{$target} gt global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_mid">
					<set_value name="$defensibleTarget" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget" />
					<set_value name="$distToEnemy" exact="this.assignedcontrolled.bboxdistanceto.{global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget}" />
					<debug_text text="@this.assignedcontrolled.idcode + ' $distToEnemy: ' + $distToEnemy" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' and $kAAIT_detailedDebugChance then @global.$kAAIT_Data.$debugChance else 0" />
					<do_if value="$distToEnemy le this.assignedcontrolled.bboxdistanceto.{$target}" comment="target is closer to avoid object">
						<resume label="finish" />
					</do_if>
				</do_if>
				<do_if value="$distToDest gt 5km">
					<do_if value="
						@$kAAIT_attacker.exists and $kAAIT_attacker != $target and
						this.assignedcontrolled.bboxdistanceto.{$target} gt global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData.$skill_distance_withdraw
					" comment="at this point, $kAAIT_attacker is set by the interrupt in wait 5s above">
						<set_value name="$kAAIT_test_target_isHighRisk" exact="$kAAIT_attacker" />
						<include_interrupt_actions ref="kAAIT_GetIsTargetHighRisk" />
						<set_value name="$kAAIT_isHighRisk" exact="$kAAIT_result_isTargetHighRisk" />
						<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_isHighRisk: ' + @$kAAIT_isHighRisk" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' and $kAAIT_detailedDebugChance then @global.$kAAIT_Data.$debugChance else 0" />
						<do_if value="not $kAAIT_isHighRisk">
							<do_if value="$target.isoperational">
								<resume label="move_locked_destination" />
							</do_if>
							<do_else>
								<resume label="finish" />
							</do_else>
						</do_if>
						<do_else>
							<resume label="start" />
						</do_else>
					</do_if>
					<do_else>
						<resume label="move_locked_destination" />
					</do_else>
				</do_if>
			</do_if>
			<do_elseif value="@$kAAIT_isInterrupted and $distToDest gt 5km">
				<do_if value="@$kAAIT_attacker.exists and $kAAIT_attacker != $target" comment="at this point, $kAAIT_attacker is set by kAAIT_Handler_AvoidWithdrawOrJustFight">
					<resume label="start" />
				</do_if>
				<do_else>
					<resume label="move_locked_destination" />
				</do_else>
			</do_elseif>
			<resume label="finish" />

			<label name="flee" />
			<debug_text text="@this.assignedcontrolled.idcode + ' LABEL flee'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
			<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid" exact="$target" />
			<include_interrupt_actions ref="kAAIT_Order_Flee" />
			<wait min="1s" max="3s" />

			<label name="fight" comment="required for DisengageHandler. $disengage_pursue resumes at fight label. in this case, just finish." />
			<debug_text text="@this.assignedcontrolled.idcode + ' LABEL fight'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />

			<label name="finish" />
			<debug_text text="@this.assignedcontrolled.idcode + ' LABEL finish'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
			<stop_moving object="this.assignedcontrolled" />
			<!-- <reset_flight_behaviour object="this.assignedcontrolled" /> -->
			<do_if value="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_space?">
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isAvoiding" exact="false" />
				<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_space" />
				<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_pos" />
			</do_if>
			<include_interrupt_actions ref="kAAIT_Deinit" />
		</actions>
	</attention>
	<on_abort>
		<do_if value="@this.assignedcontrolled.isoperational">
			<stop_moving object="this.assignedcontrolled" />
			<!-- <reset_flight_behaviour object="this.assignedcontrolled" /> -->
		</do_if>
		<do_if value="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData?">
			<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isAvoiding" exact="false" />
		</do_if>
		<do_if value="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_space?">
			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_space" />
			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_pos" />
		</do_if>
		<include_interrupt_actions ref="kAAIT_Deinit" />
	</on_abort>
</aiscript>
