<?xml version="1.0" encoding="utf-8" ?>
<aiscript name="move.kuertee.engage.position" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="aiscripts.xsd" version="18">
	<order id="kAAIT_MoveEngagePosition" name="{1111920, 106}" description="{1111920, 126}" category="internal">
		<params>
			<param name="target" required="true" type="object" text="{1041, 10126}" comment="target" />
			<param name="kAAITParam_iskAAITOrder" required="false" default="true" type="internal" />
			<param name="kAAITParam_isBigMoveAround" required="false" default="false" type="internal" />
			<param name="debugchance" type="bool" default="0" advanced="true" text="{1041, 10086}" comment="Print debug output">
				<input_param name="truevalue" value="100"/>
			</param>
		</params>
		<requires>
			<match shiptype="shiptype.lasertower" negate="true"/>
		</requires>
		<location
			object="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$forced_avoidDestination"
			position="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$forced_avoidDestinationPosition"
			condition="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$forced_avoidDestination
				and @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$forced_avoidDestinationPosition"/>
		<location object="$map_space" position="$map_pos" condition="$map_space? and $map_pos?" comment="$map_space/pos MAY BE DIFFERENT FROM $moveTo_space/pos" />
		<location object="$target" condition="$target" />
	</order>
	<interrupts>
		<library>
			<actions name="GetMoveToEngagePosition">
				<create_position name="$posShip" space="this.sector" object="this.assignedcontrolled" />
				<create_position name="$posTarget" space="this.sector" object="$target" />
				<create_position name="$posDefensibleTarget" space="this.sector" object="$defensibleTarget" />
				<create_orientation name="$rotTargetToShip" orientation="look_at" refposition="$posShip">
					<position value="$posTarget" />
				</create_orientation>
				<set_value name="$yaw_deg" exact="$yaw_engage" />
				<debug_text text="@this.assignedcontrolled.idcode + ' GetMoveToEngagePosition $yaw_deg: ' + $yaw_deg" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />

				<set_value name="$yaw" exact="$yaw_deg * pi / 180" />
				<set_value name="$pitch_deg" exact="0" />
				<debug_text text="@this.assignedcontrolled.idcode + ' GetMoveToEngagePosition $pitch_deg: ' + $pitch_deg" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<do_if value="$isFinalMove">
					<!-- <set_value name="$pitch_deg" min="-15" max="15" /> -->
					<do_if value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$count_stepForward % 2 == 0" comment="alternate to keep the ship at a pretty much the same pitch">
						<set_value name="$pitch_deg" exact="15" />
					</do_if>
					<do_else>
						<set_value name="$pitch_deg" exact="-15" />
					</do_else>
					<debug_text text="@this.assignedcontrolled.idcode + ' GetMoveToEngagePosition $pitch_deg ($isFinalMove): ' + $pitch_deg" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				</do_if>
				<set_value name="$pitch" exact="$pitch_deg * pi / 180" />
				<set_value name="$distance_000ToEdgeOfTarget" exact="this.assignedcontrolled.distanceto.{$defensibleTarget} - this.assignedcontrolled.bboxdistanceto.{$defensibleTarget}" />
				<create_position name="$kAAIT_result_moveToEngagePosition"
					x="$posDefensibleTarget.x + (global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$distance_attackFrom + $distance_000ToEdgeOfTarget) * sin ($yaw) * cos ($pitch)"
					y="$posDefensibleTarget.y + (global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$distance_attackFrom + $distance_000ToEdgeOfTarget) * sin ($pitch) + [-5m, -2.5m, 0, 2.5m, 5m].random"
					z="$posDefensibleTarget.z + (global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$distance_attackFrom + $distance_000ToEdgeOfTarget) * cos ($yaw) * cos ($pitch)"
				/>

				<!-- <create_orientation name="$rotToMoveToPos" orientation="look_at" refposition="$kAAIT_result_moveToEngagePosition">
					<position value="$posTarget" />
				</create_orientation>
				<set_value name="$yawToMoveToPos" exact="$rotToMoveToPos.yaw * 180 / pi" />
				<debug_text text="@this.assignedcontrolled.idcode + ' GetMoveToEngagePosition $yawToMoveToPos: ' + $yawToMoveToPos" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" /> -->

				<create_position name="$kAAIT_test_position_getIsNearBigEnemy" space="this.assignedcontrolled" object="this.sector" value="$kAAIT_result_moveToEngagePosition" />
				<set_value name="$kAAIT_ignore_objects_getIsNearBigEnemies" exact="[$target, @$target.defensible]" />
				<include_interrupt_actions ref="kAAIT_GetIsNearBigEnemies" />
				<set_value name="$isMoveToEngagePosDangerous" exact="@$kAAIT_result_isShipNearBigEnemy and @$kAAIT_result_bigEnemy.isclass.station and @$kAAIT_result_distanceToBigEnemy le this.assignedcontrolled.maxradarrange * 0.5" />
				<debug_text text="@this.assignedcontrolled.idcode + ' GetMoveToEngagePosition $isMoveToEngagePosDangerous (near other big enemy): ' + $isMoveToEngagePosDangerous" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />

				<set_value name="$isDifficultLOS" exact="@global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData.$targetsWithDifficultLOS.indexof.{$target}" />
				<debug_text text="@this.assignedcontrolled.idcode + ' GetMoveToEngagePosition $isDifficultLOS: ' + $isDifficultLOS" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />

				<do_if value="$isMoveToEngagePosDangerous or $isDifficultLOS" comment="yaw movement will result in ship being near a big enemy, add a pitch component">
					<do_if value="$isMoveToEngagePosDangerous">
						<debug_text text="@this.assignedcontrolled.idcode + ' GetMoveToEngagePosition movement will result in near (' + $kAAIT_result_distanceToBigEnemy + ') big enemy (' + @$kAAIT_result_bigEnemy.knownname + ' ' + @$kAAIT_result_bigEnemy.idcode + '), trying with pitch'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
						<create_position name="$posBigEnemy" space="this.sector" object="$kAAIT_result_bigEnemy" />
						<create_orientation name="$rotShipToBigEnemy" orientation="look_at" refposition="$posBigEnemy">
							<position value="$posShip" />
						</create_orientation>
						<set_value name="$pitch_toBigEnemy" exact="$rotShipToBigEnemy.pitch * 180 / pi" />
						<debug_text text="@this.assignedcontrolled.idcode + ' GetMoveToEngagePosition $pitch_toBigEnemy: ' + $pitch_toBigEnemy" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
						<do_if value="$pitch_toBigEnemy le 0" comment="big enemy is below ship, so move up">
							<set_value name="$pitch" exact="45deg" />
						</do_if>
						<do_else comment="pitch down">
							<set_value name="$pitch" exact="-45deg" />
						</do_else>
						<debug_text text="@this.assignedcontrolled.idcode + ' GetMoveToEngagePosition $pitch (kAAIT_result_bigEnemy): ' + ($pitch * 180 / pi)" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					</do_if>
					<do_else>
						<debug_text text="@this.assignedcontrolled.idcode + ' GetMoveToEngagePosition current position has no los to target, trying with pitch'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
						<set_value name="$pitch_current" exact="$rotTargetToShip.pitch * 180 / pi" />
						<do_if value="$pitch_current le 0" comment="ship is already below target, keep ship below target">
							<set_value name="$pitch" exact="-45deg" />
						</do_if>
						<do_else>
							<set_value name="$pitch" exact="45deg" />
						</do_else>
					</do_else>

					<set_value name="$pitch_current" exact="$rotTargetToShip.pitch * 180 / pi" />
					<debug_text text="@this.assignedcontrolled.idcode + ' GetMoveToEngagePosition $pitch_current: ' + ($pitch_current * 180 / pi)" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<do_if value="($pitch gt 0 and $pitch_current lt 0) or ($pitch lt 0 and $pitch_current gt 0)" comment="move away from big enemy first by moving to target's y-level - i.e. pitch = 0.
						use the ship's current yaw to target so that MTE doesn't think that the ship is already at its target yaw to target.
						$distance_attackFrom moves the ship away from both the big enemy and the target.">
						<set_value name="$yaw" exact="$rotTargetToShip.yaw" />
						<set_value name="$pitch" exact="0" />
						<debug_text text="@this.assignedcontrolled.idcode + ' GetMoveToEngagePosition moving away first'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					</do_if>

					<create_position name="$kAAIT_result_moveToEngagePosition"
						x="$posDefensibleTarget.x + (global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$distance_attackFrom + $distance_000ToEdgeOfTarget) * sin ($yaw) * cos ($pitch)"
						y="$posDefensibleTarget.y + (global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$distance_attackFrom + $distance_000ToEdgeOfTarget) * sin ($pitch)"
						z="$posDefensibleTarget.z + (global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$distance_attackFrom + $distance_000ToEdgeOfTarget) * cos ($yaw) * cos ($pitch)"
					/>

					<!-- <create_orientation name="$rotToMoveToPos" orientation="look_at" refposition="$kAAIT_result_moveToEngagePosition">
						<position value="$posTarget" />
					</create_orientation>
					<set_value name="$yawToMoveToPos" exact="$rotToMoveToPos.yaw * 180 / pi" />
					<debug_text text="@this.assignedcontrolled.idcode + ' GetMoveToEngagePosition $yawToMoveToPos (with pitch): ' + $yawToMoveToPos" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" /> -->
				</do_if>

				<!-- <do_if value="$isFinalMove">
					<set_value name="global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData.$moveToEngage_yawTargetToShip" exact="$yawToMoveToPos" />
					<debug_text text="@this.assignedcontrolled.idcode + ' GetMoveToEngagePosition $yawToMoveToPos: ' + $yawToMoveToPos" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				</do_if> -->
			</actions>
		</library>
		<handler ref="DisengageHandler"/>
		<handler ref="kAAIT_Handler_NewBigTarget" />
		<handler comment="target destroyed">
			<conditions>
				<check_any>
					<event_object_destroyed object="$target" check="false" />
					<event_object_destroyed object="$defensibleTarget" check="false" />
				</check_any>
			</conditions>
			<actions>
				<debug_text text="@this.assignedcontrolled.idcode + ' event.name: ' + event.name" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<abort_called_scripts resume="finish" />
			</actions>
		</handler>
	</interrupts>
	<init>
		<debug_text text="@this.assignedcontrolled.idcode + ' init'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		<!-- required for disengage handler -->
		<set_value name="$pursuetargets" exact="false" />
		<set_value name="$pursuedistance" exact="this.assignedcontrolled.maxradarrange" />
		<set_value name="$debugchance" exact="0" />
		<!-- required for custom handlers -->
		<set_value name="$defensibleTarget" exact="null" />
	</init>
	<attention min="unknown">
		<actions>
			<set_value name="$kAAIT_isScriptHasAvoidLabel" exact="true" />
			<resume label="start" />

			<label name="kAAIT_label_avoid" />
			<debug_text text="@this.assignedcontrolled.idcode + ' LABEL kAAIT_label_avoid'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			<include_interrupt_actions ref="kAAIT_Order_Avoid" />
			<wait min="1s" max="3s" comment="stop this order from continuing as the new order is created" />
			<resume label="start" comment="in case the new order fails, do this" />

			<label name="start" />
			<debug_text text="@this.assignedcontrolled.idcode + ' LABEL start'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			<do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData?">
				<include_interrupt_actions ref="kAAIT_Init" />
			</do_if>
			<do_if value="not $kAAIT_original_name?">
				<set_value name="$kAAIT_original_name" exact="this.assignedcontrolled.knownname" />
			</do_if>

			<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target" exact="$target" />
			<do_if value="$target.isrealclass.module">
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$moduleTarget" exact="$target" />
			</do_if>
			<do_else>
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$moduleTarget" exact="null" />
			</do_else>

			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$forced_avoidDestination" />
			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$forced_avoidDestinationPosition"/>

			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$count_stepForward" />
			<do_if value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$withdrawCount gt 0">
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$withdrawCount" exact="0" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $attackData.$withdrawCount: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$withdrawCount" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			</do_if>

			<do_if value="$target.defensible">
				<set_value name="$defensibleTarget" exact="$target.defensible" />
			</do_if>
			<do_else>
				<set_value name="$defensibleTarget" exact="$target" />
			</do_else>
			<debug_text text="@this.assignedcontrolled.idcode + ' $target: ' + @$target.knownname + ' ' + @$target.idcode + ', ' + @$target.isoperational" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			<debug_text text="@this.assignedcontrolled.idcode + ' $defensibleTarget: ' + @$defensibleTarget.knownname + ' ' + @$defensibleTarget.idcode + ', ' + @$defensibleTarget.isoperational" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			<!-- <do_if value="(not @$target.isoperational) or (not @$defensibleTarget.isoperational)"> -->
			<do_if value="not @$defensibleTarget.isoperational">
				<resume label="finish" />
			</do_if>

			<do_if value="@this.assignedcontrolled.isoperational and @global.$kAAIT_Data.$debugChance_nameTags and @this.assignedcontrolled.order.script == 'move.kuertee.engage.position'">
				<debug_text text="@this.assignedcontrolled.idcode + ' set_object_name kAAIT'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_nameTags else 0)" />
				<set_object_name object="this.assignedcontrolled" name="$kAAIT_original_name + ' - kAAIT move to engage position'" />
			</do_if>

			<label name="fight" comment="required for DisengageHandler. $disengage_pursue resumes at fight label. in this case, just restart." />
			<debug_text text="@this.assignedcontrolled.idcode + ' LABEL fight'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />

			<label name="move_to_target" />
			<do_if value="this.sector != $defensibleTarget.sector">
				<debug_text text="@this.assignedcontrolled.idcode + ' LABEL move_to_target sector'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<run_script name="'move.generic'" result="$movesuccess">
					<param name="destination" value="$defensibleTarget.sector" />
					<param name="stopondetect" value="$defensibleTarget.sector"/>
					<param name="kAAITParam_iskAAITOrder" value="true" />
				</run_script>
				<wait min="(0.5s)" max="1s" comment="stop this order from continuing as the new order is created" />
				<do_if value="not $movesuccess">
					<resume label="start" />
				</do_if>
			</do_if>

			<!-- <do_if value="this.assignedcontrolled.bboxdistanceto.{$target} gt this.assignedcontrolled.maxradarrange">
				<debug_text text="@this.assignedcontrolled.idcode + ' LABEL move_to_target position'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<create_position name="$posShip" space="this.sector" object="this.assignedcontrolled" />
				<create_position name="$posTarget" space="this.sector" object="$defensibleTarget" />
				<create_orientation name="$rotFromTargettoShip" orientation="look_at" refposition="$posShip">
					<position value="$posTarget" />
				</create_orientation>
				<create_position name="$posMoveTo"
					x="$posTarget.x + this.assignedcontrolled.maxradarrange * 0.9 * sin ($rotFromTargettoShip.yaw) * cos ($rotFromTargettoShip.pitch)"
					y="$posTarget.y + this.assignedcontrolled.maxradarrange * 0.9 * sin ($rotFromTargettoShip.pitch)"
					z="$posTarget.z + this.assignedcontrolled.maxradarrange * 0.9 * cos ($rotFromTargettoShip.yaw) * cos ($rotFromTargettoShip.pitch)"
				/>
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$forced_avoidDestination" exact="this.sector" />
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$forced_avoidDestinationPosition" exact="$posMoveTo" />
				<run_script name="'move.generic'" result="$movesuccess">
					<param name="destination" value="this.sector" />
					<param name="position" value="$posMoveTo" />
					<param name="stopondetect" value="$defensibleTarget"/>
				</run_script>
				<wait min="(0.5s)" max="1s" comment="stop this order from continuing as the new order is created" />
				<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$forced_avoidDestination" />
				<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$forced_avoidDestinationPosition" />
				<do_if value="not $movesuccess">
					<resume label="start" />
				</do_if>
			</do_if> -->

			<label name="move_to_engage_position" />
			<debug_text text="@this.assignedcontrolled.idcode + ' LABEL move_to_engage_position'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />

			<set_value name="$moveTo_space" exact="this.sector" />
			<create_position name="$posShip" space="$moveTo_space" object="this.assignedcontrolled" />
			<create_position name="$posTarget" space="$moveTo_space" object="$target" />

			<!-- start: get distance from target -->
			<set_value name="$kAAIT_test_moveToEngageTarget" exact="$target" />
			<include_interrupt_actions ref="KAAIT_GetEngagePosDistance" />
			<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$distance_attackFrom" exact="$kAAIT_result_engagePosDist" />
			<debug_text text="@this.assignedcontrolled.idcode + ' $attackData.$distance_attackFrom: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$distance_attackFrom" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			<!-- end: get distance from target -->

			<!-- start: see if there's a big enemy in the way first -->
			<include_interrupt_actions ref="kAAIT_SaveBigEnemiesToData" />
			<set_value name="$kAAIT_ignore_objects_getIsNearBigEnemies" exact="[$target, @$target.defensible]" />
			<include_interrupt_actions ref="kAAIT_GetIsNearBigEnemies" />
			<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetAvoidOrNot $kAAIT_result_bigEnemy: ' + @$kAAIT_result_bigEnemy.knownname + ' ' + @$kAAIT_result_bigEnemy.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			<do_if value="@$kAAIT_result_bigEnemy.isoperational">
				<set_value name="$kAAIT_test_target_isInTheWay" exact="$kAAIT_result_bigEnemy" />
				<set_value name="$kAAIT_test_target_isInTheWayOf" exact="$target" />
				<include_interrupt_actions ref="kAAIT_GetIsInTheWay" />
				<do_if value="$kAAIT_result_isTargetInTheWay">
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid" exact="$kAAIT_result_bigEnemy" />
					<resume label="kAAIT_label_avoid" />
				</do_if>
			</do_if>
			<!-- end: see if there's a big enemy in the way first -->

			<set_value name="$yaw_engage" exact="null" />
			<set_value name="$isFinalMove" exact="true" />
			<set_value name="$dist_shipToTarget" exact="this.assignedcontrolled.distanceto.{$target}" />
			<set_value name="$dist_shipToTarget_bbox" exact="this.assignedcontrolled.bboxdistanceto.{$target}" />
			<debug_text text="@this.assignedcontrolled.idcode + ' $dist_shipToTarget: ' + $dist_shipToTarget" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			<debug_text text="@this.assignedcontrolled.idcode + ' $dist_shipToTarget_bbox: ' + $dist_shipToTarget_bbox" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			<set_value name="$kAAIT_test_moveToEngageTarget" exact="$target" />
			<set_value name="$kAAIT_test_moveToEngageTarget_isBigMoveAround" value="$kAAITParam_isBigMoveAround" />
			<include_interrupt_actions ref="kAAIT_SetMoveToEngageYawFromTarget" />
			<do_if value="abs($kAAIT_result_moveToEngageYawDiff) gt 45"
				comment="check if move to engage needs to move away first to avoid any modules that are in the way.
				e.g. stations with complex (e.g.convex) structures may require the move to engaage to put the ship away from the station first, before heading to the target vector.">
				<set_value name="$isFinalMove" exact="false" />
				<set_value name="$kAAIT_angle_from" exact="$kAAIT_result_moveToEngageYawFrom" />
				<set_value name="$kAAIT_angle_to" exact="$kAAIT_result_moveToEngageYawMid" />
				<set_value name="$kAAIT_midAngleFactorMult" exact="1" />
				<set_value name="$dist_shipToDefensible" exact="this.assignedcontrolled.distanceto.{$target.defensible}" />
				<set_value name="$dist_shipToDefensible_bbox" exact="this.assignedcontrolled.bboxdistanceto.{$target.defensible}" />
				<set_value name="$dist_targetToDefensible" exact="$target.distanceto.{$target.defensible}" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $dist_shipToDefensible: ' + $dist_shipToDefensible" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $dist_shipToDefensible_bbox: ' + $dist_shipToDefensible_bbox" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $dist_targetToDefensible: ' + $dist_targetToDefensible" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<!-- <set_value name="$kAAIT_isMoveAwayFirst" exact="$dist_shipToDefensible_bbox le 0 or $dist_shipToDefensible le $dist_targetToDefensible or $dist_shipToDefensible le $dist_shipToTarget" /> -->
				<set_value name="$kAAIT_isMoveAwayFirst" exact="
					$dist_shipToDefensible le global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_mid and
					(
						$dist_shipToDefensible_bbox le 0 or
						$dist_shipToDefensible le $dist_targetToDefensible or
						$dist_shipToDefensible le $dist_shipToTarget
					)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_isMoveAwayFirst: ' + $kAAIT_isMoveAwayFirst" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<set_value name="$kAAIT_midAngleDiffMax" exact="45" />
				<do_if value="$kAAIT_isMoveAwayFirst">
					<set_value name="$kAAIT_midAngleDiffMax" exact="30" />
				</do_if>
				<include_interrupt_actions ref="kAAIT_GetAngleDiffAndMid" />
				<set_value name="$yaw_engage" exact="$kAAIT_angle_mid" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $yaw_engage (intermediate to kAAIT_result_moveToEngageYaw): ' + $yaw_engage" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			</do_if>
			<do_else>
				<set_value name="$yaw_engage" exact="$kAAIT_result_moveToEngageYaw" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $yaw_engage (kAAIT_result_moveToEngageYaw): ' + $yaw_engage" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			</do_else>

			<include_interrupt_actions ref="GetMoveToEngagePosition" />
			<set_value name="$moveTo_space" exact="$target.sector" />
			<set_value name="$moveTo_pos" exact="$kAAIT_result_moveToEngagePosition" />

			<!-- <create_orientation name="$rotToMoveToPos" orientation="look_at" refposition="$moveTo_pos">
				<position value="$posTarget" />
			</create_orientation>
			<set_value name="$yawToMoveToPos" exact="$rotToMoveToPos.yaw * 180 / pi" />
			<debug_text text="@this.assignedcontrolled.idcode + ' $yawToMoveToPos (final): ' + $yawToMoveToPos" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" /> -->

			<label name="ensure_final_move_if_last_move_wasnt" />
			<do_if value="$isFinalMove">
				<debug_text text="@this.assignedcontrolled.idcode + ' LABEL ensure_final_move_if_last_move_wasnt'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			</do_if>
			<set_value name="$isForceRotation" exact="$isFinalMove" />
			<do_if value="$isForceRotation">
				<create_orientation name="$moveTo_rot" orientation="look_at" refposition="$posTarget">
					<position value="$moveTo_pos" />
				</create_orientation>
				<debug_text text="@this.assignedcontrolled.idcode + ' $isFrontWeapon: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isFrontWeapon" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<do_if value="not @global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData.$isFrontWeapon">
					<set_value name="$kAAIT_currentAttackRotation" exact="$moveTo_rot" />
					<include_interrupt_actions ref="kAAIT_GetBestAttackRotation" />
					<set_value name="$moveTo_rot" exact="$kAAIT_result_bestAttackRotation" />
				</do_if>
			</do_if>
			<do_else>
				<create_orientation name="$moveTo_rot" orientation="look_at" refposition="$moveTo_pos">
					<position value="$posShip" />
				</create_orientation>
			</do_else>
			<debug_text text="@this.assignedcontrolled.idcode + ' $isForceRotation: ' + $isForceRotation" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />

			<debug_text text="@this.assignedcontrolled.idcode + ' move_to start'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			<set_value name="global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData.$count_moveToEngage" operation="add" exact="1" />
			<set_value name="$map_space" exact="$moveTo_space" />
			<set_value name="$map_pos" exact="$moveTo_pos" />
			<set_value name="global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData.$orderLocation_space" exact="$moveTo_space" />
			<set_value name="global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData.$orderLocation_pos" exact="$moveTo_pos" />
			<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget_movedToEngage" exact="$defensibleTarget" />
			<set_value name="this.$capshipattack_pos" exact="[[$moveTo_space, $moveTo_pos], this.assignedcontrolled.size/2m]"/>
			<move_to object="this.assignedcontrolled"
				destination="$moveTo_space"
				uselocalhighways="false"
				useknownpath="this.isplayerowned"
				forceposition="false"
				forcerotation="$isForceRotation"
				forcesteering="(not @this.assignedcontrolled.iscapitalship)"
				commandaction="false"
				travel="true"
				abortpath="false"
				flightbehaviour="flightbehaviour.gaindistance">
				<position value="$moveTo_pos"/>
				<rotation value="$moveTo_rot" />
				<interrupt_after_time time="1s" />
			</move_to>
			<label name="move_locked_destination" />
			<debug_text text="@this.assignedcontrolled.idcode + ' LABEL move_locked_destination'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			<set_value name="$kAAIT_attacker_interruptedMove" exact="null" />
			<debug_text text="@this.assignedcontrolled.idcode + ' wait start'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			<do_if value="not $enemiesWithdrawnFrom?">
				<create_group groupname="$enemiesWithdrawnFrom" />
			</do_if>
			<wait exact="5s">
				<interrupt>
					<conditions>
						<event_object_attacked object="this.assignedcontrolled" />
						<check_any>
							<check_value value="@event.param.threatscore gt this.assignedcontrolled.threatscore * 1.5" />
							<check_value value="@event.param.iscapitalship" />
						</check_any>
						<check_value value="event.param.hasrelation.enemy.{this.assignedcontrolled}" />
						<debug_text text="@this.assignedcontrolled.idcode + ' event.name: ' + event.name + ' event.param: ' + event.param + ' ' + event.param.knownname" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
						<check_value value="not $enemiesWithdrawnFrom.indexof.{event.param}" />
						<check_value value="not $enemiesWithdrawnFrom.indexof.{event.param.defensible}" />
						<set_value name="$kAAIT_attacker_interruptedMove" exact="if event.param.defensible then event.param.defensible else event.param" />
					</conditions>
				</interrupt>
			</wait>
			<debug_text text="@this.assignedcontrolled.idcode + ' wait end'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />

			<set_value name="$kAAIT_result_isTargetInTheWayAttacked" exact="false" />
			<set_value name="$kAAIT_result_isTargetInTheWayIgnored" exact="false" />
			<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_attacker_interruptedMove: ' + $kAAIT_attacker_interruptedMove" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			<do_if value="@$kAAIT_attacker_interruptedMove">
				<set_value name="$kAAIT_test_attackTargetInTheWayOrNot" exact="$kAAIT_attacker_interruptedMove" />
				<include_interrupt_actions ref="kAAIT_GetAttackOrIgnoreTargetInTheWay" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_result_isTargetInTheWayAttacked: ' + $kAAIT_result_isTargetInTheWayAttacked" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_result_isTargetInTheWayIgnored: ' + $kAAIT_result_isTargetInTheWayIgnored" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			</do_if>
			<do_if value="(not @$kAAIT_attacker_interruptedMove) or $kAAIT_result_isTargetInTheWayIgnored">
				<set_value name="$kAAIT_distToEngagePos" exact="this.assignedcontrolled.bboxdistanceto.[$moveTo_space, $moveTo_pos]" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_distToEngagePos: ' + $kAAIT_distToEngagePos" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' this.assignedcontrolled.size * 1.25: ' + (this.assignedcontrolled.size * 1.25)" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $isFinalMove: ' + $isFinalMove" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<do_if value="$kAAIT_distToEngagePos gt this.assignedcontrolled.size * 2">
					<resume label="move_locked_destination" />
				</do_if>
				<do_elseif value="not $isFinalMove">
					<set_value name="$isFinalMove" exact="true" />
					<resume label="ensure_final_move_if_last_move_wasnt" />
				</do_elseif>
				<do_else>
					<set_value name="$kAAIT_test_moveToEngageTarget" exact="$target" />
					<include_interrupt_actions ref="kAAIT_GetIsMoveToEngage" />
					<do_if value="$kAAIT_result_isMovetoEngage">
						<resume label="move_to_engage_position" />
					</do_if>
				</do_else>
			</do_if>

			<label name="finish" />
			<debug_text text="@this.assignedcontrolled.idcode + ' LABEL finish'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			<do_if value="@this.assignedcontrolled.isoperational">
				<do_if value="$kAAIT_original_name? and @$kAAIT_original_name and (this.assignedcontrolled.knownname != @$kAAIT_original_name) and (not @this.assignedcontrolled.coverowner)">
					<!-- Check exists, check not null, check if knownname != original. Removed chance from debug message so any ships that unintentionally got a name change can be tracked -->
					<debug_text text="'MOD: KUDA -- %s(%s) -- set_object_name reset to %s.'.[@this.assignedcontrolled.knownname,@this.assignedcontrolled.idcode,$kAAIT_original_name]" />
					<set_object_name object="this.assignedcontrolled" name="$kAAIT_original_name" />
				</do_if>
			</do_if>

			<!-- ensure facing target -->
			<!-- <create_position name="$moveTo_pos" space="$moveTo_space" object="this.assignedcontrolled" />
			<create_orientation name="$moveTo_rot" orientation="look_at" refposition="$posTarget">
				<position value="$moveTo_pos" />
			</create_orientation>
			<debug_text text="@this.assignedcontrolled.idcode + ' $moveTo_rot: ' + $moveTo_rot" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			<move_to object="this.assignedcontrolled"
				destination="$moveTo_space"
				uselocalhighways="false"
				useknownpath="this.isplayerowned"
				forcesteering="(not @this.assignedcontrolled.iscapitalship)"
				commandaction="false"
				travel="true"
				abortpath="false"
				flightbehaviour="flightbehaviour.gaindistance">
				<position value="$moveTo_pos"/>
				<rotation value="$moveTo_rot" />
			</move_to> -->

			<stop_moving object="this.assignedcontrolled" />
			<!-- <reset_flight_behaviour object="this.assignedcontrolled" /> -->
			<do_if value="@$beacon_obstacle.exists">
				<destroy_object object="$beacon_obstacle" />
			</do_if>
			<do_if value="@$beacon_destination.exists">
				<destroy_object object="$beacon_destination" />
			</do_if>
			<do_if value="global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData?">
				<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_space" />
				<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_pos" />
			</do_if>
			<include_interrupt_actions ref="kAAIT_Deinit" />
		</actions>
	</attention>
	<on_abort>
		<do_if value="@this.assignedcontrolled.isoperational">
			<do_if value="$kAAIT_original_name? and @$kAAIT_original_name and (this.assignedcontrolled.knownname != @$kAAIT_original_name) and (not @this.assignedcontrolled.coverowner)">
				<!-- Check exists, check not null, check if knownname != original. Removed chance from debug message so any ships that unintentionally got a name change can be tracked -->
				<debug_text text="'MOD: KUDA -- %s(%s) -- set_object_name reset to %s.'.[@this.assignedcontrolled.knownname,@this.assignedcontrolled.idcode,$kAAIT_original_name]" />
				<set_object_name object="this.assignedcontrolled" name="$kAAIT_original_name" />
			</do_if>
		</do_if>
		<do_if value="@$beacon_obstacle.exists">
			<destroy_object object="$beacon_obstacle" />
		</do_if>
		<do_if value="@$beacon_destination.exists">
			<destroy_object object="$beacon_destination" />
		</do_if>
		<do_if value="@this.assignedcontrolled.isoperational">
			<stop_moving object="this.assignedcontrolled" />
			<!-- <reset_flight_behaviour object="this.assignedcontrolled" /> -->
		</do_if>
		<do_if value="global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData?">
			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_space" />
			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_pos" />
		</do_if>
		<include_interrupt_actions ref="kAAIT_Deinit" />
	</on_abort>
</aiscript>
