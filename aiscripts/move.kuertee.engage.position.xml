<?xml version="1.0" encoding="utf-8" ?>
<aiscript name="move.kuertee.engage.position" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="aiscripts.xsd" version="18">
	<order id="kAAIT_MoveEngagePosition" name="{1111920, 106}" description="{1111920, 126}" category="internal">
		<params>
			<param name="target" required="true" type="object" text="{1041, 10126}" comment="target" />
			<param name="kAAITParam_iskAAITOrder" required="false" default="true" type="internal" />
			<param name="debugchance" type="bool" default="0" advanced="true" text="{1041, 10086}" comment="Print debug output">
				<input_param name="truevalue" value="100"/>
			</param>
		</params>
		<requires>
			<match shiptype="shiptype.lasertower" negate="true"/>
		</requires>
		<location object="@$orderLocation_space" position="@$orderLocation_pos" condition="@$orderLocation_space and @$orderLocation_pos" />
		<location object="$target" condition="$target" />
	</order>
	<interrupts>
		<handler ref="DisengageHandler"/>
		<handler ref="kAAIT_Handler_AvoidWithdrawOrJustFight" />
		<handler ref="kAAIT_Handler_NewBigTarget" />
		<handler comment="target destroyed">
			<conditions>
				<check_any>
					<event_object_destroyed object="$target" check="false" />
					<event_object_destroyed object="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget" check="false" />
				</check_any>
			</conditions>
			<actions>
				<debug_text text="@this.assignedcontrolled.idcode + ' event.name: ' + event.name" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
				<abort_called_scripts resume="finish" />
			</actions>
		</handler>
		<handler comment="target attacked">
			<conditions>
				<event_object_attacked object="$target" />
				<check_any>
					<check_value value="not $target.isclass.station" />
					<check_value value="this.assignedcontrolled.cansee.{$target}" />
				</check_any>
				<check_value value="event.param.owner == this.owner" />
				<check_value value="event.param.isclass.ship" />
				<check_value value="not event.param.isunit" />
				<check_value value="not event.param.islasertower" />
				<check_value value="event.param != player.occupiedship" />
				<check_value value="not @$isReposition" />
			</conditions>
			<actions>
				<do_if value="not @global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}">
					<include_interrupt_actions ref="kAAIT_Init" />
				</do_if>
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$target_skipMoveToEngage" exact="$target" />
				<debug_text text="@this.assignedcontrolled.idcode + ' event.name: ' + event.name" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
				<abort_called_scripts resume="finish" />
			</actions>
		</handler>
	</interrupts>
	<init>
		<set_value name="$kAAIT_detailedDebugChance" exact="100" />
		<!-- required for disengage handler -->
		<set_value name="$pursuetargets" exact="false" />
		<set_value name="$pursuedistance" exact="this.assignedcontrolled.maxradarrange" />
		<set_value name="$debugchance" exact="0" />
	</init>
	<attention min="unknown">
		<actions>
			<include_interrupt_actions ref="kAAIT_Init" />
			<debug_text text="@this.assignedcontrolled.idcode + ' $target: ' + $target + ' (' + @$target.knownname + ', ' + @$target.idcode + ')'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />

			<label name="fight" comment="required for DisengageHandler. $disengage_pursue resumes at fight label. in this case, just restart." />
			<debug_text text="@this.assignedcontrolled.idcode + ' LABEL fight'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />

			<label name="start" />
			<debug_text text="@this.assignedcontrolled.idcode + ' LABEL start'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
			<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget_stoppedKamikaze" exact="$target" />

			<label name="move_to_target" />
			<do_if value="this.sector != $target.sector">
				<debug_text text="@this.assignedcontrolled.idcode + ' LABEL move_to_target'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_space" exact="$target" />
				<create_position name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_pos" x="0" y="0" z="0" />
				<run_script name="'move.generic'" result="$movesuccess">
					<param name="destination" value="$target.sector" />
					<param name="stopondetect" value="$target.sector"/>
					<param name="kAAITParam_iskAAITOrder" value="true" />
				</run_script>
			</do_if>

			<label name="move_to_engage_position" />
			<debug_text text="@this.assignedcontrolled.idcode + ' LABEL move_to_engage_position'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />

			<set_value name="$orderLocation_space" exact="this.sector" />
			<create_position name="$posShip" space="$orderLocation_space" object="this.assignedcontrolled" />
			<create_position name="$posTarget" space="$orderLocation_space" object="$target" />
			<create_orientation name="$rotFromTarget" orientation="look_at" refposition="$posShip">
				<position value="$posTarget" />
			</create_orientation>
			<!-- <set_value name="$pitch_deg" exact="$rotFromTarget.pitch * 180 / pi" /> -->
			<set_value name="$pitch_deg" min="-15" max="15" />
			<set_value name="$ship_yaw_deg" exact="$rotFromTarget.yaw * 180 / pi" />
			<debug_text text="@this.assignedcontrolled.idcode + ' $ship_yaw_deg: ' + $ship_yaw_deg" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />

			<set_value name="$isUseMoveGeneric" exact="false" />
			<do_if value="$target.isclass.module and (not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isFirstModuleTarget)">
				<debug_text text="@this.assignedcontrolled.idcode + ' move to better position v module'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
				<set_value name="$isReposition" exact="true" />
				<create_position name="$posStation" space="$orderLocation_space" object="$target.defensible" />
				<create_orientation name="$module_rotFromDefensible" orientation="look_at" refposition="$posTarget">
					<position value="$posStation" />
				</create_orientation>
				<!-- <set_value name="$pitch_deg" exact="$module_rotFromDefensible.pitch * 180 / pi" /> -->
				<set_value name="$pitch_deg" min="-15" max="15" />
				<set_value name="$module_yaw_deg" exact="$module_rotFromDefensible.yaw * 180 / pi" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $module_yaw_deg: ' + $module_yaw_deg" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
				<!-- <set_value name="$yaw_deg" exact="$module_yaw_deg + [-90, -75, -60, -45, -30, -15, 0, 15, 30, 45, 60, 75, 90].random + $random_jitter" /> -->
				<!-- <do_if value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl.count">
					<set_value name="$angle_max" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl.count * 5" />
					<set_value name="$angle_this" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl.indexof.{this.assignedcontrolled}" />
					<set_value name="$random_jitter" exact="$angle_max * 0.5 - $angle_this * 5" />
				</do_if>
				<do_else> -->
					<set_value name="$random_jitter" min="-5" max="5" />
				<!-- </do_else> -->
				<set_value name="$yaw_deg" exact="$ship_yaw_deg + ($module_yaw_deg - $ship_yaw_deg) * 0.5 + $random_jitter" />
				<!-- <set_value name="$yaw_deg" exact="$module_yaw_deg + $random_jitter" /> -->
				<debug_text text="@this.assignedcontrolled.idcode + ' $yaw_deg: ' + $yaw_deg" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
				<set_value name="$kAAIT_test_target_isInTheWay" exact="$target.defensible" />
				<set_value name="$kAAIT_test_target_isInTheWayOf" exact="$target" />
				<include_interrupt_actions ref="kAAIT_GetIsTargetInTheWay" />
				<remove_value name="$kAAIT_test_target_isInTheWay" />
				<remove_value name="$kAAIT_test_target_isInTheWayOf" />
				<set_value name="$isUseMoveGeneric" exact="$kAAIT_result_isTargetInTheWay" />
				<remove_value name="$kAAIT_result_isTargetInTheWay" />
			</do_if>
			<!-- <do_elseif value="$target.isclass.[class.ship_l, class.ship_xl]">
				<set_value name="$random_jitter" min="-15" max="15" />
				<set_value name="$attacker_index" exact="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl.indexof.{this.assignedcontrolled}" />
				<do_if value="$attacker_index * 0.5 == ($attacker_index)i * 0.5" comment="even: yaw + 45">
					<set_value name="$yaw_deg" exact="$target.relativerotation.{this.assignedcontrolled}.yaw * 180 / pi + 45" />
				</do_if>
				<do_else comment="odd: yaw - 45">
					<set_value name="$yaw_deg" exact="$target.relativerotation.{this.assignedcontrolled}.yaw * 180 / pi - 45" />
				</do_else>
			</do_elseif> -->
			<do_else>
				<set_value name="$random_jitter" min="-5" max="5" />
				<set_value name="$yaw_deg" exact="$ship_yaw_deg + [-45, -30, -15, 0, 15, 30, 45].random + $random_jitter" />
			</do_else>
			<set_value name="$yaw" exact="$yaw_deg * pi / 180" />
			<set_value name="$pitch" exact="$pitch_deg * pi / 180" />
			<do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$combatRange_max?">
				<include_interrupt_actions ref="kAAIT_GetCombatRange" />
			</do_if>
			<do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_distance_engagePosition_mult?">
				<include_interrupt_actions ref="kAAIT_GetSkillVars" />
			</do_if>
			<do_if value="
				this.assignedcontrolled.primarypurpose == purpose.fight and
				this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl]
			">
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$distance_attackFrom" exact="$target.size * 0.5 + global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$combatRange_max * global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_distance_engagePosition_mult" />
			</do_if>
			<do_else>
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$distance_attackFrom" exact="$target.size * 0.5 + this.assignedcontrolled.maxradarrange * 0.5 * global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_distance_engagePosition_mult" />
			</do_else>
			<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_data.$distance_attackFrom: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$distance_attackFrom" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' and $kAAIT_detailedDebugChance then @global.$kAAIT_Data.$debugChance else 0" />
			<create_position name="$orderLocation_pos"
				x="$posTarget.x + global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$distance_attackFrom * sin ($yaw) * cos ($pitch)"
				y="$posTarget.y + global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$distance_attackFrom * sin ($pitch) + [-5m, -2.5m, 0, 2.5m, 5m].random"
				z="$posTarget.z + global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$distance_attackFrom * cos ($yaw) * cos ($pitch)"
			/>
			<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_space" exact="$orderLocation_space" />
			<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_pos" exact="$orderLocation_pos" />
			<debug_text text="@this.assignedcontrolled.idcode + ' $isUseMoveGeneric: ' + $isUseMoveGeneric" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />

			<label name="move_locked_destination" />
			<debug_text text="@this.assignedcontrolled.idcode + ' LABEL move_locked_destination'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
			<set_value name="$dist" exact="this.assignedcontrolled.bboxdistanceto.[$orderLocation_space, $orderLocation_pos]" />
			<debug_text text="@this.assignedcontrolled.idcode + ' $dist: ' + $dist" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
			<do_if value="$isUseMoveGeneric">
				<run_script name="'move.generic'" result="$movesuccess">
					<param name="destination" value="$orderLocation_space" />
					<param name="position" value="$orderLocation_pos" />
					<param name="kAAITParam_iskAAITOrder" value="true" />
				</run_script>
			</do_if>
			<do_else>
				<move_to object="this.assignedcontrolled"
					destination="$orderLocation_space"
					uselocalhighways="false"
					useknownpath="this.isplayerowned"
					forcesteering="this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m]"
					commandaction="false"
					travel="true">
					<position value="$orderLocation_pos"/>
				</move_to>
			</do_else>
			<set_value name="$dist" exact="this.assignedcontrolled.bboxdistanceto.[$orderLocation_space, $orderLocation_pos]" />
			<debug_text text="@this.assignedcontrolled.idcode + ' $dist: ' + $dist" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
			<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_isInterrupted: ' + @$kAAIT_isInterrupted" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
			<do_if value="@$kAAIT_isInterrupted and this.assignedcontrolled.bboxdistanceto.[$orderLocation_space, $orderLocation_pos] gt 1km">
				<remove_value name="$kAAIT_isInterrupted" />
				<resume label="move_locked_destination" />
			</do_if>

			<label name="finish" />
			<debug_text text="@this.assignedcontrolled.idcode + ' LABEL finish'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
			<stop_moving object="this.assignedcontrolled" />
			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_space" />
			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_pos" />
			<include_interrupt_actions ref="kAAIT_Deinit" />
		</actions>
	</attention>
	<on_abort>
		<do_if value="@this.assignedcontrolled.isoperational">
			<stop_moving object="this.assignedcontrolled" />
		</do_if>
		<do_if value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data">
			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_space" />
			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_pos" />
		</do_if>
		<include_interrupt_actions ref="kAAIT_Deinit" />
	</on_abort>
</aiscript>
