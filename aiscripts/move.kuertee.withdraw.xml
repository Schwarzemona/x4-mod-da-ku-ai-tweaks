<?xml version="1.0" encoding="utf-8" ?>
<aiscript name="move.kuertee.withdraw" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="aiscripts.xsd" version="18">
	<order id="kAAIT_MoveWithdraw" name="{1111920, 108}" description="{1111920, 108}" category="internal">
		<params>
			<param name="target" required="false" default="null" type="internal" />
			<param name="kAAITParam_iskAAITOrder" required="false" default="true" type="internal" />
			<param name="kAAITParam_isAvoidHighRisk" required="false" type="internal" text="{1111920, 3}" default="
				if this.$kAAIT_isAvoidHighRisk_user? then 
					this.$kAAIT_isAvoidHighRisk_user
				else (
					if (not this.assignedcontrolled.isunit) and (not this.assignedcontrolled.islasertower) and
					(
						(
							this.assignedcontrolled.isplayerowned and
							this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m] and
							@global.$kAAIT_Config.$xssm_isAvoidHighRisk
						) or
						(
							(not this.assignedcontrolled.isplayerowned) and
							this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m] and
							@global.$kAAIT_Config.$xssm_isAvoidHighRisk_allFactions
						) or
						(
							this.assignedcontrolled.isplayerowned and
							this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
							($target.isclass.ship or @$target.defensible.isclass.ship) and
							@global.$kAAIT_Config.$lxl_isAvoidHighRisk_vShip
						) or
						(
							this.assignedcontrolled.isplayerowned and
							this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
							($target.isclass.station or @$target.defensible.isclass.station) and
							@global.$kAAIT_Config.$lxl_isAvoidHighRisk_vStation
						) or
						(
							(not this.assignedcontrolled.isplayerowned) and
							this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
							($target.isclass.ship or @$target.defensible.isclass.ship) and
							@global.$kAAIT_Config.$lxl_isAvoidHighRisk_vShip_allFactions
						) or
						(
							(not this.assignedcontrolled.isplayerowned) and
							this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
							($target.isclass.station or @$target.defensible.isclass.station) and
							@global.$kAAIT_Config.$lxl_isAvoidHighRisk_vStation_allFactions
						)
					) then true else false
				)
			" />
			<param name="kAAITParam_isStepForwardWithdraw" required="false" type="internal" text="{1111920, 109}" default="
				if (not this.assignedcontrolled.isunit) and (not this.assignedcontrolled.islasertower) and
				(
					(
						this.assignedcontrolled.isplayerowned and
						this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
						(
							(
								$target.isclass.ship or @$target.defensible.isclass.ship and
								(
									@global.$kAAIT_Config.$lxl_isStepForward_vShip or
									@global.$kAAIT_Config.$lxl_isMoveOutOfRange_vShip
								)
							) or
							(
								$target.isclass.station or @$target.defensible.isclass.station and
								(
									@global.$kAAIT_Config.$lxl_isStepForward_vStation or
									@global.$kAAIT_Config.$lxl_isMoveOutOfRange_vStation
								)
							)
						)
					) or
					(
						(not this.assignedcontrolled.isplayerowned) and
						this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
						(
							(
								$target.isclass.ship or @$target.defensible.isclass.ship and
								(
									@global.$kAAIT_Config.$lxl_isStepForward_vShip_allFactions or
									@global.$kAAIT_Config.$lxl_isMoveOutOfRange_vShip_allFactions
								)
							) or
							(
								$target.isclass.station or @$target.defensible.isclass.station and
								(
									@global.$kAAIT_Config.$lxl_isStepForward_vStation_allFactions or
									@global.$kAAIT_Config.$lxl_isMoveOutOfRange_vStation_allFactions
								)
							)
						)
					)
				) then true else false
			" />
			<param name="debugchance" type="bool" default="0" advanced="true" text="{1041, 10086}" comment="Print debug output">
				<input_param name="truevalue" value="100"/>
			</param>
		</params>
		<requires>
			<match shiptype="shiptype.lasertower" negate="true"/>
		</requires>
		<location object="@$orderLocation_space" position="@$orderLocation_pos" condition="@$orderLocation_space and @$orderLocation_pos" />
	</order>
	<interrupts>
		<handler ref="DisengageHandler"/>
		<handler ref="kAAIT_Handler_TargetDestroyed" />
	</interrupts>
	<init>
		<!-- required for disengage handler -->
		<set_value name="$pursuetargets" exact="false" />
		<set_value name="$pursuedistance" exact="this.assignedcontrolled.maxradarrange" />
		<set_value name="$debugchance" exact="0" />
		<set_value name="this.$kAAIT_data.$isWithdrawing" exact="true" />
		<debug_text text="this.assignedcontrolled.idcode + ' this.$kAAIT_data.$isWithdrawing: ' + @this.$kAAIT_data.$isWithdrawing" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
	</init>
	<attention min="unknown">
		<actions>
			<include_interrupt_actions ref="kAAIT_Init" />

			<label name="start"/>
			<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_MoveWithdraw start'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			<include_interrupt_actions ref="kAAIT_CleanOrders" />
			<debug_text text="this.assignedcontrolled.idcode + ' this.$kAAIT_data: ' + @this.$kAAIT_data" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			<set_value name="this.$kAAIT_data.$count_stepForward" exact="0" />
			<set_value name="$orderLocation_space" exact="this.assignedcontrolled.sector" />
			<create_position name="$posShip" space="$orderLocation_space" object="this.assignedcontrolled" />
			<create_position name="$posTarget" space="$orderLocation_space" object="$target" />
			<create_orientation name="$rotFromTarget" orientation="look_at" refposition="$posShip">
				<position value="$posTarget" />
			</create_orientation>
			<set_value name="$ship_yaw_deg" exact="$rotFromTarget.yaw * 180 / pi" />
			<do_if value="$target.isclass.ship">
				<set_value name="$yaw_deg" exact="$ship_yaw_deg + [-45, 45].random" />
			</do_if>
			<do_else>
				<set_value name="$yaw_deg" exact="$ship_yaw_deg" />
			</do_else>
			<set_value name="$yaw" exact="$yaw_deg * pi / 180" />
			<debug_text text="this.assignedcontrolled.idcode + ' this.assignedcontrolled.primarypurpose: ' + @this.assignedcontrolled.primarypurpose" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			<do_if value="not this.$kAAIT_data.$skill_distance_withdraw?">
				<include_interrupt_actions ref="kAAIT_GetSkillVars" />
			</do_if>
			<do_if value="$target != @this.$kAAIT_data.$defensibleTarget">
				<set_value name="this.$kAAIT_data.$distance_attackFrom" exact="this.assignedcontrolled.maxradarrange" />
			</do_if>
			<do_elseif value="
				$target.isclass.ship or
				this.assignedcontrolled.primarypurpose != purpose.fight or
				this.assignedcontrolled.type == shiptype.carrier
			">
				<set_value name="this.$kAAIT_data.$distance_attackFrom" exact="this.$kAAIT_data.$skill_distance_withdraw" />
			</do_elseif>
			<do_else>
				<set_value name="$combatRange_mid" exact="this.$kAAIT_data.$combatRange_min + (this.$kAAIT_data.$combatRange_max - this.$kAAIT_data.$combatRange_min) * 0.5" />
				<set_value name="$dist_adjByShields" exact="(100 - this.assignedcontrolled.shieldpercentage) / 100 * this.$kAAIT_data.$skill_distance_withdraw" />
				<set_value name="this.$kAAIT_data.$distance_attackFrom" exact="$combatRange_mid + $dist_adjByShields" />
			</do_else>
			<debug_text text="this.assignedcontrolled.idcode + ' this.$kAAIT_data.$distance_attackFrom: ' + @this.$kAAIT_data.$distance_attackFrom" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			<create_position name="$orderLocation_pos"
				x="$posTarget.x + this.$kAAIT_data.$distance_attackFrom * sin ($yaw) * cos ($rotFromTarget.pitch)"
				y="$posTarget.y + this.$kAAIT_data.$distance_attackFrom * sin ($rotFromTarget.pitch)"
				z="$posTarget.z + this.$kAAIT_data.$distance_attackFrom * cos ($yaw) * cos ($rotFromTarget.pitch)"
			/>
			<create_position name="$orderLocation_pos" x="$orderLocation_pos.x" y="$posShip.y" z="$orderLocation_pos.z" />
			<set_value name="this.$kAAIT_data.$orderLocation_space" exact="$orderLocation_space" />
			<set_value name="this.$kAAIT_data.$orderLocation_pos" exact="$orderLocation_pos" />

			<debug_text text="this.assignedcontrolled.idcode + ' move_to start'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			<set_value name="$dist_targetToWithdrawDest" exact="$target.distanceto.[$orderLocation_space, $orderLocation_pos]" />
			<do_if value="this.assignedcontrolled.bboxdistanceto.{$target} gt this.assignedcontrolled.maxradarrange">
				<resume label="finish" />
			</do_if>
			<move_to object="this.assignedcontrolled"
				destination="$orderLocation_space"
				uselocalhighways="false"
				useknownpath="this.isplayerowned"
				forcesteering="this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m]"
				commandaction="false">
				<position value="$orderLocation_pos"/>
				<interrupt>
					<conditions>
						<check_any>
							<event_object_attacked object="this.assignedcontrolled" />
							<event_object_attacked object="$target" />
							<event_object_changed_zone object="this.assignedcontrolled" />
							<event_object_changed_zone object="$target" />
						</check_any>
						<check_value value="this.assignedcontrolled.primarypurpose == purpose.fight" />
						<check_value value="this.assignedcontrolled.type != shiptype.carrier" />
						<check_value value="this.assignedcontrolled.weapons.operational.count / (this.assignedcontrolled.weapons.all.count)f gt 0.25" />
						<check_any>
							<check_all>
								<check_value value="this.$kAAIT_data.$defensibleTarget.isclass.ship" />
								<check_any>
									<check_value value="this.$kAAIT_data.$defensibleTarget.shieldpercentage le 25" />
									<check_all>
										<check_value value="this.assignedcontrolled.hullpercentage le 50" />
										<check_value value="this.assignedcontrolled.bboxdistanceto.{this.$kAAIT_data.$defensibleTarget} gt this.assignedcontrolled.maxradarrange * 0.25" comment="just fight if there's room" />
									</check_all>
								</check_any>
								<set_value name="$kAAIT_isJustFight" exact="true" />
							</check_all>
							<check_all>
								<check_any>
									<check_value value="this.assignedcontrolled.bboxdistanceto.{$target} gt this.assignedcontrolled.maxradarrange" />
									<check_all>
										<check_value value="this.assignedcontrolled.bboxdistanceto.{$target} gt this.assignedcontrolled.maxradarrange * 0.25" />
										<check_value value="$target.distanceto.[$orderLocation_space, $orderLocation_pos] gt $dist_targetToWithdrawDest" comment="enemy ship must have stopped chasing" />
									</check_all>
								</check_any>
								<set_value name="$kAAIT_isCancelWithdrawal" exact="true" />
							</check_all>
						</check_any>
					</conditions>
					<actions>
						<do_if value="@$kAAIT_isJustFight">
							<set_value name="this.$kAAIT_data.$isIgnoreKAAIT" exact="$kAAIT_isJustFight" />
							<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_isJustFight: ' + $kAAIT_isJustFight" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
						</do_if>
						<do_elseif value="$kAAIT_isCancelWithdrawal">
							<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_isCancelWithdrawal: ' + $kAAIT_isCancelWithdrawal" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
						</do_elseif>
					</actions>
				</interrupt>
			</move_to>
			<debug_text text="this.assignedcontrolled.idcode + ' move_to end'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			<remove_value name="this.$kAAIT_data.$defensibleTarget_stoppedKamikaze" />
			<remove_value name="this.$kAAIT_data.$moduleTarget" />

			<label name="fight" comment="required for DisengageHandler. $disengage_pursue resumes at fight label. in this case, just finish." />

			<label name="finish" />
			<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_MoveWithdraw finish'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			<set_value name="this.$kAAIT_data.$isWithdrawing" exact="false" />
			<debug_text text="this.assignedcontrolled.idcode + ' this.$kAAIT_data.$isWithdrawing: ' + @this.$kAAIT_data.$isWithdrawing" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			<remove_value name="this.$kAAIT_data.$orderLocation_space" />
			<remove_value name="this.$kAAIT_data.$orderLocation_pos" />
			<include_interrupt_actions ref="kAAIT_Deinit" />
		</actions>
	</attention>
	<on_abort>
		<do_if value="@this.$kAAIT_data">
			<set_value name="this.$kAAIT_data.$isWithdrawing" exact="false" />
			<remove_value name="this.$kAAIT_data.$orderLocation_space" />
			<remove_value name="this.$kAAIT_data.$orderLocation_pos" />
		</do_if>
		<include_interrupt_actions ref="kAAIT_Deinit" />
	</on_abort>
</aiscript>
