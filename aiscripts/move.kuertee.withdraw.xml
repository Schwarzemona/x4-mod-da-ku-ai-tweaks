<?xml version="1.0" encoding="utf-8" ?>
<aiscript name="move.kuertee.withdraw" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="aiscripts.xsd" version="18">
	<order id="kAAIT_MoveWithdraw" name="{1111920, 108}" description="{1111920, 128}" category="internal">
		<params>
			<param name="target" required="true" type="object" text="{1041, 10126}" comment="target" />
			<param name="kAAITParam_iskAAITOrder" required="false" default="true" type="internal" />
			<param name="debugchance" type="bool" default="0" advanced="true" text="{1041, 10086}" comment="Print debug output">
				<input_param name="truevalue" value="100"/>
			</param>
		</params>
		<requires>
			<match shiptype="shiptype.lasertower" negate="true"/>
		</requires>
		<location object="@$orderLocation_space" position="@$orderLocation_pos" condition="@$orderLocation_space and @$orderLocation_pos" />
	</order>
	<interrupts>
		<handler ref="DisengageHandler"/>
		<handler comment="target destroyed">
			<conditions>
				<check_any>
					<event_object_destroyed object="$target" check="false" />
					<event_object_destroyed object="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget" check="false" />
				</check_any>
			</conditions>
			<actions>
				<abort_called_scripts resume="finish" />
			</actions>
		</handler>
		<handler comment="cancelled">
			<conditions>
				<event_object_order_cancelled object="this.assignedcontrolled" />
				<check_value value="not @global.$kAAIT_Data.$debugChance" />
			</conditions>
			<actions>
				<debug_text text="@this.assignedcontrolled.idcode + ' EVENT event.name: ' + event.name + ' event.param.id: ' + @event.param.id + ' event.param2: ' + @event.param2" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
				<debug_text text="@this.assignedcontrolled.idcode + ' EVENT this.assignedcontrolled.order.id: ' + @this.assignedcontrolled.order.id" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
				<do_if value="@this.assignedcontrolled.order.id != 'kAAIT_MoveWithdraw'">
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$time_withdrawAllowed" exact="player.age + 10s" />
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$distance_attackFrom" exact="this.assignedcontrolled.bboxdistanceto.{$target}" />
					<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isWithdrawing" />
					<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$target_avoid" />
					<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_space" />
					<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_pos" />
					<abort_called_scripts resume="finish" />
				</do_if>
			</actions>
		</handler>
	</interrupts>
	<init>
		<include_interrupt_actions ref="kAAIT_Init" />
		<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$time_withdrawAllowed" />
		<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isWithdrawing" exact="true" />
		<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_data.$isWithdrawing: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isWithdrawing" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<!-- required for disengage handler -->
		<set_value name="$pursuetargets" exact="false" />
		<set_value name="$pursuedistance" exact="this.assignedcontrolled.maxradarrange" />
		<set_value name="$debugchance" exact="0" />
	</init>
	<attention min="unknown">
		<actions>
			<do_if value="@$target.defensible">
				<set_value name="$target" exact="$target.defensible" />
			</do_if>
			<do_if value="$target.isclass.ship">
				<do_if value="this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl]">
					<include_interrupt_actions ref="kAAIT_RequestHelp" comment="always request help at every new withdrawal" />
				</do_if>
			</do_if>
			<label name="start"/>
			<set_value name="$kAAIT_detailedDebugChance" exact="0" />
			<debug_text text="@this.assignedcontrolled.idcode + ' LABEL start'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
			<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$count_stepForward" exact="0" />
			<set_value name="$orderLocation_space" exact="this.sector" />
			<create_position name="$posShip" space="$orderLocation_space" object="this.assignedcontrolled" />
			<create_position name="$posTarget" space="$orderLocation_space" object="$target" />
			<create_orientation name="$rotFromTarget" orientation="look_at" refposition="$posShip" comment="get vector from target ship because that's the direction of the withdraw">
				<position value="$posTarget" />
			</create_orientation>
			<set_value name="$pitch_fromTarget" exact="$rotFromTarget.pitch * 180 / pi" />
			<set_value name="$pitch_toWithdraw_deg" min="-15" max="15" />
			<set_value name="$yaw_fromTargetToSelf" exact="$rotFromTarget.yaw * 180 / pi" />
			<include_interrupt_actions ref="kAAIT_GetBigEnemies" />
			<set_value name="$isWithdrawFromMultiple" exact="0" />
			<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_data.$bigEnemies.count: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$bigEnemies.count" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' and $kAAIT_detailedDebugChance then @global.$kAAIT_Data.$debugChance else 0" />
			<do_if value="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$bigEnemies.count"
				comment="get average of withdraw vectors from all big enemies">
				<set_value name="$isWithdrawFromMultiple" exact="1" />
				<do_for_each name="$kAAIT_bigEnemy" in="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$bigEnemies">
					<create_position name="$posBigEnemy" space="$orderLocation_space" object="$kAAIT_bigEnemy" />
					<create_orientation name="$rotFromBigEnemy" orientation="look_at" refposition="$posShip" comment="get vector from enemy because that's the direction of the withdraw">
						<position value="$posBigEnemy" />
					</create_orientation>
					<set_value name="$yaw_fromTargetToSelf" exact="$yaw_fromTargetToSelf + ($rotFromBigEnemy.yaw * 180 / pi - $yaw_fromTargetToSelf) * 0.5" />
				</do_for_each>
			</do_if>
			<set_value name="$yaw_toWithdraw_deg" exact="null" />
			<set_value name="$ally" exact="null" />
			<do_if value="$target.isclass.station">
				<set_value name="$yaw_toWithdraw_deg" exact="$yaw_fromTargetToSelf" />
			</do_if>
			<do_else>
				<do_if value="
					this.assignedcontrolled.bboxdistanceto.{$target} le 10km and
					$target == @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget and
					@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget.isclass.ship and
					@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl.count"
					comment="withdraw angle at 60 deg of ally to enemy">
					<sort_group group="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl" sortbydistanceto="this.assignedcontrolled" sortdescending="false" />
					<do_for_each name="$ally" in="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl">
						<do_if value="
							$ally != this.assignedcontrolled and
							$ally.primarypurpose == purpose.fight and
							$ally.type == shiptype.carrier and
							$ally.isoperational and
							$ally.bboxdistanceto.{$target} gt 5km and
							$ally.order.id != 'kAAIT_MoveAvoid' and
							$ally.order.id != 'kAAIT_MoveWithdraw'
						">
							<create_position name="$pos_ally" space="$orderLocation_space" object="$ally" comment="get vectors based on target because the create_position below will be from the target" />
							<create_orientation name="$rot_toAlly" orientation="look_at" refposition="$pos_ally" comment="get vector from target ship because the eariler vector is based on that">
								<position value="$posShip" />
							</create_orientation>
							<set_value name="$yaw_toAlly" exact="$rot_toAlly.yaw * 180 / pi" />
							<set_value name="$yaw_adj" exact="$yaw_toAlly - $yaw_fromTargetToSelf" />
							<do_if value="$yaw_adj gt -45 and $yaw_adj le 45" comment="withdraw and ally vectors are too near each other, add 45 to withdraw vector">
								<do_if value="$yaw_adj le 0">
									<set_value name="$yaw_adj" exact="$yaw_adj * 0.5 + (45 + 45 * $isWithdrawFromMultiple)" />
								</do_if>
								<do_else>
									<set_value name="$yaw_adj" exact="$yaw_adj * 0.5 - (45 + 45 * $isWithdrawFromMultiple)" />
								</do_else>
							</do_if>
							<do_else>
								<set_value name="$yaw_adj" exact="$yaw_adj * 0.5" comment="vector halfway between withdraw and ally vectors" />
							</do_else>
							<set_value name="$yaw_toWithdraw_deg" exact="$yaw_fromTargetToSelf + $yaw_adj" />
							<break />
						</do_if>
					</do_for_each>
				</do_if>
				<do_if value="$yaw_toWithdraw_deg == null" comment="no vector determined, get random vector">
					<set_value name="$yaw_toWithdraw_deg" exact="$yaw_fromTargetToSelf" />
				</do_if>
			</do_else>
			<set_value name="$yaw" exact="$yaw_toWithdraw_deg * pi / 180" />
			<set_value name="$pitch" exact="$pitch_toWithdraw_deg * pi / 180" />

			<label name="move" />
			<debug_text text="@this.assignedcontrolled.idcode + ' LABEL move'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
			<do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_distance_withdraw?">
				<include_interrupt_actions ref="kAAIT_GetSkillVars" />
			</do_if>
			<do_if value="
				$target != @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget or
				(not this.assignedcontrolled.weapons.all.count) or
				(not this.assignedcontrolled.engines.all.count) or
				this.assignedcontrolled.weapons.operational.count / (this.assignedcontrolled.weapons.all.count)f le 0.25 or
				this.assignedcontrolled.engines.operational.count / (this.assignedcontrolled.engines.all.count)f le 0.25">
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$distance_attackFrom" exact="this.assignedcontrolled.maxradarrange" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_data.$distance_attackFrom (maxradarrange - not attack target): ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$distance_attackFrom" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
			</do_if>
			<do_elseif value="
				$target.isclass.ship and
				this.assignedcontrolled.primarypurpose != purpose.fight">
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$distance_attackFrom" exact="this.assignedcontrolled.maxradarrange" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_data.$distance_attackFrom (maxradarrange - not fighter or large target): ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$distance_attackFrom" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
			</do_elseif>
			<do_else>
				<set_value name="$combatRange_mid" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$combatRange_min + (global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$combatRange_max - global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$combatRange_min) * 0.5" />
				<do_if value="@$target.isclass.station">
					<set_value name="$dist_adjByShields" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_distance_withdraw" />
				</do_if>
				<do_else>
					<set_value name="$dist_adjByShields" exact="(100 - this.assignedcontrolled.shieldpercentage) / 100 * global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_distance_withdraw" />
				</do_else>
				<!-- <set_value name="$dist_adjByShields" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_distance_withdraw" /> -->
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$distance_attackFrom" exact="$combatRange_mid + $dist_adjByShields" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_data.$distance_attackFrom (mid combat range (' + $combatRange_mid + ') + shield-based (' + (100 - this.assignedcontrolled.shieldpercentage) + ') withdraw distance (' + global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_distance_withdraw + ')): ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$distance_attackFrom" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
				<do_if value="$target.isclass.[class.ship_l, class.ship_xl]">
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$distance_attackFrom"
						exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$distance_attackFrom * 1.5" />
				</do_if>
			</do_else>
			<do_if value="$target.isclass.ship">
				<do_if value="$dist_targetToAlly? and @$dist_targetToAlly le 5km" comment="there's an lxl ally near the target, increase withdraw distance. shorter, original dist allows allies to near target.">
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$distance_attackFrom" exact="[global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$distance_attackFrom * 1.5, this.assignedcontrolled.maxradarrange].min" />
					<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_data.$distance_attackFrom (target is ship, withdraw distance * 1.5): ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$distance_attackFrom" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
				</do_if>
			</do_if>
			<do_if value="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$distance_attackFrom lt @$distance_attackFrom_saved">
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$distance_attackFrom" exact="$distance_attackFrom_saved" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_data.$distance_attackFrom (use saved distance): ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$distance_attackFrom" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
			</do_if>
			<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_data.$distance_attackFrom: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$distance_attackFrom" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
			<create_position name="$posTarget" space="$orderLocation_space" object="$target" />
			<create_position name="$orderLocation_pos"
				x="$posTarget.x + global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$distance_attackFrom * sin ($yaw) * cos ($pitch)"
				y="$posTarget.y + global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$distance_attackFrom * sin ($pitch)"
				z="$posTarget.z + global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$distance_attackFrom * cos ($yaw) * cos ($pitch)"
			/>
			<set_value name="$distance_attackFrom_saved" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$distance_attackFrom" />
			<!-- <create_position name="$orderLocation_pos" x="$orderLocation_pos.x" y="$posShip.y" z="$orderLocation_pos.z" /> -->
			<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_space" exact="$orderLocation_space" />
			<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_pos" exact="$orderLocation_pos" />

			<do_if value="this.assignedcontrolled.bboxdistanceto.{$target} gt this.assignedcontrolled.maxradarrange">
				<resume label="finish" />
			</do_if>

			<set_value name="$dist_toWithdrawDest" exact="this.assignedcontrolled.bboxdistanceto.[$orderLocation_space, $orderLocation_pos]" />
			<set_value name="$dist_targetToWithdrawDest" exact="$target.bboxdistanceto.[$orderLocation_space, $orderLocation_pos]" />

			<label name="move_locked_destination" />
			<remove_value name="$isJustFight" />
			<remove_value name="$isCancelWithdrawal" />
			<remove_value name="$isRequestHelp" />
			<!-- <remove_value name="$isRedoVector" /> -->
			<debug_text text="@this.assignedcontrolled.idcode + ' move_to start'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
			<move_to object="this.assignedcontrolled"
				destination="$orderLocation_space"
				uselocalhighways="false"
				useknownpath="this.isplayerowned"
				forcesteering="this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m]"
				commandaction="false">
				<position value="$orderLocation_pos"/>
				<interrupt_after_time time="1s" />
			</move_to>
			<debug_text text="@this.assignedcontrolled.idcode + ' move_to end'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
			<debug_text text="@this.assignedcontrolled.idcode + ' wait start'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
			<set_value name="$wait" exact="[(100 - this.assignedcontrolled.shieldpercentage) * 1s, 5s].min" />
			<debug_text text="@this.assignedcontrolled.idcode + ' $wait: ' + $wait" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
			<wait exact="$wait">
				<interrupt>
					<conditions>
						<check_any>
							<event_object_attacked object="this.assignedcontrolled" />
							<event_object_attacked object="$target" />
							<event_object_changed_zone object="this.assignedcontrolled" />
							<event_object_changed_zone object="$target" />
							<check_all>
								<check_any>
									<event_object_signalled object="this.assignedcontrolled" param="'kAAIT_help'" />
									<event_object_signalled object="this.assignedcontrolled.commander" param="'kAAIT_help'" check="false" />
								</check_any>
								<check_value value="event.param2 != this.assignedcontrolled" />
								<check_value value="this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl]" />
							</check_all>
						</check_any>
						<set_value name="$distToTarget" exact="this.assignedcontrolled.bboxdistanceto.{$target}" />
						<check_value value="this.assignedcontrolled.primarypurpose == purpose.fight" />
						<check_value value="this.assignedcontrolled.weapons.all.count" />
						<check_value value="this.assignedcontrolled.engines.all.count" />
						<check_value value="this.assignedcontrolled.weapons.operational.count / (this.assignedcontrolled.weapons.all.count)f gt 0.25" />
						<check_value value="this.assignedcontrolled.engines.operational.count / (this.assignedcontrolled.engines.all.count)f gt 0.25" />
						<!-- <debug_text text="@this.assignedcontrolled.idcode + ' event.name: ' + event.name" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' and $kAAIT_detailedDebugChance then @global.$kAAIT_Data.$debugChance else 0" /> -->
						<set_value name="$dist_toWithdrawDest_current" exact="this.assignedcontrolled.bboxdistanceto.[$orderLocation_space, $orderLocation_pos]" />
						<set_value name="$dist_targetToWithdrawDest_current" exact="$target.bboxdistanceto.[$orderLocation_space, $orderLocation_pos]" />
						<check_all>
							<check_value value="$target.isclass.ship" />
							<check_value value="this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl]" />
							<check_any>
								<!-- <check_all>
									<check_value value="$target.shieldpercentage le 0" comment="target has low shields, just fight it" />
									<set_value name="$isCancelWithdrawal" exact="true" />
									<set_value name="$isRequestHelp" exact="true" comment="request for help also - cancel all withdrawals of other ships" />
								</check_all> -->
								<!-- check for other entries of this text: ship will withdraw and fight at these conditions. so cancel withdrawal when required.
									fight: shield gt skill-withdraw-value.
									withdraw: shield gt 5, shield le skill-withdraw-value, distance to target < 10km.
									fight: shield le 5, hull le 50.
								-->
								<check_all comment="good shields">
									<check_value value="this.assignedcontrolled.shieldpercentage gt global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_shieldPercentage_withdrawAt_vShip" />
									<set_value name="$isJustFight" exact="'good shields (gt skill-withdraw)'" />
								</check_all>
								<check_all comment="too far from target">
									<check_value value="$target.isclass.ship" />
									<check_value value="this.assignedcontrolled.bboxdistanceto.{$target} gt this.assignedcontrolled.maxradarrange * 0.25" />
									<set_value name="$isCancelWithdrawal" exact="'too far from target'" />
								</check_all>
								<!-- <check_all comment="ship has no shield, but good hull">
									<check_value value="$target.isclass.ship" />
									<check_value value="this.assignedcontrolled.shieldpercentage le 5" comment="still have low shields. 5 = margin of error to 0 shields" />
									<check_value value="this.assignedcontrolled.hullpercentage gt 50" />
									<set_value name="$isCancelWithdrawal" exact="'poor shield (le 5), good hull (gt 75)'" />
								</check_all> -->
								<check_all comment="ship has low chance of surviving">
									<check_value value="this.assignedcontrolled.shieldpercentage le 5" comment="still have low shields. 5 = margin of error to 0 shields" />
									<check_value value="this.assignedcontrolled.hullpercentage le 50" />
									<set_value name="$isJustFight" exact="'poor shield (le 5), poor hull (le 25)'" />
									<set_value name="$isRequestHelp" exact="true" />
								</check_all>
								<check_all comment="help requested">
									<check_value value="$target.isclass.ship" />
									<check_value value="this.assignedcontrolled.bboxdistanceto.{$target} gt 10km" />
									<check_value value="event.name == 'event_object_signalled'" comment="help signal received" />
									<set_value name="$isCancelWithdrawal" exact="'help request acknowledged'" />
								</check_all>
								<check_all comment="too far from ally">
									<check_value value="$target.isclass.ship" />
									<check_value value="@$ally.isoperational" />
									<check_value value="this.assignedcontrolled.bboxdistanceto.{$ally} gt this.assignedcontrolled.maxradarrange * 0.25" />
									<set_value name="$isCancelWithdrawal" exact="'too far from ally'" />
								</check_all>
								<!-- <check_all comment="has gotten away from target">
									<check_value value="$target.isclass.ship" />
									<check_value value="this.assignedcontrolled.bboxdistanceto.{$target} gt this.assignedcontrolled.maxradarrange * 0.25" />
									<set_value name="$isCancelWithdrawal" exact="'has escaped pursuer'" />
								</check_all> -->
							</check_any>
						</check_all>
					</conditions>
					<actions>
						<debug_text text="@this.assignedcontrolled.idcode + ' event.name: ' + event.name + ' event.param: ' + @event.parm + ' event.param2: ' + @event.param2.knownname + ' ' + @event.param2.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
						<do_if value="@$isRequestHelp">
							<include_interrupt_actions ref="kAAIT_RequestHelp" />
							<debug_text text="@this.assignedcontrolled.idcode + ' $isRequestHelp: ' + $isRequestHelp" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
						</do_if>
						<do_if value="@$isJustFight">
							<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isIgnoreKAAIT" exact="$isJustFight" />
							<debug_text text="@this.assignedcontrolled.idcode + ' $isJustFight: ' + $isJustFight" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
						</do_if>
						<do_elseif value="@$isCancelWithdrawal">
							<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isIgnoreKAAIT" />
							<debug_text text="@this.assignedcontrolled.idcode + ' $isCancelWithdrawal: ' + $isCancelWithdrawal" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
						</do_elseif>
					</actions>
				</interrupt>
			</wait>
			<debug_text text="@this.assignedcontrolled.idcode + ' wait end'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
			<!-- <debug_text text="@this.assignedcontrolled.idcode + ' $isRedoVector: ' + $isRedoVector" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" /> -->
			<do_if value="
				(not @$isJustFight) and
				(not @$isCancelWithdrawal) and
				(
					(
						(not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_shieldPercentage_withdrawAt_vShip) and
						(not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_shieldPercentage_withdrawAt_vStation) and
						this.assignedcontrolled.bboxdistanceto.[$orderLocation_space, $orderLocation_pos] gt 5km
					) or
					(
						$target.isclass.ship and
						this.assignedcontrolled.shieldpercentage le global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_shieldPercentage_withdrawAt_vShip
					) or
					(
						$target.isclass.station and
						this.assignedcontrolled.shieldpercentage le global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_shieldPercentage_withdrawAt_vStation
					)
				)">
				<do_if value="$target.bboxdistanceto.[$orderLocation_space, $orderLocation_pos] gt 10km">
					<resume label="move_locked_destination" />
				</do_if>
				<do_else>
					<resume label="move" />
				</do_else>
			</do_if>
			<do_elseif value="@$kAAIT_isInterrupted and this.assignedcontrolled.bboxdistanceto.[$orderLocation_space, $orderLocation_pos] gt 1km">
				<remove_value name="$kAAIT_isInterrupted" />
				<do_if value="$target.bboxdistanceto.[$orderLocation_space, $orderLocation_pos] gt 10km">
					<resume label="move_locked_destination" />
				</do_if>
				<do_else>
					<resume label="move" />
				</do_else>
			</do_elseif>
			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget_stoppedKamikaze" />
			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$moduleTarget" />

			<label name="fight" comment="required for DisengageHandler. $disengage_pursue resumes at fight label. in this case, just finish." />
			<debug_text text="@this.assignedcontrolled.idcode + ' LABEL fight'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />

			<label name="finish" />
			<!-- <do_if value="this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl]" comment="limit withdrawing ships to 2 per commander">
				<do_if value="@this.assignedcontrolled.commander.isclass.ship">
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.commander.idcode}.$kAAIT_data.$counter_withdrawing" operation="subtract" exact="1" />
				</do_if>
				<do_elseif value="@this.assignedcontrolled.subordinates.count">
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$counter_withdrawing" operation="subtract" exact="1" />
				</do_elseif>
			</do_if> -->
			<debug_text text="@this.assignedcontrolled.idcode + ' LABEL finish'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
			<stop_moving object="this.assignedcontrolled" />
			<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isWithdrawing" exact="false" />
			<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_data.$isWithdrawing: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isWithdrawing" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_space" />
			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_pos" />
			<include_interrupt_actions ref="kAAIT_Deinit" />
		</actions>
	</attention>
	<on_abort>
		<!-- <do_if value="this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl]" comment="limit withdrawing ships to 2 per commander">
			<do_if value="@this.assignedcontrolled.commander.isclass.ship">
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.commander.idcode}.$kAAIT_data.$counter_withdrawing" operation="subtract" exact="1" />
			</do_if>
			<do_elseif value="@this.assignedcontrolled.subordinates.count">
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$counter_withdrawing" operation="subtract" exact="1" />
			</do_elseif>
		</do_if> -->
		<do_if value="@this.assignedcontrolled.isoperational">
			<stop_moving object="this.assignedcontrolled" />
		</do_if>
		<do_if value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data">
			<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isWithdrawing" exact="false" />
			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_space" />
			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_pos" />
		</do_if>
		<include_interrupt_actions ref="kAAIT_Deinit" />
	</on_abort>
</aiscript>
