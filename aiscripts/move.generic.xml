<?xml version="1.0" encoding="utf-8" ?>
<diff>
<!-- replace and add. purpose: recall subordinates only if gatedistance is 2 or more. or in the case of non-fighters 1 or more.
	<param name="recallsubordinates" default="true" type="internal" comment="recall subordinates and cancel the recall of subordinates. disabled in the move.generic call from move.gate"/>
-->
	<replace sel="//params/param[@name=&quot;recallsubordinates&quot;]">
		<param name="recallsubordinates" default="
			if this.assignedcontrolled.primarypurpose == purpose.mine then true
			else (
				if this.assignedcontrolled.primarypurpose != purpose.fight then
					if this.assignedcontrolled.jobmainsector and this.assignedcontrolled.gatedistance.{this.assignedcontrolled.jobmainsector} ge 1 then true
					else (
						if @$destination.count then
							if this.assignedcontrolled.gatedistance.{$destination.{1}} ge 1 then true
							else false
						else (
							if this.assignedcontrolled.gatedistance.{$destination} ge 1 then true
							else false
						)
					)
				else (
					if this.assignedcontrolled.jobmainsector and this.assignedcontrolled.gatedistance.{this.assignedcontrolled.jobmainsector} ge 2 then true
					else (
						if @$destination.count then
							if this.assignedcontrolled.gatedistance.{$destination.{1}} ge 2 then true
							else false
						else (
							if this.assignedcontrolled.gatedistance.{$destination} ge 2 then true
							else false
						)
					)
				)
			)
		" type="internal" />
	</replace>
<!-- add. purpose: params.
	<params>
-->
	<add sel="//params">
		<param name="kAAITParam_iskAAITOrder" required="false" default="false" type="internal" />
		<param name="kAAITParam_tacticalOrderTarget" required="false" default="null" type="internal" />
		<param name="kAAITParam_isAvoidHighRisk" required="false" type="bool" text="{1111920, 3}" default="
			if (not this.assignedcontrolled.isunit) and (not this.assignedcontrolled.islasertower) and
			(
				(
					this.assignedcontrolled.isplayerowned and
					(this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m] or this.assignedcontrolled.primarypurpose != purpose.fight) and
					@global.$kAAIT_Config.$xssm_isAvoidHighRisk and
					(
						(not global.$kAAIT_Config.$settingsByShipId.{'$' + this.assignedcontrolled.idcode}.$kAAIT_isAvoidHighRisk_user?) or
						@global.$kAAIT_Config.$settingsByShipId.{'$' + this.assignedcontrolled.idcode}.$kAAIT_isAvoidHighRisk_user
					)
				) or
				(
					(not this.assignedcontrolled.isplayerowned) and
					(this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m] or this.assignedcontrolled.primarypurpose != purpose.fight) and
					@global.$kAAIT_Config.$xssm_isAvoidHighRisk_allFactions
				) or
				(
					this.assignedcontrolled.isplayerowned and
					this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
					(@global.$kAAIT_Config.$lxl_isAvoidHighRisk_vShip or @global.$kAAIT_Config.$lxl_isAvoidHighRisk_vStation) and
					(
						(not global.$kAAIT_Config.$settingsByShipId.{'$' + this.assignedcontrolled.idcode}.$kAAIT_isAvoidHighRisk_user?) or
						@global.$kAAIT_Config.$settingsByShipId.{'$' + this.assignedcontrolled.idcode}.$kAAIT_isAvoidHighRisk_user
					)
				) or
				(
					(not this.assignedcontrolled.isplayerowned) and
					this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
					(@global.$kAAIT_Config.$lxl_isAvoidHighRisk_vShip_allFactions or @global.$kAAIT_Config.$lxl_isAvoidHighRisk_vStation_allFactions)
				)
			) then true else false
		" />
	</add>
<!-- add before. purpose: show movement.
	<location object="$destination" position="$position" condition="$destination and $position"/>
-->
	<add pos="before" sel="//location[@object=&quot;$destination&quot;][@position=&quot;$position&quot;][@condition=&quot;$destination and $position&quot;]">
		<location object="@this.$kAAIT_data.$orderLocation_space" position="@this.$kAAIT_data.$orderLocation_pos" condition="@this.$kAAIT_data.$orderLocation_space and @this.$kAAIT_data.$orderLocation_pos" />
	</add>
<!-- add before at 5 instances. purpose: debug.
	<move_to>
-->
	<add pos="before" sel="(//move_to)[1]">
		<debug_text text="this.assignedcontrolled.idcode + ' move_to (move away from exit gate) $kAAITParam_iskAAITOrder: ' + @$kAAITParam_iskAAITOrder + ' $kAAITParam_isAvoidHighRisk:' + @$kAAITParam_isAvoidHighRisk" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>
	</add>
	<add pos="before" sel="(//move_to)[2]">
		<debug_text text="this.assignedcontrolled.idcode + ' move_to (move to destination and position) $kAAITParam_iskAAITOrder: ' + @$kAAITParam_iskAAITOrder + ' $kAAITParam_isAvoidHighRisk:' + @$kAAITParam_isAvoidHighRisk" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>
	</add>
	<add pos="before" sel="(//move_to)[3]">
		<debug_text text="this.assignedcontrolled.idcode + ' move_to (move to destination) $kAAITParam_iskAAITOrder: ' + @$kAAITParam_iskAAITOrder + ' $kAAITParam_isAvoidHighRisk:' + @$kAAITParam_isAvoidHighRisk" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>
	</add>
	<add pos="before" sel="(//move_to)[4]">
		<debug_text text="this.assignedcontrolled.idcode + ' move_to (small move to final with rotation) $kAAITParam_iskAAITOrder: ' + @$kAAITParam_iskAAITOrder + ' $kAAITParam_isAvoidHighRisk:' + @$kAAITParam_isAvoidHighRisk" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>
	</add>
	<add pos="before" sel="(//move_to)[5]">
		<debug_text text="this.assignedcontrolled.idcode + ' move_to (small move to final) $kAAITParam_iskAAITOrder: ' + @$kAAITParam_iskAAITOrder + ' $kAAITParam_isAvoidHighRisk:' + @$kAAITParam_isAvoidHighRisk" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>
	</add>
<!--
	add after. purpose: debug.
	<label name="start"/>
	<label name="check" />
	<label name="move" />
	<label name="finish"/>
	<label name="cleanup"/>
-->
	<add pos="after" sel="//label[@name=&quot;start&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' LABEL start $kAAITParam_iskAAITOrder: ' + @$kAAITParam_iskAAITOrder + ' $kAAITParam_isAvoidHighRisk:' + @$kAAITParam_isAvoidHighRisk" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>
	</add>
	<add pos="after" sel="//label[@name=&quot;check&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' LABEL check $kAAITParam_iskAAITOrder: ' + @$kAAITParam_iskAAITOrder + ' $kAAITParam_isAvoidHighRisk:' + @$kAAITParam_isAvoidHighRisk" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>
	</add>
	<add pos="after" sel="//label[@name=&quot;move&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' LABEL move $kAAITParam_iskAAITOrder: ' + @$kAAITParam_iskAAITOrder + ' $kAAITParam_isAvoidHighRisk:' + @$kAAITParam_isAvoidHighRisk" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>
	</add>
	<add pos="after" sel="//label[@name=&quot;cleanup&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' LABEL cleanup $kAAITParam_iskAAITOrder: ' + @$kAAITParam_iskAAITOrder + ' $kAAITParam_isAvoidHighRisk:' + @$kAAITParam_isAvoidHighRisk" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0"/>
	</add>
<!-- add. purpose: withdraw handler.
	<interrupts>
-->
	<add pos="prepend" sel="//interrupts">
		<handler ref="kAAIT_Handler_AvoidWithdrawOrJustFight" />
		<handler ref="kAAIT_Handler_TacticalSubordinateAttack" />
	</add>
<!-- add.
	<init>
-->
	<add sel="//init">
		<debug_text text="this.assignedcontrolled.idcode + ' LABEL init'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<do_if value="@$kAAITParam_tacticalOrderTarget.isoperational">
			<create_position name="$kAAIT_pos_tacticatTarget" space="$kAAITParam_tacticalOrderTarget.zone" value="$kAAITParam_tacticalOrderTarget.position" />
		</do_if>
	</add>
<!-- add after. purpose: check start avoid. i.e. gravidar events not soon enough if already near a big enemy -->
	<add pos="after" sel="//label[@name=&quot;start&quot;]">
		<do_if value="@$kAAITParam_isAvoidHighRisk and (not @this.$kAAIT_data.$isIgnoreKAAIT)">
			<include_interrupt_actions ref="kAAIT_AvoidOrNot" />
			<do_if value="@$kAAIT_result_avoidEnemy.isoperational">
				<do_if value="not this.$kAAIT_data?">
					<set_value name="this.kAAIT_data" exact="table[]" />
				</do_if>
				<set_value name="this.$kAAIT_data.$target_avoid" exact="$kAAIT_result_avoidEnemy" />
				<include_interrupt_actions ref="kAAIT_Order_Avoid" />
			</do_if>
		</do_if>
	</add>
<!-- add after. purpose: cleanup.
	<label name="cleanup" />
-->
	<add pos="after" sel="//label[@name=&quot;cleanup&quot;]">
		<include_interrupt_actions ref="kAAIT_Deinit" />
	</add>
<!-- add. purpose: clean-up.
	<on_abort>
-->
	<add sel="//on_abort">
		<include_interrupt_actions ref="kAAIT_Deinit" />
	</add>
	<!-- DeadAir Diffs -->
	<replace sel="/aiscript/attention/actions/do_if[@value='this.sector != $targetsector or (this.zone != $targetzone and (not @$endzone or this.zone != $endzone) and ($endintargetzone or @$targetzone.isclass.highway or this.ship.bboxdistanceto.[$positionspace, $position, $destination] gt 10km))']/do_if[@value='$recallsubordinates and this.assignedcontrolled.subordinates.count and (@this.assignedcontrolled.order.state != orderstate.critical) and not this.$recalling_subordinates?']/do_for_each[@name='$locsub']/do_if[@value='$locsub.isoperational and this.assignedcontrolled.dockingallowed.{$locsub} and (not $locsub.dock or not $locsub.hascontext.{this.assignedcontrolled})']/@value">$locsub.isoperational and this.assignedcontrolled.dockingallowed.{$locsub} and (not $locsub.dock or not $locsub.hascontext.{this.assignedcontrolled}) and (not ((@$locsub.assignment == assignment.assist) or (@$locsub.defaultorder.id == 'Assist')))</replace>
	<replace sel="/aiscript/attention/actions/do_if[@value='this.sector != $targetsector or (this.zone != $targetzone and (not @$endzone or this.zone != $endzone) and ($endintargetzone or @$targetzone.isclass.highway or this.ship.bboxdistanceto.[$positionspace, $position, $destination] gt 10km))']/do_for_each[@name='$locship']/do_if[@value='$locship.isoperational and (not $locship.dock or not $locship.hascontext.{this.assignedcontrolled})']/@value">$locship.isoperational and (not $locship.dock or not $locship.hascontext.{this.assignedcontrolled}) and (not ((@$locship.assignment == assignment.assist) or (@$locship.defaultorder.id == 'Assist')))</replace>
	<remove sel="/aiscript/attention/actions/do_if[@value='this.sector != $targetsector or (this.zone != $targetzone and (not @$endzone or this.zone != $endzone) and ($endintargetzone or @$targetzone.isclass.highway or this.ship.bboxdistanceto.[$positionspace, $position, $destination] gt 10km))']/do_if[@value='$intersector? and not @this.zone.isclass.highway and (@$waitforsubordinates or $waitforatgate or this.assignedcontrolled.iscapitalship)']/do_if[@value='not $waitforsubordinates? and not $waitforatgate.isoperational and not this.zone.isclass.highway']"/>
	<remove sel="/aiscript/attention/actions/do_if[@value='this.sector != $targetsector or (this.zone != $targetzone and (not @$endzone or this.zone != $endzone) and ($endintargetzone or @$targetzone.isclass.highway or this.ship.bboxdistanceto.[$positionspace, $position, $destination] gt 10km))']/do_else/wait/@max"/>
	<add sel="/aiscript/attention/actions/do_if[@value='this.sector != $targetsector or (this.zone != $targetzone and (not @$endzone or this.zone != $endzone) and ($endintargetzone or @$targetzone.isclass.highway or this.ship.bboxdistanceto.[$positionspace, $position, $destination] gt 10km))']/do_else/wait" type="@exact">[(0.2 * (15 - [this.ship.pilot.skill.piloting,9].max))s,0.1s].max</add>
	<add sel="/aiscript/attention/actions/do_if[@value='this.sector != $targetsector or (this.zone != $targetzone and (not @$endzone or this.zone != $endzone) and ($endintargetzone or @$targetzone.isclass.highway or this.ship.bboxdistanceto.[$positionspace, $position, $destination] gt 10km))']/do_else/do_if[@value='$position']/move_to" pos="before">
		<do_if value="this.assignedcontrolled.dock and this.assignedcontrolled.pilot">
			<do_if value="@this.assignedcontrolled.order.id != 'Undock' or @this.assignedcontrolled.order.id != 'DockAt' or @this.assignedcontrolled.order.id != 'DockAndWait'">
				<run_script name="'move.undock'">
					<param name="uselaunchtubes" value="true"/>
				</run_script>
				<debug_text text="'MOD: DeadAirAITweaks -- %1 -- Undocking ship with move order: %2'.[player.age,this.assignedcontrolled.idcode]" context="false" filter="error" chance="100"/>
			</do_if>
		</do_if>
	</add>
	<replace sel="/aiscript/attention/actions/do_if[@value='this.sector != $targetsector or (this.zone != $targetzone and (not @$endzone or this.zone != $endzone) and ($endintargetzone or @$targetzone.isclass.highway or this.ship.bboxdistanceto.[$positionspace, $position, $destination] gt 10km))']/do_else/do_if[@value='$position']/move_to/@travel">(not $noboost) and (this.assignedcontrolled.distanceto.[$positionspace, $position] gt 15km)</replace>
	<add sel="/aiscript/attention/actions/do_if[@value='this.sector != $targetsector or (this.zone != $targetzone and (not @$endzone or this.zone != $endzone) and ($endintargetzone or @$targetzone.isclass.highway or this.ship.bboxdistanceto.[$positionspace, $position, $destination] gt 10km))']/do_else/do_else/move_to" pos="before">
		<do_if value="this.assignedcontrolled.dock and this.assignedcontrolled.pilot">
			<do_if value="@this.assignedcontrolled.order.id != 'Undock' or @this.assignedcontrolled.order.id != 'DockAt' or @this.assignedcontrolled.order.id != 'DockAndWait'">
				<run_script name="'move.undock'">
					<param name="uselaunchtubes" value="true"/>
				</run_script>
				<debug_text text="'MOD: DeadAirAITweaks -- %1 -- Undocking ship with move order: %2'.[player.age,this.assignedcontrolled.idcode]" context="false" filter="error" chance="100"/>
			</do_if>
		</do_if>
	</add>
	<add sel="/aiscript/attention/actions/do_if[@value='not @$rotation']" pos="before">
		<do_if value="this.assignedcontrolled.dock and this.assignedcontrolled.pilot">
			<do_if value="@this.assignedcontrolled.order.id != 'Undock' or @this.assignedcontrolled.order.id != 'DockAt' or @this.assignedcontrolled.order.id != 'DockAndWait'">
				<run_script name="'move.undock'">
					<param name="uselaunchtubes" value="true"/>
				</run_script>
				<debug_text text="'MOD: DeadAirAITweaks -- %1 -- Undocking ship with move order: %2'.[player.age,this.assignedcontrolled.idcode]" context="false" filter="error" chance="100"/>
			</do_if>
		</do_if>
	</add>
	<add sel="/aiscript/attention/actions/do_if[@value='not @$rotation']/do_if[@value='this.ship.distanceto.[$positionspace, $safepos] gt this.ship.size']/move_to" type="@travel">(not $noboost) and (this.assignedcontrolled.distanceto.[$positionspace, $safepos] gt 15km)</add>
	<add sel="/aiscript/attention/actions/do_else[4]/move_to" type="@travel">(not $noboost) and (this.assignedcontrolled.distanceto.[$positionspace, $safepos] gt 15km)</add>
</diff>
