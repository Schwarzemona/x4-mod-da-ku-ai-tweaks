<?xml version="1.0" encoding="utf-8"?>
<aiscript name="kuertee_aait_interrupts" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="aiscripts.xsd">
	<interrupts>
		<library>
			<actions name="kAAIT_Init">
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Init'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<do_if value="@this.$beacon_from or @this.$kAAIT_target or @this.$kAAIT_orders">
					<include_interrupt_actions ref="kAAIT_CleanUpOldVersionData" />
				</do_if>
				<do_if value="not @this.$kAAIT_data">
					<debug_text text="this.assignedcontrolled.idcode + ' NEW ATTACK ORDER'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<set_value name="this.$kAAIT_data" exact="table[]" />
					<debug_text text="this.assignedcontrolled.idcode + ' this.$kAAIT_data: ' + @this.$kAAIT_data" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				</do_if>
				<do_else>
					<debug_text text="this.assignedcontrolled.idcode + ' CONTINUED ATTACK ORDER'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<debug_text text="this.assignedcontrolled.idcode + ' this.$kAAIT_data: ' + @this.$kAAIT_data" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				</do_else>
				<do_if value="
					this.assignedcontrolled.order.id == 'Attack' or
					(not @this.$kAAIT_data.$defensibleTarget)
				">
					<set_value name="this.$kAAIT_data.$defensibleTarget" exact="@$primarytarget" />
					<do_if value="not @this.$kAAIT_data.$defensibleTarget.exists">
						<set_value name="this.$kAAIT_data.$defensibleTarget" exact="@$target" />
					</do_if>
					<do_if value="@this.$kAAIT_data.$defensibleTarget.defensible.exists">
						<set_value name="this.$kAAIT_data.$defensibleTarget" exact="this.$kAAIT_data.$defensibleTarget.defensible" />
					</do_if>
					<do_if value="@this.$kAAIT_data.$defensibleTarget.assignedaipilot.isoperational">
						<set_value name="this.$kAAIT_data.$defensibleTargetEntity" exact="this.$kAAIT_data.$defensibleTarget.assignedaipilot" />
					</do_if>
					<do_elseif value="@this.$kAAIT_data.$defensibleTarget.defencenpc.isoperational">
						<set_value name="this.$kAAIT_data.$defensibleTargetEntity" exact="this.$kAAIT_data.$defensibleTarget.defencenpc" />
					</do_elseif>
				</do_if>
				<include_interrupt_actions ref="kAAIT_GetCombatRange" />
				<include_interrupt_actions ref="kAAIT_GetSkillVars" />
				<include_interrupt_actions ref="kAAIT_GetIsTargetHighRisk" />
				<!-- <include_interrupt_actions ref="kAAIT_GetIsJustFight" /> -->
				<debug_text text="this.assignedcontrolled.idcode + ' this.$kAAIT_data: ' + this.$kAAIT_data" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			</actions>

			<actions name="kAAIT_Deinit">
				<set_value name="$hasAttackOrder" exact="false" />
				<do_if value="@this.assignedcontrolled.orders.count">
					<do_for_each name="$kAAIT_order" in="this.assignedcontrolled.orders">
						<do_if value="$kAAIT_order.id == 'Attack'">
							<set_value name="$hasAttackOrder" exact="true" />
						</do_if>
					</do_for_each>
				</do_if>
				<do_if value="(not $hasAttackOrder)">
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Deinit orders.{1}.id: ' + @this.assignedcontrolled.order.id" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<include_interrupt_actions ref="kAAIT_RemoveAttackerFromTarget" />
					<remove_value name="this.$kAAIT_data" />
					<debug_text text="@this.assignedcontrolled.idcode + ' this.$kAAIT_data: ' + @this.$kAAIT_data" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				</do_if>
			</actions>

			<actions name="kAAIT_CleanUpOldVersionData">
				<!-- start: clean-up obsolete data from previous version -->
				<!-- current version: most of these vars in this.$kAAIT_data -->
				<do_if value="@this.$beacon_from.exists"><destroy_object object="this.$beacon_from" /></do_if>
				<do_if value="@this.$beacon_to.exists"><destroy_object object="this.$beacon_to" /></do_if>
				<do_if value="@this.$beacon_avoid1.exists"><destroy_object object="this.$beacon_avoid1" /></do_if>
				<do_if value="@this.$beacon_avoid2.exists"><destroy_object object="this.$beacon_avoid2" /></do_if>
				<remove_value name="this.$beacon_from" />
				<remove_value name="this.$beacon_to" />
				<remove_value name="this.$beacon_avoid1" />
				<remove_value name="this.$beacon_avoid2" />
				<remove_value name="this.$kAAIT_data.$defensibleTarget_stopKamikaze" />
				<remove_value name="this.$kAAIT_target" />
				<remove_value name="this.$kAAIT_orders" />
				<remove_value name="this.$kAAIT_aroundDir" />
				<remove_value name="this.$kAAIT_lastAttack_enemy" />
				<remove_value name="this.$kAAIT_lastAttack_time" />
				<remove_value name="this.$kAAIT_lastAttack_timeLastSafe" />
				<remove_value name="this.$kAAIT_inchForwardCount" />
				<remove_value name="this.$kAAIT_movedOutOfRangeCount" />
				<remove_value name="this.$kAAIT_orderLocation_space" />
				<remove_value name="this.$kAAIT_orderLocation_pos" />
				<!-- end: clean-up obsolete data from previous version -->
			</actions>

			<actions name="kAAIT_AddAttackerToTarget">
				<do_if value="@this.$kAAIT_data.$defensibleTargetEntity.isoperational">
					<do_if value="not this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers?">
						<create_group groupname="this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers" />
					</do_if>
					<do_if value="not this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl?">
						<create_group groupname="this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl" />
					</do_if>
					<do_if value="player.age - @this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_timeAdded gt 60min">
						<clear_group group="this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers" />
						<clear_group group="this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl" />
					</do_if>
					<do_if value="this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl]">
						<add_to_group groupname="this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl" object="this.assignedcontrolled" />
					</do_if>
					<do_else>
						<add_to_group groupname="this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers" object="this.assignedcontrolled" />
					</do_else>
					<set_value name="this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_timeAdded" exact="player.age" />
					<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_attackers (add to ' + this.$kAAIT_data.$defensibleTarget + ' ' + this.$kAAIT_data.$defensibleTarget.knownname + '): ' + this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers.count" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				</do_if>
			</actions>

			<actions name="kAAIT_RemoveAttackerFromTarget">
				<do_if value="@this.$kAAIT_data.$defensibleTargetEntity.isoperational">
					<do_if value="this.assignedcontrolled">
						<do_if value="not this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers?">
							<create_group groupname="this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers" />
						</do_if>
						<do_if value="not this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl?">
							<create_group groupname="this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl" />
						</do_if>
						<remove_from_group group="this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers" object="this.assignedcontrolled" />
						<remove_from_group group="this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl" object="this.assignedcontrolled" />
						<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_attackers (remove from ' + this.$kAAIT_data.$defensibleTarget + ' ' + this.$kAAIT_data.$defensibleTarget.knownname + '): ' + this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers.count" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					</do_if>
					<do_if value="not @this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers.count">
						<remove_value name="this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers" />
					</do_if>
					<do_if value="not @this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl.count">
						<remove_value name="this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl" />
					</do_if>
				</do_if>
			</actions>

			<!--
				88  88    db    88b 88 8888b.  88     888888 88""Yb .dP"Y8
				88  88   dPYb   88Yb88  8I  Yb 88     88__   88__dP `Ybo."
				888888  dP__Yb  88 Y88  8I  dY 88  .o 88""   88"Yb  o.`Y8b
				88  88 dP""""Yb 88  Y8 8888Y"  88ood8 888888 88  Yb 8bodP'
			 -->
			<handler name="kAAIT_Handler_WithdrawOrJustFight">
				<conditions>
					<event_object_attacked object="this.assignedcontrolled" />
					<check_all>
						<check_value value="not this.assignedcontrolled.isunit" />
						<check_value value="this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl]" />
						<check_any>
							<check_value value="@$kAAITParam_isAvoidHighRisk" />
							<check_value value="@$kAAITParam_isStepForwardWithdraw" />
							<check_all>
								<check_value value="this.assignedcontrolled.isplayerowned" />
								<check_any>
									<check_value value="event.param.isclass.ship" />
									<check_value value="@event.param.defensible.isclass.ship" />
								</check_any>
								<check_any>
									<check_value value="@global.$kAAIT_Config.$lxl_isStepForward_vShip" />
									<check_value value="@global.$kAAIT_Config.$lxl_isMoveOutOfRange_vShip" />
								</check_any>
							</check_all>
							<check_all>
								<check_value value="this.assignedcontrolled.isplayerowned" />
								<check_any>
									<check_value value="event.param.isclass.station" />
									<check_value value="@event.param.defensible.isclass.station" />
								</check_any>
								<check_any>
									<check_value value="@global.$kAAIT_Config.$lxl_isStepForward_vStation" />
									<check_value value="@global.$kAAIT_Config.$lxl_isMoveOutOfRange_vStation" />
								</check_any>
							</check_all>
							<check_all>
								<check_value value="not this.assignedcontrolled.isplayerowned" />
								<check_any>
									<check_value value="event.param.isclass.ship" />
									<check_value value="@event.param.defensible.isclass.ship" />
								</check_any>
								<check_any>
									<check_value value="@global.$kAAIT_Config.$lxl_isStepForward_vShip_allFactions" />
									<check_value value="@global.$kAAIT_Config.$lxl_isMoveOutOfRange_vShip_allFactions" />
								</check_any>
							</check_all>
							<check_all>
								<check_value value="not this.assignedcontrolled.isplayerowned" />
								<check_any>
									<check_value value="event.param.isclass.station" />
									<check_value value="@event.param.defensible.isclass.station" />
								</check_any>
								<check_any>
									<check_value value="@global.$kAAIT_Config.$lxl_isStepForward_vStation_allFactions" />
									<check_value value="@global.$kAAIT_Config.$lxl_isMoveOutOfRange_vStation_allFactions" />
								</check_any>
							</check_all>
						</check_any>
						<check_any>
							<check_all comment="attacker is target">
								<check_value value="event.param == @this.$kAAIT_data.$defensibleTarget" />
								<check_value value="@this.$kAAIT_data.$isTargetPotentialHighRisk" />
								<check_any>
									<check_value value="(not this.assignedcontrolled.weapons.operational.count)" comment="withdraw if no operational weapons" />
									<check_all comment="target is ship AND (either target is near destruction or self has low survivability) AND there are other attackers">
										<check_value value="@this.$kAAIT_data.$defensibleTarget.isclass.ship" />
										<check_all>
											<check_value value="@this.$kAAIT_data.$defensibleTarget.shieldpercentage gt 25" comment="target is no where near destruction, so flee. otherwise do not flee, and just fight." />
											<check_value value="this.assignedcontrolled.hullpercentage gt 50" comment="high chance of survivaing, so flee. otherwise do not flee, and just fight." />
										</check_all>
										<check_any comment="there are other attackers">
											<check_all comment="this.assignedcontrolled is one of the attackers">
												<check_value value="@this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl.indexof.{this.assignedcontrolled}" />
												<check_value value="@this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl.count * this.$kAAIT_data.$skill_attackers_count_mult ge 2" />
											</check_all>
											<check_all comment="this.assignedcontrolled is NOT one of the attackers">
												<check_value value="not @this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl.indexof.{this.assignedcontrolled}" />
												<check_value value="@this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl.count * this.$kAAIT_data.$skill_attackers_count_mult ge 1" />
											</check_all>
										</check_any>
									</check_all>
									<check_value value="@this.$kAAIT_data.$defensibleTarget.isclass.station" />
								</check_any>
								<check_any>
									<check_value value="this.assignedcontrolled.weapons.operational.count / (this.assignedcontrolled.weapons.all.count)f le 0.25" comment="withdraw if 25% operational weapons" />
									<check_value value="this.assignedcontrolled.shieldpercentage le this.$kAAIT_data.$skill_shieldPercentage_withdrawAt" comment="withdraw if less than withdraw threshold" />
								</check_any>
								<set_value name="$kAAIT_isWithdrawFromTarget" exact="true" />
							</check_all>
							<check_all comment="attack new target">
								<check_value value="event.param != @this.$kAAIT_data.$defensibleTarget" />
								<check_value value="event.param.isclass.[class.ship_l, class.ship_xl]" />
								<check_value value="event.param.size gt @this.$kAAIT_data.$defensibleTarget.size" />
								<set_value name="$kAAIT_isNewBigTarget" exact="true" />
							</check_all>
						</check_any>
						<check_value value="not @this.$kAAIT_data.$isIgnoreKAAIT" />
						<check_value value="not @this.$kAAIT_data.$isWithdrawing" />
					</check_all>
				</conditions>
				<actions>
					<debug_text text="this.assignedcontrolled.idcode + ' event.name (kAAIT_Handler_WithdrawOrJustFight): ' + @event.name + ' event.param: ' + @event.param.knownname + ', ' + @event.param.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<debug_text text="this.assignedcontrolled.idcode + '             ================================='" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<do_if value="@$kAAIT_isWithdrawFromTarget">
						<do_if value="
							@this.assignedcontrolled.order.id == 'Attack' and
							(not @$DefensibleScript)
						" comment="assumes this is already in move.attack.object.capital.xml">
							<abort_called_scripts resume="kAAITLabel_withdraw" />
						</do_if>
						<do_elseif value="@this.assignedcontrolled.order.$kAAITParam_iskAAITOrder" comment="assumes this is in move.kuertee.*.xml">
							<abort_called_scripts resume="finish" />
						</do_elseif>
						<do_else comment="assumes in any other order with this handler">
							<do_if value="not this.$kAAIT_data">
								<set_value name="this.$kAAIT_data" exact="table[]" />
								<set_value name="this.$kAAIT_data.$defensibleTarget" exact="tableevent.param" />
							</do_if>
							<include_interrupt_actions ref="kAAIT_Order_Withdraw" />
						</do_else>
					</do_if>
					<do_elseif value="@$kAAIT_isNewBigTarget" comment="new target">
						<do_if value="
							@this.assignedcontrolled.commander.isclass.[class.ship_l, class.ship_xl] and
							this.assignedcontrolled.commander.sector == this.assignedcontrolled.sector
						">
							<set_value name="$kAAIT_Target" exact="event.param" />
							<signal_objects object="this.assignedcontrolled.commander" param="'kAAIT_new_big_target'" param2="$kAAIT_Target" />
						</do_if>
					</do_elseif>
				</actions>
			</handler>

			<handler name="kAAIT_Handler_TargetDestroyed">
				<conditions>
					<check_any>
						<event_object_destroyed object="$target" check="false" />
						<event_object_destroyed object="@this.$kAAIT_data.$defensibleTarget" check="false" />
					</check_any>
				</conditions>
				<actions>
					<abort_called_scripts resume="finish" />
				</actions>
			</handler>

			<handler name="kAAIT_Handler_NewBigTarget">
				<conditions>
					<check_any>
						<event_object_signalled object="this.assignedcontrolled" param="'kAAIT_new_big_target'" />
						<event_object_signalled object="this.assignedcontrolled.commander" param="'kAAIT_new_big_target'" check="false" />
					</check_any>
					<check_any>
						<check_value value="event.param2.isclass.[class.ship_l, class.ship_xl]" />
						<check_any>
							<check_value value="@event.param2.size gt @this.$kAAIT_data.$defensibleTarget.size" comment="new target is bigger than current target" />
							<check_value value="@this.$kAAIT_data.$defensibleTarget.isclass.station" comment="new LXL target is more dangerous than current station target" />
						</check_any>
					</check_any>
					<check_any>
						<check_value value="@this.assignedcontrolled.order.id != 'Attack'" comment="order is not an attack order" />
						<check_value value="@this.assignedcontrolled.order.$primarytarget != event.param2" comment="or has a different target" />
					</check_any>
					<check_any>
						<check_value value="@this.assignedcontrolled.orders.{2}.id != 'Attack'" comment="2nd order is not an attack order" />
						<check_value value="@this.assignedcontrolled.orders.{2}.$primarytarget != event.param2" comment="or has a different target" />
					</check_any>
					<check_value value="@this.assignedcontrolled.orders.{3}.id != 'Attack'" comment="too many attack orders if there's already a 3rd attack order" />
				</conditions>
				<actions>
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_NewBigTarget'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<debug_text text="this.assignedcontrolled.idcode + ' =========================='" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<debug_text text="this.assignedcontrolled.idcode + ' this.$kAAIT_data.$defensibleTarget.size: ' + @this.$kAAIT_data.$defensibleTarget.size" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<debug_text text="this.assignedcontrolled.idcode + ' this.$kAAIT_data.$defensibleTarget.class: ' + @this.$kAAIT_data.$defensibleTarget.class" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<debug_text text="this.assignedcontrolled.idcode + ' event.param2.size: ' + event.param2.size" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<debug_text text="this.assignedcontrolled.idcode + ' event.param2.class: ' + event.param2.class" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<set_value name="$kAAIT_Target" exact="event.param2" />
					<include_interrupt_actions ref="kAAIT_Order_AttackOther" />
				</actions>
			</handler>

			<!--
				88  88 888888 88     88""Yb 888888 88""Yb .dP"Y8
				88  88 88__   88     88__dP 88__   88__dP `Ybo."
				888888 88""   88  .o 88"""  88""   88"Yb  o.`Y8b
				88  88 888888 88ood8 88     888888 88  Yb 8bodP'
			 -->
			<actions name="kAAIT_GetCombatRange">
				<set_value name="this.$kAAIT_data.$combatRange_max" exact="[
					this.assignedcontrolled.maxcombatrange.primary,
					this.assignedcontrolled.maxcombatrange.secondary,
					this.assignedcontrolled.maxcombatrange.lasers.all,
					this.assignedcontrolled.maxcombatrange.missiles.all,
					this.assignedcontrolled.maxcombatrange.turrets,
				].max * 0.9" />
				<set_value name="this.$kAAIT_data.$combatRange_min" exact="[
					if this.assignedcontrolled.maxcombatrange.primary then this.assignedcontrolled.maxcombatrange.primary else 1000000,
					if this.assignedcontrolled.maxcombatrange.secondary then this.assignedcontrolled.maxcombatrange.secondary else 1000000,
					if this.assignedcontrolled.maxcombatrange.lasers.all then this.assignedcontrolled.maxcombatrange.lasers.all else 1000000,
					if this.assignedcontrolled.maxcombatrange.missiles.all then this.assignedcontrolled.maxcombatrange.missiles.all else 1000000,
					if this.assignedcontrolled.maxcombatrange.turrets then this.assignedcontrolled.maxcombatrange.turrets else 1000000,
				].min * 0.9" />
				<set_value name="this.$kAAIT_data.$combatRange_mid" exact="this.$kAAIT_data.$combatRange_min + (this.$kAAIT_data.$combatRange_max - this.$kAAIT_data.$combatRange_min) * 0.5" />
			</actions>

			<actions name="kAAIT_GetIsTargetHighRisk">
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetIsTargetHighRisk'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' this.$kAAIT_data.$defensibleTarget: ' + @this.$kAAIT_data.$defensibleTarget.isoperational + ' ' + @this.$kAAIT_data.$defensibleTarget.knownname + ' ' + @this.$kAAIT_data.$defensibleTarget.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<set_value name="this.$kAAIT_data.$isTargetHighRisk" exact="false" />
				<do_if value="@this.$kAAIT_data.$defensibleTarget.isoperational">
					<do_if value="this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m]">
						<set_value name="this.$kAAIT_data.$isTargetPotentialHighRisk" exact="this.$kAAIT_data.$defensibleTarget.size gt this.assignedcontrolled.size * 1.5" />
						<do_if value="this.$kAAIT_data.$defensibleTarget.isclass.ship">
							<set_value name="$kAAIT_gunCount" exact="@this.$kAAIT_data.$defensibleTarget.weapons.operational.count" />
						</do_if>
						<do_else>
							<set_value name="$kAAIT_gunCount" exact="
								@this.$kAAIT_data.$defensibleTarget.weapons.operational.count + 
								[@this.$kAAIT_data.$defensibleTarget.weapons.operational.count, @this.$kAAIT_data.$defensibleTarget.turrets.operational.count].max
							" />
						</do_else>
						<do_if value="not this.$kAAIT_data.$skill_attackers_count_mult?">
							<include_interrupt_actions ref="kAAIT_GetSkillVars" />
						</do_if>
						<set_value name="this.$kAAIT_data.$isTargetHighRisk" exact="
							this.$kAAIT_data.$isTargetPotentialHighRisk and
							(
								(
									this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s] and
									@this.$kAAIT_data.$defensibleTarget.isclass.ship and
									@this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers.count * this.$kAAIT_data.$skill_attackers_count_mult le $kAAIT_gunCount * global.$kAAIT_Config.$xss_outnumberVShips / 100.0
								)
								or
								(
									this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s] and
									@this.$kAAIT_data.$defensibleTarget.isclass.station and
									@this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers.count * this.$kAAIT_data.$skill_attackers_count_mult le $kAAIT_gunCount * global.$kAAIT_Config.$xss_outnumberVStations / 100.0
								)
								or
								(
									this.assignedcontrolled.isclass.ship_m and
									@this.$kAAIT_data.$defensibleTarget.isclass.ship and
									@this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers.count * this.$kAAIT_data.$skill_attackers_count_mult le $kAAIT_gunCount * global.$kAAIT_Config.$m_outnumberVShips / 100.0
								)
								or
								(
									this.assignedcontrolled.isclass.ship_m and
									@this.$kAAIT_data.$defensibleTarget.isclass.station and
									@this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers.count * this.$kAAIT_data.$skill_attackers_count_mult le $kAAIT_gunCount * global.$kAAIT_Config.$m_outnumberVStations / 100.0
								)
								or
								this.$kAAIT_data.$defensibleTarget.hullpercentage lt 1
							) and
							(
								(not this.assignedcontrolled.dps.missiles.all) or
								(not this.assignedcontrolled.ammostorage.missile.count)
							)
						"/>
					</do_if>
					<do_elseif value="this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl]">
						<set_value name="this.$kAAIT_data.$isTargetPotentialHighRisk" exact="
							this.$kAAIT_data.$defensibleTarget.isclass.station or
							this.$kAAIT_data.$defensibleTarget.size gt this.assignedcontrolled.size * 1.5 or
							(
								this.$kAAIT_data.$defensibleTarget.isclass.[class.ship_l, class.ship_xl] and
								this.$kAAIT_data.$defensibleTarget.dps.all gt this.assignedcontrolled.dps.all * 1.25
							)
						" />
						<set_value name="this.$kAAIT_data.$isTargetHighRisk" exact="this.$kAAIT_data.$isTargetPotentialHighRisk" />
					</do_elseif>
				</do_if>
				<debug_text text="this.assignedcontrolled.idcode + ' this.$kAAIT_data.$isTargetPotentialHighRisk: ' + this.$kAAIT_data.$isTargetPotentialHighRisk" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' this.$kAAIT_data.$isTargetHighRisk: ' + this.$kAAIT_data.$isTargetHighRisk" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			</actions>

			<actions name="kAAIT_GetIsMoveToEngage">
				<set_value name="$kAAIT_isMovetoEngage" exact="false" />
				<do_if value="
					this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
					(@this.$kAAIT_data.$isTargetHighRisk or @this.$kAAIT_data.$isTargetPotentialHighRisk) and
					(not @$primarytarget.travel.active) and
					(not @$target.travel.active)
				">
					<set_value name="$kAAIT_distToTarget" exact="this.assignedcontrolled.bboxdistanceto.{$target}" />
					<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_distToTarget: ' + $kAAIT_distToTarget" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<do_if value="
						this.$kAAIT_data.$defensibleTarget != @this.$kAAIT_data.$defensibleTarget_stoppedKamikaze and
						(
							(
								this.$kAAIT_data.$defensibleTarget.isclass.station and
								$kAAIT_distToTarget gt this.assignedcontrolled.maxradarrange * 0.5
							) or
							(
								this.$kAAIT_data.$defensibleTarget.isclass.ship and
								(not @this.$kAAIT_data.$defensibleTarget.isclass.ship.travel.active) and
								$kAAIT_distToTarget gt this.assignedcontrolled.maxradarrange
							)
						)
					">
						<set_value name="$kAAIT_isMovetoEngage" exact="true" />
						<set_value name="this.$kAAIT_data.$defensibleTarget_stoppedKamikaze" exact="this.$kAAIT_data.$defensibleTarget" />
						<debug_text text="this.assignedcontrolled.idcode + ' $defensibleTarget_stoppedKamikaze: ' + this.$kAAIT_data.$defensibleTarget_stoppedKamikaze" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
						<do_if value="
							@$primarytarget.isclass.module or
							@$target.isclass.module
						">
							<set_value name="this.$kAAIT_data.$moduleTarget" exact="if @$primarytarget.isclass.module then $primarytarget else $target" />
							<debug_text text="this.assignedcontrolled.idcode + ' FIRST $moduleTarget: ' + this.$kAAIT_data.$moduleTarget" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
						</do_if>
					</do_if>
				</do_if>
				<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_isMovetoEngage: ' + $kAAIT_isMovetoEngage" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			</actions>

			<actions name="kAAIT_GetBigEnemies">
				<do_if value="not @$kAAIT_bigEnemies.count or @$kAAIT_bigEnemies.{$kAAIT_bigEnemies.count}.bboxdistanceto.{this.assignedcontrolled} gt this.assignedcontrolled.maxradarrange">
					<set_value name="$kAAIT_bigEnemies" exact="[]" />
					<create_group groupname="$kAAIT_bigEnemies" />
					<find_gravidar_contact groupname="$kAAIT_bigEnemies" object="this.assignedcontrolled" class="[class.ship_l, class.ship_xl, class.station]" docked="false" functional="true" maybeattackedby="this.assignedcontrolled" multiple="true" chance="if @this.assignedcontrolled.sector.macro then 100 else 0">
						<match_context macro="this.assignedcontrolled.sector.macro"/>
						<match class="class.buildstorage" negate="true"/>
						<match state="componentstate.wreck" negate="true"/>
						<!-- <match_distance max="this.assignedcontrolled.maxradarrange * 0.5" object="this.assignedcontrolled" /> -->
					</find_gravidar_contact>
					<do_if value="@$kAAITParam_enemyAvoid">
						<add_to_group groupname="$kAAIT_bigEnemies" object="$kAAITParam_enemyAvoid" />
					</do_if>
					<sort_group group="$kAAIT_bigEnemies" sortbyvalue="this.assignedcontrolled.bboxdistanceto.{loop.element}" />
					<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_bigEnemies: ' + $kAAIT_bigEnemies" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				</do_if>
			</actions>

			<actions name="kAAIT_GetIsNearBigEnemies">
				<set_value name="$kAAIT_isShipNearBigEnemy" exact="false" />
				<set_value name="$kAAIT_isTargetNearBigEnemy" exact="false" />
				<set_value name="$kAAIT_bigEnemy" exact="null" />
				<do_if value="@$kAAIT_bigEnemies.count">
					<do_for_each name="$kAAIT_bigEnemy_inList" in="$kAAIT_bigEnemies">
						<do_if value="$kAAIT_bigEnemy_inList != @this.$kAAIT_data.$defensibleTarget">
							<do_if value="$kAAIT_bigEnemy_inList.bboxdistanceto.{this.assignedcontrolled} lt this.assignedcontrolled.maxradarrange * 0.5">
								<set_value name="$kAAIT_isShipNearBigEnemy" exact="true" />
							</do_if>
							<do_if value="$kAAIT_bigEnemy_inList != @this.$kAAIT_data.$defensibleTarget">
								<do_if value="
									(
										@this.$kAAIT_data.$defensibleTarget.isoperational and
										$kAAIT_bigEnemy_inList.bboxdistanceto.{this.$kAAIT_data.$defensibleTarget} lt this.assignedcontrolled.maxradarrange * 0.5
									) or
									(
										@$target.isoperational and
										$kAAIT_bigEnemy_inList.bboxdistanceto.{$target} lt this.assignedcontrolled.maxradarrange * 0.5
									)
								">
									<set_value name="$kAAIT_isTargetNearBigEnemy" exact="true" />
								</do_if>
							</do_if>
							<do_if value="$kAAIT_isShipNearBigEnemy or $kAAIT_isTargetNearBigEnemy">
								<set_value name="$kAAIT_bigEnemy" exact="$kAAIT_bigEnemy_inList" />
								<break />
							</do_if>
						</do_if>
					</do_for_each>
				</do_if>
				<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_isShipNearBigEnemy: ' + $kAAIT_isShipNearBigEnemy + ' $kAAIT_isTargetNearBigEnemy: ' + $kAAIT_isTargetNearBigEnemy" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_bigEnemy: ' + @kAAIT_bigEnemy.knownname + ' ' + @$kAAIT_bigEnemy.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			</actions>

			<actions name="kAAIT_FindSmallerTargetFarFromBigTarget">
				<do_if value="@this.$kAAIT_data.$defensibleTarget.isoperational">
					<set_value name="$kAAIT_Target" exact="null" />
					<find_gravidar_contact name="$kAAIT_Target" object="this.assignedcontrolled" class="[class.ship_xs, class.ship_s, class.ship_m]" docked="false" functional="true" maybeattackedby="this.assignedcontrolled" sortbydistanceto="this.assignedcontrolled" chance="if @this.assignedcontrolled.sector.macro then 100 else 0">
						<match_context macro="this.assignedcontrolled.sector.macro"/>
						<match class="class.buildstorage" negate="true"/>
						<match state="componentstate.wreck" negate="true"/>
						<match_distance min="10km" max="this.assignedcontrolled.maxradarrange" object="this.$kAAIT_data.$defensibleTarget" />
					</find_gravidar_contact>
					<do_if value="@$kAAIT_Target.isoperational">
						<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_Target: ' + @$kAAIT_Target.knownname + ' ' + @$kAAIT_Target.idcode + ' size: ' + @$kAAIT_Target.size + ' weapons: ' + @$kAAIT_Target.weapons.operational.count" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
						<!-- <do_if value="this.assignedcontrolled.bboxdistanceto.{this.$kAAIT_data.$defensibleTarget} lt this.assignedcontrolled.bboxdistanceto.{$kAAIT_Target}"> -->
						<do_if value="$kAAIT_Target.bboxdistanceto.{this.$kAAIT_data.$defensibleTarget} lt this.assignedcontrolled.bboxdistanceto.{this.$kAAIT_data.$defensibleTarget}">
							<!-- because this is circling a big target already, any object farther away would put the big target in the way -->
							<set_value name="$kAAIT_Target" exact="null" />
						</do_if>
						<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_Target (post-obstruction test): ' + @$kAAIT_Target.knownname + ' ' + @$kAAIT_Target.idcode + ' size: ' + @$kAAIT_Target.size + ' weapons: ' + @$kAAIT_Target.weapons.operational.count" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					</do_if>
				</do_if>
			</actions>

			<actions name="kAAIT_GetSkillVars">
				<do_if value="global.$kAAIT_Config.$isUseNPCSkills">
					<set_value name="this.$kAAIT_data.$skill_attackers_count_mult" exact="2 - (this.skill.piloting + this.skill.morale) / 30.0 * 1" comment="0 = * 2, 5 = * 1" />
					<set_value name="this.$kAAIT_data.$skill_distance_engagePosition_mult" exact="0.75 + (this.skill.piloting + this.skill.morale) / 30.0 * 0.25" comment="combat range max * (0 = * 0.75, 5 = 1)" />
					<set_value name="this.$kAAIT_data.$skill_distance_stepForward_mult" exact="2 - (this.skill.piloting + this.skill.morale) / 30.0 * 1" comment="count of step forwards * (0 = 2km, 5 = 1km)" />
					<set_value name="this.$kAAIT_data.$skill_shieldPercentage_withdrawAt" exact="75 + (this.skill.piloting + this.skill.morale) / 30.0 * 25" comment="0 = 75, 5 = 90" />
					<set_value name="this.$kAAIT_data.$skill_distance_withdraw" exact="this.assignedcontrolled.maxradarrange * (0.25 + (this.skill.piloting + this.skill.morale) / 30.0 * 0.25)" comment="0 = * 0.25, 5 = * 0.5" />
				</do_if>
				<do_else>
					<set_value name="this.$kAAIT_data.$skill_attackers_count_mult" exact="1" />
					<set_value name="this.$kAAIT_data.$skill_distance_engagePosition_mult" exact="1" />
					<set_value name="this.$kAAIT_data.$skill_distance_stepForward_mult" exact="1" />
					<set_value name="this.$kAAIT_data.$skill_shieldPercentage_withdrawAt" exact="90" />
					<set_value name="this.$kAAIT_data.$skill_distance_withdraw" exact="this.assignedcontrolled.maxradarrange * 0.5" />
				</do_else>
			</actions>

			<!--
				 dP"Yb  88""Yb 8888b.  888888 88""Yb .dP"Y8
				dP   Yb 88__dP  8I  Yb 88__   88__dP `Ybo."
				Yb   dP 88"Yb   8I  dY 88""   88"Yb  o.`Y8b
				 YbodP  88  Yb 8888Y"  888888 88  Yb 8bodP'
			 -->
			<actions name="kAAIT_CleanOrders">
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_CleanOrders'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<do_for_each name="$kAAIT_order" in="this.assignedcontrolled.orders" counter="$i" reverse="true">
					<do_if value="@$kAAIT_order.$kAAITParam_iskAAITOrder and $i gt 1" comment="cancel other move.kuertee.*.xml order">
						<debug_text text="this.assignedcontrolled.idcode + ' cancel_order ' + $kAAIT_order.id" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
						<cancel_order order="$kAAIT_order" />
					</do_if>
				</do_for_each>
			</actions>

			<actions name="kAAIT_Order_AttackOther">
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Order_AttackOther'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' ======================='" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<do_if value="@$kAAIT_Target.isoperational">
					<include_interrupt_actions ref="kAAIT_CleanOrders" />
					<debug_text text="this.assignedcontrolled.idcode + ' create_order Attack'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<set_value name="$kAAIT_isImmediate" exact="not @this.assignedcontrolled.order.$kAAIT_order" />
					<create_order name="$kAAIT_order_attack" object="this.assignedcontrolled" id="'Attack'" immediate="$kAAIT_isImmediate">
						<param name="primarytarget" value="$kAAIT_Target" />
						<param name="pursuedistance" value="if @$pursuedistance then $pursuedistance else this.assignedcontrolled.maxradarrange" />
						<param name="pursuetargets" value="if @$pursuetargets then $pursuetargets else false" />
						<param name="kAAITParam_isAvoidHighRisk" value="@$kAAITParam_isAvoidHighRisk" />
						<param name="kAAITParam_isStepForwardWithdraw" value="@$kAAITParam_isStepForwardWithdraw" />
						<param name="debugchance" value="$debugchance"/>
					</create_order>
					<do_if value="not $kAAIT_isImmediate" comment="put attack order 2nd on the list">
						<move_order order="$kAAIT_order_attack" newindex="2" result="$kAAIT_repositionOrderIsOk" />
						<do_if value="not $kAAIT_repositionOrderIsOk">
							<cancel_order order="$kAAIT_order_attack" />
						</do_if>
					</do_if>
				</do_if>
			</actions>

			<actions name="kAAIT_Order_Avoid">
				<include_interrupt_actions ref="kAAIT_CleanOrders" />
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Order_Avoid'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' ================='" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' this.$kAAIT_data.$avoidBigEnemy: ' + @this.$kAAIT_data.$avoidBigEnemy.knownname + ' ' + @$this.kAAIT_data.$avoidBigEnemy.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<create_order object="this.assignedcontrolled" id="'kAAIT_MoveAvoid'" immediate="true">
					<param name="target" value="if @this.$kAAIT_data.$avoidBigEnemy.isoperational then this.$kAAIT_data.$avoidBigEnemy else this.$kAAIT_data.$defensibleTarget" />
					<param name="kAAITParam_isAvoidHighRisk" value="@$kAAITParam_isAvoidHighRisk" />
					<param name="kAAITParam_isStepForwardWithdraw" value="@$kAAITParam_isStepForwardWithdraw" />
				</create_order>
			</actions>

			<actions name="kAAIT_Order_Flee">
				<include_interrupt_actions ref="kAAIT_CleanOrders" />
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Order_Flee'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' ================'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<create_order object="this.assignedcontrolled" id="'Flee'" immediate="true">
					<param name="method" value="'boost'"/>
					<param name="attacker" value="if @this.$kAAIT_data.$avoidBigEnemy.isoperational then @this.$kAAIT_data.$avoidBigEnemy else @this.$kAAIT_data.$defensibleTarget"/>
					<param name="donotdrop" value="true"/>
					<param name="deploydistraction" value="this.$kAAIT_data.$defensibleTarget.isclass.ship"/>
					<param name="log" value="false"/>
					<param name="kAAITParam_iskAAITOrder" value="true"/>
					<param name="debugchance" value="$debugchance"/>
				</create_order>
			</actions>

			<actions name="kAAIT_Order_Withdraw">
				<include_interrupt_actions ref="kAAIT_CleanOrders" />
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Order_Withdraw'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' ===================='" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<create_order object="event.object" id="'kAAIT_MoveWithdraw'" immediate="true">
					<param name="target" value="this.$kAAIT_data.$defensibleTarget"/>
					<param name="kAAITParam_isAvoidHighRisk" value="true"/>
					<param name="kAAITParam_isStepForwardWithdraw" value="true"/>
				</create_order>
			</actions>

			<!--
				   db    Yb    dP  dP"Yb  88 8888b.       dP"Yb  88""Yb     88b 88  dP"Yb  888888
				  dPYb    Yb  dP  dP   Yb 88  8I  Yb     dP   Yb 88__dP     88Yb88 dP   Yb   88
				 dP__Yb    YbdP   Yb   dP 88  8I  dY     Yb   dP 88"Yb      88 Y88 Yb   dP   88
				dP""""Yb    YP     YbodP  88 8888Y"       YbodP  88  Yb     88  Y8  YbodP    88
			 -->
			<actions name="kAAIT_AvoidOrNot">
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_AvoidOrNot'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' ================'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<include_interrupt_actions ref="kAAIT_GetBigEnemies" />
				<debug_text text="this.assignedcontrolled.idcode + ' this.assignedcontrolled.order.$kAAITParam_iskAAITOrder: ' + @this.assignedcontrolled.order.$kAAITParam_iskAAITOrder" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_bigEnemies.count: ' + $kAAIT_bigEnemies.count" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<do_if value="
					@this.assignedcontrolled.order.id == 'Attack' or
					@this.assignedcontrolled.order.id == 'TacticalOrder'
				" comment="movement in attack order">
					<do_if value="@this.$kAAIT_data" comment="this may be from an attack ai, so evaluate if the target is high-risk. otherwise, evaluate with nearby big enemies.">
						<include_interrupt_actions ref="kAAIT_GetIsTargetHighRisk" />
					</do_if>
					<do_if value="not @this.$kAAIT_data.$isTargetHighRisk">
						<include_interrupt_actions ref="kAAIT_GetIsNearBigEnemies" />
						<!-- <debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_isShipNearBigEnemy (1): ' + $kAAIT_isShipNearBigEnemy" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" /> -->
						<!-- <debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_isTargetNearBigEnemy (1): ' + $kAAIT_isTargetNearBigEnemy" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" /> -->
						<do_if value="@$kAAIT_isShipNearBigEnemy or @$kAAIT_isTargetNearBigEnemy">
							<do_if value="not @this.$kAAIT_data">
								<set_value name="this.$kAAIT_data" exact="table[]" />
							</do_if>
							<set_value name="this.$kAAIT_data.$avoidBigEnemy" exact="$kAAIT_bigEnemy" />
							<include_interrupt_actions ref="kAAIT_Order_Flee" />
						</do_if>
					</do_if>
					<do_else>
						<do_if value="@$allowothertargets">
							<include_interrupt_actions ref="kAAIT_FindSmallerTargetFarFromBigTarget" />
							<do_if value="@$kAAIT_Target.isoperational">
								<include_interrupt_actions ref="kAAIT_Order_AttackOther" />
							</do_if>
						</do_if>
						<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_Target: ' + @$kAAIT_Target" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
						<do_if value="not @$kAAIT_Target.isoperational">
							<do_if value="this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m]">
								<set_value name="this.$kAAIT_data.$avoidBigEnemy" exact="this.$kAAIT_data.$defensibleTarget" />
								<include_interrupt_actions ref="kAAIT_Order_Avoid" />
							</do_if>
							<do_elseif value="
								this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
								(
									this.assignedcontrolled.primarypurpose != purpose.fight or
									this.assignedcontrolled.type == shiptype.carrier
								)
							">
								<set_value name="$kAAIT_distToTarget" exact="this.assignedcontrolled.distanceto.{this.$kAAIT_data.$defensibleTarget}" />
								<do_if value="$kAAIT_distToTarget le this.assignedcontrolled.maxradarrange * 0.5">
									<debug_text text="this.assignedcontrolled.idcode + ' not a fighter LXL near high-risk'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
									<do_if value="not @this.$kAAIT_data">
										<set_value name="this.$kAAIT_data" exact="table[]" />
									</do_if>
									<set_value name="this.$kAAIT_data.$avoidBigEnemy" exact="this.$kAAIT_data.$defensibleTarget" />
									<include_interrupt_actions ref="kAAIT_Order_Avoid" />
								</do_if>
							</do_elseif>
						</do_if>
					</do_else>
				</do_if>
				<do_elseif value="@$target" comment="assume escort or follow target">
					<include_interrupt_actions ref="kAAIT_GetIsNearBigEnemies" />
					<!-- <debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_isShipNearBigEnemy (2): ' + $kAAIT_isShipNearBigEnemy" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" /> -->
					<!-- <debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_isTargetNearBigEnemy (2): ' + $kAAIT_isTargetNearBigEnemy" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" /> -->
					<do_if value="@$kAAIT_isShipNearBigEnemy or @$kAAIT_isTargetNearBigEnemy">
						<do_if value="not @this.$kAAIT_data">
							<set_value name="this.$kAAIT_data" exact="table[]" />
						</do_if>
						<set_value name="this.$kAAIT_data.$avoidBigEnemy" exact="$kAAIT_bigEnemy" />
						<include_interrupt_actions ref="kAAIT_Order_Avoid" />
					</do_if>
				</do_elseif>
				<do_if value="not @this.assignedcontrolled.order.$kAAITParam_iskAAITOrder" comment="general movement">
					<debug_text text="this.assignedcontrolled.idcode + ' CHECK AHEAD FOR BIG ENEMIES'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<create_position name="$kAAIT_posCurrent" space="this.assignedcontrolled.zone" object="this.assignedcontrolled" />
					<do_if value="@$positionspace and @$position">
						<create_position name="$kAAIT_posAhead" space="this.assignedcontrolled.zone" object="$positionspace" value="$position" />
						<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_posAhead (from $positionspace): ' + $kAAIT_posAhead" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					</do_if>
					<do_elseif value="@$destination">
						<do_if value="@$position">
							<create_position name="$kAAIT_posAhead" space="this.assignedcontrolled.zone" object="$destination" value="$position" />
						</do_if>
						<do_else>
							<create_position name="$kAAIT_posAhead" space="this.assignedcontrolled.zone" object="$destination" />
						</do_else>
						<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_posAhead (from $destination ' + $destination.class + '): ' + $kAAIT_posAhead" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					</do_elseif>
					<do_else>
						<create_position name="$kAAIT_posAhead" space="this.assignedcontrolled.zone" z="this.assignedcontrolled.maxradarrange * 2" object="this.assignedcontrolled" />
						<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_posAhead (from ship heading): ' + $kAAIT_posAhead" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					</do_else>
					<debug_text text="this.assignedcontrolled.idcode + ' this.$kAAIT_data.$isAvoiding: ' + @this.$kAAIT_data.$isAvoiding" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<do_if value="not @this.$kAAIT_data.$isAvoiding">
						<set_value name="$kAAIT_distToDest" exact="this.assignedcontrolled.distanceto.{$kAAIT_posAhead}" />
						<create_orientation name="$kAAIT_rotToDest" orientation="look_at" refposition="$kAAIT_posAhead">
							<position value="$kAAIT_posCurrent" />
						</create_orientation>
						<set_value name="$kAAIT_yawToDest" exact="$kAAIT_rotToDest.yaw * 180 / pi" />
						<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_yawToDest (orig): ' + @$kAAIT_yawToDest" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
						<do_while value="$kAAIT_yawToDest lt 0 or $kAAIT_yawToDest gt 359">
							<do_if value="$kAAIT_yawToDest lt 0">
								<set_value name="$kAAIT_yawToDest" exact="$kAAIT_yawToDest + 359" />
							</do_if>
							<do_elseif value="$kAAIT_yawToDest gt 359">
								<set_value name="$kAAIT_yawToDest" exact="$kAAIT_yawToDest - 359" />
							</do_elseif>
						</do_while>
						<debug_text text="this.assignedcontrolled.idcode + ' this.$kAAIT_data.$defensibleTarget: ' + @this.$kAAIT_data.$defensibleTarget.knownname + ' ' + @this.$kAAIT_data.$defensibleTarget.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
						<do_for_each name="$kAAIT_bigEnemy" in="$kAAIT_bigEnemies">
							<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_bigEnemy: ' + $kAAIT_bigEnemy.knownname + ' ' + $kAAIT_bigEnemy.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
							<do_if value="
								this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
								this.assignedcontrolled.primarypurpose == purpose.fight and
								this.assignedcontrolled.type != shiptype.carrier and
								(
									@this.assignedcontrolled.order.id == 'Attack' or
									@this.assignedcontrolled.order.id == 'TacticalOrder'
								) and
								$kAAIT_bigEnemy == @this.$kAAIT_data.$defensibleTarget
							" comment="only LXL are allowed to engage their target even if the target is high-risk or a potential high-risk">
								<debug_text text="this.assignedcontrolled.idcode + ' do not avoid $kAAIT_bigEnemy. attack $kAAIT_bigEnemy!'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
								<continue />
							</do_if>
							<create_position name="$kAAIT_posTarget" space="this.assignedcontrolled.zone" object="$kAAIT_bigEnemy" />
							<!-- <set_value name="$kAAIT_distFromDestToBigEnemy" exact="this.assignedcontrolled.distanceto.{$kAAIT_posTarget}" /> -->
							<!-- <set_value name="$kAAIT_distToBigEnemy" exact="$kAAIT_posAhead.distanceto.{$kAAIT_posTarget}" /> -->
							<set_value name="$kAAIT_distToBigEnemy" exact="this.assignedcontrolled.distanceto.{$kAAIT_posTarget}" />
							<create_orientation name="$kAAIT_rotToBigEnemy" orientation="look_at" refposition="$kAAIT_posTarget">
								<position value="$kAAIT_posCurrent" />
							</create_orientation>
							<set_value name="$kAAIT_yawToBigEnemy" exact="$kAAIT_rotToBigEnemy.yaw * 180 / pi" />
							<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_yawToBigEnemy (orig): ' + @$kAAIT_yawToBigEnemy" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
							<do_while value="$kAAIT_yawToBigEnemy lt 0 or $kAAIT_yawToBigEnemy gt 359">
								<do_if value="$kAAIT_yawToBigEnemy lt 0">
									<set_value name="$kAAIT_yawToBigEnemy" exact="$kAAIT_yawToBigEnemy + 359" />
								</do_if>
								<do_elseif value="$kAAIT_yawToBigEnemy gt 359">
									<set_value name="$kAAIT_yawToBigEnemy" exact="$kAAIT_yawToBigEnemy - 359" />
								</do_elseif>
							</do_while>
							<set_value name="$kAAIT_yawDiff" exact="$kAAIT_yawToDest - $kAAIT_yawToBigEnemy" />
							<set_value name="$kAAIT_yawDiff" exact="[$kAAIT_yawDiff * -1, $kAAIT_yawDiff].max" />
							<do_if value="$kAAIT_yawDiff gt 180" comment="lesser turn the other way">
								<set_value name="$kAAIT_yawDiff" exact="360 - $kAAIT_yawDiff" />
							</do_if>
							<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_distToBigEnemy: ' + $kAAIT_distToBigEnemy" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
							<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_distToDest: ' + $kAAIT_distToDest" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
							<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_yawToDest: ' + $kAAIT_yawToDest" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
							<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_yawToBigEnemy: ' + $kAAIT_yawToBigEnemy" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
							<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_yawDiff: ' + $kAAIT_yawDiff" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
							<do_if value="
								$kAAIT_distToBigEnemy lt $kAAIT_distToDest and
								$kAAIT_yawDiff lt 60
							">
								<do_if value="not this.$kAAIT_data?">
									<set_value name="this.$kAAIT_data" exact="table[]" />
								</do_if>
								<set_value name="this.$kAAIT_data.$avoidBigEnemy" exact="$kAAIT_bigEnemy" />
								<include_interrupt_actions ref="kAAIT_Order_Avoid" />
								<break />
							</do_if>
						</do_for_each>
					</do_if>
				</do_if>
			</actions>
		</library>
	</interrupts>
</aiscript>
