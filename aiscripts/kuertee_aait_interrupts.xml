<?xml version="1.0" encoding="utf-8"?>
<aiscript name="kuertee_aait_interrupts" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="aiscripts.xsd">
	<interrupts>
		<library>
			<actions name="kAAIT_RegisterShip">
				<do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data?">
					<add_to_group groupname="global.$kAAIT_Data.$ships" object="this.assignedcontrolled" />
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}" exact="table[]" />
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data" exact="table[]" />
				</do_if>
			</actions>

			<actions name="kAAIT_Init">
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Init'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				<do_if value="@this.$beacon_from or @this.$kAAIT_target or @this.$kAAIT_orders">
					<include_interrupt_actions ref="kAAIT_CleanUpOldVersionData" />
				</do_if>
				<do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data?">
					<debug_text text="this.assignedcontrolled.idcode + ' NEW ATTACK ORDER'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
					<include_interrupt_actions ref="kAAIT_RegisterShip" />
				</do_if>
				<do_else>
					<debug_text text="this.assignedcontrolled.idcode + ' CONTINUED ATTACK ORDER'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				</do_else>
				<include_interrupt_actions ref="kAAIT_GetCombatRange" />
				<include_interrupt_actions ref="kAAIT_GetSkillVars" />
				<do_if value="this.assignedcontrolled.order.id == 'Attack'">
					<set_value name="$kAAIT_test_target_isHighRisk" exact="@$primarytarget" />
					<do_if value="not @$kAAIT_test_target_isHighRisk.exists">
						<set_value name="$kAAIT_test_target_isHighRisk" exact="@$target" />
					</do_if>
					<include_interrupt_actions ref="kAAIT_GetIsTargetHighRisk" />
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget" exact="$kAAIT_test_target_isHighRisk" />
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity" exact="@$kAAIT_target_highRiskEntity" />
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isTargetPotentialHighRisk" exact="@$kAAIT_isTargetPotentialHighRisk" />
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isTargetHighRisk" exact="@$kAAIT_result_isTargetHighRisk" />
					<remove_value name="$kAAIT_test_target_isHighRisk" />
				</do_if>
				<!-- check for other entries of this text: ship will withdraw and fight at these conditions. so cancel withdrawal when required.
					fight: shield gt skill-withdraw-value.
					withdraw: shield gt 5, shield le skill-withdraw-value, distance to target < 10km.
					fight: shield le 5, hull le 50.
				-->
				<do_if value="
					@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isIgnoreKAAIT and
					(
						(
							global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget.isclass.station and
							this.assignedcontrolled.shieldpercentage gt global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_shieldPercentage_withdrawAt_vStation
						) or
						(
							global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget.isclass.ship and
							(
								this.assignedcontrolled.shieldpercentage gt global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_shieldPercentage_withdrawAt_vShip or
								this.assignedcontrolled.bboxdistanceto.{global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget} gt this.assignedcontrolled.maxradarrange * 0.25 or
								(
									this.assignedcontrolled.shieldpercentage le 5 and
									this.assignedcontrolled.hullpercentage le 50
								)
							)
						)
					)" comment="clear ignore flag when ship should fight. e.g. v ship: when no shields, but good hull.">
					<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isIgnoreKAAIT" />
				</do_if>
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isInited" exact="true" />
				<leave_formation object="this.assignedcontrolled" />
				<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_data: ' + global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
			</actions>

			<actions name="kAAIT_Deinit">
				<set_value name="$isDeInit" exact="true" />
				<do_if value="
					@this.assignedcontrolled.order.$kAAITParam_iskAAITOrder and
					(
						@this.assignedcontrolled.nextorder.id == 'MoveGeneric' or
						@this.assignedcontrolled.nextorder.id == 'MoveWait'
					)">
					<set_value name="$isDeInit" exact="false" />
				</do_if>
				<do_if value="$isDeInit">
					<do_if value="@this.assignedcontrolled.orders.count">
						<do_for_each name="$kAAIT_order" in="this.assignedcontrolled.orders">
							<do_if value="
								$kAAIT_order.id == 'Attack' or
								$kAAIT_order.id == 'Escort' or
								$kAAIT_order.id == 'ProtectShip'">
								<set_value name="$isDeInit" exact="false" />
								<break />
							</do_if>
						</do_for_each>
					</do_if>
				</do_if>
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Deinit $isDeInit: ' + $isDeInit + ' order.id: ' + @this.assignedcontrolled.order.id + ' order.$kAAITParam_iskAAITOrder: ' + @this.assignedcontrolled.order.$kAAITParam_iskAAITOrder" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				<do_if value="$isDeInit">
					<include_interrupt_actions ref="kAAIT_RemoveAttackerFromTarget" />
					<do_if value="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data?">
						<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data" />
					</do_if>
					<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_data: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
					<do_if value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_tacticalOrdersToCancel">
						<do_for_each name="$kAAIT_order" in="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_tacticalOrdersToCancel">
							<do_if value="@$kAAIT_order.exists and $kAAIT_order.id != 'Attack'">
								<debug_text text="this.assignedcontrolled.idcode + ' cancelled ' + $kAAIT_order.id + ' on ' + @$kAAIT_order.object.knownname + ' ' + @$kAAIT_order.object.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
								<set_order_syncpoint_reached order="$kAAIT_order" />
								<unassign_order_syncpoint_from_order order="$kAAIT_order" />
								<cancel_order order="$kAAIT_order" />
							</do_if>
						</do_for_each>
						<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_tacticalOrdersToCancel" />
					</do_if>
				</do_if>
			</actions>

			<actions name="kAAIT_CleanUpOldVersionData">
				<!-- start: clean-up obsolete data from previous version -->
				<!-- current version: most of these vars in global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data -->
				<do_if value="@this.$beacon_from.exists"><destroy_object object="this.$beacon_from" /></do_if>
				<do_if value="@this.$beacon_to.exists"><destroy_object object="this.$beacon_to" /></do_if>
				<do_if value="@this.$beacon_avoid1.exists"><destroy_object object="this.$beacon_avoid1" /></do_if>
				<do_if value="@this.$beacon_avoid2.exists"><destroy_object object="this.$beacon_avoid2" /></do_if>
				<remove_value name="this.$beacon_from" />
				<remove_value name="this.$beacon_to" />
				<remove_value name="this.$beacon_avoid1" />
				<remove_value name="this.$beacon_avoid2" />
				<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget_stopKamikaze" />
				<remove_value name="this.$kAAIT_target" />
				<remove_value name="this.$kAAIT_orders" />
				<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_aroundDir" />
				<remove_value name="this.$kAAIT_lastAttack_enemy" />
				<remove_value name="this.$kAAIT_lastAttack_time" />
				<remove_value name="this.$kAAIT_lastAttack_timeLastSafe" />
				<remove_value name="this.$kAAIT_inchForwardCount" />
				<remove_value name="this.$kAAIT_movedOutOfRangeCount" />
				<remove_value name="this.$kAAIT_orderLocation_space" />
				<remove_value name="this.$kAAIT_orderLocation_pos" />
				<!-- end: clean-up obsolete data from previous version -->
			</actions>

			<actions name="kAAIT_AddAttackerToTarget">
				<do_if value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.isoperational">
					<do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers?">
						<create_group groupname="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers" />
					</do_if>
					<do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl?">
						<create_group groupname="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl" />
					</do_if>
					<do_if value="player.age - @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_timeAdded gt 60min">
						<clear_group group="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers" />
						<clear_group group="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl" />
					</do_if>
					<do_if value="this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl]">
						<add_to_group groupname="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl" object="this.assignedcontrolled" />
					</do_if>
					<do_else>
						<add_to_group groupname="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers" object="this.assignedcontrolled" />
					</do_else>
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_timeAdded" exact="player.age" />
					<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_attackers (add to ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget + ' ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget.knownname + '): ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers.count" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				</do_if>
			</actions>

			<actions name="kAAIT_RemoveAttackerFromTarget">
				<do_if value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.isoperational">
					<do_if value="this.assignedcontrolled">
						<do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers?">
							<create_group groupname="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers" />
						</do_if>
						<do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl?">
							<create_group groupname="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl" />
						</do_if>
						<remove_from_group group="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers" object="this.assignedcontrolled" />
						<remove_from_group group="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl" object="this.assignedcontrolled" />
					</do_if>
					<do_if value="not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers.count">
						<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers" />
					</do_if>
					<do_if value="not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl.count">
						<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl" />
					</do_if>
					<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_attackers (remove from ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget + ' ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget.knownname + '): ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers.count" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				</do_if>
			</actions>

			<!--
				88  88    db    88b 88 8888b.  88     888888 88""Yb .dP"Y8
				88  88   dPYb   88Yb88  8I  Yb 88     88__   88__dP `Ybo."
				888888  dP__Yb  88 Y88  8I  dY 88  .o 88""   88"Yb  o.`Y8b
				88  88 dP""""Yb 88  Y8 8888Y"  88ood8 888888 88  Yb 8bodP'
			 -->
			<handler name="kAAIT_Handler_AvoidWithdrawOrJustFight">
				<conditions>
					<check_any>
						<check_all chance="if @$kAAITParam_iskAAITOrder or @$kAAITParam_isStepForwardWithdraw or (@$kAAITParam_isAvoidHighRisk and this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m]) then 100 else 0">
							<check_any>
								<event_object_shield_damaged object="this.assignedcontrolled" />
								<event_object_hull_damaged object="this.assignedcontrolled" />
							</check_any>
							<check_any>
								<check_value value="@this.assignedcontrolled.order.id == 'Attack'" />
								<check_value value="@this.assignedcontrolled.order.id == 'TacticalOrder'" />
							</check_any>
							<!-- <debug_text text="this.assignedcontrolled.idcode + ' event.name: ' + event.name" /> -->
							<!-- <check_any comment="is avoid/withdraw high-risk. ensure that these parameters are set-up in the orders that use this handler.">
								<check_all>
									<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight $kAAITParam_iskAAITOrder: ' + @$kAAITParam_iskAAITOrder" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
									<check_value value="@$kAAITParam_iskAAITOrder" />
								</check_all>
								<check_all>
									<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight $kAAITParam_isStepForwardWithdraw: ' + @$kAAITParam_isStepForwardWithdraw" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
									<check_value value="@$kAAITParam_isStepForwardWithdraw" />
								</check_all>
								<check_all>
									<check_value value="this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m]" />
									<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight $kAAITParam_isAvoidHighRisk: ' + @$kAAITParam_isAvoidHighRisk" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
									<check_value value="@$kAAITParam_isAvoidHighRisk" />
								</check_all>
							</check_any> -->
							<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight params are good'" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
							<!-- <debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight params are good'" /> -->
							<check_any>
								<check_all>
									<check_value value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget.isoperational" />
									<set_value name="$kAAIT_attacker" exact="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget" />
								</check_all>
								<check_all>
									<check_value value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$bigEnemies.{1}.isoperational" />
									<set_value name="$kAAIT_attacker" exact="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$bigEnemies.{1}" />
								</check_all>
							</check_any>
							<check_value value="player.age gt @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$time_lastHit" />
							<check_value value="player.age gt @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$time_withdrawAllowed" />
							<set_value name="$kAAIT_eventType" exact="'withdraw'" />
							<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight $kAAIT_attacker.knownname (shield/hull damaged, withdraw): ' + @$kAAIT_attacker.knownname + ' ' + $kAAIT_attacker.idcode" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
							<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$time_lastHit" exact="player.age" />
						</check_all>
						<check_all chance="if @$kAAITParam_iskAAITOrder or @$kAAITParam_isStepForwardWithdraw or (@$kAAITParam_isAvoidHighRisk and this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m]) then 100 else 0">
							<check_any>
								<event_object_attacked object="this.assignedcontrolled" />
								<event_object_attacked_object object="this.assignedcontrolled" />
							</check_any>
							<!-- <debug_text text="this.assignedcontrolled.idcode + ' event.name: ' + event.name" /> -->
							<check_any>
								<check_value value="@this.assignedcontrolled.order.id == 'Attack'" />
								<check_value value="@this.assignedcontrolled.order.id == 'TacticalOrder'" />
							</check_any>
							<!-- <check_any comment="is avoid/withdraw high-risk. ensure that these parameters are set-up in the orders that use this handler.">
								<check_all>
									<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight $kAAITParam_iskAAITOrder: ' + @$kAAITParam_iskAAITOrder" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
									<check_value value="@$kAAITParam_iskAAITOrder" />
								</check_all>
								<check_all>
									<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight $kAAITParam_isStepForwardWithdraw: ' + @$kAAITParam_isStepForwardWithdraw" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
									<check_value value="@$kAAITParam_isStepForwardWithdraw" />
								</check_all>
								<check_all>
									<check_value value="this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m]" />
									<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight $kAAITParam_isAvoidHighRisk: ' + @$kAAITParam_isAvoidHighRisk" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
									<check_value value="@$kAAITParam_isAvoidHighRisk" />
								</check_all>
							</check_any> -->
							<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight params are good'" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
							<!-- <debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight params are good'" /> -->
							<set_value name="$kAAIT_attacker" exact="if event.param.defensible then event.param.defensible else event.param" />
							<check_value value="player.age gt @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$time_withdrawAllowed" />
							<set_value name="$kAAIT_eventType" exact="'withdraw'" />
							<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight $kAAIT_attacker.knownname (attacked, withdraw): ' + @$kAAIT_attacker.knownname + ' ' + $kAAIT_attacker.idcode" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
						</check_all>
						<check_all chance="if @$kAAITParam_iskAAITOrder or @$kAAITParam_isAvoidHighRisk then 100 else 0">
							<event_gravidar_has_scanned object="if (@$kAAITParam_isAvoidHighRisk and (not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isIgnoreKAAIT)) then this.assignedcontrolled else null" check="false"/>
							<check_any>
								<check_value value="not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget.isoperational" comment="not in attack" />
								<check_value value="this.assignedcontrolled.bboxdistanceto.{global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget} gt this.assignedcontrolled.maxradarrange" comment="target is far" />
							</check_any>
							<!-- <debug_text text="this.assignedcontrolled.idcode + ' event.name: ' + event.name" /> -->
							<count_gravidar_contacts result="$kAAIT_gravidarTarget" object="this.assignedcontrolled" class="[class.ship_l, class.ship_xl, class.station]" maybeattackedby="this.assignedcontrolled" checkoperational="false" masstraffic="false" docked="false" min="1" multiple="false">
								<match_context macro="[@this.sector.macro]"/>
								<match_context class="class.highway" negate="true"/>
								<match class="class.buildstorage" negate="true"/>
								<match state="componentstate.wreck" negate="true"/>
								<match_relation_to object="this.assignedcontrolled" relation="enemy" comparison="le" />
							</count_gravidar_contacts>
							<!-- <check_any comment="is avoid/withdraw high-risk. ensure that these parameters are set-up in the orders that use this handler.">
								<check_all>
									<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight $kAAITParam_iskAAITOrder: ' + @$kAAITParam_iskAAITOrder" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
									<check_value value="@$kAAITParam_iskAAITOrder" />
								</check_all>
								<check_all>
									<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight $kAAITParam_isAvoidHighRisk: ' + @$kAAITParam_isAvoidHighRisk" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
									<check_value value="@$kAAITParam_isAvoidHighRisk" />
								</check_all>
							</check_any> -->
							<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight params are good'" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
							<!-- <debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight params are good'" /> -->
							<set_value name="$kAAIT_attacker" exact="if $kAAIT_gravidarTarget.defensible then $kAAIT_gravidarTarget.defensible else $kAAIT_gravidarTarget" />
							<check_all comment="do not avoid attack targets. note that xssm ships avoid their targets NOT from this event but from code in their AI. this event is for targets that enter gravidar.">
								<check_value value="$kAAIT_attacker != @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget" />
								<check_value value="$kAAIT_attacker != @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget.commander" />
								<check_value value="$kAAIT_attacker != @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget.toplevelcommander" />
								<check_value value="$kAAIT_attacker != @$primarytarget" />
								<check_value value="$kAAIT_attacker != @$primarytarget.commander" />
								<check_value value="$kAAIT_attacker != @$primarytarget.toplevelcommander" />
								<check_value value="$kAAIT_attacker != @$target" />
								<check_value value="$kAAIT_attacker != @$target.commander" />
								<check_value value="$kAAIT_attacker != @$target.toplevelcommander" />
							</check_all>
							<check_value value="player.age gt @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$time_avoidAllowed" />
							<set_value name="$kAAIT_eventType" exact="'avoid'" />
							<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight $kAAIT_attacker.knownname (gravidar, avoid): ' + @$kAAIT_attacker.knownname + ' ' + $kAAIT_attacker.idcode" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
						</check_all>
					</check_any>
					<set_value name="$kAAIT_isInterrupted" exact="true" />
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight event.name: ' + event.name + ' @$kAAIT_eventType: ' + @$kAAIT_eventType" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
					<check_value value="@$kAAIT_eventType" />
					<check_value value="@$kAAIT_attacker.isoperational" />
					<set_value name="$kAAIT_attackerEntity" exact="if @$kAAIT_attacker.assignedaipilot then $kAAIT_attacker.assignedaipilot else @$kAAIT_attacker.defencenpc" />
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight $kAAIT_attackerEntity.name: ' + @$kAAIT_attackerEntity.name" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
					<check_value value="@$kAAIT_attackerEntity.exists" />
					<check_all comment="is allowed to avoid or withdraw. conditions: attacker, self, situation">
						<check_all comment="attacker">
							<check_value value="$kAAIT_attacker.isclass.[class.ship, class.station]" />
							<check_value value="not @$kAAIT_attacker.isunit" />
							<check_value value="not @$kAAIT_attacker.islasertower" />
							<check_any>
								<check_value value="$kAAIT_attacker.shieldpercentage gt 25" />
								<check_value value="$kAAIT_attacker.hullpercentage gt 25" />
							</check_any>
							<check_any comment="is high-risk">
								<check_all>
									<check_value value="$kAAIT_attacker == @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget" />
									<check_value value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isTargetHighRisk" />
								</check_all>
								<check_all>
									<check_value value="$kAAIT_attacker.size gt this.assignedcontrolled.size * 1.5" />
									<check_value value="$kAAIT_attacker.primarypurpose == purpose.fight" />
								</check_all>
							</check_any>
						</check_all>
						<check_all comment="self">
							<check_value value="not this.assignedcontrolled.isunit" />
							<check_value value="not this.assignedcontrolled.islasertower" />
							<check_any comment="prevent avoid while already avoiding">
								<check_value value="$kAAIT_eventType != 'avoid'" />
								<check_value value="not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isAvoiding" />
							</check_any>
							<check_value value="not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isWithdrawing" />
							<check_value value="not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isIgnoreKAAIT" />
							<check_value value="this.assignedcontrolled.engines.operational.count / (this.assignedcontrolled.engines.all.count)f gt 0.25" />
						</check_all>
						<check_any comment="situation">
							<check_value value="$kAAIT_eventType == 'avoid'" />
							<check_value value="@$kAAIT_attacker.isclass.station" />
							<check_all comment="no attack order, so withdraw">
								<check_value value="@this.assignedcontrolled.order.id != 'Attack'" />
								<check_value value="@this.assignedcontrolled.nextorder.id != 'Attack'" />
								<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight not attacking, so withdraw'" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
							</check_all>
							<check_value value="$kAAIT_attacker != @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget" comment="new attacker" />
							<check_all comment="attacker is target and it has other lxl attacker">
								<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight $kAAIT_attackerEntity.$kAAIT_attackers_lxl.indexof.{this.assignedcontrolled}: ' + @$kAAIT_attackerEntity.$kAAIT_attackers_lxl.indexof.{this.assignedcontrolled}" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
								<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight @$kAAIT_attackerEntity.$kAAIT_attackers_lxl.count: ' + @$kAAIT_attackerEntity.$kAAIT_attackers_lxl.count" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
								<check_value value="$kAAIT_attacker == global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget" />
								<check_any>
									<check_all>
										<check_value value="@$kAAIT_attackerEntity.$kAAIT_attackers_lxl.indexof.{this.assignedcontrolled}" />
										<check_value value="@$kAAIT_attackerEntity.$kAAIT_attackers_lxl.count gt 1" />
										<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight has other attackers including me'" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
									</check_all>
									<check_all>
										<check_value value="not @$kAAIT_attackerEntity.$kAAIT_attackers_lxl.indexof.{this.assignedcontrolled}" />
										<check_value value="@$kAAIT_attackerEntity.$kAAIT_attackers_lxl.count gt 0" />
										<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight has other attackers not including me'" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
									</check_all>
								</check_any>
							</check_all>
						</check_any>
						<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight is allowed to withdraw'" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
					</check_all>
					<set_value name="$kAAIT_skillMult" exact="(@this.skill.piloting + @this.skill.morale) / 30.0" />
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight this.assignedcontrolled.shieldpercentage: ' + @this.assignedcontrolled.shieldpercentage + ' this.assignedcontrolled.hullpercentage: ' + @this.assignedcontrolled.hullpercentage" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
					<check_any comment="get $kAAIT_isActOnEventNow.">
						<check_all comment="no operational weapons">
							<check_value value="not @this.assignedcontrolled.weapons.all.count" />
							<set_value name="$kAAIT_isActOnEventNow" exact="true" />
							<set_value name="$kAAIT_eventType" exact="'avoid'" />
							<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight no operational weapons, ensure avoid behaviour'" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
						</check_all>
						<check_all comment="too few operational weapons">
							<check_value value="@this.assignedcontrolled.weapons.operational.count / (this.assignedcontrolled.weapons.all.count)f le 0.25" />
							<set_value name="$kAAIT_isActOnEventNow" exact="true" />
							<set_value name="$kAAIT_eventType" exact="'avoid'" />
							<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight too few operational weapons, ensure avoid behaviour'" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
						</check_all>
						<check_all comment="v station">
							<check_all>
								<check_value value="@$kAAIT_attacker.isclass.station" />
								<check_value value="@$kAAIT_attacker.dps.all" />
							</check_all>
							<check_any>
								<check_all>
									<check_value value="@this.assignedcontrolled.$kAAIT_data.$skill_shieldPercentage_withdrawAt_vStation" />
									<set_value name="$kAAIT_shield_withdrawAt" exact="@this.assignedcontrolled.$kAAIT_data.$skill_shieldPercentage_withdrawAt_vStation" />
								</check_all>
								<set_value name="$kAAIT_shield_withdrawAt" exact="75 + $kAAIT_skillMult * 15" />
							</check_any>
							<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight this.assignedcontrolled.shieldpercentage: ' + @this.assignedcontrolled.shieldpercentage" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
							<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight $kAAIT_shield_withdrawAt: ' + @$kAAIT_shield_withdrawAt" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
							<check_value value="this.assignedcontrolled.shieldpercentage le $kAAIT_shield_withdrawAt" />
							<set_value name="$kAAIT_isActOnEventNow" exact="true" />
							<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight poor shields (le skill-withdraw) v station'" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
						</check_all>
						<check_value value="@$kAAIT_isActOnEventNow" />
						<check_all comment="v ship">
							<check_all>
								<check_value value="$kAAIT_attacker.isclass.ship" />
								<check_value value="$kAAIT_attacker.dps.all" />
							</check_all>
							<check_any>
								<check_all>
									<check_value value="@this.assignedcontrolled.$kAAIT_data.$skill_shieldPercentage_withdrawAt_vShip" />
									<set_value name="$kAAIT_shield_withdrawAt" exact="@this.assignedcontrolled.$kAAIT_data.$skill_shieldPercentage_withdrawAt_vShip" />
								</check_all>
								<set_value name="$kAAIT_shield_withdrawAt" exact="75 + $kAAIT_skillMult * 15" />
							</check_any>
							<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight this.assignedcontrolled.shieldpercentage: ' + @this.assignedcontrolled.shieldpercentage" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
							<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight $kAAIT_shield_withdrawAt: ' + @$kAAIT_shield_withdrawAt" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
							<!-- check for other entries of this text: ship will withdraw and fight at these conditions. so cancel withdrawal when required.
								fight: shield gt skill-withdraw-value.
								withdraw: shield gt 5, shield le skill-withdraw-value, distance to target < 10km.
								fight: shield le 5, hull le 50.
							-->
							<check_all comment="good shields: fight. poor shields: withdraw">
								<check_value value="this.assignedcontrolled.shieldpercentage gt 5" />
								<check_value value="this.assignedcontrolled.shieldpercentage le $kAAIT_shield_withdrawAt" />
								<check_value value="this.assignedcontrolled.hullpercentage gt 50" />
								<check_value value="this.assignedcontrolled.bboxdistanceto.{$kAAIT_attacker} le this.assignedcontrolled.maxradarrange * 0.25" />
							</check_all>
							<set_value name="$kAAIT_isActOnEventNow" exact="true" />
							<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight poor shields (le skill-withdraw) v ship'" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
						</check_all>
					</check_any>
					<check_value value="@$kAAIT_isActOnEventNow" />
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight $kAAIT_isActOnEventNow: ' + @$kAAIT_isActOnEventNow" debugchance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				</conditions>
				<actions>
					<do_if value="(not this.isplayerowned) and (not $kAAITParam_isAvoidHighRisk) and (not $kAAITParam_isStepForwardWithdraw)">
						<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight event.name: ' + event.name + ' $kAAIT_eventType: ' + @$kAAIT_eventType + ' order: ' + @this.assignedcontrolled.order.id" />
						<debug_text text="this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ================= $kAAIT_attacker: ' + @$kAAIT_attacker.knownname + ', ' + @$kAAIT_attacker.idcode" />
					</do_if>
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight event.name: ' + event.name + ' $kAAIT_eventType: ' + @$kAAIT_eventType + ' order: ' + @this.assignedcontrolled.order.id" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
					<debug_text text="this.assignedcontrolled.idcode + ' ====================================== $kAAIT_attacker: ' + @$kAAIT_attacker.knownname + ', ' + @$kAAIT_attacker.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
					<do_if value="@$kAAIT_eventType == 'withdraw'">
						<do_if value="$kAAIT_attacker.isclass.[class.ship_l, class.ship_xl, class.station] and $kAAIT_attacker != @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget" comment="new target">
							<do_if value="
								(not this.assignedcontrolled.commander) and
								@this.assignedcontrolled.subordinates.count">
								<signal_objects object="this.assignedcontrolled" param="'kAAIT_new_big_target'" param2="table[$attacker = $kAAIT_attacker, $from = this.assignedcontrolled]" />
							</do_if>
							<do_elseif value="
								@this.assignedcontrolled.commander.isclass.[class.ship_l, class.ship_xl] and
								this.assignedcontrolled.commander.sector == this.sector">
								<signal_objects object="this.assignedcontrolled.commander" param="'kAAIT_new_big_target'" param2="table[$attacker = $kAAIT_attacker, $from = this.assignedcontrolled]" />
							</do_elseif>
						</do_if>
					</do_if>
					<do_if value="@$kAAIT_isActOnEventNow">
						<do_if value="$kAAIT_eventType == 'avoid'">
							<set_value name="$kAAIT_test_target_isAvoid" exact="$kAAIT_attacker" />
							<include_interrupt_actions ref="kAAIT_AvoidOrNot" />
							<do_if value="@$kAAIT_result_avoidEnemy.isoperational">
								<do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data?">
									<include_interrupt_actions ref="kAAIT_RegisterShip" />
								</do_if>
								<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$target_avoid" exact="$kAAIT_result_avoidEnemy" />
								<include_interrupt_actions ref="kAAIT_Order_Avoid" />
							</do_if>
						</do_if>
						<do_elseif value="$kAAIT_eventType == 'withdraw'">
							<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_attacker: ' + @$kAAIT_attacker.knownname + ', ' + @$kAAIT_attacker.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
							<set_value name="$kAAIT_isInFront" exact="false" />
							<is_in_quadrant result="$kAAIT_isInFront" object="this.assignedcontrolled" target="$kAAIT_attacker" front="true" />
							<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_isInFront: ' + @$kAAIT_isInFront" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
							<debug_text text="this.assignedcontrolled.idcode + ' this.assignedcontrolled.bboxdistanceto.{$kAAIT_attacker}: ' + @this.assignedcontrolled.bboxdistanceto.{$kAAIT_attacker}" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
							<do_if value="
								@$kAAIT_attacker.isclass.station or
								this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m] or
								$kAAIT_isInFront or
								this.assignedcontrolled.bboxdistanceto.{$kAAIT_attacker} le 5km
							">
								<do_if value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl.count">
									<sort_group group="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl" sortbydistanceto="this.assignedcontrolled" sortdescending="false" />
									<do_if value="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl.indexof.{this.assignedcontrolled}">
										<set_value name="$ally" exact="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl.{2}" />
									</do_if>
									<do_else>
										<set_value name="$ally" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl.{1}" />
									</do_else>
								</do_if>
								<debug_text text="this.assignedcontrolled.idcode + ' $ally: ' + @$ally.knownname + ', ' + @$ally.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
								<debug_text text="this.assignedcontrolled.idcode + ' $ally.bboxdistanceto.{$kAAIT_attacker}: ' + @$ally.bboxdistanceto.{$kAAIT_attacker}" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
								<do_if value="
									this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m] or
									(	@$ally != this.assignedcontrolled and
										@$ally.bboxdistanceto.{$kAAIT_attacker} le 10km
									)">
									<do_if value="
										@this.assignedcontrolled.order.id == 'Attack' and
										(not @$DefensibleScript)
									" comment="assumes this is already in an attack run_script set in order.fight.attack.object">
										<abort_called_scripts resume="kAAITLabel_withdraw" />
									</do_if>
									<do_else comment="assumes in any other order with this handler">
										<do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data?">
											<include_interrupt_actions ref="kAAIT_RegisterShip" />
										</do_if>
										<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$target_avoid" exact="$kAAIT_attacker" />
										<include_interrupt_actions ref="kAAIT_Order_Withdraw" />
									</do_else>
								</do_if>
							</do_if>
						</do_elseif>
					</do_if>
				    <remove_value name="$kAAIT_eventType" />
				    <remove_value name="$kAAIT_attacker" />
				    <remove_value name="$kAAIT_skillMult" />
				    <remove_value name="$kAAIT_isPotentialHighRiskEvent" />
				    <remove_value name="$kAAIT_shield_withdrawAt" />
				    <remove_value name="$kAAIT_isActOnEventNow" />
				    <remove_value name="$kAAIT_pathComponent_final" />
				</actions>
			</handler>

			<actions name="kAAIT_AvoidOrNot">
				<!--
					1. if $kAAIT_test_target_isAvoid is set, kAAIT_AvoidOrNot will test if $kAAIT_test_target_isAvoid needs to be avoided.
					   if $kAAIT_test_target_isAvoid is not set, kAAIT_AvoidOrNot will look for high-risk enemies to avoid.
					2. test if a high-risk enemy is in the way of destination or target
					3. if avoiding, look for smaller target
				-->
				<do_if value="(not this.isplayerowned) and (not $kAAITParam_isAvoidHighRisk) and (not $kAAITParam_isStepForwardWithdraw)">
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_AvoidOrNot order: ' + @this.assignedcontrolled.order.id" />
					<debug_text text="this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ====='" />
				</do_if>
				<set_value name="$kAAIT_result_isAvoid" exact="false" />
				<do_if value="
					(not @$kAAIT_data.$isAvoiding)
					and player.age gt @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$time_avoidAllowed">
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_AvoidOrNot $kAAIT_test_target_isAvoid: ' + @$kAAIT_test_target_isAvoid.knownname + ' ' + @$kAAIT_test_target_isAvoid.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
					<set_value name="$kAAIT_isHighRisk" exact="false" />
					<set_value name="$kAAIT_attackTarget" exact="null" />
					<do_if value="
						this.assignedcontrolled.primarypurpose == purpose.fight and
						@this.assignedcontrolled.weapons.all.count and
						@this.assignedcontrolled.weapons.operational.count / (this.assignedcontrolled.weapons.all.count)f gt 0.25
					" comment="do not get attack target unless: (1) fighter and (2) has operational weapons">
						<set_value name="$kAAIT_attackTarget" exact="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget" />
						<do_if value="@$kAAIT_attackTarget.isoperational">
							<set_value name="$kAAIT_isHighRisk" exact="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isTargetHighRisk" />
						</do_if>
						<do_if value="not $kAAIT_attackTarget.isoperational">
							<set_value name="$kAAIT_attackTarget" exact="@$primarytarget" />
						</do_if>
						<do_if value="(not $kAAIT_attackTarget.isoperational) and @$target.hasrelation.enemy.{this.assignedcontrolled}">
							<set_value name="$kAAIT_attackTarget" exact="$target" />
						</do_if>
						<do_if value="@$kAAIT_attackTarget.defensible">
							<set_value name="$kAAIT_attackTarget" exact="$kAAIT_attackTarget.defensible" />
						</do_if>
						<do_if value="not $kAAIT_isHighRisk">
							<set_value name="$kAAIT_test_target_isHighRisk" exact="$kAAIT_attackTarget" />
							<include_interrupt_actions ref="kAAIT_GetIsTargetHighRisk" />
							<set_value name="$kAAIT_isHighRisk" exact="$kAAIT_result_isTargetHighRisk" />
						</do_if>
					</do_if>
					<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_attackTarget: ' + @$kAAIT_attackTarget.knownname + ' ' + @$kAAIT_attackTarget.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
					<do_if value="
						@$kAAIT_test_target_isAvoid.isoperational and
						@$kAAIT_attackTarget.isoperational and
						$kAAIT_test_target_isAvoid == $kAAIT_attackTarget
					">
						<!-- check for other entries of this text: ship will withdraw and fight at these conditions. so cancel withdrawal when required.
							fight: shield gt skill-withdraw-value.
							withdraw: shield gt 5, shield le skill-withdraw-value, distance to target < 10km.
							fight: shield le 5, hull le 50.
						-->
						<set_value name="$kAAIT_isTakeRisk" exact="
							this.assignedcontrolled.bboxdistanceto.{$kAAIT_test_target_isAvoid} le this.assignedcontrolled.maxradarrange and
							this.assignedcontrolled.primarypurpose == purpose.fight and
							(
								(not $kAAIT_isHighRisk) or
								(
									(not $kAAIT_test_target_isAvoid.isclass.station) and
									(not $kAAIT_test_target_isAvoid.isclass.ship)
								) or
								(
									$kAAIT_test_target_isAvoid.isclass.station and
									this.assignedcontrolled.weapons.operational.count / (this.assignedcontrolled.weapons.all.count)f gt 0.25 and
									this.assignedcontrolled.shieldpercentage ge @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_shieldPercentage_withdrawAt_vStation and
									(	this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] or
										(	this.assignedcontrolled.dps.missiles.all and
											this.assignedcontrolled.ammostorage.missile.count
										)
									)
								) or
								(
									$kAAIT_test_target_isAvoid.isclass.ship and
									this.assignedcontrolled.weapons.operational.count / (this.assignedcontrolled.weapons.all.count)f gt 0.25 and
									(
										this.assignedcontrolled.shieldpercentage gt @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_shieldPercentage_withdrawAt_vShip or
										this.assignedcontrolled.bboxdistanceto.{global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget} gt this.assignedcontrolled.maxradarrange * 0.25 or
										(
											this.assignedcontrolled.shieldpercentage le 5 and
											this.assignedcontrolled.hullpercentage le 50
										)
									)
								)
							)" comment="v station: lxl or missiles + shields ok + weapons ok, v ship: shields ok + weapons ok" />
						<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_AvoidOrNot $kAAIT_isTakeRisk: ' + $kAAIT_isTakeRisk" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
						<do_if value="not $kAAIT_isTakeRisk">
							<set_value name="$kAAIT_result_avoidEnemy" exact="$kAAIT_test_target_isAvoid" />
							<set_value name="$kAAIT_result_isAvoid" exact="true" />
						</do_if>
					</do_if>
					<do_elseif value="@$kAAIT_test_target_isAvoid.isoperational">
						<set_value name="$kAAIT_result_avoidEnemy" exact="$kAAIT_test_target_isAvoid" />
						<set_value name="$kAAIT_result_isAvoid" exact="true" />
					</do_elseif>
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_AvoidOrNot kAAIT_result_avoidEnemy (1): ' + @$kAAIT_result_avoidEnemy.knownname + ' ' + @$kAAIT_result_avoidEnemy.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
					<do_if value="not $kAAIT_result_isAvoid" comment="not avoiding target but look for big enemies nearby and avoid any found">
						<include_interrupt_actions ref="kAAIT_GetBigEnemies" />
						<include_interrupt_actions ref="kAAIT_GetIsNearBigEnemies" />
						<do_if value="
							@$kAAIT_result_bigEnemy.isoperational and
							$kAAIT_result_bigEnemy != @$kAAIT_attackTarget">
							<set_value name="$kAAIT_result_avoidEnemy" exact="$kAAIT_result_bigEnemy" />
							<set_value name="$kAAIT_result_isAvoid" exact="true" />
						</do_if>
					</do_if>
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_AvoidOrNot kAAIT_result_avoidEnemy (2): ' + @$kAAIT_result_avoidEnemy.knownname + ' ' + @$kAAIT_result_avoidEnemy.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
					<do_if value="
						$kAAIT_result_isAvoid and
						@$kAAIT_attackTarget.isoperational and
						$kAAIT_result_avoidEnemy != $kAAIT_attackTarget and
						$kAAIT_attackTarget.bboxdistanceto.{$kAAIT_result_avoidEnemy} le this.assignedcontrolled.maxradarrange * 0.25
					" comment="attack target is near avoid enemy, avoid now">
						<!-- calling script should test for $kAAIT_result_isAvoid and avoid $kAAIT_result_avoidEnemy -->
					</do_if>
					<do_else>
						<do_if value="
							$kAAIT_result_isAvoid and
							(	(
									@$kAAIT_attackTarget.isoperational and
									$kAAIT_result_avoidEnemy != @$kAAIT_attackTarget
								) or
								(	$kAAIT_result_avoidEnemy.isclass.station and
									$kAAIT_result_avoidEnemy == @$kAAIT_attackTarget
								)
							)" comment="check if avoid target is in the way of destination ONLY if (1) avoid target is in the way of attack target OR (2) station core is in the way of module target (i.e. $target.defensible is suggestive of a module target)">
							<set_value name="$kAAIT_test_target_isInTheWayOf" exact="null" />
							<do_if value="@$destination">
								<set_value name="$kAAIT_test_target_isInTheWayOf" exact="$destination" />
							</do_if>
							<do_elseif value="@$kAAIT_attackTarget and $kAAIT_attackTarget != $kAAIT_result_avoidEnemy">
								<set_value name="$kAAIT_test_target_isInTheWayOf" exact="$kAAIT_attackTarget" />
							</do_elseif>
							<!-- <do_elseif value="@$primarytarget and $primarytarget != $kAAIT_result_avoidEnemy">
								<set_value name="$kAAIT_test_target_isInTheWayOf" exact="$primarytarget" />
							</do_elseif>
							<do_elseif value="@$target and $target != $kAAIT_result_avoidEnemy">
								<set_value name="$kAAIT_test_target_isInTheWayOf" exact="$target" />
							</do_elseif> -->
							<do_if value="$kAAIT_test_target_isInTheWayOf">
								<set_value name="$kAAIT_test_target_isInTheWay" exact="$kAAIT_result_avoidEnemy" />
								<include_interrupt_actions ref="kAAIT_GetIsTargetInTheWay" />
								<remove_value name="$kAAIT_test_target_isInTheWay" />
								<remove_value name="$kAAIT_test_target_isInTheWayOf" />
								<do_if value="not $kAAIT_result_isTargetInTheWay">
									<remove_value name="$kAAIT_result_avoidEnemy" />
									<set_value name="$kAAIT_result_isAvoid" exact="false" />
								</do_if>
							</do_if>
						</do_if>
						<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_AvoidOrNot kAAIT_result_avoidEnemy (3): ' + @$kAAIT_result_avoidEnemy.knownname + ' ' + @$kAAIT_result_avoidEnemy.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
						<do_if value="
							$kAAIT_result_isAvoid and
							@this.assignedcontrolled.order.$allowothertargets and
							(not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$attackOrder.exists)
						" comment="if avoiding, find smaller target first">
							<set_value name="$kAAIT_bigEnemy" exact="$kAAIT_result_avoidEnemy" />
							<include_interrupt_actions ref="kAAIT_FindSmallerTargetFarFromBigTarget" />
							<do_if value="@$kAAIT_result_target_found.isoperational">
								<remove_value name="$kAAIT_result_avoidEnemy" />
								<set_value name="$kAAIT_result_isAvoid" exact="false" />
								<set_value name="$kAAIT_target_attack" exact="$kAAIT_result_target_found" />
								<include_interrupt_actions ref="kAAIT_Order_AttackOther" />
							</do_if>
							<do_else comment="avoid now">
								<!-- calling script should test for $kAAIT_result_isAvoid and avoid $kAAIT_result_avoidEnemy -->
							</do_else>
						</do_if>
						<do_else comment="avoid now">
							<!-- calling script should test for $kAAIT_result_isAvoid and avoid $kAAIT_result_avoidEnemy -->
						</do_else>
					</do_else>
				</do_if>
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_AvoidOrNot kAAIT_result_avoidEnemy (final): ' + @$kAAIT_result_avoidEnemy.knownname + ' ' + @$kAAIT_result_avoidEnemy.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
			</actions>

			<handler name="kAAIT_Handler_NewBigTarget">
				<conditions>
					<check_any>
						<check_all chance="if @$kAAITParam_iskAAITOrder or @$kAAITParam_isStepForwardWithdraw or (@$kAAITParam_isAvoidHighRisk and this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m]) then 100 else 0">
							<check_any>
								<event_object_signalled object="this.assignedcontrolled" param="'kAAIT_new_big_target'" />
								<event_object_signalled object="this.assignedcontrolled.commander" param="'kAAIT_new_big_target'" check="false" />
							</check_any>
							<set_value name="$kAAIT_attacker" exact="event.param2.$attacker" />
							<set_value name="$kAAIT_signalFrom" exact="event.param2.$from" />
						</check_all>
						<check_all chance="if @$kAAITParam_iskAAITOrder or @$kAAITParam_isStepForwardWithdraw or (@$kAAITParam_isAvoidHighRisk and this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m]) then 100 else 0">
							<check_any>
								<check_all>
									<event_player_alert />
									<check_value value="event.object == this.sector" />
									<set_value name="$kAAIT_attacker" exact="event.param3" />
									<set_value name="$kAAIT_signalFrom" exact="event.name" />
								</check_all>
								<check_all>
									<event_object_signalled object="player.galaxy" param="'kncpr_enemy_report'" />
									<check_value value="event.param2.$enemy.sector == this.sector" />
									<set_value name="$kAAIT_attacker" exact="event.param2.$enemy" />
									<set_value name="$kAAIT_signalFrom" exact="'kncpr_enemy_report'" />
								</check_all>
							</check_any>
							<check_value value="(not @this.assignedcontrolled.toplevelcommander.exists) and @this.assignedcontrolled.subordinates.count" />
						</check_all>
					</check_any>
					<check_value value="this.assignedcontrolled != $kAAIT_signalFrom" />
					<check_value value="not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isAvoiding" comment="not performing kAAIT order" />
					<check_value value="not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isWithdrawing" comment="not performing kAAIT order" />
					<check_all>
						<check_value value="$kAAIT_attacker.isclass.[class.ship_l, class.ship_xl]" />
						<check_any comment="new target needs to be bigger or old target is a station">
							<check_value value="@$kAAIT_attacker.size gt @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget.size" comment="new target is bigger than current target" />
							<check_value value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget.isclass.station" comment="new LXL target is more dangerous than current station target" />
						</check_any>
						<check_all>
							<check_any comment="current order is not attack or is of different target">
								<check_value value="@this.assignedcontrolled.order.id != 'Attack'" />
								<check_value value="@this.assignedcontrolled.order.$primarytarget != $kAAIT_attacker" />
							</check_any>
							<check_any comment="next order is not attack or is of different target">
								<check_value value="@this.assignedcontrolled.orders.{2}.id != 'Attack'" />
								<check_value value="@this.assignedcontrolled.orders.{2}.$primarytarget != $kAAIT_attacker" />
							</check_any>
							<check_value value="@this.assignedcontrolled.orders.{3}.id != 'Attack'" comment="too many attack orders if there's already a 3rd attack order" />
						</check_all>
					</check_all>
				</conditions>
				<actions>
					<do_if value="(not this.isplayerowned) and (not $kAAITParam_isAvoidHighRisk) and (not $kAAITParam_isStepForwardWithdraw)">
						<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_NewBigTarget event.name: ' + event.name + ' order: ' + @this.assignedcontrolled.order.id" />
						<debug_text text="this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ====='" />
					</do_if>
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_NewBigTarget event.name: ' + event.name" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
					<debug_text text="this.assignedcontrolled.idcode + ' ========================== order: ' + @this.assignedcontrolled.order.id" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
					<debug_text text="this.assignedcontrolled.idcode + ' size: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget.size + ' class: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget.class" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
					<debug_text text="this.assignedcontrolled.idcode + ' size: ' + $kAAIT_attacker.size + ' class: ' + $kAAIT_attacker.class" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
					<set_value name="$kAAIT_target_attack" exact="$kAAIT_attacker" />
					<set_value name="$kAAIT_is_attack_order_tactical" exact="
						(
							event.name == 'event_player_alert' or
							(
								event.name == 'event_object_signalled' and
								event.param == 'kncpr_enemy_report'
							)
						) and
						$kAAIT_target_attack.isclass.[class.ship_l, class.ship_xl] and
						this.assignedcontrolled.bboxdistanceto.{$kAAIT_target_attack} gt this.assignedcontrolled.maxradarrange * 0.5
					" />
					<include_interrupt_actions ref="kAAIT_Order_AttackOther" />
				</actions>
			</handler>

			<handler name="kAAIT_Handler_TacticalSubordinateAttack">
				<conditions>
					<check_any>
						<check_all comment="attack events" chance="if @$kAAITParam_iskAAITOrder or @$kAAITParam_isStepForwardWithdraw or (@$kAAITParam_isAvoidHighRisk and this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m]) then 100 else 0">
							<check_any>
								<event_object_attacked object="this.assignedcontrolled" />
								<event_object_attacked_object object="this.assignedcontrolled" />
							</check_any>
							<check_value value="this.assignedcontrolled.isplayerowned" />
							<check_any>
								<check_all>
									<check_value value="event.param == @$kAAITParam_tacticalOrderTarget" />
									<set_value name="$kAAIT_isTacticalTargetAttacked" exact="true" />
								</check_all>
								<check_all>
									<check_value value="event.param.isclass.ship" />
									<check_value value="event.param.size gt this.assignedcontrolled.size * 1.5" />
									<set_value name="$kAAAIT_isNewBigEnemyAttacked" exact="true" />
								</check_all>
							</check_any>
						</check_all>
						<check_all comment="movement events" chance="if @$kAAITParam_iskAAITOrder or @$kAAITParam_isStepForwardWithdraw or (@$kAAITParam_isAvoidHighRisk and this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m]) then 100 else 0">
							<check_any>
								<event_object_changed_zone object="this.assignedcontrolled" />
								<event_object_changed_zone object="if @$kAAITParam_tacticalOrderTarget.isoperational then $kAAITParam_tacticalOrderTarget else null" check="false" />
							</check_any>
							<check_any>
								<check_all comment="target is near">
									<check_value value="@$kAAITParam_tacticalOrderTarget.isoperational" />
									<check_value value="this.assignedcontrolled.bboxdistanceto.{$kAAITParam_tacticalOrderTarget} le this.assignedcontrolled.maxradarrange * 0.5" />
									<set_value name="$kAAIT_isTacticalTargetNear" exact="true" />
								</check_all>
								<check_all comment="no target position recorded">
									<check_value value="@$kAAITParam_tacticalOrderTarget.isoperational" />
									<check_value value="not $kAAIT_pos_tacticatTarget?" />
									<set_value name="$kAAIT_pos_tacticatTarget" exact="$kAAITParam_tacticalOrderTarget.position" />
									<set_value name="$kAAIT_isTacticalTargetMoved" exact="true" />
								</check_all>
								<check_all comment="moved away from recorded target position">
									<check_value value="@$kAAITParam_tacticalOrderTarget.isoperational" />
									<check_value value="$kAAIT_pos_tacticatTarget?" />
									<check_value value="$kAAITParam_tacticalOrderTarget.bboxdistanceto.[$kAAITParam_tacticalOrderTarget.zone, $kAAIT_pos_tacticatTarget] gt this.assignedcontrolled.maxradarrange * 0.25" />
									<set_value name="$kAAIT_pos_tacticatTarget" exact="$kAAITParam_tacticalOrderTarget.position" />
									<set_value name="$kAAIT_isTacticalTargetMoved" exact="true" />
								</check_all>
							</check_any>
						</check_all>
					</check_any>
					<check_value value="@$kAAITParam_tacticalOrderTarget.isoperational" />
				</conditions>
				<actions>
					<do_if value="(not this.isplayerowned) and (not $kAAITParam_isAvoidHighRisk) and (not $kAAITParam_isStepForwardWithdraw)">
						<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_TacticalSubordinateAttack event.name: ' + event.name + ' order: ' + @this.assignedcontrolled.order.id" />
						<debug_text text="this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP =================='" />
					</do_if>
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_TacticalSubordinateAttack event.name: ' + @event.name + ' event.param: ' + @event.param.knownname + ', ' + @event.param.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
					<debug_text text="this.assignedcontrolled.idcode + ' ======================================= order: ' + @this.assignedcontrolled.order.id" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
					<do_if value="@$kAAAIT_isNewBigEnemyAttacked">
						<do_if value="@$kAAITParam_tacticalOrderTarget.isoperational and @$kAAITParam_tacticalOrderTarget.bboxdistanceto.{event.param} le this.assignedcontrolled.maxradarrange * 0.5"
							comment="other big enemy nearby, release all from tactical order and just attack">
							<do_if value="this.assignedcontrolled.commander.isoperational">
								<signal_objects object="this.assignedcontrolled.commander" param="'kAAIT_tactical_just_attack'" param2="table[$eventName = event.name, $eventObject = this.assignedcontrolled, $eventParam = event.param]" />
							</do_if>
						</do_if>
						<do_else comment="release self from tactical order and attack new">
							<set_value name="$kAAIT_target_attack" exact="event.param" />
							<include_interrupt_actions ref="kAAIT_Order_AttackOther" />
						</do_else>
					</do_if>
					<do_elseif value="@$kAAIT_isTacticalTargetAttacked" comment="release all from tactical order and just attack">
						<do_if value="this.assignedcontrolled.commander.isoperational">
							<signal_objects object="this.assignedcontrolled.commander" param="'kAAIT_tactical_just_attack'" param2="table[$eventName = event.name, $eventObject = this.assignedcontrolled, $eventParam = event.param]" />
						</do_if>
					</do_elseif>
					<do_elseif value="@$kAAIT_isTacticalTargetNear" comment="release all from tactical order and just attack">
						<do_if value="this.assignedcontrolled.commander.isoperational">
							<signal_objects object="this.assignedcontrolled.commander" param="'kAAIT_tactical_just_attack'" param2="table[$eventName = event.name, $eventObject = this.assignedcontrolled, $eventParam = event.param]" />
						</do_if>
					</do_elseif>
					<do_elseif value="@$kAAIT_isTacticalTargetMoved" comment="target moved away">
						<do_if value="this.assignedcontrolled.commander.isoperational">
							<signal_objects object="this.assignedcontrolled.commander" param="'kAAIT_tactical_reset_rally_points'" param2="table[$eventName = event.name, $eventObject = this.assignedcontrolled, $eventParam = event.param]" />
						</do_if>
					</do_elseif>
					<remove_value name="$kAAAIT_isNewBigEnemyAttacked" />
					<remove_value name="$kAAIT_isTacticalTargetAttacked" />
					<remove_value name="$kAAIT_isTacticalTargetNear" />
					<remove_value name="$kAAIT_isTacticalTargetMoved" />
				</actions>
			</handler>

			<!--
				88  88 888888 88     88""Yb 888888 88""Yb .dP"Y8
				88  88 88__   88     88__dP 88__   88__dP `Ybo."
				888888 88""   88  .o 88"""  88""   88"Yb  o.`Y8b
				88  88 888888 88ood8 88     888888 88  Yb 8bodP'
			 -->
			<actions name="kAAIT_GetCombatRange">
				<do_if value="(not this.isplayerowned) and (not $kAAITParam_isAvoidHighRisk) and (not $kAAITParam_isStepForwardWithdraw)">
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetCombatRange event.name: ' + event.name + ' order: ' + @this.assignedcontrolled.order.id" />
					<debug_text text="this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP =================='" />
				</do_if>
				<do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data?">
					<include_interrupt_actions ref="kAAIT_RegisterShip" />
				</do_if>
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$combatRange_max" exact="[
					this.assignedcontrolled.maxcombatrange.primary,
					this.assignedcontrolled.maxcombatrange.secondary,
					this.assignedcontrolled.maxcombatrange.lasers.all,
					this.assignedcontrolled.maxcombatrange.missiles.all,
					this.assignedcontrolled.maxcombatrange.turrets,
				].max * 0.9" />
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$combatRange_min" exact="[
					this.assignedcontrolled.maxcombatrange.primary,
					this.assignedcontrolled.maxcombatrange.secondary,
					this.assignedcontrolled.maxcombatrange.lasers.all,
					this.assignedcontrolled.maxcombatrange.missiles.all,
					this.assignedcontrolled.maxcombatrange.turrets,
				].min * 0.9" />
				<do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$combatRange_min">
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$combatRange_min" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$combatRange_max * 0.4" />
				</do_if>
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$combatRange_mid" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$combatRange_min + (global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$combatRange_max - global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$combatRange_min) * 0.5" />
			</actions>

			<actions name="kAAIT_GetIsTargetHighRisk" comment="also update 'get is avoid or withdraw now' conditions in different handlers">
				<do_if value="(not this.isplayerowned) and (not $kAAITParam_isAvoidHighRisk) and (not $kAAITParam_isStepForwardWithdraw)">
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetIsTargetHighRisk order: ' + @this.assignedcontrolled.order.id" />
					<debug_text text="this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ====='" />
				</do_if>
				<do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data?">
					<include_interrupt_actions ref="kAAIT_RegisterShip" />
				</do_if>
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetIsTargetHighRisk $kAAIT_test_target_isHighRisk.isoperational: ' + @$kAAIT_test_target_isHighRisk.isoperational + ' ' + @$kAAIT_test_target_isHighRisk.knownname + ' ' + @$kAAIT_test_target_isHighRisk.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				<set_value name="$kAAIT_result_isTargetHighRisk" exact="false" />
				<do_if value="@$kAAIT_test_target_isHighRisk.defensible">
					<set_value name="$kAAIT_test_target_isHighRisk" exact="$kAAIT_test_target_isHighRisk.defensible" />
				</do_if>
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetIsTargetHighRisk $kAAIT_test_target_isHighRisk (defensible).isoperational: ' + @$kAAIT_test_target_isHighRisk.isoperational + ' ' + @$kAAIT_test_target_isHighRisk.knownname + ' ' + @$kAAIT_test_target_isHighRisk.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				<do_if value="@$kAAIT_test_target_isHighRisk.isoperational">
					<do_if value="not @$kAAIT_target_highRiskEntity.exists">
						<set_value name="$kAAIT_target_highRiskEntity" exact="@$kAAIT_test_target_isHighRisk.assignedaipilot" />
						<do_if value="not @$kAAIT_target_highRiskEntity.exists">
							<set_value name="$kAAIT_target_highRiskEntity" exact="@$kAAIT_test_target_isHighRisk.defencenpc" />
						</do_if>
					</do_if>
					<do_if value="not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isSkillsSet">
						<include_interrupt_actions ref="kAAIT_GetSkillVars" />
					</do_if>
					<do_if value="this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m]">
						<set_value name="$kAAIT_isTargetPotentialHighRisk" exact="
							$kAAIT_test_target_isHighRisk.dps.all and
							(
								$kAAIT_test_target_isHighRisk.isclass.station or
								(
									$kAAIT_test_target_isHighRisk.size gt this.assignedcontrolled.size * 1.5 and
									$kAAIT_test_target_isHighRisk.primarypurpose == purpose.fight
								)
							)
						" />
						<do_if value="$kAAIT_test_target_isHighRisk.isclass.station">
							<set_value name="$kAAIT_gunCount" exact="
								@$kAAIT_test_target_isHighRisk.weapons.operational.count + 
								[@$kAAIT_test_target_isHighRisk.weapons.operational.count, @$kAAIT_test_target_isHighRisk.turrets.operational.count].max
							" />
						</do_if>
						<do_else>
							<set_value name="$kAAIT_gunCount" exact="@$kAAIT_test_target_isHighRisk.weapons.operational.count" />
						</do_else>
						<!-- <debug_text text="''" /> -->
						<!-- <debug_text text="''" /> -->
						<!-- <debug_text text="''" /> -->
						<debug_text text="this.assignedcontrolled.idcode + ' @$kAAIT_target_highRiskEntity.$kAAIT_attackers.count (' + @$kAAIT_target_highRiskEntity.$kAAIT_attackers.count + ') * $skill_attackers_count_mult (' + global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_attackers_count_mult + '): ' + (@$kAAIT_target_highRiskEntity.$kAAIT_attackers.count * global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_attackers_count_mult)" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
						<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_gunCount (' + $kAAIT_gunCount + ') * global.$kAAIT_Data.$xss_outnumberVShips (' + global.$kAAIT_Data.$xss_outnumberVShips + ') / 100.0: ' + ($kAAIT_gunCount * global.$kAAIT_Data.$xss_outnumberVShips / 100.0)" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
						<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_gunCount (' + $kAAIT_gunCount + ') * global.$kAAIT_Data.$xss_outnumberVStations (' + global.$kAAIT_Data.$xss_outnumberVStations + ') / 100.0: ' + ($kAAIT_gunCount * global.$kAAIT_Data.$xss_outnumberVStations / 100.0)" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
						<set_value name="$kAAIT_result_isTargetPotentialHighRisk" exact="$kAAIT_isTargetPotentialHighRisk" />
						<set_value name="$kAAIT_result_isTargetHighRisk" exact="
							$kAAIT_isTargetPotentialHighRisk and
							(
								(
									$kAAIT_test_target_isHighRisk.isclass.station or
									this.assignedcontrolled.hullpercentage le 25
								) or
								(
									@$kAAIT_test_target_isHighRisk.hullpercentage lt 1 and
									@$kAAIT_target_highRiskEntity.$kAAIT_attackers_lxl.count
								) or
								(
									(
										this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s] or
										this.assignedcontrolled.primarypurpose != purpose.fight
									) and
									@$kAAIT_test_target_isHighRisk.isclass.ship and
									@$kAAIT_target_highRiskEntity.$kAAIT_attackers.count * global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_attackers_count_mult le $kAAIT_gunCount * global.$kAAIT_Data.$xss_outnumberVShips / 100.0
								) or
								(
									(
										this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s] or
										this.assignedcontrolled.primarypurpose != purpose.fight
									) and
									@$kAAIT_test_target_isHighRisk.isclass.station and
									@$kAAIT_target_highRiskEntity.$kAAIT_attackers.count * global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_attackers_count_mult le $kAAIT_gunCount * global.$kAAIT_Data.$xss_outnumberVStations / 100.0
								) or
								(
									this.assignedcontrolled.isclass.ship_m and
									@$kAAIT_test_target_isHighRisk.isclass.ship and
									@$kAAIT_target_highRiskEntity.$kAAIT_attackers.count * global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_attackers_count_mult le $kAAIT_gunCount * global.$kAAIT_Data.$m_outnumberVShips / 100.0
								) or
								(
									this.assignedcontrolled.isclass.ship_m and
									@$kAAIT_test_target_isHighRisk.isclass.station and
									@$kAAIT_target_highRiskEntity.$kAAIT_attackers.count * global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_attackers_count_mult le $kAAIT_gunCount * global.$kAAIT_Data.$m_outnumberVStations / 100.0
								)
							)
						"/>
					</do_if>
					<do_elseif value="this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl]">
						<set_value name="$kAAIT_isTargetPotentialHighRisk" exact="
							$kAAIT_test_target_isHighRisk.dps.all and
							(
								$kAAIT_test_target_isHighRisk.isclass.station or
								(
									$kAAIT_test_target_isHighRisk.size gt this.assignedcontrolled.size * 1.5 and
									$kAAIT_test_target_isHighRisk.primarypurpose == purpose.fight
								)
							)
						" />
						<set_value name="$kAAIT_result_isTargetPotentialHighRisk" exact="$kAAIT_isTargetPotentialHighRisk" />
						<set_value name="$kAAIT_result_isTargetHighRisk" exact="
							$kAAIT_isTargetPotentialHighRisk and
							(	this.assignedcontrolled.primarypurpose != purpose.fight or
								$kAAIT_test_target_isHighRisk.dps.all gt this.assignedcontrolled.dps.all * 1.25
							)
						" />
					</do_elseif>
				</do_if>
				<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_isTargetPotentialHighRisk: ' + @$kAAIT_isTargetPotentialHighRisk + ' $kAAIT_result_isTargetHighRisk: ' + @$kAAIT_result_isTargetHighRisk" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
			</actions>

			<actions name="kAAIT_GetBigEnemies">
				<do_if value="(not this.isplayerowned) and (not $kAAITParam_isAvoidHighRisk) and (not $kAAITParam_isStepForwardWithdraw)">
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetBigEnemies order: ' + @this.assignedcontrolled.order.id" />
					<debug_text text="this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ====='" />
				</do_if>
				<do_if value="
					(not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$bigEnemies.count) or
					@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$bigEnemies.{1}.bboxdistanceto.{this.assignedcontrolled} gt this.assignedcontrolled.maxradarrange">
					<do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data?">
						<include_interrupt_actions ref="kAAIT_RegisterShip" />
					</do_if>
					<create_group groupname="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$bigEnemies" />
					<find_gravidar_contact groupname="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$bigEnemies" object="this.assignedcontrolled" class="[class.ship_l, class.ship_xl, class.station]" docked="false" functional="true" maybeattackedby="this.assignedcontrolled" multiple="true" chance="if @this.sector.macro then 100 else 0">
						<match_context macro="[@this.sector.macro]"/>
						<match class="class.buildstorage" negate="true"/>
						<match state="componentstate.wreck" negate="true"/>
						<match_relation_to object="this.assignedcontrolled" relation="enemy" comparison="le" />
						<!-- <match_distance max="this.assignedcontrolled.currentradarrange * 0.5" object="this.assignedcontrolled" /> -->
					</find_gravidar_contact>
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetBigEnemies $bigEnemies.count (find_gravidar_contact): ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$bigEnemies.count" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
					<do_if value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget.isclass.[class.ship_l, class.ship_xl, class.station]">
						<add_to_group groupname="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$bigEnemies" object="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget" />
						<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetBigEnemies $bigEnemies.count (added $defensibleTarget): ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$bigEnemies.count" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
					</do_if>
					<sort_group group="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$bigEnemies" sortbyvalue="this.assignedcontrolled.bboxdistanceto.{loop.element}" sortdescending="false" />
				</do_if>
				<do_else>
					<sort_group group="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$bigEnemies" sortbyvalue="this.assignedcontrolled.bboxdistanceto.{loop.element}" sortdescending="false" />
				</do_else>
				<set_value name="$kAAIT_bigEnemies_indexOf" exact="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$bigEnemies.indexof.{this.assignedcontrolled}" />
				<!-- <do_if value="$kAAIT_bigEnemies_indexOf gt 0">
					<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_bigEnemies_indexOf: ' + $kAAIT_bigEnemies_indexOf" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
					<remove_from_group group="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$bigEnemies" object="this.assignedcontrolled" />
				</do_if> -->
				<do_for_each name="$kAAIT_bigEnemy_inList" in="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$bigEnemies">
					<do_if value="not $kAAIT_bigEnemy_inList.hasrelation.enemy.{this.assignedcontrolled}">
						<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_bigEnemy_inList: ' + $kAAIT_bigEnemy_inList + ' not enemy'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
						<remove_from_group group="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$bigEnemies" object="$kAAIT_bigEnemy_inList" />
					</do_if>
				</do_for_each>
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetBigEnemies $bigEnemies.count (final): ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$bigEnemies.count" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
			</actions>

			<actions name="kAAIT_GetIsNearBigEnemies">
				<do_if value="(not this.isplayerowned) and (not $kAAITParam_isAvoidHighRisk) and (not $kAAITParam_isStepForwardWithdraw)">
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetIsNearBigEnemies order: ' + @this.assignedcontrolled.order.id" />
					<debug_text text="this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ====='" />
				</do_if>
				<set_value name="$kAAIT_result_isShipNearBigEnemy" exact="false" />
				<set_value name="$kAAIT_result_isTargetNearBigEnemy" exact="false" />
				<set_value name="$kAAIT_result_bigEnemy" exact="null" />
				<do_if value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$bigEnemies.count">
					<do_for_each name="$kAAIT_bigEnemy_inList" in="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$bigEnemies">
						<!-- <do_if value="$kAAIT_bigEnemy_inList != @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget"> -->
							<do_if value="$kAAIT_bigEnemy_inList.bboxdistanceto.{this.assignedcontrolled} le this.assignedcontrolled.maxradarrange * 0.5">
								<set_value name="$kAAIT_result_isShipNearBigEnemy" exact="true" />
							</do_if>
							<do_if value="$kAAIT_bigEnemy_inList != @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget">
								<do_if value="
									(
										@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget.isoperational and
										$kAAIT_bigEnemy_inList.bboxdistanceto.{global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget} le this.assignedcontrolled.maxradarrange * 0.5
									) or
									(
										@$target.isoperational and
										$kAAIT_bigEnemy_inList.bboxdistanceto.{$target} le this.assignedcontrolled.maxradarrange * 0.5
									)
								">
									<set_value name="$kAAIT_result_isTargetNearBigEnemy" exact="true" />
								</do_if>
							</do_if>
							<do_if value="$kAAIT_result_isShipNearBigEnemy or $kAAIT_result_isTargetNearBigEnemy">
								<set_value name="$kAAIT_result_bigEnemy" exact="$kAAIT_bigEnemy_inList" />
								<break />
							</do_if>
						<!-- </do_if> -->
					</do_for_each>
				</do_if>
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetIsNearBigEnemies $kAAIT_result_isShipNearBigEnemy: ' + $kAAIT_result_isShipNearBigEnemy + ' $kAAIT_result_isTargetNearBigEnemy: ' + $kAAIT_result_isTargetNearBigEnemy" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetIsNearBigEnemies $kAAIT_result_bigEnemy: ' + @$kAAIT_result_bigEnemy.knownname + ' ' + @$kAAIT_result_bigEnemy.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
			</actions>

			<actions name="kAAIT_FindSmallerTargetFarFromBigTarget">
				<do_if value="(not this.isplayerowned) and (not $kAAITParam_isAvoidHighRisk) and (not $kAAITParam_isStepForwardWithdraw)">
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_FindSmallerTargetFarFromBigTarget order: ' + @this.assignedcontrolled.order.id" />
					<debug_text text="this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP =================='" />
				</do_if>
				<set_value name="$kAAIT_result_target_found" exact="null" />
				<do_if value="
					this.assignedcontrolled.dps.all and
					this.assignedcontrolled.primarypurpose == purpose.fight and
					(not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$attackOrder.exists)">
					<find_gravidar_contact name="$kAAIT_smallTargets" object="this.assignedcontrolled" class="[class.ship_xs, class.ship_s, class.ship_m]" docked="false" functional="true" maybeattackedby="this.assignedcontrolled" sortbydistanceto="this.assignedcontrolled" multiple="true">
						<match_context macro="[@this.sector.macro]"/>
						<match class="class.buildstorage" negate="true"/>
						<match state="componentstate.wreck" negate="true"/>
						<match_distance min="this.assignedcontrolled.currentradarrange * 0.25" max="this.assignedcontrolled.currentradarrange" object="$kAAIT_bigEnemy" />
					</find_gravidar_contact>
					<sort_list list="$kAAIT_smallTargets" sortbyvalue="loop.element.size" sortdescending="false" />
					<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_smallTargets: ' + @$kAAIT_smallTargets.count" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
					<set_value name="$kAAIT_result_target_found" exact="@$kAAIT_smallTargets.{1}" />
					<do_if value="@$kAAIT_result_target_found.isoperational and $kAAIT_result_target_found.size le this.assignedcontrolled.size * 1.5">
						<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_result_target_found (pre obstruction test): ' + @$kAAIT_result_target_found" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
						<do_if value="$kAAIT_result_target_found.bboxdistanceto.{$kAAIT_bigEnemy} gt this.assignedcontrolled.bboxdistanceto.{$kAAIT_bigEnemy}" comment="because this is circling a big target already, any object farther away would put the big target in the way">
							<set_value name="$kAAIT_result_target_found" exact="null" />
						</do_if>
						<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_result_target_found (post-obstruction test): ' + @$kAAIT_result_target_found" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
					</do_if>
				</do_if>
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_FindSmallerTargetFarFromBigTarget $kAAIT_result_target_found: ' + @$kAAIT_result_target_found.knownname + ' ' + @$kAAIT_result_target_found.idcode + ' size: ' + @$kAAIT_result_target_found.size + ' weapons: ' + @$kAAIT_result_target_found.weapons.operational.count" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
			</actions>

			<actions name="kAAIT_GetSkillVars" comment="also update 'get is avoid or withdraw now' conditions in different handlers">
				<do_if value="(not this.isplayerowned) and (not $kAAITParam_isAvoidHighRisk) and (not $kAAITParam_isStepForwardWithdraw)">
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetSkillVars order: ' + @this.assignedcontrolled.order.id" />
					<debug_text text="this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ====='" />
				</do_if>
				<do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data?">
					<include_interrupt_actions ref="kAAIT_RegisterShip" />
				</do_if>
				<do_if value="global.$kAAIT_Data.$isUseNPCSkills">
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_attackers_count_mult" exact="2 - (this.skill.piloting + this.skill.morale) / 30.0 * 1" comment="0 = * 2, 5 = * 1" />
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_distance_engagePosition_mult" exact="0.75 + (this.skill.piloting + this.skill.morale) / 30.0 * 0.25" comment="combat range max * (0 = * 0.75, 5 = 1)" />
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_distance_stepForward_mult" exact="2 - (this.skill.piloting + this.skill.morale) / 30.0 * 1" comment="count of step forwards * (0 = 2km, 5 = 1km)" />
					<do_if value="this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m]">
						<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_shieldPercentage_withdrawAt_vShip" exact="75 + (this.skill.piloting + this.skill.morale) / 30.0 * 15" comment="0 = 75, 5 = 90" />
						<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_shieldPercentage_withdrawAt_vStation" exact="75 + (this.skill.piloting + this.skill.morale) / 30.0 * 15" comment="0 = 75, 5 = 90" />
					</do_if>
					<do_elseif value="this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl]">
						<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_shieldPercentage_withdrawAt_vShip" exact="75 + (this.skill.piloting + this.skill.morale) / 30.0 * 15" comment="0 = 75, 5 = 90" />
						<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_shieldPercentage_withdrawAt_vStation" exact="75 + (this.skill.piloting + this.skill.morale) / 30.0 * 15" comment="0 = 75, 5 = 90" />
					</do_elseif>
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_distance_withdraw" exact="this.assignedcontrolled.maxradarrange * (0.35 + (this.skill.piloting + this.skill.morale) / 30.0 * 0.15)" comment="0 = * 0.35, 5 = * 0.5" />
				</do_if>
				<do_else>
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_attackers_count_mult" exact="1" />
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_distance_engagePosition_mult" exact="1" />
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_distance_stepForward_mult" exact="1" />
					<do_if value="this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m]">
						<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_shieldPercentage_withdrawAt_vShip" exact="90" />
						<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_shieldPercentage_withdrawAt_vStation" exact="90" />
					</do_if>
					<do_elseif value="this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl]">
						<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_shieldPercentage_withdrawAt_vShip" exact="25" />
						<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_shieldPercentage_withdrawAt_vStation" exact="90" />
					</do_elseif>
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$skill_distance_withdraw" exact="this.assignedcontrolled.maxradarrange * 0.5" />
				</do_else>
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isSkillsSet" exact="true" />
			</actions>

			<actions name="kAAIT_GetEscortPos">
				<do_if value="(not this.isplayerowned) and (not $kAAITParam_isAvoidHighRisk) and (not $kAAITParam_isStepForwardWithdraw)">
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetEscortPos order: ' + @this.assignedcontrolled.order.id" />
					<debug_text text="this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ====='" />
				</do_if>
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetEscortPos'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				<create_position name="$kAAIT_pos_self" space="this.sector" object="this.assignedcontrolled" />
				<create_position name="$kAAIT_pos_escort" space="this.sector" object="$kAAIT_target_escort" />
				<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_target_escort: ' + $kAAIT_target_escort.knownname + ' ' + $kAAIT_target_escort.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				<create_orientation name="$kAAIT_rot_fromEscort" orientation="look_at" refposition="$kAAIT_pos_self">
					<position value="$kAAIT_pos_escort" />
				</create_orientation>
				<set_value name="$kAAIT_yaw_fromEscort" exact="$kAAIT_rot_fromEscort.yaw * 180 / pi" />
				<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_yaw_fromEscort: ' + $kAAIT_yaw_fromEscort" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				<set_value name="$kAAIT_pitch_fromEscort" exact="$kAAIT_rot_fromEscort.pitch * 180 / pi" />
				<set_value name="$kAAIT_escortEnemy" exact="null" />
				<do_if value="@global.$kAAITByShipId.{'$' + $kAAIT_target_escort.idcode}.$kAAIT_data.$defensibleTarget.isoperational">
					<set_value name="$kAAIT_escortEnemy" exact="global.$kAAITByShipId.{'$' + $kAAIT_target_escort.idcode}.$kAAIT_data.$defensibleTarget" />
				</do_if>
				<do_elseif value="@$kAAIT_target_escort.order.$primarytarget.isoperational">
					<set_value name="$kAAIT_escortEnemy" exact="$kAAIT_target_escort.order.$primarytarget" />
				</do_elseif>
				<do_elseif value="@$kAAIT_target_escort.nextorder.$primarytarget.isoperational">
					<set_value name="$kAAIT_escortEnemy" exact="$kAAIT_target_escort.nextorder.$primarytarget" />
				</do_elseif>
				<do_elseif value="@$kAAIT_target_escort.order.$selectedtarget.isoperational">
					<set_value name="$kAAIT_escortEnemy" exact="$kAAIT_target_escort.order.$selectedtarget" />
				</do_elseif>
				<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_escortEnemy: ' + @$kAAIT_escortEnemy.knownname + ' ' + @$kAAIT_escortEnemy.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				<do_if value="$kAAIT_escortEnemy">
					<create_position name="$kAAIT_pos_escortEnemy" space="this.sector" object="$kAAIT_escortEnemy" />
					<create_orientation name="$kAAIT_rot_fromEnemyToEscort" orientation="look_at" refposition="$kAAIT_pos_escort">
						<position value="$kAAIT_pos_escortEnemy" />
					</create_orientation>
					<set_value name="$kAAIT_result_yawDeg" exact="$kAAIT_rot_fromEnemyToEscort.yaw * 180 / pi" />
					<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_result_yawDeg: ' + $kAAIT_result_yawDeg" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
					<set_value name="$kAAIT_result_pitchDeg" exact="$kAAIT_rot_fromEnemyToEscort.pitch * 180 / pi" />
					<set_value name="$kAAIT_index_self" exact="$kAAIT_target_escort.subordinates.indexof.{this.assignedcontrolled}" />
					<set_value name="$kAAIT_maxAngle" exact="45" />
					<do_if value="$kAAIT_target_escort.subordinates.count gt 1">
						<set_value name="$kAAIT_angleForOneShip" exact="$kAAIT_maxAngle * 2 / ($kAAIT_target_escort.subordinates.count - 1)f" />
					</do_if>
					<do_else>
						<set_value name="$kAAIT_angleForOneShip" exact="5" />
					</do_else>
					<set_value name="$kAAIT_yaw_adj" exact="($kAAIT_maxAngle * -1) + (($kAAIT_index_self - 1) * $kAAIT_angleForOneShip)" />
					<set_value name="$kAAIT_result_yawDeg" operation="add" exact="$kAAIT_yaw_adj" />
				</do_if>
				<do_else>
					<set_value name="$kAAIT_result_yawDeg" exact="$kAAIT_yaw_fromEscort" />
					<set_value name="$kAAIT_result_pitchDeg" exact="$kAAIT_pitch_fromEscort" />
				</do_else>
				<set_value name="$kAAIT_result_yawRad" exact="$kAAIT_result_yawDeg * pi / 180" />
				<set_value name="$kAAIT_result_pitchRad" exact="$kAAIT_result_pitchDeg * pi / 180" />
				<create_position name="$kAAIT_result_pos_escort"
					x="$kAAIT_pos_escort.x + 10km * sin ($kAAIT_result_yawRad) * cos ($kAAIT_result_pitchRad)"
					y="$kAAIT_pos_escort.y + 10km * sin ($kAAIT_result_pitchRad)"
					z="$kAAIT_pos_escort.z + 10km * cos ($kAAIT_result_yawRad) * cos ($kAAIT_result_pitchRad)"/>
				<!-- <do_if value="$kAAIT_pos_escortEnemy">
					<create_orientation name="$kAAIT_rot_fromEnemyToEscort" orientation="look_at" refposition="$kAAIT_result_pos_escort">
						<position value="$kAAIT_pos_escortEnemy" />
					</create_orientation>
					<set_value name="$kAAIT_yaw_final" exact="$kAAIT_rot_fromEnemyToEscort.yaw * 180 / pi" />
					<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_yaw_final: ' + $kAAIT_yaw_final" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				</do_if> -->
			</actions>

			<actions name="kAAIT_GetIsTargetInTheWay">
				<do_if value="(not this.isplayerowned) and (not $kAAITParam_isAvoidHighRisk) and (not $kAAITParam_isStepForwardWithdraw)">
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetIsTargetInTheWay order: ' + @this.assignedcontrolled.order.id" />
					<debug_text text="this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ====='" />
				</do_if>
				<!-- <do_if value="not @$kAAIT_space_getGlobalPath or this.assignedcontrolled.bboxdistanceto.[$kAAIT_space_getGlobalPath, $kAAIT_position_getGlobalPath] gt this.assignedcontrolled.maxradarrange"> -->
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetIsTargetInTheWay $kAAIT_test_target_isInTheWay: ' + @$kAAIT_test_target_isInTheWay.knownname + ' ' + @$kAAIT_test_target_isInTheWay.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetIsTargetInTheWay $kAAIT_test_target_isInTheWayOf: ' + @$kAAIT_test_target_isInTheWayOf.knownname + ' ' + @$kAAIT_test_target_isInTheWayOf.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				<set_value name="$kAAIT_result_isTargetInTheWay" exact="false" />
				<do_if value="(typeof $kAAIT_test_target_isInTheWayOf) == datatype.component">
					<do_if value="(not @$kAAIT_space_getGlobalPath) or this.sector != $kAAIT_space_getGlobalPath">
						<set_value name="$kAAIT_space_getGlobalPath" exact="this.sector" />
						<create_position name="$kAAIT_position_getGlobalPath" object="this.assignedcontrolled" />
						<set_value name="$kAAIT_dist_toTarget" exact="this.assignedcontrolled.bboxdistanceto.{$kAAIT_test_target_isInTheWay}" />
						<get_global_path component="$kAAIT_pathComponents" uselocalhighways="true" multiple="true">
							<start object="this.assignedcontrolled" />
							<end object="$kAAIT_test_target_isInTheWayOf" />
						</get_global_path>
					</do_if>
					<do_if value="$kAAIT_pathComponents.count">
						<set_value name="$kAAIT_pathComponent" exact="$kAAIT_pathComponents.{1}" />
						<do_if value="$kAAIT_pathComponent == this.assignedcontrolled">
							<set_value name="$kAAIT_pathComponent" exact="$kAAIT_pathComponents.{2}" />
						</do_if>
					</do_if>
					<do_else>
						<set_value name="$kAAIT_pathComponent" exact="$kAAIT_test_target_isInTheWayOf" />
					</do_else>
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetIsTargetInTheWay $kAAIT_pathComponent: ' + @$kAAIT_pathComponent.knownname + ' (' + $kAAIT_pathComponent.class + ') ' + @$kAAIT_pathComponent.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
					<do_if value="$kAAIT_pathComponent == this.sector or @$kAAIT_pathComponent.sector == this.sector">
						<create_position name="$kAAIT_pos_self" space="this.sector" object="this.assignedcontrolled" />
						<create_position name="$kAAIT_pos_enemy" space="this.sector" object="$kAAIT_test_target_isInTheWay" />
						<set_value name="$kAAIT_dist_toEnemy" exact="this.assignedcontrolled.bboxdistanceto.[this.sector, $kAAIT_pos_enemy]" />
						<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetIsTargetInTheWay $kAAIT_dist_toEnemy: ' + @$kAAIT_dist_toEnemy" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
						<create_orientation name="$kAAIT_rot_toEnemy" orientation="look_at" refposition="$kAAIT_pos_enemy">
							<position value="$kAAIT_pos_self" />
						</create_orientation>
						<set_value name="$kAAIT_yaw_toEnemy" exact="$kAAIT_rot_toEnemy.yaw * 180 / pi" />
						<do_if value="@$kAAIT_pathComponent.sector == this.sector">
							<create_position name="$kAAIT_pos_dest" space="this.sector" object="$kAAIT_pathComponent" />
							<set_value name="$kAAIT_dist_toDest" exact="this.assignedcontrolled.bboxdistanceto.{$kAAIT_pathComponent}" />
							<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetIsTargetInTheWay $kAAIT_dist_toDest ($kAAIT_pathComponent): ' + @$kAAIT_dist_toDest" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
						</do_if>
						<do_elseif value="@$destination and @$position">
							<create_position name="$kAAIT_pos_dest" space="this.sector" object="$destination" value="$position" />
							<set_value name="$kAAIT_dist_toDest" exact="this.assignedcontrolled.bboxdistanceto.[$destination, $position]" />
							<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetIsTargetInTheWay $kAAIT_dist_toDest (MoveGeneric $destination): ' + @$kAAIT_dist_toDest" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
						</do_elseif>
						<do_elseif value="@$positionspace and @$position">
							<create_position name="$kAAIT_pos_dest" space="this.sector" object="$positionspace" value="$position" />
							<set_value name="$kAAIT_dist_toDest" exact="this.assignedcontrolled.bboxdistanceto.[$positionspace, $position]" />
							<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetIsTargetInTheWay $kAAIT_dist_toDest (MoveGeneric $positionspace): ' + @$kAAIT_dist_toDest" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
						</do_elseif>
						<do_elseif value="@$target and @$position">
							<create_position name="$kAAIT_pos_dest" space="this.sector" object="$target" value="$position" />
							<set_value name="$kAAIT_dist_toDest" exact="this.assignedcontrolled.bboxdistanceto.[$target, $position]" />
							<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetIsTargetInTheWay $kAAIT_dist_toDest ($target and $position): ' + @$kAAIT_dist_toDest" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
						</do_elseif>
						<do_elseif value="@$target">
							<create_position name="$kAAIT_pos_dest" space="this.sector" object="$target" />
							<set_value name="$kAAIT_dist_toDest" exact="this.assignedcontrolled.bboxdistanceto.{$target}" />
							<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetIsTargetInTheWay $kAAIT_dist_toDest ($target): ' + @$kAAIT_dist_toDest" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
						</do_elseif>
						<!-- <do_elseif value="@$position">
							<create_position name="$kAAIT_pos_dest" space="this.sector" object="$kAAIT_pathComponent" value="$position" />
							<set_value name="$kAAIT_dist_toDest" exact="this.assignedcontrolled.bboxdistanceto.[this.sector, $kAAIT_pos_dest]" />
							<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetIsTargetInTheWay $kAAIT_dist_toDest (position): ' + @$kAAIT_dist_toDest" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
						</do_elseif>
						<do_else>
							<create_position name="$kAAIT_pos_dest" space="this.sector" object="$kAAIT_pathComponent" />
							<set_value name="$kAAIT_dist_toDest" exact="this.assignedcontrolled.bboxdistanceto.{$kAAIT_pathComponent}" />
							<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetIsTargetInTheWay $kAAIT_dist_toDest (no position): ' + @$kAAIT_dist_toDest" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
						</do_else> -->
						<create_orientation name="$kAAIT_rot_toDest" orientation="look_at" refposition="$kAAIT_pos_dest">
							<position value="$kAAIT_pos_self" />
						</create_orientation>
						<set_value name="$kAAIT_yaw_toDest" exact="$kAAIT_rot_toDest.yaw * 180 / pi" />
						<set_value name="$kAAIT_yaw_diff" exact="$kAAIT_yaw_toDest - $kAAIT_yaw_toEnemy" />
						<set_value name="$kAAIT_isBothInFront" exact="$kAAIT_yaw_diff gt -45 and $kAAIT_yaw_diff lt 45" />
						<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetIsTargetInTheWay $kAAIT_isBothInFront: ' + @$kAAIT_isBothInFront" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
						<do_if value="$kAAIT_isBothInFront and $kAAIT_dist_toEnemy lt $kAAIT_dist_toDest">
							<set_value name="$kAAIT_result_isTargetInTheWay" exact="true" />
						</do_if>
					</do_if>
					<do_else>
						<set_value name="$kAAIT_result_isTargetInTheWay" exact="false" />
					</do_else>
				</do_if>
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetIsTargetInTheWay $kAAIT_result_isTargetInTheWay: ' + @$kAAIT_result_isTargetInTheWay" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
			</actions>

			<!--
				 dP"Yb  88""Yb 8888b.  888888 88""Yb .dP"Y8
				dP   Yb 88__dP  8I  Yb 88__   88__dP `Ybo."
				Yb   dP 88"Yb   8I  dY 88""   88"Yb  o.`Y8b
				 YbodP  88  Yb 8888Y"  888888 88  Yb 8bodP'
			 -->
			<actions name="kAAIT_CleanOrders">
				<do_if value="(not this.isplayerowned) and (not $kAAITParam_isAvoidHighRisk) and (not $kAAITParam_isStepForwardWithdraw)">
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_CleanOrders order: ' + @this.assignedcontrolled.order.id" />
					<debug_text text="this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ====='" />
				</do_if>
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_CleanOrders order: ' + @this.assignedcontrolled.order.id" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				<do_for_each name="$kAAIT_order" in="this.assignedcontrolled.orders" counter="$i" reverse="true">
					<do_if value="@$kAAIT_order.$kAAITParam_iskAAITOrder" comment="cancel other move.kuertee.*.xml order">
						<debug_text text="this.assignedcontrolled.idcode + ' cancel_order ' + $kAAIT_order.id" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
						<cancel_order order="$kAAIT_order" />
					</do_if>
				</do_for_each>
			</actions>

			<actions name="kAAIT_Order_AttackOther">
				<do_if value="(not this.isplayerowned) and (not $kAAITParam_isAvoidHighRisk) and (not $kAAITParam_isStepForwardWithdraw)">
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Order_AttackOther order: ' + @this.assignedcontrolled.order.id" />
					<debug_text text="this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ====='" />
				</do_if>
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Order_AttackOther'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' ======================='" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_target_attack: ' + @$kAAIT_target_attack.knownname + ' ' + @$kAAIT_target_attack.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				<include_interrupt_actions ref="kAAIT_CleanOrders" />
				<do_if value="this.assignedcontrolled.order">
					<set_order_syncpoint_reached order="this.assignedcontrolled.order" />
					<unassign_order_syncpoint_from_order order="this.assignedcontrolled.order" />
					<do_if value="this.assignedcontrolled.commander.isoperational">
						<signal_objects object="this.assignedcontrolled.commander" param="'kAAIT_tactical_remove_subordinate'" param2="this.assignedcontrolled" />
					</do_if>
				</do_if>
				<do_if value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$attackOrder">
					<cancel_order order="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$attackOrder" />
				</do_if>
				<do_if value="@$kAAIT_is_attack_order_tactical">
					<create_order name="$kAAIT_order_attack" object="this.assignedcontrolled" id="'TacticalOrder'" immediate="true">
						<param name="selectedtarget" value="$kAAIT_target_attack" />
						<param name="kAAITParam_isAvoidHighRisk" value="@$kAAITParam_isAvoidHighRisk" />
						<param name="kAAITParam_isStepForwardWithdraw" value="@$kAAITParam_isStepForwardWithdraw" />
						<param name="debugchance" value="@$debugchance"/>
					</create_order>
				</do_if>
				<do_else>
					<do_if value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget != $kAAIT_target_attack">
						<create_order name="$kAAIT_order_attack" object="this.assignedcontrolled" id="'Attack'" immediate="true">
							<param name="primarytarget" value="$kAAIT_target_attack" />
							<param name="pursuedistance" value="this.assignedcontrolled.maxradarrange" />
							<param name="pursuetargets" value="false" />
							<param name="kAAITParam_isAvoidHighRisk" value="@$kAAITParam_isAvoidHighRisk" />
							<param name="kAAITParam_isStepForwardWithdraw" value="@$kAAITParam_isStepForwardWithdraw" />
							<param name="debugchance" value="@$debugchance"/>
						</create_order>
					</do_if>
				</do_else>
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$attackOrder" exact="$kAAIT_order_attack" />
			</actions>

			<actions name="kAAIT_Order_Avoid">
				<do_if value="(not this.isplayerowned) and (not $kAAITParam_isAvoidHighRisk) and (not $kAAITParam_isStepForwardWithdraw)">
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Order_Avoid order: ' + @this.assignedcontrolled.order.id" />
					<debug_text text="this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ====='" />
				</do_if>
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Order_Avoid'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' ================='" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' $target_avoid: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$target_avoid.knownname + ' ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$target_avoid.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				<include_interrupt_actions ref="kAAIT_CleanOrders" />
				<do_if value="this.assignedcontrolled.order">
					<set_order_syncpoint_reached order="this.assignedcontrolled.order" />
					<unassign_order_syncpoint_from_order order="this.assignedcontrolled.order" />
					<do_if value="this.assignedcontrolled.commander.isoperational">
						<signal_objects object="this.assignedcontrolled.commander" param="'kAAIT_tactical_remove_subordinate'" param2="this.assignedcontrolled" />
					</do_if>
				</do_if>
				<set_value name="$kAAIT_isImmediate" exact="true" />
				<do_if value="@this.assignedcontrolled.order.id == 'TacticalOrder'">
					<set_value name="$kAAIT_isImmediate" exact="false" />
				</do_if>
				<create_order object="this.assignedcontrolled" id="'kAAIT_MoveAvoid'" immediate="$kAAIT_isImmediate">
					<param name="target" value="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$target_avoid" />
				</create_order>
				<do_if value="not $kAAIT_isImmediate" comment="if TacticalOrder, cancel it. then re-add it.">
					<set_value name="$kAAIT_target_attack" exact="this.assignedcontrolled.order.$selectedtarget" />
					<set_value name="$kAAIT_aggressiveness" exact="this.assignedcontrolled.order.$aggressiveness" />
					<set_value name="$kAAIT_weakfirst" exact="this.assignedcontrolled.order.$weakfirst" />
					<set_value name="$kAAIT_xdistance" exact="this.assignedcontrolled.order.$xdistance" />
					<set_value name="$kAAIT_zdistance" exact="this.assignedcontrolled.order.$zdistance" />
					<set_value name="$kAAIT_timeout" exact="this.assignedcontrolled.order.$timeout" />
					<cancel_order order="this.assignedcontrolled.order" />
					<create_order object="this.assignedcontrolled" id="'TacticalOrder'">
						<param name="selectedtarget" value="$kAAIT_target_attack" />
						<param name="aggressiveness" value="$kAAIT_aggressiveness" />
						<param name="weakfirst" value="$kAAIT_weakfirst" />
						<param name="xdistance" value="$kAAIT_xdistance" />
						<param name="zdistance" value="$kAAIT_zdistance" />
						<param name="timeout" value="$kAAIT_timeout" />
					</create_order>
				</do_if>
			</actions>

			<actions name="kAAIT_Order_Flee">
				<do_if value="(not this.isplayerowned) and (not $kAAITParam_isAvoidHighRisk) and (not $kAAITParam_isStepForwardWithdraw)">
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Order_Flee order: ' + @this.assignedcontrolled.order.id" />
					<debug_text text="this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ====='" />
				</do_if>
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Order_Flee'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' ================'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' $target_avoid: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$target_avoid.knownname + ' ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$target_avoid.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				<include_interrupt_actions ref="kAAIT_CleanOrders" />
				<do_if value="this.assignedcontrolled.order">
					<set_order_syncpoint_reached order="this.assignedcontrolled.order" />
					<unassign_order_syncpoint_from_order order="this.assignedcontrolled.order" />
					<do_if value="this.assignedcontrolled.commander.isoperational">
						<signal_objects object="this.assignedcontrolled.commander" param="'kAAIT_tactical_remove_subordinate'" param2="this.assignedcontrolled" />
					</do_if>
				</do_if>
				<create_order object="this.assignedcontrolled" id="'Flee'" immediate="true">
					<param name="method" value="'boost'"/>
					<param name="attacker" value="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$target_avoid"/>
					<param name="donotdrop" value="true"/>
					<param name="deploydistraction" value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget.isclass.ship"/>
					<param name="log" value="false"/>
					<param name="kAAITParam_iskAAITOrder" value="true"/>
					<param name="debugchance" value="@$debugchance"/>
				</create_order>
			</actions>

			<actions name="kAAIT_Order_MoveToEngagePosition">
				<do_if value="(not this.isplayerowned) and (not $kAAITParam_isAvoidHighRisk) and (not $kAAITParam_isStepForwardWithdraw)">
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Order_MoveToEngagePosition order: ' + @this.assignedcontrolled.order.id" />
					<debug_text text="this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ==========='" />
				</do_if>
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Order_MoveToEngagePosition'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' ================================'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' $target_avoid: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$target_avoid.knownname + ' ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$target_avoid.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				<include_interrupt_actions ref="kAAIT_CleanOrders" />
				<do_if value="this.assignedcontrolled.order">
					<set_order_syncpoint_reached order="this.assignedcontrolled.order" />
					<unassign_order_syncpoint_from_order order="this.assignedcontrolled.order" />
					<do_if value="this.assignedcontrolled.commander.isoperational">
						<signal_objects object="this.assignedcontrolled.commander" param="'kAAIT_tactical_remove_subordinate'" param2="this.assignedcontrolled" />
					</do_if>
				</do_if>
				<create_order object="this.assignedcontrolled" id="'kAAIT_MoveEngagePosition'" immediate="true">
					<param name="target" value="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$target_avoid"/>
				</create_order>
			</actions>

			<actions name="kAAIT_Order_Withdraw">
				<do_if value="(not this.isplayerowned) and (not $kAAITParam_isAvoidHighRisk) and (not $kAAITParam_isStepForwardWithdraw)">
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Order_Withdraw order: ' + @this.assignedcontrolled.order.id" />
					<debug_text text="this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ====='" />
				</do_if>
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Order_Withdraw'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' ===================='" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' $target_avoid: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$target_avoid.knownname + ' ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$target_avoid.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				<include_interrupt_actions ref="kAAIT_CleanOrders" />
				<do_if value="this.assignedcontrolled.order">
					<set_order_syncpoint_reached order="this.assignedcontrolled.order" />
					<unassign_order_syncpoint_from_order order="this.assignedcontrolled.order" />
					<do_if value="this.assignedcontrolled.commander.isoperational">
						<signal_objects object="this.assignedcontrolled.commander" param="'kAAIT_tactical_remove_subordinate'" param2="this.assignedcontrolled" />
					</do_if>
				</do_if>
				<create_order object="this.assignedcontrolled" id="'kAAIT_MoveWithdraw'" immediate="true">
					<param name="target" value="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$target_avoid"/>
				</create_order>
			</actions>

			<actions name="kAAIT_RequestHelp">
				<do_if value="(not this.isplayerowned) and (not $kAAITParam_isAvoidHighRisk) and (not $kAAITParam_isStepForwardWithdraw)">
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_RequestHelp order: ' + @this.assignedcontrolled.order.id" />
					<debug_text text="this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ====='" />
				</do_if>
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_RequestHelp'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' ================='" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Data.$debugChance else 0" />
				<do_if value="@this.assignedcontrolled.subordinates.count">
					<signal_objects object="this.assignedcontrolled" param="'kAAIT_help'" param2="this.assignedcontrolled" />
				</do_if>
				<do_if value="@this.assignedcontrolled.commander.isoperational">
					<signal_objects object="this.assignedcontrolled.commander" param="'kAAIT_help'" param2="this.assignedcontrolled" />
				</do_if>
			</actions>
		</library>
	</interrupts>
</aiscript>
