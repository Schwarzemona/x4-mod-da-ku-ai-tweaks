<?xml version="1.0" encoding="utf-8"?>
<aiscript name="kuertee_aait_interrupts" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="aiscripts.xsd">
	<interrupts>
		<library>
			<actions name="kAAIT_RegisterShip">
				<do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}?">
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}" exact="table[]" />
				</do_if>
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$version" exact="global.$kAAIT.version" />
				<do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData?">
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData" exact="table[]" />
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$ship" exact="this.assignedcontrolled" />
				</do_if>
			</actions>

			<actions name="kAAIT_DeregisterShip">
				<include_interrupt_actions ref="kAAIT_RemoveAttackerFromTarget" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $attackData (pre): ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<do_if value="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData?">
					<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData" />
					<debug_text text="@this.assignedcontrolled.idcode + ' $attackData (post): ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				</do_if>
				<do_if value="not this.assignedcontrolled.isoperational">
					<debug_text text="@this.assignedcontrolled.idcode + ' $kAAITByShipId (pre): ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}" />
					<debug_text text="@this.assignedcontrolled.idcode + ' $kAAITByShipId (post): ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				</do_if>
				<remove_value name="this.$time_avoidWithdrawEvent" />
			</actions>

			<actions name="kAAIT_Init">
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Init'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<do_if value="@this.$beacon_from or @this.$kAAIT_target or @this.$kAAIT_orders">
					<include_interrupt_actions ref="kAAIT_CleanUpOldVersionData" />
				</do_if>
				<do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData?">
					<debug_text text="@this.assignedcontrolled.idcode + ' NEW ATTACK ORDER'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<include_interrupt_actions ref="kAAIT_RegisterShip" />
				</do_if>
				<do_else>
					<debug_text text="@this.assignedcontrolled.idcode + ' CONTINUED ATTACK ORDER'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				</do_else>
				<include_interrupt_actions ref="kAAIT_SaveWeaponStatsToData" />
				<include_interrupt_actions ref="kAAIT_SaveSkillVarsToData" />
				<do_for_each name="$kAAIT_order" in="this.assignedcontrolled.orders">
					<do_if value="@$kAAIT_order.$primarytarget">
						<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$isAttacking" exact="true" />
						<set_value name="$kAAIT_test_target_isHighRisk" exact="@$kAAIT_order.$primarytarget" />
						<include_interrupt_actions ref="kAAIT_GetIsHighRisk" />
						<do_if value="
							@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget != $kAAIT_test_target_isHighRisk and
							@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTargetEntity.$kAAIT_attackers.indexof.{this.assignedcontrolled}">
							<include_interrupt_actions ref="kAAIT_RemoveAttackerFromTarget" />
						</do_if>
						<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget" exact="$kAAIT_test_target_isHighRisk" />
						<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTargetEntity" exact="@$kAAIT_target_highRiskEntity" />
						<include_interrupt_actions ref="kAAIT_AddAttackerToTarget" />
						<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isTargetPotentialHighRisk" exact="@$kAAIT_result_isPotentialHighRisk" />
						<break />
					</do_if>
				</do_for_each>
				<remove_value name="$kAAIT_test_target_isHighRisk" />
				<do_if value="@this.assignedcontrolled.commander.exists">
					<include_interrupt_actions ref="kAAIT_CheckDefaultOrderOfCommander" />
				</do_if>
				<do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isInited?">
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isInited" exact="true" />
					<leave_formation object="this.assignedcontrolled" />
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' $isAttacking: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$isAttacking" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $attackData: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			</actions>

			<actions name="kAAIT_Deinit">
				<set_value name="$isDeInit" exact="true" />
				<set_value name="$kAAIT_wasAttacking" exact="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$isAttacking" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Deinit $kAAIT_wasAttacking: ' + $kAAIT_wasAttacking" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<do_if value="
					@this.assignedcontrolled.isoperational and
					@this.assignedcontrolled.order.$kAAITParam_iskAAITOrder and
					(
						@this.assignedcontrolled.nextorder.$kAAITParam_iskAAITOrder or
						@this.assignedcontrolled.nextorder.script == 'move.generic' or
						@this.assignedcontrolled.nextorder.script == 'order.move.wait'
					)">
					<set_value name="$isDeInit" exact="false" />
				</do_if>
				<do_if value="$isDeInit">
					<do_if value="@this.assignedcontrolled.orders.count">
						<do_for_each name="$kAAIT_order" in="this.assignedcontrolled.orders">
							<do_if value="
								$kAAIT_order.script == 'order.fight.attack.object' or
								$kAAIT_order.script == 'order.fight.escort' or
								$kAAIT_order.script == 'order.fight.protect.ship' or
								$kAAIT_order.script == 'order.fight.protect.station' or
								$kAAIT_order.script == 'order.fight.tactical'">
								<set_value name="$isDeInit" exact="false" />
								<break />
							</do_if>
						</do_for_each>
					</do_if>
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Deinit $isDeInit: ' + $isDeInit + ' order.script: ' + @this.assignedcontrolled.order.script + ' order.$kAAITParam_iskAAITOrder: ' + @this.assignedcontrolled.order.$kAAITParam_iskAAITOrder" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<do_if value="$isDeInit">
					<do_if value="@this.assignedcontrolled.commander.exists">
						<include_interrupt_actions ref="kAAIT_CheckDefaultOrderOfCommander" />
					</do_if>
					<include_interrupt_actions ref="kAAIT_DeregisterShip" />
				</do_if>
				<do_elseif value="global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}?">
					<set_value name="global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$isAttacking" exact="$kAAIT_wasAttacking" />
				</do_elseif>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Deinit $isAttacking: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$isAttacking" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			</actions>

			<actions name="kAAIT_CleanUpOldVersionData">
				<!-- start: clean-up obsolete data from previous version -->
				<!-- current version: most of these vars in global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData -->
				<do_if value="@this.$beacon_from.exists"><destroy_object object="this.$beacon_from" /></do_if>
				<do_if value="@this.$beacon_to.exists"><destroy_object object="this.$beacon_to" /></do_if>
				<do_if value="@this.$beacon_avoid1.exists"><destroy_object object="this.$beacon_avoid1" /></do_if>
				<do_if value="@this.$beacon_avoid2.exists"><destroy_object object="this.$beacon_avoid2" /></do_if>
				<remove_value name="this.$beacon_from" />
				<remove_value name="this.$beacon_to" />
				<remove_value name="this.$beacon_avoid1" />
				<remove_value name="this.$beacon_avoid2" />
				<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget_stopKamikaze" />
				<remove_value name="this.$kAAIT_target" />
				<remove_value name="this.$kAAIT_orders" />
				<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_aroundDir" />
				<remove_value name="this.$kAAIT_lastAttack_enemy" />
				<remove_value name="this.$kAAIT_lastAttack_time" />
				<remove_value name="this.$kAAIT_lastAttack_timeLastSafe" />
				<remove_value name="this.$kAAIT_inchForwardCount" />
				<remove_value name="this.$kAAIT_movedOutOfRangeCount" />
				<remove_value name="this.$kAAIT_orderLocation_space" />
				<remove_value name="this.$kAAIT_orderLocation_pos" />
				<!-- end: clean-up obsolete data from previous version -->
			</actions>

			<actions name="kAAIT_AddAttackerToTarget">
				<do_if value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTargetEntity.isoperational">
					<do_if value="not global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData?">
						<include_interrupt_actions ref="kAAIT_Init" />
					</do_if>
					<do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTargetEntity.$kAAIT_attackers?">
						<create_group groupname="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTargetEntity.$kAAIT_attackers" />
					</do_if>
					<do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTargetEntity.$kAAIT_attackers_lxl?">
						<create_group groupname="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTargetEntity.$kAAIT_attackers_lxl" />
					</do_if>
					<do_if value="player.age - @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTargetEntity.$kAAIT_attackers_timeAdded gt 60min">
						<clear_group group="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTargetEntity.$kAAIT_attackers" />
						<clear_group group="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTargetEntity.$kAAIT_attackers_lxl" />
					</do_if>
					<add_to_group groupname="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTargetEntity.$kAAIT_attackers" object="this.assignedcontrolled" />
					<do_if value="@this.assignedcontrolled.iscapitalship">
						<add_to_group groupname="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTargetEntity.$kAAIT_attackers_lxl" object="this.assignedcontrolled" />
					</do_if>
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTargetEntity.$kAAIT_attackers_timeAdded" exact="player.age" />
					<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_attackers (add to ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget + ' ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget.knownname + '): ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTargetEntity.$kAAIT_attackers.count" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				</do_if>
			</actions>

			<actions name="kAAIT_RemoveAttackerFromTarget">
				<do_if value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTargetEntity.isoperational">
					<do_if value="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTargetEntity.$kAAIT_attackers?">
						<remove_from_group group="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTargetEntity.$kAAIT_attackers" object="this.assignedcontrolled" />
						<do_if value="not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTargetEntity.$kAAIT_attackers.count">
							<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTargetEntity.$kAAIT_attackers" />
						</do_if>
					</do_if>
					<do_if value="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTargetEntity.$kAAIT_attackers_lxl?">
						<remove_from_group group="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTargetEntity.$kAAIT_attackers_lxl" object="this.assignedcontrolled" />
						<do_if value="not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTargetEntity.$kAAIT_attackers_lxl.count">
							<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTargetEntity.$kAAIT_attackers_lxl" />
						</do_if>
					</do_if>
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_attackers (remove from ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget + ' ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget.knownname + '): ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTargetEntity.$kAAIT_attackers.count" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			</actions>

			<!--
				88  88    db    88b 88 8888b.  88     888888 88""Yb .dP"Y8
				88  88   dPYb   88Yb88  8I  Yb 88     88__   88__dP `Ybo."
				888888  dP__Yb  88 Y88  8I  dY 88  .o 88""   88"Yb  o.`Y8b
				88  88 dP""""Yb 88  Y8 8888Y"  88ood8 888888 88  Yb 8bodP'
			 -->
			<handler name="kAAIT_CheckVersion">
				<conditions>
					<event_universe_generated />
				</conditions>
				<actions>
					<do_if value="not $kAAIT_original_name?">
						<set_value name="$kAAIT_original_name" exact="this.assignedcontrolled.knownname" />
					</do_if>
					<do_if value="
						@$kAAITParam_isAvoidHighRisk or
						@$kAAITParam_isStepForwardWithdraw or
						@$kAAITParam_iskAAITOrder or
						@this.assignedcontrolled.order.$kAAITParam_isAvoidHighRisk or
						@this.assignedcontrolled.order.$kAAITParam_isStepForwardWithdraw or
						global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}?">
						<debug_text text="@this.assignedcontrolled.idcode + ' (' + this.owner + ') $kAAIT_version: ' + @$kAAIT_version + ' != global.$kAAIT.version: ' + global.$kAAIT.version + '.'" />
						<do_if value="$kAAIT_version? and @global.$kAAIT.exists and global.$kAAIT.version != @$kAAIT_version"
							comment="but orders that have kaait features acquire the code changes even if they are not used, so update ALL running orders">
							<debug_text text="@this.assignedcontrolled.idcode + ' (' + this.owner + ') $kAAIT_version: ' + @$kAAIT_version + ' != global.$kAAIT.version: ' + global.$kAAIT.version + '. restarting.'" />
							<set_value name="$kAAIT_version" exact="global.$kAAIT.version" />
							<create_order name="$kAAIT_waitOrderToForceRestartAtUpdate" id="'Wait'" object="this.assignedcontrolled" immediate="true">
								<param name="timeout" value="1s"/>
								<param name="debugchance" value="100"/>
							</create_order>
							<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_waitOrderToForceRestartAtUpdate: ' + $kAAIT_waitOrderToForceRestartAtUpdate" />
							<set_value name="$movesuccess" exact="false" />
							<abort_called_scripts resume="kAAIT_label_start" />
						</do_if>
					</do_if>
				</actions>
			</handler>

			<!--
				there is only one way to trigger the avoid and withdraw behaviours:
				<handler name="kAAIT_Handler_AvoidWithdrawOrJustFight">.

				the behaviours are triggered like this within kAAIT_Handler_AvoidWithdrawOrJustFight:
					<abort_called_scripts resume="kAAIT_label_avoid" />
					<include_interrupt_actions ref="kAAIT_Order_Avoid" />
					<abort_called_scripts resume="kAAIT_label_withdraw" />
					<include_interrupt_actions ref="kAAIT_Order_Withdraw" />

				BUT <actions name="kAAIT_GetAvoidOrNot"> is used to check if the ship SHOULD avoid or not.

				so ... if <actions name="kAAIT_GetAvoidOrNot"> is true then
				any of these
					<abort_called_scripts resume="kAAIT_label_avoid" />
					<include_interrupt_actions ref="kAAIT_Order_Avoid" />
					<abort_called_scripts resume="kAAIT_label_withdraw" />
					<include_interrupt_actions ref="kAAIT_Order_Withdraw" />
			-->
			<handler name="kAAIT_Handler_AvoidWithdrawOrJustFight">
				<conditions>
					<check_any>
						<check_all chance="
							if (not @$kAAITParam_iskAAITOrder) and
							(
								(
									@this.assignedcontrolled.iscapitalship and
									@$kAAITParam_isStepForwardWithdraw
								) or
								(
									(not @this.assignedcontrolled.iscapitalship) and
									@$kAAITParam_isAvoidHighRisk
								)
							) then 100 else 0">
							<check_any>
								<event_object_attacked object="this.assignedcontrolled" />
								<event_object_attacked_object object="this.assignedcontrolled" />
							</check_any>
							<check_value value="not this.assignedcontrolled.dock" />
							<check_any comment="prevent event stack">
								<check_value value="not @this.$time_avoidWithdrawEvent" />
								<check_value value="player.age gt @this.$time_avoidWithdrawEvent" />
							</check_any>
							<debug_text text="@this.assignedcontrolled.idcode + ' event.name (' + player.age + ', ' + @this.$time_avoidWithdrawEvent + '): ' + event.name" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
							<set_value name="this.$time_avoidWithdrawEvent" exact="player.age + (global.$kAAIT_Data.$optimisation_hit_event)s" />
							<check_any>
								<check_value value="@this.assignedcontrolled.order.script == 'order.fight.attack.object'" />
								<check_value value="@this.assignedcontrolled.order.script == 'order.fight.tactical'" />
								<check_value value="@this.assignedcontrolled.primarypurpose != purpose.fight" />
								<check_value value="not @this.assignedcontrolled.iscapitalship" />
							</check_any>
							<set_value name="$kAAIT_attacker" exact="if event.param.defensible then event.param.defensible else event.param" />
							<check_value value="$kAAIT_attacker.hasrelation.enemy.{this.assignedcontrolled}" />
							<check_value value="@$kAAIT_attacker.isoperational" />
							<set_value name="$kAAIT_distAttacker" exact="this.assignedcontrolled.bboxdistanceto.{$kAAIT_attacker}" />
							<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight (event.name: ' + event.name + ') $kAAIT_attacker.knownname (attacked, withdraw): ' + @$kAAIT_attacker.knownname + ' ' + $kAAIT_attacker.idcode" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
							<set_value name="$kAAIT_eventType" exact="'withdraw'" />
						</check_all>
						<check_all chance="if (not @$kAAITParam_iskAAITOrder) and @$kAAITParam_isAvoidHighRisk then 100 else 0">
							<event_gravidar_has_scanned object="if @$kAAITParam_isAvoidHighRisk then this.assignedcontrolled else null" check="false"/>
							<check_value value="not this.assignedcontrolled.dock" />
							<check_any comment="prevent event stack">
								<check_value value="not @this.$time_avoidWithdrawEvent" />
								<check_value value="player.age gt @this.$time_avoidWithdrawEvent" />
							</check_any>
							<debug_text text="@this.assignedcontrolled.idcode + ' event.name (' + player.age + ', ' + @this.$time_avoidWithdrawEvent + '): ' + event.name" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
							<set_value name="this.$time_avoidWithdrawEvent" exact="player.age + (global.$kAAIT_Data.$optimisation_radar_event)s" />
							<check_value value="@this.assignedcontrolled.order.script != 'move.kuertee.avoid'" />
							<!-- <check_any>
								<check_value value="not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget.isoperational" comment="not in attack" />
								<check_all>
									<set_value name="$kAAIT_attacker" exact="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget" />
									<check_value value="@$kAAIT_attacker.isoperational" />
									<set_value name="$kAAIT_distAttacker" exact="this.assignedcontrolled.bboxdistanceto.{global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget}" />
									<check_value value="$kAAIT_distAttacker gt this.assignedcontrolled.maxradarrange" comment="target is far" />
								</check_all>
							</check_any> -->
							<count_gravidar_contacts result="$kAAIT_gravidarTarget" object="this.assignedcontrolled" class="[class.ship_l, class.ship_xl, class.station]" maybeattackedby="this.assignedcontrolled" checkoperational="false" masstraffic="false" docked="false" min="1" multiple="false" sortbydistanceto="this.assignedcontrolled" sortdescending="false">
								<match_context macro="[@this.sector.macro]"/>
								<match_context class="class.highway" negate="true"/>
								<match class="class.buildstorage" negate="true"/>
								<match state="componentstate.wreck" negate="true"/>
								<match_relation_to object="this.assignedcontrolled" relation="enemy" comparison="le" />
							</count_gravidar_contacts>
							<!-- <check_value value="false" comment="debugging: uncomment to disable event listener" /> -->
							<!-- <debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight params are good'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance debugChance_avoidWithdrawOrJustFighte 0)" /> -->
							<set_value name="$kAAIT_attacker" exact="if $kAAIT_gravidarTarget.defensible then $kAAIT_gravidarTarget.defensible else $kAAIT_gravidarTarget" />
							<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight (event.name: ' + event.name + ') $kAAIT_attacker.knownname (gravidar, avoid): ' + @$kAAIT_attacker.knownname + ' ' + $kAAIT_attacker.idcode" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
							<check_value value="@$kAAIT_attacker.isoperational" />
							<set_value name="$kAAIT_distAttacker" exact="this.assignedcontrolled.bboxdistanceto.{$kAAIT_attacker}" />
							<check_all comment="do not avoid attack targets. note that xssm ships avoid their targets NOT from this event but from the actual avoid XML. this event is for targets that enter gravidar.">
								<check_all>
									<check_all>
										<check_value value="$kAAIT_attacker != @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget" />
										<check_value value="$kAAIT_attacker != @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget.commander" />
										<check_value value="$kAAIT_attacker != @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget.toplevelcommander" />
										<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight $kAAIT_attacker (' + $kAAIT_attacker + ') not $defensibleTarget (' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget + ')'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
									</check_all>
									<check_all>
										<check_any>
											<check_value value="@this.assignedcontrolled.order.script != 'order.fight.attack.object'" />
											<check_all>
												<check_value value="$kAAIT_attacker != @$primarytarget" />
												<check_value value="$kAAIT_attacker != @$primarytarget.commander" />
												<check_value value="$kAAIT_attacker != @$primarytarget.toplevelcommander" />
											</check_all>
										</check_any>
										<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight $kAAIT_attacker (' + $kAAIT_attacker + ') not $primarytarget (' + @$primarytarget + ')'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
									</check_all>
									<check_all>
										<check_any>
											<check_value value="@this.assignedcontrolled.order.script != 'order.fight.tactical'" />
											<check_all>
												<check_value value="$kAAIT_attacker != @$selectedtarget" />
												<check_value value="$kAAIT_attacker != @$selectedtarget.commander" />
												<check_value value="$kAAIT_attacker != @$selectedtarget.toplevelcommander" />
											</check_all>
										</check_any>
										<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight $kAAIT_attacker (' + $kAAIT_attacker + ') not $selectedtarget (' + @$selectedtarget + ')'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
									</check_all>
									<check_all>
										<check_value value="@this.assignedcontrolled.order.script != 'order.fight.patrol'" />
										<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight not on patrol'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
									</check_all>
									<check_all>
										<check_any>
											<check_all>
												<check_value value="@this.assignedcontrolled.order.script != 'order.fight.protect.position'" />
												<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight not protecting position'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
											</check_all>
											<check_all>
												<check_value value="@this.assignedcontrolled.order.script == 'order.fight.protect.position'" />
												<check_value value="$kAAIT_attacker.distanceto.[$targetsector, $position] gt this.assignedcontrolled.maxradarrange" />
												<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight far from protect position $targetsector: ' + @$targetsector + ' $position: ' + @$position" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
											</check_all>
										</check_any>
									</check_all>
									<check_all>
										<check_any>
											<check_all>
												<check_value value="@this.assignedcontrolled.order.script != 'order.fight.protect.ship'" comment="target is $target" />
												<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight not protecting ship'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
											</check_all>
											<check_all>
												<check_value value="@this.assignedcontrolled.order.script == 'order.fight.protect.ship'" comment="target is $target" />
												<check_value value="@$target.isoperational" />
												<check_value value="$kAAIT_attacker.distanceto.{$target} gt this.assignedcontrolled.maxradarrange" />
												<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight $kAAIT_attacker (' + $kAAIT_attacker + ') far from protected ship $target (' + @$target + ')'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
											</check_all>
										</check_any>
									</check_all>
									<check_all>
										<check_any>
											<check_all>
												<check_value value="@this.assignedcontrolled.order.script != 'order.fight.protect.station'" comment="target is $station" />
												<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight not protecting station'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
											</check_all>
											<check_all>
												<check_value value="@this.assignedcontrolled.order.script == 'order.fight.protect.station'" comment="target is $station" />
												<check_value value="@$station.isoperational" />
												<check_value value="$kAAIT_attacker.distanceto.{$station} gt this.assignedcontrolled.maxradarrange" />
												<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight $kAAIT_attacker (' + $kAAIT_attacker + ') far from protected $station (' + @$station + ')'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
											</check_all>
										</check_any>
									</check_all>
								</check_all>
							</check_all>
							<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight $kAAIT_attacker is not the current target'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
							<set_value name="$kAAIT_eventType" exact="'avoid'" />
						</check_all>
					</check_any>
					<set_value name="$kAAIT_isInterrupted" exact="true" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight @$kAAIT_eventType: ' + @$kAAIT_eventType" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
					<check_value value="@$kAAIT_eventType" />
					<check_value value="@$kAAIT_attacker.isoperational" />
					<set_value name="$kAAIT_attackerEntity" exact="if @$kAAIT_attacker.assignedaipilot then $kAAIT_attacker.assignedaipilot else @$kAAIT_attacker.defencenpc" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight $kAAIT_attackerEntity.name: ' + @$kAAIT_attackerEntity.name" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
					<check_value value="@$kAAIT_attackerEntity.isoperational" />
					<check_all comment="is allowed to avoid or withdraw. conditions: attacker, self, situation">
						<check_all comment="attacker">
							<check_value value="$kAAIT_attacker.isclass.[class.ship, class.station]" />
							<check_value value="not @$kAAIT_attacker.isunit" />
							<check_value value="not @$kAAIT_attacker.islasertower" />
							<check_any>
								<check_any>
									<check_value value="$kAAIT_attacker.isclass.station" />
									<check_value value="$kAAIT_attacker.shieldpercentage gt 25" />
								</check_any>
								<check_all>
									<check_value value="$kAAIT_attacker.hullpercentage gt 25" />
									<check_all>
										<check_value value="this.assignedcontrolled.shieldpercentage le 25" />
										<check_value value="this.assignedcontrolled.hullpercentage le 25" />
									</check_all>
								</check_all>
							</check_any>
							<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight attacker (' + @$kAAIT_attacker.idcode + ') shield and hull are high'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
							<check_any comment="is high-risk">
								<check_all>
									<check_value value="$kAAIT_attacker.isclass.station" />
									<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight attacker is station'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
								</check_all>
								<check_all>
									<check_value value="$kAAIT_attacker == @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget" />
									<check_value value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isTargetPotentialHighRisk" />
									<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight attacker is high-risk via saved data'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
								</check_all>
								<check_all>
									<check_any>
										<check_value value="$kAAIT_attacker.threatscore gt this.assignedcontrolled.threatscore * 1.5" />
										<check_value value="@$kAAIT_attacker.iscapitalship" />
									</check_any>
									<check_value value="@$kAAIT_attacker.primarypurpose == purpose.fight" />
									<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight attacker is high-risk via threatscore'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
								</check_all>
							</check_any>
							<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight attacker checks passed'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
						</check_all>
						<check_all comment="self">
							<check_value value="not this.assignedcontrolled.isunit" />
							<check_value value="not this.assignedcontrolled.islasertower" />
							<check_any comment="prevent avoid while already avoiding">
								<check_value value="$kAAIT_eventType != 'avoid'" />
								<check_value value="not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isAvoiding" />
							</check_any>
							<check_value value="not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isWithdrawing" />
							<check_value value="this.assignedcontrolled.engines.all.count" />
							<check_value value="this.assignedcontrolled.engines.operational.count / (this.assignedcontrolled.engines.all.count)f gt 0.25" />
							<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight self checks passed'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
						</check_all>
						<check_any comment="situation">
							<check_value value="$kAAIT_eventType == 'avoid'" />
							<check_value value="@$kAAIT_attacker.isclass.station" />
							<check_all comment="no attack order, so withdraw">
								<check_value value="@this.assignedcontrolled.order.script != 'order.fight.attack.object'" />
								<check_value value="@this.assignedcontrolled.nextorder.script != 'order.fight.attack.object'" />
								<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight not attacking, so withdraw'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
							</check_all>
							<check_value value="$kAAIT_attacker != @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget" comment="new attacker" />
							<check_all comment="attacker is target and it has other lxl attacker">
								<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight $kAAIT_attackerEntity.$kAAIT_attackers_lxl.indexof.{this.assignedcontrolled}: ' + @$kAAIT_attackerEntity.$kAAIT_attackers_lxl.indexof.{this.assignedcontrolled}" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
								<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight @$kAAIT_attackerEntity.$kAAIT_attackers_lxl.count: ' + @$kAAIT_attackerEntity.$kAAIT_attackers_lxl.count" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
								<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight $kAAIT_attackerEntity.$kAAIT_attackers.indexof.{this.assignedcontrolled}: ' + @$kAAIT_attackerEntity.$kAAIT_attackers.indexof.{this.assignedcontrolled}" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
								<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight @$kAAIT_attackerEntity.$kAAIT_attackers.count: ' + @$kAAIT_attackerEntity.$kAAIT_attackers.count" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
								<check_value value="$kAAIT_attacker == global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget" />
								<check_any>
									<check_all>
										<check_value value="@$kAAIT_attackerEntity.$kAAIT_attackers_lxl.indexof.{this.assignedcontrolled}" />
										<check_value value="@$kAAIT_attackerEntity.$kAAIT_attackers_lxl.count gt 1" />
										<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight has other attackers including me'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
									</check_all>
									<check_all>
										<check_value value="not @$kAAIT_attackerEntity.$kAAIT_attackers_lxl.indexof.{this.assignedcontrolled}" />
										<check_value value="@$kAAIT_attackerEntity.$kAAIT_attackers_lxl.count gt 0" />
										<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight has other attackers not including me'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
									</check_all>
									<check_all>
										<check_value value="@$kAAIT_attackerEntity.$kAAIT_attackers.indexof.{this.assignedcontrolled}" />
										<check_value value="@$kAAIT_attackerEntity.$kAAIT_attackers.count gt 1" />
										<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight has other attackers including me'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
									</check_all>
									<check_all>
										<check_value value="not @$kAAIT_attackerEntity.$kAAIT_attackers.indexof.{this.assignedcontrolled}" />
										<check_value value="@$kAAIT_attackerEntity.$kAAIT_attackers.count gt 0" />
										<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight has other attackers not including me'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
									</check_all>
								</check_any>
								<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight attacker is target and has other attackers'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
							</check_all>
						</check_any>
						<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight is allowed to withdraw'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
					</check_all>
					<set_value name="$kAAIT_skillMult" exact="(@this.skill.piloting + @this.skill.morale) / 30.0" />
					<check_any comment="get $kAAIT_isActOnEventNow.">
						<check_all comment="no operational weapons">
							<check_value value="@$kAAITParam_isAvoidHighRisk" comment="allowed to avoid" />
							<check_value value="not @this.assignedcontrolled.weapons.all.count" />
							<set_value name="$kAAIT_isActOnEventNow" exact="true" />
							<set_value name="$kAAIT_eventType" exact="'avoid'" />
							<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight no operational weapons, ensure avoid behaviour'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
						</check_all>
						<check_all comment="too few operational weapons">
							<check_value value="@$kAAITParam_isAvoidHighRisk" comment="allowed to avoid" />
							<check_value value="this.assignedcontrolled.weapons.all.count" />
							<check_value value="@this.assignedcontrolled.weapons.operational.count / (this.assignedcontrolled.weapons.all.count)f le 0.25" />
							<set_value name="$kAAIT_isActOnEventNow" exact="true" />
							<set_value name="$kAAIT_eventType" exact="'avoid'" />
							<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight too few operational weapons, ensure avoid behaviour'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
						</check_all>
						<check_all comment="vs station">
							<check_all>
								<check_value value="@$kAAIT_attacker.isclass.station" />
								<check_value value="@$kAAIT_attacker.dps.all" />
							</check_all>
							<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight vs station'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
							<check_any>
								<check_all>
									<check_any>
										<check_all>
											<check_value value="not @this.assignedcontrolled.iscapitalship" />
											<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight iscapitalship: ' + this.assignedcontrolled.iscapitalship" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
										</check_all>
										<check_all>
											<check_value value="this.assignedcontrolled.primarypurpose != purpose.fight" />
											<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight primarypurpose: ' + this.assignedcontrolled.primarypurpose" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
										</check_all>
										<check_all comment="not attacking gravidar target">
											<check_any>
												<check_value value="this.assignedcontrolled.order != 'order.fight.attack.object'" />
												<check_value value="this.assignedcontrolled.order.$primarytarget != $kAAIT_attacker" />
											</check_any>
											<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight order: ' + this.assignedcontrolled.order + ' $primarytarget: ' + @this.assignedcontrolled.order.$primarytarget" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
										</check_all>
									</check_any>
								</check_all>
								<check_all>
									<check_any>
										<check_all>
											<check_value value="@this.assignedcontrolled.$attackData.$skill_shieldPercentage_withdrawAt_vStation" />
											<set_value name="$kAAIT_shield_withdrawAt" exact="@this.assignedcontrolled.$attackData.$skill_shieldPercentage_withdrawAt_vStation" />
										</check_all>
										<set_value name="$kAAIT_shield_withdrawAt" exact="75 + $kAAIT_skillMult * 15" />
									</check_any>
									<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight this.assignedcontrolled.shieldpercentage: ' + @this.assignedcontrolled.shieldpercentage" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
									<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight $kAAIT_shield_withdrawAt: ' + @$kAAIT_shield_withdrawAt" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
									<check_value value="this.assignedcontrolled.shieldpercentage le $kAAIT_shield_withdrawAt" />
									<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight poor shields (le skill-withdraw) v station'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
								</check_all>
							</check_any>
							<set_value name="$kAAIT_isActOnEventNow" exact="true" />
						</check_all>
						<check_value value="@$kAAIT_isActOnEventNow" />
						<check_all comment="vs ship">
							<check_all>
								<check_value value="@$kAAIT_attacker.iscapitalship" />
								<check_value value="$kAAIT_attacker.dps.all" />
							</check_all>
							<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight vs ship'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
							<check_any>
								<check_all>
									<check_value value="$kAAIT_attacker != @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget" comment="new attacker" />
									<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight new attacker'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
								</check_all>
								<check_all>
									<check_value value="this.assignedcontrolled.primarypurpose != purpose.fight" />
									<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight this.assignedcontrolled.primarypurpose: ' + this.assignedcontrolled.primarypurpose" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
								</check_all>
								<check_all comment="test shields">
									<check_any>
										<check_all>
											<check_value value="@this.assignedcontrolled.$attackData.$skill_shieldPercentage_withdrawAt_vShip" />
											<set_value name="$kAAIT_shield_withdrawAt" exact="@this.assignedcontrolled.$attackData.$skill_shieldPercentage_withdrawAt_vShip" />
										</check_all>
										<set_value name="$kAAIT_shield_withdrawAt" exact="75 + $kAAIT_skillMult * 15" />
									</check_any>
									<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight this.assignedcontrolled.shieldpercentage: ' + @this.assignedcontrolled.shieldpercentage" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
									<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight $kAAIT_shield_withdrawAt:                 ' + @$kAAIT_shield_withdrawAt" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
									<!-- check for other entries of this text: ship will withdraw and fight at these conditions. so cancel withdrawal when required.
										fight: shield gt skill-withdraw-value.
										withdraw: shield gt 5, shield le skill-withdraw-value, distance to target < 10km.
										fight (self-sacrifice): shield le 5, hull le 50.
									-->
									<check_all comment="good shields: fight. poor shields: withdraw">
										<set_value name="$kAAIT_isShieldsLow" exact="(this.assignedcontrolled.shieldpercentage / ($kAAIT_attacker.shieldpercentage)f) le ($kAAIT_shield_withdrawAt / 100.0)" />
										<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight $kAAIT_isShieldsLow?                      ' + $kAAIT_isShieldsLow + ' eval: ' + (this.assignedcontrolled.shieldpercentage / ($kAAIT_attacker.shieldpercentage)f) + ' le ' + ($kAAIT_shield_withdrawAt / 100.0)" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
										<check_value value="$kAAIT_isShieldsLow" />
										<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight                                           yes'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />

										<set_value name="$kAAIT_isNearTarget" value="$kAAIT_distAttacker le this.assignedcontrolled.maxradarrange * 0.25"/>
										<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight $kAAIT_isNearTarget?                      ' + $kAAIT_isNearTarget + ' eval: ' + $kAAIT_distAttacker + ' le ' + (this.assignedcontrolled.maxradarrange * 0.25)" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
										<check_value value="$kAAIT_isNearTarget" />
										<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight                                           yes'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />

										<set_value name="$kAAIT_isSacrificeSelf" exact="this.assignedcontrolled.shieldpercentage le 5 and this.assignedcontrolled.hullpercentage le 50" />
										<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight NOT $kAAIT_isSacrificeSelf?               ' + (not $kAAIT_isSacrificeSelf) + ' eval: ' + (this.assignedcontrolled.shieldpercentage le 5) + ' and ' + (this.assignedcontrolled.hullpercentage le 50)" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
										<check_value value="not $kAAIT_isSacrificeSelf" />
										<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight                                           yes'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
									</check_all>
									<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight poor shields (le skill-withdraw) v ship'" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
								</check_all>
							</check_any>
							<set_value name="$kAAIT_isActOnEventNow" exact="true" />
						</check_all>
					</check_any>
					<check_value value="@$kAAIT_isActOnEventNow" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight $kAAIT_isActOnEventNow: ' + @$kAAIT_isActOnEventNow" debugchance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
					<!-- <check_value value="@this.assignedcontrolled.order.state != orderstate.critical" /> -->
				</conditions>
				<actions>
					<do_if value="(not this.isplayerowned) and (not @$kAAITParam_isAvoidHighRisk) and (not @$kAAITParam_isStepForwardWithdraw) and (not @$kAAITParam_iskAAITOrder)">
						<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight event.name: ' + event.name + ' $kAAIT_eventType: ' + @$kAAIT_eventType + ' order: ' + @this.assignedcontrolled.order.script" />
						<debug_text text="@this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ================= $kAAIT_attacker: ' + @$kAAIT_attacker.knownname + ', ' + @$kAAIT_attacker.idcode" />
					</do_if>
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight event.name: ' + event.name + ' $kAAIT_eventType: ' + @$kAAIT_eventType + ' order: ' + @this.assignedcontrolled.order.script" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<debug_text text="@this.assignedcontrolled.idcode + ' ====================================== $kAAIT_attacker: ' + @$kAAIT_attacker.knownname + ', ' + @$kAAIT_attacker.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<do_if value="@$kAAIT_attacker.iscapitalship and $kAAIT_attacker != @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget" comment="new target">
						<do_if value="
							(not this.assignedcontrolled.commander) and
							@this.assignedcontrolled.subordinates.count">
							<debug_text text="@this.assignedcontrolled.idcode + ' signal_objects (subordinates) kAAIT_new_big_target'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
							<signal_objects object="this.assignedcontrolled" param="'kAAIT_new_big_target'" param2="table[$attacker = $kAAIT_attacker, $from = this.assignedcontrolled]" />
						</do_if>
						<do_elseif value="
							@this.assignedcontrolled.commander.iscapitalship and
							this.assignedcontrolled.commander.sector == this.sector">
							<debug_text text="@this.assignedcontrolled.idcode + ' signal_objects (commander) kAAIT_new_big_target'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
							<signal_objects object="this.assignedcontrolled.commander" param="'kAAIT_new_big_target'" param2="table[$attacker = $kAAIT_attacker, $from = this.assignedcontrolled]" />
						</do_elseif>
					</do_if>
					<do_if value="@$kAAIT_isActOnEventNow">
						<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_attacker: ' + @$kAAIT_attacker.knownname + ', ' + @$kAAIT_attacker.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
						<do_if value="this.assignedcontrolled.order.script == 'order.fight.tactical' and this.assignedcontrolled.distanceto.{$kAAIT_attacker} le this.assignedcontrolled.maxradarrange">
							<include_interrupt_actions ref="kAAIT_CancelWaitOrders" />
							<abort_called_scripts resume="attack" />
						</do_if>
						<do_else>
							<do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData?">
								<include_interrupt_actions ref="kAAIT_Init" />
							</do_if>
							<set_value name="$kAAIT_attackTarget" exact="$kAAIT_attacker" />
							<set_value name="$kAAIT_test_current_attack_target" exact="$kAAIT_attacker" />
							<set_value name="$kAAIT_test_target_isAvoid" exact="$kAAIT_attacker" />
							<include_interrupt_actions ref="kAAIT_GetAvoidOrNot" />
							<do_if value="@$kAAIT_result_avoidEnemy.isoperational or @$kAAIT_result_withdrawFromEnemy.isoperational">
								<do_if value="@$kAAIT_result_avoidEnemy.isoperational">
									<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid" exact="$kAAIT_result_avoidEnemy" />
								</do_if>
								<do_else>
									<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid" exact="$kAAIT_result_withdrawFromEnemy" />
								</do_else>
								<do_if value="$kAAIT_eventType == 'avoid' or (not this.assignedcontrolled.iscapitalship)">
									<do_if value="@$kAAIT_isScriptHasAvoidLabel">
										<abort_called_scripts resume="kAAIT_label_avoid" />
									</do_if>
									<do_else>
										<include_interrupt_actions ref="kAAIT_Order_Avoid" />
									</do_else>
								</do_if>
								<do_else>
									<do_if value="@$kAAIT_isScriptHasWithdrawLabel">
										<abort_called_scripts resume="kAAIT_label_withdraw" />
									</do_if>
									<do_else comment="assumes in any other order with this handler">
										<include_interrupt_actions ref="kAAIT_Order_Withdraw" />
									</do_else>
								</do_else>
							</do_if>
						</do_else>
					</do_if>
				    <remove_value name="$kAAIT_eventType" />
				    <remove_value name="$kAAIT_attacker" />
				    <remove_value name="$kAAIT_skillMult" />
				    <remove_value name="$kAAIT_isPotentialHighRiskEvent" />
				    <remove_value name="$kAAIT_shield_withdrawAt" />
				    <remove_value name="$kAAIT_isActOnEventNow" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidWithdrawOrJustFight done'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<debug_text text="@this.assignedcontrolled.idcode + ' ======================================'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				</actions>
			</handler>

			<handler name="kAAIT_Handler_NewBigTarget">
				<conditions>
					<check_any>
						<check_all chance="if @$kAAITParam_iskAAITOrder or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_isAvoidHighRisk then 100 else 0">
							<check_any>
								<event_object_signalled object="this.assignedcontrolled" param="'kAAIT_new_big_target'" />
								<event_object_signalled object="this.assignedcontrolled.commander" param="'kAAIT_new_big_target'" check="false" />
							</check_any>
							<set_value name="$kAAIT_attacker" exact="event.param2.$attacker" />
							<set_value name="$kAAIT_signalFrom" exact="event.param2.$from" />
							<check_value value="$kAAIT_attacker" />
						</check_all>
						<check_all chance="if @$kAAITParam_iskAAITOrder or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_isAvoidHighRisk then 100 else 0">
							<check_any>
								<event_object_attacked object="this.assignedcontrolled" />
								<event_object_attacked_object object="this.assignedcontrolled" />
							</check_any>
							<check_value value="@this.assignedcontrolled.order.script != 'order.fight.attack.object'" />
							<check_value value="@this.assignedcontrolled.order.script != 'order.fight.tactical'" />
							<set_value name="$kAAIT_attacker" exact="event.param" />
							<set_value name="$kAAIT_signalFrom" exact="event.name" />
							<check_value value="$kAAIT_attacker" />
						</check_all>
						<check_all chance="if @$kAAITParam_iskAAITOrder or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_isAvoidHighRisk then 100 else 0">
							<event_object_signalled object="this.sector" param="'kAAIT_player_alert'" />
							<check_value value="not @this.assignedcontrolled.orders.{1}.exists" />
							<check_value value="this.sector == event.param2.{1}" />
							<set_value name="$kAAIT_attacker" exact="event.param2.{2}" />
							<set_value name="$kAAIT_signalFrom" exact="event.param" />
							<check_value value="$kAAIT_attacker" />
						</check_all>
					</check_any>
					<check_value value="$kAAIT_attacker.hasrelation.enemy.{this.assignedcontrolled}" />
					<check_value value="this.assignedcontrolled != $kAAIT_signalFrom" />
					<check_value value="not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isAvoiding" comment="not performing kAAIT order" />
					<check_value value="not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isWithdrawing" comment="not performing kAAIT order" />
					<check_all>
						<check_value value="$kAAIT_attacker.isclass.ship" />
						<check_any>
							<check_value value="$kAAIT_attacker.threatscore gt @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget.threatscore" comment="new target is bigger than current target" />
							<check_value value="@$kAAIT_attacker.iscapitalship" />
						</check_any>
						<check_value value="$kAAIT_attacker.primarypurpose == purpose.fight" />
						<check_all>
							<check_any comment="current order is not attack or is of different target">
								<check_value value="@this.assignedcontrolled.order.script != 'order.fight.attack.object'" />
								<check_all>
									<check_value value="@this.assignedcontrolled.order.$primarytarget != $kAAIT_attacker" />
									<check_value value="@this.assignedcontrolled.order.$primarytarget.defensible != $kAAIT_attacker" />
								</check_all>
							</check_any>
							<check_any comment="next order is not attack or is of different target">
								<check_value value="@this.assignedcontrolled.nextorder.script != 'order.fight.attack.object'" />
								<check_all>
									<check_value value="@this.assignedcontrolled.nextorder.$primarytarget != $kAAIT_attacker" />
									<check_value value="@this.assignedcontrolled.nextorder.$primarytarget.defensible != $kAAIT_attacker" />
								</check_all>
							</check_any>
							<check_value value="@this.assignedcontrolled.orders.{3}.script != 'order.fight.attack.object'" comment="too many attack orders if there's already a 3rd attack order" />
						</check_all>
					</check_all>
					<check_any>
						<check_value value="@this.assignedcontrolled.order.script != 'order.fight.attack.object'" />
						<check_value value="@this.assignedcontrolled.order.$allowothertargets" />
					</check_any>
				</conditions>
				<actions>
					<do_if value="(not this.isplayerowned) and (not @$kAAITParam_isAvoidHighRisk) and (not @$kAAITParam_isStepForwardWithdraw) and (not @$kAAITParam_iskAAITOrder)">
						<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_NewBigTarget event.name: ' + event.name + ' order: ' + @this.assignedcontrolled.order.script" />
						<debug_text text="@this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ====='" />
					</do_if>
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_NewBigTarget event.name: ' + event.name" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<debug_text text="@this.assignedcontrolled.idcode + ' ========================== order: ' + @this.assignedcontrolled.order.script" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<debug_text text="@this.assignedcontrolled.idcode + ' threatscore ($defensibleTarget, old target): ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget.threatscore + ' class: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget.class" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<debug_text text="@this.assignedcontrolled.idcode + ' threatscore ($kAAIT_attacker, new possible target): ' + $kAAIT_attacker.threatscore + ' class: ' + $kAAIT_attacker.class" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<do_if value="event.name == 'event_object_attacked' or event.name == 'event_object_attacked_object'">
						<do_if value="
							(not this.assignedcontrolled.commander) and
							@this.assignedcontrolled.subordinates.count">
							<signal_objects object="this.assignedcontrolled" param="'kAAIT_new_big_target'" param2="table[$attacker = $kAAIT_attacker, $from = this.assignedcontrolled]" />
						</do_if>
						<do_elseif value="
							@this.assignedcontrolled.commander.iscapitalship and
							this.assignedcontrolled.commander.sector == this.sector">
							<signal_objects object="this.assignedcontrolled.commander" param="'kAAIT_new_big_target'" param2="table[$attacker = $kAAIT_attacker, $from = this.assignedcontrolled]" />
						</do_elseif>
					</do_if>
					<do_elseif value="event.name == 'event_object_signalled' and event.param == 'kAAIT_new_big_target' and event.param2.$from != this.assignedcontrolled">
						<set_value name="$kAAIT_target_attack" exact="$kAAIT_attacker" />
						<set_value name="$kAAIT_is_attack_order_tactical" exact="
							(
								event.name == 'event_player_alert' or
								(
									event.name == 'event_object_signalled' and
									(
										event.param == 'kAAIT_player_alert' or
										event.param == 'kncpr_enemy_report'
									)
								)
							) and
							@$kAAIT_target_attack.iscapitalship and
							this.assignedcontrolled.bboxdistanceto.{$kAAIT_target_attack} gt this.assignedcontrolled.maxradarrange * 0.5
						" />
						<include_interrupt_actions ref="kAAIT_Order_AttackOther" />
					</do_elseif>
				</actions>
			</handler>

			<handler name="kAAIT_Handler_OrderNewSubordinateToAttack" comment="handler valid only in order.fight.attack.object.xml">
				<conditions>
					<check_all chance="if @$kAAITParam_iskAAITOrder or @$kAAITParam_isStepForwardWithdraw or (@$kAAITParam_isAvoidHighRisk and (not @this.assignedcontrolled.iscapitalship)) then 100 else 0">
						<event_object_signalled object="this.assignedcontrolled" param="'kAAIT_new_subordinate'" />
						<check_value value="@this.$escortgroup.count" />
						<check_value value="@this.assignedcontrolled.order.script == 'order.fight.attack.object'" />
						<check_value value="@event.param2.order.script != 'order.fight.attack.object'" />
						<check_value value="$squad_attack" />
					</check_all>
				</conditions>
				<actions>
					<do_if value="(not this.isplayerowned) and (not @$kAAITParam_isAvoidHighRisk) and (not @$kAAITParam_isStepForwardWithdraw) and (not @$kAAITParam_iskAAITOrder)">
						<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_OrderNewSubordinateToAttack event.name: ' + event.name + ' order: ' + @this.assignedcontrolled.order.script" />
						<debug_text text="@this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ===================='" />
					</do_if>
					<set_value name="$kAAIT_subordinate" exact="event.param2" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Handler_OrderNewSubordinateToAttack $kAAIT_subordinate: ' + $kAAIT_subordinate.knownname + ', ' + $kAAIT_subordinate.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<abort_called_scripts resume="start" />
				</actions>
			</handler>

			<handler name="kAAIT_Handler_DebugWithdraw">
				<conditions>
					<event_object_signalled object="this.assignedcontrolled" param="'withdraw'" />
				</conditions>
				<actions>
					<set_value name="$kAAIT_isDebugWithdraw" exact="true" />
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget" />
					<abort_called_scripts resume="kAAIT_label_withdraw" />
				</actions>
			</handler>

			<!--
				88  88 888888 88     88""Yb 888888 88""Yb .dP"Y8
				88  88 88__   88     88__dP 88__   88__dP `Ybo."
				888888 88""   88  .o 88"""  88""   88"Yb  o.`Y8b
				88  88 888888 88ood8 88     888888 88  Yb 8bodP'
			 -->
			<actions name="kAAIT_GetNonKAAITOrder">
				<do_if value="not @$kAAIT_getOrderOf">
					<set_value name="$kAAIT_getOrderOf" exact="this.assignedcontrolled" />
				</do_if>
				<set_value name="$kAAIT_result_order" exact="null" />
				<do_for_each name="$kAAIT_order" in="$kAAIT_getOrderOf.orders" counter="$i">
					<do_if value="not @$kAAIT_order.$kAAITParam_iskAAITOrder">
						<set_value name="$kAAIT_result_order" exact="$kAAIT_order" />
						<break />
					</do_if>
				</do_for_each>
				<do_if value="not $kAAIT_result_order">
					<set_value name="$kAAIT_result_order" exact="$kAAIT_getOrderOf.defaultorder" />
				</do_if>
				<debug_text text="@$kAAIT_getOrderOf.idcode + ' kAAIT_GetNonkAAITOrder $kAAIT_result_order: ' + $kAAIT_result_order + ' ' + @$kAAIT_result_order.script" chance="if @$kAAIT_getOrderOf.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0" />
				<remove_value name="$kAAIT_getOrderOf" />
			</actions>

			<actions name="kAAIT_GetAttackTarget">
				<set_value name="$kAAIT_result_attackTarget" exact="null" />
				<do_if value="not @$kAAIT_getAttackTargetOf">
					<set_value name="$kAAIT_getAttackTargetOf" exact="this.assignedcontrolled" />
				</do_if>
				<!-- <debug_text text="'$kAAIT_getAttackTargetOf: ' + $kAAIT_getAttackTargetOf + ' ' + $kAAIT_getAttackTargetOf.knownname + ' ' + $kAAIT_getAttackTargetOf.idcode" /> -->
				<do_if value="@$kAAIT_test_current_attack_target.isoperational and $kAAIT_test_current_attack_target.dps.all">
					<set_value name="$kAAIT_result_attackTarget" exact="$kAAIT_test_current_attack_target" />
					<debug_text text="@$kAAIT_getAttackTargetOf.idcode + ' $kAAIT_result_attackTarget ($kAAIT_test_current_attack_target): ' + @$kAAIT_result_attackTarget.knownname + ' ' + @$kAAIT_result_attackTarget.idcode" chance="if @$kAAIT_getAttackTargetOf.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0" />
				</do_if>
				<do_elseif value="
					$kAAIT_getAttackTargetOf.primarypurpose == purpose.fight and
					@$kAAIT_getAttackTargetOf.weapons.all.count and
					@$kAAIT_getAttackTargetOf.weapons.operational.count / ($kAAIT_getAttackTargetOf.weapons.all.count)f gt 0.25"
					comment="do not get attack target unless: (1) fighter and (2) has operational weapons">
					<set_value name="$kAAIT_getOrderOf" exact="$kAAIT_getAttackTargetOf" />
					<include_interrupt_actions ref="kAAIT_GetNonKAAITOrder" />
					<set_value name="$kAAIT_currentOrder" exact="$kAAIT_result_order" />
					<do_if value="(not @$kAAIT_result_attackTarget.isoperational) and @global.$kAAITByShipId.{'$' + @$kAAIT_getAttackTargetOf.idcode}.$attackData.$defensibleTarget.isoperational">
						<set_value name="$kAAIT_result_attackTarget" exact="@global.$kAAITByShipId.{'$' + @$kAAIT_getAttackTargetOf.idcode}.$attackData.$defensibleTarget" />
						<debug_text text="@$kAAIT_getAttackTargetOf.idcode + ' $kAAIT_result_attackTarget ($attackData.$defensibleTarget): ' + @$kAAIT_result_attackTarget.knownname + ' ' + @$kAAIT_result_attackTarget.idcode" chance="if @$kAAIT_getAttackTargetOf.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0" />
					</do_if>
					<do_if value="(not @$kAAIT_result_attackTarget.isoperational) and @$kAAIT_currentOrder.$primarytarget.isoperational">
						<set_value name="$kAAIT_result_attackTarget" exact="$kAAIT_currentOrder.$primarytarget" />
						<debug_text text="@$kAAIT_getAttackTargetOf.idcode + ' $kAAIT_result_attackTarget ($kAAIT_currentOrder.$primarytarget): ' + @$kAAIT_result_attackTarget.knownname + ' ' + @$kAAIT_result_attackTarget.idcode" chance="if @$kAAIT_getAttackTargetOf.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0" />
					</do_if>
					<do_if value="(not $kAAIT_result_attackTarget.isoperational) and @$kAAIT_currentOrder.$target.hasrelation.enemy.{$kAAIT_getAttackTargetOf}">
						<set_value name="$kAAIT_result_attackTarget" exact="$kAAIT_currentOrder.$target" />
						<debug_text text="@$kAAIT_getAttackTargetOf.idcode + ' $kAAIT_result_attackTarget ($kAAIT_currentOrder.$target): ' + @$kAAIT_result_attackTarget.knownname + ' ' + @$kAAIT_result_attackTarget.idcode" chance="if @$kAAIT_getAttackTargetOf.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0" />
					</do_if>
					<do_if value="(not $kAAIT_result_attackTarget.isoperational) and @$kAAIT_currentOrder.$selectedtarget.isoperational">
						<set_value name="$kAAIT_result_attackTarget" exact="$kAAIT_currentOrder.$selectedtarget" />
						<debug_text text="@$kAAIT_getAttackTargetOf.idcode + ' $kAAIT_result_attackTarget ($kAAIT_currentOrder.$selectedtarget): ' + @$kAAIT_result_attackTarget.knownname + ' ' + @$kAAIT_result_attackTarget.idcode" chance="if @$kAAIT_getAttackTargetOf.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0" />
					</do_if>
				</do_elseif>
				<do_if value="@$kAAIT_result_attackTarget.defensible">
					<set_value name="$kAAIT_result_attackTarget" exact="$kAAIT_result_attackTarget.defensible" />
				</do_if>
				<debug_text text="@$kAAIT_getAttackTargetOf.idcode + ' kAAIT_GetAttackTarget $kAAIT_result_attackTarget: ' + @$kAAIT_result_attackTarget.knownname + ' ' + @$kAAIT_result_attackTarget.idcode" chance="if @$kAAIT_getAttackTargetOf.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0" />
				<remove_value name="$kAAIT_test_current_attack_target" />
				<remove_value name="$kAAIT_getAttackTargetOf" />
			</actions>

			<actions name="kAAIT_GetAvoidOrNot">
				<!--
					1. if $kAAIT_test_target_isAvoid is set, kAAIT_GetAvoidOrNot will test if $kAAIT_test_target_isAvoid needs to be avoided.
					   if $kAAIT_test_target_isAvoid is not set, kAAIT_GetAvoidOrNot will look for high-risk enemies to avoid.
					2. test if a high-risk enemy is in the way of destination or target
					3. if avoiding, look for smaller target
				-->
				<do_if value="(not this.isplayerowned) and (not @$kAAITParam_isAvoidHighRisk) and (not @$kAAITParam_isStepForwardWithdraw) and (not @$kAAITParam_iskAAITOrder)">
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetAvoidOrNot order: ' + @this.assignedcontrolled.order.script" />
					<debug_text text="@this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ====='" />
				</do_if>
				<do_if value="@$kAAIT_test_target_isAvoid.defensible">
					<set_value name="$kAAIT_test_target_isAvoid" exact="$kAAIT_test_target_isAvoid.defensible" />
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetAvoidOrNot $kAAIT_test_target_isAvoid: ' + @$kAAIT_test_target_isAvoid.knownname + ' ' + @$kAAIT_test_target_isAvoid.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<set_value name="$kAAIT_result_isAvoid" exact="false" />
				<set_value name="$kAAIT_result_avoidEnemy" exact="null" />
				<set_value name="$kAAIT_result_isWithdraw" exact="false" />
				<set_value name="$kAAIT_result_withdrawFromEnemy" exact="null" />
				<do_if value="not this.assignedcontrolled.dock">
					<do_if value="@$kAAIT_test_target_isAvoid.isoperational">
						<include_interrupt_actions ref="kAAIT_GetAttackTarget" />
						<include_interrupt_actions ref="kAAIT_GetDestination" />
						<do_if value="
							(
								$kAAIT_result_destination and
								$kAAIT_test_target_isAvoid != $kAAIT_result_destination and
								$kAAIT_test_target_isAvoid.hascontext.{$kAAIT_result_destinationSector} and
								$kAAIT_test_target_isAvoid.distanceto.[$kAAIT_result_destination, $kAAIT_result_destinationPosition] lt this.assignedcontrolled.distanceto.[$kAAIT_result_destination, $kAAIT_result_destinationPosition]
							) or
							$kAAIT_result_attackTarget == $kAAIT_result_destination"
							comment="avoid target is nearer than destination or avoid target == attack target, assess avoid or not. otherwise don't avoid.">
							<set_value name="$kAAIT_test_target_isTakeRisk" exact="$kAAIT_test_target_isAvoid" />
							<include_interrupt_actions ref="kAAIT_GetIsTakeRisk" />
							<do_if value="$kAAIT_result_isTakeRisk">
								<set_value name="$kAAIT_test_target_isInTheWay" exact="$kAAIT_test_target_isAvoid" />
								<include_interrupt_actions ref="kAAIT_GetIsInTheWay" />
								<do_if value="$kAAIT_result_isTargetInTheWay">
									<set_value name="$kAAIT_test_attackTargetInTheWayOrNot" exact="$kAAIT_test_target_isInTheWay" />
									<include_interrupt_actions ref="kAAIT_GetAttackOrIgnoreTargetInTheWay" />
									<do_if value="(not $kAAIT_result_isTargetInTheWayAttacked) and (not $kAAIT_result_isTargetInTheWayIgnored)">
										<set_value name="$kAAIT_result_avoidEnemy" exact="$kAAIT_test_target_isInTheWay" />
										<set_value name="$kAAIT_result_isAvoid" exact="true" />
									</do_if>
								</do_if>
							</do_if>
							<do_else>
								<do_if value="$kAAIT_result_attackTarget == $kAAIT_test_target_isAvoid or $kAAIT_result_destination == $kAAIT_test_target_isAvoid">
									<set_value name="$kAAIT_result_avoidEnemy" exact="$kAAIT_test_target_isAvoid" />
									<set_value name="$kAAIT_result_isAvoid" exact="true" />
								</do_if>
								<do_else>
									<set_value name="$kAAIT_test_target_isInTheWay" exact="$kAAIT_test_target_isAvoid" />
									<include_interrupt_actions ref="kAAIT_GetIsInTheWay" />
									<do_if value="$kAAIT_result_isTargetInTheWay">
										<set_value name="$kAAIT_test_attackTargetInTheWayOrNot" exact="$kAAIT_test_target_isInTheWay" />
										<include_interrupt_actions ref="kAAIT_GetAttackOrIgnoreTargetInTheWay" />
										<do_if value="(not $kAAIT_result_isTargetInTheWayAttacked) and (not $kAAIT_result_isTargetInTheWayIgnored)">
											<set_value name="$kAAIT_result_avoidEnemy" exact="$kAAIT_test_target_isInTheWay" />
											<set_value name="$kAAIT_result_isAvoid" exact="true" />
										</do_if>
									</do_if>
								</do_else>
							</do_else>
							<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetAvoidOrNot kAAIT_result_avoidEnemy (1): ' + @$kAAIT_result_avoidEnemy.knownname + ' ' + @$kAAIT_result_avoidEnemy.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
						</do_if>
					</do_if>
					<do_if value="not $kAAIT_result_isAvoid" comment="not avoiding target but look for big enemies nearby and avoid if in the way">
						<include_interrupt_actions ref="kAAIT_SaveBigEnemiesToData" />
						<include_interrupt_actions ref="kAAIT_GetIsNearBigEnemies" />
						<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetAvoidOrNot $kAAIT_result_bigEnemy: ' + @$kAAIT_result_bigEnemy.knownname + ' ' + @$kAAIT_result_bigEnemy.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
						<do_if value="@$kAAIT_result_bigEnemy.isoperational">
							<do_if value="$kAAIT_result_bigEnemy != @$kAAIT_test_target_isAvoid" comment="at this point, $kAAIT_test_target_isAvoid is already evaluated to not avoid, so don't re-evaluate.">
								<set_value name="$kAAIT_test_target_isInTheWay" exact="$kAAIT_result_bigEnemy" />
								<include_interrupt_actions ref="kAAIT_GetIsInTheWay" />
								<do_if value="$kAAIT_result_isTargetInTheWay">
									<set_value name="$kAAIT_test_attackTargetInTheWayOrNot" exact="$kAAIT_test_target_isInTheWay" />
									<include_interrupt_actions ref="kAAIT_GetAttackOrIgnoreTargetInTheWay" />
									<do_if value="(not $kAAIT_result_isTargetInTheWayAttacked) and (not $kAAIT_result_isTargetInTheWayIgnored)">
										<set_value name="$kAAIT_result_avoidEnemy" exact="$kAAIT_test_target_isInTheWay" />
										<set_value name="$kAAIT_result_isAvoid" exact="true" />
									</do_if>
								</do_if>
							</do_if>
						</do_if>
					</do_if>
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetAvoidOrNot kAAIT_result_avoidEnemy (2): ' + @$kAAIT_result_avoidEnemy.knownname + ' ' + @$kAAIT_result_avoidEnemy.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
					<do_if value="$kAAIT_result_isAvoid and @$kAAIT_result_avoidEnemy.isoperational">
						<do_if value="this.assignedcontrolled.bboxdistanceto.{$kAAIT_result_avoidEnemy} gt this.assignedcontrolled.maxradarrange">
							<set_value name="$kAAIT_result_isAvoid" exact="false" />
							<set_value name="$kAAIT_result_avoidEnemy" exact="null" />
						</do_if>
						<do_elseif value="@this.assignedcontrolled.iscapitalship and @this.assignedcontrolled.order.script == 'order.fight.attack.object' and (@$kAAIT_isShieldsLow_vsStation or @$kAAIT_isShieldsLow_vsShip)">
							<set_value name="$kAAIT_result_isWithdraw" exact="true" />
							<set_value name="$kAAIT_result_withdrawFromEnemy" exact="$kAAIT_result_avoidEnemy" />
							<set_value name="$kAAIT_result_isAvoid" exact="false" />
							<set_value name="$kAAIT_result_avoidEnemy" exact="null" />
						</do_elseif>
					</do_if>
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetAvoidOrNot kAAIT_result_avoidEnemy (final): ' + @$kAAIT_result_avoidEnemy.knownname + ' ' + @$kAAIT_result_avoidEnemy.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<do_if value="@$kAAIT_result_isWithdraw">
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetAvoidOrNot kAAIT_result_withdrawFromEnemy (final, withdraw instead): ' + @$kAAIT_result_withdrawFromEnemy.knownname + ' ' + @$kAAIT_result_withdrawFromEnemy.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				</do_if>
			</actions>

			<actions name="kAAIT_GetIsTakeRisk">
				<!-- check for other entries of this text: ship will withdraw and fight at these conditions. so cancel withdrawal when required.
					fight: shield gt skill-withdraw-value.
					withdraw: shield gt 5, shield le skill-withdraw-value, distance to target < 10km.
					fight (self-sacrifice): shield le 5, hull le 50.
				-->
				<do_if value="@$kAAIT_test_target_isTakeRisk.defensible">
					<set_value name="$kAAIT_test_target_isTakeRisk" exact="$kAAIT_test_target_isTakeRisk.defensible" />
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsTakeRisk $kAAIT_test_target_isTakeRisk: ' + @$kAAIT_test_target_isTakeRisk.knownname + ' ' + @$kAAIT_test_target_isTakeRisk.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<set_value name="$kAAIT_test_target_isHighRisk" exact="$kAAIT_test_target_isTakeRisk" />
				<include_interrupt_actions ref="kAAIT_GetIsHighRisk" />
				<set_value name="$kAAIT_isPotentialHighRisk" exact="$kAAIT_result_isPotentialHighRisk" />
				<set_value name="$kAAIT_isHighRisk" exact="$kAAIT_result_isHighRisk" />
				<set_value name="$kAAIT_isShieldsLow_vsStation" exact="false" />
				<set_value name="$kAAIT_isShieldsLow_vsShip" exact="false" />
				<do_if value="$kAAIT_test_target_isTakeRisk.isclass.station">
					<set_value name="$kAAIT_isShieldsLow_vsStation" exact="this.assignedcontrolled.shieldpercentage lt @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$skill_shieldPercentage_withdrawAt_vStation" />
				</do_if>
				<do_elseif value="@$kAAIT_test_target_isTakeRisk.iscapitalship">
					<set_value name="$kAAIT_shieldValue_withdrawAt" exact="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$skill_shieldPercentage_withdrawAt_vShip / 100.0" />
					<do_if value="this.assignedcontrolled.iscapitalship" comment="LXL vs high-risk LXL: low shields determination uses ONLY shieldpercentage">
						<set_value name="$kAAIT_shieldValue_vsShip" exact="this.assignedcontrolled.shieldpercentage / ([$kAAIT_test_target_isTakeRisk.shieldpercentage, 0.1].max)f" />
						<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsTakeRisk $kAAIT_shieldValue_vsShip (LXL vs LXL): ' + @$kAAIT_shieldValue_vsShip" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
					</do_if>
					<do_else comment="XSSM vs high-risk LXL: low shields determination uses ALSO hullpercentage">
						<set_value name="$kAAIT_shieldValue_vsShip" exact="(this.assignedcontrolled.shieldpercentage + this.assignedcontrolled.hullpercentage) / ([$kAAIT_test_target_isTakeRisk.shieldpercentage + $kAAIT_test_target_isTakeRisk.hullpercentage, 0.1].max)f" />
						<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsTakeRisk $kAAIT_shieldValue_vsShip (XSSM vs LXL): ' + @$kAAIT_shieldValue_vsShip" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
					</do_else>
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsTakeRisk $kAAIT_shieldValue_withdrawAt: ' + @$kAAIT_shieldValue_withdrawAt" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
					<set_value name="$kAAIT_isShieldsLow_vsShip" exact="$kAAIT_shieldValue_vsShip lt $kAAIT_shieldValue_withdrawAt" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsTakeRisk $kAAIT_isShieldsLow_vsShip: ' + @$kAAIT_isShieldsLow_vsShip" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
				</do_elseif>
				<set_value name="$kAAIT_isFighter" exact="this.assignedcontrolled.primarypurpose == purpose.fight and @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$isAttacking" />
				<set_value name="$kAAIT_enemyGunCount" exact="[@$kAAIT_test_target_isHighRisk.weapons.operational.count, @$kAAIT_test_target_isHighRisk.turrets.operational.count].max" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsTakeRisk $kAAIT_enemyGunCount: ' + @$kAAIT_enemyGunCount" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
				<do_if value="this.assignedcontrolled.weapons.all.count">
					<set_value name="$kAAIT_isHasWeapons" exact="this.assignedcontrolled.weapons.all.count and this.assignedcontrolled.weapons.operational.count / (this.assignedcontrolled.weapons.all.count)f gt 0.25" />
				</do_if>
				<do_else>
					<set_value name="$kAAIT_isHasWeapons" exact="false" />
				</do_else>
				<set_value name="$kAAIT_isEnemyOverwhelmedVsAttackers" exact="false" />
				<do_if value="$kAAIT_isHasWeapons">
					<do_if value="not this.assignedcontrolled.iscapitalship">
						<set_value name="$kAAIT_perceivedAttackersCount" exact="@$kAAIT_target_highRiskEntity.$kAAIT_attackers.count * global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$skill_attackers_count_mult" />
						<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsTakeRisk $kAAIT_perceivedAttackersCount: ' + @$kAAIT_perceivedAttackersCount" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
						<do_if value="$kAAIT_test_target_isTakeRisk.isclass.ship">
							<do_if value="this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s]">
								<set_value name="$kAAIT_enemyGunCountTakeRiskThreshold" exact="$kAAIT_enemyGunCount * global.$kAAIT_Data.$xss_outnumberVShips / 100.0" />
							</do_if>
							<do_elseif value="this.assignedcontrolled.isclass.ship_m">
								<set_value name="$kAAIT_enemyGunCountTakeRiskThreshold" exact="$kAAIT_enemyGunCount * global.$kAAIT_Data.$m_outnumberVShips / 100.0" />
							</do_elseif>
						</do_if>
						<do_elseif value="$kAAIT_test_target_isTakeRisk.isclass.station">
							<do_if value="this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s]">
								<set_value name="$kAAIT_enemyGunCountTakeRiskThreshold" exact="$kAAIT_enemyGunCount * global.$kAAIT_Data.$xss_outnumberVStations / 100.0" />
							</do_if>
							<do_elseif value="this.assignedcontrolled.isclass.ship_m">
								<set_value name="$kAAIT_enemyGunCountTakeRiskThreshold" exact="$kAAIT_enemyGunCount * global.$kAAIT_Data.$m_outnumberVStations / 100.0" />
							</do_elseif>
						</do_elseif>
						<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsTakeRisk $kAAIT_enemyGunCountTakeRiskThreshold: ' + @$kAAIT_enemyGunCountTakeRiskThreshold" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
						<set_value name="$kAAIT_isEnemyOverwhelmedVsAttackers" exact="$kAAIT_perceivedAttackersCount gt $kAAIT_enemyGunCountTakeRiskThreshold" />
						<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsTakeRisk $kAAIT_isEnemyOverwhelmedVsAttackers: ' + @$kAAIT_isEnemyOverwhelmedVsAttackers" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
					</do_if>
				</do_if>
				<set_value name="$kAAIT_isPotentialOrActualHighRisk" exact="$kAAIT_isPotentialHighRisk or $kAAIT_isHighRisk" />
				<set_value name="$kAAIT_isStationOrShipHighRisk" exact="$kAAIT_test_target_isTakeRisk.isclass.station or $kAAIT_test_target_isTakeRisk.isclass.ship" />
				<set_value name="$kAAIT_hasMissilesOrTorpedoes" exact="this.assignedcontrolled.dps.missiles.all and this.assignedcontrolled.ammostorage.missile.count" />
				<set_value name="$kAAIT_isSacrificeSelf" exact="this.assignedcontrolled.shieldpercentage le 5 and this.assignedcontrolled.hullpercentage le 50" />
				<set_value name="$kAAIT_isFarFromTarget" exact="this.assignedcontrolled.bboxdistanceto.{$kAAIT_test_target_isTakeRisk} gt this.assignedcontrolled.maxradarrange" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsTakeRisk $kAAIT_isFighter:                                              ' + $kAAIT_isFighter" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsTakeRisk AND $kAAIT_isHasWeapons:                                       ' + $kAAIT_isHasWeapons" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsTakeRisk AND NOT $kAAIT_isPotentialOrActualHighRisk:                    ' + (not $kAAIT_isPotentialOrActualHighRisk) + ' actual: ' + $kAAIT_isPotentialOrActualHighRisk" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsTakeRisk     OR NOT $kAAIT_isStationOrShipHighRisk:                     ' + (not $kAAIT_isStationOrShipHighRisk) + ' actual: ' + $kAAIT_isStationOrShipHighRisk" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsTakeRisk     OR $kAAIT_test_target_isTakeRisk.isclass.station:          ' + $kAAIT_test_target_isTakeRisk.isclass.station" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsTakeRisk        AND NOT $kAAIT_isShieldsLow_vsStation:                  ' + (not $kAAIT_isShieldsLow_vsStation) + ' actual: ' + $kAAIT_isShieldsLow_vsStation" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsTakeRisk        AND this.assignedcontrolled.iscapitalship:              ' + @this.assignedcontrolled.iscapitalship" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsTakeRisk            OR $kAAIT_hasMissilesOrTorpedoes:                   ' + $kAAIT_hasMissilesOrTorpedoes" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsTakeRisk            OR $kAAIT_isEnemyOverwhelmedVsAttackers:            ' + $kAAIT_isEnemyOverwhelmedVsAttackers" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsTakeRisk     OR $kAAIT_test_target_isTakeRisk.isclass.ship:             ' + $kAAIT_test_target_isTakeRisk.isclass.ship" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsTakeRisk        AND    NOT $kAAIT_isShieldsLow_vsShip:                  ' + (not $kAAIT_isShieldsLow_vsShip) + ' actual: ' + @$kAAIT_isShieldsLow_vsShip" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsTakeRisk               AND @this.assignedcontrolled.iscapitalship:      ' + @this.assignedcontrolled.iscapitalship" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsTakeRisk                   OR $kAAIT_hasMissilesOrTorpedoes:            ' + $kAAIT_hasMissilesOrTorpedoes" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsTakeRisk                   OR $kAAIT_isEnemyOverwhelmedVsAttackers:     ' + $kAAIT_isEnemyOverwhelmedVsAttackers" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsTakeRisk            OR NOT $kAAIT_test_target_isTakeRisk.iscapitalship: ' + (not @$kAAIT_test_target_isTakeRisk.iscapitalship) + ' actual: ' + @$kAAIT_test_target_isTakeRisk.iscapitalship" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsTakeRisk               AND @this.assignedcontrolled.iscapitalship:      ' + @this.assignedcontrolled.iscapitalship" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsTakeRisk            OR $kAAIT_isFarFromTarget:                          ' + $kAAIT_isFarFromTarget" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsTakeRisk            OR $kAAIT_isSacrificeSelf:                          ' + $kAAIT_isSacrificeSelf" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance_avoidWithdrawOrJustFight else 0)" />
				<set_value name="$kAAIT_result_isTakeRisk" exact="
					$kAAIT_isFighter and
					$kAAIT_isHasWeapons and
					(
						(not $kAAIT_isPotentialOrActualHighRisk) or
						(not $kAAIT_isStationOrShipHighRisk) or
						(
							$kAAIT_test_target_isTakeRisk.isclass.station and
							(not $kAAIT_isShieldsLow_vsStation) and
							(
								@this.assignedcontrolled.iscapitalship or
								$kAAIT_hasMissilesOrTorpedoes or
								$kAAIT_isEnemyOverwhelmedVsAttackers
							)
						) or
						(
							$kAAIT_test_target_isTakeRisk.isclass.ship and
							(
								(
									(not $kAAIT_isShieldsLow_vsShip) and
									(
										@this.assignedcontrolled.iscapitalship or
										$kAAIT_hasMissilesOrTorpedoes or
										$kAAIT_isEnemyOverwhelmedVsAttackers
									)
								) or
								(
									(not $kAAIT_test_target_isTakeRisk.iscapitalship) and
									@this.assignedcontrolled.iscapitalship
								) or
								$kAAIT_isFarFromTarget or
								$kAAIT_isSacrificeSelf
							)
						)
					)" comment="v station: lxl or missiles + shields ok + weapons ok, v ship: shields ok + weapons ok" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsTakeRisk $kAAIT_result_isTakeRisk: ' + $kAAIT_result_isTakeRisk + ' vs ' + $kAAIT_test_target_isTakeRisk + ' ' + $kAAIT_test_target_isTakeRisk.knownname + ' ' + $kAAIT_test_target_isTakeRisk.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			</actions>

			<actions name="kAAIT_SaveWeaponStatsToData">
				<do_if value="(not this.isplayerowned) and (not @$kAAITParam_isAvoidHighRisk) and (not @$kAAITParam_isStepForwardWithdraw) and (not @$kAAITParam_iskAAITOrder)">
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_SaveWeaponStatsToData event.name: ' + event.name + ' order: ' + @this.assignedcontrolled.order.script" />
					<debug_text text="@this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP =================='" />
				</do_if>
				<do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData?">
					<include_interrupt_actions ref="kAAIT_Init" />
				</do_if>
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$dpsMainGuns" exact="this.assignedcontrolled.dps.all - this.assignedcontrolled.dps.turrets.all" />
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$dpsTurrets" exact="this.assignedcontrolled.dps.turrets.all" />
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$dpsByHQuadrant" exact="table[]" />
				<do_for_each name="$kAAIT_quadrant" in="[quadrant.front, quadrant.right, quadrant.left]">
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$dpsByHQuadrant.{$kAAIT_quadrant}" exact="this.assignedcontrolled.dps.turrets.{$kAAIT_quadrant}" />
				</do_for_each>
				<set_value name="$bestHQuadrant" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$dpsByHQuadrant.keys.sorted.last" />
				<do_if value="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$dpsByHQuadrant.{$bestHQuadrant} gt global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$dpsByHQuadrant.{quadrant.front} * 1.25">
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$bestHQuadrant" exact="$bestHQuadrant" />
				</do_if>
				<do_else>
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$bestHQuadrant" exact="quadrant.front" />
				</do_else>
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$dpsByVQuadrant" exact="table[]" />
				<do_for_each name="$kAAIT_quadrant" in="[quadrant.up, quadrant.down]">
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$dpsByVQuadrant.{$kAAIT_quadrant}" exact="this.assignedcontrolled.dps.turrets.{$kAAIT_quadrant}" />
				</do_for_each>
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$bestVQuadrant" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$dpsByVQuadrant.keys.sorted.last" />
				<do_if value="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$dpsMainGuns ge global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$dpsTurrets">
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_max" exact="[
						this.assignedcontrolled.maxcombatrange.primary,
						this.assignedcontrolled.maxcombatrange.secondary,
						this.assignedcontrolled.maxcombatrange.lasers.all,
						this.assignedcontrolled.maxcombatrange.missiles.all,
					].max * 0.9" />
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_min" exact="[
						this.assignedcontrolled.shortestmaxcombatrange.primary,
						this.assignedcontrolled.shortestmaxcombatrange.secondary,
						this.assignedcontrolled.shortestmaxcombatrange.lasers.all,
						this.assignedcontrolled.shortestmaxcombatrange.missiles.all,
					].min * 0.9" />
				</do_if>
				<do_else>
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_max" exact="this.assignedcontrolled.maxcombatrange.turrets * 0.9" />
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_min" exact="this.assignedcontrolled.shortestmaxcombatrange.turrets * 0.9" />
				</do_else>
				<do_if value="(not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_min) or global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_min == global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_max">
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_min" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_max * 0.3725" />
				</do_if>
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_mid" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_min + (global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_max - global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_min) * 0.5" />
			</actions>

			<actions name="kAAIT_GetIsHighRisk" comment="also update 'get is avoid or withdraw now' conditions in different handlers">
				<do_if value="(not this.isplayerowned) and (not @$kAAITParam_isAvoidHighRisk) and (not @$kAAITParam_isStepForwardWithdraw) and (not @$kAAITParam_iskAAITOrder)">
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsHighRisk order: ' + @this.assignedcontrolled.order.script" />
					<debug_text text="@this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ====='" />
				</do_if>
				<do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData?">
					<include_interrupt_actions ref="kAAIT_Init" />
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsHighRisk $kAAIT_test_target_isHighRisk: ' + @$kAAIT_test_target_isHighRisk.knownname + ' ' + @$kAAIT_test_target_isHighRisk.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<do_if value="@$kAAIT_test_target_isHighRisk.defensible">
					<set_value name="$kAAIT_test_target_isHighRisk" exact="$kAAIT_test_target_isHighRisk.defensible" />
				</do_if>
				<set_value name="$kAAIT_result_isPotentialHighRisk" exact="false" />
				<set_value name="$kAAIT_result_isHighRisk" exact="false" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsHighRisk $kAAIT_test_target_isHighRisk (defensible).isoperational: ' + @$kAAIT_test_target_isHighRisk.isoperational + ' ' + @$kAAIT_test_target_isHighRisk.knownname + ' ' + @$kAAIT_test_target_isHighRisk.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<do_if value="@$kAAIT_test_target_isHighRisk.isoperational">
					<do_if value="not @$kAAIT_target_highRiskEntity.isoperational">
						<set_value name="$kAAIT_target_highRiskEntity" exact="@$kAAIT_test_target_isHighRisk.assignedaipilot" />
						<do_if value="not @$kAAIT_target_highRiskEntity.isoperational">
							<set_value name="$kAAIT_target_highRiskEntity" exact="@$kAAIT_test_target_isHighRisk.defencenpc" />
						</do_if>
					</do_if>
					<do_if value="not @this.assignedcontrolled.iscapitalship">
						<set_value name="$kAAIT_result_isPotentialHighRisk" exact="
							$kAAIT_test_target_isHighRisk.dps.all and
							(
								@$kAAIT_test_target_isHighRisk.iscapitalship or
								$kAAIT_test_target_isHighRisk.isclass.station or
								$kAAIT_test_target_isHighRisk.threatscore gt this.assignedcontrolled.threatscore * 1.5
							)" />
						<set_value name="$kAAIT_result_isHighRisk" exact="
							$kAAIT_result_isPotentialHighRisk and
							(	this.assignedcontrolled.primarypurpose != purpose.fight or
								this.assignedcontrolled.hullpercentage le 25 or
								(
									@$kAAIT_test_target_isHighRisk.hullpercentage lt 1 and
									@$kAAIT_target_highRiskEntity.$kAAIT_attackers_lxl.count
								)
							)"/>
					</do_if>
					<do_elseif value="@this.assignedcontrolled.iscapitalship">
						<set_value name="$kAAIT_result_isPotentialHighRisk" exact="
							$kAAIT_test_target_isHighRisk.dps.all and
							(
								@$kAAIT_test_target_isHighRisk.iscapitalship or
								$kAAIT_test_target_isHighRisk.isclass.station or
								$kAAIT_test_target_isHighRisk.threatscore gt this.assignedcontrolled.threatscore * 1.5
							)" />
						<set_value name="$kAAIT_isEnemyDPSOverwhelming" exact="$kAAIT_test_target_isHighRisk.dps.all gt this.assignedcontrolled.dps.all * 1.5" />
						<set_value name="$kAAIT_result_isHighRisk" exact="
							$kAAIT_result_isPotentialHighRisk and
							(
								this.assignedcontrolled.primarypurpose != purpose.fight or
								$kAAIT_isEnemyDPSOverwhelming
							)" />
					</do_elseif>
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsHighRisk $kAAIT_result_isPotentialHighRisk: ' + @$kAAIT_result_isPotentialHighRisk + ' $kAAIT_result_isHighRisk: ' + @$kAAIT_result_isHighRisk" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			</actions>

			<actions name="kAAIT_SaveBigEnemiesToData">
				<do_if value="(not this.isplayerowned) and (not @$kAAITParam_isAvoidHighRisk) and (not @$kAAITParam_isStepForwardWithdraw) and (not @$kAAITParam_iskAAITOrder)">
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_SaveBigEnemiesToData order: ' + @this.assignedcontrolled.order.script" />
					<debug_text text="@this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ====='" />
				</do_if>
				<do_if value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$bigEnemies.count">
					<sort_group group="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$bigEnemies" sortbydistanceto="this.assignedcontrolled" sortdescending="false" />
				</do_if>
				<do_if value="
					(not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$bigEnemies.count) or
					@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$bigEnemies.{1}.bboxdistanceto.{this.assignedcontrolled} gt this.assignedcontrolled.maxradarrange * 0.5"
					comment="get new list if previous big enemy is now far">
					<do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData?">
						<include_interrupt_actions ref="kAAIT_Init" />
					</do_if>
					<!-- <do_if value="
						this.assignedcontrolled.commander.isoperational and
						this.assignedcontrolled.distanceto.{this.assignedcontrolled.commander} le this.assignedcontrolled.maxradarrange * 0.5 and
						@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.commander.idcode}.$attackData.$bigEnemies.count">
						<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$bigEnemies" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.commander.idcode}.$attackData.$bigEnemies" />
						<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_SaveBigEnemiesToData $bigEnemies.count (from commander): ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$bigEnemies.count" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					</do_if>
					<do_else> -->
						<create_group groupname="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$bigEnemies" />
						<find_gravidar_contact groupname="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$bigEnemies" object="this.assignedcontrolled" class="[class.ship_l, class.ship_xl, class.station]" docked="false" functional="true" maybeattackedby="this.assignedcontrolled" multiple="true" sortbydistanceto="this.assignedcontrolled" sortdescending="false" chance="if @this.sector.macro then 100 else 0">
							<match_context macro="[@this.sector.macro]"/>
							<match class="class.buildstorage" negate="true"/>
							<match state="componentstate.wreck" negate="true"/>
							<match_relation_to object="this.assignedcontrolled" relation="enemy" comparison="le" />
						</find_gravidar_contact>
						<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_SaveBigEnemiesToData $bigEnemies.count (find_gravidar_contact): ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$bigEnemies.count" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
						<do_if value="
							this.assignedcontrolled.commander.isclass.ship and
							this.assignedcontrolled.commander.isoperational and
							this.assignedcontrolled.distanceto.{this.assignedcontrolled.commander} le this.assignedcontrolled.maxradarrange and
							@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.commander.idcode}.$attackData and
							(not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.commander.idcode}.$attackData.$bigEnemies.count)">
							<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.commander.idcode}.$attackData.$bigEnemies" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$bigEnemies" />
						</do_if>
					<!-- </do_else> -->
					<sort_group group="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$bigEnemies" sortbydistanceto="this.assignedcontrolled" sortdescending="false" />
				</do_if>
				<do_for_each name="$kAAIT_bigEnemy_inList" in="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$bigEnemies" reverse="true">
					<do_if value="this.assignedcontrolled.bboxdistanceto.{$kAAIT_bigEnemy_inList} gt this.assignedcontrolled.maxradarrange"
						comment="remove non-enemy and any that is too far">
						<debug_text text="@this.assignedcontrolled.idcode + ' remove $kAAIT_bigEnemy_inList: ' + $kAAIT_bigEnemy_inList" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
						<remove_from_group group="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$bigEnemies" object="$kAAIT_bigEnemy_inList" />
					</do_if>
				</do_for_each>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_SaveBigEnemiesToData $bigEnemies.count (final): ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$bigEnemies.count" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			</actions>

			<actions name="kAAIT_GetIsNearBigEnemies">
				<do_if value="(not this.isplayerowned) and (not @$kAAITParam_isAvoidHighRisk) and (not @$kAAITParam_isStepForwardWithdraw) and (not @$kAAITParam_iskAAITOrder)">
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsNearBigEnemies order: ' + @this.assignedcontrolled.order.script" />
					<debug_text text="@this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ====='" />
				</do_if>
				<set_value name="$kAAIT_result_distanceToBigEnemy" exact="0" />
				<set_value name="$kAAIT_result_isShipNearBigEnemy" exact="false" />
				<set_value name="$kAAIT_result_bigEnemy" exact="null" />
				<do_if value="not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$bigEnemies.count">
					<include_interrupt_actions ref="kAAIT_SaveBigEnemiesToData" />
				</do_if>
				<do_if value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$bigEnemies.count">
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsNearBigEnemies $kAAIT_ignore_objects_getIsNearBigEnemies: ' + @$kAAIT_ignore_objects_getIsNearBigEnemies" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<do_for_each name="$kAAIT_bigEnemy_inList" in="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$bigEnemies">
						<do_if value="
							(not @$kAAIT_ignore_objects_getIsNearBigEnemies.count) or
							(not $kAAIT_ignore_objects_getIsNearBigEnemies.indexof.{$kAAIT_bigEnemy_inList})
						">
							<do_if value="@$kAAIT_test_position_getIsNearBigEnemy">
								<set_value name="$kAAIT_result_distanceToBigEnemy" exact="$kAAIT_bigEnemy_inList.bboxdistanceto.[this.assignedcontrolled, $kAAIT_test_position_getIsNearBigEnemy]" />
							</do_if>
							<do_else>
								<set_value name="$kAAIT_result_distanceToBigEnemy" exact="this.assignedcontrolled.bboxdistanceto.{$kAAIT_bigEnemy_inList}" />
							</do_else>
							<set_value name="$kAAIT_result_isShipNearBigEnemy" exact="$kAAIT_result_distanceToBigEnemy and $kAAIT_result_distanceToBigEnemy le this.assignedcontrolled.maxradarrange" />
							<do_if value="$kAAIT_result_isShipNearBigEnemy">
								<set_value name="$kAAIT_result_bigEnemy" exact="$kAAIT_bigEnemy_inList" />
								<break />
							</do_if>
							<do_else>
								<set_value name="$kAAIT_result_distanceToBigEnemy" exact="0" />
							</do_else>
						</do_if>
					</do_for_each>
					<remove_value name="$kAAIT_ignore_objects_getIsNearBigEnemies" />
					<remove_value name="$kAAIT_test_position_getIsNearBigEnemy" />
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsNearBigEnemies $kAAIT_result_distanceToBigEnemy: ' + $kAAIT_result_distanceToBigEnemy" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsNearBigEnemies $kAAIT_result_isShipNearBigEnemy: ' + $kAAIT_result_isShipNearBigEnemy" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsNearBigEnemies $kAAIT_result_bigEnemy: ' + @$kAAIT_result_bigEnemy.knownname + ' ' + @$kAAIT_result_bigEnemy.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			</actions>

			<actions name="kAAIT_FindSmallerTarget">
				<do_if value="(not this.isplayerowned) and (not @$kAAITParam_isAvoidHighRisk) and (not @$kAAITParam_isStepForwardWithdraw) and (not @$kAAITParam_iskAAITOrder)">
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_FindSmallerTarget order: ' + @this.assignedcontrolled.order.script" />
					<debug_text text="@this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP =================='" />
				</do_if>
				<set_value name="$kAAIT_result_target_found" exact="null" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_FindSmallerTarget this.assignedcontrolled.dps.all: ' + @this.assignedcontrolled.dps.all" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_FindSmallerTarget this.assignedcontrolled.primarypurpose: ' + @this.assignedcontrolled.primarypurpose" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<do_if value="
					this.assignedcontrolled.dps.all and
					this.assignedcontrolled.primarypurpose == purpose.fight and
					(
						(not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$attackOrder_smallTarget.exists) or
						(not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$attackOrder_smallTarget.$primarytarget.isoperational)
					)">
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_FindSmallerTarget this.assignedcontrolled.order.$allowothertargets: ' + @this.assignedcontrolled.order.$allowothertargets" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_FindSmallerTarget this.assignedcontrolled.orders.{2}.$allowothertargets: ' + @this.assignedcontrolled.orders.{2}.$allowothertargets" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<find_gravidar_contact groupname="$kAAIT_smallTargets" object="this.assignedcontrolled" class="[class.ship_xs, class.ship_s, class.ship_m]" docked="false" functional="true" maybeattackedby="this.assignedcontrolled" multiple="true" sortbydistanceto="this.assignedcontrolled" sortdescending="false">
						<match_context macro="[@this.sector.macro]"/>
						<match class="class.buildstorage" negate="true"/>
						<match state="componentstate.wreck" negate="true"/>
					</find_gravidar_contact>
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_FindSmallerTarget $kAAIT_smallTargets.count: ' + @$kAAIT_smallTargets.count" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<sort_group group="$kAAIT_smallTargets" sortbyvalue="loop.element.distanceto.{this.assignedcontrolled}" sortdescending="false" />
					<set_value name="$kAAIT_smallTarget" exact="@$kAAIT_smallTargets.{1}" />
					<do_if value="@$kAAIT_smallTarget.isoperational">
						<include_interrupt_actions ref="kAAIT_SaveBigEnemiesToData" />
						<sort_group group="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$bigEnemies" sortbyvalue="loop.element.distanceto.{$kAAIT_smallTarget}" sortdescending="false" />
						<set_value name="$kAAIT_bigEnemy" exact="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$bigEnemies.{1}" />
						<do_if value="@$kAAIT_bigEnemy.isoperational">
							<set_value name="$kAAIT_test_target_isInTheWay" exact="$kAAIT_bigEnemy" />
							<set_value name="$kAAIT_test_target_isInTheWayOf" exact="$kAAIT_smallTarget" />
							<include_interrupt_actions ref="kAAIT_GetIsInTheWay" />
							<do_if value="not $kAAIT_result_isTargetInTheWay">
								<set_value name="$kAAIT_result_target_found" exact="$kAAIT_smallTarget" />
							</do_if>
						</do_if>
					</do_if>
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_FindSmallerTarget $kAAIT_result_target_found: ' + @$kAAIT_result_target_found.knownname + ' ' + @$kAAIT_result_target_found.idcode + ' threatscore: ' + @$kAAIT_result_target_found.threatscore + ' weapons: ' + @$kAAIT_result_target_found.weapons.operational.count" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			</actions>

			<actions name="kAAIT_SaveSkillVarsToData" comment="also update 'get is avoid or withdraw now' conditions in different handlers">
				<do_if value="(not this.isplayerowned) and (not @$kAAITParam_isAvoidHighRisk) and (not @$kAAITParam_isStepForwardWithdraw) and (not @$kAAITParam_iskAAITOrder)">
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_SaveSkillVarsToData order: ' + @this.assignedcontrolled.order.script" />
					<debug_text text="@this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ====='" />
				</do_if>
				<do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData?">
					<include_interrupt_actions ref="kAAIT_Init" />
				</do_if>
				<do_if value="global.$kAAIT_Data.$isUseNPCSkills">
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$skill_attackers_count_mult" exact="2 - (this.skill.piloting + this.skill.morale) / 30.0 * 1" comment="0 = * 2, 5 = * 1" />
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$skill_distance_engagePosition_mult" exact="0.75 + (this.skill.piloting + this.skill.morale) / 30.0 * 0.25" comment="combat range max * (0 = * 0.75, 5 = 1)" />
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$skill_distance_stepForward_mult" exact="2 - (this.skill.piloting + this.skill.morale) / 30.0 * 1" comment="count of step forwards * (0 = 2km, 5 = 1km)" />
					<do_if value="not @this.assignedcontrolled.iscapitalship">
						<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$skill_shieldPercentage_withdrawAt_vShip" exact="75 + (this.skill.piloting + this.skill.morale) / 30.0 * 15" comment="0 = 75, 5 = 90" />
						<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$skill_shieldPercentage_withdrawAt_vStation" exact="75 + (this.skill.piloting + this.skill.morale) / 30.0 * 15" comment="0 = 75, 5 = 90" />
					</do_if>
					<do_elseif value="@this.assignedcontrolled.iscapitalship">
						<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$skill_shieldPercentage_withdrawAt_vShip" exact="75 + (this.skill.piloting + this.skill.morale) / 30.0 * 15" comment="0 = 75, 5 = 90" />
						<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$skill_shieldPercentage_withdrawAt_vStation" exact="75 + (this.skill.piloting + this.skill.morale) / 30.0 * 15" comment="0 = 75, 5 = 90" />
					</do_elseif>
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$skill_distance_withdraw" exact="this.assignedcontrolled.maxradarrange * (0.35 + (this.skill.piloting + this.skill.morale) / 30.0 * 0.15)" comment="0 = * 0.35, 5 = * 0.5" />
				</do_if>
				<do_else>
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$skill_attackers_count_mult" exact="1" />
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$skill_distance_engagePosition_mult" exact="1" />
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$skill_distance_stepForward_mult" exact="1" />
					<do_if value="not @this.assignedcontrolled.iscapitalship">
						<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$skill_shieldPercentage_withdrawAt_vShip" exact="90" />
						<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$skill_shieldPercentage_withdrawAt_vStation" exact="90" />
					</do_if>
					<do_elseif value="@this.assignedcontrolled.iscapitalship">
						<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$skill_shieldPercentage_withdrawAt_vShip" exact="25" />
						<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$skill_shieldPercentage_withdrawAt_vStation" exact="90" />
					</do_elseif>
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$skill_distance_withdraw" exact="this.assignedcontrolled.maxradarrange * 0.5" />
				</do_else>
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isSkillsSet" exact="true" />
			</actions>

			<actions name="kAAIT_GetEscortPos">
				<do_if value="(not this.isplayerowned) and (not @$kAAITParam_isAvoidHighRisk) and (not @$kAAITParam_isStepForwardWithdraw) and (not @$kAAITParam_iskAAITOrder)">
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetEscortPos order: ' + @this.assignedcontrolled.order.script" />
					<debug_text text="@this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ====='" />
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetEscortPos'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<create_position name="$kAAIT_pos_self" space="this.sector" object="this.assignedcontrolled" />
				<create_position name="$kAAIT_pos_escort" space="this.sector" object="$kAAIT_target_escort" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_target_escort: ' + $kAAIT_target_escort.knownname + ' ' + $kAAIT_target_escort.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<create_orientation name="$kAAIT_rot_fromEscort" orientation="look_at" refposition="$kAAIT_pos_self">
					<position value="$kAAIT_pos_escort" />
				</create_orientation>
				<set_value name="$kAAIT_yaw_fromEscort" exact="$kAAIT_rot_fromEscort.yaw * 180 / pi" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_yaw_fromEscort: ' + $kAAIT_yaw_fromEscort" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<set_value name="$kAAIT_pitch_fromEscort" exact="$kAAIT_rot_fromEscort.pitch * 180 / pi" />
				<set_value name="$kAAIT_getAttackTargetOf" exact="$kAAIT_target_escort" />
				<include_interrupt_actions ref="kAAIT_GetAttackTarget" />
				<do_if value="$kAAIT_result_attackTarget">
					<create_position name="$kAAIT_pos_escortEnemy" space="this.sector" object="$kAAIT_result_attackTarget" />
					<create_orientation name="$kAAIT_rot_fromEnemyToEscort" orientation="look_at" refposition="$kAAIT_pos_escort">
						<position value="$kAAIT_pos_escortEnemy" />
					</create_orientation>
					<set_value name="$kAAIT_result_yawDeg" exact="$kAAIT_rot_fromEnemyToEscort.yaw * 180 / pi" />
					<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_result_yawDeg: ' + $kAAIT_result_yawDeg" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<set_value name="$kAAIT_result_pitchDeg" exact="$kAAIT_rot_fromEnemyToEscort.pitch * 180 / pi" />
					<set_value name="$kAAIT_index_self" exact="$kAAIT_target_escort.subordinates.indexof.{this.assignedcontrolled}" />
					<set_value name="$kAAIT_maxAngle" exact="45" />
					<do_if value="$kAAIT_target_escort.subordinates.count gt 1">
						<set_value name="$kAAIT_angleForOneShip" exact="$kAAIT_maxAngle * 2 / ($kAAIT_target_escort.subordinates.count - 1)f" />
					</do_if>
					<do_else>
						<set_value name="$kAAIT_angleForOneShip" exact="5" />
					</do_else>
					<set_value name="$kAAIT_yaw_adj" exact="($kAAIT_maxAngle * -1) + (($kAAIT_index_self - 1) * $kAAIT_angleForOneShip)" />
					<set_value name="$kAAIT_result_yawDeg" operation="add" exact="$kAAIT_yaw_adj" />
				</do_if>
				<do_else>
					<set_value name="$kAAIT_result_yawDeg" exact="$kAAIT_yaw_fromEscort" />
					<set_value name="$kAAIT_result_pitchDeg" exact="$kAAIT_pitch_fromEscort" />
				</do_else>
				<set_value name="$kAAIT_result_yawRad" exact="$kAAIT_result_yawDeg * pi / 180" />
				<set_value name="$kAAIT_result_pitchRad" exact="$kAAIT_result_pitchDeg * pi / 180" />
				<create_position name="$kAAIT_result_pos_escort"
					x="$kAAIT_pos_escort.x + 10km * sin ($kAAIT_result_yawRad) * cos ($kAAIT_result_pitchRad)"
					y="$kAAIT_pos_escort.y + 10km * sin ($kAAIT_result_pitchRad)"
					z="$kAAIT_pos_escort.z + 10km * cos ($kAAIT_result_yawRad) * cos ($kAAIT_result_pitchRad)"/>
				<!-- <do_if value="$kAAIT_pos_escortEnemy">
					<create_orientation name="$kAAIT_rot_fromEnemyToEscort" orientation="look_at" refposition="$kAAIT_result_pos_escort">
						<position value="$kAAIT_pos_escortEnemy" />
					</create_orientation>
					<set_value name="$kAAIT_yaw_final" exact="$kAAIT_rot_fromEnemyToEscort.yaw * 180 / pi" />
					<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_yaw_final: ' + $kAAIT_yaw_final" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				</do_if> -->
			</actions>

			<actions name="kAAIT_GetDestination">
				<do_if value="(not this.isplayerowned) and (not @$kAAITParam_isAvoidHighRisk) and (not @$kAAITParam_isStepForwardWithdraw) and (not @$kAAITParam_iskAAITOrder)">
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetDestination order: ' + @this.assignedcontrolled.order.script" />
					<debug_text text="@this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ====='" />
				</do_if>
				<include_interrupt_actions ref="kAAIT_GetNonKAAITOrder" />
				<set_value name="$kAAIT_currentOrder" exact="$kAAIT_result_order" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetDestination $kAAIT_currentOrder: ' + @$kAAIT_currentOrder.script" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetDestination $kAAIT_currentOrder.$primarytarget: ' + @$kAAIT_currentOrder.$primarytarget" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetDestination $kAAIT_currentOrder.$selectedtarget: ' + @$kAAIT_currentOrder.$selectedtarget" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetDestination $kAAIT_currentOrder.$destination: ' + @$kAAIT_currentOrder.$destination" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetDestination $kAAIT_currentOrder.$target: ' + @$kAAIT_currentOrder.$target" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetDestination $jumpPathDataByOrderId: ' + @global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$jumpPathDataByOrderId.{'$' + $kAAIT_currentOrder.id}" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<set_value name="$kAAIT_result_destination_sourceId" exact="null" />
				<set_value name="$kAAIT_result_destination" exact="null" />
				<set_value name="$kAAIT_result_destinationSector" exact="null" />
				<set_value name="$kAAIT_result_destinationPosition" exact="null" />
				<do_if value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$forced_avoidDestination and global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$forced_avoidDestinationPosition">
					<set_value name="$kAAIT_result_destination_sourceId" exact="'forced_avoidDestination'" />
					<set_value name="$kAAIT_result_destination" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$forced_avoidDestination" />
					<set_value name="$kAAIT_result_destinationPosition" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$forced_avoidDestinationPosition" />
				</do_if>
				<do_elseif value="@$kAAIT_currentOrder.$primarytarget and @$kAAIT_currentOrder.$primarytarget.sector == this.sector and this.sector">
					<set_value name="$kAAIT_result_destination_sourceId" exact="'$primarytarget'" />
					<set_value name="$kAAIT_result_destination" exact="$kAAIT_currentOrder.$primarytarget" />
				</do_elseif>
				<do_elseif value="@$kAAIT_currentOrder.$selectedtarget and @$kAAIT_currentOrder.$selectedtarget.sector == this.sector and this.sector">
					<set_value name="$kAAIT_result_destination_sourceId" exact="'$selectedtarget'" />
					<set_value name="$kAAIT_result_destination" exact="$kAAIT_currentOrder.$selectedtarget" />
				</do_elseif>
				<do_elseif value="@$kAAIT_currentOrder.$destination">
					<set_value name="$kAAIT_result_destination_sourceId" exact="'$destination'" />
					<set_value name="$kAAIT_result_destination" exact="$kAAIT_currentOrder.$destination" />
					<set_value name="$kAAIT_result_destinationPosition" exact="@$kAAIT_currentOrder.$position" />
				</do_elseif>
				<do_elseif value="@$kAAIT_currentOrder.$target">
					<set_value name="$kAAIT_result_destination_sourceId" exact="'$target'" />
					<set_value name="$kAAIT_result_destination" exact="$kAAIT_currentOrder.$target" />
					<set_value name="$kAAIT_result_destinationPosition" exact="@$kAAIT_currentOrder.$position" />
				</do_elseif>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetDestination (orig values) $kAAIT_result_destination %s $kAAIT_result_destinationPosition %s'.[$kAAIT_result_destination, $kAAIT_result_destinationPosition]" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<do_if value="typeof $kAAIT_result_destination == datatype.list and typeof $kAAIT_result_destination.{2} == datatype.position">
					<set_value name="$kAAIT_result_destinationPosition" exact="@$kAAIT_result_destination.{2}" />
					<set_value name="$kAAIT_result_destination" exact="$kAAIT_result_destination.{1}" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetDestination (set from list) $kAAIT_result_destination %s $kAAIT_result_destinationPosition %s'.[$kAAIT_result_destination, $kAAIT_result_destinationPosition]" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetDestination (final) $kAAIT_result_destination %s %s %s %s $kAAIT_result_destinationPosition %s'.[$kAAIT_result_destination, @$kAAIT_result_destination.knownname, @$kAAIT_result_destination.idcode, @$kAAIT_result_destination.class, $kAAIT_result_destinationPosition]" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<do_if value="$kAAIT_result_destination">
					<do_if value="typeof $kAAIT_result_destinationPosition != datatype.position">
						<create_position name="$kAAIT_result_destinationPosition" x="0" y="0" z="0" />
					</do_if>
					<do_if value="$kAAIT_result_destination.isclass.sector">
						<set_value name="$kAAIT_result_destinationSector" exact="$kAAIT_result_destination" />
						<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetDestination $kAAIT_result_destinationSector (sector is dest): ' + $kAAIT_result_destinationSector + ' (' + @$kAAIT_result_destinationSector.knownname + ')'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
						<set_value name="$kAAIT_result_destinationSectorPosition" exact="$kAAIT_result_destinationPosition" />
					</do_if>
					<do_else>
						<set_value name="$kAAIT_result_destinationSector" exact="$kAAIT_result_destination.sector" />
						<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetDestination $kAAIT_result_destinationSector (sector is dest.sector): ' + $kAAIT_result_destinationSector + ' (' + @$kAAIT_result_destinationSector.knownname + ')'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
						<create_position name="$kAAIT_result_destinationSectorPosition" space="$kAAIT_result_destinationSector" object="$kAAIT_result_destination" value="$kAAIT_result_destinationPosition" />
					</do_else>
				</do_if>
				<do_elseif value="global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$jumpPathDataByOrderId.{'$' + $kAAIT_currentOrder.id}.$jumpPath?">
					<!-- get from jump paths if any -->
					<!-- assume that $kAAIT_result_destinationPosition is already in this.sector context -->
					<set_value name="$kAAIT_result_destination_sourceId" exact="'$jumpPathDataByOrderId'" />
					<set_value name="$kAAIT_result_destination" exact="global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$jumpPathDataByOrderId.{'$' + $kAAIT_currentOrder.id}.$jumpPath.{1}" />
					<set_value name="$kAAIT_result_destinationPosition" exact="position.[0, 0, 0]" />
					<set_value name="$kAAIT_result_destinationSector" exact="$kAAIT_result_destination.sector" />
					<create_position name="$kAAIT_result_destinationSectorPosition" space="$kAAIT_result_destinationSector" object="$kAAIT_result_destination" value="$kAAIT_result_destinationPosition" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetDestination (from $jumpPathDataByOrderId) $kAAIT_result_destination %s $kAAIT_result_destinationPosition %s'.[$kAAIT_result_destination, $kAAIT_result_destinationPosition]" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				</do_elseif>
				<do_else>
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetDestination reset because dest is not in sector and no jump path recorded'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<set_value name="$kAAIT_result_destination_sourceId" exact="null" />
					<set_value name="$kAAIT_result_destination" exact="null" />
					<set_value name="$kAAIT_result_destinationPosition" exact="null" />
					<set_value name="$kAAIT_result_destinationSector" exact="null" />
					<set_value name="$kAAIT_result_destinationSectorPosition" exact="null" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetDestination (reset) $kAAIT_result_destination %s $kAAIT_result_destinationPosition %s'.[$kAAIT_result_destination, $kAAIT_result_destinationPosition]" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				</do_else>
				<do_if value="not global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}?">
					<set_value name="global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}" exact="table[]" />
				</do_if>
				<!-- <do_if value="
					@this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode and
					@global.$kAAIT_Data.$debugChance
				">
					<do_if value="@this.$beacon_nextPathToDestination.exists">
						<destroy_object object="this.$beacon_nextPathToDestination" />
					</do_if>
					<create_position name="$pos_beacon" space="$kAAIT_result_destinationSector" object="$kAAIT_result_destination" value="$kAAIT_result_destinationPosition" />
					<create_object name="this.$beacon_nextPathToDestination" sector="$kAAIT_result_destinationSector" macro="macro.env_deco_nav_beacon_t1_macro" owner="faction.player">
						<position value="$pos_beacon" y="10km" />
					</create_object>
					<set_object_name object="this.$beacon_nextPathToDestination" name="'kAAIT: next path to destination'" />
				</do_if> -->
				<set_value name="global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$destination" exact="table[
					$order = $kAAIT_currentOrder,
					$from = $kAAIT_result_destination_sourceId,
					$destinationSector = $kAAIT_result_destinationSector,
					$destinationSectorPosition = $kAAIT_result_destinationSectorPosition,
					$nextPathComponent = $kAAIT_result_destination,
					$nextPathComponentPosition = $kAAIT_result_destinationPosition,
				]" />
				<!-- <do_if value="@$kAAIT_result_destination.defensible">
					<set_value name="$kAAIT_result_destination" exact="$kAAIT_result_destination.defensible" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetDestination $kAAIT_result_destination (defensible): ' + $kAAIT_result_destination + ' (' + @$kAAIT_result_destination.knownname + ')'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				</do_if> -->
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetDestination $kAAIT_result_destination_sourceId (final): ' + $kAAIT_result_destination_sourceId" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetDestination $kAAIT_result_destinationSector (final): ' + $kAAIT_result_destinationSector + ' (' + @$kAAIT_result_destinationSector.knownname + ')'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetDestination $kAAIT_result_destinationSectorPosition (final): ' + $kAAIT_result_destinationSectorPosition + ' (' + @$kAAIT_result_destinationSector.knownname + ')'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetDestination $kAAIT_result_destination (final): ' + $kAAIT_result_destination + ' (' + @$kAAIT_result_destination.knownname + ', ' + @$kAAIT_result_destination.idcode + ', ' + @$kAAIT_result_destination.class + ')'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetDestination $kAAIT_result_destinationPosition (final): ' + $kAAIT_result_destinationPosition" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetDestination this.assignedcontrolled.distanceto.[$kAAIT_result_destination, $kAAIT_result_destinationPosition]: ' + @this.assignedcontrolled.distanceto.[$kAAIT_result_destination, $kAAIT_result_destinationPosition]" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			</actions>

			<actions name="kAAIT_SaveJumpPathDataByOrderId">
				<do_if value="global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$jumpPathDataByOrderId?">
					<do_for_each name="$orderId" valuename="$jumpPathData" in="global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$jumpPathDataByOrderId" reverse="true">
						<do_if value="(not $jumpPathData.$order.exists) or $jumpPathData.$sector != this.sector">
							<remove_value name="global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$jumpPathDataByOrderId.{$orderId}" />
						</do_if>
					</do_for_each>
				</do_if>
				<do_if value="this.assignedcontrolled.order">
					<do_if value="not global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}?">
						<set_value name="global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}" exact="table[]" />
					</do_if>
					<do_if value="not global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$jumpPathDataByOrderId?">
						<set_value name="global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$jumpPathDataByOrderId" exact="table[]" />
					</do_if>
					<set_value name="global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$jumpPathDataByOrderId.{'$' + this.assignedcontrolled.order.id}" exact="table[
						$order = this.assignedcontrolled.order,
						$sector = this.sector,
						$jumpPath = $jumppath,
					]" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_SaveJumpPathDataByOrderId $jumpPathDataByOrderId.{$' + this.assignedcontrolled.order.id + '}: ' + @global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$jumpPathDataByOrderId.{'$' + this.assignedcontrolled.order.id}" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				</do_if>
			</actions>

			<actions name="kAAIT_GetIsInTheWay">
				<do_if value="(not this.isplayerowned) and (not @$kAAITParam_isAvoidHighRisk) and (not @$kAAITParam_isStepForwardWithdraw) and (not @$kAAITParam_iskAAITOrder)">
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsInTheWay order: ' + @this.assignedcontrolled.order.script" />
					<debug_text text="@this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ====='" />
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsInTheWay $kAAIT_test_target_isInTheWay: ' + @$kAAIT_test_target_isInTheWay.knownname + ' (' + @$kAAIT_test_target_isInTheWay.idcode + ')'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsInTheWay $kAAIT_test_target_isInTheWayOf: ' + @$kAAIT_test_target_isInTheWayOf.knownname + ' (' + @$kAAIT_test_target_isInTheWayOf.idcode + ')'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<do_if value="@$kAAIT_test_target_isInTheWayOf">
					<set_value name="$kAAIT_result_destination" exact="$kAAIT_test_target_isInTheWayOf" />
					<do_if value="$kAAIT_test_target_isInTheWayOf_position?">
						<set_value name="$kAAIT_result_destinationPosition" exact="$kAAIT_test_target_isInTheWayOf_position" />
					</do_if>
					<do_else>
						<set_value name="$kAAIT_result_destinationPosition" exact="position.[0,0,0]" />
					</do_else>
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsInTheWay $kAAIT_test_target_isInTheWayOf_position: ' + @$kAAIT_test_target_isInTheWayOf_position" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<do_if value="$kAAIT_result_destination.isclass.sector">
						<set_value name="$kAAIT_result_destinationSector" exact="$kAAIT_result_destination" />
						<do_if value="@$kAAIT_result_destinationPosition">
							<set_value name="kAAIT_result_destinationSectorPosition" exact="$kAAIT_result_destinationPosition" />
						</do_if>
						<do_else comment="get maxradarrange front from ship. not the ideal destination point as ship can be facing away from its destination, but there's no other better value.">
							<create_position name="$kAAIT_result_destinationSectorPosition" space="$kAAIT_result_destinationSector" object="this.assignedcontrolled" z="this.maxradarrange" />
						</do_else>
					</do_if>
					<do_else>
						<set_value name="$kAAIT_result_destinationSector" exact="$kAAIT_result_destination.sector" />
						<do_if value="@$kAAIT_result_destinationPosition">
							<create_position name="$kAAIT_result_destinationSectorPosition" space="$kAAIT_result_destinationSector" object="$kAAIT_result_destination" value="$kAAIT_result_destinationPosition" />
						</do_if>
						<do_else>
							<create_position name="$kAAIT_result_destinationSectorPosition" space="$kAAIT_result_destinationSector" object="$kAAIT_result_destination" />
						</do_else>
					</do_else>
					<remove_value name="$kAAIT_test_target_isInTheWayOf" />
					<remove_value name="$kAAIT_test_target_isInTheWayOf_position" />
				</do_if>
				<do_else>
					<include_interrupt_actions ref="kAAIT_GetDestination" comment="this sets $kAAIT_result_destination and $kAAIT_result_destinationPosition" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsInTheWay $kAAIT_result_destination (from kAAIT_GetDestination): ' + @$kAAIT_result_destination.knownname + ' (' + @$kAAIT_result_destination.idcode + ')'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				</do_else>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsInTheWay $kAAIT_result_destination (final): ' + @$kAAIT_result_destination.knownname + ' (' + @$kAAIT_result_destination.idcode + ')'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsInTheWay $kAAIT_result_destinationPosition (final): ' + @$kAAIT_result_destinationPosition" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<set_value name="$kAAIT_result_isTargetInTheWay" exact="false" />
				<do_if value="$kAAIT_result_destination != $kAAIT_test_target_isInTheWay and $kAAIT_result_destination and @$kAAIT_result_destinationPosition and $kAAIT_test_target_isInTheWay.hascontext.{$kAAIT_result_destinationSector}" comment="at this point this is in same sector as ship">
					<set_value name="$kAAIT_dist_obstacle" exact="this.assignedcontrolled.bboxdistanceto.{$kAAIT_test_target_isInTheWay}" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsInTheWay $kAAIT_dist_obstacle: ' + $kAAIT_dist_obstacle" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<set_value name="$kAAIT_dist_dest" exact="this.assignedcontrolled.distanceto.[$kAAIT_result_destination, $kAAIT_result_destinationPosition]" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsInTheWay $kAAIT_dist_dest: ' + $kAAIT_dist_dest" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<create_position name="$kAAIT_pos_obstacle" space="$kAAIT_result_destinationSector" object="$kAAIT_test_target_isInTheWay" /> 
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsInTheWay $kAAIT_pos_obstacle: ' + $kAAIT_pos_obstacle" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<set_value name="$kAAIT_dist_obstacleToDest" exact="$kAAIT_pos_obstacle.distanceto.{$kAAIT_result_destinationSectorPosition}" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsInTheWay $kAAIT_dist_obstacleToDest: ' + $kAAIT_dist_obstacleToDest" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<set_value name="$kAAIT_distObstacleIsDest" exact="0km" />
					<do_if value="$kAAIT_test_target_isInTheWay.isrealclass.station">
						<!-- kAAIT_distObstacleIsDest prevents ship from avoiding stations that are near destinations. e.g. defense stations around khaak main stations. -->
						<set_value name="$kAAIT_distObstacleIsDest" exact="10km" />
					</do_if>
					<do_else>
						<!-- for ship obstacles, greater chance to consider ship obstacle is in the way because ship obstacle needs to be really close (5km) to destination -->
						<set_value name="$kAAIT_distObstacleIsDest" exact="5km" />
					</do_else>
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsInTheWay $kAAIT_distObstacleIsDest (if obstacle is within this dist, then it is part of destination): ' + $kAAIT_distObstacleIsDest" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsInTheWay $kAAIT_dist_obstacleToDest le $kAAIT_distObstacleIsDest: ' + ($kAAIT_dist_obstacleToDest gt $kAAIT_distObstacleIsDest)" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<!--
						kAAIT_angleInSameVector = angle to test whether the obstacle is in the same vector as the destination.
						this angle changes based on the ship's distance from the obstacle.
						at 40km or farther, the angle test is 45 * 0.5 deg - i.e. smaller angle when far from the obstacle
						at 20km or nearer, the angle is at 45 deg - i.e. larger angle when near the obstacle
					-->
					<set_value name="$kAAIT_angleInSameVector" exact="abs(-1.125 * ($kAAIT_dist_obstacle / 1000.0) + 67.5)" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsInTheWay $kAAIT_angleInSameVector: ' + $kAAIT_angleInSameVector" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsInTheWay $kAAIT_dist_obstacle le this.assignedcontrolled.maxradarrange: ' + ($kAAIT_dist_obstacle le this.assignedcontrolled.maxradarrange)" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsInTheWay $kAAIT_dist_obstacle le $kAAIT_dist_dest: ' + ($kAAIT_dist_obstacle le $kAAIT_dist_dest)" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<do_if value="
						$kAAIT_dist_obstacle le this.assignedcontrolled.maxradarrange and
						$kAAIT_dist_obstacle le $kAAIT_dist_dest and
						$kAAIT_dist_obstacleToDest gt $kAAIT_distObstacleIsDest">
						<create_position name ="$kAAIT_pos_self" space="this.sector" object="this.assignedcontrolled" />
						<create_position name ="$kAAIT_pos_obstacle" space="this.sector" object="$kAAIT_test_target_isInTheWay" />
						<create_orientation name="$kAAIT_rot_obstacle" orientation="look_at" refposition="$kAAIT_pos_obstacle">
							<position value="$kAAIT_pos_self" />
						</create_orientation>
						<create_orientation name="$kAAIT_rot_dest" orientation="look_at" refposition="$kAAIT_result_destinationSectorPosition">
							<position value="$kAAIT_pos_self" />
						</create_orientation>
						<set_value name="$kAAIT_angle_from" exact="$kAAIT_rot_obstacle.yaw * 180 / pi" />
						<set_value name="$kAAIT_angle_to" exact="$kAAIT_rot_dest.yaw * 180 / pi" />
						<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsInTheWay testing yaw diff'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
						<include_interrupt_actions ref="kAAIT_GetAngleDiffAndMid" />
						<do_if value="$kAAIT_angle_diff gt $kAAIT_angleInSameVector * -1 and $kAAIT_angle_diff lt $kAAIT_angleInSameVector * 1">
							<set_value name="$kAAIT_angle_from" exact="$kAAIT_rot_obstacle.pitch * 180 / pi" />
							<set_value name="$kAAIT_angle_to" exact="$kAAIT_rot_dest.pitch * 180 / pi" />
							<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsInTheWay testing pitch diff'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
							<include_interrupt_actions ref="kAAIT_GetAngleDiffAndMid" />
							<do_if value="$kAAIT_angle_diff gt $kAAIT_angleInSameVector * -1 and $kAAIT_angle_diff lt $kAAIT_angleInSameVector * 1">
								<set_value name="$kAAIT_result_isTargetInTheWay" exact="true" />
							</do_if>
						</do_if>
					</do_if>
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsInTheWay $kAAIT_result_isTargetInTheWay: ' + @$kAAIT_result_isTargetInTheWay" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			</actions>

			<actions name="kAAIT_GetAttackOrIgnoreTargetInTheWay">
				<do_if value="(not this.isplayerowned) and (not @$kAAITParam_isAvoidHighRisk) and (not @$kAAITParam_isStepForwardWithdraw) and (not @$kAAITParam_iskAAITOrder)">
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetAttackOrIgnoreTargetInTheWay order: ' + @this.assignedcontrolled.order.script" />
					<debug_text text="@this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ====='" />
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetAttackOrIgnoreTargetInTheWay $kAAIT_test_attackTargetInTheWayOrNot: ' + @$kAAIT_test_attackTargetInTheWayOrNot.knownname + ' (' + @$kAAIT_test_attackTargetInTheWayOrNot.idcode + ')'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<set_value name="$kAAIT_result_isTargetInTheWayAttacked" exact="false" />
				<set_value name="$kAAIT_result_isTargetInTheWayIgnored" exact="false" />
				<do_if value="$kAAIT_test_attackTargetInTheWayOrNot.isclass.ship">
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetAttackOrIgnoreTargetInTheWay $kAAIT_test_attackTargetInTheWayOrNot: ' + @$kAAIT_test_attackTargetInTheWayOrNot.knownname + ' ' + @$kAAIT_test_attackTargetInTheWayOrNot.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<set_value name="$kAAIT_test_target_isTakeRisk" exact="$kAAIT_test_attackTargetInTheWayOrNot" />
					<include_interrupt_actions ref="kAAIT_GetIsTakeRisk" />
					<do_if value="$kAAIT_result_isTakeRisk">
						<do_if value="$kAAIT_test_attackTargetInTheWayOrNot.threatscore gt this.assignedcontrolled.threatscore * 1.5 and $kAAIT_test_attackTargetInTheWayOrNot.primarypurpose == purpose.fight">
							<do_if value="@this.assignedcontrolled.order.$allowothertargets">
								<set_value name="$kAAIT_target_attack" exact="$kAAIT_test_target_isTakeRisk" />
								<include_interrupt_actions ref="kAAIT_Order_AttackOther" />
								<set_value name="$kAAIT_result_isTargetInTheWayAttacked" exact="@$kAAIT_result_order_attackOther.exists" />
							</do_if>
						</do_if>
						<do_else comment="ignore ship in the way">
							<set_value name="$kAAIT_result_isTargetInTheWayIgnored" exact="true" />
						</do_else>
					</do_if>
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetAttackOrIgnoreTargetInTheWay $kAAIT_result_isTargetInTheWayAttacked: ' + $kAAIT_result_isTargetInTheWayAttacked" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetAttackOrIgnoreTargetInTheWay $kAAIT_result_isTargetInTheWayIgnored: ' + $kAAIT_result_isTargetInTheWayIgnored" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			</actions>

			<actions name="kAAIT_LimitAngleToNegPos180">
				<!-- input: $kAAIT_angle -->
				<!-- output: $kAAIT_angle -->
				<!-- <debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_LimitAngleToNegPos180 $kAAIT_angle (start): ' + @$kAAIT_angle" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" /> -->
				<do_while value="$kAAIT_angle gt 180">
					<set_value name="$kAAIT_angle" operation="subtract" exact="360" />
					<!-- <debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_LimitAngleToNegPos180 $kAAIT_angle (gt 180, so subtract 360): ' + @$kAAIT_angle" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" /> -->
				</do_while>
				<do_while value="$kAAIT_angle lt -180">
					<set_value name="$kAAIT_angle" operation="add" exact="360" />
					<!-- <debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_LimitAngleToNegPos180 $kAAIT_angle (lt 180, so add 360): ' + @$kAAIT_angle" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" /> -->
				</do_while>
			</actions>

			<actions name="kAAIT_LimitAngleTo360">
				<!-- input: $kAAIT_angle -->
				<!-- output: $kAAIT_angle -->
				<do_while value="$kAAIT_angle lt 0">
					<set_value name="$kAAIT_angle" operation="add" exact="360" />
				</do_while>
				<do_while value="$kAAIT_angle gt 360">
					<set_value name="$kAAIT_angle" operation="subtract" exact="360" />
				</do_while>
			</actions>

			<actions name="kAAIT_GetAngleDiffAndMid">
				<!-- in degrees: -->
				<!-- input: $kAAIT_angle_from, $kAAIT_angle_to -->
				<!-- output: $kAAIT_angle_diff, $kAAIT_angle_mid -->
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetAngleDiffAndMid $kAAIT_angle_from: ' + $kAAIT_angle_from" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetAngleDiffAndMid $kAAIT_angle_to: ' + $kAAIT_angle_to" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<set_value name="$kAAIT_angle_from_orig" exact="$kAAIT_angle_from" />
				<set_value name="$kAAIT_angle_to_orig" exact="$kAAIT_angle_to" />
				<set_value name="$kAAIT_angle" exact="$kAAIT_angle_from" />
				<include_interrupt_actions ref="kAAIT_LimitAngleToNegPos180" />
				<set_value name="$kAAIT_angle_from" exact="$kAAIT_angle" />
				<set_value name="$kAAIT_angle" exact="$kAAIT_angle_to" />
				<include_interrupt_actions ref="kAAIT_LimitAngleToNegPos180" />
				<set_value name="$kAAIT_angle_to" exact="$kAAIT_angle" />
				<set_value name="$kAAIT_angle_diff" exact="$kAAIT_angle_to - $kAAIT_angle_from" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetAngleDiffAndMid $kAAIT_angle_diff: ' + $kAAIT_angle_diff" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<do_if value="$kAAIT_angle_diff lt -180 or $kAAIT_angle_diff gt 180">
					<set_value name="$kAAIT_angle" exact="$kAAIT_angle_from_orig" />
					<include_interrupt_actions ref="kAAIT_LimitAngleTo360" />
					<set_value name="$kAAIT_angle_from" exact="$kAAIT_angle" />
					<set_value name="$kAAIT_angle" exact="$kAAIT_angle_to_orig" />
					<include_interrupt_actions ref="kAAIT_LimitAngleTo360" />
					<set_value name="$kAAIT_angle_to" exact="$kAAIT_angle" />
					<set_value name="$kAAIT_angle_diff" exact="$kAAIT_angle_to - $kAAIT_angle_from" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetAngleDiffAndMid $kAAIT_angle_diff (smaller arc): ' + $kAAIT_angle_diff" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				</do_if>
				<set_value name="$kAAIT_angleToAddForAngleMid" exact="0" />
				<do_if value="not @$kAAIT_midAngleFactorMult">
					<set_value name="$kAAIT_midAngleFactorMult" exact="0.5" />
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetAngleDiffAndMid $kAAIT_midAngleFactorMult: ' + $kAAIT_midAngleFactorMult" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<set_value name="$kAAIT_angleToAddForAngleMid" exact="$kAAIT_angle_diff * $kAAIT_midAngleFactorMult" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetAngleDiffAndMid $kAAIT_angleToAddForAngleMid: ' + $kAAIT_angleToAddForAngleMid" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetAngleDiffAndMid $kAAIT_midAngleDiffMax: ' + @$kAAIT_midAngleDiffMax" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<do_if value="@$kAAIT_midAngleDiffMax">
					<do_if value="abs($kAAIT_angleToAddForAngleMid) gt $kAAIT_midAngleDiffMax">
						<do_if value="$kAAIT_angleToAddForAngleMid lt 0">
							<set_value name="$kAAIT_angleToAddForAngleMid" exact="$kAAIT_midAngleDiffMax * -1" />
						</do_if>
						<do_else>
							<set_value name="$kAAIT_angleToAddForAngleMid" exact="$kAAIT_midAngleDiffMax" />
						</do_else>
						<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetAngleDiffAndMid $kAAIT_angleToAddForAngleMid (post cap): ' + $kAAIT_angleToAddForAngleMid" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					</do_if>
					<remove_value name="$kAAIT_midAngleFactorMult" />
				</do_if>
				<set_value name="$kAAIT_angle_mid" exact="$kAAIT_angle_from + $kAAIT_angleToAddForAngleMid" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetAngleDiffAndMid $kAAIT_angle_mid: ' + $kAAIT_angle_mid" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<set_value name="$kAAIT_angle" exact="$kAAIT_angle_mid" />
				<include_interrupt_actions ref="kAAIT_LimitAngleToNegPos180" />
				<set_value name="$kAAIT_angle_mid" exact="$kAAIT_angle" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetAngleDiffAndMid $kAAIT_angle_diff (final): ' + $kAAIT_angle_diff" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetAngleDiffAndMid $kAAIT_angle_mid (normalised, final): ' + $kAAIT_angle_mid" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			</actions>

			<actions name="kAAIT_CheckDefaultOrderOfCommander" comment="in the base game, the replacement commander doesn't acquire the previous commander's default order. this leaves all subordinates to be dumb - sometimes only responding to threads after they've attacked.">
				<do_if value="this.assignedcontrolled.commander and global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData?">
					<set_value name="$kAAIT_commanderId" exact="@this.assignedcontrolled.commander.idcode" />
					<set_value name="$kAAIT_commanderId_previous" exact="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$commanderId" />
					<!-- restore, if required -->
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_CheckDefaultOrderOfCommander restore first, if required. $kAAIT_commanderId: ' + $kAAIT_commanderId + ', $kAAIT_commanderId_previous: ' + $kAAIT_commanderId_previous" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<debug_text text="@this.assignedcontrolled.idcode + ' this.assignedcontrolled.commander.defaultorder.script: ' + @this.assignedcontrolled.commander.defaultorder.script" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<debug_text text="@this.assignedcontrolled.idcode + ' this.assignedcontrolled.commander.defaultorder.$target.isoperational: ' + @this.assignedcontrolled.commander.defaultorder.$target.isoperational" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<do_if value="
						$kAAIT_commanderId != $kAAIT_commanderId_previous or
						(
							@this.assignedcontrolled.commander.defaultorder.script == 'order.fight.escort' and
							(not @this.assignedcontrolled.commander.defaultorder.$target.isoperational)
						)"
						comment="invalid escort order, restore if an order was saved">
						<do_if value="$kAAIT_commanderId_previous">
							<include_interrupt_actions ref="kAAIT_RestoreDefaultOrderOfCommander" />
						</do_if>
					</do_if>
					<!-- save, if required -->
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_CheckDefaultOrderOfCommander then save, if required. $kAAIT_commanderId: ' + $kAAIT_commanderId + ', $kAAIT_commanderId_previous: ' + $kAAIT_commanderId_previous" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<set_value name="$kAAIT_order" exact="this.assignedcontrolled.commander.defaultorder" />
					<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_order.script ' + @$kAAIT_order.script + ' $kAAIT_order.exists ' + @$kAAIT_order.exists" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<do_if value="$kAAIT_commanderId != $kAAIT_commanderId_previous and $kAAIT_order.exists">
						<debug_text text="@this.assignedcontrolled.idcode + ' global.$kAAIT_Data.$defaultOrdersByShipId.{$' + $kAAIT_commanderId + '}: ' + @global.$kAAIT_Data.$defaultOrdersByShipId.{'$' + $kAAIT_commanderId}" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
						<debug_text text="@this.assignedcontrolled.idcode + ' player.age - @global.$kAAIT_Data.$defaultOrdersByShipId.{$' + $kAAIT_commanderId + '}.$time: ' + (player.age - @global.$kAAIT_Data.$defaultOrdersByShipId.{'$' + $kAAIT_commanderId}.$time)" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
						<do_if value="
							(not @global.$kAAIT_Data.$defaultOrdersByShipId.{'$' + $kAAIT_commanderId}) or
							player.age - @global.$kAAIT_Data.$defaultOrdersByShipId.{'$' + $kAAIT_commanderId}.$time gt 1s
						">
							<do_if value="$kAAIT_order.script == 'order.fight.escort'">
								<set_value name="global.$kAAIT_Data.$defaultOrdersByShipId.{'$' + $kAAIT_commanderId}" exact="table[
									$commanderId = this.assignedcontrolled.commander.idcode,
									$time = player.age,
									$id                     = 'Escort',
									$target                 = $kAAIT_order.$target,
									$formation              = $kAAIT_order.$formation,
									$rollmembers            = $kAAIT_order.$rollmembers,
									$rollformation          = $kAAIT_order.$rollformation,
									$maxshipsperline        = $kAAIT_order.$maxshipsperline,
									$pursuedistance         = $kAAIT_order.$pursuedistance,
									$timeout                = $kAAIT_order.$timeout,
									$overrideformationskill = $kAAIT_order.$overrideformationskill,
									$cannotdock             = $kAAIT_order.$cannotdock,
									$releasesignal          = $kAAIT_order.$releasesignal,
									$subordinateorders      = $kAAIT_order.$subordinateorders,
									$endontargetdeath       = $kAAIT_order.$endontargetdeath,
									$thresholdbreak         = $kAAIT_order.$thresholdbreak
								]" />
								<remove_value name="global.$kAAIT_Data.$defaultOrdersByShipId.{'$' + $kAAIT_commanderId_previous}" />
								<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_CheckDefaultOrderOfCommander (saved): ' + global.$kAAIT_Data.$defaultOrdersByShipId.{'$' + $kAAIT_commanderId}" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
							</do_if>
							<do_elseif value="$kAAIT_order.script == 'order.fight.patrol'">
								<set_value name="global.$kAAIT_Data.$defaultOrdersByShipId.{'$' + $kAAIT_commanderId}" exact="table[
									$commanderId = this.assignedcontrolled.commander.idcode,
									$time = player.age,
									$id                           = 'Patrol',
									$space                        = $kAAIT_order.$space,
									$range                        = $kAAIT_order.$range,
									$pursuetargets                = $kAAIT_order.$pursuetargets,
									$pursuedistance               = $kAAIT_order.$pursuedistance,
									$includeroute                 = $kAAIT_order.$includeroute,
									$allowothertargets            = $kAAIT_order.$allowothertargets,
									$targetpurposes               = $kAAIT_order.$targetpurposes,
									$stayinspace                  = $kAAIT_order.$stayinspace,
									$usebasket                    = $kAAIT_order.$usebasket,
									$timeout                      = $kAAIT_order.$timeout,
									$engageonlyonline             = $kAAIT_order.$engageonlyonline,
									$targetclasses                = $kAAIT_order.$targetclasses,
									$stayhidden                   = $kAAIT_order.$stayhidden,
									$organizesubordinates         = $kAAIT_order.$organizesubordinates,
									$defences_maxgatedistance     = $kAAIT_order.$defences_maxgatedistance,
									$defences_includedassignments = $kAAIT_order.$defences_includedassignments,
									$checkrelation                = $kAAIT_order.$checkrelation
								]" />
								<remove_value name="global.$kAAIT_Data.$defaultOrdersByShipId.{'$' + $kAAIT_commanderId_previous}" />
								<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_CheckDefaultOrderOfCommander (saved): ' + global.$kAAIT_Data.$defaultOrdersByShipId.{'$' + $kAAIT_commanderId}" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
							</do_elseif>
							<do_elseif value="$kAAIT_order.script == 'order.fight.protect.position'">
								<set_value name="global.$kAAIT_Data.$defaultOrdersByShipId.{'$' + $kAAIT_commanderId}" exact="table[
									$commanderId = this.assignedcontrolled.commander.idcode,
									$time = player.age,
									$id                = 'ProtectPosition',
									$destination       = $kAAIT_order.$destination,
									$radius            = $kAAIT_order.$radius,
									$pursuetargets     = $kAAIT_order.$pursuetargets,
									$attackonsight     = $kAAIT_order.$attackonsight,
									$reinforcefleet    = $kAAIT_order.$reinforcefleet,
									$resupplyatfleet   = $kAAIT_order.$resupplyatfleet,
									$flagship          = $kAAIT_order.$flagship,
									$timeout           = $kAAIT_order.$timeout
								]" />
								<remove_value name="global.$kAAIT_Data.$defaultOrdersByShipId.{'$' + $kAAIT_commanderId_previous}" />
								<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_CheckDefaultOrderOfCommander (saved): ' + global.$kAAIT_Data.$defaultOrdersByShipId.{'$' + $kAAIT_commanderId}" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
							</do_elseif>
							<do_elseif value="$kAAIT_order.script == 'order.fight.protect.ship'">
								<set_value name="global.$kAAIT_Data.$defaultOrdersByShipId.{'$' + $kAAIT_commanderId}" exact="table[
									$commanderId = this.assignedcontrolled.commander.idcode,
									$time = player.age,
									$id             = 'ProtectShip',
									$target         = $kAAIT_order.$target,
									$radius         = $kAAIT_order.$radius,
									$timeout        = $kAAIT_order.$timeout,
									$pursuedistance = $kAAIT_order.$pursuedistance,
									$untilclaimed   = $kAAIT_order.$untilclaimed
								]" />
								<remove_value name="global.$kAAIT_Data.$defaultOrdersByShipId.{'$' + $kAAIT_commanderId_previous}" />
								<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_CheckDefaultOrderOfCommander (saved): ' + global.$kAAIT_Data.$defaultOrdersByShipId.{'$' + $kAAIT_commanderId}" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
							</do_elseif>
							<do_elseif value="$kAAIT_order.script == 'order.fight.protect.station'">
								<set_value name="global.$kAAIT_Data.$defaultOrdersByShipId.{'$' + $kAAIT_commanderId}" exact="table[
									$commanderId = this.assignedcontrolled.commander.idcode,
									$time = player.age,
									$id             = 'ProtectStation',
									$station         = $kAAIT_order.$station,
									$radius         = $kAAIT_order.$radius,
									$timeout        = $kAAIT_order.$timeout
								]" />
								<remove_value name="global.$kAAIT_Data.$defaultOrdersByShipId.{'$' + $kAAIT_commanderId_previous}" />
								<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_CheckDefaultOrderOfCommander (saved): ' + global.$kAAIT_Data.$defaultOrdersByShipId.{'$' + $kAAIT_commanderId}" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
							</do_elseif>
						</do_if>
					</do_if>
					<do_if value="$kAAIT_commanderId">
						<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$commanderId" exact="$kAAIT_commanderId" />
					</do_if>
				</do_if>
			</actions>

			<actions name="kAAIT_RestoreDefaultOrderOfCommander" comment="in the base game, the replacement commander doesn't acquire the previous commander's default order. this leaves all subordinates to be dumb - sometimes only responding to threads after they've attacked.">
				<set_value name="$kAAIT_commanderId" exact="@this.assignedcontrolled.commander.idcode" />
				<set_value name="$kAAIT_commanderId_previous" exact="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$commanderId" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_RestoreDefaultOrderOfCommander $kAAIT_commanderId: ' + $kAAIT_commanderId + ', $kAAIT_commanderId_previous: ' + $kAAIT_commanderId_previous" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<do_if value="this.assignedcontrolled.commander and $kAAIT_commanderId_previous">
					<set_value name="$kAAIT_order" exact="@global.$kAAIT_Data.$defaultOrdersByShipId.{'$' + $kAAIT_commanderId_previous}" />
					<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_order.script ' + @$kAAIT_order.$id" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<do_if value="
						$kAAIT_order and
						(
							$kAAIT_commanderId != $kAAIT_commanderId_previous or
							(
								this.assignedcontrolled.commander.defaultorder.script == 'order.fight.escort' and
								(not @this.assignedcontrolled.commander.defaultorder.$target.exists)
							)
						)"
						comment="invalid escort order, restore if an order was saved">
						<do_if value="$kAAIT_order.$id == 'Escort'">
							<create_order object="this.assignedcontrolled.commander" id="'Escort'" default="true">
								<param name="target"                 value ="$kAAIT_order.$target" />
								<param name="formation"              value ="$kAAIT_order.$formation" />
								<param name="rollmembers"            value ="$kAAIT_order.$rollmembers" />
								<param name="rollformation"          value ="$kAAIT_order.$rollformation"/>
								<param name="maxshipsperline"        value ="$kAAIT_order.$maxshipsperline"/>
								<param name="pursuedistance"         value ="$kAAIT_order.$pursuedistance"/>
								<!-- <param name="timeout"           value ="$kAAIT_order.$timeout"/> -->
								<param name="overrideformationskill" value ="$kAAIT_order.$overrideformationskill"/>
								<param name="cannotdock"             value ="$kAAIT_order.$cannotdock"/>
								<param name="releasesignal"          value ="$kAAIT_order.$releasesignal"/>
								<param name="subordinateorders"      value ="$kAAIT_order.$subordinateorders"/>
								<param name="endontargetdeath"       value ="$kAAIT_order.$endontargetdeath"/>
								<param name="thresholdbreak"         value ="$kAAIT_order.$thresholdbreak"/>
							</create_order>
							<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_CheckDefaultOrderOfCommander (restored): ' + $kAAIT_order" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
						</do_if>
						<do_elseif value="$kAAIT_order.$id == 'Patrol'">
							<create_order object="this.assignedcontrolled.commander" id="'Patrol'" default="true">
								<param name="space"                        value ="$kAAIT_order.$space" />
								<param name="range"                        value ="$kAAIT_order.$range" />
								<param name="pursuetargets"                value ="$kAAIT_order.$pursuetargets" />
								<param name="pursuedistance"               value ="$kAAIT_order.$pursuedistance"/>
								<param name="includeroute"                 value ="$kAAIT_order.$includeroute"/>
								<param name="allowothertargets"            value ="$kAAIT_order.$allowothertargets"/>
								<param name="targetpurposes"               value ="$kAAIT_order.$targetpurposes"/>
								<param name="stayinspace"                  value ="$kAAIT_order.$stayinspace"/>
								<param name="usebasket"                    value ="$kAAIT_order.$usebasket"/>
								<!-- <param name="timeout"                 value ="$kAAIT_order.$timeout"/> -->
								<param name="engageonlyonline"             value ="$kAAIT_order.$engageonlyonline"/>
								<param name="targetclasses"                value ="$kAAIT_order.$targetclasses"/>
								<param name="stayhidden"                   value ="$kAAIT_order.$stayhidden"/>
								<param name="organizesubordinates"         value ="$kAAIT_order.$organizesubordinates"/>
								<param name="defences_maxgatedistance"     value ="$kAAIT_order.$defences_maxgatedistance"/>
								<param name="defences_includedassignments" value ="$kAAIT_order.$defences_includedassignments"/>
								<param name="checkrelation"                value ="$kAAIT_order.$checkrelation"/>
							</create_order>
							<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_CheckDefaultOrderOfCommander (restored): ' + $kAAIT_order" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
						</do_elseif>
						<do_elseif value="$kAAIT_order.$id == 'ProtectPosition'">
							<create_order object="this.assignedcontrolled.commander" id="'ProtectPosition'" default="true">
								<param name="destination"     value ="$kAAIT_order.$destination" />
								<param name="radius"          value ="$kAAIT_order.$radius" />
								<param name="pursuetargets"   value ="$kAAIT_order.$pursuetargets" />
								<param name="attackonsight"   value ="$kAAIT_order.$attackonsight"/>
								<param name="reinforcefleet"  value ="$kAAIT_order.$reinforcefleet"/>
								<param name="resupplyatfleet" value ="$kAAIT_order.$resupplyatfleet"/>
								<param name="flagship"        value ="$kAAIT_order.$flagship"/>
								<!-- <param name="timeout"    value ="$kAAIT_order.$timeout"/> -->
							</create_order>
							<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_CheckDefaultOrderOfCommander (restored): ' + $kAAIT_order" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
						</do_elseif>
						<do_elseif value="$kAAIT_order.$id == 'ProtectShip'">
							<create_order object="this.assignedcontrolled.commander" id="'ProtectShip'" default="true">
								<param name="target"         value ="$kAAIT_order.$target" />
								<param name="radius"         value ="$kAAIT_order.$radius" />
								<!-- <param name="timeout"   value ="$kAAIT_order.$timeout" /> -->
								<param name="pursuedistance" value ="$kAAIT_order.$pursuedistance"/>
								<param name="untilclaimed"   value ="$kAAIT_order.$untilclaimed"/>
							</create_order>
							<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_CheckDefaultOrderOfCommander (restored): ' + $kAAIT_order" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
						</do_elseif>
						<do_elseif value="$kAAIT_order.$id == 'ProtectStation'">
							<create_order object="this.assignedcontrolled.commander" id="'ProtectStation'" default="true">
								<param name="station"      value ="$kAAIT_order.$station" />
								<param name="radius"       value ="$kAAIT_order.$radius" />
								<!-- <param name="timeout" value ="$kAAIT_order.$timeout"/> -->
							</create_order>
							<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_CheckDefaultOrderOfCommander (restored): ' + $kAAIT_order" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
						</do_elseif>
					</do_if>
				</do_if>
			</actions>

			<actions name="kAAIT_GetIsOkToResupply">
				<set_value name="$kAAIT_result_isOkToResupply" exact="true" />
				<set_value name="$kAAIT_result_isOkToResupply_reason" exact="'no reason, should be ok to repair'" />
				<do_if value="this.assignedcontrolled.hullpercentage gt 25">
					<include_interrupt_actions ref="kAAIT_SaveBigEnemiesToData" />
					<include_interrupt_actions ref="kAAIT_GetIsNearBigEnemies" />
					<do_if value="this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl]">
						<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_lxl_repair_queue (self): ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_lxl_repair_queue.knownname + ' ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_lxl_repair_queue.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
						<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_lxl_repair_queue (commander): ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.commander.idcode}.$kAAIT_lxl_repair_queue.knownname + ' ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.commander.idcode}.$kAAIT_lxl_repair_queue.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					</do_if>
					<do_if value="@$kAAIT_result_bigEnemy.isoperational">
						<set_value name="$kAAIT_result_isOkToResupply" exact="false" />
						<set_value name="$kAAIT_result_isOkToResupply_reason" exact="'big enemy'" />
					</do_if>
					<!--
						=========================================
						limit l and xl ships going to repair to 1
						=========================================
						search for $kAAIT_lxl_repair_queue
					-->
					<do_elseif value="
						this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
						(
							@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_lxl_repair_queue.exists or
							@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.commander.idcode}.$kAAIT_lxl_repair_queue.exists
						)
					">
						<set_value name="$kAAIT_result_isOkToResupply" exact="false" />
						<set_value name="$kAAIT_result_isOkToResupply_reason" exact="'lxl in fleet already repairing'" />
					</do_elseif>
					<do_elseif value="this.assignedcontrolled.commander.isoperational">
						<do_if value="
							@this.assignedcontrolled.commander.order.$kAAITParam_iskAAITOrder or
							@this.assignedcontrolled.commander.order.script == 'order.fight.attack.object' or
							@this.assignedcontrolled.commander.nextorder.script == 'order.fight.attack.object' or
							@this.assignedcontrolled.commander.order.script == 'order.fight.tactical' or
							@this.assignedcontrolled.commander.nextorder.script == 'order.fight.tactical'">
							<set_value name="$kAAIT_result_isOkToResupply" exact="false" />
							<set_value name="$kAAIT_result_isOkToResupply_reason" exact="'commander in combat'" />
						</do_if>
					</do_elseif>
					<do_else>
						<do_if value="
							@this.assignedcontrolled.commander.order.$kAAITParam_iskAAITOrder or
							@this.assignedcontrolled.order.script == 'order.fight.attack.object' or
							@this.assignedcontrolled.nextorder.script == 'order.fight.attack.object' or
							@this.assignedcontrolled.order.script == 'order.fight.tactical' or
							@this.assignedcontrolled.nextorder.script == 'order.fight.tactical'">
							<set_value name="$kAAIT_result_isOkToResupply" exact="false" />
							<set_value name="$kAAIT_result_isOkToResupply_reason" exact="'in combat'" />
						</do_if>
					</do_else>
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_result_isOkToResupply ($kAAIT_lxl_repair_queue: ' + $kAAIT_result_isOkToResupply_reason + '): ' + $kAAIT_result_isOkToResupply" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<!-- <debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_result_isOkToResupply: ' + $kAAIT_result_isOkToResupply" /> -->
			</actions>

			<actions name="kAAIT_GetAvoidYawTowardsDestination" comment="get avoid yaw that leads to the ship's destination. yaw from = usually heading the ship needs to avoid, yaw to = heading to the ship's destination. result = yaw between those two.">
				<!-- in degrees: -->
				<!-- input: $kAAIT_yaw_from, $kAAIT_yaw_to -->
				<!-- output: $kAAIT_result_avoidYawTowardsDestination -->
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetAvoidYawTowardsDestination $kAAIT_yaw_from: ' + $kAAIT_yaw_from" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetAvoidYawTowardsDestination $kAAIT_yaw_to: ' + $kAAIT_yaw_to" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<set_value name="$kAAIT_angle_from" exact="$kAAIT_yaw_from" />
				<set_value name="$kAAIT_angle_to" exact="$kAAIT_yaw_to" />
				<include_interrupt_actions ref="kAAIT_GetAngleDiffAndMid" />
				<set_value name="$kAAIT_result_avoidYawTowardsDestination" exact="$kAAIT_angle_mid" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetAvoidYawTowardsDestination $kAAIT_result_avoidYawTowardsDestination: ' + $kAAIT_result_avoidYawTowardsDestination" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			</actions>

			<actions name="GetAvoidPosVectorAndObject" comment="avoid pos = average pos of target and big enemies, avoid yaw = 'average' yaw from target and big enemies to ship">
				<!--
				inputs: $kAAIT_target_avoid
				outputs: $kAAIT_result_avoidPos, $kAAIT_result_avoidYaw, $kAAIT_result_avoidPitch, $kAAIT_result_avoidObject, $kAAIT_result_avoidDistance
				-->
				<set_value name="$kAAIT_result_avoidPos" exact="null" />
				<set_value name="$kAAIT_result_avoidYaw" exact="null" />
				<set_value name="$kAAIT_result_avoidPitch" exact="null" />
				<set_value name="$kAAIT_result_avoidObject" exact="null" />
				<set_value name="$kAAIT_result_avoidDistance" exact="null" />
				<create_position name="$kAAIT_pos_ship" space="this.sector" object="this.assignedcontrolled" />
				<debug_text text="@this.assignedcontrolled.idcode + ' GetAvoidPosVectorAndObject $kAAIT_pos_ship: ' + $kAAIT_pos_ship" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<include_interrupt_actions ref="kAAIT_SaveBigEnemiesToData" />
				<set_value name="$kAAIT_avoidObjects" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$bigEnemies.list.clone" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_avoidObjects (from big enemies list): ' + $kAAIT_avoidObjects" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<do_if value="
					@$kAAIT_target_avoid.isoperational and
					(not $kAAIT_avoidObjects.indexof.{$kAAIT_target_avoid}) and
					(
						(not $kAAIT_avoidObjects.count) or
						this.assignedcontrolled.bboxdistanceto.{$kAAIT_target_avoid} le this.assignedcontrolled.maxradarrange * 0.5
					)">
					<append_to_list name="$kAAIT_avoidObjects" exact="$kAAIT_target_avoid" />
					<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_avoidObjects (added $kAAIT_target_avoid, ' + $kAAIT_target_avoid.knownname + ', ' + @$kAAIT_target_avoid.idcode + '): ' + $kAAIT_avoidObjects" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				</do_if>
				<sort_list list="$kAAIT_avoidObjects" sortbyvalue="this.assignedcontrolled.bboxdistanceto.{loop.element}" sortdescending="false" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_avoidObjects (sorted): ' + $kAAIT_avoidObjects" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<set_value name="$kAAIT_yaws" exact="[]" />
				<set_value name="$kAAIT_pitches" exact="[]" />
				<set_value name="$kAAIT_hasAvoidStation" exact="false" />
				<do_for_each name="$kAAIT_avoidObject" in="$kAAIT_avoidObjects" counter="$i">
					<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_avoidObject (' + $i + '): ' + $kAAIT_avoidObject.knownname + ', ' + @$kAAIT_avoidObject.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<set_value name="$kAAIT_hasAvoidStation" exact="$kAAIT_hasAvoidStation or $kAAIT_avoidObject.isclass.station" />
					<create_position name="$kAAIT_pos_avoidObject" space="this.sector" object="$kAAIT_avoidObject" />
					<set_value name="$kAAIT_dist_avoidObjectToShip" exact="$kAAIT_pos_avoidObject.bboxdistanceto.{this.assignedcontrolled}" />
					<create_orientation name="$kAAIT_rot_avoidObjectToShip" orientation="look_at" refposition="$kAAIT_pos_ship">
						<position value="$kAAIT_pos_avoidObject" />
					</create_orientation>
					<set_value name="$kAAIT_yaw_avoidObjectToShip" exact="$kAAIT_rot_avoidObjectToShip.yaw * 180 / pi" />
					<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_yaw_avoidObjectToShip: ' + $kAAIT_yaw_avoidObjectToShip" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<set_value name="$kAAIT_pitch_avoidObjectToShip" exact="$kAAIT_rot_avoidObjectToShip.pitch * 180 / pi" />
					<append_to_list name="$kAAIT_yaws" exact="$kAAIT_yaw_avoidObjectToShip" />
					<append_to_list name="$kAAIT_pitches" exact="$kAAIT_pitch_avoidObjectToShip" />
					<do_if value="$i == 1">
						<set_value name="$kAAIT_result_avoidObject" exact="$kAAIT_avoidObject" />
						<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_result_avoidObject: ' + $kAAIT_result_avoidObject.knownname + ', ' + $kAAIT_result_avoidObject.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
						<set_value name="$kAAIT_result_avoidDistance" exact="$kAAIT_dist_avoidObjectToShip" />
						<set_value name="$kAAIT_result_avoidPos" exact="$kAAIT_pos_avoidObject" />
						<set_value name="$kAAIT_result_avoidYaw" exact="$kAAIT_yaw_avoidObjectToShip" />
						<set_value name="$kAAIT_result_avoidPitch" exact="$kAAIT_pitch_avoidObjectToShip" />
					</do_if>
					<do_elseif value="this.assignedcontrolled.cansee.{$kAAIT_avoidObject}">
						<do_if value="[$kAAIT_yaw_avoidObjectToShip - $kAAIT_result_avoidYaw, $kAAIT_result_avoidYaw - $kAAIT_yaw_avoidObjectToShip].max ge 90"
							comment="this new vector is too wide from other vectors, consider avoiding this object as well">
							<do_if value="$kAAIT_dist_avoidObjectToShip le $kAAIT_result_avoidDistance">
								<set_value name="$kAAIT_result_avoidObject" exact="$kAAIT_avoidObject" />
								<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_result_avoidObject: ' + $kAAIT_result_avoidObject.knownname + ', ' + $kAAIT_result_avoidObject.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
								<set_value name="$kAAIT_result_avoidDistance" exact="$kAAIT_dist_avoidObjectToShip" />
								<set_value name="$kAAIT_result_avoidPitch" exact="$kAAIT_pitch_avoidObjectToShip" />
							</do_if>
							<create_position name="$kAAIT_result_avoidPos"
								x="$kAAIT_result_avoidPos.x + ($kAAIT_pos_avoidObject.x - $kAAIT_result_avoidPos.x) * 0.5"
								y="$kAAIT_result_avoidPos.y + ($kAAIT_pos_avoidObject.y - $kAAIT_result_avoidPos.y) * 0.5"
								z="$kAAIT_result_avoidPos.z + ($kAAIT_pos_avoidObject.z - $kAAIT_result_avoidPos.z) * 0.5"
							/>
						</do_if>
					</do_elseif>
				</do_for_each>
				<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_yaws: ' + $kAAIT_yaws" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_pitches: ' + $kAAIT_pitches" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<do_if value="$kAAIT_yaws.count gt 1">
					<!-- this is the middle position of all objects to avoid -->
					<create_orientation name="$kAAIT_rotAvoidPosToShip" orientation="look_at" refposition="$kAAIT_pos_ship">
						<position value="$kAAIT_result_avoidPos" />
					</create_orientation>
					<!-- get ideal yaw and pitch from all avoid objects -->
					<set_value name="$kAAIT_result_avoidYaw" exact="null" />
					<set_value name="$kAAIT_result_avoidPitch" exact="null" />
					<do_all counter="$kAAIT_count" exact="$kAAIT_yaws.count">
						<do_if value="not $kAAIT_result_avoidYaw">
							<set_value name="$kAAIT_result_avoidYaw" exact="$kAAIT_yaws.{$kAAIT_count}" />
							<set_value name="$kAAIT_result_avoidPitch" exact="$kAAIT_pitches.{$kAAIT_count}" />
						</do_if>
						<do_else>
							<set_value name="$kAAIT_angle_from" exact="$kAAIT_result_avoidYaw" />
							<set_value name="$kAAIT_angle_to" exact="$kAAIT_yaws.{$kAAIT_count}" />
							<include_interrupt_actions ref="kAAIT_GetAngleDiffAndMid" />
							<do_if value="$kAAIT_angle_diff gt -90 or $kAAIT_angle_diff lt 90">
								<!-- do not ignore this yaw. take the mid angle for the new avoid yaw -->
								<set_value name="$kAAIT_result_avoidYaw" exact="$kAAIT_angle_mid" />
								<set_value name="$kAAIT_angle_from" exact="$kAAIT_result_avoidPitch" />
								<set_value name="$kAAIT_angle_to" exact="$kAAIT_pitches.{$kAAIT_count}" />
								<include_interrupt_actions ref="kAAIT_GetAngleDiffAndMid" />
								<set_value name="$kAAIT_result_avoidPitch" exact="$kAAIT_angle_mid" />
							</do_if>
						</do_else>
					</do_all>
					<!-- <set_value name="$kAAIT_result_avoidYaw" exact="$kAAIT_rotAvoidPosToShip.yaw * 180 / pi" />
					<set_value name="$kAAIT_result_avoidPitch" exact="$kAAIT_rotAvoidPosToShip.pitch * 180 / pi" /> -->
					<!-- <do_if value="not $kAAIT_hasAvoidStation">
						<do_if value="$kAAIT_result_avoidPitch le -45">
							<set_value name="$kAAIT_result_avoidPitch" exact="-45" />
						</do_if>
						<do_elseif value="$kAAIT_result_avoidPitch gt 45">
							<set_value name="$kAAIT_result_avoidPitch" exact="45" />
						</do_elseif>
					</do_if> -->
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_result_avoidYaw: ' + $kAAIT_result_avoidYaw + ' $kAAIT_result_avoidPitch: ' + $kAAIT_result_avoidPitch" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			</actions>

			<actions name="kAAIT_GetIsMoveToEngage">
				<set_value name="$kAAIT_result_isMovetoEngage" exact="false" />
				<set_value name="$kAAIT_result_isMovetoEngage_reason" exact="null" />
				<set_value name="$kAAIT_test_moveToEngageTargetDefensible" exact="null" />
				<do_if value="$kAAIT_test_moveToEngageTarget.defensible">
					<set_value name="$kAAIT_test_moveToEngageTargetDefensible" exact="$kAAIT_test_moveToEngageTarget.defensible" />
				</do_if>
				<do_if value="$kAAIT_test_moveToEngageTarget.isrealclass.station or @$kAAIT_test_moveToEngageTargetDefensible.isrealclass.station">
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsMoveToEngage $kAAIT_test_moveToEngageTarget: ' + $kAAIT_test_moveToEngageTarget + ' (' + $kAAIT_test_moveToEngageTarget.knownname + ' , ' + @$kAAIT_test_moveToEngageTarget.hullpercentage + ')'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsMoveToEngage $kAAIT_test_moveToEngageTargetDefensible: ' + $kAAIT_test_moveToEngageTargetDefensible + ' (' + $kAAIT_test_moveToEngageTargetDefensible.knownname + ' , ' + @$kAAIT_test_moveToEngageTargetDefensible.hullpercentage + ')'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsMoveToEngage $defensibleTarget: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget + ' (' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget.knownname + ' , ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget.hullpercentage + ') $defensibleTarget_stoppedKamikaze: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget_stoppedKamikaze + ' (' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget_stoppedKamikaze.knownname + ', ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget_stoppedKamikaze.hullpercentage + ')'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<set_value name="$kAAIT_distToTarget" exact="this.assignedcontrolled.bboxdistanceto.{$kAAIT_test_moveToEngageTarget}" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsMoveToEngage $kAAIT_distToTarget: ' + $kAAIT_distToTarget" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<do_if value="$kAAIT_test_moveToEngageTargetDefensible">
						<set_value name="$kAAIT_dps" exact="@$kAAIT_test_moveToEngageTargetDefensible.dps.all" />
						<set_value name="$kAAIT_distToDefensible" exact="this.assignedcontrolled.bboxdistanceto.{$kAAIT_test_moveToEngageTargetDefensible}" />
						<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsMoveToEngage $kAAIT_distToDefensible: ' + $kAAIT_distToDefensible" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					</do_if>
					<include_interrupt_actions ref="KAAIT_GetEngagePosDistance" />
					<set_value name="$kAAIT_engagePosDist" exact="$kAAIT_result_engagePosDist" />
					<set_value name="$kAAIT_dps" exact="@$kAAIT_test_moveToEngageTarget.dps.all" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsMoveToEngage .script %s $DefensibleScript %s'.[this.assignedcontrolled.order.script, @$DefensibleScript]" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<do_if value="$kAAIT_dps gt this.assignedcontrolled.dps.all * 0.5 and @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget != @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget_stoppedKamikaze">
						<set_value name="$kAAIT_result_isMovetoEngage_reason" exact="'kamikaze check'" />
						<set_value name="$kAAIT_result_isMovetoEngage" exact="true" />
					</do_if>
					<do_elseif value="$kAAIT_distToTarget gt $kAAIT_engagePosDist * 1.5">
						<set_value name="$kAAIT_result_isMovetoEngage_reason" exact="'too far'" />
						<set_value name="$kAAIT_result_isMovetoEngage" exact="true" />
					</do_elseif>
					<do_elseif value="($kAAIT_distToTarget le [@$movethreshold_min, 1km].max)">
						<set_value name="$kAAIT_result_isMovetoEngage_reason" exact="'too near'" />
						<set_value name="$kAAIT_result_isMovetoEngage" exact="true" />
					</do_elseif>
					<do_elseif value="
						@this.assignedcontrolled.order.script == 'order.fight.attack.object' and
						$distance? and $distance gt 0 and
						$target? and $target.sector and $targetposition? and
						$movethreshold_min? and $movethreshold_min gt 0 and
						$distance le [$movethreshold_min, 1km].max">
						<set_value name="$kAAIT_result_isMovetoEngage_reason" exact="'too near based on $distance var from attack script'" />
						<set_value name="$kAAIT_result_isMovetoEngage" exact="true" />
					</do_elseif>
					<do_elseif value="$kAAIT_dps gt this.assignedcontrolled.dps.all * 0.5">
						<do_if value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$moveToEngage_yawTargetToShip">
							<!-- moveToEngage_yawTargetToShip is from the target's defensible -->
							<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsMoveToEngage $moveToEngage_yawTargetToShip: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$moveToEngage_yawTargetToShip" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
							<create_position name="$kAAIT_pos_ship" space="$kAAIT_test_moveToEngageTarget.sector" object="this.assignedcontrolled" />
							<do_if value="$kAAIT_test_moveToEngageTargetDefensible">
								<create_position name="$kAAIT_posTarget" space="$kAAIT_test_moveToEngageTarget.sector" object="$kAAIT_test_moveToEngageTargetDefensible" />
							</do_if>
							<do_else>
								<create_position name="$kAAIT_posTarget" space="$kAAIT_test_moveToEngageTarget.sector" object="$kAAIT_test_moveToEngageTarget" />
							</do_else>
							<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsMoveToEngage $kAAIT_posTarget: ' + $kAAIT_posTarget" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
							<create_orientation name="$kAAIT_rotTargetToShip" orientation="look_at" refposition="$kAAIT_pos_ship">
								<position value="$kAAIT_posTarget" />
							</create_orientation>
							<set_value name="$kAAIT_yawTargetToShip" exact="$kAAIT_rotTargetToShip.yaw * 180 / pi" />
							<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsMoveToEngage $kAAIT_yawTargetToShip: ' + $kAAIT_yawTargetToShip" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
							<set_value name="$kAAIT_angle_from" exact="$kAAIT_yawTargetToShip" />
							<set_value name="$kAAIT_angle_to" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$moveToEngage_yawTargetToShip" />
							<include_interrupt_actions ref="kAAIT_GetAngleDiffAndMid" />
							<do_if value="abs($kAAIT_angle_diff) gt 15 * 0.5">
								<set_value name="$kAAIT_result_isMovetoEngage_reason" exact="'not at vector (i.e. yaw) to target yet'" />
								<set_value name="$kAAIT_result_isMovetoEngage" exact="true" />
							</do_if>
						</do_if>
					</do_elseif>
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget_stoppedKamikaze" exact="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget" />
					<do_if value="(not $kAAIT_result_isMovetoEngage) and
						$kAAIT_test_moveToEngageTargetDefensible and
						$kAAIT_test_moveToEngageTarget.distanceto.{$kAAIT_test_moveToEngageTargetDefensible} and
						$kAAIT_distToTarget gt $kAAIT_distToDefensible * 1.25">
						<set_value name="$kAAIT_result_isMovetoEngage_reason" exact="'too near defensible and far from target'" />
						<set_value name="$kAAIT_result_isMovetoEngage" exact="true" />
					</do_if>
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsMoveToEngage $kAAIT_result_isMovetoEngage: ' + $kAAIT_result_isMovetoEngage" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsMoveToEngage $kAAIT_result_isMovetoEngage_reason: ' + $kAAIT_result_isMovetoEngage_reason" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			</actions>

			<actions name="kAAIT_SetMoveToEngageYawFromTarget" comment="yaw is from the target to the ship">
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_SetMoveToEngageYawFromTarget $kAAIT_test_moveToEngageTarget: ' + @$kAAIT_test_moveToEngageTarget.knownname + ' ' + @$kAAIT_test_moveToEngageTarget.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<set_value name="$kAAIT_result_moveToEngageYaw" exact="0" />
				<set_value name="$kAAIT_result_moveToEngageYawFrom" exact="0" />
				<set_value name="$kAAIT_result_moveToEngageYawMid" exact="0" />
				<set_value name="$kAAIT_result_moveToEngageYawDiff" exact="0" />
				<set_value name="$kAAIT_test_moveToEngageTargetDefensible" exact="$kAAIT_test_moveToEngageTarget" />
				<do_if value="$kAAIT_test_moveToEngageTarget.defensible">
					<set_value name="$kAAIT_test_moveToEngageTargetDefensible" exact="$kAAIT_test_moveToEngageTarget.defensible" />
				</do_if>
				<create_position name="$kAAIT_posShip" space="$kAAIT_test_moveToEngageTarget.sector" object="this.assignedcontrolled" />
				<create_position name="$kAAIT_posTarget" space="$kAAIT_test_moveToEngageTarget.sector" object="$kAAIT_test_moveToEngageTarget" />
				<set_value name="$kAAIT_shipIndex" exact="@this.assignedcontrolled.commander.allsubordinates.indexof.{this.assignedcontrolled}" />
				<do_if value="$kAAIT_shipIndex % 2 == 0">
					<set_value name="$kAAIT_yaw_jitter" exact="$kAAIT_shipIndex * 1" />
				</do_if>
				<do_else>
					<set_value name="$kAAIT_yaw_jitter" exact="$kAAIT_shipIndex * -1" />
				</do_else>
				<do_if value="$kAAIT_test_moveToEngageTarget.defensible and $kAAIT_test_moveToEngageTarget.sector and this.assignedcontrolled.hascontext.{$kAAIT_test_moveToEngageTarget.sector}">
					<create_position name="$kAAIT_posDefensibleTarget" space="$kAAIT_test_moveToEngageTarget.sector" object="$kAAIT_test_moveToEngageTarget.defensible" />
					<create_orientation name="$kAAIT_rotDefensibleTargetToShip" orientation="look_at" refposition="$kAAIT_posShip">
						<position value="$kAAIT_posDefensibleTarget" />
					</create_orientation>
					<create_orientation name="$kAAIT_rotDefensibleTargetToTarget" orientation="look_at" refposition="$kAAIT_posTarget">
						<position value="$kAAIT_posDefensibleTarget" />
					</create_orientation>
					<!-- $targetsWithDifficultLOS is set at move.attack.object.capital when $holdposition (i.e. LOS check) is false -->
					<set_value name="$isDifficultLOS" exact="@global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData.$targetsWithDifficultLOS.indexof.{$kAAIT_test_moveToEngageTarget}" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_SetMoveToEngageYawFromTarget $isDifficultLOS: ' + $isDifficultLOS" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<do_if value="$isDifficultLOS">
						<set_value name="$kAAIT_yawAdj" exact="30" />
					</do_if>
					<do_else>
						<set_value name="$kAAIT_yawAdj" exact="45" />
					</do_else>
					<!-- start: adj attack vector based on distance of module target to 0,0,0
						kAAIT_yawAdj = 0 at origin, 45 at mid, 0 at max dist
						sinusoidal formula:
						dist = target.distanceto.{defensibleTarget}
						adj = 45 * sin((pi * dist)/max dist) -->
					<do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTargetEntity.$dist_moduleFarFromOrigin?">
						<find_module name="$kAAIT_moduleFarFromOrigin" object="$kAAIT_test_moveToEngageTarget.defensible" sortbyvalue="loop.element.distanceto.[$kAAIT_test_moveToEngageTarget.sector, $kAAIT_posDefensibleTarget]" sortdescending="true" />
						<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTargetEntity.$dist_moduleFarFromOrigin" exact="@$kAAIT_moduleFarFromOrigin.distanceto.{$kAAIT_test_moveToEngageTarget.defensible}" />
						<do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTargetEntity.$dist_moduleFarFromOrigin">
							<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTargetEntity.$dist_moduleFarFromOrigin" exact="$kAAIT_test_moveToEngageTarget.size * 0.75" />
						</do_if>
					</do_if>
					<set_value name="$kAAIT_distMax" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTargetEntity.$dist_moduleFarFromOrigin" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_SetMoveToEngageYawFromTarget $kAAIT_distMax: ' + $kAAIT_distMax" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<do_if value="not $kAAIT_distMax">
						<set_value name="$kAAIT_distMax" exact="$kAAIT_test_moveToEngageTarget.size * 0.5" />
						<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_SetMoveToEngageYawFromTarget $kAAIT_distMax (was 0, force to half size of target): ' + $kAAIT_distMax" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					</do_if>
					<set_value name="$kAAIT_dist" exact="$kAAIT_test_moveToEngageTarget.bboxdistanceto.{$kAAIT_test_moveToEngageTargetDefensible}" />
					<do_if value="(not $kAAIT_dist) and $kAAIT_test_moveToEngageTarget.isclass.module">
						<include_interrupt_actions ref="kAAIT_GetDistOfFarthestModuleCorner" />
						<!-- kAAIT_GetDistOfFarthestModuleCorner also changes kAAIT_rotDefensibleTargetToTarget based on corner -->
						<set_value name="$kAAIT_dist" exact="$kAAIT_distOfFarthestModuleCorner" />
						<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_SetMoveToEngageYawFromTarget $kAAIT_dist (was 0, get from farthest corner of module): ' + $kAAIT_dist" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					</do_if>
					<set_value name="$kAAIT_yawAdj" exact="$kAAIT_yawAdj * sin((pi)f * $kAAIT_dist / ($kAAIT_distMax)f)" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_SetMoveToEngageYawFromTarget $kAAIT_dist: ' + $kAAIT_dist" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_SetMoveToEngageYawFromTarget $kAAIT_yawAdj: ' + $kAAIT_yawAdj" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<!-- end: adj attack vector based on distance of module target to 0,0,0 -->
					<!--
						kAAIT_angle_from = angle from defensible target to ship
						kAAIT_angle_to = angle from defensible target to module target
						kAAIT_result_moveToEngageYaw = nearest +/- (kAAIT_yawAdj * 0.5) vector of kAAIT_angle_from to kAAIT_angle_to
					-->
					<set_value name="$kAAIT_angle_from" exact="$kAAIT_rotDefensibleTargetToShip.yaw * 180 / pi" />
					<set_value name="$kAAIT_angle_to_0" exact="$kAAIT_rotDefensibleTargetToTarget.yaw * 180 / pi" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_SetMoveToEngageYawFromTarget $kAAIT_angle_from: ' + $kAAIT_angle_from" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_SetMoveToEngageYawFromTarget $kAAIT_angle_to_0: ' + $kAAIT_angle_to_0" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_SetMoveToEngageYawFromTarget $kAAIT_test_moveToEngageTarget_isBigMoveAround: ' + @global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData.$kAAIT_test_moveToEngageTarget_isBigMoveAround" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_SetMoveToEngageYawFromTarget $count_moveToEngage: ' + @global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData.$count_moveToEngage" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<do_if value="(not @global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData.$kAAIT_test_moveToEngageTarget_isBigMoveAround) or (not @global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData.$count_moveToEngage)">
						<!-- vs modular targets, smaller yaw change -->
						<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_SetMoveToEngageYawFromTarget yaw to move to target vector'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
						<set_value name="$kAAIT_angle_to_neg45" exact="$kAAIT_angle_to_0 - $kAAIT_yawAdj * 0.5" />
						<set_value name="$kAAIT_angle_to_pos45" exact="$kAAIT_angle_to_0 + $kAAIT_yawAdj * 0.5" />
					</do_if>
					<do_else>
						<!-- vs non-modular targets, larger yaw change -->
						<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_SetMoveToEngageYawFromTarget yaw to move around target'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
						<set_value name="$kAAIT_angle_to_neg45" exact="$kAAIT_angle_from - 30" />
						<set_value name="$kAAIT_angle_to_pos45" exact="$kAAIT_angle_from + 30" />
					</do_else>
					<set_value name="$kAAIT_angle_to" exact="$kAAIT_angle_to_neg45" />
					<include_interrupt_actions ref="kAAIT_GetAngleDiffAndMid" />
					<set_value name="$kAAIT_angle_diff_left" exact="abs($kAAIT_angle_diff)" />
					<set_value name="$kAAIT_angle_to" exact="$kAAIT_angle_to_pos45" />
					<include_interrupt_actions ref="kAAIT_GetAngleDiffAndMid" />
					<set_value name="$kAAIT_angle_diff_right" exact="abs($kAAIT_angle_diff)" />
					<do_if value="(not @global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData.$kAAIT_test_moveToEngageTarget_isBigMoveAround) or (not @global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData.$count_moveToEngage)">
						<do_if value="$kAAIT_angle_diff_left le $kAAIT_angle_diff_right">
							<set_value name="$kAAIT_angle_to" exact="$kAAIT_angle_to_neg45" />
						</do_if>
						<do_else>
							<set_value name="$kAAIT_angle_to" exact="$kAAIT_angle_to_pos45" />
						</do_else>
					</do_if>
					<do_else>
						<do_if value="$kAAIT_shipIndex % 2 == 0">
							<set_value name="$kAAIT_angle_to" exact="$kAAIT_angle_to_pos45" />
						</do_if>
						<do_else>
							<set_value name="$kAAIT_angle_to" exact="$kAAIT_angle_to_neg45" />
						</do_else>
					</do_else>
					<remove_value name="global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData.$kAAIT_test_moveToEngageTarget_isBigMoveAround" />
					<set_value name="$kAAIT_result_moveToEngageYaw" exact="$kAAIT_angle_to + $kAAIT_yaw_jitter" />
					<set_value name="global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData.$moveToEngage_yawTargetToShip" exact="$kAAIT_result_moveToEngageYaw" />
					<set_value name="$kAAIT_result_moveToEngageYawFrom" exact="$kAAIT_angle_from" />
					<set_value name="$kAAIT_result_moveToEngageYawMid" exact="$kAAIT_angle_mid" />
					<set_value name="$kAAIT_result_moveToEngageYawDiff" exact="$kAAIT_angle_diff" />
				</do_if>
				<do_else>
					<create_orientation name="$kAAIT_rotTargetToShip" orientation="look_at" refposition="$kAAIT_posShip">
						<position value="$kAAIT_posTarget" />
					</create_orientation>
					<set_value name="$kAAIT_result_moveToEngageYaw" exact="$kAAIT_rotTargetToShip.yaw * 180 / pi + $kAAIT_yaw_jitter" />
					<set_value name="global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData.$moveToEngage_yawTargetToShip" exact="$kAAIT_result_moveToEngageYaw" />
					<set_value name="$kAAIT_result_moveToEngageYawFrom" exact="$kAAIT_result_moveToEngageYaw" />
					<set_value name="$kAAIT_result_moveToEngageYawMid" exact="0" />
					<set_value name="$kAAIT_result_moveToEngageYawDiff" exact="0" />
				</do_else>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_SetMoveToEngageYawFromTarget $kAAIT_result_moveToEngageYaw: ' + $kAAIT_result_moveToEngageYaw" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_SetMoveToEngageYawFromTarget $kAAIT_result_moveToEngageYawFrom: ' + $kAAIT_result_moveToEngageYawFrom" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_SetMoveToEngageYawFromTarget $kAAIT_result_moveToEngageYawMid: ' + $kAAIT_result_moveToEngageYawMid" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_SetMoveToEngageYawFromTarget $kAAIT_result_moveToEngageYawDiff: ' + $kAAIT_result_moveToEngageYawDiff" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			</actions>

			<actions name="kAAIT_GetDistOfFarthestModuleCorner">
				<set_value name="$kAAIT_moduleRot" exact="$kAAIT_test_moveToEngageTarget.rotation" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetDistOfFarthestModuleCorner $kAAIT_moduleRot: ' + $kAAIT_moduleRot"  chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<set_value name="$kAAIT_cornerWHDFactors" exact="[
					table[$x = -1, $y = 0, $z = -1],
					table[$x = +1, $y = 0, $z = -1],
					table[$x = +1, $y = 0, $z = +1],
					table[$x = -1, $y = 0, $z = +1],
				]" />
				<set_value name="$kAAIT_w" exact="$kAAIT_test_moveToEngageTarget.width" />
				<set_value name="$kAAIT_h" exact="$kAAIT_test_moveToEngageTarget.height" />
				<set_value name="$kAAIT_l" exact="$kAAIT_test_moveToEngageTarget.length" />
				<set_value name="$kAAIT_distOfFarthestModuleCorner" exact="0" />
				<create_position name="$kAAIT_pos_ship" space="$kAAIT_test_moveToEngageTarget.defensible.zone" object="this.assignedcontrolled" />
				<do_for_each name="$kAAIT_cornerWHDFactor" in="$kAAIT_cornerWHDFactors" counter="$i">
					<create_position name="$kAAIT_pos_module" space="$kAAIT_test_moveToEngageTarget.defensible.zone" object="$kAAIT_test_moveToEngageTarget" />
					<create_position name="$kAAIT_pos_corner"
						x="$kAAIT_w * $kAAIT_cornerWHDFactor.$x"
						y="$kAAIT_h * $kAAIT_cornerWHDFactor.$y"
						z="$kAAIT_l * $kAAIT_cornerWHDFactor.$z"/>
					<transform_position name="$kAAIT_pos_corner" refposition="$kAAIT_pos_module" refrotation="$kAAIT_moduleRot">
						<position value="$kAAIT_pos_corner" />
					</transform_position>
					<!-- <set_value name="$kAAIT_dist" exact="$kAAIT_pos_corner.distanceto.{position.[0, 0, 0]} + $kAAIT_pos_corner.distanceto.{$kAAIT_pos_ship}" /> -->
					<set_value name="$kAAIT_dist" exact="$kAAIT_pos_corner.distanceto.{position.[0, 0, 0]}" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetDistOfFarthestModuleCorner $kAAIT_dist: ' + $kAAIT_dist + ' $kAAIT_distOfFarthestModuleCorner: ' + $kAAIT_distOfFarthestModuleCorner" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<do_if value="$kAAIT_dist ge $kAAIT_distOfFarthestModuleCorner">
						<create_orientation name="$kAAIT_rotDefensibleTargetToTarget" orientation="look_at" refposition="position.[0, 0, 0]">
							<position value="$kAAIT_pos_corner" />
						</create_orientation>
						<set_value name="$kAAIT_distOfFarthestModuleCorner" exact="$kAAIT_dist" />
						<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetDistOfFarthestModuleCorner $kAAIT_distOfFarthestModuleCorner: ' + $kAAIT_distOfFarthestModuleCorner" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					</do_if>
				</do_for_each>
			</actions>

			<actions name="kAAIT_GetIsStepForward">
				<set_value name="$kAAIT_result_isStepForward" exact="false" />
				<do_if value="$kAAIT_test_target_stepForward.isrealclass.station or $kAAIT_test_target_stepForward.defensible.isrealclass.station">
					<set_value name="$time_nextStepForward" exact="1min" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsStepForward $kAAIT_test_target_stepForward.isrealclass.station: ' + $kAAIT_test_target_stepForward.isrealclass.station + ' $kAAIT_test_target_stepForward.defensible.isclass.station: ' + $kAAIT_test_target_stepForward.defensible.isclass.station" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsStepForward $time_nextStepForward: ' + $time_nextStepForward" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsStepForward $time_lastStepForward: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$time_lastStepForward" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsStepForward gt $time_nextStepForward: ' + (player.age - @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$time_lastStepForward gt $time_nextStepForward)" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<set_value name="$kAAIT_distToTarget" exact="this.assignedcontrolled.bboxdistanceto.{$kAAIT_test_target_stepForward}" />
					<do_if value="player.age - @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$time_lastStepForward gt $time_nextStepForward">
						<set_value name="$kAAIT_distToTarget" exact="this.assignedcontrolled.bboxdistanceto.{$kAAIT_test_target_stepForward}" />
						<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsStepForward $kAAIT_distToTarget: ' + $kAAIT_distToTarget" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
						<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsStepForward $combatRange_min: ' + global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_min" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
						<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsStepForward $combatRange_max: ' + global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_max" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
						<do_if value="$kAAIT_distToTarget gt global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_min">
							<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsStepForward type: ' + this.assignedcontrolled.type" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
							<do_if value="
								this.assignedcontrolled.type != shiptype.carrier or
								(
									(
										this.isplayerowned and
										global.$kAAIT_Data.$isCarriersAttackLikeDestroyers
									) or
									(
										(not this.isplayerowned) and
										global.$kAAIT_Data.$isCarriersAttackLikeDestroyers_allFactions
									)
								)
							">
								<set_value name="$kAAIT_result_isStepForward" exact="true" />
							</do_if>
						</do_if>
					</do_if>
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsStepForward $kAAIT_result_isStepForward: ' + $kAAIT_result_isStepForward" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			</actions>

			<actions name="KAAIT_GetEngagePosDistance" comment="engage pos = half target size + max combat range * (skill + withdraw count). used in move.attack.object.capital">
				<set_value name="$kAAIT_skillAndWithdrawCountMult" exact="
					  @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$skill_distance_engagePosition_mult
					+ @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$withdrawCount * 0.5" />
				<do_if value="not $kAAIT_skillAndWithdrawCountMult">
					<set_value name="$kAAIT_skillAndWithdrawCountMult" exact="1" />
				</do_if>
				<!-- <do_if value="$kAAIT_test_moveToEngageTarget.defensible">
					<set_value name="$kAAIT_dist_fromDefensible" exact="this.assignedcontrolled.distanceto.{$kAAIT_test_moveToEngageTarget.defensible}" />
					<set_value name="$kAAIT_dist_bboxDistanceFromDefensible" exact="this.assignedcontrolled.bboxdistanceto.{$kAAIT_test_moveToEngageTarget.defensible}" />
					<debug_text text="@this.assignedcontrolled.idcode + ' KAAIT_GetEngagePosDistance $kAAIT_dist_fromDefensible: ' + $kAAIT_dist_fromDefensible" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<debug_text text="@this.assignedcontrolled.idcode + ' KAAIT_GetEngagePosDistance $kAAIT_dist_bboxDistanceFromDefensible: ' + $kAAIT_dist_bboxDistanceFromDefensible" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<do_if value="$kAAIT_dist_bboxDistanceFromDefensible">
						<set_value name="$kAAIT_dist_edgeFromOrigin" exact="abs($kAAIT_dist_bboxDistanceFromDefensible - $kAAIT_dist_fromDefensible)" />
					</do_if>
					<do_else>
						<set_value name="$kAAIT_dist_edgeFromOrigin" exact="$kAAIT_dist_fromDefensible" />
					</do_else>
					<debug_text text="@this.assignedcontrolled.idcode + ' KAAIT_GetEngagePosDistance $kAAIT_dist_edgeFromOrigin (likely module target): ' + $kAAIT_dist_edgeFromOrigin" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				</do_if>
				<do_else> -->
					<set_value name="$kAAIT_dist_fromDefensible" exact="this.assignedcontrolled.distanceto.{$kAAIT_test_moveToEngageTarget}" />
					<set_value name="$kAAIT_dist_bboxDistanceFromDefensible" exact="this.assignedcontrolled.bboxdistanceto.{$kAAIT_test_moveToEngageTarget}" />
					<do_if value="$kAAIT_dist_bboxDistanceFromDefensible">
						<set_value name="$kAAIT_dist_edgeFromOrigin" exact="abs($kAAIT_dist_fromDefensible - $kAAIT_dist_bboxDistanceFromDefensible)" />
						<debug_text text="@this.assignedcontrolled.idcode + ' KAAIT_GetEngagePosDistance $kAAIT_dist_edgeFromOrigin (distanceto - bboxdistanceto): ' + $kAAIT_dist_edgeFromOrigin" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					</do_if>
					<do_else>
						<set_value name="$kAAIT_dist_edgeFromOrigin" exact="$kAAIT_dist_fromDefensible" />
						<debug_text text="@this.assignedcontrolled.idcode + ' KAAIT_GetEngagePosDistance $kAAIT_dist_edgeFromOrigin (distanceto): ' + $kAAIT_dist_edgeFromOrigin" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					</do_else>
				<!-- </do_else> -->
				<debug_text text="@this.assignedcontrolled.idcode + ' KAAIT_GetEngagePosDistance $kAAIT_skillAndWithdrawCountMult: ' + $kAAIT_skillAndWithdrawCountMult" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<do_if value="
					this.assignedcontrolled.primarypurpose != purpose.fight or
					(not @this.assignedcontrolled.iscapitalship) or
					(
						this.assignedcontrolled.type == shiptype.carrier and
						(
							(
								this.isplayerowned and
								(not global.$kAAIT_Data.$isCarriersAttackLikeDestroyers)
							) or
							(
								(not this.isplayerowned) and
								(not global.$kAAIT_Data.$isCarriersAttackLikeDestroyers_allFactions)
							)
						)
					)
				">
					<!--
					=========================================
					prevent carriers from getting into danger
					========================================= -->
					<debug_text text="@this.assignedcontrolled.idcode + ' KAAIT_GetEngagePosDistance this.assignedcontrolled.maxradarrange * 0.75: ' + (this.assignedcontrolled.maxradarrange * 0.75)" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<set_value name="$kAAIT_result_engagePosDist" exact="$kAAIT_dist_edgeFromOrigin + this.assignedcontrolled.maxradarrange * 0.75 * $kAAIT_skillAndWithdrawCountMult" />
					<do_if value="$kAAIT_result_engagePosDist gt this.assignedcontrolled.maxradarrange * 0.5">
						<set_value name="$kAAIT_result_engagePosDist" exact="this.assignedcontrolled.maxradarrange * 0.5" />
					</do_if>
				</do_if>
				<do_else>
					<debug_text text="@this.assignedcontrolled.idcode + ' KAAIT_GetEngagePosDistance $attackData.$combatRange_max * 0.9: ' + (@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_max * 0.9)" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<set_value name="$kAAIT_result_engagePosDist" exact="$kAAIT_dist_edgeFromOrigin + global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_max * 0.9 * $kAAIT_skillAndWithdrawCountMult" />
				</do_else>
				<debug_text text="@this.assignedcontrolled.idcode + ' KAAIT_GetEngagePosDistance $kAAIT_result_engagePosDist: ' + $kAAIT_result_engagePosDist" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			</actions>

			<actions name="kAAIT_GetBestAttackRotation">
				<do_if value="not $kAAIT_currentAttackRotation">
					<create_rotation name="$kAAIT_currentAttackRotation" yaw="0deg" pitch="0deg" roll="0deg" />
				</do_if>
				<set_value name="$kAAIT_bestAttackRotateYawsByQuadrant" exact="table[
					{quadrant.front} = 0deg,
					{quadrant.left} = 90deg,
					{quadrant.right} = -90deg,
				]" />
				<set_value name="$kAAIT_attackRotateYaw" exact="$kAAIT_currentAttackRotation.yaw + $kAAIT_bestAttackRotateYawsByQuadrant.{global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$bestHQuadrant}" />
				<set_value name="$kAAIT_attackRotateRollAdj" exact="0deg" />
				<do_if value="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$bestHQuadrant == quadrant.left">
					<set_value name="$kAAIT_attackRotateRoll" exact="$kAAIT_currentAttackRotation.pitch" />
				</do_if>
				<do_else>
					<set_value name="$kAAIT_attackRotateRoll" exact="$kAAIT_currentAttackRotation.pitch + 180deg" />
				</do_else>
				<create_rotation name="$kAAIT_result_bestAttackRotation" yaw="$kAAIT_attackRotateYaw" pitch="0deg" roll="$kAAIT_attackRotateRoll" />
				<remove_value name="$kAAIT_currentAttackRotation" />
			</actions>

			<actions name="kAAIT_GetIsRepairQueued">
				<!-- input: $kAAIT_test_target_isRepairQueued -->
				<!-- valid repair queues are:
					1. order.repair
					2. order.dock, order.repair
					3. order.dock, order.dock.wait, order.repair
					3. order.dock.wait, order.repair
				-->
				<set_value name="$kAAIT_orderScripts" exact="[]" />
				<do_for_each name="$order_inList" in="$kAAIT_test_target_isRepairQueued.orders">
					<append_to_list name="$kAAIT_orderScripts" exact="$order_inList.script" />
				</do_for_each>
				<set_value name="$kAAIT_result_isRepairQueued" exact="
					@$kAAIT_orderScripts.{1} == 'order.repair' or
					@$kAAIT_orderScripts.{2} == 'order.repair' or
					(
						@$kAAIT_orderScripts.{1} == 'order.dock' and
						@$kAAIT_orderScripts.{2} == 'order.dock.wait' and
						@$kAAIT_orderScripts.{3} == 'order.repair'
					)
				" />
				<debug_text text="@$kAAIT_test_target_isRepairQueued.idcode + ' kAAIT_GetIsRepairQueued $kAAIT_result_isRepairQueued: ' + $kAAIT_result_isRepairQueued" chance="if @$kAAIT_test_target_isRepairQueued.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0" />
			</actions>

			<actions name="kAAIT_GetIsUndockQueued">
				<!-- valid undock queues are:
					1. move.undock
					2. order.dock, move.undock
					3. order.dock, order.dock.wait, move.undock
					3. order.dock.wait, move.undock
				-->
				<set_value name="$kAAIT_orderScripts" exact="[]" />
				<do_for_each name="$order_inList" in="this.assignedcontrolled.orders">
					<append_to_list name="$kAAIT_orderScripts" exact="$order_inList.script" />
				</do_for_each>
				<set_value name="$kAAIT_result_isUndockQueued" exact="
					@$kAAIT_orderScripts.{1} == 'move.undock' or
					@$kAAIT_orderScripts.{2} == 'move.undock' or
					(
						@$kAAIT_orderScripts.{1} == 'order.dock' and
						@$kAAIT_orderScripts.{2} == 'order.dock.wait' and
						@$kAAIT_orderScripts.{3} == 'move.undock'
					)
				" />
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsUndockQueued $kAAIT_result_isUndockQueued: ' + $kAAIT_result_isUndockQueued" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			</actions>
			<!--
				 dP"Yb  88""Yb 8888b.  888888 88""Yb .dP"Y8
				dP   Yb 88__dP  8I  Yb 88__   88__dP `Ybo."
				Yb   dP 88"Yb   8I  dY 88""   88"Yb  o.`Y8b
				 YbodP  88  Yb 8888Y"  888888 88  Yb 8bodP'
			 -->
			<actions name="kAAIT_CleanOrders">
				<do_if value="(not this.isplayerowned) and (not @$kAAITParam_isAvoidHighRisk) and (not @$kAAITParam_isStepForwardWithdraw) and (not @$kAAITParam_iskAAITOrder)">
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_CleanOrders order (current): ' + @this.assignedcontrolled.order.script" />
					<debug_text text="@this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ====='" />
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_CleanOrders order (current): ' + @this.assignedcontrolled.order.script" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<do_for_each name="$kAAIT_order" in="this.assignedcontrolled.orders" counter="$i" reverse="true">
					<do_if value="@$kAAIT_order.$kAAITParam_iskAAITOrder" comment="cancel other move.kuertee.*.xml order">
						<debug_text text="@this.assignedcontrolled.idcode + ' cancel_order ' + $kAAIT_order.script" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
						<cancel_order order="$kAAIT_order" />
					</do_if>
				</do_for_each>
				<set_value name="$kAAIT_order" exact="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$attackOrder" />
				<do_if value="$kAAIT_order.exists">
					<cancel_order order="$kAAIT_order" />
				</do_if>
				<set_value name="$kAAIT_order" exact="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$attackOrder_smallTarget" />
				<do_if value="$kAAIT_order.exists">
					<cancel_order order="$kAAIT_order" />
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_CleanOrders order (post clean): ' + @this.assignedcontrolled.order.script" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			</actions>

			<actions name="kAAIT_Order_AttackOther">
				<do_if value="(not this.isplayerowned) and (not @$kAAITParam_isAvoidHighRisk) and (not @$kAAITParam_isStepForwardWithdraw) and (not @$kAAITParam_iskAAITOrder)">
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Order_AttackOther order: ' + @this.assignedcontrolled.order.script" />
					<debug_text text="@this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ====='" />
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Order_AttackOther'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' ======================='" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_target_attack: ' + @$kAAIT_target_attack.knownname + ' ' + @$kAAIT_target_attack.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<do_if value="not global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData?">
					<include_interrupt_actions ref="kAAIT_Init" />
				</do_if>
				<include_interrupt_actions ref="kAAIT_CleanOrders" />
				<do_if value="this.assignedcontrolled.order">
					<set_order_syncpoint_reached order="this.assignedcontrolled.order" />
					<unassign_order_syncpoint_from_order order="this.assignedcontrolled.order" />
					<do_if value="this.assignedcontrolled.commander.isoperational">
						<signal_objects object="this.assignedcontrolled.commander" param="'kAAIT_tactical_remove_subordinate'" param2="this.assignedcontrolled" />
					</do_if>
				</do_if>
				<do_if value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$attackOrder.exists">
					<cancel_order order="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$attackOrder" />
				</do_if>
				<do_if value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$attackOrder_smallTarget.exists">
					<cancel_order order="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$attackOrder_smallTarget" />
				</do_if>
				<do_if value="@$kAAIT_is_attack_order_tactical">
					<create_order name="$kAAIT_result_order_attackOther" object="this.assignedcontrolled" id="'TacticalOrder'" immediate="true">
						<param name="selectedtarget" value="$kAAIT_target_attack" />
						<param name="kAAITParam_isAvoidHighRisk" value="@$kAAITParam_isAvoidHighRisk" />
						<param name="kAAITParam_isStepForwardWithdraw" value="@$kAAITParam_isStepForwardWithdraw" />
						<param name="debugchance" value="@$debugchance"/>
					</create_order>
				</do_if>
				<do_else>
					<create_order name="$kAAIT_result_order_attackOther" object="this.assignedcontrolled" id="'Attack'" immediate="true">
						<param name="primarytarget" value="$kAAIT_target_attack" />
						<param name="secondarytargets" value="@$secondarytargets" />
						<param name="pursuedistance" value="this.assignedcontrolled.maxradarrange" />
						<param name="pursuetargets" value="false" />
						<param name="kAAITParam_isAvoidHighRisk" value="@$kAAITParam_isAvoidHighRisk" />
						<param name="kAAITParam_isStepForwardWithdraw" value="@$kAAITParam_isStepForwardWithdraw" />
						<param name="debugchance" value="@$debugchance"/>
					</create_order>
				</do_else>
				<do_if value="@$kAAIT_result_order_attackOther.exists">
					<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$attackOrder" exact="$kAAIT_result_order_attackOther" />
					<do_if value="not @$kAAIT_target_attack.iscapitalship">
						<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$attackOrder_smallTarget" exact="$kAAIT_result_order_attackOther" />
					</do_if>
				</do_if>
			</actions>

			<actions name="kAAIT_Order_Avoid">
				<do_if value="(not this.isplayerowned) and (not @$kAAITParam_isAvoidHighRisk) and (not @$kAAITParam_isStepForwardWithdraw) and (not @$kAAITParam_iskAAITOrder)">
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Order_Avoid order: ' + @this.assignedcontrolled.order.script" />
					<debug_text text="@this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ====='" />
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Order_Avoid'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' ================='" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $target_avoid: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid.knownname + ' ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<do_if value="not global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData?">
					<include_interrupt_actions ref="kAAIT_Init" />
				</do_if>
				<include_interrupt_actions ref="kAAIT_CleanOrders" />
				<do_if value="this.assignedcontrolled.order">
					<set_order_syncpoint_reached order="this.assignedcontrolled.order" />
					<unassign_order_syncpoint_from_order order="this.assignedcontrolled.order" />
					<do_if value="this.assignedcontrolled.commander.isoperational">
						<signal_objects object="this.assignedcontrolled.commander" param="'kAAIT_tactical_remove_subordinate'" param2="this.assignedcontrolled" />
					</do_if>
				</do_if>
				<set_value name="$kAAIT_isImmediate" exact="true" />
				<do_if value="@this.assignedcontrolled.order.script == 'order.fight.tactical'">
					<set_value name="$kAAIT_isImmediate" exact="false" />
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' create_order kAAIT_MoveAvoid'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<create_order object="this.assignedcontrolled" id="'kAAIT_MoveAvoid'" immediate="$kAAIT_isImmediate">
					<param name="target" value="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid" />
				</create_order>
				<do_if value="not $kAAIT_isImmediate" comment="if TacticalOrder, cancel it. then re-add it.">
					<set_value name="$kAAIT_target_attack" exact="this.assignedcontrolled.order.$selectedtarget" />
					<set_value name="$kAAIT_aggressiveness" exact="this.assignedcontrolled.order.$aggressiveness" />
					<set_value name="$kAAIT_weakfirst" exact="this.assignedcontrolled.order.$weakfirst" />
					<set_value name="$kAAIT_xdistance" exact="this.assignedcontrolled.order.$xdistance" />
					<set_value name="$kAAIT_zdistance" exact="this.assignedcontrolled.order.$zdistance" />
					<set_value name="$kAAIT_timeout" exact="this.assignedcontrolled.order.$timeout" />
					<cancel_order order="this.assignedcontrolled.order" />
					<create_order object="this.assignedcontrolled" id="'TacticalOrder'">
						<param name="selectedtarget" value="$kAAIT_target_attack" />
						<param name="aggressiveness" value="$kAAIT_aggressiveness" />
						<param name="weakfirst" value="$kAAIT_weakfirst" />
						<param name="xdistance" value="$kAAIT_xdistance" />
						<param name="zdistance" value="$kAAIT_zdistance" />
						<param name="timeout" value="$kAAIT_timeout" />
					</create_order>
				</do_if>
			</actions>

			<actions name="kAAIT_Order_Flee">
				<do_if value="(not this.isplayerowned) and (not @$kAAITParam_isAvoidHighRisk) and (not @$kAAITParam_isStepForwardWithdraw) and (not @$kAAITParam_iskAAITOrder)">
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Order_Flee order: ' + @this.assignedcontrolled.order.script" />
					<debug_text text="@this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ====='" />
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Order_Flee'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' ================'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $target_avoid: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid.knownname + ' ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<do_if value="not global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData?">
					<include_interrupt_actions ref="kAAIT_Init" />
				</do_if>
				<include_interrupt_actions ref="kAAIT_CleanOrders" />
				<do_if value="this.assignedcontrolled.order">
					<set_order_syncpoint_reached order="this.assignedcontrolled.order" />
					<unassign_order_syncpoint_from_order order="this.assignedcontrolled.order" />
					<do_if value="this.assignedcontrolled.commander.isoperational">
						<signal_objects object="this.assignedcontrolled.commander" param="'kAAIT_tactical_remove_subordinate'" param2="this.assignedcontrolled" />
					</do_if>
				</do_if>
				<create_order object="this.assignedcontrolled" id="'Flee'" immediate="true">
					<param name="method" value="'boost'"/>
					<param name="attacker" value="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid"/>
					<param name="donotdrop" value="true"/>
					<param name="deploydistraction" value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget.isclass.ship"/>
					<param name="log" value="false"/>
					<param name="kAAITParam_iskAAITOrder" value="true"/>
					<param name="debugchance" value="@$debugchance"/>
				</create_order>
			</actions>

			<actions name="kAAIT_Order_MoveToEngagePosition">
				<do_if value="(not this.isplayerowned) and (not @$kAAITParam_isAvoidHighRisk) and (not @$kAAITParam_isStepForwardWithdraw) and (not @$kAAITParam_iskAAITOrder)">
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Order_MoveToEngagePosition order: ' + @this.assignedcontrolled.order.script" />
					<debug_text text="@this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ==========='" />
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Order_MoveToEngagePosition'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' ================================'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $target_avoid: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid.knownname + ' ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<do_if value="not global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData?">
					<include_interrupt_actions ref="kAAIT_Init" />
				</do_if>
				<include_interrupt_actions ref="kAAIT_CleanOrders" />
				<do_if value="this.assignedcontrolled.order">
					<set_order_syncpoint_reached order="this.assignedcontrolled.order" />
					<unassign_order_syncpoint_from_order order="this.assignedcontrolled.order" />
					<do_if value="this.assignedcontrolled.commander.isoperational">
						<signal_objects object="this.assignedcontrolled.commander" param="'kAAIT_tactical_remove_subordinate'" param2="this.assignedcontrolled" />
					</do_if>
				</do_if>
				<create_order object="this.assignedcontrolled" id="'kAAIT_MoveEngagePosition'" immediate="true">
					<param name="target" value="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid"/>
					<param name="kAAITParam_isBigMoveAround" value="@$kAAIT_test_moveToEngageTarget_isBigMoveAround" />
				</create_order>
			</actions>

			<actions name="kAAIT_Order_Withdraw">
				<do_if value="(not this.isplayerowned) and (not @$kAAITParam_isAvoidHighRisk) and (not @$kAAITParam_isStepForwardWithdraw) and (not @$kAAITParam_iskAAITOrder)">
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Order_Withdraw order: ' + @this.assignedcontrolled.order.script" />
					<debug_text text="@this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ====='" />
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Order_Withdraw'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' ===================='" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $target_avoid: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid.knownname + ' ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<do_if value="not global.$kAAITByShipId.{'$' + this.assignedcontrolled.idcode}.$attackData?">
					<include_interrupt_actions ref="kAAIT_Init" />
				</do_if>
				<include_interrupt_actions ref="kAAIT_CleanOrders" />
				<do_if value="this.assignedcontrolled.order">
					<set_order_syncpoint_reached order="this.assignedcontrolled.order" />
					<unassign_order_syncpoint_from_order order="this.assignedcontrolled.order" />
					<do_if value="this.assignedcontrolled.commander.isoperational">
						<signal_objects object="this.assignedcontrolled.commander" param="'kAAIT_tactical_remove_subordinate'" param2="this.assignedcontrolled" />
					</do_if>
				</do_if>
				<create_order object="this.assignedcontrolled" id="'kAAIT_MoveWithdraw'" immediate="true">
					<param name="target" value="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid"/>
				</create_order>
			</actions>

			<actions name="kAAIT_RequestHelp">
				<do_if value="(not this.isplayerowned) and (not @$kAAITParam_isAvoidHighRisk) and (not @$kAAITParam_isStepForwardWithdraw) and (not @$kAAITParam_iskAAITOrder)">
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_RequestHelp order: ' + @this.assignedcontrolled.order.script" />
					<debug_text text="@this.assignedcontrolled.idcode + ' ===== NOT KAAIT SHIP ====='" />
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_RequestHelp'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' ================='" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<do_if value="@this.assignedcontrolled.subordinates.count">
					<signal_objects object="this.assignedcontrolled" param="'kAAIT_help'" param2="this.assignedcontrolled" />
				</do_if>
				<do_if value="@this.assignedcontrolled.commander.isoperational">
					<signal_objects object="this.assignedcontrolled.commander" param="'kAAIT_help'" param2="this.assignedcontrolled" />
				</do_if>
			</actions>

			<!--
				 dP"Yb  88""Yb 8888b.  888888 88""Yb          .dP"Y8 88""Yb 888888  dP""b8 88 888888 88  dP""b8
				dP   Yb 88__dP  8I  Yb 88__   88__dP ________ `Ybo." 88__dP 88__   dP   `" 88 88__   88 dP   `"
				Yb   dP 88"Yb   8I  dY 88""   88"Yb  """""""" o.`Y8b 88"""  88""   Yb      88 88""   88 Yb
				 YbodP  88  Yb 8888Y"  888888 88  Yb          8bodP' 88     888888  YboodP 88 88     88  YboodP
			 -->
			<actions name="kAAIT_InitAttackScript" comment="only works in the fight.attack.object.* and move.attack.object.capital scripts">
				<set_value name="$kAAIT_version" exact="global.$kAAIT.version" />
				<do_if value="not $kAAIT_original_name?">
					<set_value name="$kAAIT_original_name" exact="this.assignedcontrolled.knownname" />
				</do_if>
				<do_if value="@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw">
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_InitAttackScript'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<debug_text text="@this.assignedcontrolled.idcode + ' ======================'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<include_interrupt_actions ref="kAAIT_Init" />
				</do_if>
			</actions>

			<actions name="kAAIT_DeinitAttackScript" comment="only works in the fight.attack.object.* and move.attack.object.capital scripts">
				<do_if value="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_space?">
					<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_space" />
					<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_pos" />
				</do_if>
				<do_if value="@this.assignedcontrolled.isoperational">
					<do_if value="$kAAIT_original_name? and @$kAAIT_original_name and (this.assignedcontrolled.knownname != @$kAAIT_original_name) and (not @this.assignedcontrolled.coverowner)">
						<!-- Check exists, check not null, check if knownname != original. Removed chance from debug message so any ships that unintentionally got a name change can be tracked -->
						<debug_text text="'MOD: KUDA -- %s(%s) -- set_object_name reset to %s.'.[@this.assignedcontrolled.knownname,@this.assignedcontrolled.idcode,$kAAIT_original_name]" />
						<set_object_name object="this.assignedcontrolled" name="$kAAIT_original_name" />
					</do_if>
				</do_if>
			</actions>
		</library>
	</interrupts>
</aiscript>
