<?xml version="1.0" encoding="utf-8"?>
<aiscript name="kuertee_aait_interrupts" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="aiscripts.xsd">
	<interrupts>
		<library>
			<actions name="kAAIT_Init">
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Init'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<do_if value="@this.$beacon_from or @this.$kAAIT_target or @this.$kAAIT_orders">
					<include_interrupt_actions ref="kAAIT_CleanUpOldVersionData" />
				</do_if>
				<do_if value="not this.$kAAIT_data?">
					<debug_text text="this.assignedcontrolled.idcode + ' NEW ATTACK ORDER'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<set_value name="this.$kAAIT_data" exact="table[]" />
				</do_if>
				<do_else>
					<debug_text text="this.assignedcontrolled.idcode + ' CONTINUED ATTACK ORDER'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				</do_else>
				<include_interrupt_actions ref="kAAIT_GetCombatRange" />
				<include_interrupt_actions ref="kAAIT_GetSkillVars" />
				<do_if value="
					this.assignedcontrolled.order.id == 'Attack' or
					(not @this.$kAAIT_data.$defensibleTarget)
				">
					<set_value name="$kAAIT_test_target_isHighRisk" exact="@$primarytarget" />
					<do_if value="not @$kAAIT_test_target_isHighRisk.exists">
						<set_value name="$kAAIT_test_target_isHighRisk" exact="@$target" />
					</do_if>
					<include_interrupt_actions ref="kAAIT_GetIsTargetHighRisk" />
					<set_value name="this.$kAAIT_data.$defensibleTarget" exact="$kAAIT_test_target_isHighRisk" />
					<set_value name="this.$kAAIT_data.$defensibleTargetEntity" exact="@$kAAIT_target_highRiskEntity" />
					<set_value name="this.$kAAIT_data.$isTargetPotentialHighRisk" exact="@$kAAIT_isTargetPotentialHighRisk" />
					<set_value name="this.$kAAIT_data.$isTargetHighRisk" exact="@$kAAIT_result_isTargetHighRisk" />
					<remove_value name="$kAAIT_test_target_isHighRisk" />
				</do_if>
				<debug_text text="this.assignedcontrolled.idcode + ' this.$kAAIT_data: ' + this.$kAAIT_data" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			</actions>

			<actions name="kAAIT_Deinit">
				<set_value name="$isDeInit" exact="true" />
				<do_if value="
					@this.assignedcontrolled.order.$kAAITParam_iskAAITOrder and
					(
						@this.assignedcontrolled.nextorder.id == 'MoveGeneric' or
						@this.assignedcontrolled.nextorder.id == 'MoveWait'
					)">
					<set_value name="$isDeInit" exact="false" />
				</do_if>
				<do_if value="$isDeInit">
					<do_if value="@this.assignedcontrolled.orders.count">
						<do_for_each name="$kAAIT_order" in="this.assignedcontrolled.orders">
							<do_if value="
								$kAAIT_order.id == 'Attack' or
								(
									(
										$kAAIT_order.id == 'Escort' or
										$kAAIT_order.id == 'ProtectShip'
									) and
									(
										@$target.assignedaipilot.$kAAIT_data.$defensibleTarget.isoperational or
										@$target.order.$primarytarget.isoperational or
										@$target.nextorder.$primarytarget.isoperational or
										@$target.order.$selectedtarget.isoperational
									)
								)">
								<set_value name="$isDeInit" exact="false" />
								<break />
							</do_if>
						</do_for_each>
					</do_if>
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_Deinit $isDeInit: ' + $isDeInit + ' order.id: ' + @this.assignedcontrolled.order.id + ' order.$kAAITParam_iskAAITOrder: ' + @this.assignedcontrolled.order.$kAAITParam_iskAAITOrder" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<do_if value="$isDeInit">
					<include_interrupt_actions ref="kAAIT_RemoveAttackerFromTarget" />
					<remove_value name="this.$kAAIT_data" />
					<debug_text text="@this.assignedcontrolled.idcode + ' this.$kAAIT_data: ' + @this.$kAAIT_data" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				</do_if>
			</actions>

			<actions name="kAAIT_CleanUpOldVersionData">
				<!-- start: clean-up obsolete data from previous version -->
				<!-- current version: most of these vars in this.$kAAIT_data -->
				<do_if value="@this.$beacon_from.exists"><destroy_object object="this.$beacon_from" /></do_if>
				<do_if value="@this.$beacon_to.exists"><destroy_object object="this.$beacon_to" /></do_if>
				<do_if value="@this.$beacon_avoid1.exists"><destroy_object object="this.$beacon_avoid1" /></do_if>
				<do_if value="@this.$beacon_avoid2.exists"><destroy_object object="this.$beacon_avoid2" /></do_if>
				<remove_value name="this.$beacon_from" />
				<remove_value name="this.$beacon_to" />
				<remove_value name="this.$beacon_avoid1" />
				<remove_value name="this.$beacon_avoid2" />
				<remove_value name="this.$kAAIT_data.$defensibleTarget_stopKamikaze" />
				<remove_value name="this.$kAAIT_target" />
				<remove_value name="this.$kAAIT_orders" />
				<remove_value name="this.$kAAIT_aroundDir" />
				<remove_value name="this.$kAAIT_lastAttack_enemy" />
				<remove_value name="this.$kAAIT_lastAttack_time" />
				<remove_value name="this.$kAAIT_lastAttack_timeLastSafe" />
				<remove_value name="this.$kAAIT_inchForwardCount" />
				<remove_value name="this.$kAAIT_movedOutOfRangeCount" />
				<remove_value name="this.$kAAIT_orderLocation_space" />
				<remove_value name="this.$kAAIT_orderLocation_pos" />
				<!-- end: clean-up obsolete data from previous version -->
			</actions>

			<actions name="kAAIT_AddAttackerToTarget">
				<do_if value="@this.$kAAIT_data.$defensibleTargetEntity.isoperational">
					<do_if value="not this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers?">
						<create_group groupname="this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers" />
					</do_if>
					<do_if value="not this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl?">
						<create_group groupname="this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl" />
					</do_if>
					<do_if value="player.age - @this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_timeAdded gt 60min">
						<clear_group group="this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers" />
						<clear_group group="this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl" />
					</do_if>
					<do_if value="this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl]">
						<add_to_group groupname="this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl" object="this.assignedcontrolled" />
					</do_if>
					<do_else>
						<add_to_group groupname="this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers" object="this.assignedcontrolled" />
					</do_else>
					<set_value name="this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_timeAdded" exact="player.age" />
					<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_attackers (add to ' + @this.$kAAIT_data.$defensibleTarget + ' ' + @this.$kAAIT_data.$defensibleTarget.knownname + '): ' + @this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers.count" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				</do_if>
			</actions>

			<actions name="kAAIT_RemoveAttackerFromTarget">
				<do_if value="@this.$kAAIT_data.$defensibleTargetEntity.isoperational">
					<do_if value="this.assignedcontrolled">
						<do_if value="not this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers?">
							<create_group groupname="this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers" />
						</do_if>
						<do_if value="not this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl?">
							<create_group groupname="this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl" />
						</do_if>
						<remove_from_group group="this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers" object="this.assignedcontrolled" />
						<remove_from_group group="this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl" object="this.assignedcontrolled" />
					</do_if>
					<do_if value="not @this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers.count">
						<remove_value name="this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers" />
					</do_if>
					<do_if value="not @this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl.count">
						<remove_value name="this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers_lxl" />
					</do_if>
					<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_attackers (remove from ' + @this.$kAAIT_data.$defensibleTarget + ' ' + @this.$kAAIT_data.$defensibleTarget.knownname + '): ' + @this.$kAAIT_data.$defensibleTargetEntity.$kAAIT_attackers.count" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				</do_if>
			</actions>

			<!--
				88  88    db    88b 88 8888b.  88     888888 88""Yb .dP"Y8
				88  88   dPYb   88Yb88  8I  Yb 88     88__   88__dP `Ybo."
				888888  dP__Yb  88 Y88  8I  dY 88  .o 88""   88"Yb  o.`Y8b
				88  88 dP""""Yb 88  Y8 8888Y"  88ood8 888888 88  Yb 8bodP'
			 -->
			<!--
			purpose: determine to withdraw from object on <event_object_attacked />
			to use:
			1. add kAAITParam_isAvoidHighRisk to <params>. see order.fight.attack.object order for its default.
			2. add <handler ref="kAAIT_Handler_WithdrawOrJustFight" /> to <interrupts>
			3. add 4, 5, and 6 to the <actions> of a <event_object_attacked /> that is not in a handler that allows detection of all attacks on this.assignedcontrolled.
				e.g. a <move_to> with a <event_object_attacked /> that allows detection of all attack.
			4. set $kAAIT_test_target_isWithdraw to the object to test.
			5. <include_interrupt_actions ref="kAAIT_Actions_WithdrawOrNot" />.
			6. <remove_value name="$kAAIT_test_target_isWithdraw" />.
			7. if withdrawing, kAAIT_MoveWithdraw order is created and this.$kAAIT_data.isWithdrawing is set to true.
			8. otherwise, no action. individual implementation determines resumption of the AI with <abort_called_scripts /> - generally from "start".
			-->
			<handler name="kAAIT_Handler_WithdrawOrJustFight">
				<conditions>
					<check_any>
						<event_object_attacked object="this.assignedcontrolled" />
						<event_object_attacked_object object="this.assignedcontrolled" />
					</check_any>
					<check_value value="event.param.isclass.[class.ship, class.station]" />
					<check_value value="not this.assignedcontrolled.isunit" />
					<check_value value="not this.assignedcontrolled.islasertower" />
					<check_value value="not @this.$kAAIT_data.$isWithdrawing" />
					<check_value value="not @this.$kAAIT_data.$isIgnoreKAAIT" />
					<check_all>
						<check_any comment="is avoid high-risk. ensure that these parameters are set-up in the orders that use this handler.">
							<check_value value="@$kAAITParam_iskAAITOrder" />
							<check_value value="@$kAAITParam_isAvoidHighRisk" />
							<check_value value="@$kAAITParam_isStepForwardWithdraw" />
						</check_any>
						<check_any comment="is event.param high-risk. when changed, also change others with the 'is event.param high-risk' comment.">
							<check_all comment="this ship is xssm">
								<check_value value="this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m]" />
								<check_all comment="potential high-risk">
									<check_any>
										<check_all>
											<check_value value="@event.param.defensible" />
											<check_value value="event.param.defensible.size gt this.assignedcontrolled.size * 1.5" />
											<check_value value="event.param.defensible.primarypurpose == purpose.fight" />
											<check_value value="@event.param.defensible.type != shiptype.carrier" />
										</check_all>
										<check_all>
											<check_value value="event.param.size gt this.assignedcontrolled.size * 1.5" />
											<check_value value="event.param.primarypurpose == purpose.fight" />
											<check_value value="@event.param.type != shiptype.carrier" />
										</check_all>
									</check_any>
								</check_all>
								<check_any>
									<check_all comment="target is ship">
										<check_value value="event.param.isclass.ship" />
										<check_any>
											<check_all comment="this ship is xss">
												<check_value value="this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s]" />
												<check_value value="
													[@event.param.assignedaipilot.$kAAIT_attackers.count, @event.param.defencenpc.$kAAIT_attackers.count, 1].max * (2 - (this.skill.piloting + this.skill.morale) / 30.0 * 1) le
													@event.param.weapons.operational.count * global.$kAAIT_Config.$xss_outnumberVShips / 100.0
												" />
											</check_all>
											<check_all comment="this ship is m">
												<check_value value="this.assignedcontrolled.isclass.ship_m" />
												<check_value value="
													[@event.param.assignedaipilot.$kAAIT_attackers.count, @event.param.defencenpc.$kAAIT_attackers.count, 1].max * (2 - (this.skill.piloting + this.skill.morale) / 30.0 * 1) le
													@event.param.weapons.operational.count * global.$kAAIT_Config.$m_outnumberVShips / 100.0
												" />
											</check_all>
										</check_any>
									</check_all>
									<check_all comment="target is station">
										<check_value value="event.param.isclass.station" />
										<check_any>
											<check_all comment="this ship is xss">
												<check_value value="this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s]" />
												<check_value value="
													[@event.param.assignedaipilot.$kAAIT_attackers.count, @event.param.defencenpc.$kAAIT_attackers.count, 1].max * (2 - (this.skill.piloting + this.skill.morale) / 30.0 * 1) le
													@event.param.weapons.operational.count * global.$kAAIT_Config.$xss_outnumberVStations / 100.0
												" />
											</check_all>
											<check_all comment="this ship is m">
												<check_value value="this.assignedcontrolled.isclass.ship_m" />
												<check_value value="
													[@event.param.assignedaipilot.$kAAIT_attackers.count, @event.param.defencenpc.$kAAIT_attackers.count, 1].max * (2 - (this.skill.piloting + this.skill.morale) / 30.0 * 1) le
													@event.param.weapons.operational.count * global.$kAAIT_Config.$m_outnumberVStations / 100.0
												" />
											</check_all>
										</check_any>
									</check_all>
								</check_any>
								<check_any comment="not a bomber">
									<check_value value="not this.assignedcontrolled.dps.missiles.all" />
									<check_value value="not this.assignedcontrolled.ammostorage.missile.count" />
								</check_any>
								<set_value name="$kAAIT_isHighRiskEvent" exact="true" />
							</check_all>
							<check_all comment="this ship is lxl">
								<check_value value="this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl]" />
								<check_any>
									<check_value value="event.param.isclass.station" />
									<check_any>
										<check_all>
											<check_value value="@event.param.defensible" />
											<check_value value="event.param.defensible.size gt this.assignedcontrolled.size * 1.5" />
											<check_value value="event.param.defensible.primarypurpose == purpose.fight" />
											<check_value value="@event.param.defensible.type != shiptype.carrier" />
										</check_all>
										<check_all>
											<check_value value="event.param.size gt this.assignedcontrolled.size * 1.5" />
											<check_value value="event.param.primarypurpose == purpose.fight" />
											<check_value value="@event.param.type != shiptype.carrier" />
										</check_all>
									</check_any>
									<check_all>
										<check_value value="event.param.isclass.[class.ship_l, class.ship_xl]" />
										<check_value value="event.param.dps.all gt this.assignedcontrolled.dps.all * 1.25" />
									</check_all>
								</check_any>
								<set_value name="$kAAIT_isHighRiskEvent" exact="true" />
							</check_all>
						</check_any>
						<check_all comment="withdraw now?">
							<check_any>
								<check_value value="not this.assignedcontrolled.weapons.all.count" />
								<check_value value="this.assignedcontrolled.weapons.operational.count / (this.assignedcontrolled.weapons.all.count)f le 0.25" comment="withdraw if 25% operational weapons" />
								<check_value value="this.assignedcontrolled.shieldpercentage le (75 + (this.skill.piloting + this.skill.morale) / 30.0 * 15)" comment="withdraw if less than withdraw threshold" />
							</check_any>
							<set_value name="$kAAIT_isWithdrawFromTarget" exact="true" />
						</check_all>
					</check_all>
				</conditions>
				<actions>
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_WithdrawOrJustFight event.name: ' + @event.name + ' event.param: ' + @event.param.knownname + ', ' + @event.param.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<debug_text text="this.assignedcontrolled.idcode + ' ================================= order: ' + @this.assignedcontrolled.order.id" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<do_if value="event.param != @this.$kAAIT_data.$defensibleTarget" comment="new target">
						<do_if value="
							@this.assignedcontrolled.commander.isclass.[class.ship_l, class.ship_xl] and
							this.assignedcontrolled.commander.sector == this.assignedcontrolled.sector
						">
							<signal_objects object="this.assignedcontrolled.commander" param="'kAAIT_new_big_target'" param2="event.param" />
						</do_if>
					</do_if>
					<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_isWithdrawFromTarget: ' + @$kAAIT_isWithdrawFromTarget" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<do_if value="@$kAAIT_isWithdrawFromTarget">
						<do_if value="
							@this.assignedcontrolled.order.id == 'Attack' and
							(not @$DefensibleScript)
						" comment="assumes this is already in an attack run_script set in order.fight.attack.object">
							<abort_called_scripts resume="kAAITLabel_withdraw" />
						</do_if>
						<!-- <do_elseif value="@this.assignedcontrolled.order.$kAAITParam_iskAAITOrder" comment="assumes this is in move.kuertee.*.xml">
							<abort_called_scripts resume="finish" />
						</do_elseif> -->
						<do_else comment="assumes in any other order with this handler">
							<do_if value="not this.$kAAIT_data?">
								<set_value name="this.$kAAIT_data" exact="table[]" />
							</do_if>
							<set_value name="this.$kAAIT_data.$target_avoid" exact="event.param" />
							<include_interrupt_actions ref="kAAIT_Order_Withdraw" />
						</do_else>
					</do_if>
					<remove_value name="$kAAIT_isHighRiskEvent" />
					<remove_value name="$kAAIT_isWithdrawFromTarget" />
				</actions>
			</handler>

			<actions name="kAAIT_Actions_WithdrawOrNot">
				<do_if value="@$kAAITParam_isAvoidHighRisk and (not @this.$kAAIT_data.isWithdrawing) and (not @this.$kAAIT_data.$isIgnoreKAAIT)">
					<set_value name="$kAAIT_test_target_isHighRisk" exact="$kAAIT_test_target_isWithdraw" />
					<include_interrupt_actions ref="kAAIT_GetIsTargetHighRisk" />
					<remove_value name="$kAAIT_test_target_isHighRisk" />
					<do_if value="$kAAIT_result_isTargetHighRisk">
						<do_if value="
							(not this.assignedcontrolled.weapons.all.count) or
							this.assignedcontrolled.weapons.operational.count / (this.assignedcontrolled.weapons.all.count)f le 0.25 or
							this.assignedcontrolled.shieldpercentage le (75 + (this.skill.piloting + this.skill.morale) / 30.0 * 15)">
							<do_if value="not this.$kAAIT_data?">
								<set_value name="this.$kAAIT_data" exact="table[]" />
							</do_if>
							<set_value name="this.$kAAIT_data.$target_avoid" exact="$kAAIT_test_target_isWithdraw" />
							<include_interrupt_actions ref="kAAIT_Order_Withdraw" />
						</do_if>
					</do_if>
				</do_if>
			</actions>

			<!--
			purpose: determine to avoid object on <event_gravidar_has_scanned />
			to use:
			1. add kAAITParam_isAvoidHighRisk to <params>. see order.fight.attack.object order for its default.
			2. add <handler ref="kAAIT_Handler_AvoidHighRisk" /> to <interrupts>
			-->
			<handler name="kAAIT_Handler_AvoidHighRisk">
				<conditions>
					<event_gravidar_has_scanned object="if (@$kAAITParam_isAvoidHighRisk and (not @this.$kAAIT_data.$isIgnoreKAAIT)) then this.assignedcontrolled else null" check="false"/>
					<check_value value="not this.assignedcontrolled.isunit" />
					<check_value value="not this.assignedcontrolled.islasertower" />
					<check_value value="not @this.$kAAIT_data.$isAvoiding" />
					<check_value value="not @this.$kAAIT_data.$isIgnoreKAAIT" />
					<check_any comment="is avoid high-risk. ensure that these parameters are set-up in the orders that use this handler.">
						<check_value value="@$kAAITParam_iskAAITOrder" />
						<check_value value="@$kAAITParam_isAvoidHighRisk" />
						<check_value value="@$kAAITParam_isStepForwardWithdraw" />
					</check_any>
					<check_all comment="is gravidar target high-risk. when changed, also change others with the 'is gravidar target high-risk' comment.">
						<count_gravidar_contacts result="$kAAIT_gravidarTarget" object="this.assignedcontrolled" class="[class.ship_l, class.ship_xl, class.station]" maybeattackedby="this.assignedcontrolled" checkoperational="false" masstraffic="false" docked="false" min="1" multiple="false">
							<match_context macro="this.sector.macro"/>
							<match_context class="class.highway" negate="true"/>
							<match class="class.buildstorage" negate="true"/>
							<match state="componentstate.wreck" negate="true"/>
						</count_gravidar_contacts>
						<check_value value="@this.sector.exists" />
						<!-- <debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidHighRisk $kAAIT_gravidarTarget: ' + @$kAAIT_gravidarTarget.knownname + ', ' + @$kAAIT_gravidarTarget.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" /> -->
						<check_all comment="is $kAAIT_gravidarTarget high-risk">
							<check_value value="@$kAAIT_gravidarTarget.isoperational" />
							<check_any>
								<check_all comment="this ship is xssm">
									<check_value value="this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m]" />
									<check_all comment="potential high-risk">
										<check_value value="$kAAIT_gravidarTarget.size gt this.assignedcontrolled.size * 1.5" />
										<check_any>
											<check_value value="$kAAIT_gravidarTarget.isclass.station" />
											<check_all>
												<check_value value="$kAAIT_gravidarTarget.primarypurpose == purpose.fight" />
												<check_value value="@$kAAIT_gravidarTarget.type != shiptype.carrier" />
											</check_all>
										</check_any>
									</check_all>
									<!-- <debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidHighRisk potential high-risk v xssm'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" /> -->
									<check_any comment="is high-risk">
										<check_all comment="target is ship">
											<check_value value="$kAAIT_gravidarTarget.isclass.ship" />
											<check_any>
												<check_all comment="this ship is xss">
													<check_value value="this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s]" />
													<check_value value="
														[@$kAAIT_gravidarTarget.assignedaipilot.$kAAIT_attackers.count, @$kAAIT_gravidarTarget.defencenpc.$kAAIT_attackers.count, 1].max * (2 - (this.skill.piloting + this.skill.morale) / 30.0 * 1) le
														@$kAAIT_gravidarTarget.weapons.operational.count * global.$kAAIT_Config.$xss_outnumberVShips / 100.0
													" />
												</check_all>
												<check_all comment="this ship is m">
													<check_value value="this.assignedcontrolled.isclass.ship_m" />
													<check_value value="
														[@$kAAIT_gravidarTarget.assignedaipilot.$kAAIT_attackers.count, @$kAAIT_gravidarTarget.defencenpc.$kAAIT_attackers.count, 1].max * (2 - (this.skill.piloting + this.skill.morale) / 30.0 * 1) le
														@$kAAIT_gravidarTarget.weapons.operational.count * global.$kAAIT_Config.$m_outnumberVShips / 100.0
													" />
												</check_all>
											</check_any>
											<!-- <debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidHighRisk IS high-risk v ship'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" /> -->
										</check_all>
										<check_all comment="target is station">
											<check_value value="$kAAIT_gravidarTarget.isclass.station" />
											<check_any>
												<check_all comment="this ship is xss">
													<check_value value="this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s]" />
													<check_value value="
														[@$kAAIT_gravidarTarget.assignedaipilot.$kAAIT_attackers.count, @$kAAIT_gravidarTarget.defencenpc.$kAAIT_attackers.count, 1].max * (2 - (this.skill.piloting + this.skill.morale) / 30.0 * 1) le
														(@$kAAIT_gravidarTarget.weapons.operational.count + @$kAAIT_gravidarTarget.turrets.operational.count) * global.$kAAIT_Config.$xss_outnumberVStations / 100.0
													" />
													<!-- <debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidHighRisk v station 2'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" /> -->
												</check_all>
												<check_all comment="this ship is m">
													<check_value value="this.assignedcontrolled.isclass.ship_m" />
													<check_value value="
														[@$kAAIT_gravidarTarget.assignedaipilot.$kAAIT_attackers.count, @$kAAIT_gravidarTarget.defencenpc.$kAAIT_attackers.count, 1].max * (2 - (this.skill.piloting + this.skill.morale) / 30.0 * 1) le
														(@$kAAIT_gravidarTarget.weapons.operational.count + @$kAAIT_gravidarTarget.turrets.operational.count) * global.$kAAIT_Config.$m_outnumberVStations / 100.0
													" />
												</check_all>
											</check_any>
											<!-- <debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidHighRisk IS high-risk v station'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" /> -->
										</check_all>
									</check_any>
									<check_any comment="not a bomber">
										<check_value value="not this.assignedcontrolled.dps.missiles.all" />
										<check_value value="not this.assignedcontrolled.ammostorage.missile.count" />
									</check_any>
									<set_value name="$kAAIT_isHighRiskEvent" exact="true" />
								</check_all>
								<check_all comment="this ship is lxl">
									<check_value value="this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl]" />
									<check_any>
										<check_value value="$kAAIT_gravidarTarget.isclass.station" />
										<check_all comment="potential high-risk">
											<check_value value="$kAAIT_gravidarTarget.size gt this.assignedcontrolled.size * 1.5" />
											<check_any>
												<check_value value="$kAAIT_gravidarTarget.isclass.station" />
												<check_all>
													<check_value value="$kAAIT_gravidarTarget.primarypurpose == purpose.fight" />
													<check_value value="@$kAAIT_gravidarTarget.type != shiptype.carrier" />
												</check_all>
											</check_any>
										</check_all>
										<check_all comment="is high-risk">
											<check_value value="$kAAIT_gravidarTarget.isclass.[class.ship_l, class.ship_xl]" />
											<check_value value="$kAAIT_gravidarTarget.dps.all gt this.assignedcontrolled.dps.all * 1.25" />
										</check_all>
									</check_any>
									<set_value name="$kAAIT_isHighRiskEvent" exact="true" />
								</check_all>
							</check_any>
						</check_all>
						<!-- <debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidHighRisk $kAAIT_isHighRiskEvent: ' + @$kAAIT_isHighRiskEvent" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" /> -->
						<check_all comment="is gravidar target not an attack target">
							<check_value value="@$kAAIT_isHighRiskEvent" />
							<check_value value="$kAAIT_gravidarTarget != @this.$kAAIT_data.$defensibleTarget" />
							<!-- <debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidHighRisk not an attack target'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" /> -->
							<check_value value="$kAAIT_gravidarTarget != @this.assignedcontrolled.order.$primarytarget" />
							<!-- <debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidHighRisk not an attack target'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" /> -->
							<check_value value="$kAAIT_gravidarTarget != @this.assignedcontrolled.nextorder.$primarytarget" />
							<!-- <debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidHighRisk not an attack target'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" /> -->
							<check_value value="$kAAIT_gravidarTarget != @this.assignedcontrolled.order.$selectedtarget" />
							<!-- <debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidHighRisk not an attack target'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" /> -->
							<check_value value="$kAAIT_gravidarTarget != @$target" />
							<!-- <debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidHighRisk not an attack target'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" /> -->
							<!-- <check_value value="$kAAIT_gravidarTarget != @this.assignedcontrolled.commander.assignedaipilot.$kAAIT_data.$defensibleTarget" />
							<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidHighRisk not an attack target'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
							<check_value value="$kAAIT_gravidarTarget != @this.assignedcontrolled.commander.order.$primarytarget" />
							<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidHighRisk not an attack target'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
							<check_value value="$kAAIT_gravidarTarget != @this.assignedcontrolled.commander.nextorder.$primarytarget" />
							<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidHighRisk not an attack target'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
							<check_value value="$kAAIT_gravidarTarget != @this.assignedcontrolled.commander.order.$selectedtarget" />
							<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidHighRisk not an attack target'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" /> -->
						</check_all>
						<check_all comment="is gravidar target obstructing destination">
							<check_any>
								<check_value value="not $destination?" />
								<check_value value="$position?" />
								<check_all>
									<check_value value="$destination?" />
									<check_value value="$kAAIT_gravidarTarget != $destination" />
									<check_value value="this.assignedcontrolled.bboxdistanceto.{$kAAIT_gravidarTarget} le this.assignedcontrolled.distanceto.{$destination}" />
									<set_value name="$kAAIT_pathComponent_final" exact="$destination" />
								</check_all>
							</check_any>
							<!-- <debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidHighRisk nearer than dest or no dest'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" /> -->
							<check_any>
								<check_value value="not $destination?" />
								<check_value value="not $position?" />
								<check_all>
									<check_value value="$destination?" />
									<check_value value="$kAAIT_gravidarTarget != $destination" />
									<check_value value="$position?" />
									<check_value value="this.assignedcontrolled.bboxdistanceto.{$kAAIT_gravidarTarget} le this.assignedcontrolled.distanceto.[$destination, $position]" />
									<set_value name="$kAAIT_pathComponent_final" exact="$destination" />
								</check_all>
							</check_any>
							<!-- <debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidHighRisk nearer than dest+pos or (no dest+pos)'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" /> -->
							<check_any>
								<check_value value="not $positionspace?" />
								<check_value value="$position?" />
								<check_all>
									<check_value value="$positionspace?" />
									<check_value value="$kAAIT_gravidarTarget != $destination" />
									<check_value value="this.assignedcontrolled.bboxdistanceto.{$kAAIT_gravidarTarget} le this.assignedcontrolled.distanceto.{$positionspace}" />
									<set_value name="$kAAIT_pathComponent_final" exact="$positionspace" />
								</check_all>
							</check_any>
							<!-- <debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidHighRisk nearer than positionspaces or (no positionspace)'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" /> -->
							<check_any>
								<check_value value="not $positionspace?" />
								<check_value value="not $position?" />
								<check_all>
									<check_value value="$positionspace?" />
									<check_value value="$kAAIT_gravidarTarget != $destination" />
									<check_value value="$position?" />
									<check_value value="this.assignedcontrolled.bboxdistanceto.{$kAAIT_gravidarTarget} le this.assignedcontrolled.distanceto.[$positionspace, $position]" />
									<set_value name="$kAAIT_pathComponent_final" exact="$positionspace" />
								</check_all>
							</check_any>
							<!-- <debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidHighRisk nearer than positionspace+pos or (no positionspace+pos)'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" /> -->
							<check_any>
								<check_value value="not $target?" />
								<check_all>
									<check_value value="$target?" />
									<check_value value="$kAAIT_gravidarTarget != $target" />
									<check_value value="$target.isclass.[class.ship, class.station]" />
									<check_value value="this.assignedcontrolled.bboxdistanceto.{$kAAIT_gravidarTarget} le this.assignedcontrolled.distanceto.{$target}" />
									<set_value name="$kAAIT_pathComponent_final" exact="$target" />
								</check_all>
							</check_any>
							<!-- <debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidHighRisk nearer than target'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" /> -->
							<set_value name="$kAAIT_isNearerThanDestination" exact="true" />
						</check_all>
						<!-- <debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidHighRisk $kAAIT_isNearerThanDestination: ' + @$kAAIT_isNearerThanDestination" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" /> -->
					</check_all>
				</conditions>
				<actions>
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidHighRisk event.name: ' + @event.name + ' $kAAIT_gravidarTarget: ' + @$kAAIT_gravidarTarget.knownname + ', ' + @$kAAIT_gravidarTarget.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<debug_text text="this.assignedcontrolled.idcode + ' =========================== order: ' + @this.assignedcontrolled.order.id" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<is_in_quadrant result="$kAAIT_isInFront" object="this.assignedcontrolled" target="$kAAIT_gravidarTarget" front="true"/>
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidHighRisk $kAAIT_isInFront: ' + @$kAAIT_isInFront" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<do_if value="$kAAIT_isInFront">
						<set_value name="$kAAIT_isInTheWay" exact="false" />
						<do_if value="$kAAIT_pathComponent_final">
							<set_value name="$kAAIT_test_target_isInTheWay" exact="$kAAIT_gravidarTarget" />
							<set_value name="$kAAIT_test_target_isInTheWayOf" exact="$kAAIT_pathComponent_final" />
							<include_interrupt_actions ref="kAAIT_GetIsTargetInTheWay" />
							<remove_value name="$kAAIT_test_target_isInTheWay" />
							<remove_value name="$kAAIT_test_target_isInTheWayOf" />
							<set_value name="$kAAIT_isInTheWay" exact="$kAAIT_result_isTargetInTheWay" />
						</do_if>
						<do_else>
							<set_value name="$kAAIT_isInTheWay" exact="true" />
						</do_else>
						<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_AvoidHighRisk $kAAIT_isInTheWay: ' + @$kAAIT_isInTheWay" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
						<do_if value="$kAAIT_isInTheWay">
							<do_if value="not this.$kAAIT_data?">
								<set_value name="this.$kAAIT_data" exact="table[]" />
							</do_if>
							<set_value name="this.$kAAIT_data.$target_avoid" exact="$kAAIT_gravidarTarget" />
							<include_interrupt_actions ref="kAAIT_Order_Avoid" />
						</do_if>
					</do_if>
					<abort_called_scripts resume="start" />
					<remove_value name="$kAAIT_gravidarTarget" />
					<remove_value name="$kAAIT_isInFront" />
					<remove_value name="$kAAIT_isHighRiskEvent" />
				</actions>
			</handler>

			<handler name="kAAIT_Handler_NewBigTarget">
				<conditions>
					<check_any>
						<event_object_signalled object="this.assignedcontrolled" param="'kAAIT_new_big_target'" />
						<event_object_signalled object="this.assignedcontrolled.commander" param="'kAAIT_new_big_target'" check="false" />
					</check_any>
					<check_all>
						<check_value value="event.param2.isclass.[class.ship_l, class.ship_xl]" />
						<check_any comment="new target needs to be bigger or old target is a station">
							<check_value value="@event.param2.size gt @this.$kAAIT_data.$defensibleTarget.size" comment="new target is bigger than current target" />
							<check_value value="@this.$kAAIT_data.$defensibleTarget.isclass.station" comment="new LXL target is more dangerous than current station target" />
						</check_any>
						<check_all>
							<check_any comment="current order is not attack or is of different target">
								<check_value value="@this.assignedcontrolled.order.id != 'Attack'" />
								<check_value value="@this.assignedcontrolled.order.$primarytarget != event.param2" />
							</check_any>
							<check_any comment="next order is not attack or is of different target">
								<check_value value="@this.assignedcontrolled.orders.{2}.id != 'Attack'" />
								<check_value value="@this.assignedcontrolled.orders.{2}.$primarytarget != event.param2" />
							</check_any>
							<check_value value="@this.assignedcontrolled.orders.{3}.id != 'Attack'" comment="too many attack orders if there's already a 3rd attack order" />
						</check_all>
					</check_all>
				</conditions>
				<actions>
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_NewBigTarget event.name: ' + event.name" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<debug_text text="this.assignedcontrolled.idcode + ' ========================== order: ' + @this.assignedcontrolled.order.id" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<debug_text text="this.assignedcontrolled.idcode + ' size: ' + @this.$kAAIT_data.$defensibleTarget.size + ' class: ' + @this.$kAAIT_data.$defensibleTarget.class" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<debug_text text="this.assignedcontrolled.idcode + ' size: ' + event.param2.size + ' class: ' + event.param2.class" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<set_value name="$kAAIT_target_attack" exact="event.param2" />
					<include_interrupt_actions ref="kAAIT_Order_AttackOther" />
				</actions>
			</handler>

			<handler name="kAAIT_Handler_TacticalSubordinateAttack">
				<conditions>
					<check_any>
						<check_all>
							<check_any>
								<event_object_attacked object="this.assignedcontrolled" />
								<event_object_attacked_object object="this.assignedcontrolled" />
							</check_any>
							<check_any>
								<check_all>
									<check_value value="event.param == @$kAAITParam_tacticalOrderTarget" />
									<set_value name="$kAAIT_isTacticalTargetAttacked" exact="true" />
								</check_all>
								<check_all>
									<check_value value="event.param.size gt this.assignedcontrolled.size * 1.5" />
									<set_value name="$kAAAIT_isBigEnemyAttacked" exact="true" />
								</check_all>
							</check_any>
						</check_all>
						<check_all>
							<event_object_changed_zone object="if @$kAAITParam_tacticalOrderTarget.isoperational then $kAAITParam_tacticalOrderTarget else null" param="this.assignedcontrolled" check="false" />
							<check_value value="@this.assignedcontrolled.bboxdistanceto.{$kAAITParam_tacticalOrderTarget} le this.assignedcontrolled.maxradarrange * 0.5" />
							<set_value name="$kAAIT_isTacticalTargetNear" exact="true" />
						</check_all>
					</check_any>
					<check_value value="@$kAAITParam_tacticalOrderTarget.isoperational" />
				</conditions>
				<actions>
					<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Handler_TacticalSubordinateAttack event.name: ' + @event.name + ' event.param: ' + @event.param.knownname + ', ' + @event.param.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<debug_text text="this.assignedcontrolled.idcode + ' ======================================= order: ' + @this.assignedcontrolled.order.id" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<do_if value="@$kAAIT_isTacticalTargetAttacked" comment="release all from tactical order and just attack">
						<signal_objects object="this.assignedcontrolled.commander" param="'kAAIT_tactical_just_attack'" param2="table[$eventName = event.name, $eventObject = this.assignedcontrolled, $eventParam = event.param]" />
					</do_if>
					<do_elseif value="@$kAAAIT_isBigEnemyAttacked">
						<do_if value="@$kAAITParam_tacticalOrderTarget.isoperational and @$kAAITParam_tacticalOrderTarget.bboxdistanceto.{event.param} le this.assignedcontrolled.maxradarrange * 0.5"
							comment="other big enemy nearby, release all from tactical order and just attack">
							<signal_objects object="this.assignedcontrolled.commander" param="'kAAIT_tactical_just_attack'" param2="table[$eventName = event.name, $eventObject = this.assignedcontrolled, $eventParam = event.param]" />
						</do_if>
						<do_else comment="release self from tactical order and attack new">
							<set_value name="$kAAIT_target_attack" exact="event.param" />
							<include_interrupt_actions ref="kAAIT_Order_AttackOther" />
						</do_else>
					</do_elseif>
					<do_elseif value="@$kAAIT_isTacticalTargetNear" comment="release all from tactical order and just attack">
						<signal_objects object="this.assignedcontrolled.commander" param="'kAAIT_tactical_just_attack'" param2="table[$eventName = event.name, $eventObject = this.assignedcontrolled, $eventParam = event.param]" />
					</do_elseif>
					<remove_value name="$kAAIT_isTacticalTargetAttacked" />
					<remove_value name="$kAAIT_isPrimaryTargetAttacked" />
					<remove_value name="$kAAAIT_isBigEnemyAttacked" />
					<remove_value name="$kAAIT_isTacticalTargetNear" />
				</actions>
			</handler>

			<!--
				88  88 888888 88     88""Yb 888888 88""Yb .dP"Y8
				88  88 88__   88     88__dP 88__   88__dP `Ybo."
				888888 88""   88  .o 88"""  88""   88"Yb  o.`Y8b
				88  88 888888 88ood8 88     888888 88  Yb 8bodP'
			 -->
			<actions name="kAAIT_GetCombatRange">
				<do_if value="not this.$kAAIT_data?">
					<set_value name="this.$kAAIT_data" exact="table[]" />
				</do_if>
				<set_value name="this.$kAAIT_data.$combatRange_max" exact="[
					this.assignedcontrolled.maxcombatrange.primary,
					this.assignedcontrolled.maxcombatrange.secondary,
					this.assignedcontrolled.maxcombatrange.lasers.all,
					this.assignedcontrolled.maxcombatrange.missiles.all,
					this.assignedcontrolled.maxcombatrange.turrets,
				].max * 0.9" />
				<set_value name="this.$kAAIT_data.$combatRange_min" exact="[
					if this.assignedcontrolled.maxcombatrange.primary then this.assignedcontrolled.maxcombatrange.primary else 1000000,
					if this.assignedcontrolled.maxcombatrange.secondary then this.assignedcontrolled.maxcombatrange.secondary else 1000000,
					if this.assignedcontrolled.maxcombatrange.lasers.all then this.assignedcontrolled.maxcombatrange.lasers.all else 1000000,
					if this.assignedcontrolled.maxcombatrange.missiles.all then this.assignedcontrolled.maxcombatrange.missiles.all else 1000000,
					if this.assignedcontrolled.maxcombatrange.turrets then this.assignedcontrolled.maxcombatrange.turrets else 1000000,
				].min * 0.9" />
				<set_value name="this.$kAAIT_data.$combatRange_mid" exact="this.$kAAIT_data.$combatRange_min + (this.$kAAIT_data.$combatRange_max - this.$kAAIT_data.$combatRange_min) * 0.5" />
			</actions>

			<actions name="kAAIT_GetIsTargetHighRisk" comment="also update 'is event.param high-risk' conditions in different handlers">
				<do_if value="not this.$kAAIT_data?">
					<set_value name="this.$kAAIT_data" exact="table[]" />
				</do_if>
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetIsTargetHighRisk $kAAIT_test_target_isHighRisk: ' + @$kAAIT_test_target_isHighRisk.isoperational + ' ' + @$kAAIT_test_target_isHighRisk.knownname + ' ' + @$kAAIT_test_target_isHighRisk.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<set_value name="$kAAIT_result_isTargetHighRisk" exact="false" />
				<do_if value="$kAAIT_test_target_isHighRisk.defensible">
					<set_value name="$kAAIT_test_target_isHighRisk" exact="$kAAIT_test_target_isHighRisk.defensible" />
				</do_if>
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetIsTargetHighRisk $kAAIT_test_target_isHighRisk (defensible): ' + @$kAAIT_test_target_isHighRisk.isoperational + ' ' + @$kAAIT_test_target_isHighRisk.knownname + ' ' + @$kAAIT_test_target_isHighRisk.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<do_if value="@$kAAIT_test_target_isHighRisk.isoperational">
					<do_if value="not @$kAAIT_target_highRiskEntity.exists">
						<set_value name="$kAAIT_target_highRiskEntity" exact="@$kAAIT_test_target_isHighRisk.assignedaipilot" />
						<do_if value="not @$kAAIT_target_highRiskEntity.exists">
							<set_value name="$kAAIT_target_highRiskEntity" exact="@$kAAIT_test_target_isHighRisk.defencenpc" />
						</do_if>
					</do_if>
					<do_if value="this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m]">
						<set_value name="$kAAIT_isTargetPotentialHighRisk" exact="
							$kAAIT_test_target_isHighRisk.size gt this.assignedcontrolled.size * 1.5 and
							(
								$kAAIT_test_target_isHighRisk.isclass.station or
								(
									$kAAIT_test_target_isHighRisk.primarypurpose == purpose.fight and
									@$kAAIT_test_target_isHighRisk.type != shiptype.carrier
								)
							)
						" />
						<do_if value="$kAAIT_test_target_isHighRisk.isclass.ship">
							<set_value name="$kAAIT_gunCount" exact="@$kAAIT_test_target_isHighRisk.weapons.operational.count" />
						</do_if>
						<do_else>
							<set_value name="$kAAIT_gunCount" exact="
								@$kAAIT_test_target_isHighRisk.weapons.operational.count + 
								[@$kAAIT_test_target_isHighRisk.weapons.operational.count, @$kAAIT_test_target_isHighRisk.turrets.operational.count].max
							" />
						</do_else>
						<do_if value="not this.$kAAIT_data.$skill_attackers_count_mult?">
							<include_interrupt_actions ref="kAAIT_GetSkillVars" />
						</do_if>
						<!-- <debug_text text="''" /> -->
						<!-- <debug_text text="''" /> -->
						<!-- <debug_text text="''" /> -->
						<debug_text text="this.assignedcontrolled.idcode + ' @$kAAIT_target_highRiskEntity.$kAAIT_attackers.count * this.$kAAIT_data.$skill_attackers_count_mult: ' + (@$kAAIT_target_highRiskEntity.$kAAIT_attackers.count * this.$kAAIT_data.$skill_attackers_count_mult)" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
						<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_gunCount * global.$kAAIT_Config.$xss_outnumberVStations / 100.0: ' + ($kAAIT_gunCount * global.$kAAIT_Config.$xss_outnumberVStations / 100.0)" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
						<set_value name="$kAAIT_result_isTargetHighRisk" exact="
							$kAAIT_isTargetPotentialHighRisk and
							(
								(
									this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s] and
									@$kAAIT_test_target_isHighRisk.isclass.ship and
									@$kAAIT_target_highRiskEntity.$kAAIT_attackers.count * this.$kAAIT_data.$skill_attackers_count_mult le $kAAIT_gunCount * global.$kAAIT_Config.$xss_outnumberVShips / 100.0
								)
								or
								(
									this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s] and
									@$kAAIT_test_target_isHighRisk.isclass.station and
									@$kAAIT_target_highRiskEntity.$kAAIT_attackers.count * this.$kAAIT_data.$skill_attackers_count_mult le $kAAIT_gunCount * global.$kAAIT_Config.$xss_outnumberVStations / 100.0
								)
								or
								(
									this.assignedcontrolled.isclass.ship_m and
									@$kAAIT_test_target_isHighRisk.isclass.ship and
									@$kAAIT_target_highRiskEntity.$kAAIT_attackers.count * this.$kAAIT_data.$skill_attackers_count_mult le $kAAIT_gunCount * global.$kAAIT_Config.$m_outnumberVShips / 100.0
								)
								or
								(
									this.assignedcontrolled.isclass.ship_m and
									@$kAAIT_test_target_isHighRisk.isclass.station and
									@$kAAIT_target_highRiskEntity.$kAAIT_attackers.count * this.$kAAIT_data.$skill_attackers_count_mult le $kAAIT_gunCount * global.$kAAIT_Config.$m_outnumberVStations / 100.0
								)
								or
								$kAAIT_test_target_isHighRisk.hullpercentage lt 1
							) and
							(
								(not this.assignedcontrolled.dps.missiles.all) or
								(not this.assignedcontrolled.ammostorage.missile.count)
							)
						"/>
					</do_if>
					<do_elseif value="this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl]">
						<set_value name="$kAAIT_isTargetPotentialHighRisk" exact="
							$kAAIT_test_target_isHighRisk.isclass.station or
							(
								$kAAIT_test_target_isHighRisk.size gt this.assignedcontrolled.size * 1.5 and
								$kAAIT_test_target_isHighRisk.primarypurpose == purpose.fight and
								@$kAAIT_test_target_isHighRisk.type != shiptype.carrier
							) or
							(
								$kAAIT_test_target_isHighRisk.isclass.[class.ship_l, class.ship_xl] and
								$kAAIT_test_target_isHighRisk.dps.all gt this.assignedcontrolled.dps.all * 1.25
							)
						" />
						<set_value name="$kAAIT_result_isTargetHighRisk" exact="$kAAIT_isTargetPotentialHighRisk" />
					</do_elseif>
				</do_if>
				<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_isTargetPotentialHighRisk: ' + @$kAAIT_isTargetPotentialHighRisk + ' $kAAIT_result_isTargetHighRisk: ' + @$kAAIT_result_isTargetHighRisk" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			</actions>

			<actions name="kAAIT_GetBigEnemies">
				<do_if value="not @$kAAIT_bigEnemies.count or @$kAAIT_bigEnemies.{$kAAIT_bigEnemies.count}.bboxdistanceto.{this.assignedcontrolled} gt this.assignedcontrolled.maxradarrange">
					<create_group groupname="$kAAIT_bigEnemies" />
					<find_gravidar_contact groupname="$kAAIT_bigEnemies" object="this.assignedcontrolled" class="[class.ship_l, class.ship_xl, class.station]" docked="false" functional="true" maybeattackedby="this.assignedcontrolled" multiple="true" chance="if @this.assignedcontrolled.sector.macro then 100 else 0">
						<match_context macro="this.assignedcontrolled.sector.macro"/>
						<match class="class.buildstorage" negate="true"/>
						<match state="componentstate.wreck" negate="true"/>
						<!-- <match_distance max="this.assignedcontrolled.maxradarrange * 0.5" object="this.assignedcontrolled" /> -->
					</find_gravidar_contact>
					<do_if value="@$kAAITParam_enemyAvoid">
						<add_to_group groupname="$kAAIT_bigEnemies" object="$kAAITParam_enemyAvoid" />
					</do_if>
					<sort_group group="$kAAIT_bigEnemies" sortbyvalue="this.assignedcontrolled.bboxdistanceto.{loop.element}" />
				</do_if>
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetBigEnemies $kAAIT_bigEnemies.count: ' + @$kAAIT_bigEnemies.count" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			</actions>

			<actions name="kAAIT_GetIsNearBigEnemies">
				<set_value name="$kAAIT_result_isShipNearBigEnemy" exact="false" />
				<set_value name="$kAAIT_result_isTargetNearBigEnemy" exact="false" />
				<set_value name="$kAAIT_result_bigEnemy" exact="null" />
				<do_if value="@$kAAIT_bigEnemies.count">
					<do_for_each name="$kAAIT_bigEnemy_inList" in="$kAAIT_bigEnemies">
						<do_if value="$kAAIT_bigEnemy_inList != @this.$kAAIT_data.$defensibleTarget">
							<do_if value="$kAAIT_bigEnemy_inList.bboxdistanceto.{this.assignedcontrolled} le this.assignedcontrolled.maxradarrange * 0.5">
								<set_value name="$kAAIT_result_isShipNearBigEnemy" exact="true" />
							</do_if>
							<do_if value="$kAAIT_bigEnemy_inList != @this.$kAAIT_data.$defensibleTarget">
								<do_if value="
									(
										@this.$kAAIT_data.$defensibleTarget.isoperational and
										$kAAIT_bigEnemy_inList.bboxdistanceto.{this.$kAAIT_data.$defensibleTarget} le this.assignedcontrolled.maxradarrange * 0.5
									) or
									(
										@$target.isoperational and
										$kAAIT_bigEnemy_inList.bboxdistanceto.{$target} le this.assignedcontrolled.maxradarrange * 0.5
									)
								">
									<set_value name="$kAAIT_result_isTargetNearBigEnemy" exact="true" />
								</do_if>
							</do_if>
							<do_if value="$kAAIT_result_isShipNearBigEnemy or $kAAIT_result_isTargetNearBigEnemy">
								<set_value name="$kAAIT_result_bigEnemy" exact="$kAAIT_bigEnemy_inList" />
								<break />
							</do_if>
						</do_if>
					</do_for_each>
				</do_if>
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetIsNearBigEnemies $kAAIT_result_isShipNearBigEnemy: ' + $kAAIT_result_isShipNearBigEnemy + ' $kAAIT_result_isTargetNearBigEnemy: ' + $kAAIT_result_isTargetNearBigEnemy" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetIsNearBigEnemies $kAAIT_result_bigEnemy: ' + @kAAIT_result_bigEnemy.knownname + ' ' + @$kAAIT_result_bigEnemy.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			</actions>

			<actions name="kAAIT_FindSmallerTargetFarFromBigTarget">
				<set_value name="$kAAIT_result_target_found" exact="null" />
				<do_if value="
					this.assignedcontrolled.primarypurpose == purpose.fight and
					this.assignedcontrolled.type != shiptype.carrier">
					<find_gravidar_contact name="$kAAIT_smallTargets" object="this.assignedcontrolled" class="[class.ship_xs, class.ship_s, class.ship_m]" docked="false" functional="true" maybeattackedby="this.assignedcontrolled" sortbydistanceto="this.assignedcontrolled" multiple="true">
						<match_context macro="this.assignedcontrolled.sector.macro"/>
						<match class="class.buildstorage" negate="true"/>
						<match state="componentstate.wreck" negate="true"/>
						<match_distance min="this.assignedcontrolled.maxradarrange * 0.25" max="this.assignedcontrolled.maxradarrange" object="$kAAIT_bigEnemy" />
					</find_gravidar_contact>
					<sort_list list="$kAAIT_smallTargets" sortbyvalue="loop.element.size" sortdescending="false" />
					<set_value name="$kAAIT_result_target_found" exact="@$kAAIT_smallTargets.{1}" />
					<do_if value="@$kAAIT_result_target_found.isoperational and $kAAIT_result_target_found.size le this.assignedcontrolled.size * 1.5">
						<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_result_target_found (pre obstruction test): ' + @$kAAIT_result_target_found" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
						<do_if value="$kAAIT_result_target_found.bboxdistanceto.{$kAAIT_bigEnemy} gt this.assignedcontrolled.bboxdistanceto.{$kAAIT_bigEnemy}" comment="because this is circling a big target already, any object farther away would put the big target in the way">
							<set_value name="$kAAIT_result_target_found" exact="null" />
						</do_if>
						<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_result_target_found (post-obstruction test): ' + @$kAAIT_result_target_found" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					</do_if>
				</do_if>
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_FindSmallerTargetFarFromBigTarget $kAAIT_result_target_found: ' + @$kAAIT_result_target_found.knownname + ' ' + @$kAAIT_result_target_found.idcode + ' size: ' + @$kAAIT_result_target_found.size + ' weapons: ' + @$kAAIT_result_target_found.weapons.operational.count" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			</actions>

			<actions name="kAAIT_GetSkillVars" comment="also update 'is event.param high-risk' conditions in different handlers">
				<do_if value="not this.$kAAIT_data?">
					<set_value name="this.$kAAIT_data" exact="table[]" />
				</do_if>
				<do_if value="global.$kAAIT_Config.$isUseNPCSkills">
					<set_value name="this.$kAAIT_data.$skill_attackers_count_mult" exact="2 - (this.skill.piloting + this.skill.morale) / 30.0 * 1" comment="0 = * 2, 5 = * 1" />
					<set_value name="this.$kAAIT_data.$skill_distance_engagePosition_mult" exact="0.75 + (this.skill.piloting + this.skill.morale) / 30.0 * 0.25" comment="combat range max * (0 = * 0.75, 5 = 1)" />
					<set_value name="this.$kAAIT_data.$skill_distance_stepForward_mult" exact="2 - (this.skill.piloting + this.skill.morale) / 30.0 * 1" comment="count of step forwards * (0 = 2km, 5 = 1km)" />
					<set_value name="this.$kAAIT_data.$skill_shieldPercentage_withdrawAt" exact="75 + (this.skill.piloting + this.skill.morale) / 30.0 * 25" comment="0 = 75, 5 = 90" />
					<set_value name="this.$kAAIT_data.$skill_distance_withdraw" exact="this.assignedcontrolled.maxradarrange * (0.25 + (this.skill.piloting + this.skill.morale) / 30.0 * 0.25)" comment="0 = * 0.25, 5 = * 0.5" />
				</do_if>
				<do_else>
					<set_value name="this.$kAAIT_data.$skill_attackers_count_mult" exact="1" />
					<set_value name="this.$kAAIT_data.$skill_distance_engagePosition_mult" exact="1" />
					<set_value name="this.$kAAIT_data.$skill_distance_stepForward_mult" exact="1" />
					<set_value name="this.$kAAIT_data.$skill_shieldPercentage_withdrawAt" exact="90" />
					<set_value name="this.$kAAIT_data.$skill_distance_withdraw" exact="this.assignedcontrolled.maxradarrange * 0.5" />
				</do_else>
			</actions>

			<actions name="kAAIT_GetEscortPos">
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetEscortPos'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<create_position name="$kAAIT_pos_self" space="this.assignedcontrolled.sector" object="this.assignedcontrolled" />
				<create_position name="$kAAIT_pos_escort" space="this.assignedcontrolled.sector" object="$kAAIT_target_escort" />
				<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_target_escort: ' + $kAAIT_target_escort.knownname + ' ' + $kAAIT_target_escort.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<create_orientation name="$kAAIT_rot_fromEscort" orientation="look_at" refposition="$kAAIT_pos_self">
					<position value="$kAAIT_pos_escort" />
				</create_orientation>
				<set_value name="$kAAIT_yaw_fromEscort" exact="$kAAIT_rot_fromEscort.yaw * 180 / pi" />
				<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_yaw_fromEscort: ' + $kAAIT_yaw_fromEscort" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<set_value name="$kAAIT_pitch_fromEscort" exact="$kAAIT_rot_fromEscort.pitch * 180 / pi" />
				<set_value name="$kAAIT_escortEnemy" exact="null" />
				<do_if value="@$kAAIT_target_escort.assignedaipilot.$kAAIT_data.$defensibleTarget.isoperational">
					<set_value name="$kAAIT_escortEnemy" exact="$kAAIT_target_escort.assignedaipilot.$kAAIT_data.$defensibleTarget" />
				</do_if>
				<do_elseif value="@$kAAIT_target_escort.order.$primarytarget.isoperational">
					<set_value name="$kAAIT_escortEnemy" exact="$kAAIT_target_escort.order.$primarytarget" />
				</do_elseif>
				<do_elseif value="@$kAAIT_target_escort.nextorder.$primarytarget.isoperational">
					<set_value name="$kAAIT_escortEnemy" exact="$kAAIT_target_escort.nextorder.$primarytarget" />
				</do_elseif>
				<do_elseif value="@$kAAIT_target_escort.order.$selectedtarget.isoperational">
					<set_value name="$kAAIT_escortEnemy" exact="$kAAIT_target_escort.order.$selectedtarget" />
				</do_elseif>
				<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_escortEnemy: ' + @$kAAIT_escortEnemy.knownname + ' ' + @$kAAIT_escortEnemy.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<do_if value="$kAAIT_escortEnemy">
					<create_position name="$kAAIT_pos_escortEnemy" space="this.assignedcontrolled.sector" object="$kAAIT_escortEnemy" />
					<create_orientation name="$kAAIT_rot_fromEnemyToEscort" orientation="look_at" refposition="$kAAIT_pos_escort">
						<position value="$kAAIT_pos_escortEnemy" />
					</create_orientation>
					<set_value name="$kAAIT_result_yawDeg" exact="$kAAIT_rot_fromEnemyToEscort.yaw * 180 / pi" />
					<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_result_yawDeg: ' + $kAAIT_result_yawDeg" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<set_value name="$kAAIT_result_pitchDeg" exact="$kAAIT_rot_fromEnemyToEscort.pitch * 180 / pi" />
					<set_value name="$kAAIT_index_self" exact="$kAAIT_target_escort.subordinates.indexof.{this.assignedcontrolled}" />
					<set_value name="$kAAIT_maxAngle" exact="45" />
					<set_value name="$kAAIT_angleForOneShip" exact="$kAAIT_maxAngle * 2 / ($kAAIT_target_escort.subordinates.count - 1)f" />
					<set_value name="$kAAIT_yaw_adj" exact="($kAAIT_maxAngle * -1) + (($kAAIT_index_self - 1) * $kAAIT_angleForOneShip)" />
					<set_value name="$kAAIT_result_yawDeg" operation="add" exact="$kAAIT_yaw_adj" />
				</do_if>
				<do_else>
					<set_value name="$kAAIT_result_yawDeg" exact="$kAAIT_yaw_fromEscort" />
					<set_value name="$kAAIT_result_pitchDeg" exact="$kAAIT_pitch_fromEscort" />
				</do_else>
				<set_value name="$kAAIT_result_yawRad" exact="$kAAIT_result_yawDeg * pi / 180" />
				<set_value name="$kAAIT_result_pitchRad" exact="$kAAIT_result_pitchDeg * pi / 180" />
				<create_position name="$kAAIT_result_pos_escort"
					x="$kAAIT_pos_escort.x + 10km * sin ($kAAIT_result_yawRad) * cos ($kAAIT_result_pitchRad)"
					y="$kAAIT_pos_escort.y + 10km * sin ($kAAIT_result_pitchRad)"
					z="$kAAIT_pos_escort.z + 10km * cos ($kAAIT_result_yawRad) * cos ($kAAIT_result_pitchRad)"/>
				<!-- <do_if value="$kAAIT_pos_escortEnemy">
					<create_orientation name="$kAAIT_rot_fromEnemyToEscort" orientation="look_at" refposition="$kAAIT_result_pos_escort">
						<position value="$kAAIT_pos_escortEnemy" />
					</create_orientation>
					<set_value name="$kAAIT_yaw_final" exact="$kAAIT_rot_fromEnemyToEscort.yaw * 180 / pi" />
					<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_yaw_final: ' + $kAAIT_yaw_final" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				</do_if> -->
			</actions>

			<actions name="kAAIT_GetIsTargetInTheWay">
				<set_value name="$kAAIT_dist_toTarget" exact="this.assignedcontrolled.bboxdistanceto.{$kAAIT_test_target_isInTheWay}" />
				<get_global_path component="$kAAIT_pathComponents" uselocalhighways="true" multiple="true">
					<start object="this.assignedcontrolled" />
					<end object="$kAAIT_test_target_isInTheWayOf" />
				</get_global_path>
				<set_value name="$kAAIT_pathComponent" exact="$kAAIT_pathComponents.{1}" />
				<do_if value="$kAAIT_pathComponent == this.assignedcontrolled">
					<set_value name="$kAAIT_pathComponent" exact="$kAAIT_pathComponents.{2}" />
				</do_if>
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetIsTargetInTheWay $kAAIT_pathComponent: ' + @$kAAIT_pathComponent.knownname + ' ' + @$kAAIT_pathComponent.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<do_if value="$kAAIT_pathComponent == this.sector or @$kAAIT_pathComponent.sector == this.sector">
					<do_if value="$kAAIT_pathComponent.isclass.sector or $kAAIT_pathComponent.isclass.zone">
						<do_if value="@$position" comment="generally in MoveGeneric">
							<set_value name="$kAAIT_dist_toDest" exact="this.assignedcontrolled.distanceto.[$kAAIT_pathComponent, $position]" />
							<set_value name="$kAAIT_result_isTargetInTheWay" exact="$kAAIT_dist_toDest gt $kAAIT_dist_toTarget" />
						</do_if>
						<do_else comment="can't determine if in the way, assume in the way if nearby">
							<set_value name="$kAAIT_result_isTargetInTheWay" exact="$kAAIT_dist_toTarget le this.assignedcontrolled.maxradarrange * 0.25" />
						</do_else>
					</do_if>
					<do_else>
						<set_value name="$kAAIT_dist_toDest" exact="this.assignedcontrolled.distanceto.{$kAAIT_pathComponent}" />
						<set_value name="$kAAIT_result_isTargetInTheWay" exact="$kAAIT_dist_toDest gt $kAAIT_dist_toTarget" />
					</do_else>
				</do_if>
				<do_else>
					<set_value name="$kAAIT_result_isTargetInTheWay" exact="true" />
				</do_else>
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetIsTargetInTheWay $kAAIT_dist_toDest: ' + @$kAAIT_dist_toDest" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetIsTargetInTheWay $kAAIT_dist_toTarget: ' + @$kAAIT_dist_toTarget" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetIsTargetInTheWay $kAAIT_result_isTargetInTheWay: ' + @$kAAIT_result_isTargetInTheWay" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			</actions>

			<!--
				 dP"Yb  88""Yb 8888b.  888888 88""Yb .dP"Y8
				dP   Yb 88__dP  8I  Yb 88__   88__dP `Ybo."
				Yb   dP 88"Yb   8I  dY 88""   88"Yb  o.`Y8b
				 YbodP  88  Yb 8888Y"  888888 88  Yb 8bodP'
			 -->
			<actions name="kAAIT_CleanOrders">
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_CleanOrders order: ' + @this.assignedcontrolled.order.id" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<do_for_each name="$kAAIT_order" in="this.assignedcontrolled.orders" counter="$i" reverse="true">
					<do_if value="@$kAAIT_order.$kAAITParam_iskAAITOrder and $i gt 1" comment="cancel other move.kuertee.*.xml order">
						<debug_text text="this.assignedcontrolled.idcode + ' cancel_order ' + $kAAIT_order.id" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
						<cancel_order order="$kAAIT_order" />
					</do_if>
				</do_for_each>
			</actions>

			<actions name="kAAIT_Order_AttackOther">
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Order_AttackOther'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' ======================='" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_target_attack: ' + @$kAAIT_target_attack.knownname + ' ' + @$kAAIT_target_attack.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<include_interrupt_actions ref="kAAIT_CleanOrders" />
				<do_if value="this.assignedcontrolled.order">
					<unassign_order_syncpoint_from_order order="this.assignedcontrolled.order" />
				</do_if>
				<create_order name="$kAAIT_order_attack" object="this.assignedcontrolled" id="'Attack'" immediate="true">
					<param name="primarytarget" value="$kAAIT_target_attack" />
					<param name="pursuedistance" value="this.assignedcontrolled.maxradarrange" />
					<param name="pursuetargets" value="false" />
					<param name="kAAITParam_iskAAITOrder" value="true" />
					<param name="kAAITParam_isAvoidHighRisk" value="@$kAAITParam_isAvoidHighRisk" />
					<param name="kAAITParam_isStepForwardWithdraw" value="@$kAAITParam_isStepForwardWithdraw" />
					<param name="debugchance" value="$debugchance"/>
				</create_order>
			</actions>

			<actions name="kAAIT_Order_Avoid">
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Order_Avoid'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' ================='" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' this.$kAAIT_data.$target_avoid: ' + @this.$kAAIT_data.$target_avoid.knownname + ' ' + @this.$kAAIT_data.$target_avoid.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<include_interrupt_actions ref="kAAIT_CleanOrders" />
				<do_if value="this.assignedcontrolled.order">
					<unassign_order_syncpoint_from_order order="this.assignedcontrolled.order" />
				</do_if>
				<set_value name="$kAAIT_isImmediate" exact="true" />
				<do_if value="@this.assignedcontrolled.order.id == 'TacticalOrder'">
					<set_value name="$kAAIT_isImmediate" exact="false" />
				</do_if>
				<create_order object="this.assignedcontrolled" id="'kAAIT_MoveAvoid'" immediate="$kAAIT_isImmediate">
					<param name="target" value="this.$kAAIT_data.$target_avoid" />
				</create_order>
				<do_if value="not $kAAIT_isImmediate" comment="if TacticalOrder, cancel it. then re-add it.">
					<set_value name="$kAAIT_target_attack" exact="this.assignedcontrolled.order.$selectedtarget" />
					<set_value name="$kAAIT_aggressiveness" exact="this.assignedcontrolled.order.$aggressiveness" />
					<set_value name="$kAAIT_weakfirst" exact="this.assignedcontrolled.order.$weakfirst" />
					<set_value name="$kAAIT_xdistance" exact="this.assignedcontrolled.order.$xdistance" />
					<set_value name="$kAAIT_zdistance" exact="this.assignedcontrolled.order.$zdistance" />
					<set_value name="$kAAIT_timeout" exact="this.assignedcontrolled.order.$timeout" />
					<cancel_order order="this.assignedcontrolled.order" />
					<create_order object="this.assignedcontrolled" id="'TacticalOrder'">
						<param name="selectedtarget" value="$kAAIT_target_attack" />
						<param name="aggressiveness" value="$kAAIT_aggressiveness" />
						<param name="weakfirst" value="$kAAIT_weakfirst" />
						<param name="xdistance" value="$kAAIT_xdistance" />
						<param name="zdistance" value="$kAAIT_zdistance" />
						<param name="timeout" value="$kAAIT_timeout" />
					</create_order>
				</do_if>
			</actions>

			<actions name="kAAIT_Order_Flee">
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Order_Flee'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' ================'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' this.$kAAIT_data.$target_avoid: ' + @this.$kAAIT_data.$target_avoid.knownname + ' ' + @this.$kAAIT_data.$target_avoid.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<include_interrupt_actions ref="kAAIT_CleanOrders" />
				<do_if value="this.assignedcontrolled.order">
					<unassign_order_syncpoint_from_order order="this.assignedcontrolled.order" />
				</do_if>
				<create_order object="this.assignedcontrolled" id="'Flee'" immediate="true">
					<param name="method" value="'boost'"/>
					<param name="attacker" value="this.$kAAIT_data.$target_avoid"/>
					<param name="donotdrop" value="true"/>
					<param name="deploydistraction" value="@this.$kAAIT_data.$defensibleTarget.isclass.ship"/>
					<param name="log" value="false"/>
					<param name="kAAITParam_iskAAITOrder" value="true"/>
					<param name="debugchance" value="$debugchance"/>
				</create_order>
			</actions>

			<actions name="kAAIT_Order_Withdraw">
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_Order_Withdraw'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' ===================='" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<debug_text text="this.assignedcontrolled.idcode + ' this.$kAAIT_data.$target_avoid: ' + @this.$kAAIT_data.$target_avoid.knownname + ' ' + @this.$kAAIT_data.$target_avoid.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<include_interrupt_actions ref="kAAIT_CleanOrders" />
				<do_if value="this.assignedcontrolled.order">
					<unassign_order_syncpoint_from_order order="this.assignedcontrolled.order" />
				</do_if>
				<create_order object="event.object" id="'kAAIT_MoveWithdraw'" immediate="true">
					<param name="target" value="this.$kAAIT_data.$target_avoid"/>
				</create_order>
			</actions>
		</library>
	</interrupts>
</aiscript>
