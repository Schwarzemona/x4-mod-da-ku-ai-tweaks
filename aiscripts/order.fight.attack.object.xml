<?xml version="1.0" encoding="utf-8" ?>
<diff>
<!-- add. purpose: data store
	<params>
-->
	<add sel="//params">
		<param name="kAAITParam_isActive" required="false" default="false" type="internal" />
		<param name="kAAITParam_isAttackOrder" required="false" default="true" type="internal" />
		<param name="kAAITParam_isAutoAdded" required="false" default="false" type="internal" />
		<param name="kAAITParam_data" required="false" default="null" type="internal" />
		<param name="kAAITParam_isAvoidHighRisk" required="false" type="bool" text="{1111920, 3}" default="
			if this.assignedcontrolled.$kAAIT_isAvoidHighRisk_user? then 
				this.assignedcontrolled.$kAAIT_isAvoidHighRisk_user
			else (
				if (not this.assignedcontrolled.isunit) and (not this.assignedcontrolled.islasertower) and
				(
					(
						this.assignedcontrolled.isplayerowned and
						this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m] and
						@global.$kAAIT_Config.$xssm_isAvoidHighRisk
					) or
					(
						(not this.assignedcontrolled.isplayerowned) and
						this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m] and
						@global.$kAAIT_Config.$xssm_isAvoidHighRisk_allFactions
					) or
					(
						this.assignedcontrolled.isplayerowned and
						this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
						($primarytarget.isclass.ship or @$primarytarget.defensible.isclass.ship) and
						@global.$kAAIT_Config.$lxl_isAvoidHighRisk_vShip
					) or
					(
						this.assignedcontrolled.isplayerowned and
						this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
						($primarytarget.isclass.station or @$primarytarget.defensible.isclass.station) and
						@global.$kAAIT_Config.$lxl_isAvoidHighRisk_vStation
					) or
					(
						(not this.assignedcontrolled.isplayerowned) and
						this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
						($primarytarget.isclass.ship or @$primarytarget.defensible.isclass.ship) and
						@global.$kAAIT_Config.$lxl_isAvoidHighRisk_vShip_allFactions
					) or
					(
						(not this.assignedcontrolled.isplayerowned) and
						this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
						($primarytarget.isclass.station or @$primarytarget.defensible.isclass.station) and
						@global.$kAAIT_Config.$lxl_isAvoidHighRisk_vStation_allFactions
					)
				) then true else false
			)
		" />
		<param name="kAAITParam_isStepForwardWithdraw" required="false" type="bool" text="{1111920, 109}" default="
			if (not this.assignedcontrolled.isunit) and (not this.assignedcontrolled.islasertower) and
			(
				(
					this.assignedcontrolled.isplayerowned and
					this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
					(
						($primarytarget.isclass.ship or @$primarytarget.defensible.isclass.ship) and
						(
							@global.$kAAIT_Config.$lxl_isStepForward_vShip or
							@global.$kAAIT_Config.$lxl_isMoveOutOfRange_vShip
						)
					) or
					(
						($primarytarget.isclass.station or @$primarytarget.defensible.isclass.station) and
						(
							@global.$kAAIT_Config.$lxl_isStepForward_vStation or
							@global.$kAAIT_Config.$lxl_isMoveOutOfRange_vStation
						)
					)
				) or
				(
					(not this.assignedcontrolled.isplayerowned) and
					this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
					(
						($primarytarget.isclass.ship or @$primarytarget.defensible.isclass.ship) and
						(
							@global.$kAAIT_Config.$lxl_isStepForward_vShip_allFactions or
							@global.$kAAIT_Config.$lxl_isMoveOutOfRange_vShip_allFactions
						)
					) or
					(
						($primarytarget.isclass.station or @$primarytarget.defensible.isclass.station) and
						(
							@global.$kAAIT_Config.$lxl_isStepForward_vStation_allFactions or
							@global.$kAAIT_Config.$lxl_isMoveOutOfRange_vStation_allFactions
						)
					)
				)
			) then true else false
		" />
	</add>
<!-- add before. purpose: show movement.
	<location condition="$primarytarget.canbeattacked" object="$primarytarget" additionalobjects="$secondarytargets"/>
-->
	<add pos="before" sel="//location[@condition=&quot;$primarytarget.canbeattacked&quot;][@object=&quot;$primarytarget&quot;][@additionalobjects=&quot;$secondarytargets&quot;]">
		<location object="@$kAAITParam_data.$orderLocation_space" position="@$kAAITParam_data.$orderLocation_pos" condition="@$kAAITParam_data.$orderLocation_space and @$kAAITParam_data.$orderLocation_pos" />
		<location object="@$target" condition="@$target.canbeattacked" />
	</add>
<!-- add after. purpose: keep track of attackers
	<label name="fight"/>
-->
	<add pos="after" sel="//label[@name=&quot;fight&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' fight, $primarytarget: ' + @$primarytarget + ' (' + @$primarytarget.class + '), $secondarytargets: ' + @$secondarytargets" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<debug_text text="this.assignedcontrolled.idcode + ' $kAAITParam_isActive (1): ' + @$kAAITParam_isActive + ', $kAAITParam_data: ' + @$kAAITParam_data" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<debug_text text="this.assignedcontrolled.idcode + ' $kAAITParam_isAvoidHighRisk (1): ' + @$kAAITParam_isAvoidHighRisk + ', $kAAITParam_isStepForwardWithdraw: ' + @$kAAITParam_isStepForwardWithdraw" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<do_if value="
			@$kAAITParam_isAvoidHighRisk or
			@$kAAITParam_isStepForwardWithdraw
		">
			<include_interrupt_actions ref="kAAIT_Init" />
			<debug_text text="this.assignedcontrolled.idcode + ' $kAAITParam_isActive (2): ' + @$kAAITParam_isActive + ', $kAAITParam_data: ' + @$kAAITParam_data" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		</do_if>
		<do_if value="@$kAAITParam_isAvoidHighRisk">
			<include_interrupt_actions ref="kAAIT_AddAttackerToTarget" />
		</do_if>
	</add>
<!-- add before. purpose: first move to target
	this initiates the move.kuertee.engage.position (the stop kamikaze) order, if required
	<do_if value="this.assignedcontrolled.bboxdistanceto.{$target} gt $pursuedistance">
-->
	<add pos="before" sel="//do_if[@value=&quot;this.assignedcontrolled.bboxdistanceto.{$target} gt $pursuedistance&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' $kAAITParam_isAvoidHighRisk (2): ' + @$kAAITParam_isAvoidHighRisk + ', $kAAITParam_isStepForwardWithdraw: ' + @$kAAITParam_isStepForwardWithdraw" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<debug_text text="this.assignedcontrolled.idcode + ' bboxdistanceto ' + @this.assignedcontrolled.bboxdistanceto.{$target} + ' $pursuedistance: ' + $pursuedistance" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<do_if value="@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw">
			<include_interrupt_actions ref="kAAIT_XSSM_AttackOrNot" />
		</do_if>
	</add>
<!-- add. purpose: pass data to DefensibleScript.
	<run_script name="$DefensibleScript">
-->
	<add pos="before" sel="//run_script[@name=&quot;$DefensibleScript&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' this.assignedcontrolled.$kAAIT_isAvoidHighRisk_user: ' + @this.assignedcontrolled.$kAAIT_isAvoidHighRisk_user" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<debug_text text="this.assignedcontrolled.idcode + ' $kAAITParam_isAvoidHighRisk: ' + @$kAAITParam_isAvoidHighRisk" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<debug_text text="this.assignedcontrolled.idcode + ' run_script ' + $DefensibleScript" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
	</add>
	<add sel="//run_script[@name=&quot;$DefensibleScript&quot;]">
		<param name="kAAITParam_isAutoAdded" value="true" />
		<param name="kAAITParam_data" value="@$kAAITParam_data" />
		<param name="kAAITParam_isAvoidHighRisk" value="if this.assignedcontrolled.$kAAIT_isAvoidHighRisk_user? then this.assignedcontrolled.$kAAIT_isAvoidHighRisk_user else @$kAAITParam_isAvoidHighRisk" />
		<param name="kAAITParam_isStepForwardWithdraw" value="@$kAAITParam_isStepForwardWithdraw" />
	</add>
<!-- add after. purpose: if new attack order, flee or move away, finish this order.
	and create a replacement order with the same params.
	note that this will only occur in low attention AIs.
	high attention AIs do not exit their attack behaviour loop.
	if this order is not recreated, they'll lose their attack order.
	<run_script name="$DefensibleScript">
-->
	<add pos="after" sel="//run_script[@name=&quot;$DefensibleScript&quot;]">
		<do_if value="@$kAAITParam_isAvoidHighRisk">
			<do_if value="
				this.assignedcontrolled.attention lt attention.visible and
				(
					@$kAAITParam_data.$orders.$attackOther.exists
					or
					@$kAAITParam_data.$orders.$stayAway.exists
					or
					@$kAAITParam_data.$orders.$flee.exists
				)
			">
				<!-- recreate the order if in low attention and an AAIT order is active -->
				<!-- otherwise, in low attention, the ship will lose this attack order -->
				<set_value name="$speak" exact="false" />
				<create_order object="this.assignedcontrolled" id="'Attack'">
					<param name="primarytarget" value="$primarytarget" />
					<param name="secondarytargets" value="$secondarytargets" />
					<param name="escort" value="$escort" />
					<param name="pursuedistance" value="$pursuedistance" />
					<param name="pursuetargets" value="$pursuetargets" />
					<param name="allowothertargets" value="$allowothertargets" />
					<param name="checkrelation" value="$checkrelation" />
					<param name="disable" value="$disable" />
					<param name="disablehullpercentagethreshold" value="$disablehullpercentagethreshold" />
					<param name="disabletargets" value="$disabletargets" />
					<param name="minrange" value="$minrange" />
					<param name="maxrange" value="$maxrange" />
					<param name="maintaindistance" value="$maintaindistance" />
					<param name="squad_attack" value="$squad_attack" />
					<param name="boardingbehavior" value="$boardingbehavior" />
					<param name="behaviortargetclasses" value="$behaviortargetclasses" />
					<param name="uncover" value="$uncover" />
					<param name="targetclasses" value="$targetclasses" />
					<param name="radius" value="$radius" />
					<param name="radiusanchorpos" value="$radiusanchorpos" />
					<param name="radiusanchorspace" value="$radiusanchorspace" />
					<param name="allowboost" value="$allowboost" />
					<param name="forceprimarytarget" value="$forceprimarytarget" />
					<param name="internalorder" value="$internalorder" />
					<param name="kAAITParam_isAutoAdded" value="$kAAITParam_isAutoAdded" />
					<param name="kAAITParam_data" value="$kAAITParam_data" />
					<param name="kAAITParam_isAvoidHighRisk" value="if this.assignedcontrolled.$kAAIT_isAvoidHighRisk_user? then this.assignedcontrolled.$kAAIT_isAvoidHighRisk_user else @$kAAITParam_isAvoidHighRisk" />
					<param name="kAAITParam_isStepForwardWithdraw" value="@$kAAITParam_isStepForwardWithdraw" />
					<param name="debugchance" value="$debugchance" />
				</create_order>
				<resume label="finish"/>
			</do_if>
		</do_if>
	</add>
<!-- add after. purpose: if this ship withdrew, select new target if primary is station.
	otherwise, the nearest module may not be the ship's target.
	<do_if value="$target.canbeattacked and $pursuetargets">
-->
	<add pos="after" sel="//do_if[@value=&quot;$target.canbeattacked and $pursuetargets&quot;]">
		<do_if value="@$kAAITParam_data.$movedOutOfRangeCount">
			<resume label="selecttarget"/>
		</do_if>
	</add>
<!-- add after. purpose: cleanup.
	<label name="finish" />
-->
	<add pos="after" sel="//label[@name=&quot;finish&quot;]">
		<do_if value="@$kAAITParam_isAvoidHighRisk">
			<include_interrupt_actions ref="kAAIT_RemoveAttackerFromTarget" />
		</do_if>
		<do_elseif value="@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw">
			<debug_text text="this.assignedcontrolled.idcode + ' finish'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		</do_elseif>
	</add>
	<!-- DeadAir Diffs -->
	<replace sel="/aiscript/attention[@min='unknown']/actions/wait[@exact='[((100 - this.assignedcontrolled.combinedskill) / 400)s, 1ms].max']/@exact">[1ms, 2ms].random</replace>
</diff>
