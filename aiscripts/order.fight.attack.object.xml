<?xml version="1.0" encoding="utf-8" ?>
<diff>
<!-- add. purpose: kaait data
	<params>
-->
	<add sel="//params">
		<param name="kAAITParam_iskAAITOrder" required="false" default="false" type="internal" />
		<param name="kAAITParam_isAvoidHighRisk" required="false" type="bool" text="{1111920, 3}" default="
			if this.$kAAIT_isAvoidHighRisk_user? then 
				this.$kAAIT_isAvoidHighRisk_user
			else (
				if (not this.assignedcontrolled.isunit) and (not this.assignedcontrolled.islasertower) and
				(
					(
						this.assignedcontrolled.isplayerowned and
						this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m] and
						@global.$kAAIT_Config.$xssm_isAvoidHighRisk
					) or
					(
						(not this.assignedcontrolled.isplayerowned) and
						this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m] and
						@global.$kAAIT_Config.$xssm_isAvoidHighRisk_allFactions
					) or
					(
						this.assignedcontrolled.isplayerowned and
						this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
						($primarytarget.isclass.ship or @$primarytarget.defensible.isclass.ship) and
						@global.$kAAIT_Config.$lxl_isAvoidHighRisk_vShip
					) or
					(
						this.assignedcontrolled.isplayerowned and
						this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
						($primarytarget.isclass.station or @$primarytarget.defensible.isclass.station) and
						@global.$kAAIT_Config.$lxl_isAvoidHighRisk_vStation
					) or
					(
						(not this.assignedcontrolled.isplayerowned) and
						this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
						($primarytarget.isclass.ship or @$primarytarget.defensible.isclass.ship) and
						@global.$kAAIT_Config.$lxl_isAvoidHighRisk_vShip_allFactions
					) or
					(
						(not this.assignedcontrolled.isplayerowned) and
						this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
						($primarytarget.isclass.station or @$primarytarget.defensible.isclass.station) and
						@global.$kAAIT_Config.$lxl_isAvoidHighRisk_vStation_allFactions
					)
				) then true else false
			)
		" />
		<param name="kAAITParam_isStepForwardWithdraw" required="false" type="bool" text="{1111920, 109}" default="
			if (not this.assignedcontrolled.isunit) and (not this.assignedcontrolled.islasertower) and
			(
				(
					this.assignedcontrolled.isplayerowned and
					this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
					(
						($primarytarget.isclass.ship or @$primarytarget.defensible.isclass.ship) and
						(
							@global.$kAAIT_Config.$lxl_isStepForward_vShip or
							@global.$kAAIT_Config.$lxl_isMoveOutOfRange_vShip
						)
					) or
					(
						($primarytarget.isclass.station or @$primarytarget.defensible.isclass.station) and
						(
							@global.$kAAIT_Config.$lxl_isStepForward_vStation or
							@global.$kAAIT_Config.$lxl_isMoveOutOfRange_vStation
						)
					)
				) or
				(
					(not this.assignedcontrolled.isplayerowned) and
					this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
					(
						($primarytarget.isclass.ship or @$primarytarget.defensible.isclass.ship) and
						(
							@global.$kAAIT_Config.$lxl_isStepForward_vShip_allFactions or
							@global.$kAAIT_Config.$lxl_isMoveOutOfRange_vShip_allFactions
						)
					) or
					(
						($primarytarget.isclass.station or @$primarytarget.defensible.isclass.station) and
						(
							@global.$kAAIT_Config.$lxl_isStepForward_vStation_allFactions or
							@global.$kAAIT_Config.$lxl_isMoveOutOfRange_vStation_allFactions
						)
					)
				)
			) then true else false
		" />
	</add>
<!-- add before. purpose: show movement.
	<location condition="$primarytarget.canbeattacked" object="$primarytarget" additionalobjects="$secondarytargets"/>
-->
	<add pos="before" sel="//location[@condition=&quot;$primarytarget.canbeattacked&quot;][@object=&quot;$primarytarget&quot;][@additionalobjects=&quot;$secondarytargets&quot;]">
		<location object="@this.$kAAIT_data.$orderLocation_space" position="@this.$kAAIT_data.$orderLocation_pos" condition="@this.$kAAIT_data.$orderLocation_space and @this.$kAAIT_data.$orderLocation_pos" />
		<location object="@$target" condition="@$target.canbeattacked" />
	</add>
<!-- replace. purpose: do not cancel attack due to kAAIT_MoveEngagePosition order.
	<check_all>
		<event_object_order_ready object="this.assignedcontrolled.commander" check="false"/>
		<check_value value="event.object.isoperational"/>
		<check_value value="event.param == event.object.order"/>
		<check_any>
			<check_value value="event.param.id != 'Attack'"/>
			<check_value value="event.param.$primarytarget != $primarytarget"/>
-->
	<replace sel="//check_value[@value=&quot;event.param.id != 'Attack'&quot;]">
		<check_all>
			<check_value value="event.param.id != 'Attack'" />
			<check_value value="event.param.id != 'kAAIT_MoveEngagePosition'" />
		</check_all>
	</replace>
	<replace sel="//check_value[@value=&quot;event.param.$primarytarget != $primarytarget&quot;]">
		<check_all>
			<check_value value="event.param.$primarytarget?" />
			<check_value value="@event.param.$primarytarget != $primarytarget" />
		</check_all>
	</replace>
<!-- add after. purpose: keep track of attackers
	<label name="fight"/>
-->
	<add pos="after" sel="//label[@name=&quot;fight&quot;]">
		<do_if value="(@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw) and (not @this.$kAAIT_data.$isIgnoreKAAIT)">
			<debug_text text="this.assignedcontrolled.idcode + ' fight'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			<debug_text text="this.assignedcontrolled.idcode + ' ====='" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			<include_interrupt_actions ref="kAAIT_Init" />
			<remove_value name="this.$kAAIT_data.$orderLocation_space" />
			<remove_value name="this.$kAAIT_data.$orderLocation_pos" />
		</do_if>
	</add>
<!-- add. purpose: send attack command to subordinates immediately.
	address the issue of ships in escort arriving at the target WAAAY ahead of this ship but WITHOUT the attack order.
	<label name="fight"/>
-->
	<add pos="after" sel="//label[@name=&quot;fight&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' @this.$escortgroup.count: ' + @this.$escortgroup.count" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<do_if value="@this.$escortgroup.count">
			<set_value name="$loctarget" exact="$target"/>
			<do_if value="not $loctarget">
				<set_value name="$loctarget" exact="$primarytarget" />
			</do_if>
			<do_if value="$loctarget.defensible">
				<set_value name="$loctarget" exact="$loctarget.defensible"/>
			</do_if>
			<debug_text text="this.assignedcontrolled.idcode + ' @$loctarget: ' + @$loctarget.knownname + ', ' + @$loctarget.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			<do_for_each name="$locsub" in="this.$escortgroup" reverse="true">
				<do_if value="($locsub.assignment == assignment.attack) and not $locsub.subordinategroupdockoverride">
					<debug_text text="'%s %s %s ordering attack subordinate %s %s %s to attack %s %s %s.'.[@this.assignedcontrolled.idcode, @this.assignedcontrolled.knownname, this.assignedcontrolled, @$locsub.idcode, @$locsub.knownname, $locsub, @$loctarget.idcode, @$loctarget.knownname, $loctarget]" chance="$debugchance"/>
					<create_order object="$locsub" id="'Attack'">
						<param name="primarytarget" value="$loctarget"/>
						<param name="secondarytargets" value="@$secondarytargetgroup.list"/>
						<param name="checkrelation" value="$checkrelation"/>
						<param name="escort" value="$escort"/>
						<param name="pursuedistance" value="this.assignedcontrolled.maxradarrange"/>
						<param name="pursuetargets" value="@$pursuetargets"/>
						<param name="disable" value="$disable"/>
						<param name="disablehullpercentagethreshold" value="$disablehullpercentagethreshold"/>
						<param name="disabletargets" value="$disabletargets"/>
						<param name="allowothertargets" value="false"/>
						<param name="squad_attack" value="$squad_attack"/>
						<param name="internalorder" value="true"/>
						<param name="debugchance" value="$debugchance"/>
					</create_order>
					<remove_from_group group="this.$escortgroup" object="$locsub"/>
				</do_if>
			</do_for_each>
			<remove_value name="$loctarget"/>
		</do_if>
	</add>
<!-- add. purpose: pass data to first move to target.
	<run_script name="'move.generic'" result="$movesuccess">
-->
	<add sel="//run_script[@name=&quot;'move.generic'&quot;]">
		<param name="kAAITParam_enemyAvoid" value="if (@this.$kAAIT_data.$isTargetHighRisk or @this.$kAAIT_data.$isTargetPotentialHighRisk) then @this.$kAAIT_data.$defensibleTarget else null" />
		<param name="kAAITParam_isAvoidHighRisk" value="@$kAAITParam_isAvoidHighRisk" />
	</add>
<!-- add. purpose: pass data to DefensibleScript.
	<run_script name="$DefensibleScript">
-->
	<add pos="before" sel="//run_script[@name=&quot;$DefensibleScript&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' this.assignedcontrolled.$kAAIT_isAvoidHighRisk_user: ' + @this.assignedcontrolled.$kAAIT_isAvoidHighRisk_user" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<debug_text text="this.assignedcontrolled.idcode + ' $kAAITParam_isAvoidHighRisk: ' + @$kAAITParam_isAvoidHighRisk" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<debug_text text="this.assignedcontrolled.idcode + ' run_script ' + $DefensibleScript" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
	</add>
	<add sel="//run_script[@name=&quot;$DefensibleScript&quot;]">
		<param name="kAAITParam_isAvoidHighRisk" value="@$kAAITParam_isAvoidHighRisk" />
		<param name="kAAITParam_isStepForwardWithdraw" value="@$kAAITParam_isStepForwardWithdraw" />
	</add>
<!-- add after. purpose: cleanup.
	<label name="finish" />
-->
	<add pos="after" sel="//label[@name=&quot;finish&quot;]">
		<do_if value="@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw">
			<debug_text text="this.assignedcontrolled.idcode + ' finish'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			<debug_text text="this.assignedcontrolled.idcode + ' ======'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			<do_if value="@this.$kAAIT_data">
				<set_value name="this.$kAAIT_data.$isRemoveDataOnFinish" exact="true" />
			</do_if>
			<include_interrupt_actions ref="kAAIT_Deinit" />
		</do_if>
	</add>
<!-- add. purpose: cleanup.
	<on_abort>
-->
	<add sel="//on_abort">
		<include_interrupt_actions ref="kAAIT_Deinit" />
	</add>
	<!-- DeadAir Diffs -->
	<replace sel="/aiscript/attention[@min='unknown']/actions/wait[@exact='[((100 - this.assignedcontrolled.combinedskill) / 400)s, 1ms].max']/@exact">[1ms, 2ms].random</replace>
</diff>
