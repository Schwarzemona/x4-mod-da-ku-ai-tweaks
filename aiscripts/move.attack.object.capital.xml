<?xml version="1.0" encoding="utf-8" ?>
<diff>
<!-- add. purpose: data store
	<params>
-->
	<add sel="//params">
		<param name="kAAITParam_isAvoidHighRisk" required="false" default="null" type="internal" />
		<param name="kAAITParam_isStepForwardWithdraw" required="false" type="internal" text="{1111920, 109}" default="false" />
	</add>
<!-- add before at 3 x move_to and 1 x move_strafe. purpose: debug.
	<move_to>
-->
	<add pos="before" sel="(//move_to)[1]">
		<do_if value="(@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw) and @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isTargetPotentialHighRisk">
			<debug_text text="@this.assignedcontrolled.idcode + ' move_to (1) rotate to aim'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		</do_if>
	</add>
	<add pos="before" sel="(//move_to)[2]">
		<do_if value="(@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw) and @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isTargetPotentialHighRisk">
			<debug_text text="@this.assignedcontrolled.idcode + ' move_to (2) rotate to look away'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		</do_if>
	</add>
	<add pos="before" sel="//move_strafe">
		<do_if value="(@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw) and @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isTargetPotentialHighRisk">
			<debug_text text="@this.assignedcontrolled.idcode + ' move_strafe'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		</do_if>
	</add>
	<add pos="before" sel="(//move_to)[3]">
		<do_if value="(@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw) and @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isTargetPotentialHighRisk">
			<debug_text text="@this.assignedcontrolled.idcode + ' move_to (3) short attack move'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		</do_if>
	</add>
<!-- add. purpose: add handlers.
	<interrupts>
-->
	<add pos="prepend" sel="//interrupts">
		<handler ref="kAAIT_CheckVersion" />
		<handler ref="kAAIT_Handler_AvoidWithdrawOrJustFight" />
		<handler ref="kAAIT_Handler_NewBigTarget" />
		<handler ref="kAAIT_Handler_DebugWithdraw" />
	</add>
<!-- add.
-->
	<add pos="prepend" sel="//interrupts">
		<library>
			<actions name="kAAIT_GetIsMoveToEngage">
				<set_value name="$kAAIT_result_isMovetoEngage" exact="false" />
				<do_if value="
					(
						this.assignedcontrolled.type != shiptype.carrier or
						(
							(
								this.isplayerowned and
								global.$kAAIT_Data.$isCarriersAttackLikeDestroyers
							) or
							(
								(not this.isplayerowned) and
								global.$kAAIT_Data.$isCarriersAttackLikeDestroyers_allFactions
							)
						)
					) and
					(
						@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isTargetHighRisk or
						@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isTargetPotentialHighRisk
					) and
					(not @$primarytarget.travel.active) and
					(not @$target.travel.active)
				">
					<set_value name="$kAAIT_distToTarget" exact="this.assignedcontrolled.bboxdistanceto.{$target}" />
					<include_interrupt_actions ref="KAAIT_GetEngagePosDistance" />
					<set_value name="$kAAIT_engagePosDist" exact="$kAAIT_result_engagePosDist" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsMoveToEngage $target: ' + $target + ' (' + $target.knownname + ' , ' + @$target.hullpercentage + ') $moduleTarget: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$moduleTarget + ' (' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$moduleTarget.knownname + ', ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$moduleTarget.hullpercentage + ')'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsMoveToEngage $defensibleTarget: ' + global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget + ' (' + global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget.knownname + ' , ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget.hullpercentage + ') $defensibleTarget_stoppedKamikaze: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget_stoppedKamikaze + ' (' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget_stoppedKamikaze.knownname + ', ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget_stoppedKamikaze.hullpercentage + ')'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<do_if value="$target.isclass.module and $target != @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$moduleTarget">
						<set_value name="$kAAIT_result_isMovetoEngage" exact="true" />
					</do_if>
					<do_if value="
						(not $kAAIT_result_isMovetoEngage) and
						global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget != @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget_stoppedKamikaze and
						(
							(
								global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget.isclass.station and
								$kAAIT_distToTarget gt $kAAIT_engagePosDist
							) or
							(
								global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget.isclass.ship and
								(not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget.isclass.ship.travel.active) and
								$kAAIT_distToTarget gt $kAAIT_engagePosDist
							)
						)
					">
						<set_value name="$kAAIT_result_isMovetoEngage" exact="true" />
					</do_if>
					<do_if value="(not $kAAIT_result_isMovetoEngage) and $target.isclass.module and $target.defensible.isclass.station">
						<!-- <find_module name="$kAAIT_nearestModule" object="$target.defensible" checkoperational="false" indestructible="true" invulnerable="false" sortbydistanceto="this.assignedcontrolled" multiple="false" /> -->
						<find_module name="$kAAIT_nearestModule" checkoperational="false" object="$target.defensible" />
						<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsMoveToEngage $kAAIT_nearestModule: ' + $kAAIT_nearestModule + ' ' + @$kAAIT_nearestModule.knownname + ' ' + @$kAAIT_nearestModule.idcode" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
						<do_if value="$kAAIT_nearestModule">
							<set_value name="$kAAIT_test_target_isInTheWay" exact="$kAAIT_nearestModule" />
							<set_value name="$kAAIT_test_target_isInTheWayOf" exact="$target" />
							<include_interrupt_actions ref="kAAIT_GetIsInTheWay" />
							<remove_value name="$kAAIT_test_target_isInTheWay" />
							<remove_value name="$kAAIT_test_target_isInTheWayOf" />
							<set_value name="$kAAIT_result_isMovetoEngage" exact="$kAAIT_result_isTargetInTheWay" />
						</do_if>
					</do_if>
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsMoveToEngage $kAAIT_result_isMovetoEngage: ' + $kAAIT_result_isMovetoEngage" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			</actions>
			<actions name="kAAIT_GetIsStepForward">
				<set_value name="$kAAIT_result_isStepForward" exact="false" />
				<set_value name="$time_nextStepForward" exact="1min" />
				<do_if value="$target.isclass.ship">
					<set_value name="$time_nextStepForward" exact="10s" />
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' $target.iscapitalship: ' + @$target.iscapitalship" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $target.isclass.station: ' + $target.isclass.station + ' $target.defensible.isclass.station: ' + $target.defensible.isclass.station" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $time_nextStepForward: ' + $time_nextStepForward" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $time_lastStepForward: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$time_lastStepForward" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<debug_text text="@this.assignedcontrolled.idcode + ' gt $time_nextStepForward: ' + (player.age - @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$time_lastStepForward gt $time_nextStepForward)" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<do_if value="
					(
						@$target.iscapitalship or
						$target.isclass.station or
						$target.defensible.isclass.station
					) and
					player.age - @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$time_lastStepForward gt $time_nextStepForward
				">
					<!-- <set_value name="$kAAIT_distToTarget" exact="this.assignedcontrolled.bboxdistanceto.{global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget}" /> -->
					<set_value name="$kAAIT_distToTarget" exact="this.assignedcontrolled.bboxdistanceto.{$target}" />
					<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_distToTarget: ' + $kAAIT_distToTarget" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<debug_text text="@this.assignedcontrolled.idcode + ' $combatRange_min: ' + global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_min" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<debug_text text="@this.assignedcontrolled.idcode + ' $combatRange_max: ' + global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_max" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<do_if value="$kAAIT_distToTarget gt global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_min">
						<debug_text text="@this.assignedcontrolled.idcode + ' type: ' + this.assignedcontrolled.type" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
						<do_if value="
							this.assignedcontrolled.type != shiptype.carrier or
							(
								(
									this.isplayerowned and
									global.$kAAIT_Data.$isCarriersAttackLikeDestroyers
								) or
								(
									(not this.isplayerowned) and
									global.$kAAIT_Data.$isCarriersAttackLikeDestroyers_allFactions
								)
							)
						">
							<set_value name="$kAAIT_result_isStepForward" exact="true" />
						</do_if>
					</do_if>
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsStepForward $kAAIT_result_isStepForward: ' + $kAAIT_result_isStepForward" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			</actions>
		</library>
	</add>
<!-- add prepend. purpose: init var.
	<init>
-->
	<add pos="prepend" sel="//init">
		<debug_text text="@this.assignedcontrolled.idcode + ' EVENT init'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
	</add>
<!-- add prepend. purpose: init.
	<attention min="unknown">
-->
	<add pos="prepend" sel="//attention[@min=&quot;unknown&quot;]/actions">
		<label name="kAAIT_label_start" />
		<include_interrupt_actions ref="kAAIT_InitAttackScript" />
	</add>
<!--
	=========================================
	prevent carriers from getting into danger
	=========================================
	replace 2 instances.
	purpose: $iscarrier behaviour is true if shiptype.carrier AND has subordinates or has a wingmate that is a capital ship.
	i.e. base-game implementation sets iscarrier to true ONLY if subordinates are dockable on the carrier.
	therefore: base-game implementation will put carrier in danger even if its subordinates are captial ships that do not dock on the carrier.
	kuda's implementation makes it so that carriers never attack like destroyers UNLESS it has no more subordinates or it has no capital ship wingmate.
	1st instance:
	<set_value name="$iscarrier" exact="false"/>
	<do_if value="this.assignedcontrolled.type == shiptype.carrier">
		<do_for_each name="$locsub" in="this.assignedcontrolled.subordinates">
			...
-->
	<replace sel="//set_value[@name=&quot;$iscarrier&quot;][@exact=&quot;false&quot;]/following-sibling::do_if[@value=&quot;this.assignedcontrolled.type == shiptype.carrier&quot;]/do_for_each[@name=&quot;$locsub&quot;][@in=&quot;this.assignedcontrolled.subordinates&quot;]">
		<set_value name="$iscarrier" exact="this.assignedcontrolled.subordinates.count" />
		<do_if value="(not $iscarrier) and @this.assignedcontrolled.commander.subordinates.count">
			<do_for_each name="$wingmate" in="this.assignedcontrolled.commander.subordinates">
				<do_if value="@$wingmate.iscapitalship">
					<set_value name="$iscarrier" exact="true" />
					<break />
				</do_if>
			</do_for_each>
		</do_if>
	</replace>
<!--
	=========================================
	prevent carriers from getting into danger
	=========================================
	2nd instance:
	remove:
	<do_if value="$iscarrier">
		<set_value name="$iscarrier" exact="false"/>
		<do_for_each name="$locsub" in="this.assignedcontrolled.subordinates">
	replace:
	<do_if value="$iscarrier">
		<set_value name="$iscarrier" exact="false"/>
-->
	<remove sel="//do_if[@value=&quot;$iscarrier&quot;]/set_value[@name=&quot;$iscarrier&quot;][@exact=&quot;false&quot;]/following-sibling::do_for_each[@name=&quot;$locsub&quot;][@in=&quot;this.assignedcontrolled.subordinates&quot;]" />
	<replace sel="//do_if[@value=&quot;$iscarrier&quot;]/set_value[@name=&quot;$iscarrier&quot;][@exact=&quot;false&quot;]">
		<set_value name="$iscarrier" exact="this.assignedcontrolled.subordinates.count" />
		<do_if value="(not $iscarrier) and @this.assignedcontrolled.commander.subordinates.count">
			<do_for_each name="$wingmate" in="this.assignedcontrolled.commander.subordinates">
				<do_if value="@$wingmate.iscapitalship">
					<set_value name="$iscarrier" exact="true" />
					<break />
				</do_if>
			</do_for_each>
		</do_if>
	</replace>
<!--
	=========================================
	prevent carriers from getting into danger
	=========================================
	add before. purpose: change $maintaindistance
	<do_if value="$iscarrier and $maintaindistance">
-->
	<add pos="before" sel="//do_if[@value=&quot;$iscarrier and $maintaindistance&quot;]">
		<do_if value="$iscarrier">
			<do_if value="
				(this.isplayerowned and @global.$kAAIT_Data.$isCarriersAttackLikeDestroyers) or
				((not this.isplayerowned) and @global.$kAAIT_Data.$isCarriersAttackLikeDestroyers_allFactions)
			">
				<do_if value="@this.assignedcontrolled.isoperational and @global.$kAAIT_Data.$debugChance and @this.assignedcontrolled.order.script == 'order.fight.attack.object'">
					<debug_text text="@this.assignedcontrolled.idcode + ' set_object_name kAAIT'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
					<set_object_name object="this.assignedcontrolled" name="$kAAIT_original_name + ' - kAAIT attack'" />
				</do_if>
				<set_value name="$maintaindistance" exact="false" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $maintaindistance: ' + $maintaindistance" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			</do_if>
		</do_if>
	</add>
<!-- add before. purpose: custom behaviours.
	<label name="fight" />
-->
	<add pos="before" sel="//label[@name=&quot;fight&quot;]">
		<resume label="fight" />

		<label name="kAAIT_label_move_to_engage_position" />
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL kAAIT_label_move_to_engage_position'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		<include_interrupt_actions ref="KAAIT_GetEngagePosDistance" />
		<set_value name="$kAAIT_engagePosDist" exact="$kAAIT_result_engagePosDist" />
		<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid" exact="$target" />
		<include_interrupt_actions ref="kAAIT_Order_MoveToEngagePosition" />
		<wait min="1s" max="3s" comment="stop this order from continuing as the new order is created" />
		<resume label="fight" comment="in case the new order fails, do this" />

		<label name="kAAIT_label_step_forward" />
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL kAAIT_label_step_forward'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		<include_interrupt_actions ref="kAAIT_GetIsMoveToEngage" />
		<do_if value="$kAAIT_result_isMovetoEngage">
			<resume label="kAAIT_label_move_to_engage_position" />
		</do_if>
		<do_else>
			<create_order object="this.assignedcontrolled" id="'kAAIT_MoveStepForward'" immediate="true">
				<param name="target" value="$target" />
			</create_order>
			<wait min="1s" max="3s" comment="stop this order from continuing as the new order is created" />
		</do_else>
		<resume label="fight" comment="in case the new order fails, do this" />

		<label name="kAAIT_label_avoid" />
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL kAAIT_label_avoid'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		<include_interrupt_actions ref="kAAIT_Order_Avoid" />
		<wait min="1s" max="3s" comment="stop this order from continuing as the new order is created" />
		<resume label="fight" comment="in case the new order fails, do this" />
	</add>
<!-- add after. purpose: determine custom behaviours.
	<label name="fight" />
-->
	<add pos="after" sel="//label[@name=&quot;fight&quot;]">
		<do_if value="@this.assignedcontrolled.isoperational">
			<do_if value="$kAAIT_original_name? and @$kAAIT_original_name and (this.assignedcontrolled.knownname != @$kAAIT_original_name) and (not @this.assignedcontrolled.coverowner)">
				<debug_text text="'MOD: KUDA -- %s(%s) -- set_object_name reset to %s.'.[@this.assignedcontrolled.knownname,@this.assignedcontrolled.idcode,$kAAIT_original_name]" />
				<set_object_name object="this.assignedcontrolled" name="$kAAIT_original_name" />
			</do_if>
		</do_if>
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL fight'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		<do_if value="not @$target.exists">
			<!--
				bug to fix: $pursuetargets is ignored.
				search for 'bug to fix: $pursuetargets' to find related code for the fix.
			-->
			<!-- <debug_text text="@this.assignedcontrolled.idcode + ' $target.exists (disengaged?): ' + @$target.exists" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" /> -->
			<debug_text text="@this.assignedcontrolled.idcode + ' $target.exists (disengaged?): ' + @$target.exists" />
			<resume label="finish" />
		</do_if>
		<do_if value="@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw">
			<set_value name="$kAAIT_test_target_isAvoid" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget" />
			<include_interrupt_actions ref="kAAIT_GetAvoidOrNot" />
			<do_if value="@$kAAIT_result_avoidEnemy.isoperational and @$kAAITParam_isAvoidHighRisk">
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid" exact="$kAAIT_result_avoidEnemy" />
				<resume label="kAAIT_label_avoid" />
			</do_if>
			<do_elseif value="@$kAAIT_result_withdrawFromEnemy.isoperational and @$kAAITParam_isStepForwardWithdraw">
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid" exact="$kAAIT_result_withdrawFromEnemy" />
				<resume label="kAAIT_label_withdraw" />
			</do_elseif>
		</do_if>
		<do_if value="@$kAAITParam_isStepForwardWithdraw">
			<include_interrupt_actions ref="kAAIT_GetIsMoveToEngage" />
			<do_if value="$kAAIT_result_isMovetoEngage">
				<resume label="kAAIT_label_move_to_engage_position" />
			</do_if>
		</do_if>
	</add>
<!-- add before. purpose: force frontweapon on all kuda-enabled ships for debugging
	<do_if value="$frontweapon?">
-->
	<!-- <add pos="before" sel="//do_if[@value=&quot;$frontweapon?&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' $frontweapon: ' + @$frontweapon" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		<do_if value="@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw">
			<set_value name="$frontweapon" exact="true" />
			<debug_text text="@this.assignedcontrolled.idcode + ' $frontweapon (kuda, forced): ' + @$frontweapon" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		</do_if>
	</add> -->
<!--
	in kuda ...
	1. poor-skilled captains are more reckless and attack from a nearer distance to the target
	2. better-skilled captains are more cautious and attack from 90% max combat range
	3. aimdist = max combat range * (skill-based dist mult from target + number of withdraws). the more withdraws, the further.
	4. min move threshold is min combat range and doesn't include aimdist component like in base-game attacks
	5. max move threshold is max combat range
-->
<!--
	override aim distance based on engage pos distance
	<set_value name="$movethreshold_min" exact="[$maxeffectivecombatrange * 0.5, $aimdist - 1m].min"/>
-->
	<add pos="before" sel="//set_value[@name=&quot;$movethreshold_min&quot;]">
		<do_if value="@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw">
			<do_if value="(not @$kAAIT_result_engagePosDist) or (not @$kAAIT_targetCentreToEdgeDist)">
				<include_interrupt_actions ref="KAAIT_GetEngagePosDistance" />
			</do_if>
			<set_value name="$aimdist" exact="$kAAIT_result_engagePosDist - $kAAIT_targetCentreToEdgeDist"
				comment="remove the target's size component as the attack pos is the ship's bboxdistance to the target + aimdistance.
				i.e. the target's size component, the ship's bboxdistance to the target, will be added aimdist when calculating attack pos" />
			<debug_text text="@this.assignedcontrolled.idcode + ' $aimdist: ' + $aimdist" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		</do_if>
	</add>
<!-- add after. purpose: hijack effective range and move thresholds to limit the ship's movements to step forward or withdraw behaviours.
	<do_if value="$frontweapon?">
		<set_value name="$movethreshold_max" exact="$maxeffectivecombatrange"/>
-->
	<add pos="after" sel="//do_if[@value=&quot;$frontweapon?&quot;]//set_value[@name=&quot;$movethreshold_max&quot;][@exact=&quot;$maxeffectivecombatrange&quot;]">
		<set_value name="$movethreshold_min_orig" exact="$movethreshold_min"/>
		<set_value name="$movethreshold_max_orig" exact="$movethreshold_max"/>
		<debug_text text="@this.assignedcontrolled.idcode + ' $kAAITParam_isAvoidHighRisk: ' + @$kAAITParam_isAvoidHighRisk" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		<debug_text text="@this.assignedcontrolled.idcode + ' $kAAITParam_isStepForwardWithdraw: ' + @$kAAITParam_isStepForwardWithdraw" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		<do_if value="@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw">
			<do_if value="@this.assignedcontrolled.isoperational and @global.$kAAIT_Data.$debugChance and @this.assignedcontrolled.order.script == 'order.fight.attack.object'">
				<debug_text text="@this.assignedcontrolled.idcode + ' set_object_name kAAIT'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
				<set_object_name object="this.assignedcontrolled" name="$kAAIT_original_name + ' - kAAIT attack'" />
			</do_if>
			<set_value name="$movethreshold_min" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_min"/>
			<set_value name="$movethreshold_max" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_max"/>
		</do_if>
	</add>
<!-- debug
	3rd occurence of:
	<set_value name="$distance" exact="this.assignedcontrolled.bboxdistanceto.[$target.sector, $targetposition] - ($target.size/2m)"/>
-->
	<add pos="after" sel="(//set_value[@name=&quot;$distance&quot;][@exact=&quot;this.assignedcontrolled.bboxdistanceto.[$target.sector, $targetposition] - ($target.size/2m)&quot;])[3]">
		<debug_text text="@this.assignedcontrolled.idcode + ' $distance: ' + $distance" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		<do_if value="$target.isclass.module">
			<set_value name="$kAAIT_distToTarget" exact="this.assignedcontrolled.bboxdistanceto.{$target}" />
			<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_distToTarget: ' + $kAAIT_distToTarget" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		</do_if>
	</add>
<!-- add prepend. purpose: debug.
	<do_if value="$frontweapon?" >
		<do_if value="$distance gt $movethreshold_max or $distance lt $movethreshold_min">
-->
	<add pos="before" sel="//do_if[@value=&quot;$frontweapon?&quot;]//do_if[@value=&quot;$distance gt $movethreshold_max or $distance lt $movethreshold_min&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' $movethreshold_min_orig: ' + $movethreshold_min_orig + ' $movethreshold_min: ' + $movethreshold_min" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		<debug_text text="@this.assignedcontrolled.idcode + ' $distance: ' + $distance" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		<debug_text text="@this.assignedcontrolled.idcode + ' $movethreshold_max_orig: ' + $movethreshold_max_orig + ' $movethreshold_max: ' + $movethreshold_max" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
	</add>
	<add pos="prepend" sel="//do_if[@value=&quot;$frontweapon?&quot;]//do_if[@value=&quot;$distance gt $movethreshold_max or $distance lt $movethreshold_min&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' OUT OF MOVE THRESHOLDS'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
	</add>
	<add pos="prepend" sel="//do_if[@value=&quot;$frontweapon?&quot;]//do_elseif[@value=&quot;$distance le $movethreshold_max and $distance ge $movethreshold_min&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' WITHIN MOVE THRESHOLDS'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
	</add>
<!--
	purpose:
	==========================================================================
	do not change module target if previous module target is still operational
	==========================================================================
	search for $targetSelection_primaryTarget or $targetSelection_closestModule

	<do_if value="$frontweapon?" >
		...
		<do_elseif value="$distance le $movethreshold_max and $distance ge $movethreshold_min" >
			...
			<do_for_each name="$locmodule" in="$locmodules" counter="$i">
-->
	<add pos="before" sel="//do_if[@value=&quot;$frontweapon?&quot;]//do_for_each[@name=&quot;$locmodule&quot;][@in=&quot;$locmodules&quot;][@counter=&quot;$i&quot;]">
		<set_value name="$kAAIT_changeTargetChance" exact="100" />
		<do_if value="@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw">
			<do_if value="$target.isoperational">
				<set_value name="$kAAIT_changeTargetChance" exact="0" />
			</do_if>
		</do_if>
		<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_changeTargetChance: ' + $kAAIT_changeTargetChance" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
	</add>
	<add sel="//do_if[@value=&quot;$frontweapon?&quot;]//do_for_each[@name=&quot;$locmodule&quot;][@in=&quot;$locmodules&quot;][@counter=&quot;$i&quot;]" type="@chance">$kAAIT_changeTargetChance</add>
<!-- add before. purspoe: step forward after wait.
	<do_if value="$frontweapon?" >
		<wait exact="$updatetime">
-->
	<add pos="after" sel="//do_if[@value=&quot;$frontweapon?&quot;]//wait[@exact=&quot;$updatetime&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' WAIT COMPLETE'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		<do_if value="@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw">
			<do_if value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$withdrawCount gt 0">
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$withdrawCount" operation="subtract" exact="1" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $attackData.$withdrawCount: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$withdrawCount" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			</do_if>
		</do_if>
		<do_if value="@$kAAITParam_isStepForwardWithdraw and @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isTargetHighRisk">
			<include_interrupt_actions ref="kAAIT_GetIsStepForward" />
			<do_if value="$kAAIT_result_isStepForward">
				<resume label="kAAIT_label_step_forward" />
			</do_if>
		</do_if>
	</add>
<!-- add before. purpose: debug.
	<do_else>
		<set_value name="$case" exact="'1.1.3: cap v cap, front-mounted, retreat'"/>
-->
	<!-- <add pos="before" sel="//set_value[@name=&quot;$case&quot;][@exact=&quot;'1.1.3: cap v cap, front-mounted, retreat'&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' TOO NEAR TARGET'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
	</add> -->
<!-- add after. purpose: debug.
	<do_if value="this.ship.bboxdistanceto.{$target} ge $minoperationalrange and this.ship.bboxdistanceto.{$target} le $maxoperationalrange">
-->
	<add pos="before" sel="//do_if[@value=&quot;this.ship.bboxdistanceto.{$target} ge $minoperationalrange and this.ship.bboxdistanceto.{$target} le $maxoperationalrange&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' this.assignedcontrolled.bboxdistanceto.{$target}: ' + this.assignedcontrolled.bboxdistanceto.{$target}" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		<debug_text text="@this.assignedcontrolled.idcode + ' $minoperationalrange: ' + $minoperationalrange" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		<debug_text text="@this.assignedcontrolled.idcode + ' $maxoperationalrange: ' + $maxoperationalrange" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
	</add>
<!-- add before. purpose: debug.
	<remove_value name="$tempoffset"/>
-->
	<add pos="before" sel="//remove_value[@name=&quot;$tempoffset&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' this.assignedcontrolled.bboxdistanceto.[$target, $tempoffset]: ' + this.assignedcontrolled.bboxdistanceto.[$target, $tempoffset]" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		<debug_text text="@this.assignedcontrolled.idcode + ' this.assignedcontrolled.bboxdistanceto.[$target.sector, $pos]: ' + this.assignedcontrolled.bboxdistanceto.[$target.sector, $pos]" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
	</add>
<!-- add before. purpose: if primarypurpose != fight, stay away from target
	<do_if value="this.assignedcontrolled.sector == $target.sector">
		...
		<do_if value="$strafe?">
-->
	<add pos="before" sel="//do_if[@value=&quot;this.assignedcontrolled.sector == $target.sector&quot;]/do_if[@value=&quot;$strafe?&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' $case: ' + $case" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		<debug_text text="@this.assignedcontrolled.idcode + ' this.assignedcontrolled.bboxdistanceto.[$target, $pos]: ' + this.assignedcontrolled.bboxdistanceto.[$target, $pos]" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
	</add>
<!-- disable move_strafe and move_to.
	kuda controls these movements with move to engage, step forward, and withdraw
	<move_strafe destination="$target" abortpath="not @$abortpath" object="this.assignedcontrolled" finishonapproach="false" forcerotation="true" sinceversion="10">
	<move_to destination="$target" abortpath="not @$noabortpath" object="this.assignedcontrolled" finishonapproach="false" forceposition="false" forcerotation="false" uselocalhighways="false" boost="@$boost" travel="@$travel">
-->
	<add pos="before" sel="//do_if[@value=&quot;this.assignedcontrolled.sector == $target.sector&quot;]/do_if[@value=&quot;$strafe?&quot;]">
		<set_value name="$kAAIT_vanillaAttackMoveChance" exact="100" />
		<do_if value="$kAAITParam_isAvoidHighRisk or $kAAITParam_isStepForwardWithdraw">
			<include_interrupt_actions ref="kAAIT_SaveBigEnemiesToData" />
			<do_if value="$target.isclass.station or @$target.defensible.isclass.station or global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$bigEnemies.count gt 1">
				<!-- there's more than one big enemy nearby, do not do any vanilla moves -->
				<set_value name="$kAAIT_vanillaAttackMoveChance" exact="0" />
			</do_if>
		</do_if>
		<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_vanillaAttackMoveChance: ' + $kAAIT_vanillaAttackMoveChance" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
	</add>
	<add sel="//do_if[@value=&quot;this.assignedcontrolled.sector == $target.sector&quot;]//move_strafe[@destination=&quot;$target&quot;]" type="@chance">$kAAIT_vanillaAttackMoveChance</add>
	<add sel="//do_if[@value=&quot;this.assignedcontrolled.sector == $target.sector&quot;]//move_to[@destination=&quot;$target&quot;]" type="@chance">$kAAIT_vanillaAttackMoveChance</add>
<!-- add after. purpose: step_forward after attack run.
	<do_if value="this.assignedcontrolled.sector == $target.sector">
		...
		<remove_value name="this.$capshipattack_pos"/>
-->
	<add pos="before" sel="//do_if[@value=&quot;this.assignedcontrolled.sector == $target.sector&quot;]/remove_value[@name=&quot;this.$capshipattack_pos&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' ATTACK CYCLE COMPLETE'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		<do_if value="@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw">
			<do_if value="@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$withdrawCount gt 0">
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$withdrawCount" operation="subtract" exact="1" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $attackData.$withdrawCount: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$withdrawCount" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			</do_if>
		</do_if>
		<do_if value="@$kAAITParam_isStepForwardWithdraw and @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isTargetHighRisk">
			<debug_text text="@this.assignedcontrolled.idcode + ' $target: ' + $target.knownname + ' ' + @$target.idcode + ' isoperational: ' + $target.isoperational" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
			<do_if value="not $target.isoperational">
				<resume label="finish" />
			</do_if>
			<do_else>
				<include_interrupt_actions ref="kAAIT_GetIsStepForward" />
				<do_if value="$kAAIT_result_isStepForward">
					<resume label="kAAIT_label_step_forward" />
				</do_if>
			</do_else>
		</do_if>
	</add>
<!-- add before. purpose: withdraw.
	<label name="finish"/>
-->
	<add pos="before" sel="//label[@name=&quot;finish&quot;]">
		<resume label="finish"/>

		<label name="kAAIT_label_withdraw" />
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL kAAIT_label_withdraw'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		<do_if value="(not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget.isoperational) and $kAAIT_attacker.isoperational">
			<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid" exact="$kAAIT_attacker" />
		</do_if>
		<do_else>
			<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget" />
		</do_else>
		<include_interrupt_actions ref="kAAIT_Order_Withdraw" />
		<wait min="1s" max="3s" comment="stop this order from continuing as the new order is created" />
		<resume label="finish" comment="in case the new order fails, do this" />
	</add>
<!-- add after finish. purpose: clean-up.
	<label name="finish" />
-->
	<add pos="after" sel="//label[@name=&quot;finish&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL finish'" chance="if @$debugchance then $debugchance else (if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or (@global.$kAAIT.$debugChance_idCode == 'all' and (@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw or @$kAAITParam_iskAAITOrder)) then @global.$kAAIT_Data.$debugChance else 0)" />
		<include_interrupt_actions ref="kAAIT_DeinitAttackScript" />
	</add>
	<!--
		   db    88""Yb  dP"Yb  88""Yb 888888
		  dPYb   88__dP dP   Yb 88__dP   88
		 dP__Yb  88""Yb Yb   dP 88"Yb    88
		dP""""Yb 88oodP  YbodP  88  Yb   88
	 -->
<!-- add after. purpose: cleanup.
	<attention min="unknown">
-->
	<add pos="after" sel="//attention[@min=&quot;unknown&quot;]">
		<on_abort>
			<do_if value="@this.assignedcontrolled.isoperational">
				<do_if value="$kAAIT_original_name? and @$kAAIT_original_name and (this.assignedcontrolled.knownname != @$kAAIT_original_name) and (not @this.assignedcontrolled.coverowner)">
					<debug_text text="'MOD: KUDA -- %s(%s) -- set_object_name reset to %s.'.[@this.assignedcontrolled.knownname,@this.assignedcontrolled.idcode,$kAAIT_original_name]" />
					<set_object_name object="this.assignedcontrolled" name="$kAAIT_original_name" />
				</do_if>
			</do_if>
			<!-- <include_interrupt_actions ref="kAAIT_RemoveAttackerFromTarget" /> -->
			<do_if value="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_space?">
				<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_space" />
				<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_pos" />
			</do_if>
		</on_abort>
	</add>
	<!-- DEADAIR DIFFS APPLIED AFTER KUERTEE CHANGES -->
	<replace sel="/aiscript/init/do_if[@value='this.isplayerowned']/@value">this.isplayerowned or @global.$DATweaks.$MAOCapital.$RemoveAISkillCheckAlso</replace>
	<replace sel="/aiscript/attention[@min='unknown']/actions/do_if[@value='this.isplayerowned']/@value">this.isplayerowned or @global.$DATweaks.$MAOCapital.$RemoveAISkillCheckAlso</replace>
	<replace sel="/aiscript/attention[@min='unknown']/actions/do_if[@value='not @$frontweapon'][@chance='[$combinedskill + 50, 100].min']/@chance">if @global.$DATweaks.$MAOCapital.$IgnoreVerticalQuadrants then 0 else [$combinedskill + 50, 100].min</replace>
	<add sel="/aiscript/attention[@min='unknown']/actions/set_value[@name='$targetquadranttable'][@exact='table[]']" pos="before">
		<do_if value="@global.$DATweaks.$MAOCapital.$EnemyQuadrantTweak">
			<set_value name="$quadrants" exact="[quadrant.left, quadrant.right, quadrant.up, quadrant.down, quadrant.back, quadrant.front]"/>
			<do_if value="@global.$DATweaks.$MAOCapital.$IgnoreVerticalQuadrants">
				<set_value name="$quadrants" exact="[quadrant.left, quadrant.right, quadrant.back, quadrant.front]"/>
			</do_if>
		</do_if>
	</add>
	<add sel="/aiscript/attention[@min='unknown']/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_if[@value='$distance gt $movethreshold_max or $distance lt $movethreshold_min']/do_if[@value='$distance gt $movethreshold_max']/set_value[@name='$updatetime'][@exact='((this.ship.distanceto.[$target.sector, $pos])f / [this.ship.maxspeed, 1m].max)s + ($locrot.yaw / [this.ship.maxyawspeed, 1].max)s']" pos="before">
		<do_if value="@global.$DATweaks.$MAOCapital.$TravelDriveTweak">
			<set_value name="$DATCheckTravel" exact="true"/>
		</do_if>
	</add>
	<replace sel="/aiscript/attention[@min='unknown']/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_if[@value='$distance gt $movethreshold_max or $distance lt $movethreshold_min']/do_else/set_value[@name='$boost'][@chance='$allowboost * 100']">
		<do_if value="true">
			<set_value name="$DATBoostBan" exact="false"/>
			<do_if value="@global.$DATweaks.$MAOCapital.$PlayerBoostDisabled and this.isplayerowned">
				<set_value name="$DATBoostBan" exact="true"/>
			</do_if>
			<do_elseif value="@global.$DATweaks.$MAOCapital.$AIBoostDisabled and (not this.isplayerowned)">
				<set_value name="$DATBoostBan" exact="true"/>
			</do_elseif>
		</do_if>
	</replace>
	<add sel="/aiscript/attention[@min='unknown']/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_if[@value='$distance gt $movethreshold_max or $distance lt $movethreshold_min']/do_else/set_value[@name='$updatetime'][@exact='(((this.ship.distanceto.[$target.sector, $pos])f / [this.ship.maxspeed, 1m].max)s + (pi / [this.ship.maxyawspeed, 1].max)s) * 5']" pos="before">
		<set_value name="$boost" chance="if @$DATBoostBan then 0 else ($allowboost * 100)"/>
	</add>
	<add sel="/aiscript/attention[@min='unknown']/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_if[@value='$distance gt $movethreshold_max or $distance lt $movethreshold_min']/do_else/set_value[@name='$updatetime'][@exact='(((this.ship.distanceto.[$target.sector, $pos])f / [this.ship.maxspeed, 1m].max)s + (pi / [this.ship.maxyawspeed, 1].max)s) * 5']" pos="before">
		<do_if value="@global.$DATweaks.$MAOCapital.$TravelDriveTweak">
			<set_value name="$DATCheckTravel" exact="true"/>
		</do_if>
	</add>
	<replace sel="/aiscript/attention[@min='unknown']/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_else[2]/set_value[@name='$boost'][@chance='$allowboost * 100']">
		<do_if value="true">
			<set_value name="$DATBoostBan" exact="false"/>
			<do_if value="@global.$DATweaks.$MAOCapital.$PlayerBoostDisabled and this.isplayerowned">
				<set_value name="$DATBoostBan" exact="true"/>
			</do_if>
			<do_elseif value="@global.$DATweaks.$MAOCapital.$AIBoostDisabled and (not this.isplayerowned)">
				<set_value name="$DATBoostBan" exact="true"/>
			</do_elseif>
		</do_if>
	</replace>
	<add sel="/aiscript/attention[@min='unknown']/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_else[2]/remove_value[@name='$enemypos']" pos="before">
		<set_value name="$boost" chance="if @$DATBoostBan then 0 else ($allowboost * 100)"/>
	</add>
	<add sel="/aiscript/attention[@min='unknown']/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_else[2]/get_safe_pos[@min='$minoperationalrange'][@max='$maxoperationalrange'][@object='$target'][@result='$pos']" pos="before">
		<do_if value="@global.$DATweaks.$MAOCapital.$TravelDriveTweak">
			<set_value name="$DATCheckTravel" exact="true"/>
		</do_if>
	</add>
	<add sel="/aiscript/attention[@min='unknown']/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $boost? and $allowboost and ($combinedskill ge 80)'][@chance='$combinedskill']">
		<do_if value="@$DATCheckTravel and ($timetopos gt 60s)">
			<set_value name="$travel"/>
		</do_if>
	</add>
</diff>
