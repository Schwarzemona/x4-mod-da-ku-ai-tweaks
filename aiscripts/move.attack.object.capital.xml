<?xml version="1.0" encoding="utf-8" ?>
<diff>
<!-- add. purpose: data store
	<params>
-->
	<add sel="//params">
		<param name="kAAITParam_isAvoidHighRisk" required="false" default="null" type="internal" />
		<param name="kAAITParam_isStepForwardWithdraw" required="false" type="internal" text="{1111920, 109}" default="false" />
	</add>
<!-- add before at 3 x move_to and 1 x move_strafe. purpose: debug.
	<move_to>
-->
	<add pos="before" sel="(//move_to)[1]">
		<do_if value="(@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw) and @this.$kAAIT_data.$isTargetPotentialHighRisk">
			<debug_text text="this.assignedcontrolled.idcode + ' move_to (1) rotate to aim'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		</do_if>
	</add>
	<add pos="before" sel="(//move_to)[2]">
		<do_if value="(@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw) and @this.$kAAIT_data.$isTargetPotentialHighRisk">
			<debug_text text="this.assignedcontrolled.idcode + ' move_to (2) rotate to look away'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		</do_if>
	</add>
	<add pos="before" sel="//move_strafe">
		<do_if value="(@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw) and @this.$kAAIT_data.$isTargetPotentialHighRisk">
			<debug_text text="this.assignedcontrolled.idcode + ' move_strafe'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		</do_if>
	</add>
	<add pos="before" sel="(//move_to)[3]">
		<do_if value="(@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw) and @this.$kAAIT_data.$isTargetPotentialHighRisk">
			<debug_text text="this.assignedcontrolled.idcode + ' move_to (3) short attack move'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		</do_if>
	</add>
<!-- add.
-->
	<add pos="prepend" sel="//interrupts">
		<library>
			<actions name="kAAIT_GetIsMoveToEngage">
				<set_value name="$kAAIT_result_isMovetoEngage" exact="false" />
				<do_if value="
					this.assignedcontrolled.isclass.[class.ship_l, class.ship_xl] and
					(@this.$kAAIT_data.$isTargetHighRisk or @this.$kAAIT_data.$isTargetPotentialHighRisk) and
					(not @$primarytarget.travel.active) and
					(not @$target.travel.active)
				">
					<set_value name="$kAAIT_distToTarget" exact="this.assignedcontrolled.bboxdistanceto.{$target}" />
					<do_if value="
						this.$kAAIT_data.$defensibleTarget != @this.$kAAIT_data.$defensibleTarget_stoppedKamikaze and
						(
							(
								this.$kAAIT_data.$defensibleTarget.isclass.station and
								$kAAIT_distToTarget gt this.assignedcontrolled.maxradarrange * 0.5
							) or
							(
								this.$kAAIT_data.$defensibleTarget.isclass.ship and
								(not @this.$kAAIT_data.$defensibleTarget.isclass.ship.travel.active) and
								$kAAIT_distToTarget gt this.assignedcontrolled.maxradarrange
							)
						)
					">
						<set_value name="$kAAIT_result_isMovetoEngage" exact="true" />
						<set_value name="this.$kAAIT_data.$defensibleTarget_stoppedKamikaze" exact="this.$kAAIT_data.$defensibleTarget" />
						<debug_text text="this.assignedcontrolled.idcode + ' $defensibleTarget_stoppedKamikaze: ' + this.$kAAIT_data.$defensibleTarget_stoppedKamikaze" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
						<do_if value="
							@$primarytarget.isclass.module or
							@$target.isclass.module
						">
							<set_value name="this.$kAAIT_data.$moduleTarget" exact="if @$primarytarget.isclass.module then $primarytarget else $target" />
							<debug_text text="this.assignedcontrolled.idcode + ' FIRST $moduleTarget: ' + this.$kAAIT_data.$moduleTarget" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
						</do_if>
					</do_if>
				</do_if>
				<debug_text text="this.assignedcontrolled.idcode + ' kAAIT_GetIsMoveToEngage $kAAIT_result_isMovetoEngage: ' + $kAAIT_result_isMovetoEngage" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			</actions>
		</library>
	</add>
<!-- add. purpose: add handlers.
	<interrupts>
-->
	<add pos="prepend" sel="//interrupts">
		<handler ref="kAAIT_Handler_AvoidWithdrawOrJustFight" />
		<handler ref="kAAIT_Handler_NewBigTarget" />
	</add>
<!-- add prepend. purpose: init var.
	<init>
-->
	<add pos="prepend" sel="//init">
		<debug_text text="this.assignedcontrolled.idcode + ' EVENT init'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<do_if value="@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw">
			<include_interrupt_actions ref="kAAIT_Init" />
		</do_if>
	</add>
<!-- replace. purpose: ignore canbeattacked 'coz move to engage position will handle it.
	<do_if value="not $target.canbeattacked">
		<resume label="finish" />
-->
	<!-- <replace sel="//do_if[@value=&quot;not $target.canbeattacked&quot;]/resume[@label=&quot;finish&quot;]">
		<do_if value="(@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw) and @this.$kAAIT_data.$isTargetHighRisk and (not @this.$kAAIT_data.$isIgnoreKAAIT)">
		</do_if>
		<do_else>
			<resume label="finish" />
		</do_else>
	</replace> -->
<!-- add before. purpose: custom behaviours.
	<label name="fight" />
-->
	<add pos="before" sel="//label[@name=&quot;fight&quot;]">
		<resume label="fight" />

		<label name="kAAIT_label_move_to_engage_position_order" />
		<debug_text text="this.assignedcontrolled.idcode + ' LABEL move_to_engage_position_order'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<create_order object="this.assignedcontrolled" id="'kAAIT_MoveEngagePosition'" immediate="true">
			<param name="target" value="$target"/>
		</create_order>
		<wait min="5s" max="10s" />
		<debug_text text="this.assignedcontrolled.idcode + ' shouldnt be here because kAAIT_MoveEngagePosition should have been activated'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<resume label="fight" />

		<label name="kAAIT_label_step_forward" />
		<debug_text text="this.assignedcontrolled.idcode + ' LABEL step_forward'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<create_order object="this.assignedcontrolled" id="'kAAIT_MoveStepForward'" immediate="true">
			<param name="target" value="$target" />
		</create_order>
		<resume label="fight" />

		<label name="kAAIT_label_avoid" />
		<debug_text text="this.assignedcontrolled.idcode + ' LABEL avoid'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<include_interrupt_actions ref="kAAIT_Order_Avoid" />
		<wait min="5s" max="10s" />
		<resume label="fight" />
	</add>
<!-- add after. purpose: determine custom behaviours.
	<label name="fight" />
-->
	<add pos="after" sel="//label[@name=&quot;fight&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' LABEL fight'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<do_if value="(@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw) and @this.$kAAIT_data.$isTargetHighRisk and (not @this.$kAAIT_data.$isIgnoreKAAIT)">
			<set_value name="$kAAIT_test_target_isAvoid" exact="$target" comment="check if target is obstructed by big enemy - e.g. station the module target is attached to" />
			<include_interrupt_actions ref="kAAIT_AvoidOrNot" />
			<do_if value="$kAAIT_result_isAvoid and @$kAAIT_result_avoidEnemy and $kAAIT_result_avoidEnemy != $target">
				<set_value name="this.$kAAIT_data.$target_avoid" exact="$kAAIT_result_avoidEnemy" />
				<resume label="kAAIT_label_avoid" />
			</do_if>
			<do_if value="
				this.assignedcontrolled.primarypurpose != purpose.fight or
				(
					this.assignedcontrolled.type == shiptype.carrier and
					@this.assignedcontrolled.commander.isoperational
				)
			">
				<set_value name="this.$kAAIT_data.$target_avoid" exact="this.$kAAIT_data.$defensibleTarget" />
				<resume label="kAAIT_label_avoid" />
			</do_if>
			<do_else>
				<include_interrupt_actions ref="kAAIT_GetIsMoveToEngage" />
				<do_if value="$kAAIT_result_isMovetoEngage">
					<resume label="kAAIT_label_move_to_engage_position_order" />
				</do_if>
				<do_elseif value="$target.isclass.module">
					<do_if value="this.$kAAIT_data.$moduleTarget?">
						<do_if value="$target != @this.$kAAIT_data.$moduleTarget"
							comment="only move to engage position AGAIN if there was a previous module target">
							<debug_text text="this.assignedcontrolled.idcode + ' NEW $moduleTarget: ' + this.$kAAIT_data.$moduleTarget" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
							<set_value name="this.$kAAIT_data.$moduleTarget" exact="$target" />
							<resume label="kAAIT_label_move_to_engage_position_order" />
						</do_if>
						<do_else>
							<debug_text text="this.assignedcontrolled.idcode + ' SAME $moduleTarget: ' + this.$kAAIT_data.$moduleTarget" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
						</do_else>
					</do_if>
					<do_else>
						<set_value name="this.$kAAIT_data.$moduleTarget" exact="$target" />
						<debug_text text="this.assignedcontrolled.idcode + ' FIRST $moduleTarget: ' + this.$kAAIT_data.$moduleTarget" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					</do_else>
				</do_elseif>
				<do_else>
					<set_value name="this.$kAAIT_data.$defensibleTarget_stoppedKamikaze" exact="this.$kAAIT_data.$defensibleTarget" />
					<do_if value="$target.isclass.module">
						<set_value name="this.$kAAIT_data.$moduleTarget" exact="$target" />
					</do_if>
				</do_else>
			</do_else>
		</do_if>

		<label name="kAAITLabel_just_fight" />
		<debug_text text="this.assignedcontrolled.idcode + ' LABEL just_fight'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<do_if value="(@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw) and @this.$kAAIT_data.$isTargetHighRisk and (not @this.$kAAIT_data.$isIgnoreKAAIT)">
			<include_interrupt_actions ref="kAAIT_AddAttackerToTarget" />
			<remove_value name="this.$kAAIT_data.$orderLocation_space" />
			<remove_value name="this.$kAAIT_data.$orderLocation_pos" />
		</do_if>
	</add>
<!-- add after. purpose: hijack effective range and move thresholds to limit the ship's movements to step forward or withdraw behaviours.
	<set_value name="$movethreshold_max" exact="$maxeffectivecombatrange"/>
-->
	<add pos="after" sel="//set_value[@name=&quot;$movethreshold_max&quot;][@exact=&quot;$maxeffectivecombatrange&quot;]">
		<set_value name="$movethreshold_min_orig" exact="$movethreshold_min"/>
		<set_value name="$movethreshold_max_orig" exact="$movethreshold_max"/>
		<do_if value="(@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw) and @this.$kAAIT_data.$isTargetHighRisk and (not @this.$kAAIT_data.$isIgnoreKAAIT)">
			<set_value name="$movethreshold_min" exact="this.$kAAIT_data.$combatRange_min"/>
			<set_value name="$movethreshold_max" exact="this.$kAAIT_data.$combatRange_max"/>
		</do_if>
	</add>
<!-- add prepend. purpose: debug.
	<do_if value="$distance gt $movethreshold_max or $distance lt $movethreshold_min">
-->
	<add pos="before" sel="//do_if[@value=&quot;$distance gt $movethreshold_max or $distance lt $movethreshold_min&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' $movethreshold_min_orig: ' + $movethreshold_min_orig + ' $movethreshold_min: ' + $movethreshold_min" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<debug_text text="this.assignedcontrolled.idcode + ' $distance: ' + $distance" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<debug_text text="this.assignedcontrolled.idcode + ' $movethreshold_max_orig: ' + $movethreshold_max_orig + ' $movethreshold_max: ' + $movethreshold_max" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
	</add>
	<add pos="prepend" sel="//do_if[@value=&quot;$distance gt $movethreshold_max or $distance lt $movethreshold_min&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' OUT OF MOVE THRESHOLDS'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
	</add>
	<add pos="prepend" sel="//do_elseif[@value=&quot;$distance le $movethreshold_max and $distance ge $movethreshold_min&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' WITHIN MOVE THRESHOLDS'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
	</add>
<!-- add before. purspoe: step forward after wait.
	<wait exact="$updatetime">
-->
	<add pos="after" sel="//wait[@exact=&quot;$updatetime&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' WAIT COMPLETE'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<do_if value="@$kAAITParam_isStepForwardWithdraw and @this.$kAAIT_data.$isTargetHighRisk and (not @this.$kAAIT_data.$isIgnoreKAAIT)">
			<do_if value="
				(not $target.isclass.ship) and
				player.age - @this.$kAAIT_data.$time_lastStepForward gt 1min and
				player.age gt @this.$kAAIT_data.$time_stepForwardAllowed
			">
				<set_value name="$kAAIT_distToTarget" exact="this.assignedcontrolled.bboxdistanceto.{$target}" />
				<do_if value="$kAAIT_distToTarget gt this.$kAAIT_data.$combatRange_min">
					<resume label="kAAIT_label_step_forward" />
				</do_if>
			</do_if>
		</do_if>
	</add>
<!-- add before. purpose: debug.
	<do_else>
		<set_value name="$case" exact="'1.1.3: cap v cap, front-mounted, retreat'"/>
-->
	<add pos="before" sel="//set_value[@name=&quot;$case&quot;][@exact=&quot;'1.1.3: cap v cap, front-mounted, retreat'&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' TOO NEAR TARGET'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
	</add>
<!-- add after 2nd instance. purpose: if chasing small ships near big enemy, move away.
	<get_safe_pos result="$pos" object="$target" min="$minoperationalrange" max="$maxoperationalrange" sector="$target.sector" direction="$weakquadrant" directionobject="$target" radius="this.ship.size/2.0" ignored="this.ship"/>
-->
	<add pos="after" sel="(//get_safe_pos[@result=&quot;$pos&quot;][@object=&quot;$target&quot;][@min=&quot;$minoperationalrange&quot;][@max=&quot;$maxoperationalrange&quot;][@sector=&quot;$target.sector&quot;][@direction=&quot;$weakquadrant&quot;][@directionobject=&quot;$target&quot;][@radius=&quot;this.ship.size/2.0&quot;][@ignored=&quot;this.ship&quot;])[2]">
		<do_if value="@$kAAITParam_isStepForwardWithdraw and @this.$kAAIT_data.$isTargetHighRisk and (not @this.$kAAIT_data.$isIgnoreKAAIT)">
			<include_interrupt_actions ref="kAAIT_GetBigEnemies" />
			<include_interrupt_actions ref="kAAIT_GetIsNearBigEnemies" />
			<do_if value="@$kAAIT_result_bigEnemy">
				<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_result_bigEnemy (too near): ' + @$kAAIT_result_bigEnemy.knownname + ' ' + @$kAAIT_result_bigEnemy.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<resume label="kAAITLabel_withdraw" />
			</do_if>
		</do_if>
	</add>
<!-- add before. purpose: if primarypurpose != fight or shiptype == carrier, stay away from target
	<do_if value="this.ship.sector == $target.sector">
		...
		<do_if value="$strafe?">
-->
	<add pos="before" sel="//do_if[@value=&quot;this.ship.sector == $target.sector&quot;]//do_if[@value=&quot;$strafe?&quot;]">
		<do_if value="(@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw) and @this.$kAAIT_data.$isTargetHighRisk and (not @this.$kAAIT_data.$isIgnoreKAAIT)">
			<do_if value="
				this.assignedcontrolled.primarypurpose != purpose.fight or
				(
					this.assignedcontrolled.type == shiptype.carrier and
					this.assignedcontrolled.commander.isoperational
				)" comment="if not primarypurpose fight or carrier, then keep away from target">
				<debug_text text="this.assignedcontrolled.idcode + ' this.assignedcontrolled.primarypurpose (keep away from target): ' + this.assignedcontrolled.primarypurpose" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<create_orientation name="$kAAIT_rotFromTarget" orientation="look_at" refobject="this.assignedcontrolled">
					<position object="$target" />
				</create_orientation>
				<set_value name="$kAAIT_distAvoid" exact="this.assignedcontrolled.maxradarrange * 0.5" />
				<create_position name="$pos"
					x="$target.position.x + $kAAIT_distAvoid * sin ($kAAIT_rotFromTarget.yaw) * cos ($kAAIT_rotFromTarget.pitch)"
					y="$target.position.y + $kAAIT_distAvoid * sin ($kAAIT_rotFromTarget.pitch)"
					z="$target.position.z + $kAAIT_distAvoid * cos ($kAAIT_rotFromTarget.yaw) * cos ($kAAIT_rotFromTarget.pitch)"
				/>
			</do_if>
		</do_if>
	</add>
<!-- add after. purpose: step_forward after attack run.
	<do_if value="this.ship.sector == $target.sector">
		...
		<do_if value="@$boost">
-->
	<add pos="after" sel="//do_if[@value=&quot;this.ship.sector == $target.sector&quot;]/do_if[@value=&quot;@$boost&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' ATTACK CYCLE COMPLETE'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<do_if value="@$kAAITParam_isStepForwardWithdraw and @this.$kAAIT_data.$isTargetHighRisk and (not @this.$kAAIT_data.$isIgnoreKAAIT)">
			<do_if value="
				(not $target.isclass.ship) and
				player.age - @this.$kAAIT_data.$time_lastStepForward gt 1min and
				player.age gt @this.$kAAIT_data.$time_stepForwardAllowed
			">
				<set_value name="$kAAIT_distToTarget" exact="this.assignedcontrolled.bboxdistanceto.{this.$kAAIT_data.$defensibleTarget}" />
				<do_if value="$kAAIT_distToTarget gt this.$kAAIT_data.$combatRange_min">
					<resume label="kAAIT_label_step_forward" />
				</do_if>
			</do_if>
		</do_if>
	</add>
<!-- add before. purpose: withdraw.
	<label name="finish"/>
-->
	<add pos="before" sel="//label[@name=&quot;finish&quot;]">
		<resume label="finish"/>
		<label name="kAAITLabel_withdraw" />
		<debug_text text="this.assignedcontrolled.idcode + ' LABEL kAAITLabel_withdraw'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<create_order object="this.assignedcontrolled" id="'kAAIT_MoveWithdraw'" immediate="true">
			<param name="target" value="this.$kAAIT_data.$defensibleTarget" />
		</create_order>
		<resume label="finish"/>
	</add>
<!-- add after finish. purpose: clean-up.
	<label name="finish" />
-->
	<add pos="after" sel="//label[@name=&quot;finish&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' LABEL finish'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<include_interrupt_actions ref="kAAIT_RemoveAttackerFromTarget" />
		<do_if value="@this.$kAAIT_data">
			<remove_value name="this.$kAAIT_data.$orderLocation_space" />
			<remove_value name="this.$kAAIT_data.$orderLocation_pos" />
		</do_if>
	</add>
	<!--
		   db    88""Yb  dP"Yb  88""Yb 888888
		  dPYb   88__dP dP   Yb 88__dP   88
		 dP__Yb  88""Yb Yb   dP 88"Yb    88
		dP""""Yb 88oodP  YbodP  88  Yb   88
	 -->
<!-- add after. purpose: cleanup.
	<attention min="unknown">
-->
	<add pos="after" sel="//attention[@min=&quot;unknown&quot;]">
		<on_abort>
			<include_interrupt_actions ref="kAAIT_RemoveAttackerFromTarget" />
			<do_if value="@this.$kAAIT_data">
				<remove_value name="this.$kAAIT_data.$orderLocation_space" />
				<remove_value name="this.$kAAIT_data.$orderLocation_pos" />
			</do_if>
		</on_abort>
	</add>
	<!-- DeadAir Diffs -->
	<replace sel="/aiscript/params/param[@name='minrange']/@default">if @$target.iscapitalship or $target.isrealclass.station or $target.container.isrealclass.station then ([this.ship.maxcombatrange.all,this.assignedcontrolled.maxradarrange].min * 0.6) else ([this.ship.maxcombatrange.all,this.assignedcontrolled.maxradarrange].min * 0.3)</replace>
	<replace sel="/aiscript/params/param[@name='maxrange']/@default">if @$target.iscapitalship or $target.isrealclass.station or $target.container.isrealclass.station then ([this.ship.maxcombatrange.all,this.assignedcontrolled.maxradarrange].min * 0.9) else ([this.ship.maxcombatrange.all,this.assignedcontrolled.maxradarrange].min * 0.9)</replace>
	<remove sel="/aiscript/init/do_if[@value='this.isplayerowned']"/>
	<replace sel="/aiscript/attention/actions/do_if[@value='not $disable']/do_if[@value='this.ship.dps.missiles.all']">
		<do_elseif value="this.ship.dps.missiles.all">
			<set_value name="$bestquadrant" exact="quadrant.front"/>
			<set_value name="$frontweapon" exact="2"/>
		</do_elseif>
	</replace>
	<remove sel="/aiscript/attention/actions/do_if[@value='not @$frontweapon']"/>
	<replace sel="/aiscript/attention/actions/do_elseif[@value='@$frontweapon == 1']/set_value[@name='$minoperationalrange'][@exact='[this.assignedcontrolled.maxcombatrange.lasers.all * 0.6, $minrange].min']/@exact">if (@$isstation or @$target.iscapitalship) then ([this.assignedcontrolled.maxcombatrange.lasers.all,this.assignedcontrolled.maxradarrange].min * 0.6) else ([this.assignedcontrolled.maxcombatrange.lasers.all,this.assignedcontrolled.maxradarrange].min * 0.3)</replace>
	<replace sel="/aiscript/attention/actions/do_elseif[@value='@$frontweapon == 1']/set_value[@name='$maxoperationalrange'][@exact='[this.assignedcontrolled.maxcombatrange.lasers.all * 0.9, $maxrange].min']/@exact">([this.assignedcontrolled.maxcombatrange.lasers.all,this.assignedcontrolled.maxradarrange].min * 0.9)</replace>
	<replace sel="/aiscript/attention/actions/do_if[@value='$isstation']/set_value[@name='$quadrants'][@exact='[quadrant.left, quadrant.right, quadrant.up, quadrant.down, quadrant.back, quadrant.front]']/@exact">[quadrant.left, quadrant.right, quadrant.back, quadrant.front]</replace>
	<replace sel="/aiscript/attention/actions/do_else[2]/set_value[@name='$quadrants'][@exact='[quadrant.left, quadrant.right, quadrant.back]']/@exact">[quadrant.left, quadrant.right, quadrant.back, quadrant.front]</replace>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/set_value[@name='$maxeffectivecombatrange'][@exact='this.assignedcontrolled.maxcombatrange.all * 0.8']/@exact">$maxoperationalrange</replace>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_if[@value='this.assignedcontrolled.dps.lasers.all']">
		<set_value name="$aimdist" min="$minoperationalrange" max="$maxoperationalrange" profile="bell"/>
	</replace>
	<remove sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/set_value[@name='$aimdist'][@min='$maxeffectivecombatrange * (0.4 * (1.0 + (($skill_piloting + $skill_morale)f / 30.0)))']"/>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/set_value[@name='$movethreshold_min'][@exact='[$maxeffectivecombatrange * 0.5, $aimdist - 1m].min']/@exact">if ((@$target.order.id == 'Flee') or @$target.travel.active) then [$minoperationalrange * 0.75, $aimdist - 1m].min else ($minoperationalrange * 0.75)</replace>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/check_object/match_is_in_view_of/@vertical">150deg</replace>
	<add sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_if[@value='$distance ge $movethreshold_min']/move_to" type="@boost">false</add>
	<add sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_if[@value='$distance ge $movethreshold_min']/move_to" type="@travel">false</add>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_if[@value='$distance gt $movethreshold_max or $distance lt $movethreshold_min']/get_safe_pos/@allowyaxis">true</replace>
	<add sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_if[@value='$distance gt $movethreshold_max or $distance lt $movethreshold_min']/do_if[@value='$distance gt $movethreshold_max']/create_position[@name='$locpos']" pos="before">
		<create_position name="$targetposition" space="$target.sector" object="$target"/>
	</add>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_if[@value='$distance gt $movethreshold_max or $distance lt $movethreshold_min']/do_else/set_value[@name='$boost']/@chance">if (this.assignedcontrolled.shieldpercentage gt 75) then $allowboost * 100 else 0</replace>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_elseif[@value='$distance le $movethreshold_max and $distance ge $movethreshold_min']/do_if[@value='@$holdposition']/set_value[@name='$time_waitend'][@exact='player.age + (($updatetime * 4) / (16 - $skill_morale))']/@exact">player.age + (($updatetime * 4) / (16 - [$skill_morale,9].max))</replace>
	<remove sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_elseif[@value='$distance le $movethreshold_max and $distance ge $movethreshold_min']/do_if[@value='not ($isstation or $frontweapon?)']/@chance"/>
	<add sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_else[2]/move_to" type="@boost">false</add>
	<add sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_else[2]/move_to" type="@travel">false</add>
	<add sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_else[2]/set_value[@name='$distfactor'][@exact='($maxeffectivecombatrange - $distance) / $distance ']" pos="before">
		<set_value name="$distance" exact="this.assignedcontrolled.bboxdistanceto.{$target}"/>
	</add>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_else[2]/set_value[@name='$boost']/@chance">if (this.assignedcontrolled.shieldpercentage gt 75) then ($allowboost * 100) else 0</replace>
	<remove sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_else/do_else/do_else/get_safe_pos/@direction"/>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_else/do_else/do_else/get_safe_pos/@directionobject">this.ship</replace>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_else/do_else/do_else/get_safe_pos/@allowyaxis">true</replace>
	<add sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_else/do_else/do_else/get_safe_pos" type="@profile">bell</add>
	<remove sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_else[2]/get_safe_pos/@direction"/>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_else[2]/get_safe_pos/@directionobject">this.ship</replace>
	<add sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_else[2]/get_safe_pos" type="@profile">bell</add>
	<remove sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='(@$lastquadranttupdate lt player.age) and not @$frontweapon']/@chance"/>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='(@$lastquadranttupdate lt player.age) and not @$frontweapon']/set_value[@name='$lastquadranttupdate'][@exact='player.age + 30s']/@exact">player.age + 30s + (30s - (30*($combinedskill/100.0)))s</replace>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='(@$lastquadranttupdate lt player.age) and not @$frontweapon']/do_any">
		<set_value name="$weakquadrant" exact="$weakquadrants.{1}"/>
	</replace>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $boost? and $allowboost and ($combinedskill ge 80)']/@value">(not $boost? and $allowboost and (this.ship.bboxdistanceto.{$target} gt $maxoperationalrange or this.ship.bboxdistanceto.{$target} lt $minoperationalrange)) or ($allowboost and (this.ship.distanceto.[$target.sector, $pos] gt 15km) and (this.ship.bboxdistanceto.{$target} gt $maxoperationalrange or this.ship.bboxdistanceto.{$target} lt $minoperationalrange))</replace>
	<remove sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='(not $boost? and $allowboost and (this.ship.bboxdistanceto.{$target} gt $maxoperationalrange or this.ship.bboxdistanceto.{$target} lt $minoperationalrange)) or ($allowboost and (this.ship.distanceto.[$target.sector, $pos] gt 15km) and (this.ship.bboxdistanceto.{$target} gt $maxoperationalrange or this.ship.bboxdistanceto.{$target} lt $minoperationalrange))']/@chance"/>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='$boost?']/do_if[@value='(this.assignedcontrolled.shieldpercentage gt 50) and this.assignedcontrolled.boost.maxduration']/@value">(this.assignedcontrolled.shieldpercentage gt 75) and (this.assignedcontrolled.boost.maxduration)</replace>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='$boost?']/do_if[@value='(this.assignedcontrolled.shieldpercentage gt 75) and (this.assignedcontrolled.boost.maxduration)']/set_value[@name='$updatetime'][@exact='(this.assignedcontrolled.boost.maxduration * (this.assignedcontrolled.shieldpercentage / 100.0) * 0.5)s']/@exact">(this.assignedcontrolled.boost.maxduration * (this.assignedcontrolled.shieldpercentage / 100.0) * 0.25)s</replace>
	<add sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='this.ship.sector == $target.sector']/do_if[@value='$strafe?']/move_strafe" type="@boost">false</add>
	<add sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='this.ship.sector == $target.sector']/do_if[@value='$strafe?']/move_strafe" type="@travel">false</add>
</diff>
