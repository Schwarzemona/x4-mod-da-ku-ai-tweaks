<?xml version="1.0" encoding="utf-8" ?>
<diff>
<!-- add. purpose: data store
	<params>
-->
	<add sel="//params">
		<param name="kAAITParam_isAttackOrder" required="false" default="true" type="internal" />
		<param name="kAAITParam_isAutoAdded" required="false" default="false" type="internal" />
		<param name="kAAITParam_data" required="false" default="null" type="internal" />
		<param name="kAAITParam_isAvoidHighRisk" required="false" type="bool" text="{1111920, 3}" default="false" />
		<param name="kAAITParam_isStepForwardWithdraw" required="false" type="internal" text="{1111920, 109}" default="false" />
	</add>
<!-- add before at 4 instances. purpose: debug and show move in map.
	the order location properties are in order.fight.attack.object as $kAAITParam_data.$orderLocation_space and $kAAITParam_data.$orderLocation_pos.
	setting $kAAITParam_data.$orderLocation_space and $kAAITParam_data.$orderLocation_pos will show the order performing the move instead of as the attack.
	<move_to>
-->
	<add pos="before" sel="(//move_to)[1]">
		<do_if value="@$kAAITParam_isAvoidHighRisk">
			<debug_text text="this.assignedcontrolled.idcode + ' move_to (1) rotate to aim'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		</do_if>
	</add>
	<add pos="before" sel="(//move_to)[2]">
		<do_if value="@$kAAITParam_isAvoidHighRisk">
			<debug_text text="this.assignedcontrolled.idcode + ' move_to (2) rotate to look away'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		</do_if>
	</add>
	<add pos="before" sel="//move_strafe">
		<do_if value="@$kAAITParam_isAvoidHighRisk">
			<debug_text text="this.assignedcontrolled.idcode + ' move_strafe'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		</do_if>
	</add>
	<add pos="before" sel="(//move_to)[3]">
		<do_if value="@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw">
			<debug_text text="this.assignedcontrolled.idcode + ' move_to (3) short attack move'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		</do_if>
	</add>
	<add pos="after" sel="(//move_to)[3]">
		<do_if value="@$kAAITParam_data">
			<remove_value name="$kAAITParam_data.$orderLocation_space" />
			<remove_value name="$kAAITParam_data.$orderLocation_pos" />
		</do_if>
	</add>
<!-- add prepend. purpose: init var.
	<init>
-->
	<add pos="prepend" sel="//init">
		<do_if value="@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw">
			<include_interrupt_actions ref="kAAIT_Init" />
		</do_if>
	</add>
<!-- add after 1st instance. purpose: replace aimdist. more stable combat range.
	<set_value name="$aimdist" min="$maxeffectivecombatrange * (0.4 * (1.0 + (($skill_piloting + $skill_morale)f / 30.0)))" max="$maxeffectivecombatrange * (1.0 - (($skill_piloting + $skill_morale)f / 300.0))"/>
-->
	<add pos="after" sel="(//set_value[@name=&quot;$aimdist&quot;])[1]">
		<do_if value="@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw">
			<include_interrupt_actions ref="kAAIT_LXL_GetCombatRange" />
			<set_value name="$aimdist" exact="$kAAIT_combatRange" />
		</do_if>
	</add>
<!-- add after. purpose: hijack effective range and move thresholds.
	<set_value name="$movethreshold_max" exact="$maxeffectivecombatrange"/>
-->
	<add pos="after" sel="//set_value[@name=&quot;$movethreshold_max&quot;][@exact=&quot;$maxeffectivecombatrange&quot;]">
		<do_if value="@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw">
			<set_value name="$maxeffectivecombatrange" exact="$kAAIT_maxCombatRange"/>
			<!-- <set_value name="$movethreshold_min" exact="$kAAIT_minCombatRange"/> -->
			<!-- <set_value name="$movethreshold_min" exact="[$movethreshold_min, $kAAIT_combatRange].max"/> -->
			<set_value name="$movethreshold_max" exact="[$movethreshold_max, $kAAIT_maxCombatRange].max"/>
		</do_if>
	</add>
<!-- add before. purpose: debug
	<do_if value="$distance gt $movethreshold_max or $distance lt $movethreshold_min">
-->
	<add pos="before" sel="//do_if[@value=&quot;$distance gt $movethreshold_max or $distance lt $movethreshold_min&quot;]">
		<do_if value="@$kAAITParam_isAvoidHighRisk">
			<debug_text text="this.assignedcontrolled.idcode + ' $distance: ' + $distance + ' $aimdist: ' + $aimdist + ' $maxeffectivecombatrange: ' + $maxeffectivecombatrange + ' $movethreshold_min: ' + $movethreshold_min + ' $movethreshold_max: ' + $movethreshold_max" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		</do_if>
	</add>
<!-- add "not isstation" to value. purpose: prevent going to the other side of target, if target is a station module!
	<do_if value="$target.distanceto.[$target.sector, $pos] gt $movethreshold_max or $target.distanceto.[$target.sector, $pos] lt $movethreshold_min">
-->
	<add pos="before" sel="//do_if[@value=&quot;$target.distanceto.[$target.sector, $pos] gt $movethreshold_max or $target.distanceto.[$target.sector, $pos] lt $movethreshold_min&quot;]">
		<do_if value="
			@$kAAIT_isTargetPotentialHighRisk and
			(@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw)
		">
			<set_value name="$kAAIT_isFindPosOnOtherSide" exact="false" />
			<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_isFindPosOnOtherSide (1): ' + $kAAIT_isFindPosOnOtherSide" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			<do_if value="$target.distanceto.[$target.sector, $pos] gt $movethreshold_max or $kAAIT_isLXLNewModuleTarget">
				<include_interrupt_actions ref="kAAIT_XSSM_AttackOrNot" />
				<do_if value="@$kAAIT_isAvoidOrderGiven">
					<do_if value="@$kAAIT_isLXLNewModuleTarget">
						<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_isLXLNewModuleTarget: ' + $kAAIT_isLXLNewModuleTarget" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
						<set_value name="$kAAIT_isLXLNewModuleTarget" exact="false" />
						<!-- this is an embedded move, so a move_to is required here. -->
						<do_if value="@$kAAIT_moveToSpace and $kAAIT_moveToPos?">
							<debug_text text="this.assignedcontrolled.idcode + ' move_to $kAAIT_moveToSpace: ' + @$kAAIT_moveToSpace + ', $kAAIT_moveToPos: ' + @$kAAIT_moveToPos" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
							<include_interrupt_actions ref="kAAIT_UpdateOrderLocation" />
							<move_to object="this.ship"
								destination="$kAAIT_moveToSpace"
								uselocalhighways="false"
								useknownpath="this.isplayerowned"
								forcesteering="this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m]"
								commandaction="false">
								<position value="$kAAIT_moveToPos"/>
							</move_to>
							<do_if value="@$kAAITParam_data">
								<remove_value name="$kAAITParam_data.$orderLocation_space" />
								<remove_value name="$kAAITParam_data.$orderLocation_pos" />
							</do_if>
						</do_if>
						<resume label="fight"/>
					</do_if>
					<do_else>
						<!-- empty. -->
						<!-- if not kAAIT_isLXLNewModuleTarget, a new order (rather than an embedded move_to) is created, and this attack order automatically resumes as if it has started anew. -->
					</do_else>
				</do_if>
			</do_if>
		</do_if>
		<do_else>
			<set_value name="$kAAIT_isFindPosOnOtherSide" exact="$target.distanceto.[$target.sector, $pos] lt $movethreshold_min" />
			<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_isFindPosOnOtherSide (2): ' + $kAAIT_isFindPosOnOtherSide" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		</do_else>
	</add>
	<replace sel="//do_if[@value=&quot;$target.distanceto.[$target.sector, $pos] gt $movethreshold_max or $target.distanceto.[$target.sector, $pos] lt $movethreshold_min&quot;]/@value">$kAAIT_isFindPosOnOtherSide</replace>
<!-- replace check value. purpose: consider shield for reaction.
	<wait exact="$updatetime">
		<interrupt>
			<conditions>
				...
				<check_value value="player.age ge $time_waitend"/>
-->
	<replace sel="//wait[@exact=&quot;$updatetime&quot;]//conditions//check_value[@value=&quot;player.age ge $time_waitend&quot;]">
		<check_value value="
			player.age ge $time_waitend or
			(
				@$kAAITParam_isStepForwardWithdraw and @$kAAIT_isTargetPotentialHighRisk and
				(
					this.assignedcontrolled.shieldpercentage le 90 or
					this.assignedcontrolled.distanceto.{$target} lt @$kAAITParam_data.$kAAIT_lockedAttackDist * 0.9
				) and
				(
					this.assignedcontrolled.shieldpercentage gt 25 and
					this.assignedcontrolled.hullpercentage gt 25
				)
			)
		" />
	</replace>
<!-- add before. purspoe: inch forward or backwards.
	<wait exact="$updatetime">
-->
	<add pos="before" sel="//wait[@exact=&quot;$updatetime&quot;]">
		<do_if value="@$kAAITParam_isStepForwardWithdraw">
			<debug_text text="this.assignedcontrolled.idcode + ' player.age (before wait): ' + player.age + ' $time_waitend: ' + $time_waitend" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		</do_if>
	</add>
	<add pos="prepend" sel="//wait[@exact=&quot;$updatetime&quot;]/interrupt/actions">
		<do_if value="@$kAAITParam_isStepForwardWithdraw">
			<debug_text text="'event.name: ' + @event.name + ' event.param: ' + @event.param.knownname + ', ' + @event.param.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			<do_if value="event.param.isclass.[class.ship_l, class.ship_xl, class.station] or @event.param.defensible.isclass.[class.ship_l, class.ship_xl, class.station]">
				<set_value name="$kAAITParam_data.$lastAttack_enemy" exact="event.param" />
				<set_value name="$kAAITParam_data.$lastAttack_time" exact="player.age" />
			</do_if>
		</do_if>
	</add>
	<add pos="after" sel="//wait[@exact=&quot;$updatetime&quot;]">
		<do_if value="@$kAAITParam_isStepForwardWithdraw">
			<debug_text text="this.assignedcontrolled.idcode + ' $kAAITParam_isStepForwardWithdraw (inch forward or backwards after wait): ' + @$kAAITParam_isStepForwardWithdraw" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			<include_interrupt_actions ref="kAAIT_LXL_StepForwardOrMoveOutOfRange" />
			<do_if value="@$kAAIT_isStepForwardWithdrawGiven">
				<!-- these are precise movements, so always assume no get_safe_pos is req. -->
				<set_value name="$kAAIT_moveToSpace" exact="this.assignedcontrolled.zone" />
				<include_interrupt_actions ref="kAAIT_UpdateOrderLocation" />
				<debug_text text="this.assignedcontrolled.idcode + ' move_to $kAAIT_moveToSpace: ' + @$kAAIT_moveToSpace + ', $kAAIT_moveToPos: ' + @$kAAIT_moveToPos" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<move_to object="this.ship"
					destination="$kAAIT_moveToSpace"
					uselocalhighways="false"
					useknownpath="this.isplayerowned"
					forcesteering="this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m]"
					commandaction="false">
					<position value="$kAAIT_moveToPos"/>
					<interrupt>
						<conditions>
							<event_object_destroyed object="$kAAIT_defensibleTarget"/>
							<check_any>
								<event_object_destroyed object="$kAAIT_defensibleTarget"/>
								<check_all>
									<event_object_attacked object="this.assignedcontrolled"/>
									<check_value value="$kAAIT_defensibleTarget.isclass.ship" />
									<check_value value="this.assignedcontrolled.shieldpercentage lt 25"/>
									<check_value value="this.assignedcontrolled.hullpercentage lt 25"/>
								</check_all>
							</check_any>
						</conditions>
						<actions>
							<debug_text text="this.assignedcontrolled.idcode + ' step forward/withdraw cancelled! (1)'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
							<debug_text text="this.assignedcontrolled.idcode + ' this.assignedcontrolled.shieldpercentage: ' + @this.assignedcontrolled.shieldpercentage" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
							<debug_text text="this.assignedcontrolled.idcode + ' this.assignedcontrolled.hullpercentage: ' + @this.assignedcontrolled.hullpercentage" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
						</actions>
					</interrupt>
				</move_to>
				<do_if value="@$kAAITParam_data">
					<remove_value name="$kAAITParam_data.$orderLocation_space" />
					<remove_value name="$kAAITParam_data.$orderLocation_pos" />
				</do_if>
				<resume label="finish" />
			</do_if>
		</do_if>
	</add>
<!-- add before. purpose: debug null vars on update to new version
	<set_value name="$distfactor" exact="($maxeffectivecombatrange - $distance) / $distance " />
-->
	<add pos="before" sel="//set_value[@name=&quot;$distfactor&quot;][@exact=&quot;($maxeffectivecombatrange - $distance) / $distance &quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' $kAAITParam_isActive: ' + @$kAAITParam_isActive + ' $kAAITParam_data: ' + @$kAAITParam_data" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<debug_text text="this.assignedcontrolled.idcode + ' $maxeffectivecombatrange: ' + $maxeffectivecombatrange + ' $distance: ' + $distance" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<do_if value="(not @$maxeffectivecombatrange) or (not @$distance)">
			<debug_text text="this.assignedcontrolled.idcode + ' resume label fight. mod updated: $maxeffectivecombatrange ' + @$maxeffectivecombatrange + ' $distance: ' + @$distance + ' $kAAITParam_isActive: ' + @$kAAITParam_isActive + ' $kAAITParam_data: ' + @$kAAITParam_data" />
			<resume label="fight" />
		</do_if>
	</add>
<!-- add after 2nd instance. purpose: if chasing small ships near big enemy, move away.
	<get_safe_pos result="$pos" object="$target" min="$minoperationalrange" max="$maxoperationalrange" sector="$target.sector" direction="$weakquadrant" directionobject="$target" radius="this.ship.size/2.0" ignored="this.ship"/>
-->
	<add pos="after" sel="(//get_safe_pos[@result=&quot;$pos&quot;][@object=&quot;$target&quot;][@min=&quot;$minoperationalrange&quot;][@max=&quot;$maxoperationalrange&quot;][@sector=&quot;$target.sector&quot;][@direction=&quot;$weakquadrant&quot;][@directionobject=&quot;$target&quot;][@radius=&quot;this.ship.size/2.0&quot;][@ignored=&quot;this.ship&quot;])[2]">
		<do_if value="@$kAAITParam_isStepForwardWithdraw">
			<include_interrupt_actions ref="kAAIT_GetIsNearBigEnemies" />
			<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_isShipNearBigEnemy: ' + $kAAIT_isShipNearBigEnemy + ' $kAAIT_isTargetNearBigEnemy: ' + $kAAIT_isTargetNearBigEnemy" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			<do_if value="@$kAAIT_isShipNearBigEnemy or @$kAAIT_isTargetNearBigEnemy">
				<!-- move away -->
				<include_interrupt_actions ref="kAAIT_Order_Avoid" />
				<do_if value="this.assignedcontrolled.attention lt attention.visible">
					<resume label="finish" />
				</do_if>
			</do_if>
		</do_if>
	</add>
<!-- add. purpose: consider shield for reaction. MOVE_STRAFE.
	<move_strafe destination="$target" abortpath="not @$abortpath" object="this.assignedcontrolled" finishonapproach="false" forcerotation="true" sinceversion="10">
		<interrupt>
			<conditions>
				<check_any>
-->
	<add sel="//move_strafe[@destination=&quot;$target&quot;]/interrupt/conditions/check_any">
		<check_all>
			<event_object_attacked object="this.assignedcontrolled" />
			<check_value value="@$kAAITParam_isStepForwardWithdraw" />
			<check_value value="@$kAAIT_isTargetPotentialHighRisk" />
			<check_any>
				<check_value value="this.assignedcontrolled.shieldpercentage le 90" />
				<check_value value="this.assignedcontrolled.bboxdistanceto.{$target} lt @$kAAITParam_data.$kAAIT_lockedAttackDist * 0.9" />
			</check_any>
			<check_any>
				<check_value value="this.assignedcontrolled.shieldpercentage gt 25" />
				<check_value value="this.assignedcontrolled.hullpercentage gt 25" />
			</check_any>
		</check_all>
	</add>
<!-- add after. purpose: var for last attack.
	<move_strafe destination="$target" abortpath="not @$abortpath" object="this.assignedcontrolled" finishonapproach="false" forcerotation="true" sinceversion="10">
		<interrupt>
			<conditions>
-->
	<add pos="after" sel="//move_strafe[@destination=&quot;$target&quot;]/interrupt/conditions">
		<actions>
			<do_if value="@$kAAITParam_isStepForwardWithdraw">
				<debug_text text="'event.name: ' + @event.name + ' event.param: ' + @event.param.knownname + ', ' + @event.param.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<do_if value="event.param.isclass.[class.ship_l, class.ship_xl, class.station] or @event.param.defensible.isclass.[class.ship_l, class.ship_xl, class.station]">
					<set_value name="$kAAITParam_data.$lastAttack_enemy" exact="event.param" />
					<set_value name="$kAAITParam_data.$lastAttack_time" exact="player.age" />
				</do_if>
			</do_if>
		</actions>
	</add>
<!-- add. purpose: consider shield for reaction. MOVE_TO (3).
	<move_to destination="$target" abortpath="not @$noabortpath" object="this.assignedcontrolled" finishonapproach="false" forceposition="false" forcerotation="false" uselocalhighways="false" boost="@$boost" travel="@$travel">
		<interrupt>
			<conditions>
				<check_any>
-->
	<add sel="//move_to[@destination=&quot;$target&quot;]/interrupt/conditions/check_any">
		<check_all>
			<event_object_attacked object="this.assignedcontrolled" />
			<check_value value="@$kAAITParam_isStepForwardWithdraw" />
			<check_value value="@$kAAIT_isTargetPotentialHighRisk" />
			<check_any>
				<check_value value="this.assignedcontrolled.shieldpercentage le 90" />
				<check_value value="this.assignedcontrolled.bboxdistanceto.{$target} lt @$kAAITParam_data.$kAAIT_lockedAttackDist * 0.9" />
			</check_any>
			<check_any>
				<check_value value="this.assignedcontrolled.shieldpercentage gt 25" />
				<check_value value="this.assignedcontrolled.hullpercentage gt 25" />
			</check_any>
		</check_all>
	</add>
<!-- add after. purpose: var for last attack.
	<move_to destination="$target" abortpath="not @$noabortpath" object="this.assignedcontrolled" finishonapproach="false" forceposition="false" forcerotation="false" uselocalhighways="false" boost="@$boost" travel="@$travel">
		<interrupt>
			<conditions>
-->
	<add pos="after" sel="//move_to[@destination=&quot;$target&quot;]/interrupt/conditions">
		<actions>
			<do_if value="@$kAAITParam_isStepForwardWithdraw">
				<debug_text text="'event.name: ' + @event.name + ' event.param: ' + @event.param.knownname + ', ' + @event.param.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<do_if value="event.param.isclass.[class.ship_l, class.ship_xl, class.station] or @event.param.defensible.isclass.[class.ship_l, class.ship_xl, class.station]">
					<set_value name="$kAAITParam_data.$lastAttack_enemy" exact="event.param" />
					<set_value name="$kAAITParam_data.$lastAttack_time" exact="player.age" />
				</do_if>
			</do_if>
		</actions>
	</add>
<!-- add after. purpose: inch forward if no recent damage from big target.
	<do_if value="this.ship.sector == $target.sector">
		...
		<do_if value="@$boost">
-->
	<add pos="after" sel="//do_if[@value=&quot;this.ship.sector == $target.sector&quot;]/do_if[@value=&quot;@$boost&quot;]">
		<do_if value="@$kAAITParam_isStepForwardWithdraw">
			<debug_text text="this.assignedcontrolled.idcode + ' $kAAITParam_isStepForwardWithdraw (inch forward if no recent damage): ' + @$kAAITParam_isStepForwardWithdraw" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			<include_interrupt_actions ref="kAAIT_LXL_StepForwardOrMoveOutOfRange" />
			<do_if value="@$kAAIT_isStepForwardWithdrawGiven">
				<!-- these are precise movements, so always assume no get_safe_pos is req. -->
				<set_value name="$kAAIT_moveToSpace" exact="this.assignedcontrolled.zone" />
				<include_interrupt_actions ref="kAAIT_UpdateOrderLocation" />
				<debug_text text="this.assignedcontrolled.idcode + ' move_to $kAAIT_moveToSpace: ' + @$kAAIT_moveToSpace + ', $kAAIT_moveToPos: ' + @$kAAIT_moveToPos" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
				<move_to object="this.ship"
					destination="$kAAIT_moveToSpace"
					uselocalhighways="false"
					useknownpath="this.isplayerowned"
					forcesteering="this.assignedcontrolled.isclass.[class.ship_xs, class.ship_s, class.ship_m]"
					commandaction="false">
					<position value="$kAAIT_moveToPos"/>
					<interrupt>
						<conditions>
							<event_object_destroyed object="$kAAIT_defensibleTarget"/>
							<check_any>
								<event_object_destroyed object="$kAAIT_defensibleTarget"/>
								<check_all>
									<event_object_attacked object="this.assignedcontrolled"/>
									<check_value value="$kAAIT_defensibleTarget.isclass.ship" />
									<check_value value="this.assignedcontrolled.shieldpercentage lt 25"/>
									<check_value value="this.assignedcontrolled.hullpercentage lt 25"/>
								</check_all>
							</check_any>
						</conditions>
						<actions>
							<debug_text text="this.assignedcontrolled.idcode + ' step forward/withdraw cancelled! (2)'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
							<debug_text text="this.assignedcontrolled.idcode + ' this.assignedcontrolled.shieldpercentage: ' + @this.assignedcontrolled.shieldpercentage" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
							<debug_text text="this.assignedcontrolled.idcode + ' this.assignedcontrolled.hullpercentage: ' + @this.assignedcontrolled.hullpercentage" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
						</actions>
					</interrupt>
				</move_to>
				<do_if value="@$kAAITParam_data">
					<remove_value name="$kAAITParam_data.$orderLocation_space" />
					<remove_value name="$kAAITParam_data.$orderLocation_pos" />
				</do_if>
				<resume label="finish" />
			</do_if>
		</do_if>
	</add>
<!-- add after finish. purpose: clean-up.
	<label name="finish" />
-->
	<add pos="after" sel="//label[@name=&quot;finish&quot;]">
		<include_interrupt_actions ref="kAAIT_RemoveAttackerFromTarget" />
	</add>
	<!-- DeadAir Diffs -->
	<replace sel="/aiscript/params/param[@name='minrange']/@default">if @$target.iscapitalship or $target.isrealclass.station or $target.container.isrealclass.station then ([this.ship.maxcombatrange.all,this.assignedcontrolled.maxradarrange].min * 0.6) else ([this.ship.maxcombatrange.all,this.assignedcontrolled.maxradarrange].min * 0.3)</replace>
	<replace sel="/aiscript/params/param[@name='maxrange']/@default">if @$target.iscapitalship or $target.isrealclass.station or $target.container.isrealclass.station then ([this.ship.maxcombatrange.all,this.assignedcontrolled.maxradarrange].min * 0.9) else ([this.ship.maxcombatrange.all,this.assignedcontrolled.maxradarrange].min * 0.9)</replace>
	<remove sel="/aiscript/init/do_if[@value='this.isplayerowned']"/>
	<replace sel="/aiscript/attention/actions/do_if[@value='not $disable']/do_if[@value='this.ship.dps.missiles.all']">
		<do_elseif value="this.ship.dps.missiles.all">
			<set_value name="$bestquadrant" exact="quadrant.front"/>
			<set_value name="$frontweapon" exact="2"/>
		</do_elseif>
	</replace>
	<remove sel="/aiscript/attention/actions/do_if[@value='not @$frontweapon']"/>
	<replace sel="/aiscript/attention/actions/do_elseif[@value='@$frontweapon == 1']/set_value[@name='$minoperationalrange'][@exact='[this.assignedcontrolled.maxcombatrange.lasers.all * 0.6, $minrange].min']/@exact">if (@$isstation or @$target.iscapitalship) then ([this.assignedcontrolled.maxcombatrange.lasers.all,this.assignedcontrolled.maxradarrange].min * 0.6) else ([this.assignedcontrolled.maxcombatrange.lasers.all,this.assignedcontrolled.maxradarrange].min * 0.3)</replace>
	<replace sel="/aiscript/attention/actions/do_elseif[@value='@$frontweapon == 1']/set_value[@name='$maxoperationalrange'][@exact='[this.assignedcontrolled.maxcombatrange.lasers.all * 0.9, $maxrange].min']/@exact">([this.assignedcontrolled.maxcombatrange.lasers.all,this.assignedcontrolled.maxradarrange].min * 0.9)</replace>
	<replace sel="/aiscript/attention/actions/do_if[@value='$isstation']/set_value[@name='$quadrants'][@exact='[quadrant.left, quadrant.right, quadrant.up, quadrant.down, quadrant.back, quadrant.front]']/@exact">[quadrant.left, quadrant.right, quadrant.back, quadrant.front]</replace>
	<replace sel="/aiscript/attention/actions/do_else[2]/set_value[@name='$quadrants'][@exact='[quadrant.left, quadrant.right, quadrant.back]']/@exact">[quadrant.left, quadrant.right, quadrant.back, quadrant.front]</replace>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/set_value[@name='$maxeffectivecombatrange'][@exact='this.assignedcontrolled.maxcombatrange.all * 0.8']/@exact">$maxoperationalrange</replace>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_if[@value='this.assignedcontrolled.dps.lasers.all']">
		<set_value name="$aimdist" min="$minoperationalrange" max="$maxoperationalrange" profile="bell"/>
	</replace>
	<remove sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/set_value[@name='$aimdist'][@min='$maxeffectivecombatrange * (0.4 * (1.0 + (($skill_piloting + $skill_morale)f / 30.0)))']"/>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/set_value[@name='$movethreshold_min'][@exact='[$maxeffectivecombatrange * 0.5, $aimdist - 1m].min']/@exact">if ((@$target.order.id == 'Flee') or @$target.travel.active) then [$minoperationalrange * 0.75, $aimdist - 1m].min else ($minoperationalrange * 0.75)</replace>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/check_object/match_is_in_view_of/@vertical">150deg</replace>
	<add sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_if[@value='$distance ge $movethreshold_min']/move_to" type="@boost">false</add>
	<add sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_if[@value='$distance ge $movethreshold_min']/move_to" type="@travel">false</add>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_if[@value='$distance gt $movethreshold_max or $distance lt $movethreshold_min']/get_safe_pos/@allowyaxis">true</replace>
	<add sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_if[@value='$distance gt $movethreshold_max or $distance lt $movethreshold_min']/do_if[@value='$distance gt $movethreshold_max']/create_position[@name='$locpos']" pos="before">
		<create_position name="$targetposition" space="$target.sector" object="$target"/>
	</add>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_if[@value='$distance gt $movethreshold_max or $distance lt $movethreshold_min']/do_else[2]/set_value[@name='$boost']/@chance">if (this.assignedcontrolled.shieldpercentage gt 75) then $allowboost * 100 else 0</replace>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_elseif[@value='$distance le $movethreshold_max and $distance ge $movethreshold_min']/do_if[@value='@$holdposition']/set_value[@name='$time_waitend'][@exact='player.age + (($updatetime * 4) / (16 - $skill_morale))']/@exact">player.age + (($updatetime * 4) / (16 - [$skill_morale,9].max))</replace>
	<remove sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_elseif[@value='$distance le $movethreshold_max and $distance ge $movethreshold_min']/do_if[@value='not ($isstation or $frontweapon?)']/@chance"/>
	<add sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_else[2]/move_to" type="@boost">false</add>
	<add sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_else[2]/move_to" type="@travel">false</add>
	<add sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_else[2]/set_value[@name='$distfactor'][@exact='($maxeffectivecombatrange - $distance) / $distance ']" pos="before">
		<set_value name="$distance" exact="this.assignedcontrolled.bboxdistanceto.{$target}"/>
	</add>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_else[2]/set_value[@name='$boost']/@chance">if (this.assignedcontrolled.shieldpercentage gt 75) then ($allowboost * 100) else 0</replace>
	<remove sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_else/do_else/do_else/get_safe_pos/@direction"/>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_else/do_else/do_else/get_safe_pos/@directionobject">this.ship</replace>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_else/do_else/do_else/get_safe_pos/@allowyaxis">true</replace>
	<add sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_else/do_else/do_else/get_safe_pos" type="@profile">bell</add>
	<remove sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_else[2]/get_safe_pos/@direction"/>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_else[2]/get_safe_pos/@directionobject">this.ship</replace>
	<add sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_else[2]/get_safe_pos" type="@profile">bell</add>
	<remove sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='(@$lastquadranttupdate lt player.age) and not @$frontweapon']/@chance"/>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='(@$lastquadranttupdate lt player.age) and not @$frontweapon']/set_value[@name='$lastquadranttupdate'][@exact='player.age + 30s']/@exact">player.age + 30s + (30s - (30*($combinedskill/100.0)))s</replace>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='(@$lastquadranttupdate lt player.age) and not @$frontweapon']/do_any">
		<set_value name="$weakquadrant" exact="$weakquadrants.{1}"/>
	</replace>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $boost? and $allowboost and ($combinedskill ge 80)']/@value">(not $boost? and $allowboost and (this.ship.bboxdistanceto.{$target} gt $maxoperationalrange or this.ship.bboxdistanceto.{$target} lt $minoperationalrange)) or ($allowboost and (this.ship.distanceto.[$target.sector, $pos] gt 15km) and (this.ship.bboxdistanceto.{$target} gt $maxoperationalrange or this.ship.bboxdistanceto.{$target} lt $minoperationalrange))</replace>
	<remove sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='(not $boost? and $allowboost and (this.ship.bboxdistanceto.{$target} gt $maxoperationalrange or this.ship.bboxdistanceto.{$target} lt $minoperationalrange)) or ($allowboost and (this.ship.distanceto.[$target.sector, $pos] gt 15km) and (this.ship.bboxdistanceto.{$target} gt $maxoperationalrange or this.ship.bboxdistanceto.{$target} lt $minoperationalrange))']/@chance"/>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='$boost?']/do_if[@value='(this.assignedcontrolled.shieldpercentage gt 50) and this.assignedcontrolled.boost.maxduration']/@value">(this.assignedcontrolled.shieldpercentage gt 75) and (this.assignedcontrolled.boost.maxduration)</replace>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='$boost?']/do_if[@value='(this.assignedcontrolled.shieldpercentage gt 75) and (this.assignedcontrolled.boost.maxduration)']/set_value[@name='$updatetime'][@exact='(this.assignedcontrolled.boost.maxduration * (this.assignedcontrolled.shieldpercentage / 100.0) * 0.5)s']/@exact">(this.assignedcontrolled.boost.maxduration * (this.assignedcontrolled.shieldpercentage / 100.0) * 0.25)s</replace>
	<add sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='this.ship.sector == $target.sector']/do_if[@value='$strafe?']/move_strafe" type="@boost">false</add>
	<add sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='this.ship.sector == $target.sector']/do_if[@value='$strafe?']/move_strafe" type="@travel">false</add>
</diff>
