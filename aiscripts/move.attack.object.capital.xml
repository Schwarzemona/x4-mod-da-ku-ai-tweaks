<?xml version="1.0" encoding="utf-8" ?>
<diff>
<!-- add. purpose: data store
	<params>
-->
	<add sel="//params">
		<param name="kAAITParam_isAvoidHighRisk" required="false" default="null" type="internal" />
		<param name="kAAITParam_isStepForwardWithdraw" required="false" type="internal" text="{1111920, 109}" default="false" />
	</add>
<!-- add before at 3 x move_to and 1 x move_strafe. purpose: debug.
	<move_to>
-->
	<add pos="before" sel="(//move_to)[1]">
		<do_if value="(@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw) and @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isTargetPotentialHighRisk">
			<debug_text text="@this.assignedcontrolled.idcode + ' move_to (1) rotate to aim'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		</do_if>
	</add>
	<add pos="before" sel="(//move_to)[2]">
		<do_if value="(@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw) and @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isTargetPotentialHighRisk">
			<debug_text text="@this.assignedcontrolled.idcode + ' move_to (2) rotate to look away'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		</do_if>
	</add>
	<add pos="before" sel="//move_strafe">
		<do_if value="(@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw) and @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isTargetPotentialHighRisk">
			<debug_text text="@this.assignedcontrolled.idcode + ' move_strafe'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		</do_if>
	</add>
	<add pos="before" sel="(//move_to)[3]">
		<do_if value="(@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw) and @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isTargetPotentialHighRisk">
			<debug_text text="@this.assignedcontrolled.idcode + ' move_to (3) short attack move'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		</do_if>
	</add>
<!-- add. purpose: add handlers.
	<interrupts>
-->
	<add pos="prepend" sel="//interrupts">
		<handler ref="kAAIT_CheckVersion" />
		<handler ref="kAAIT_Handler_AvoidWithdrawOrJustFight" />
		<handler ref="kAAIT_Handler_NewBigTarget" />
		<handler ref="kAAIT_Handler_DebugWithdraw" />
	</add>
<!-- add.
-->
	<add pos="prepend" sel="//interrupts">
		<library>
			<actions name="kAAIT_GetIsMoveToEngage">
				<set_value name="$kAAIT_result_isMovetoEngage" exact="false" />
				<do_if value="
					(
						this.assignedcontrolled.type != shiptype.carrier or
						(
							(
								this.isplayerowned and
								global.$kAAIT_Data.$isCarriersAttackLikeDestroyers
							) or
							(
								(not this.isplayerowned) and
								global.$kAAIT_Data.$isCarriersAttackLikeDestroyers_allFactions
							)
						)
					) and
					(@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isTargetHighRisk or @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isTargetPotentialHighRisk) and
					(not @$primarytarget.travel.active) and
					(not @$target.travel.active)
				">
					<set_value name="$kAAIT_distToTarget" exact="this.assignedcontrolled.bboxdistanceto.{$target}" />
					<set_value name="$kAAIT_engagePosDist" exact="
						[
							this.assignedcontrolled.maxradarrange * 0.5,
							$target.size * 0.5 + global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_max * global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$skill_distance_engagePosition_mult
						].min" />
					<do_if value="$target.isrealclass.module and $target != @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$moduleTarget">
						<set_value name="$kAAIT_result_isMovetoEngage" exact="true" />
					</do_if>
					<do_elseif value="
						global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget != @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget_stoppedKamikaze and
						(
							(
								global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget.isclass.station and
								$kAAIT_distToTarget gt $kAAIT_engagePosDist + 10km
							) or
							(
								global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget.isclass.ship and
								(not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget.isclass.ship.travel.active) and
								$kAAIT_distToTarget gt $kAAIT_engagePosDist + 10km
							)
						)
					">
						<set_value name="$kAAIT_result_isMovetoEngage" exact="true" />
					</do_elseif>
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsMoveToEngage $kAAIT_result_isMovetoEngage: ' + $kAAIT_result_isMovetoEngage" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
			</actions>
			<actions name="kAAIT_GetIsTargetBlocked">
				<set_value name="$kAAIT_test_target_isInTheWay" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget" />
				<include_interrupt_actions ref="kAAIT_GetIsTargetInTheWay" />
				<remove_value name="$kAAIT_test_target_isInTheWay" />
				<set_value name="$isTargetBlocked" exact="$kAAIT_result_isTargetInTheWay" />
				<remove_value name="$kAAIT_result_isTargetInTheWay" />
			</actions>
		</library>
	</add>
<!-- add prepend. purpose: init var.
	<init>
-->
	<add pos="prepend" sel="//init">
		<debug_text text="@this.assignedcontrolled.idcode + ' EVENT init'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
<!-- add prepend. purpose: init.
	<attention min="unknown">
-->
	<add pos="prepend" sel="//attention[@min=&quot;unknown&quot;]">
		<do_if value="(@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw)">
			<include_interrupt_actions ref="kAAIT_Init" />
		</do_if>
		<do_if value="(@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw) and (not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isIgnoreKAAIT)">
			<include_interrupt_actions ref="kAAIT_AddAttackerToTarget" />
		</do_if>
	</add>
<!-- replace 2 instances.
	purpose: $iscarrier behaviour is true if shiptype.carrier AND has subordinates or has a wingmate that is a capital ship.
	i.e. base-game implementation sets iscarrier to true ONLY if subordinates are dockable on the carrier.
	therefore: base-game implementation will put carrier in danger even if its subordinates are captial ships that do not dock on the carrier.
	kuda's implementation makes it so that carriers never attack like destroyers UNLESS it has no more subordinates or it has no capital ship wingmate.
	1st instance:
	<set_value name="$iscarrier" exact="false"/>
	<do_if value="this.assignedcontrolled.type == shiptype.carrier">
		<do_for_each name="$locsub" in="this.assignedcontrolled.subordinates">
			...
-->
	<replace sel="//set_value[@name=&quot;$iscarrier&quot;][@exact=&quot;false&quot;]/following-sibling::do_if[@value=&quot;this.assignedcontrolled.type == shiptype.carrier&quot;]/do_for_each[@name=&quot;$locsub&quot;][@in=&quot;this.assignedcontrolled.subordinates&quot;]">
		<set_value name="$iscarrier" exact="this.assignedcontrolled.subordinates.count" />
		<do_if value="(not $iscarrier) and @this.assignedcontrolled.commander.subordinates.count">
			<do_for_each name="$wingmate" in="this.assignedcontrolled.commander.subordinates">
				<do_if value="$wingmate.iscapitalship">
					<set_value name="$iscarrier" exact="true" />
					<break />
				</do_if>
			</do_for_each>
		</do_if>
	</replace>
<!-- 2nd instance:
	remove:
	<do_if value="$iscarrier">
		<set_value name="$iscarrier" exact="false"/>
		<do_for_each name="$locsub" in="this.assignedcontrolled.subordinates">
	replace:
	<do_if value="$iscarrier">
		<set_value name="$iscarrier" exact="false"/>
-->
	<remove sel="//do_if[@value=&quot;$iscarrier&quot;]/set_value[@name=&quot;$iscarrier&quot;][@exact=&quot;false&quot;]/following-sibling::do_for_each[@name=&quot;$locsub&quot;][@in=&quot;this.assignedcontrolled.subordinates&quot;]" />
	<replace sel="//do_if[@value=&quot;$iscarrier&quot;]/set_value[@name=&quot;$iscarrier&quot;][@exact=&quot;false&quot;]">
		<set_value name="$iscarrier" exact="this.assignedcontrolled.subordinates.count" />
		<do_if value="(not $iscarrier) and @this.assignedcontrolled.commander.subordinates.count">
			<do_for_each name="$wingmate" in="this.assignedcontrolled.commander.subordinates">
				<do_if value="$wingmate.iscapitalship">
					<set_value name="$iscarrier" exact="true" />
					<break />
				</do_if>
			</do_for_each>
		</do_if>
	</replace>
<!-- add before. purpose: change $maintaindistance
	<do_if value="$iscarrier and $maintaindistance">
-->
	<add pos="before" sel="//do_if[@value=&quot;$iscarrier and $maintaindistance&quot;]">
		<do_if value="$iscarrier">
			<do_if value="
				(this.isplayerowned and @global.$kAAIT_Data.$isCarriersAttackLikeDestroyers) or
				((not this.isplayerowned) and @global.$kAAIT_Data.$isCarriersAttackLikeDestroyers_allFactions)
			">
				<set_value name="$maintaindistance" exact="false" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $maintaindistance: ' + $maintaindistance" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
			</do_if>
		</do_if>
	</add>
<!-- add before. purpose: custom behaviours.
	<label name="fight" />
-->
	<add pos="before" sel="//label[@name=&quot;fight&quot;]">
		<resume label="fight" />

		<label name="kAAIT_label_move_to_engage_position" />
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL kAAIT_label_move_to_engage_position'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<set_value name="$kAAIT_engagePosDist" exact="$target.size * 0.5 + global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_max * global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$skill_distance_engagePosition_mult" />
		<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid" exact="$target" />
		<include_interrupt_actions ref="kAAIT_Order_MoveToEngagePosition" />
		<wait min="(0.5)s" max="(1.0)s" />
		<resume label="fight" />

		<label name="kAAIT_label_step_forward" />
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL kAAIT_label_step_forward'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<set_value name="$isTargetBlocked" exact="false" />
		<do_if value="
			$target.isrealclass.module and
			$target != global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$moduleTarget
		" comment="can move to engage instead of step forward">
			<include_interrupt_actions ref="kAAIT_GetIsTargetBlocked" />
		</do_if>
		<do_if value="@$isTargetBlocked">
			<resume label="kAAIT_label_move_to_engage_position" />
		</do_if>
		<do_else>
			<create_order object="this.assignedcontrolled" id="'kAAIT_MoveStepForward'" immediate="true">
				<param name="target" value="$target" />
			</create_order>
			<wait min="(0.5)s" max="(1.0)s" />
		</do_else>
		<resume label="fight" />

		<label name="kAAIT_label_avoid" />
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL kAAIT_label_avoid'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<include_interrupt_actions ref="kAAIT_Order_Avoid" />
		<wait min="(0.5)s" max="(1.0)s" />
		<resume label="fight" />
	</add>
<!-- add after. purpose: determine custom behaviours.
	<label name="fight" />
-->
	<add pos="after" sel="//label[@name=&quot;fight&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL fight'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<do_if value="@$kAAITParam_isAvoidHighRisk and (not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isIgnoreKAAIT)">
			<set_value name="$kAAIT_test_target_isAvoid" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget" />
			<include_interrupt_actions ref="kAAIT_AvoidOrNot" />
			<do_if value="@$kAAIT_result_avoidEnemy.isoperational"/>
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid" exact="$kAAIT_result_avoidEnemy" />
				<resume label="kAAIT_label_avoid" />
			</do_if>
			<do_elseif value="@$kAAIT_result_withdrawFromEnemy.isoperational"/>
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid" exact="$kAAIT_result_withdrawFromEnemy" />
				<resume label="kAAIT_label_withdraw" />
			</do_elseif>
		</do_if>
		<do_if value="@$kAAITParam_isStepForwardWithdraw and (not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isIgnoreKAAIT)">
			<include_interrupt_actions ref="kAAIT_GetIsMoveToEngage" />
			<do_if value="$kAAIT_result_isMovetoEngage">
				<resume label="kAAIT_label_move_to_engage_position" />
			</do_if>
		</do_if>

		<label name="kAAIT_label_just_fight" />
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL kAAIT_label_just_fight'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<do_if value="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_space?">
			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_space" />
			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_pos" />
		</do_if>
	</add>
<!-- add after. purpose: hijack effective range and move thresholds to limit the ship's movements to step forward or withdraw behaviours.
	<set_value name="$movethreshold_max" exact="$maxeffectivecombatrange"/>
-->
	<add pos="after" sel="//set_value[@name=&quot;$movethreshold_max&quot;][@exact=&quot;$maxeffectivecombatrange&quot;]">
		<set_value name="$movethreshold_min_orig" exact="$movethreshold_min"/>
		<set_value name="$movethreshold_max_orig" exact="$movethreshold_max"/>
		<do_if value="(@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw) and (not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isIgnoreKAAIT)">
			<!-- <do_if value="not global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_min?">
				<include_interrupt_actions ref="kAAIT_GetCombatRange" />
			</do_if> -->
			<set_value name="$movethreshold_min" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_min"/>
			<set_value name="$movethreshold_max" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_max"/>
		</do_if>
	</add>
<!-- add prepend. purpose: debug.
	<do_if value="$distance gt $movethreshold_max or $distance lt $movethreshold_min">
-->
	<add pos="before" sel="//do_if[@value=&quot;$distance gt $movethreshold_max or $distance lt $movethreshold_min&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' $movethreshold_min_orig: ' + $movethreshold_min_orig + ' $movethreshold_min: ' + $movethreshold_min" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<debug_text text="@this.assignedcontrolled.idcode + ' $distance: ' + $distance" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<debug_text text="@this.assignedcontrolled.idcode + ' $movethreshold_max_orig: ' + $movethreshold_max_orig + ' $movethreshold_max: ' + $movethreshold_max" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
	<add pos="prepend" sel="//do_if[@value=&quot;$distance gt $movethreshold_max or $distance lt $movethreshold_min&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' OUT OF MOVE THRESHOLDS'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
	<add pos="prepend" sel="//do_elseif[@value=&quot;$distance le $movethreshold_max and $distance ge $movethreshold_min&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' WITHIN MOVE THRESHOLDS'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
<!-- add before. purspoe: step forward after wait.
	<wait exact="$updatetime">
-->
	<add pos="after" sel="//wait[@exact=&quot;$updatetime&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' WAIT COMPLETE'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<do_if value="@$kAAITParam_isStepForwardWithdraw and @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isTargetHighRisk and (not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isIgnoreKAAIT)">
			<set_value name="$time_nextStepForward" exact="1min" />
			<do_if value="$target.isclass.ship">
				<set_value name="$time_nextStepForward" exact="30s" />
			</do_if>
			<do_if value="
				$target.isclass.[class.ship_l, class.ship_xl, class.station] and
				player.age - @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$time_lastStepForward gt $time_nextStepForward
			">
				<set_value name="$kAAIT_distToTarget" exact="this.assignedcontrolled.bboxdistanceto.{$target}" />
				<do_if value="
					(
						($target.isclass.station or $target.defensible.isclass.station) and
						$kAAIT_distToTarget gt global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_min
					) or
					(
						$target.isclass.ship and
						$kAAIT_distToTarget gt global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_max * 2
					)
				">
					<do_if value="
						this.assignedcontrolled.type != shiptype.carrier or
						(
							(
								this.isplayerowned and
								global.$kAAIT_Data.$isCarriersAttackLikeDestroyers
							) or
							(
								(not this.isplayerowned) and
								global.$kAAIT_Data.$isCarriersAttackLikeDestroyers_allFactions
							)
						)
					">
						<resume label="kAAIT_label_step_forward" />
					</do_if>
				</do_if>
			</do_if>
		</do_if>
	</add>
<!-- add before. purpose: debug.
	<do_else>
		<set_value name="$case" exact="'1.1.3: cap v cap, front-mounted, retreat'"/>
-->
	<!-- <add pos="before" sel="//set_value[@name=&quot;$case&quot;][@exact=&quot;'1.1.3: cap v cap, front-mounted, retreat'&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' TOO NEAR TARGET'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
	</add> -->
<!-- add after 2nd instance. purpose: if chasing small ships near big enemy, move away.
	<get_safe_pos result="$pos" object="$target" min="$minoperationalrange" max="$maxoperationalrange" sector="$target.sector" direction="$weakquadrant" directionobject="$target" radius="this.ship.size/2.0" ignored="this.ship"/>
-->
	<add pos="after" sel="(//get_safe_pos[@result=&quot;$pos&quot;][@object=&quot;$target&quot;][@min=&quot;$minoperationalrange&quot;][@max=&quot;$maxoperationalrange&quot;][@sector=&quot;$target.sector&quot;][@direction=&quot;$weakquadrant&quot;][@directionobject=&quot;$target&quot;][@radius=&quot;this.ship.size/2.0&quot;][@ignored=&quot;this.ship&quot;])[2]">
		<do_if value="@$kAAITParam_isStepForwardWithdraw and @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isTargetHighRisk and (not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isIgnoreKAAIT)">
			<include_interrupt_actions ref="kAAIT_GetBigEnemies" />
			<include_interrupt_actions ref="kAAIT_GetIsNearBigEnemies" />
			<do_if value="@$kAAIT_result_bigEnemy != global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget">
				<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_result_bigEnemy (too near): ' + @$kAAIT_result_bigEnemy.knownname + ' ' + @$kAAIT_result_bigEnemy.idcode" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
				<resume label="kAAIT_label_withdraw" />
			</do_if>
		</do_if>
	</add>
<!-- add after. purpose: debug.
	<do_if value="this.ship.bboxdistanceto.{$target} ge $minoperationalrange and this.ship.bboxdistanceto.{$target} le $maxoperationalrange">
-->
	<add pos="before" sel="//do_if[@value=&quot;this.ship.bboxdistanceto.{$target} ge $minoperationalrange and this.ship.bboxdistanceto.{$target} le $maxoperationalrange&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' this.assignedcontrolled.bboxdistanceto.{$target}: ' + this.assignedcontrolled.bboxdistanceto.{$target}" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<debug_text text="@this.assignedcontrolled.idcode + ' $minoperationalrange: ' + $minoperationalrange" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<debug_text text="@this.assignedcontrolled.idcode + ' $maxoperationalrange: ' + $maxoperationalrange" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
<!-- add before. purpose: debug.
	<remove_value name="$tempoffset"/>
-->
	<add pos="before" sel="//remove_value[@name=&quot;$tempoffset&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' this.assignedcontrolled.bboxdistanceto.[$target, $tempoffset]: ' + this.assignedcontrolled.bboxdistanceto.[$target, $tempoffset]" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<debug_text text="@this.assignedcontrolled.idcode + ' this.assignedcontrolled.bboxdistanceto.[$target.sector, $pos]: ' + this.assignedcontrolled.bboxdistanceto.[$target.sector, $pos]" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
<!-- add before. purpose: if primarypurpose != fight, stay away from target
	<do_if value="this.ship.sector == $target.sector">
		...
		<do_if value="$strafe?">
-->
	<add pos="before" sel="//do_if[@value=&quot;this.ship.sector == $target.sector&quot;]//do_if[@value=&quot;$strafe?&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' $case: ' + $case" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<debug_text text="@this.assignedcontrolled.idcode + ' this.assignedcontrolled.bboxdistanceto.[$target, $pos]: ' + this.assignedcontrolled.bboxdistanceto.[$target, $pos]" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
	<!-- <add pos="before" sel="//do_if[@value=&quot;this.ship.sector == $target.sector&quot;]//do_if[@value=&quot;$strafe?&quot;]">
		<do_if value="(@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw) and @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isTargetHighRisk and (not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isIgnoreKAAIT)">
			<do_if value="this.assignedcontrolled.primarypurpose != purpose.fight" comment="if not primarypurpose fight, then keep away from target">
				<debug_text text="@this.assignedcontrolled.idcode + ' this.assignedcontrolled.primarypurpose (keep away from target): ' + this.assignedcontrolled.primarypurpose" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
				<create_orientation name="$kAAIT_rotFromTarget" orientation="look_at" refobject="this.assignedcontrolled">
					<position object="$target" />
				</create_orientation>
				<set_value name="$kAAIT_distAvoid" exact="this.assignedcontrolled.maxradarrange * 0.5" />
				<create_position name="$pos"
					x="$target.position.x + $kAAIT_distAvoid * sin ($kAAIT_rotFromTarget.yaw) * cos ($kAAIT_rotFromTarget.pitch)"
					y="$target.position.y + $kAAIT_distAvoid * sin ($kAAIT_rotFromTarget.pitch)"
					z="$target.position.z + $kAAIT_distAvoid * cos ($kAAIT_rotFromTarget.yaw) * cos ($kAAIT_rotFromTarget.pitch)"
				/>
			</do_if>
		</do_if>
	</add> -->
<!-- add after. purpose: step_forward after attack run.
	<do_if value="this.ship.sector == $target.sector">
		...
		<do_if value="@$boost">
-->
	<add pos="after" sel="//do_if[@value=&quot;this.ship.sector == $target.sector&quot;]/do_if[@value=&quot;@$boost&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' ATTACK CYCLE COMPLETE'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<do_if value="@$kAAITParam_isStepForwardWithdraw and @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isTargetHighRisk and (not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isIgnoreKAAIT)">
			<set_value name="$time_nextStepForward" exact="1min" />
			<do_if value="$target.isclass.ship">
				<set_value name="$time_nextStepForward" exact="10s" />
			</do_if>
			<do_if value="
				$target.isclass.[class.ship_l, class.ship_xl, class.station] and
				player.age - @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$time_lastStepForward gt $time_nextStepForward
			">
				<set_value name="$kAAIT_distToTarget" exact="this.assignedcontrolled.bboxdistanceto.{global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget}" />
				<do_if value="$kAAIT_distToTarget gt global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_max * 2">
					<do_if value="
						this.assignedcontrolled.type != shiptype.carrier or
						(
							(
								this.isplayerowned and
								global.$kAAIT_Data.$isCarriersAttackLikeDestroyers
							) or
							(
								(not this.isplayerowned) and
								global.$kAAIT_Data.$isCarriersAttackLikeDestroyers_allFactions
							)
						)
					">
						<resume label="kAAIT_label_step_forward" />
					</do_if>
				</do_if>
			</do_if>
		</do_if>
	</add>
<!-- add before. purpose: withdraw.
	<label name="finish"/>
-->
	<add pos="before" sel="//label[@name=&quot;finish&quot;]">
		<resume label="finish"/>

		<label name="kAAIT_label_withdraw" />
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL kAAIT_label_withdraw'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<do_if value="(not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget.isoperational) and $kAAIT_attacker.isoperational">
			<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid" exact="$kAAIT_attacker" />
		</do_if>
		<do_else>
			<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget" />
		</do_else>
		<include_interrupt_actions ref="kAAIT_Order_Withdraw" />
		<wait min="(0.5)s" max="(1.0)s" />
		<resume label="finish"/>
	</add>
<!-- add after finish. purpose: clean-up.
	<label name="finish" />
-->
	<add pos="after" sel="//label[@name=&quot;finish&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL finish'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<include_interrupt_actions ref="kAAIT_RemoveAttackerFromTarget" />
		<do_if value="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_space?">
			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_space" />
			<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_pos" />
		</do_if>
	</add>
	<!--
		   db    88""Yb  dP"Yb  88""Yb 888888
		  dPYb   88__dP dP   Yb 88__dP   88
		 dP__Yb  88""Yb Yb   dP 88"Yb    88
		dP""""Yb 88oodP  YbodP  88  Yb   88
	 -->
<!-- add after. purpose: cleanup.
	<attention min="unknown">
-->
	<add pos="after" sel="//attention[@min=&quot;unknown&quot;]">
		<on_abort>
			<include_interrupt_actions ref="kAAIT_RemoveAttackerFromTarget" />
			<do_if value="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_space?">
				<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_space" />
				<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_pos" />
			</do_if>
		</on_abort>
	</add>
	<!-- DEADAIR DIFFS APPLIED AFTER KUERTEE CHANGES -->
	<replace sel="/aiscript/attention/actions/set_value[@name='$combinedskill'][@exact='this.assignedcontrolled.combinedskill']/@exact">if global.$DATPilotSkillTweaks then 100 else this.assignedcontrolled.combinedskill</replace>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_if[@value='$distance gt $movethreshold_max or $distance lt $movethreshold_min']/do_else/set_value[@name='$boost']/@chance">if this.isplayerowned then ([global.$DATPlayerAllowBoost,$allowboost].min * 100) else ($allowboost * 100)</replace>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_else[2]/set_value[@name='$boost']/@chance">if this.isplayerowned then ([global.$DATPlayerAllowBoost,$allowboost].min * 100) else ($allowboost * 100)</replace>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $boost? and $allowboost and ($combinedskill ge 80)']/@value">((not $boost?) or (global.$DATTravelTweaks)) and ($allowboost) and ($combinedskill ge 80)</replace>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='((not $boost?) or (global.$DATTravelTweaks)) and ($allowboost) and ($combinedskill ge 80)']/do_if[@value='$timetopos gt 120s']/@value">$timetopos ge (if global.$DATTravelTweaks then 60s else 120s)</replace>
	<add sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='((not $boost?) or (global.$DATTravelTweaks)) and ($allowboost) and ($combinedskill ge 80)']">
		<do_if value="global.$DATTravelTweaks and @$travel and (this.assignedcontrolled.bboxdistanceto.{$target} le [@$movethreshold_max,@$maxoperationalrange].max)">
			<remove_value name="$travel"/>
		</do_if>
	</add>
	<add sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='$boost?']/do_if[@value='(this.assignedcontrolled.shieldpercentage gt 50) and this.assignedcontrolled.boost.maxduration']" type="@chance">if (this.isplayerowned and (not global.$DATPlayerAllowBoost)) then 0 else 100</add>
	<!-- DAT Reposition for LOS -->
	<add sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_elseif[@value='$distance le $movethreshold_max and $distance ge $movethreshold_min']/do_if[@value='this.assignedcontrolled.attention ge attention.visible']/remove_value[@name='$isinview']" pos="before">
		<do_if value="global.$DATAttackStationLOSTweak">
			<!-- Since below is a resume label, best place to clean up is at beginning for reduced code amount -->
			<!-- Changed debug chance to "if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else $debugchance" -->
			<remove_value name="$DATThisPosSector"/>
			<remove_value name="$DATEnemyPosSector"/>
			<remove_value name="$DATThisPosZone"/>
			<remove_value name="$DATEnemyPosZone"/>
			<remove_value name="$DATRot"/>
			<remove_value name="$DATRotAdjusted"/>
			<remove_value name="$DATmaxeffectivecombatrange"/>
			<remove_value name="$DATRePos"/>
			<remove_value name="$DATRePosRot"/>
			<remove_value name="$DATBeacon"/>
			<remove_value name="$DATRePosShipRot"/>
			<remove_value name="$DATupdatetime"/>
			<remove_value name="$DAlos"/>
			<remove_value name="$DAisinview"/>
			<!-- Onto the actual scripting -->
			<set_value name="$DATRepositionForLOS" exact="false"/>
			<do_if value="(not @$los) and @$isinview and @$isstation and (this.assignedcontrolled.sector == $target.sector)">
				<set_value name="$DATRepositionForLOS" exact="true"/>
				<!-- Ships are repositioning when they shouldn't, LOS is pretty unreliable -->
				<check_line_of_sight name="$DAlos" object="this.assignedcontrolled" target="$target"/>
				<check_object result="$DAisinview" object="$target">
					<match_is_in_view_of vertical="9deg" horizontal="9deg" object="this.assignedcontrolled"/>
				</check_object>
				<do_if value="@$DAlos and @$DAisinview">
					<set_value name="$DATRepositionForLOS" exact="false"/>
					<set_value name="$holdposition"/>
					<set_value name="$DATRepositionCounter" exact="0"/>
				</do_if>
				<do_else>
					<set_value name="$DATRepositionCounter" exact="1" operation="add"/>
				</do_else>
				<debug_text text="'MOD: DAT -- move.attack.object.capital -- %s (%s) -- (not $los) and $isinview'.[this.ship.knownname,this.ship.idcode]" context="false" filter="scripts" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else $debugchance"/>
				<!-- Sector Positions -->
				<create_position name="$DATThisPosSector" space="$target.sector" object="this.ship"/>
				<create_position name="$DATEnemyPosSector" space="$target.sector" object="$target"/>
				<!-- Zone Positions -->
				<create_position name="$DATThisPosZone" space="this.zone" x="$DATThisPosSector.x" y="$DATThisPosSector.y" z="$DATThisPosSector.z" object="this.assignedcontrolled.sector"/>
				<create_position name="$DATEnemyPosZone" space="$target.zone" x="$DATEnemyPosSector.x" y="$DATEnemyPosSector.y" z="$DATEnemyPosSector.z" object="$target.sector"/>
				<!-- Transform 15 Deg -->
				<create_orientation name="$DATRot" refposition="$DATThisPosZone" orientation="look_at">
					<position value="$DATEnemyPosZone"/>
				</create_orientation>
				<debug_text text="'MOD: DAT -- move.attack.object.capital -- %s (%s) -- original yaw: %s (%s) -- pitch: %s (%s) -- roll: %s (%s) -- distance: %s'.[this.ship.knownname,this.ship.idcode,$DATRot.yaw,$DATRot.yaw * 180 / pi,$DATRot.pitch,$DATRot.pitch * 180 / pi,$DATRot.roll,$DATRot.roll * 180 / pi,$target.distanceto.{this.assignedcontrolled}]" context="false" filter="scripts" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else $debugchance"/>
				<set_value name="$DATRotAdjusted" exact="rotation.[$DATRot.yaw + 15deg,$DATRot.pitch,$DATRot.roll]"/>
				<set_value name="$DATmaxeffectivecombatrange" exact="this.assignedcontrolled.maxcombatrange.all * 0.8"/>
				<do_if value="this.assignedcontrolled.dps.lasers.all">
					<set_value name="$DATmaxeffectivecombatrange" exact="this.assignedcontrolled.maxcombatrange.lasers.all * 0.8"/>
				</do_if>
				<transform_position name="$DATRePos" refposition="$DATEnemyPosZone" refrotation="$DATRotAdjusted">
					<position z="$DATmaxeffectivecombatrange"/>
				</transform_position>
				<create_orientation name="$DATRePosRot" refposition="$DATRePos" orientation="look_at">
					<position value="$DATEnemyPosZone"/>
				</create_orientation>
				<debug_text text="'MOD: DAT -- move.attack.object.capital -- %s (%s) -- adjusted yaw: %s (%s) -- pitch: %s (%s) -- roll: %s (%s) -- distance: %s'.[this.ship.knownname,this.ship.idcode,$DATRePosRot.yaw,$DATRePosRot.yaw * 180 / pi,$DATRePosRot.pitch,$DATRePosRot.pitch * 180 / pi,$DATRePosRot.roll,$DATRePosRot.roll * 180 / pi,$target.distanceto.[$target.zone,$DATRePos]]" context="false" filter="scripts" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else $debugchance"/>
				<!-- Handle obstructions or obstacles? -->
				<!-- Move -->
				<do_if value="$DATRePos? and (@$DATRePos != null) and this.assignedcontrolled.maxspeed and ((this.assignedcontrolled.zone == $target.zone) or (this.assignedcontrolled.bboxdistanceto.{$target} le this.assignedcontrolled.maxradarrange)) and @$DATRepositionForLOS and (@$DATRepositionCounter ge 3)">
					<!-- reset counter -->
					<set_value name="$DATRepositionCounter" exact="0"/>
					<!-- Custom update time -->
					<!-- might need to account for rotation time to target -->
					<!-- adding 50% to time to account for rotation -->
					<set_value name="$DATupdatetime" exact="(this.assignedcontrolled.distanceto.[$target.zone, $DATRePos] / [this.assignedcontrolled.maxspeed, 1m].max)s * 1.5"/>
					<!-- <do_if value="true" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else $debugchance"> -->
					<do_if value="true">
						<!-- Create beacon for testing -->
						<create_object name="$DATBeacon" zone="$target.zone" macro="macro.env_deco_nav_beacon_t1_macro" owner="faction.player">
							<position value="$DATRePos"/>
						</create_object>
						<set_object_name object="$DATBeacon" name="'000 - %s (%s) Rot Beacon vs %s'.[this.assignedcontrolled.knownname,this.assignedcontrolled.idcode,$target.knownname]"/>
					</do_if>
					<move_to destination="$target.zone" abortpath="false" object="this.assignedcontrolled" finishonapproach="false" forceposition="false" forcerotation="false" uselocalhighways="false" boost="false" travel="false" chance="(@$DATRepositionForLOS and @$DATupdatetime) * 100">
						<position value="$DATRePos"/>
						<interrupt_after_time time="if $DATupdatetime? then $DATupdatetime else 1s"/>
						<interrupt>
							<conditions>
								<check_any>
									<event_object_destroyed object="$target"/>
									<check_all>
										<event_object_attacked object="this.assignedcontrolled"/>
										<check_value value="not this.assignedcontrolled.maxspeed"/>
									</check_all>
								</check_any>
							</conditions>
						</interrupt>
					</move_to>
					<do_if value="@$DATBeacon.exists">
						<destroy_object object="$DATBeacon" />
					</do_if>
					<do_if value="@$DATRepositionForLOS and @$DATupdatetime">
						<debug_text text="'MOD: DAT -- move.attack.object.capital -- %s (%s) -- Move Complete'.[this.ship.knownname,this.ship.idcode]" context="false" filter="scripts" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else $debugchance"/>
					</do_if>
					<resume label="fight" chance="@$DATRepositionForLOS * 100"/>
				</do_if>
				<do_else>
					<do_if value="not this.assignedcontrolled.maxspeed">
						<debug_text text="'MOD: DAT -- move.attack.object.capital -- Error Moving: No Engines -- %s (%s) -- this.assignedcontrolled.maxspeed: %s '.[this.ship.knownname,this.ship.idcode,this.assignedcontrolled.maxspeed]" context="false" filter="error" chance="100"/>
						<set_value name="$DATRepositionCounter" exact="0"/>
					</do_if>
					<do_elseif value="not ((this.assignedcontrolled.zone == $target.zone) or (this.assignedcontrolled.bboxdistanceto.{$target} le this.assignedcontrolled.maxradarrange))">
						<debug_text text="'MOD: DAT -- move.attack.object.capital -- Error Moving: Too Far -- %s (%s) -- (this.assignedcontrolled.zone == $target.zone): %s -- (this.assignedcontrolled.bboxdistanceto.{$target} le this.assignedcontrolled.maxradarrange): %s'.[this.ship.knownname,this.ship.idcode,(this.assignedcontrolled.zone == $target.zone),(this.assignedcontrolled.bboxdistanceto.{$target} le this.assignedcontrolled.maxradarrange)]" context="false" filter="error" chance="100"/>
						<set_value name="$DATRepositionCounter" exact="0"/>
					</do_elseif>
					<do_elseif value="((@$DATRepositionForLOS) and (@$DATRepositionCounter lt 3)) or ((not @$DATRepositionForLOS) and (@$DAlos and @$DAisinview))">
						<debug_text text="'MOD: DAT -- move.attack.object.capital -- Not Moving (Expected) -- %s (%s) -- @$DATRepositionForLOS: %s -- @$DATRepositionCounter: %s -- @$DAlos: %s -- @$DAisinview: %s'.[this.ship.knownname,this.ship.idcode,@$DATRepositionForLOS,@$DATRepositionCounter,@$DAlos,@$DAisinview]" context="false" filter="scripts" chance="100"/>
					</do_elseif>
					<do_else>
						<debug_text text="'MOD: DAT -- move.attack.object.capital -- Error Moving: Unhandled -- %s (%s) -- $DATRePos?: %s -- (@$DATRePos != null): %s -- this.assignedcontrolled.maxspeed: %s -- (this.assignedcontrolled.zone == $target.zone): %s -- (this.assignedcontrolled.bboxdistanceto.{$target} le this.assignedcontrolled.maxradarrange): %s -- @$DATRepositionForLOS: %s -- (not @$DAlos): %s -- @$DAisinview: %s -- @$DATRepositionCounter: %s'.[this.ship.knownname,this.ship.idcode,$DATRePos?,(@$DATRePos != null),this.assignedcontrolled.maxspeed,(this.assignedcontrolled.zone == $target.zone),(this.assignedcontrolled.bboxdistanceto.{$target} le this.assignedcontrolled.maxradarrange),@$DATRepositionForLOS,(not @$DAlos),@$DAisinview,@$DATRepositionCounter]" context="false" filter="error" chance="100"/>
						<set_value name="$DATRepositionCounter" exact="0"/>
					</do_else>
				</do_else>
			</do_if>
		</do_if>
	</add>
</diff>
