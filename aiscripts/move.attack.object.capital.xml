<?xml version="1.0" encoding="utf-8" ?>
<diff>
<!-- add. purpose: data store
	<params>
-->
	<add sel="//params">
		<param name="kAAITParam_isAvoidHighRisk" required="false" default="null" type="internal" />
		<param name="kAAITParam_isStepForwardWithdraw" required="false" type="internal" text="{1111920, 109}" default="false" />
	</add>
<!-- add before at 3 x move_to and 1 x move_strafe. purpose: debug.
	<move_to>
-->
	<add pos="before" sel="(//move_to)[1]">
		<do_if value="(@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw) and @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isTargetPotentialHighRisk">
			<debug_text text="@this.assignedcontrolled.idcode + ' move_to (1) rotate to aim'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		</do_if>
	</add>
	<add pos="before" sel="(//move_to)[2]">
		<do_if value="(@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw) and @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isTargetPotentialHighRisk">
			<debug_text text="@this.assignedcontrolled.idcode + ' move_to (2) rotate to look away'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		</do_if>
	</add>
	<add pos="before" sel="//move_strafe">
		<do_if value="(@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw) and @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isTargetPotentialHighRisk">
			<debug_text text="@this.assignedcontrolled.idcode + ' move_strafe'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		</do_if>
	</add>
	<add pos="before" sel="(//move_to)[3]">
		<do_if value="(@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw) and @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isTargetPotentialHighRisk">
			<debug_text text="@this.assignedcontrolled.idcode + ' move_to (3) short attack move'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		</do_if>
	</add>
<!-- add. purpose: add handlers.
	<interrupts>
-->
	<add pos="prepend" sel="//interrupts">
		<handler ref="kAAIT_CheckVersion" />
		<handler ref="kAAIT_Handler_AvoidWithdrawOrJustFight" />
		<handler ref="kAAIT_Handler_NewBigTarget" />
		<handler ref="kAAIT_Handler_DebugWithdraw" />
	</add>
<!-- add.
-->
	<add pos="prepend" sel="//interrupts">
		<library>
			<actions name="kAAIT_GetIsMoveToEngage">
				<set_value name="$kAAIT_result_isMovetoEngage" exact="false" />
				<do_if value="
					(
						this.assignedcontrolled.type != shiptype.carrier or
						(
							(
								this.isplayerowned and
								global.$kAAIT_Data.$isCarriersAttackLikeDestroyers
							) or
							(
								(not this.isplayerowned) and
								global.$kAAIT_Data.$isCarriersAttackLikeDestroyers_allFactions
							)
						)
					) and
					(
						@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isTargetHighRisk or
						@global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isTargetPotentialHighRisk
					) and
					(not @$primarytarget.travel.active) and
					(not @$target.travel.active)
				">
					<set_value name="$kAAIT_distToTarget" exact="this.assignedcontrolled.bboxdistanceto.{$target}" />
					<set_value name="$kAAIT_engagePosDist" exact="
						[
							this.assignedcontrolled.maxradarrange * 0.5,
							$target.size * 0.5 + global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_max * global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$skill_distance_engagePosition_mult
						].min" />
					<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsMoveToEngage $target: ' + $target + ' (' + $target.knownname + ' , ' + @$target.hullpercentage + ') $moduleTarget: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$moduleTarget + ' (' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$moduleTarget.knownname + ', ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$moduleTarget.hullpercentage + ')'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
					<do_if value="$target.isrealclass.module and $target != @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$moduleTarget">
						<set_value name="$kAAIT_result_isMovetoEngage" exact="true" />
					</do_if>
					<do_elseif value="
						global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget != @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget_stoppedKamikaze and
						(
							(
								global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget.isclass.station and
								$kAAIT_distToTarget gt $kAAIT_engagePosDist
							) or
							(
								global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget.isclass.ship and
								(not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget.isclass.ship.travel.active) and
								$kAAIT_distToTarget gt $kAAIT_engagePosDist
							)
						)
					">
						<set_value name="$kAAIT_result_isMovetoEngage" exact="true" />
					</do_elseif>
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsMoveToEngage $kAAIT_result_isMovetoEngage: ' + $kAAIT_result_isMovetoEngage" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
			</actions>
			<actions name="kAAIT_GetIsTargetBlocked">
				<set_value name="$kAAIT_test_target_isInTheWay" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget" />
				<include_interrupt_actions ref="kAAIT_GetIsInTheWay" />
				<remove_value name="$kAAIT_test_target_isInTheWay" />
				<set_value name="$isTargetBlocked" exact="$kAAIT_result_isTargetInTheWay" />
				<remove_value name="$kAAIT_result_isTargetInTheWay" />
			</actions>
			<actions name="kAAIT_GetIsStepForward">
				<set_value name="$kAAIT_result_isStepForward" exact="false" />
				<set_value name="$time_nextStepForward" exact="1min" />
				<do_if value="$target.isclass.ship">
					<set_value name="$time_nextStepForward" exact="10s" />
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' $target.iscapitalship: ' + @$target.iscapitalship" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $target.isclass.station: ' + $target.isclass.station + ' $target.defensible.isclass.station: ' + $target.defensible.isclass.station" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $time_nextStepForward: ' + $time_nextStepForward" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $time_lastStepForward: ' + @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$time_lastStepForward" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
				<debug_text text="@this.assignedcontrolled.idcode + ' gt $time_nextStepForward: ' + (player.age - @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$time_lastStepForward gt $time_nextStepForward)" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
				<do_if value="
					(
						@$target.iscapitalship or
						$target.isclass.station or
						$target.defensible.isclass.station
					) and
					player.age - @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$time_lastStepForward gt $time_nextStepForward
				">
					<set_value name="$kAAIT_distToTarget" exact="this.assignedcontrolled.bboxdistanceto.{global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget}" />
					<debug_text text="@this.assignedcontrolled.idcode + ' $kAAIT_distToTarget: ' + $kAAIT_distToTarget" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
					<debug_text text="@this.assignedcontrolled.idcode + ' $combatRange_min: ' + global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_min" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
					<debug_text text="@this.assignedcontrolled.idcode + ' $combatRange_max: ' + global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_max" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
					<do_if value="$kAAIT_distToTarget gt global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_max * 2">
						<debug_text text="@this.assignedcontrolled.idcode + ' type: ' + this.assignedcontrolled.type" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
						<do_if value="
							this.assignedcontrolled.type != shiptype.carrier or
							(
								(
									this.isplayerowned and
									global.$kAAIT_Data.$isCarriersAttackLikeDestroyers
								) or
								(
									(not this.isplayerowned) and
									global.$kAAIT_Data.$isCarriersAttackLikeDestroyers_allFactions
								)
							)
						">
							<set_value name="$kAAIT_result_isStepForward" exact="true" />
						</do_if>
					</do_if>
				</do_if>
				<debug_text text="@this.assignedcontrolled.idcode + ' kAAIT_GetIsStepForward $kAAIT_result_isStepForward: ' + $kAAIT_result_isStepForward" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
			</actions>
		</library>
	</add>
<!-- add prepend. purpose: init var.
	<init>
-->
	<add pos="prepend" sel="//init">
		<debug_text text="@this.assignedcontrolled.idcode + ' EVENT init'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
<!-- add prepend. purpose: init.
	<attention min="unknown">
-->
	<add pos="prepend" sel="//attention[@min=&quot;unknown&quot;]/actions">
		<label name="kAAIT_label_start" />
		<include_interrupt_actions ref="kAAIT_InitAttackScript" />
	</add>
<!-- replace 2 instances.
	purpose: $iscarrier behaviour is true if shiptype.carrier AND has subordinates or has a wingmate that is a capital ship.
	i.e. base-game implementation sets iscarrier to true ONLY if subordinates are dockable on the carrier.
	therefore: base-game implementation will put carrier in danger even if its subordinates are captial ships that do not dock on the carrier.
	kuda's implementation makes it so that carriers never attack like destroyers UNLESS it has no more subordinates or it has no capital ship wingmate.
	1st instance:
	<set_value name="$iscarrier" exact="false"/>
	<do_if value="this.assignedcontrolled.type == shiptype.carrier">
		<do_for_each name="$locsub" in="this.assignedcontrolled.subordinates">
			...
-->
	<replace sel="//set_value[@name=&quot;$iscarrier&quot;][@exact=&quot;false&quot;]/following-sibling::do_if[@value=&quot;this.assignedcontrolled.type == shiptype.carrier&quot;]/do_for_each[@name=&quot;$locsub&quot;][@in=&quot;this.assignedcontrolled.subordinates&quot;]">
		<set_value name="$iscarrier" exact="this.assignedcontrolled.subordinates.count" />
		<do_if value="(not $iscarrier) and @this.assignedcontrolled.commander.subordinates.count">
			<do_for_each name="$wingmate" in="this.assignedcontrolled.commander.subordinates">
				<do_if value="@$wingmate.iscapitalship">
					<set_value name="$iscarrier" exact="true" />
					<break />
				</do_if>
			</do_for_each>
		</do_if>
	</replace>
<!-- 2nd instance:
	remove:
	<do_if value="$iscarrier">
		<set_value name="$iscarrier" exact="false"/>
		<do_for_each name="$locsub" in="this.assignedcontrolled.subordinates">
	replace:
	<do_if value="$iscarrier">
		<set_value name="$iscarrier" exact="false"/>
-->
	<remove sel="//do_if[@value=&quot;$iscarrier&quot;]/set_value[@name=&quot;$iscarrier&quot;][@exact=&quot;false&quot;]/following-sibling::do_for_each[@name=&quot;$locsub&quot;][@in=&quot;this.assignedcontrolled.subordinates&quot;]" />
	<replace sel="//do_if[@value=&quot;$iscarrier&quot;]/set_value[@name=&quot;$iscarrier&quot;][@exact=&quot;false&quot;]">
		<set_value name="$iscarrier" exact="this.assignedcontrolled.subordinates.count" />
		<do_if value="(not $iscarrier) and @this.assignedcontrolled.commander.subordinates.count">
			<do_for_each name="$wingmate" in="this.assignedcontrolled.commander.subordinates">
				<do_if value="@$wingmate.iscapitalship">
					<set_value name="$iscarrier" exact="true" />
					<break />
				</do_if>
			</do_for_each>
		</do_if>
	</replace>
<!-- add before. purpose: change $maintaindistance
	<do_if value="$iscarrier and $maintaindistance">
-->
	<add pos="before" sel="//do_if[@value=&quot;$iscarrier and $maintaindistance&quot;]">
		<do_if value="$iscarrier">
			<do_if value="
				(this.isplayerowned and @global.$kAAIT_Data.$isCarriersAttackLikeDestroyers) or
				((not this.isplayerowned) and @global.$kAAIT_Data.$isCarriersAttackLikeDestroyers_allFactions)
			">
				<do_if value="@this.assignedcontrolled.isoperational and @global.$kAAIT_Data.$debugChance and @this.assignedcontrolled.order.script == 'order.fight.attack.object'">
					<debug_text text="@this.assignedcontrolled.idcode + ' set_object_name kAAIT'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
					<set_object_name object="this.assignedcontrolled" name="$kAAIT_original_name + ' - kAAIT attack'" />
				</do_if>
				<set_value name="$maintaindistance" exact="false" />
				<debug_text text="@this.assignedcontrolled.idcode + ' $maintaindistance: ' + $maintaindistance" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
			</do_if>
		</do_if>
	</add>
<!-- add before. purpose: custom behaviours.
	<label name="fight" />
-->
	<add pos="before" sel="//label[@name=&quot;fight&quot;]">
		<resume label="fight" />

		<label name="kAAIT_label_move_to_engage_position" />
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL kAAIT_label_move_to_engage_position'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<set_value name="$kAAIT_engagePosDist" exact="$target.size * 0.5 + global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_max * global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$skill_distance_engagePosition_mult" />
		<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid" exact="$target" />
		<include_interrupt_actions ref="kAAIT_Order_MoveToEngagePosition" />
		<wait min="1s" max="3s" comment="stop this order from continuing as the new order is created" />
		<resume label="fight" comment="in case the new order fails, do this" />

		<label name="kAAIT_label_step_forward" />
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL kAAIT_label_step_forward'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<set_value name="$isTargetBlocked" exact="false" />
		<do_if value="
			$target.isrealclass.module and
			$target != global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$moduleTarget
		" comment="can move to engage instead of step forward">
			<include_interrupt_actions ref="kAAIT_GetIsTargetBlocked" />
		</do_if>
		<do_if value="@$isTargetBlocked">
			<resume label="kAAIT_label_move_to_engage_position" />
		</do_if>
		<do_else>
			<create_order object="this.assignedcontrolled" id="'kAAIT_MoveStepForward'" immediate="true">
				<param name="target" value="$target" />
			</create_order>
			<wait min="1s" max="3s" comment="stop this order from continuing as the new order is created" />
		</do_else>
		<resume label="fight" comment="in case the new order fails, do this" />

		<label name="kAAIT_label_avoid" />
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL kAAIT_label_avoid'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<include_interrupt_actions ref="kAAIT_Order_Avoid" />
		<wait min="1s" max="3s" comment="stop this order from continuing as the new order is created" />
		<resume label="fight" comment="in case the new order fails, do this" />
	</add>
<!-- add after. purpose: determine custom behaviours.
	<label name="fight" />
-->
	<add pos="after" sel="//label[@name=&quot;fight&quot;]">
		<do_if value="@this.assignedcontrolled.isoperational">
			<do_if value="$kAAIT_original_name? and @$kAAIT_original_name and (this.assignedcontrolled.knownname != @$kAAIT_original_name) and (not @this.assignedcontrolled.coverowner)">
				<debug_text text="'MOD: KUDA -- %s(%s) -- set_object_name reset to %s.'.[@this.assignedcontrolled.knownname,@this.assignedcontrolled.idcode,$kAAIT_original_name]" />
				<set_object_name object="this.assignedcontrolled" name="$kAAIT_original_name" />
			</do_if>
		</do_if>
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL fight'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<do_if value="@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw">
			<set_value name="$kAAIT_test_target_isAvoid" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget" />
			<include_interrupt_actions ref="kAAIT_GetAvoidOrNot" />
			<do_if value="@$kAAIT_result_avoidEnemy.isoperational and @$kAAITParam_isAvoidHighRisk">
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid" exact="$kAAIT_result_avoidEnemy" />
				<resume label="kAAIT_label_avoid" />
			</do_if>
			<do_elseif value="@$kAAIT_result_withdrawFromEnemy.isoperational and @$kAAITParam_isStepForwardWithdraw">
				<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid" exact="$kAAIT_result_withdrawFromEnemy" />
				<resume label="kAAIT_label_withdraw" />
			</do_elseif>
		</do_if>
		<do_if value="@$kAAITParam_isStepForwardWithdraw">
			<include_interrupt_actions ref="kAAIT_GetIsMoveToEngage" />
			<do_if value="$kAAIT_result_isMovetoEngage">
				<resume label="kAAIT_label_move_to_engage_position" />
			</do_if>
		</do_if>
	</add>
<!-- add before. purpose: force frontweapon on all kuda-enabled ships for debugging
	<do_if value="$frontweapon?">
-->
	<!-- <add pos="before" sel="//do_if[@value=&quot;$frontweapon?&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' $frontweapon: ' + @$frontweapon" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<do_if value="@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw">
			<set_value name="$frontweapon" exact="true" />
			<debug_text text="@this.assignedcontrolled.idcode + ' $frontweapon (kuda, forced): ' + @$frontweapon" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		</do_if>
	</add> -->
<!-- add after. purpose: hijack effective range and move thresholds to limit the ship's movements to step forward or withdraw behaviours.
	<do_if value="$frontweapon?">
		<set_value name="$movethreshold_max" exact="$maxeffectivecombatrange"/>
-->
	<add pos="after" sel="//do_if[@value=&quot;$frontweapon?&quot;]//set_value[@name=&quot;$movethreshold_max&quot;][@exact=&quot;$maxeffectivecombatrange&quot;]">
		<set_value name="$movethreshold_min_orig" exact="$movethreshold_min"/>
		<set_value name="$movethreshold_max_orig" exact="$movethreshold_max"/>
		<debug_text text="@this.assignedcontrolled.idcode + ' $kAAITParam_isAvoidHighRisk: ' + @$kAAITParam_isAvoidHighRisk" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<debug_text text="@this.assignedcontrolled.idcode + ' $kAAITParam_isStepForwardWithdraw: ' + @$kAAITParam_isStepForwardWithdraw" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<do_if value="@$kAAITParam_isAvoidHighRisk or @$kAAITParam_isStepForwardWithdraw">
			<do_if value="@this.assignedcontrolled.isoperational and @global.$kAAIT_Data.$debugChance and @this.assignedcontrolled.order.script == 'order.fight.attack.object'">
				<debug_text text="@this.assignedcontrolled.idcode + ' set_object_name kAAIT'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
				<set_object_name object="this.assignedcontrolled" name="$kAAIT_original_name + ' - kAAIT attack'" />
			</do_if>
			<set_value name="$movethreshold_min" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_min"/>
			<set_value name="$movethreshold_max" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$combatRange_max"/>
		</do_if>
	</add>
<!-- add prepend. purpose: debug.
	<do_if value="$frontweapon?" >
		<do_if value="$distance gt $movethreshold_max or $distance lt $movethreshold_min">
-->
	<add pos="before" sel="//do_if[@value=&quot;$frontweapon?&quot;]//do_if[@value=&quot;$distance gt $movethreshold_max or $distance lt $movethreshold_min&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' $movethreshold_min_orig: ' + $movethreshold_min_orig + ' $movethreshold_min: ' + $movethreshold_min" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<debug_text text="@this.assignedcontrolled.idcode + ' $distance: ' + $distance" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<debug_text text="@this.assignedcontrolled.idcode + ' $movethreshold_max_orig: ' + $movethreshold_max_orig + ' $movethreshold_max: ' + $movethreshold_max" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
	<add pos="prepend" sel="//do_if[@value=&quot;$frontweapon?&quot;]//do_if[@value=&quot;$distance gt $movethreshold_max or $distance lt $movethreshold_min&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' OUT OF MOVE THRESHOLDS'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
	<add pos="prepend" sel="//do_if[@value=&quot;$frontweapon?&quot;]//do_elseif[@value=&quot;$distance le $movethreshold_max and $distance ge $movethreshold_min&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' WITHIN MOVE THRESHOLDS'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
<!-- add. purspose: debug.
	<do_if value="$frontweapon?" >
-->
	<!-- <add sel="//do_if[@value=&quot;$frontweapon?&quot;]">
		<set_object_name object="this.assignedcontrolled" name="$kAAIT_original_name" />
	</add> -->
<!-- add before. purspoe: step forward after wait.
	<do_if value="$frontweapon?" >
		<wait exact="$updatetime">
-->
	<add pos="after" sel="//do_if[@value=&quot;$frontweapon?&quot;]//wait[@exact=&quot;$updatetime&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' WAIT COMPLETE'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<do_if value="@$kAAITParam_isStepForwardWithdraw and @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isTargetHighRisk">
			<include_interrupt_actions ref="kAAIT_GetIsStepForward" />
			<do_if value="$kAAIT_result_isStepForward">
				<resume label="kAAIT_label_step_forward" />
			</do_if>
		</do_if>
	</add>
<!-- add before. purpose: debug.
	<do_else>
		<set_value name="$case" exact="'1.1.3: cap v cap, front-mounted, retreat'"/>
-->
	<!-- <add pos="before" sel="//set_value[@name=&quot;$case&quot;][@exact=&quot;'1.1.3: cap v cap, front-mounted, retreat'&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' TOO NEAR TARGET'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
	</add> -->
<!-- add after. purpose: debug.
	<do_if value="this.ship.bboxdistanceto.{$target} ge $minoperationalrange and this.ship.bboxdistanceto.{$target} le $maxoperationalrange">
-->
	<add pos="before" sel="//do_if[@value=&quot;this.ship.bboxdistanceto.{$target} ge $minoperationalrange and this.ship.bboxdistanceto.{$target} le $maxoperationalrange&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' this.assignedcontrolled.bboxdistanceto.{$target}: ' + this.assignedcontrolled.bboxdistanceto.{$target}" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<debug_text text="@this.assignedcontrolled.idcode + ' $minoperationalrange: ' + $minoperationalrange" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<debug_text text="@this.assignedcontrolled.idcode + ' $maxoperationalrange: ' + $maxoperationalrange" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
<!-- add before. purpose: debug.
	<remove_value name="$tempoffset"/>
-->
	<add pos="before" sel="//remove_value[@name=&quot;$tempoffset&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' this.assignedcontrolled.bboxdistanceto.[$target, $tempoffset]: ' + this.assignedcontrolled.bboxdistanceto.[$target, $tempoffset]" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<debug_text text="@this.assignedcontrolled.idcode + ' this.assignedcontrolled.bboxdistanceto.[$target.sector, $pos]: ' + this.assignedcontrolled.bboxdistanceto.[$target.sector, $pos]" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
<!-- add before. purpose: if primarypurpose != fight, stay away from target
	<do_if value="this.assignedcontrolled.sector == $target.sector">
		...
		<do_if value="$strafe?">
-->
	<add pos="before" sel="//do_if[@value=&quot;this.assignedcontrolled.sector == $target.sector&quot;]//do_if[@value=&quot;$strafe?&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' $case: ' + $case" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<debug_text text="@this.assignedcontrolled.idcode + ' this.assignedcontrolled.bboxdistanceto.[$target, $pos]: ' + this.assignedcontrolled.bboxdistanceto.[$target, $pos]" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
	</add>
<!-- add after. purpose: step_forward after attack run.
	<do_if value="this.assignedcontrolled.sector == $target.sector">
		...
		<do_if value="@$boost">
-->
	<add pos="after" sel="//do_if[@value=&quot;this.assignedcontrolled.sector == $target.sector&quot;]/do_if[@value=&quot;@$boost&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' ATTACK CYCLE COMPLETE'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<do_if value="@$kAAITParam_isStepForwardWithdraw and @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$isTargetHighRisk">
			<debug_text text="@this.assignedcontrolled.idcode + ' $target: ' + $target.knownname + ' ' + @$target.idcode + ' isoperational: ' + $target.isoperational" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
			<do_if value="not $target.isoperational">
				<resume label="finish" />
			</do_if>
			<do_else>
				<include_interrupt_actions ref="kAAIT_GetIsStepForward" />
				<do_if value="$kAAIT_result_isStepForward">
					<resume label="kAAIT_label_step_forward" />
				</do_if>
			</do_else>
		</do_if>
	</add>
<!-- add before. purpose: withdraw.
	<label name="finish"/>
-->
	<add pos="before" sel="//label[@name=&quot;finish&quot;]">
		<resume label="finish"/>

		<label name="kAAIT_label_withdraw" />
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL kAAIT_label_withdraw'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<do_if value="(not @global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget.isoperational) and $kAAIT_attacker.isoperational">
			<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid" exact="$kAAIT_attacker" />
		</do_if>
		<do_else>
			<set_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$target_avoid" exact="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$defensibleTarget" />
		</do_else>
		<include_interrupt_actions ref="kAAIT_Order_Withdraw" />
		<wait min="1s" max="3s" comment="stop this order from continuing as the new order is created" />
		<resume label="finish" comment="in case the new order fails, do this" />
	</add>
<!-- add after finish. purpose: clean-up.
	<label name="finish" />
-->
	<add pos="after" sel="//label[@name=&quot;finish&quot;]">
		<debug_text text="@this.assignedcontrolled.idcode + ' LABEL finish'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0" />
		<include_interrupt_actions ref="kAAIT_DeinitAttackScript" />
	</add>
	<!--
		   db    88""Yb  dP"Yb  88""Yb 888888
		  dPYb   88__dP dP   Yb 88__dP   88
		 dP__Yb  88""Yb Yb   dP 88"Yb    88
		dP""""Yb 88oodP  YbodP  88  Yb   88
	 -->
<!-- add after. purpose: cleanup.
	<attention min="unknown">
-->
	<add pos="after" sel="//attention[@min=&quot;unknown&quot;]">
		<on_abort>
			<do_if value="@this.assignedcontrolled.isoperational">
				<do_if value="$kAAIT_original_name? and @$kAAIT_original_name and (this.assignedcontrolled.knownname != @$kAAIT_original_name) and (not @this.assignedcontrolled.coverowner)">
					<debug_text text="'MOD: KUDA -- %s(%s) -- set_object_name reset to %s.'.[@this.assignedcontrolled.knownname,@this.assignedcontrolled.idcode,$kAAIT_original_name]" />
					<set_object_name object="this.assignedcontrolled" name="$kAAIT_original_name" />
				</do_if>
			</do_if>
			<!-- <include_interrupt_actions ref="kAAIT_RemoveAttackerFromTarget" /> -->
			<do_if value="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_space?">
				<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_space" />
				<remove_value name="global.$kAAITByShipId.{'$' + @this.assignedcontrolled.idcode}.$attackData.$orderLocation_pos" />
			</do_if>
		</on_abort>
	</add>
	<!-- DEADAIR DIFFS APPLIED AFTER KUERTEE CHANGES -->
	<replace sel="/aiscript/attention/actions/set_value[@name='$combinedskill'][@exact='this.assignedcontrolled.combinedskill']/@exact">if global.$DATPilotSkillTweaks then 100 else this.assignedcontrolled.combinedskill</replace>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_if[@value='$distance gt $movethreshold_max or $distance lt $movethreshold_min']/do_else/set_value[@name='$boost']/@chance">if this.isplayerowned then ([global.$DATPlayerAllowBoost,$allowboost].min * 100) else ($allowboost * 100)</replace>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_else[2]/set_value[@name='$boost']/@chance">if this.isplayerowned then ([global.$DATPlayerAllowBoost,$allowboost].min * 100) else ($allowboost * 100)</replace>
	<replace sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $boost? and $allowboost and ($combinedskill ge 80)']/@value">((not $boost?) or (global.$DATTravelTweaks)) and ($allowboost) and ($combinedskill ge 80)</replace>
	<add sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='((not $boost?) or (global.$DATTravelTweaks)) and ($allowboost) and ($combinedskill ge 80)']">
		<do_if value="global.$DATTravelTweaks">
			<do_if value="$timetopos ge 60s">
				<set_value name="$travel"/>
			</do_if>
			<do_if value="@$travel and (this.assignedcontrolled.bboxdistanceto.{$target} le [@$movethreshold_max,@$maxoperationalrange].max)">
				<remove_value name="$travel"/>
			</do_if>
		</do_if>
	</add>
	<add sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='$boost?']/do_if[@value='(this.assignedcontrolled.shieldpercentage gt 50) and this.assignedcontrolled.boost.maxduration']" type="@chance">if (this.isplayerowned and (not global.$DATPlayerAllowBoost)) then 0 else 100</add>
	<!-- 7.x incompatibility: -->
	<!-- <add sel="/aiscript/attention/actions/do_while[@value='$target.canbeattacked and this.ship.defencenpc.exists']/do_if[@value='not $issmall']/do_if[@value='$frontweapon?']/do_elseif[@value='$distance le $movethreshold_max and $distance ge $movethreshold_min']/do_if[@value='this.assignedcontrolled.attention ge attention.visible']/remove_value[@name='$isinview']" pos="before">
		<do_if value="global.$DATAttackStationLOSTweak"> -->
			<!-- Since below is a resume label, best place to clean up is at beginning for reduced code amount -->
			<!-- Changed debug chance to "if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else $debugchance" -->
			<!-- <remove_value name="$DATThisPosSector"/>
			<remove_value name="$DATEnemyPosSector"/>
			<remove_value name="$DATThisPosZone"/>
			<remove_value name="$DATEnemyPosZone"/>
			<remove_value name="$DATRot"/>
			<remove_value name="$DATRotAdjusted"/>
			<remove_value name="$DATmaxeffectivecombatrange"/>
			<remove_value name="$DATRePos"/>
			<remove_value name="$DATRePosRot"/>
			<remove_value name="$DATBeacon"/>
			<remove_value name="$DATRePosShipRot"/>
			<remove_value name="$DATupdatetime"/>
			<remove_value name="$DAlos"/>
			<remove_value name="$DAisinview"/> -->
			<!-- Onto the actual scripting -->
			<!-- <set_value name="$DATRepositionForLOS" exact="false"/>
			<do_if value="(not @$los) and @$isinview and @$isstation and (this.assignedcontrolled.sector == $target.sector)">
				<set_value name="$DATRepositionForLOS" exact="true"/> -->
				<!-- Ships are repositioning when they shouldn't, LOS is pretty unreliable -->
				<!-- <check_line_of_sight name="$DAlos" object="this.assignedcontrolled" target="$target"/>
				<check_object result="$DAisinview" object="$target">
					<match_is_in_view_of vertical="9deg" horizontal="9deg" object="this.assignedcontrolled"/>
				</check_object>
				<do_if value="@$DAlos and @$DAisinview">
					<set_value name="$DATRepositionForLOS" exact="false"/>
					<set_value name="$holdposition"/>
					<set_value name="$DATRepositionCounter" exact="0"/>
				</do_if>
				<do_else>
					<set_value name="$DATRepositionCounter" exact="1" operation="add"/>
				</do_else>
				<debug_text text="'MOD: DAT - move.attack.object.capital - %s (%s) - (not $los) and $isinview'.[this.ship.knownname,this.ship.idcode]" context="false" filter="scripts" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else $debugchance"/> -->
				<!-- Sector Positions -->
				<!-- <create_position name="$DATThisPosSector" space="$target.sector" object="this.ship"/>
				<create_position name="$DATEnemyPosSector" space="$target.sector" object="$target"/> -->
				<!-- Zone Positions -->
				<!-- <create_position name="$DATThisPosZone" space="this.zone" x="$DATThisPosSector.x" y="$DATThisPosSector.y" z="$DATThisPosSector.z" object="this.assignedcontrolled.sector"/>
				<create_position name="$DATEnemyPosZone" space="$target.zone" x="$DATEnemyPosSector.x" y="$DATEnemyPosSector.y" z="$DATEnemyPosSector.z" object="$target.sector"/> -->
				<!-- Transform 15 Deg -->
				<!-- <create_orientation name="$DATRot" refposition="$DATThisPosZone" orientation="look_at">
					<position value="$DATEnemyPosZone"/>
				</create_orientation>
				<debug_text text="'MOD: DAT - move.attack.object.capital - %s (%s) - original yaw: %s (%s) - pitch: %s (%s) - roll: %s (%s) - distance: %s'.[this.ship.knownname,this.ship.idcode,$DATRot.yaw,$DATRot.yaw * 180 / pi,$DATRot.pitch,$DATRot.pitch * 180 / pi,$DATRot.roll,$DATRot.roll * 180 / pi,$target.distanceto.{this.assignedcontrolled}]" context="false" filter="scripts" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else $debugchance"/>
				<set_value name="$DATRotAdjusted" exact="rotation.[$DATRot.yaw + 15deg,$DATRot.pitch,$DATRot.roll]"/>
				<set_value name="$DATmaxeffectivecombatrange" exact="this.assignedcontrolled.maxcombatrange.all * 0.8"/>
				<do_if value="this.assignedcontrolled.dps.lasers.all">
					<set_value name="$DATmaxeffectivecombatrange" exact="this.assignedcontrolled.maxcombatrange.lasers.all * 0.8"/>
				</do_if>
				<transform_position name="$DATRePos" refposition="$DATEnemyPosZone" refrotation="$DATRotAdjusted">
					<position z="$DATmaxeffectivecombatrange"/>
				</transform_position>
				<create_orientation name="$DATRePosRot" refposition="$DATRePos" orientation="look_at">
					<position value="$DATEnemyPosZone"/>
				</create_orientation>
				<debug_text text="'MOD: DAT - move.attack.object.capital - %s (%s) - adjusted yaw: %s (%s) - pitch: %s (%s) - roll: %s (%s) - distance: %s'.[this.ship.knownname,this.ship.idcode,$DATRePosRot.yaw,$DATRePosRot.yaw * 180 / pi,$DATRePosRot.pitch,$DATRePosRot.pitch * 180 / pi,$DATRePosRot.roll,$DATRePosRot.roll * 180 / pi,$target.distanceto.[$target.zone,$DATRePos]]" context="false" filter="scripts" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else $debugchance"/> -->
				<!-- Handle obstructions or obstacles? -->
				<!-- Move -->
				<!-- <do_if value="$DATRePos? and (@$DATRePos != null) and this.assignedcontrolled.maxspeed and ((this.assignedcontrolled.zone == $target.zone) or (this.assignedcontrolled.bboxdistanceto.{$target} le this.assignedcontrolled.maxradarrange)) and @$DATRepositionForLOS and (@$DATRepositionCounter ge 3)"> -->
					<!-- reset counter -->
					<!-- <set_value name="$DATRepositionCounter" exact="0"/> -->
					<!-- Custom update time -->
					<!-- might need to account for rotation time to target -->
					<!-- adding 50% to time to account for rotation -->
					<!-- <set_value name="$DATupdatetime" exact="(this.assignedcontrolled.distanceto.[$target.zone, $DATRePos] / [this.assignedcontrolled.maxspeed, 1m].max)s * 1.5"/> -->
					<!-- Debug -->
					<!-- <do_if value="@global.$kAAIT_Data.$debugChance" comment="debug DAT Reposition">
						<do_if value="@this.assignedcontrolled.isoperational and @this.assignedcontrolled.order.script == 'order.fight.attack.object'">
							<set_value name="$kAAIT_original_name_DAT" exact="this.assignedcontrolled.knownname"/>
							<debug_text text="@this.assignedcontrolled.idcode + ' set_object_name DAT'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0"/>
							<set_object_name object="this.assignedcontrolled" name="$kAAIT_original_name + ' - DAT reposition'"/>
						</do_if> -->
						<!-- Create beacon for testing -->
						<!-- <create_object name="$DATBeacon" zone="$target.zone" macro="macro.env_deco_nav_beacon_t1_macro" owner="faction.player">
							<position value="$DATRePos"/>
						</create_object>
						<set_object_name object="$DATBeacon" name="'000 - %s (%s) Rot Beacon vs %s'.[this.assignedcontrolled.knownname,this.assignedcontrolled.idcode,$target.knownname]"/>
					</do_if> -->
					<!-- <move_to destination="$target.zone" abortpath="false" object="this.assignedcontrolled" finishonapproach="false" forceposition="false" forcerotation="false" uselocalhighways="false" boost="false" travel="false" chance="(@$DATRepositionForLOS and @$DATupdatetime) * 100">
						<position value="$DATRePos"/>
						<interrupt_after_time time="if $DATupdatetime? then $DATupdatetime else 1s"/>
						<interrupt>
							<conditions>
								<check_any>
									<event_object_destroyed object="$target"/>
									<check_all>
										<event_object_attacked object="this.assignedcontrolled"/>
										<check_value value="not this.assignedcontrolled.maxspeed"/>
									</check_all>
								</check_any>
							</conditions>
						</interrupt>
					</move_to>
					<do_if value="$kAAIT_original_name_DAT?" comment="undebug DAT Reposition">
						<debug_text text="@this.assignedcontrolled.idcode + ' set_object_name reset to pre DAT'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else 0"/>
						<set_object_name object="this.assignedcontrolled" name="$kAAIT_original_name_DAT"/>
						<remove_value name="$kAAIT_original_name_DAT"/>
					</do_if>
					<do_if value="@$DATBeacon.exists" comment="undebug DAT Reposition">
						<destroy_object object="$DATBeacon"/>
					</do_if>
					<do_if value="@$DATRepositionForLOS and @$DATupdatetime">
						<debug_text text="'MOD: DAT - move.attack.object.capital - %s (%s) - Move Complete'.[this.ship.knownname,this.ship.idcode]" context="false" filter="scripts" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode or @global.$kAAIT.$debugChance_idCode == 'all' then @global.$kAAIT_Data.$debugChance else $debugchance"/>
					</do_if>
					<resume label="fight" chance="@$DATRepositionForLOS * 100"/>
				</do_if>
				<do_else>
					<do_if value="not this.assignedcontrolled.maxspeed">
						<debug_text text="'MOD: DAT - move.attack.object.capital - Error Moving: No Engines - %s (%s) - this.assignedcontrolled.maxspeed: %s '.[this.ship.knownname,this.ship.idcode,this.assignedcontrolled.maxspeed]" context="false" filter="error" chance="100"/>
						<set_value name="$DATRepositionCounter" exact="0"/>
					</do_if>
					<do_elseif value="not ((this.assignedcontrolled.zone == $target.zone) or (this.assignedcontrolled.bboxdistanceto.{$target} le this.assignedcontrolled.maxradarrange))">
						<debug_text text="'MOD: DAT - move.attack.object.capital - Error Moving: Too Far - %s (%s) - (this.assignedcontrolled.zone == $target.zone): %s - (this.assignedcontrolled.bboxdistanceto.{$target} le this.assignedcontrolled.maxradarrange): %s'.[this.ship.knownname,this.ship.idcode,(this.assignedcontrolled.zone == $target.zone),(this.assignedcontrolled.bboxdistanceto.{$target} le this.assignedcontrolled.maxradarrange)]" context="false" filter="error" chance="100"/>
						<set_value name="$DATRepositionCounter" exact="0"/>
					</do_elseif>
					<do_elseif value="((@$DATRepositionForLOS) and (@$DATRepositionCounter lt 3)) or ((not @$DATRepositionForLOS) and (@$DAlos and @$DAisinview))">
						<debug_text text="'MOD: DAT - move.attack.object.capital - Not Moving (Expected) - %s (%s) - @$DATRepositionForLOS: %s - @$DATRepositionCounter: %s - @$DAlos: %s - @$DAisinview: %s'.[this.ship.knownname,this.ship.idcode,@$DATRepositionForLOS,@$DATRepositionCounter,@$DAlos,@$DAisinview]" context="false" filter="scripts" chance="100"/>
					</do_elseif>
					<do_else>
						<debug_text text="'MOD: DAT - move.attack.object.capital - Error Moving: Unhandled - %s (%s) - $DATRePos?: %s - (@$DATRePos != null): %s - this.assignedcontrolled.maxspeed: %s - (this.assignedcontrolled.zone == $target.zone): %s - (this.assignedcontrolled.bboxdistanceto.{$target} le this.assignedcontrolled.maxradarrange): %s - @$DATRepositionForLOS: %s - (not @$DAlos): %s - @$DAisinview: %s - @$DATRepositionCounter: %s'.[this.ship.knownname,this.ship.idcode,$DATRePos?,(@$DATRePos != null),this.assignedcontrolled.maxspeed,(this.assignedcontrolled.zone == $target.zone),(this.assignedcontrolled.bboxdistanceto.{$target} le this.assignedcontrolled.maxradarrange),@$DATRepositionForLOS,(not @$DAlos),@$DAisinview,@$DATRepositionCounter]" context="false" filter="error" chance="100"/>
						<set_value name="$DATRepositionCounter" exact="0"/>
					</do_else>
				</do_else>
			</do_if>
		</do_if>
	</add> -->
</diff>
