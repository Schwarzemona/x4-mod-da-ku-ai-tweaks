<?xml version="1.0" encoding="utf-8" ?>
<diff>
<!-- add. purpose: data store
	<params>
-->
	<add sel="//params">
		<param name="kAAITParam_isAvoidHighRisk" required="false" type="internal" text="{1111920, 3}" default="false" />
		<param name="kAAITParam_isStepForwardWithdraw" required="false" type="internal" text="{1111920, 109}" default="false" />
	</add>
<!-- add prepend. purpose: init var.
	<init>
-->
	<add pos="prepend" sel="//init">
		<debug_text text="this.assignedcontrolled.idcode + ' EVENT init'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<do_if value="@$kAAITParam_isAvoidHighRisk">
			<include_interrupt_actions ref="kAAIT_Init" />
		</do_if>
	</add>
<!-- add. purpose: add handlers.
	<interrupts>
-->
	<add pos="prepend" sel="//interrupts">
		<!-- <handler ref="kAAIT_Handler_AvoidWithdrawOrJustFight" /> -->
		<!-- <handler ref="kAAIT_Handler_NewBigTarget" /> -->
	</add>
	<!--
		Yb    dP 88 .dP"Y8 88 88""Yb 88     888888
		 Yb  dP  88 `Ybo." 88 88__dP 88     88__
		  YbdP   88 o.`Y8b 88 88""Yb 88  .o 88""
		   YP    88 8bodP' 88 88oodP 88ood8 888888
	 -->
<!-- add before. purpose: behaviours.
	<label name="fight" />
-->
	<add pos="before" sel="//attention[@min=&quot;visible&quot;]//label[@name=&quot;fight&quot;]">
		<resume label="fight" />

		<label name="kAAIT_label_avoid" />
		<debug_text text="this.assignedcontrolled.idcode + ' LABEL kAAIT_label_avoid'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<include_interrupt_actions ref="kAAIT_Order_Avoid" />
		<wait min="5s" max="10s" />
		<resume label="fight" />
	</add>
<!-- add after. purpose: add attacker to target
	<label name="fight" />
-->
	<add pos="after" sel="//attention[@min=&quot;visible&quot;]//label[@name=&quot;fight&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' LABEL fight'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<do_if value="@$kAAITParam_isAvoidHighRisk and (not @global.$kAAIT_Config.$settingsByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isIgnoreKAAIT)">
			<include_interrupt_actions ref="kAAIT_AddAttackerToTarget" />
			<remove_value name="global.$kAAIT_Config.$settingsByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_space" />
			<remove_value name="global.$kAAIT_Config.$settingsByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_pos" />
		</do_if>
	</add>
<!-- add prepend. purpose: avoid if required.
	<attention min="visible">
		<do_while value="$target.canbeattacked">
-->
	<add pos="prepend" sel="//attention[@min=&quot;visible&quot;]//do_while[@value=&quot;$target.canbeattacked&quot;]">
		<do_if value="@$kAAITParam_isAvoidHighRisk and (not @global.$kAAIT_Config.$settingsByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isIgnoreKAAIT)">
			<do_if value="@global.$kAAIT_Config.$settingsByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isTargetHighRisk">
				<set_value name="$kAAIT_test_target_isAvoid" exact="global.$kAAIT_Config.$settingsByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget" />
				<include_interrupt_actions ref="kAAIT_AvoidOrNot" />
				<do_if value="$kAAIT_result_isAvoid">
					<debug_text text="this.assignedcontrolled.idcode + ' this.assignedcontrolled.dps.missiles.all: ' + this.assignedcontrolled.dps.missiles.all" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<debug_text text="this.assignedcontrolled.idcode + ' this.assignedcontrolled.ammostorage.missile.count: ' + this.assignedcontrolled.ammostorage.missile.count" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
					<set_value name="global.$kAAIT_Config.$settingsByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$target_avoid" exact="$kAAIT_result_avoidEnemy" />
					<resume label="kAAIT_label_avoid" />
				</do_if>
			</do_if>
		</do_if>
	</add>
<!-- add before. purpose: withdraw.
	<label name="finish"/>
-->
	<add pos="before" sel="//attention[@min=&quot;visible&quot;]//label[@name=&quot;finish&quot;]">
		<resume label="finish"/>
		<label name="kAAITLabel_withdraw" />
		<debug_text text="this.assignedcontrolled.idcode + ' LABEL kAAITLabel_withdraw'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<create_order object="this.assignedcontrolled" id="'kAAIT_MoveWithdraw'" immediate="true">
			<param name="target" value="global.$kAAIT_Config.$settingsByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget" />
		</create_order>
		<resume label="finish"/>
	</add>
<!-- add after. purpose: clean-up.
	<label name="finish" />
-->
	<add pos="after" sel="//attention[@min=&quot;visible&quot;]//label[@name=&quot;finish&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' LABEL finish'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<include_interrupt_actions ref="kAAIT_RemoveAttackerFromTarget" />
		<do_if value="@global.$kAAIT_Config.$settingsByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data">
			<remove_value name="global.$kAAIT_Config.$settingsByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_space" />
			<remove_value name="global.$kAAIT_Config.$settingsByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_pos" />
		</do_if>
	</add>
	<!--
		88   88 88b 88 88  dP 88b 88  dP"Yb  Yb        dP 88b 88
		88   88 88Yb88 88odP  88Yb88 dP   Yb  Yb  db  dP  88Yb88
		Y8   8P 88 Y88 88"Yb  88 Y88 Yb   dP   YbdPYbdP   88 Y88
		`YbodP' 88  Y8 88  Yb 88  Y8  YbodP     YP  YP    88  Y8
	 -->
<!-- add before. purpose: behaviours.
	<label name="fight" />
-->
	<add pos="before" sel="//attention[@min=&quot;unknown&quot;]//label[@name=&quot;fight&quot;]">
		<resume label="fight" />

		<label name="kAAIT_label_avoid" />
		<debug_text text="this.assignedcontrolled.idcode + ' LABEL kAAIT_label_avoid'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<include_interrupt_actions ref="kAAIT_Order_Avoid" />
		<wait min="5s" max="10s" />
		<resume label="fight" />
	</add>
<!-- add after. purpose: add attacker to target
	<label name="fight" />
-->
	<add pos="after" sel="//attention[@min=&quot;unknown&quot;]//label[@name=&quot;fight&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' LABEL fight'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<do_if value="@$kAAITParam_isAvoidHighRisk and (not @global.$kAAIT_Config.$settingsByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isIgnoreKAAIT)">
			<include_interrupt_actions ref="kAAIT_AddAttackerToTarget" />
			<remove_value name="global.$kAAIT_Config.$settingsByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_space" />
			<remove_value name="global.$kAAIT_Config.$settingsByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_pos" />
		</do_if>
	</add>
<!-- add prepend. purpose: avoid if required.
	<attention min="unknown">
		<do_while value="$bigtarget.canbeattacked and not $isdead" >
-->
	<add pos="prepend" sel="//attention[@min=&quot;unknown&quot;]//do_while[@value=&quot;$bigtarget.canbeattacked and not $isdead&quot;]">
		<do_if value="@$kAAITParam_isAvoidHighRisk and (not @global.$kAAIT_Config.$settingsByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isIgnoreKAAIT)">
			<do_if value="@global.$kAAIT_Config.$settingsByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$isTargetHighRisk">
				<set_value name="$kAAIT_test_target_isAvoid" exact="global.$kAAIT_Config.$settingsByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget" />
				<include_interrupt_actions ref="kAAIT_AvoidOrNot" />
				<do_if value="$kAAIT_result_isAvoid">
					<set_value name="global.$kAAIT_Config.$settingsByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$target_avoid" exact="$kAAIT_result_avoidEnemy" />
					<resume label="kAAIT_label_avoid" />
				</do_if>
			</do_if>
		</do_if>
	</add>
<!-- add before. purpose: withdraw.
	<label name="finish"/>
-->
	<add pos="before" sel="//attention[@min=&quot;unknown&quot;]//label[@name=&quot;finish&quot;]">
		<resume label="finish"/>
		<label name="kAAITLabel_withdraw" />
		<debug_text text="this.assignedcontrolled.idcode + ' LABEL kAAITLabel_withdraw'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<create_order object="this.assignedcontrolled" id="'kAAIT_MoveWithdraw'" immediate="true">
			<param name="target" value="global.$kAAIT_Config.$settingsByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$defensibleTarget" />
		</create_order>
		<resume label="finish"/>
	</add>
<!-- add after. purpose: clean-up.
	<label name="finish" />
-->
	<add pos="after" sel="//attention[@min=&quot;unknown&quot;]//label[@name=&quot;finish&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' LABEL finish'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<include_interrupt_actions ref="kAAIT_RemoveAttackerFromTarget" />
		<do_if value="@global.$kAAIT_Config.$settingsByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data">
			<remove_value name="global.$kAAIT_Config.$settingsByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_space" />
			<remove_value name="global.$kAAIT_Config.$settingsByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_pos" />
		</do_if>
	</add>
	<!--
		   db    88""Yb  dP"Yb  88""Yb 888888
		  dPYb   88__dP dP   Yb 88__dP   88
		 dP__Yb  88""Yb Yb   dP 88"Yb    88
		dP""""Yb 88oodP  YbodP  88  Yb   88
	 -->
<!-- add. purpose: cleanup.
	<on_abort>
-->
	<add sel="//on_abort">
		<include_interrupt_actions ref="kAAIT_RemoveAttackerFromTarget" />
		<do_if value="@global.$kAAIT_Config.$settingsByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data">
			<remove_value name="global.$kAAIT_Config.$settingsByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_space" />
			<remove_value name="global.$kAAIT_Config.$settingsByShipId.{'$' + @this.assignedcontrolled.idcode}.$kAAIT_data.$orderLocation_pos" />
		</do_if>
	</add>
	<!-- DeadAir Diffs -->
	<replace sel="/aiscript/init/set_value[@name='$MaxGainDistance'][@exact='this.assignedcontrolled.maxcombatrange.all']/@exact">[this.assignedcontrolled.maxcombatrange.all, this.assignedcontrolled.maxradarrange * 0.9].min</replace>
	<replace sel="/aiscript/patch[@sinceversion='10']/set_value[@name='$MaxGainDistance'][@exact='this.ship.maxcombatrange.all']/@exact">[this.assignedcontrolled.maxcombatrange.all, this.assignedcontrolled.maxradarrange * 0.9].min</replace>
	<replace sel="/aiscript/attention[@min='visible']/actions/do_if[@value='$iscapship']/set_value[@name='$ToleranceWeapon1'][@exact='8.0deg']/@exact">4.0deg</replace>
	<replace sel="/aiscript/attention[@min='visible']/actions/do_if[@value='$iscapship']/set_value[@name='$ToleranceWeapon2'][@exact='4.0deg']/@exact">6.0deg</replace>
	<replace sel="/aiscript/attention[@min='visible']/actions/do_if[@value='$iscapship']/set_value[@name='$MinGainDistance'][@exact='this.ship.maxcombatrange.all * 0.75']/@exact">[this.assignedcontrolled.maxcombatrange.all * 0.75, this.assignedcontrolled.maxradarrange * 0.9].min</replace>
	<replace sel="/aiscript/attention[@min='visible']/actions/do_else/set_value[@name='$ToleranceWeapon1'][@exact='18.0deg']/@exact">4.0deg</replace>
	<replace sel="/aiscript/attention[@min='visible']/actions/do_else/set_value[@name='$ToleranceWeapon2'][@exact='8.0deg']/@exact">6.0deg</replace>
	<replace sel="/aiscript/attention[@min='visible']/actions/do_else/set_value[@name='$MinGainDistance'][@exact='this.ship.maxcombatrange.all']/@exact">[this.assignedcontrolled.maxcombatrange.all, this.assignedcontrolled.maxradarrange * 0.9].min</replace>
	<replace sel="/aiscript/attention[@min='visible']/actions/do_while[@value='$target.canbeattacked']/do_if[@value='$isinview']/@chance">100</replace>
	<replace sel="/aiscript/attention[@min='visible']/actions/do_while[@value='$target.canbeattacked']/move_to/@travel">($duration_movement gt 40s) and (((this.assignedcontrolled.bboxdistanceto.{$bigtarget} + this.assignedcontrolled.size) gt this.assignedcontrolled.maxcombatrange.all) or ((this.assignedcontrolled.bboxdistanceto.{$bigtarget} + this.assignedcontrolled.size) gt (this.assignedcontrolled.maxradarrange)))</replace>
	<replace sel="/aiscript/attention[@min='visible']/actions/do_while[@value='$target.canbeattacked']/do_while[@value='$target.canbeattacked and ($gaindistancetimeout gt player.age) and (this.assignedcontrolled.bboxdistanceto.{$bigtarget} lt $MaxGainDistance)']/set_value[@name='$time_gaindistance'][@min='[10s * this.assignedcontrolled.combinedskill / 100, 1s].max'][@max='[30s * this.assignedcontrolled.combinedskill / 100, 3s].max']/@min">10s</replace>
	<replace sel="/aiscript/attention[@min='visible']/actions/do_while[@value='$target.canbeattacked']/do_while[@value='$target.canbeattacked and ($gaindistancetimeout gt player.age) and (this.assignedcontrolled.bboxdistanceto.{$bigtarget} lt $MaxGainDistance)']/set_value[@name='$time_gaindistance'][@min='10s'][@max='[30s * this.assignedcontrolled.combinedskill / 100, 3s].max']/@max">30s</replace>
	<replace sel="/aiscript/attention[@min='unknown']/actions/set_value[@name='$MaxGainDistance'][@exact='this.ship.maxcombatrange.all']/@exact">[this.assignedcontrolled.maxcombatrange.all, this.assignedcontrolled.maxradarrange * 0.9].min</replace>
</diff>
