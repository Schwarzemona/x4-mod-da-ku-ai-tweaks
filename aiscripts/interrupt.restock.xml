<?xml version='1.0' encoding='utf-8'?>
<diff>
<!-- replace. purpose: address ships that continualy get damaged and request a repair even if hullpercentage is at 98% resulting in a seemingly infinite loop of dock > repair > undock.
	how: add a 10 min timer and 10% hull percentage test. repair only if more than 10min AND hull percentage more than 10% below the last hull percentage.
	e.g. debug logs:
	[Scripts] 777256.25 *** aicontext<order.fight.protect.ship,0x21ff49e>: XFQ-439 $hullpercent: 100 this.ship.hullpercentage: 99.9964
	[Scripts] 774372.65 *** aicontext<order.fight.escort,0x28d13>: XFQ-439 $damagedcomponent: TEL XL Shield Generator Mk1 99.7076
	[Scripts] 774372.65 *** aicontext<order.fight.escort,0x28d13>: XFQ-439 $damagedcomponent: TEL M Shield Generator Mk2 99.7077
	[Scripts] 774372.65 *** aicontext<order.fight.escort,0x28d13>: XFQ-439 $damagedcomponent: TEL M Shield Generator Mk2 99.7077
	[Scripts] 774372.65 *** aicontext<order.fight.escort,0x28d13>: XFQ-439 $damagedcomponent: TEL M Shield Generator Mk2 99.7077
	[Scripts] 774372.65 *** aicontext<order.fight.escort,0x28d13>: XFQ-439 $damagedcomponent: TEL M Shield Generator Mk2 99.7077
	[Scripts] 774372.65 *** aicontext<order.fight.escort,0x28d13>: XFQ-439 $damagedcomponent: TEL M Shield Generator Mk2 99.7077
	[Scripts] 774372.65 *** aicontext<order.fight.escort,0x28d13>: XFQ-439 $damagedcomponent: TEL M Shield Generator Mk2 99.7077
	[Scripts] 774372.65 *** aicontext<order.fight.escort,0x28d13>: XFQ-439 $damagedcomponent: TEL M Shield Generator Mk2 99.7077
	[Scripts] 774372.65 *** aicontext<order.fight.escort,0x28d13>: XFQ-439 $damagedcomponent: TEL M Shield Generator Mk2 99.7077
	[Scripts] 774372.65 *** aicontext<order.fight.escort,0x28d13>: XFQ-439 $damagedcomponent: TEL M Shield Generator Mk2 99.7077
	[Scripts] 774372.65 *** aicontext<order.fight.escort,0x28d13>: XFQ-439 $damagedcomponent: TEL M Shield Generator Mk2 99.7077
	[Scripts] 774372.65 *** aicontext<order.fight.escort,0x28d13>: XFQ-439 $damagedcomponent: TEL M Shield Generator Mk2 99.7077
	[Scripts] 774372.65 *** aicontext<order.fight.escort,0x28d13>: XFQ-439 $damagedcomponent: TEL M Shield Generator Mk2 99.7077
	[Scripts] 774372.65 *** aicontext<order.fight.escort,0x28d13>: XFQ-439 $damagedcomponent: TEL M Shield Generator Mk2 99.7077
	[Scripts] 774372.65 *** aicontext<order.fight.escort,0x28d13>: XFQ-439 $damagedcomponent: TEL M Shield Generator Mk2 99.7077
	[Scripts] 774372.65 *** aicontext<order.fight.escort,0x28d13>: XFQ-439 $damagedcomponent: TEL XL Shield Generator Mk1 99.7076
	[Scripts] 774372.65 *** aicontext<order.fight.escort,0x28d13>: XFQ-439 $damagedcomponent: TEL XL Travel Engine Mk1 99.9786
	[Scripts] 774372.65 *** aicontext<order.fight.escort,0x28d13>: XFQ-439 $damagedcomponent: TEL XL Travel Engine Mk1 99.9964
<do_if value="$repair and ($hullpercent gt this.ship.hullpercentage or $damagedcomponents.count)">
	<create_order object="this.ship" id="'Repair'" immediate="true">
-->
	<add sel="//interrupts/library">
		<actions name="kAAIT_GetIsOkToRepairNow">
			<debug_text text="this.assignedcontrolled.idcode + ' $repair: ' + $repair" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			<debug_text text="this.assignedcontrolled.idcode + ' $hullpercent: ' + $hullpercent + ' this.ship.hullpercentage: ' + this.ship.hullpercentage" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			<debug_text text="this.assignedcontrolled.idcode + ' $damagedcomponents.count: ' + $damagedcomponents.count" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			<set_value name="$kAAIT_isOkToRepairNow" exact="false" />
			<set_value name="$kAAIT_hullpercentages" exact="[]" />
			<append_to_list name="$kAAIT_hullpercentages" exact="this.ship.hullpercentage" />
			<do_for_each name="$damagedcomponent" in="$damagedcomponents">
				<append_to_list name="$kAAIT_hullpercentages" exact="$damagedcomponent.hullpercentage" />
				<debug_text text="this.assignedcontrolled.idcode + ' $damagedcomponent: ' + @$damagedcomponent.name + ' ' + @$damagedcomponent.hullpercentage" />
			</do_for_each>
			<sort_list list="$kAAIT_hullpercentages" sortbyvalue="loop.element" sortdescending="false" />
			<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_hullpercentages: ' + @$kAAIT_hullpercentages" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			<debug_text text="this.assignedcontrolled.idcode + ' this.$kAAIT_restockData.$hullpercentage_lowest: ' + @this.$kAAIT_restockData.$hullpercentage_lowest" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			<debug_text text="this.assignedcontrolled.idcode + ' (player.age - @this.$kAAIT_restockData.$time_lastRestocked): ' + (player.age - @this.$kAAIT_restockData.$time_lastRestocked)" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
			<do_if value="
				(not @this.$kAAIT_restockData) or
				player.age - this.$kAAIT_restockData.$time_lastRestocked gt 1h or
				(
					$kAAIT_hullpercentages.{1} lt @this.$kAAIT_restockData.$hullpercentage_lowest - 10 and
					player.age - @this.$kAAIT_restockData.$time_lastRestocked gt 10min
				)
			">
				<set_value name="$kAAIT_isOkToRepairNow" exact="true" />
				<do_if value="not this.$kAAIT_restockData?">
					<set_value name="this.$kAAIT_restockData" exact="table[]" />
				</do_if>
				<set_value name="this.$kAAIT_restockData.$hullpercentage_lowest" exact="$kAAIT_hullpercentages.{1}" />
				<set_value name="this.$kAAIT_restockData.$time_lastRestocked" exact="player.age" />
			</do_if>
			<debug_text text="this.assignedcontrolled.idcode + ' $kAAIT_isOkToRepairNow: ' + @$kAAIT_isOkToRepairNow" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		</actions>
	</add>
	<add pos="before" sel="//create_order[@object=&quot;this.ship&quot;][@id=&quot;'Repair'&quot;][@immediate=&quot;true&quot;]">
		<include_interrupt_actions ref="kAAIT_GetIsOkToRepairNow" />
	</add>
	<add sel="//create_order[@object=&quot;this.ship&quot;][@id=&quot;'Repair'&quot;][@immediate=&quot;true&quot;]" type="@chance">if @$kAAIT_isOkToRepairNow then 100 else 0</add>
<!-- add. purpose debug.
<do_if value="$restock_subordinates">
	<create_order object="this.ship" id="'RestockSubordinates'" immediate="true">
-->
	<add pos="before" sel="//create_order[@object=&quot;this.ship&quot;][@id=&quot;'RestockSubordinates'&quot;][@immediate=&quot;true&quot;]">
		<debug_text text="this.assignedcontrolled.idcode + ' $restock_subordinates: ' + $restock_subordinates" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
		<debug_text text="this.assignedcontrolled.idcode + ' create_order RestockSubordinates'" chance="if @this.assignedcontrolled.idcode == @global.$kAAIT.$debugChance_idCode then @global.$kAAIT_Config.$debugChance else 0" />
	</add>
</diff>
