KUDA AI tweaks
Release version: https://www.nexusmods.com/x4foundations/mods/839
Development version: https://github.com/kuertee/x4-mod-da-ku-ai-tweaks
by deadair, kuertee
localisations: Tioemer (Chinese), Arkblade (Japanese)

Attack AI Tweaks read-me is below.
Dead Air AI Tweaks read-me is here: https://github.com/kuertee/x4-mod-da-ku-ai-tweaks/blob/master/deadairaitweaks-read-me.md

Updates
=======
v5.1.0302, 8 Aug 2022:
-New feature: Escort, Follow, and Protect orders (and any other AIs that use these, e.g. Supply) acquires the Withdraw custom behaviour.
-New feature: Ships that are not fighters (e.g. Auxiliaries) will always stay away (e.g. Avoid custom behaviour) from their target. E.g. Monitors will never find themselves caught in a station's turrets.
-New feature: Coordinated attack changes. Read more below. Summary: much further rally points, small targets first checkbox disabled by default, subordinates that are busy or are more than 2 gates away do not join the attack, etc.
-New feature: Ships that have a low chance of survival or ships targeting enemies with a low chance of survival never withdraw.
-New feature: Refactored about 90% of Attack AI Tweaks - my portion of the mod. DeadAir's portions are unchanged. The codebase is cleaner and easier to edit.
-Bug-fix: The user-controlled order options for the custom behaviours weren't working.
-New feature: Board and Protect orders now have the attack "Avoid high-risk" and "Step forward/withdraw" order options.

Attack AI Tweaks:
=================

Mod effects
===========
(1) All ships avoid high-risk enemies. (2) L, and XL ships inch forward against high-risk targets. (3) L, and XL ships withdraw from high-risk targets when their shields fall below 90%.

Requirements
============
-SirNukes Mod Support APIs mod (https://www.nexusmods.com/x4foundations/mods/503)

Avoid high-risk enemies
=======================
All ships move around high-risk enemies that are in their flight path. (https://youtu.be/mWBef0_mrmE)

XS (except for drones), S, and M class ships will circle high-risk station targets until they outnumber 75% of their targets' turrets, and 50% for high-risk ship targets. Ships with missile and torpedo loadouts do not acquire this behaviour until their missiles and torpedoes are depleted. (https://youtu.be/DFVtwZxSKes)

L, and XL class ships, enroute to their targets, will stop short of their targets to prevent accidental kamikaze attacks.

Non-fighters (e.g. auxiliaries) will stay away from their targets.

Additional L, and XL AI behaviours
==================================
Step forward: When attacking high-risk targets, L and XL ships will move forward from near their max range up to an optimal range based on the times they withdrew and the times they didn't have to withdraw. The player's removal of high-damage turrets have a direct effect on the AI's behaviour.

Previous versions start at their optimal range based on their DPS, their target DPS and the number of times they withdrew. You can enable this previous version in the Extension Options.

The current version makes use of long-range weapons earlier and for a longer time - softening up their target. The previous version used all weapons sooner (because they get closer sooner) but put the ship in danger sooner - causing some ships to withdraw sooner and more often.

Withdraw out of range: When shields drop below 90%, L and XL ships will withdraw out of range of high-risk stations at a distance based on their remaining shields. They withdraw farther with lower shields to give it time to recharge. Against high-risk ships, L, and XL attackers will not withdraw unless there are other L, and XL attackers.

Ships that have a low chance of survival or ships targeting enemies with a low chance of survival never withdraw.

High-risk enemies
=================
Potentially high-risk enemies are 1.5x larger physically than the ship. For XS (except for drones), S, and M ships, high-risk enemies have turrets that outnumber the attackers. For L, and XL ships, high-risk enemies have more DPS than the ship.

Coordinated attack changes
==========================
1. "Weak targets first" option is disabled by default.
	Addresses this problem in this AI of the base game: The opposite default in the base game would make the attackers chase after fighters and ignore their capital ship primary target.)
1. Rally points are much further from the target.
	Addresses this problem: This minimises the occurence of the target attacking the ships while they wait for the others to arrive at the rally point.
2. The rally points are not set until the ships are in the same sector as the target.
	Addresses this problem: This prevents rally points from sometimes getting set on the other side of the target - causing your ships to fly across its turrets.
3. The attackers will not wait for wingmen that are busy or are two or more sectors away. This allows ships in the fleet to do other activities.
	Addresses this problem: E.g. Wingmen that you want to get repaired needed to removed from the fleet. Otherwise, they'll get pulled into attack formation.
4. The Coordinate Attack order of the fleet commander is converted into a normal Attack order when the attack begins. I think this is a little cleaner than keeping the Coordinate Attack order active.

Interact Menu
=============
There are two right-click commands that sets or unsets two options in the attack order UI.
1. "Enable/Disable 'Attack all enemies'": This sets or unsets the attack order 'Attack all enemies' option. This option allows or disallows the ship from acquiring other targets other than their primary target.
2. "Enable/Disable 'Avoid high-risk enemies'": This sets or unsets this mod's "avoid" behaviour. When set, the ships acquire this mod's determination of high-risk targets and avoid them according to the behaviours described above. When unset, the ships ignore this mod's AI. Functionally, these are an "attack now" and "hold off attack and stay at a distance" commands.

Player-owned ships only
=======================
By default, these AI behaviours are applied to player-owned ships only. But you can enable them for ALL ships. Note that I've not tested them on all ships.

What this mod doesn't do
========================
1. Order fleet subordinates to attack. Fleet subordinates only acquire this mod's attack behaviours WHEN they acquire an attack order from either their commander or the player. This mod will never start their attacks. How they behave at the start of their attack, defend and intercept stances are determined by their AI commander's orders.
2. For XS (except for drones), S, and M ships: set their starting targets. The only time this mod sets targets for XS (except for drones), S, and M ships are when they are circling a high-risk enemy AND their "Attack all enemies" option is enabled.
3. For L, and XL ships: set their targets.
4. Find and move to the best attack vector. (Nor did the base attack AI.) Ships that are in "ideal" attack vectors are incidental. (Same with the base attack AI.)
5. Increase the efficiency of attacks in low attention. Damages received and dealt in attacks in low attention are determined by the base game. I.e. ships could be in good attack ranges (and out of reach of their target's weapons) but still not deal the optimal damage per second.

Install
=======
-Unzip to 'X4 Foundations/extensions/kuertee_attack_ai_tweaks/'.
-Make sure the sub-folders, and files are in 'X4 Foundations/extensions/kuertee_attack_ai_tweaks/', and not in 'X4 Foundations/extensions/kuertee_attack_ai_tweaks/kuertee_attack_ai_tweaks/'.

Uninstall
=========
-Delete the mod folder.

Debugging
=========
(1) Allow the game to log events to a text file by adding "-debug all -logfile debug.log" to its launch parameters.
(2) Enable the mod-specific Debug Log in the mod's the Extension Options.
(3) Play for long enough for the mod to log its events.
(4) Send me (at kuertee@gmail.com) the log found in My Documents\Egosoft\X4\(your player-specific number)\debug.log.

Uninstall
=========
-Delete the mod folder.

Credits
=======
By kuertee.
Chinese localisation by Tiomer.
Japanese localisation by Arkblade.

History
=======
v5.1.0301, 3 July 2022:
-kuertee: New feature: On new module targets: L and XL ships uses withdraw behaviour but with horizontal and vertical offsets - promotes ships to move around their station targets.
-kuertee: New feature: L and XL ships stop their withdraw behaviour against ships if their hull is less than 50%. Allows the ship to stand their ground instead of to flee a losing battle.
-kuertee: Tweak/bug-fix: When attacking a target in a different sector, the move to engage behaviour will not activate until appropriate. This prevents the bug where the engage position is at the other side of the target.
-kuertee: Bug-fix: Move to engage position behaviour against ships now update as the ships move, preventing ramming behaviour against ships. Previous versions had this disabled.
-kuertee: Bug-fix: Escorts were ignoring the new behaviours because they weren't evaluating their "$primarytarget" var properly.
-kuertee: Bug-fix: User toggle for avoid high risk wasn't sticking.
-kuertee: Bug-fix: "Move around instead of attack" behaviour applied only on XS, S, M or non-fighter ships.
-Dead Air: move.attack.object.capital: Adjusted ideal ranges for ships against stations, capitalships, and smaller ships. They will attempt to keep more distance against stations. Player ships no longer get artificial skill boost. Missile ships will no longer act as if they have a front weapon unless they actually have one. Ships will attempt to get above/below ships much less often (due to front weapon and capital aiming restrictions by egosoft). Ships will consider their minoperationalrange and maxoperationalrange when finding a position near the enemy with less RNG. Capital ships will use travel drive and boost much less often when the target is within range. Capital ships will no longer try to get into the weakquadrant of ships since it mostly led to them getting too close or trying to move too often.
-Dead Air: Engineer: Default script - removed all changes other than hull damage limit. Optional Script - Increased station repair amount 5X and scaled frequency to 5X. Reduced station max repair per cycle to 1% hull instead of 5%.
-Dead Air: lib.target.selection: Reduced stickiness of primary target by 20%. Reduced relation impact to vanilla and removed impact from subordinates relation value. XL ships will be more likely to target L/XL ship hulls or station modules themselves instead of turrets now.  L will be more likely to target M/L/XL ship hulls and XL turrets/engines/shields. Torp S/M will be more likely to target L/XL ship hulls, station modules, or L/XL/Station turrets/engines/shields. Reduced chance of non torpedo S/M of attacking station over preferred targets.
-Dead Air: move.flee: Reduced chance of AI ships dropping their cargo every time they flee.
-Dead Air: drops.xml: Reverted seminar drop rate changes.
-Dead Air: faction logic changes: Hold Space: Set default range search for defense ships to 3 jumps (preliminary steps taken to allow user to enable/disable change), balanced the desired fleet sizes so moodlevel is less likely to have fleets never engage, improved defense station placement to vicinity of gates further (preliminary steps taken to allow user to enable/disable change). Invade Space: Set default range search to include all owned sectors for the faction. No more fleets sitting around idle doing nothing in backwater systems. Balanced desired fleet sizes so moodlevel is less likely to have fleets never engage, enabled factions to order more ships from shipyard/wharf to meet their desired fleet strength. Patrol coordination: balanced acceptable force differential so patrols are more likely to engage enemies for certain moodlevels.
-Dead Air: Carrier attack fix: Added logic for current bug where docked subordinates on a carrier never receive new orders. This fix checks all docked ships and re-adds then to $escortgroup. Behavior for attacking carriers slightly changed where they will send all of their subordinates that are currently available at their primary target or it's turrets/engines/shields. If attacking and a station is a primary target but not the only target, the carrier will send a subordinate L/XL if available, else it will focus down smaller targets first. Carriers will now auto repair docked subordinate ships if they have a shiptrader.
-Dead Air: Old bugfixes: Mining ships will now drop all of the unsellable cargo if they are stuck at or above 50% cargo after mining and unable to sell. Recon - updated threat scaling of stations to account for possible weapons.operational bug

v5.1.00081, 27 May 2022:
-Bug-fix: Avoid high-risk Extension Options was getting ignored by the aiscript.

v5.1.0008, 22 May 2022:
-Bug-fix: Weapon counts on stations were 0 even if they had turrets.
-Tweak: Force L and XL ships to always move to engage position on stations even if their low DPS is not considered high-risk. I.e. they might still have high-damage plasma turrets.
-New feature/Extension Options: Separated weapon/turret count threshold on when to attack for ship and station targets. By default, S ships attack when attackers count more than 25% the weapon/turret count of ship targets and when more than 75% the weapon/turret count of station targets. M ships attack at the previous defaults of 50% for ship targets and 75% for station targets.
-New feature/Extension Options: Separated the options for L and XL ship's avoidance behaviour against ship and station targets. By default L and XL ships avoid high-risk ships and high-risk stations.

v5.1.0007, 14 May 2022:
-Bug-fix: Turret counts on high-risk enemies for the new behaviours from Attack AI Tweaks for S-sized and M-sized ships.
-Optional tweak: DeadAir's alternative to DeadAirAITweaks repair calculations. To use: copy the file from the "optional" folder into the "aiscripts" folder. From DeadAir's notes: "Changed the calculation for repair amount more based on number of crew, skill of crew, and number of repair drones. Repairs happen less often, they are lower than vanilla with small amount of service crew who are low skilled. Repair drones are now a multiplier effect on the ability of service crew. New repair rate is a minimum of 0.1% and a max of 5% hull and occurs around every 60%. Stations have a lower repair rate due to massive amount of HP and reasoning that they have less "combat" personnel onboard."

v5.1.0006, 6 May 2022:
-Tweak: The "Step forward" and "Move out of range" behaviours are separated between attacking ships and attacking stations. By default, they are set to true for both. Set them in the Extension Options.
-Bug-fix: S and M ships with missiles and torpedoes were acquiring avoid high-risk targets even if they had ammo left over.
-Bug-fix: The mod supressed global chatter but didn't reactivate it.
-Tweaks/bug-fix: Various deadairaitweaks including the bug-fix that allowed miners to mine too far away from their station commanders.

v5.1.0005, 18 Apr 2022:
-Tweak: The v5.1.0003 fix didn't actually fix the bug. v5.1.0005 fixes it properly: Travel mode is enabled for the "Avoid high-risk enemy" and "Move to engage position" behaviours if the ship's distance to its target is more than the ship's max radar range.

v5.1.0004, 16 Apr 2022:
-DeadAirAITweaks updates.

v5.1.0003, 14 Apr 2022:
-Tweak: Travel mode is enabled for the "Avoid high-risk enemy" and "Move to engage position" behaviours if the ship's distance to its target is more than the ship's max radar range. (Whether they actually use their travel engines is up to the game. :D)

v5.1.00021, 11 Apr 2022:
-Uploaded the CORRECT folder this time. :D. Sorry, everyone.

v5.1.0002, 11 Apr 2022:
-New feature: Merged file with DeadAirAITweaks. Its read-me is here: https://github.com/kuertee/x4-mod-da-ku-ai-tweaks/blob/master/deadairaitweaks-read-me.md.
-New feature: The "Step forward/Withdraw" behaviour can now be disabled in the ship's Behaviour Menu or from the right-click Interact Menu.
-New feature: The AI movements, "Avoid high-risk enemies" and "Move to engage position" (prevents accidental kamikaze), are now shown as such in the ship's Behaviour Menu. It'll show those order names instead of the generic move to order name. It's easier to know what they're doing with these new orders.
-Bug-fix: The "Step forward" and "Withdraw" do not stop the ship's subordinates from attacking. The downside is that they do not appear in the ship's Behaviour Menu because the moves are embedded within their attack orders.
-New feature (WIP): The Escort Ship, Follow Ship, and Supply Fleet behaviours acquire the Withdraw behaviour. I'm hoping that the interrupt handlers I attached to these behaviours trigger the Withdraw behaviour properly. If they don't, then these behaviours will perform as per the base-game's AI (so no loss there, relatively speaking): i.e. ignore incoming hits at certain times the behaviours are active.
-Localisation files: Chinese from Tiomer. And Japanese from Arkblade. Thank you to you both!

v5.0.00151, 3 Apr 2022:
-Bug-fix: Avoid behaviour for fighter craft v fighter craft were getting skipped on low-attention ships. Thanks DeadAir!

v5.0.0015, 3 Apr 2022:
-New behaviour: XS (except for drones), S, and M ships attack high-risk ship targets when they outnumber 50% of their weapons and turrets. It's still 75% against high-risk stations. These two values can be set in the Extension Options.
-New behaviour: L, and XL ships do not withdraw against high-risk ship targets unless there's another L or XL ship attacker.
-New feature: Enable/Disable 'Avoid high-risk enemies' on the ship's order panel or from the right-click Interact Menu. Disabling this will allow the ships to ignore their determination of high-risk enemies and forcing them to attack.

v5.0.0014, 31 Mar 2022:
-New behaviour: The attack runs of XS (except for drones), S, and M class ships will start when they outnumber 50% of their ship's turrets.
-New behaviour: L, and XL ships will not withdraw against other high-risk enemy ships unless there are other L, and XL attackers.
-Bug-fix: In low-attention fighter to fighter attacks, attackers were not stoping their attack runs on small targets that get near high-risk enemies.

v5.0.0013, 30 Mar 2022:
-Bug-fix: L and XL ships was acquiring the "stop kamikaze" behaviour (stop short of the target) against ship targets.
-Bug-fix: The "stop kamikaze" behaviour was getting applied on L and XL ships that are already in attack range.
-Bug-fix: One of the flee AI types was acquiring the avoid behaviour instead of just fleeing.

v5.0.0012, 25 Mar 2022:
-Note: This version will invalidate the mod's attack behaviours from the previous version, causing the ships to act unexpectedly UNTIL their next AI cycle. Or you can simply cancel then reissue any attack orders.
-New feature: L, and XL ships will now start their attack at their max combat range. Prevously, they started their attack at their optimal combat range - which made it look like they ignored their long-range weapons. As in previous versions, they'll inch towards their optimal combat range.
-New feature: L, and XL ships will approach their target at a vertical angle. Previously, they approached their target at their target's vertical position.
-New feature: XS (except for drones), S, and M ships will circle high-risk targets at a vertical angle.
-Bug-fix: L, and XL ships were still trying to get to the other side of their targets - exposing themselves to their target's weapons as they passed them. This happened when the ship acquired an attack order against the same target and the target is outside combat range. I.e. the ship only acquired the "stop kamikaze" behaviour once per target in previous version. In this version, this doesn't happen. (I had to rewrite how the mod's internal data for an attack order was stored for this fix.)
-New feature: L, and XL ships will move away a short distance after destroying a station module for a better attack vector against their next module target. They'll use the mod's behaviour for avoiding high-risk enemies so that they don't get within range of the station's turrets.
-New feature: High-risk enemies are no longer determined on object class. Potentially high-risk enemies are 1.5x larger physically than the ship. For XS (except for drones), S, and M ships, high-risk enemies have turrets that outnumber the attackers. For L, and XL ships, high-risk enemies have more DPS than the ship.

v5.0.0011, 19 Mar 2022:
-Bug-fix: Capital ships were still trying to find better attack vectors at the other side of their target stations.
-Tweak: Better optimal range values.
-Bug-fix: Some of the new behaviours were getting applied to ALL ships even if that option is disabled in the Extension Options.
-Tweak: Cleaned-up some unnecessary get_safe_pos calls.

v5.0.001, 17 Mar 2022:
-New feature: "Enable/Disable: 'Attack all enemies'" Interact Menu (i.e. right-click context sensitive menu) to enable or disable the "Attack all enemies" options of any attack orders of the selected ships.
-New feature: XS (except for drones), S, and M ships with missiles and torpedoes are do not use their avoidance AI until their missiles and torpedoes are exhausted.
-New feature: L and XL ships will never use boost against stations - except when their base-game AI makes them use their boost to flee.
-New feature: Disables the base-game AI that allows L and XL ships to look for better attack vectors on the other side of their target stations (ignoring the danger of passing by the main body of the station).
-New feature: L and XL module targets are shown on the map.
-Tweak: More careful "inch forward" and better withdraw AI.
-Tweak: Better "move around" vectors.

v4.2.0810, 12 Mar 2022:
-Initial release.
